<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>SGE+bash+awk+sed+Python+WebStackPage实现P级数据并发扫描与数据报表公示系统</title>
    <url>/2020/10/19/SGE+bash+awk+sed+Python+WebStackPage%E5%AE%9E%E7%8E%B0P%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%B9%B6%E5%8F%91%E6%89%AB%E6%8F%8F%E4%B8%8E%E4%B8%8B%E6%9C%BA%E6%95%B0%E6%8D%AE%E6%8A%A5%E8%A1%A8%E5%85%AC%E7%A4%BA/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="SGE-bash-awk-sed-Python-WebStackPage-实现P级数据并发扫描与数据报表公示系统"><a href="#SGE-bash-awk-sed-Python-WebStackPage-实现P级数据并发扫描与数据报表公示系统" class="headerlink" title="SGE+bash+awk+sed+Python+WebStackPage 实现P级数据并发扫描与数据报表公示系统"></a>SGE+bash+awk+sed+Python+WebStackPage 实现P级数据并发扫描与数据报表公示系统</h1><ul>
<li>需求与实现初衷</li>
</ul>
<ol>
<li>生信类数据每周有大量的下机数据，需要按照超期周期公示到各个业务部门找对应的负责人、运营经理、生信分息等进行删除，并且要保证超期周期可调整;</li>
<li>想把下机公示的脚本写成高效扫盘的脚本，实现分发投递，与数据扫盘时数据中断的可控性;不影响每周的下机数据公示; 扫盘数据匹配人员，数据分析、数据透视的准确性，超期周期，任务进度把控与匹配，要确保每次公示数据的存在性，计算的准确性等等;</li>
<li>每次定任务删除进度时，只发送邮件，由使用各管理员自己去web 页面下载分析好的超期数据;进行实时分析与更新，主动把控数据的清除进度与任务推进。</li>
</ol>
<ul>
<li>实现与突破</li>
</ul>
<ol>
<li><p>使用rg命令结合 stat 命令、bash 并发、qsub 多任务的投递，突破了扫盘慢的问题，P级扫盘共需2-8小时左右，2小时基本可以把很大部分数据量扫下来，因个别目录文件比较碎，在8小时左右全部扫完，但是碎方件占用量不大，基本不影响数据的总量;</p>
</li>
<li><p>使用awk 的 ARGIND模块结合hash算法，突破了bash脚本两文件合并慢，占用cpu，内存资源慢的问题，可以10几秒内完成合并，现bash脚本分析(279T)超期数据，需3分钟左右的时间，python脚本 excel 表格生成，数据透视共需4分钟左右。定义扫盘定时任务计划，确认数据的准确性，自动化结合这块，web 页面公示与生信人员自主获取公示结果。</p>
</li>
</ol>
<ul>
<li>环境需求</li>
</ul>
<ol>
<li>SGE 高性能集群;</li>
<li>分布式挂载存储;</li>
</ol>
<h2 id="实现逻辑图"><a href="#实现逻辑图" class="headerlink" title="实现逻辑图"></a>实现逻辑图</h2><p><img src="/images/PLevel-Disembarkation-data-display.png" class="lazyload" data-srcset="/images/PLevel-Disembarkation-data-display.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="扫盘命令挑选–-rg-命令"><a href="#扫盘命令挑选–-rg-命令" class="headerlink" title="扫盘命令挑选– rg 命令"></a>扫盘命令挑选– rg 命令</h2><ol>
<li>如果说目录下文件个数较少，数据量较小时，我们大可不必考虑扫盘效率的问题;</li>
<li>但当文件数目超过几千万、甚至1亿总数据量超过P时，我们要挑选性能优的扫盘命令工具做底层是毋庸置疑的;</li>
<li>经查找资源，测试发现，rg 命令可以代替ls  和find 进行快的扫盘，大的目录扫描时效率较高;相传要比find快n倍；</li>
<li>命令如下</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rg --files /PATH/DIR | xargs -I &#123;&#125;  <span class="built_in">stat</span> -c \&quot;%n<span class="comment">####%s####%U####%z\&quot; &#123;&#125; </span></span><br></pre></td></tr></table></figure>
<h2 id="首先要统计部门-管理员等相关信息"><a href="#首先要统计部门-管理员等相关信息" class="headerlink" title="首先要统计部门-管理员等相关信息"></a>首先要统计部门-管理员等相关信息</h2><p>这里可以看一下类似的信息，敏感信息已用<strong>xx隐藏</strong></p>
<p>xj_id_class 文件，用于根据扫出的条目列表中的利润编号匹配管理员,部门详情,管理员邮箱等信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">02xx,TESTDPART1,leixxx,XX中心-XX中心-XX转化研究部-生信分析组,leixxx@xxx.com</span><br><span class="line">19xx,TESTANI1,zhangxxx,XX中心-XX医学研究部-生信分析,zhangxxx@xxx.com</span><br><span class="line">19xx,TESTCAN,leixxx,XX中心-XX作物研究部-生信分析,leixxx@xxx.com</span><br><span class="line">10xx,TESTHEAL,jianxxx,XX中心-XX事业部-生信分析组,jianxxx@xxx.com</span><br><span class="line">14xx,TESTHW,weixxx,海外XX-交付组,weixxx.xxx.com</span><br></pre></td></tr></table></figure>
<h2 id="定义xjscan-主脚本全局变量"><a href="#定义xjscan-主脚本全局变量" class="headerlink" title="定义xjscan 主脚本全局变量"></a>定义xjscan 主脚本全局变量</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">source</span> /root/.bashrc</span><br><span class="line"><span class="built_in">source</span> /root/.bash_profile</span><br><span class="line">project_dir=<span class="string">&#x27;/test/data/xjscan/&#x27;</span></span><br><span class="line">other_storage_txxj1=<span class="string">&#x27;/TXPORJ1/XJ&#x27;</span></span><br><span class="line">other_storage_txxj4=<span class="string">&#x27;/XXPROJ4/XJ&#x27;</span></span><br><span class="line">xxxj5_name=<span class="string">&#x27;XXPROJ5&#x27;</span></span><br><span class="line">xxxj1_name=<span class="string">&#x27;XXPROJ1&#x27;</span></span><br><span class="line">id_group_file=<span class="string">&#x27;xj_id_class&#x27;</span></span><br><span class="line">library_file=<span class="string">&#x27;project_library.xls&#x27;</span></span><br><span class="line">s5_dir=<span class="string">&#x27;/XXPROJ4/XJ/S5_production&#x27;</span></span><br><span class="line"></span><br><span class="line">dir_10x=<span class="string">&#x27;/XXPROJ4/XJ/Data_production/10xgen/&#x27;</span></span><br><span class="line">share_dir=<span class="string">&#x27;/XXPROJ4/XJ/department_data/shared&#x27;</span></span><br><span class="line">s5_dir=<span class="string">&#x27;/XXPROJ4/XJ/S5_produ&#x27;</span></span><br><span class="line"></span><br><span class="line">now_time=`date +<span class="string">&quot;%Y-%m&quot;</span>`</span><br><span class="line">[ -d <span class="variable">$now_time</span> ] || mkdir <span class="variable">$now_time</span></span><br><span class="line">other_storage_dir=<span class="string">&quot;<span class="variable">$now_time</span>/other&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_dir</span> ] || mkdir <span class="variable">$other_storage_dir</span></span><br><span class="line">other_storage_data=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/data/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_data</span> ] || mkdir <span class="variable">$other_storage_data</span></span><br><span class="line">other_storage_cache=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/cache/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_cache</span> ] || mkdir <span class="variable">$other_storage_cache</span></span><br><span class="line">other_storage_shell=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/shell/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_shell</span> ] || mkdir <span class="variable">$other_storage_shell</span></span><br></pre></td></tr></table></figure>
<h2 id="主脚本各模块实现与功能"><a href="#主脚本各模块实现与功能" class="headerlink" title="主脚本各模块实现与功能"></a>主脚本各模块实现与功能</h2><h3 id="create-data-tx1-函数模块"><a href="#create-data-tx1-函数模块" class="headerlink" title="create_data_tx1 函数模块"></a>create_data_tx1 函数模块</h3><p>将XXPROJ1盘下的XJ 盘扫描生成并发执行脚本，并投递到all.q 等多个计算节点上;<br>为避免投递后投行完shell脚本本身的一个并发退出，需要在并发后添加&amp; ,即<code>&#123;&#125; &amp; 的形势</code>;<br>或者自己在生成的扫盘脚本中检测进程是否存在，进程不存时，再退出投递的脚本;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">create_data_xx1</span></span>() &#123;</span><br><span class="line"><span class="comment">### 将存储的二级目录的文件统计下来 ###</span></span><br><span class="line">&gt; <span class="variable">$other_storage_data</span>/<span class="variable">$xjxx1_name</span>.FINDF2</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `find <span class="variable">$other_storage_xxxj1</span> -maxdepth 2 -<span class="built_in">type</span> f `; <span class="keyword">do</span> </span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$i</span> |  xargs -I &#123;&#125;  <span class="built_in">stat</span> -c <span class="string">&quot;%n####%s####%U####%z&quot;</span> &#123;&#125; &gt;&gt; <span class="variable">$other_storage_data</span>/<span class="variable">$xjxx1_name</span>.FINDF2</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">## 将存储的二级目录的目录统计下来，并生成投递的命令 ###</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `find <span class="variable">$other_storage_xjxx1</span> -maxdepth 2 -mindepth 2 -<span class="built_in">type</span> d`;</span><br><span class="line">     <span class="keyword">do</span></span><br><span class="line">     shell_name=`<span class="built_in">echo</span> <span class="variable">$i</span> |sed <span class="string">&#x27;s/^\///g&#x27;</span> | sed <span class="string">&#x27;s/\//_/g&#x27;</span> | awk <span class="string">&#x27;&#123;print $0&quot;.rg.qsub.sh&quot;&#125;&#x27;</span>`</span><br><span class="line">     data_name=`<span class="built_in">echo</span> <span class="variable">$i</span> | sed <span class="string">&#x27;s/^\///g&#x27;</span> | sed <span class="string">&#x27;s/\//_/g&#x27;</span> | awk <span class="string">&#x27;&#123;print $0&quot;.FINDD2&quot;&#125;&#x27;</span>`</span><br><span class="line">     file_num=`ls -l  <span class="variable">$i</span>  | sed <span class="string">&#x27;1d&#x27;</span> |wc -l`</span><br><span class="line">    <span class="comment">## 判断目录个数来切分脚本中的并发数;</span></span><br><span class="line">     <span class="keyword">if</span> [ <span class="variable">$file_num</span> -le 10 ] ;<span class="keyword">then</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;#!/bin/bash&quot;</span> &gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;rg --files <span class="variable">$i</span> | xargs -I &#123;&#125;  stat -c \&quot;%n####%s####%U####%z\&quot; &#123;&#125;  &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_data</span><span class="variable">$data_name</span>&quot;</span> &amp;&gt;&gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line">     <span class="comment">## 判断子目录个数来切分脚本中的并发数</span></span><br><span class="line">     <span class="keyword">if</span> [ <span class="variable">$file_num</span> -gt 10 ] ; <span class="keyword">then</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;#!/bin/bash &quot;</span> &gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;&#123;&quot;</span> &gt;&gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">         num=0</span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_data</span><span class="variable">$data_name</span>&quot;</span> &gt;&gt;<span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">         <span class="keyword">for</span> b <span class="keyword">in</span> `ls -l <span class="variable">$i</span>| sed <span class="string">&#x27;1d&#x27;</span> | awk <span class="string">&#x27;&#123;print $8&#125;&#x27;</span> `;</span><br><span class="line">            <span class="keyword">do</span> </span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;rg --files <span class="variable">$i</span>/<span class="variable">$b</span> | xargs -I &#123;&#125;  stat -c \&quot;%n####%s####%U####%z\&quot; &#123;&#125;  &amp;&gt;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_data</span><span class="variable">$data_name</span><span class="variable">$num</span> &amp; &quot;</span> &amp;&gt;&gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">               num=$[<span class="variable">$num</span>+1]</span><br><span class="line">         <span class="keyword">done</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;&#125;&quot;</span> &gt;&gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;wait&quot;</span>  &gt;&gt; <span class="variable">$other_storage_shell</span><span class="variable">$shell_name</span></span><br><span class="line">        cat &lt;&lt;<span class="string">EOF &gt;&gt; $other_storage_shell$shell_name</span></span><br><span class="line"><span class="string">rg_ps_num=\`ps aux | grep &#x27;rg --files&#x27; | wc -l \`</span></span><br><span class="line"><span class="string">while [ \$rg_ps_num -gt 1 ] ; do</span></span><br><span class="line"><span class="string">    sleep 60</span></span><br><span class="line"><span class="string">    rg_ps_num=\`ps aux | grep &#x27;rg --files&#x27; | wc -l \`</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">     <span class="keyword">fi</span>      </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将生成的脚本投递到挂载存储盘的多个节点上进行扫描(开始并发执行)</span></span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> ` <span class="built_in">cd</span> <span class="variable">$project_dir</span><span class="variable">$other_storage_shell</span> &amp;&amp; ls <span class="variable">$xjxx1_name</span>*<span class="string">&quot;rg&quot;</span>*<span class="string">&quot;sh&quot;</span>`;<span class="keyword">do</span></span><br><span class="line">        qsub -l vf=0,p=0 <span class="variable">$project_dir</span><span class="variable">$other_storage_shell</span><span class="variable">$i</span></span><br><span class="line">        sleep 2.5</span><br><span class="line">     <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="data-agregation-函数模块"><a href="#data-agregation-函数模块" class="headerlink" title="data_agregation 函数模块"></a>data_agregation 函数模块</h3><ol>
<li>将扫盘的数据文件合并成一个大的文件，方便于分离超期数据，与数据分析;</li>
<li>执行get_proj_info.sh 将原有的下机人员记录的信息做数据全并，存入项目目录中，用于后面详情匹配;</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">data_aggregation</span></span> () &#123;</span><br><span class="line">    time_dxx1ays=`date +<span class="string">&quot;%Y-%m-%d-&quot;</span>`</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; mv <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span> <span class="variable">$other_storage_cache</span>.<span class="variable">$time_days</span><span class="variable">$xxxj1_name</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; find  <span class="variable">$other_storage_data</span> -name <span class="string">&quot;<span class="variable">$xxxj1_name</span>*FIND*&quot;</span> | xargs -I &#123;&#125; cat &#123;&#125; |awk  <span class="string">&#x27;&#123;$NF=&quot;&quot;&#125;&#123;print $0&#125;&#x27;</span>| awk <span class="string">&#x27;&#123;$NF=&quot;&quot;&#125;&#123;print $0&#125;&#x27;</span>  &amp;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; bash get_proj_info.sh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="over-due-xx1-函数模块"><a href="#over-due-xx1-函数模块" class="headerlink" title="over_due_xx1 函数模块"></a>over_due_xx1 函数模块</h3><ul>
<li>实现功能</li>
</ul>
<ol>
<li>将合并的大的扫盘数据文件，按指定的超期周期进合切割与分离;</li>
<li>将以文件为条录的数据信息，合并为目录的形势，并按照目录提取文件信息，目录信息，及~以目录的形势来合并计算目录的大小;</li>
<li>再次处理数据，将目录中的信息与定义好的xj_id_class中的部门等信息做匹配存放到临时的缓存文件中;</li>
<li>分离匹配不到部门与特殊目录的信息，存入其它缓存中，做二次处理;</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">over_due_xx1</span></span> () &#123;</span><br><span class="line">    <span class="comment">### Separate overdue files from all data sources ###</span></span><br><span class="line">    awk -v ntime=<span class="string">&quot;<span class="variable">$ntime</span>&quot;</span> -v cycle=<span class="string">&quot;<span class="variable">$cycle</span>&quot;</span> -v stop_cycle=<span class="string">&quot;<span class="variable">$stop_cycle</span>&quot;</span> -F <span class="string">&#x27;####&#x27;</span> <span class="string">&#x27;&#123;split($4,ti,&quot;-&quot;);filetime=mktime(ti[1]&quot; &quot;ti[2]&quot; &quot;ti[3]&quot; &quot;&quot;0 0 0&quot;)&#125;&#123;moretime=(ntime-filetime)/86400&#125;&#123;if(moretime &gt; cycle &amp;&amp; moretime &lt;stop_cycle)&#123;print $0&#125;&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span>  &amp;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span></span><br><span class="line">    <span class="comment">### Merge file size to directory size ###</span></span><br><span class="line">    cat <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span>  | grep -v <span class="string">&quot;<span class="variable">$s5_dir</span>&quot;</span> |   awk -F <span class="string">&#x27;####&#x27;</span> <span class="string">&#x27;&#123;OFS=&quot;####&quot;&#125;&#123;dirname = gensub(&quot;/*[^/]*/*$&quot;, &quot;&quot;, &quot;&quot;, $1);print dirname,$2,$3,$4&#125;&#x27;</span> | awk -F <span class="string">&#x27;####&#x27;</span> <span class="string">&#x27;&#123;a[$1&quot;####&quot;$3&quot;####&quot;$4]+=$2&#125;END&#123;for(i in a) print i&quot;####&quot;a[i]&#125;&#x27;</span> &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span></span><br><span class="line">    cat <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span> | grep <span class="string">&quot;<span class="variable">$s5_dir</span>&quot;</span>  | awk -F <span class="string">&#x27;####&#x27;</span> -v OFS=<span class="string">&#x27;####&#x27;</span> <span class="string">&#x27;&#123;print $1,$3,$4,$2&#125;&#x27;</span> &amp;&gt;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span></span><br><span class="line">    <span class="comment">#awk -F &#x27;####&#x27; &#x27;&#123;OFS=&quot;####&quot;&#125;&#123;dirname = gensub(&quot;/*[^/]*/*$&quot;, &quot;&quot;, &quot;&quot;, $1);print dirname,$2,$3,$4&#125;&#x27; $other_storage_cache$xxxj1_name$over_due_name | awk -F &#x27;####&#x27; &#x27;&#123;OFS=&quot;####&quot;&#125;&#123;dirname = gensub(&quot;/*[^/]*/*$&quot;, &quot;&quot;, &quot;&quot;, $1);print dirname,$2,$3,$4&#125;&#x27; | awk -F &#x27;####&#x27; &#x27;&#123;a[$1&quot;####&quot;$3&quot;####&quot;$4]+=$2&#125;END&#123;for(i in a) print i&quot;####&quot;a[i]&#125;&#x27; &amp;&gt; $other_storage_cache.$xxxj1_name$over_due_name</span></span><br><span class="line">    mv <span class="variable">$other_storage_cache</span>.<span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span>   <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span></span><br><span class="line">    <span class="comment">### Add the group and ID project Numbers ###</span></span><br><span class="line">    awk -F <span class="string">&#x27;####&#x27;</span> -v OFS=<span class="string">&#x27;####&#x27;</span> <span class="string">&#x27;&#123;gsub(/ /,&quot;&quot;,$3)&#125;&#123;print $0&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span> &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span></span><br><span class="line">    mv <span class="variable">$other_storage_cache</span>.<span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span>   <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span></span><br><span class="line">    grep_group_id=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `cat <span class="variable">$id_group_file</span>`; <span class="keyword">do</span></span><br><span class="line">        group_id=`<span class="built_in">echo</span> <span class="variable">$i</span> | awk -F <span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">        group_name=`<span class="built_in">echo</span> <span class="variable">$i</span> | awk -F <span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">        awk -v group_id=<span class="string">&quot;<span class="variable">$group_id</span>&quot;</span> -v group_name=<span class="string">&quot;<span class="variable">$group_name</span>&quot;</span> -v OFS=<span class="string">&quot;\t&quot;</span> -F <span class="string">&#x27;####&#x27;</span> <span class="string">&#x27;&#123;split($1,wenku,&quot;/&quot;);wenku_num=length(wenku)&#125;&#123;if($1 ~ &quot;/&quot;group_id&quot;/&quot;)&#123;print $4,$3,group_id,$2,$1,wenku[wenku_num],group_name&#125;&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span> &amp;&gt;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span></span><br><span class="line">        grep_group_id=<span class="string">&quot;<span class="variable">$grep_group_id</span>/<span class="variable">$group_id</span>/|&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    grep_group_id_v=`<span class="built_in">echo</span> <span class="variable">$grep_group_id</span> | sed s<span class="string">&#x27;/.$//&#x27;</span>`</span><br><span class="line">    cat <span class="variable">$other_storage_cache</span><span class="variable">$xxxj1_name</span><span class="variable">$over_due_name</span> | egrep -v <span class="string">&quot;<span class="variable">$grep_group_id_v</span>&quot;</span>  | awk -F <span class="string">&quot;####&quot;</span> -v OFS=<span class="string">&quot;\t&quot;</span> <span class="string">&#x27;&#123;print $1,$2,$3,$4&#125;&#x27;</span> &amp;&gt;&gt;  <span class="variable">$other_storage_cache</span><span class="variable">$other_file</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v cycle=<span class="string">&quot;<span class="variable">$cycle</span>&quot;</span> <span class="string">&#x27;&#123;sum+=$4&#125;END&#123;print &quot;Expiration date &quot;cycle,sum&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$other_file</span> &amp;&gt;&gt;  <span class="variable">$other_storage_cache</span><span class="variable">$other_file</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="add-over-date-函数模块"><a href="#add-over-date-函数模块" class="headerlink" title="add_over_date 函数模块"></a>add_over_date 函数模块</h3><p>计算并添加目录条目录的超期天数项</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">add_over_date</span></span>() &#123;</span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span>  -v ntime=<span class="string">&quot;<span class="variable">$ntime</span>&quot;</span>  -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;split($2,ti,&quot;-&quot;);filetime=mktime(ti[1]&quot; &quot;ti[2]&quot; &quot;ti[3]&quot; &quot;&quot;0 0 0&quot;)&#125;&#123;moretime=(ntime-filetime)/86400&#125;&#123;print $0,moretime&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span> &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$libproj</span></span><br><span class="line">    mv <span class="variable">$other_storage_cache</span>.<span class="variable">$libproj</span> <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span>  -v ntime=<span class="string">&quot;<span class="variable">$ntime</span>&quot;</span>  -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;split($3,ti,&quot;-&quot;);filetime=mktime(ti[1]&quot; &quot;ti[2]&quot; &quot;ti[3]&quot; &quot;&quot;0 0 0&quot;)&#125;&#123;moretime=(ntime-filetime)/86400&#125;&#123;print $4,$3,$2,$1,moretime&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$other_file</span>  &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$other_file</span></span><br><span class="line">    mv <span class="variable">$other_storage_cache</span>.<span class="variable">$other_file</span> <span class="variable">$other_storage_cache</span><span class="variable">$other_file</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="overall-xx-函数模块"><a href="#overall-xx-函数模块" class="headerlink" title="overall_xx 函数模块"></a>overall_xx 函数模块</h3><ol>
<li>首先根据目录中的分期号等信息等值关联合并查询；</li>
<li>注 <code>a[s]=$4&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;</code> <strong>这个就是建哈希，a是哈希名。以s键，后边为值,num就是第一列/分割长度，s=wenku[num]就是取最后一个， c就是另一个文件的key值，如果在哈希里有值，就执行下边的语句。</strong>  此项分析也是脚本实现高效运算的核心所在;</li>
<li>详情页数据大小为B,  汇总分析页数据大小合并运算为G。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt; <span class="variable">$other_storage_cache</span><span class="variable">$overall</span></span><br><span class="line"><span class="comment">## 详情页的生成</span></span><br><span class="line"><span class="comment">## 匹配到相关信息的人员数据精确匹配与合并</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num]&quot;&quot;$5;t=wenku[num]&quot;-&quot;$2&quot;&quot;$5;a[s]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&quot;\t&quot;$10;b[t]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&quot;\t&quot;$10&#125;ARGIND==2&#123;c=$6&quot;&quot;$3;if(a[c])&#123;print $0,a[c]&#125; else if(b[c])&#123;print $0,b[c]&#125;&#125;&#x27;</span> <span class="variable">$library_file</span>  <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>  &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$libproj_location</span></span><br><span class="line"><span class="comment">##  未匹配到相关信息人员的数据输出与合并</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num]&quot;&quot;$5;t=wenku[num]&quot;-&quot;$2&quot;&quot;$5;a[s]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9;b[t]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&#125;ARGIND==2&#123;c=$6&quot;&quot;$3;if(!a[c] &amp;&amp; ! b[c])&#123;print $0,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;&#125;&#125;&#x27;</span> <span class="variable">$library_file</span>  <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>  &amp;&gt;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$libproj_location</span></span><br><span class="line"></span><br><span class="line"> mv <span class="variable">$other_storage_cache</span>.<span class="variable">$libproj_location</span> <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span></span><br><span class="line"><span class="comment">## 汇总页的数据生成与分析并匹配获取部门与管理人员相关信息</span></span><br><span class="line">     bash xjsan_nodepartment.sh  <span class="variable">$cycle</span> <span class="variable">$stop_cycle</span></span><br><span class="line">     cat <span class="variable">$id_group_file</span> | awk -F <span class="string">&#x27;,&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;print $1,$2,$3,$4,$5&#125;&#x27;</span> &amp;&gt; .<span class="variable">$id_group_file</span></span><br><span class="line">     awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;s=$1;a[s]=$4&quot;-&quot;$2&quot;-&quot;$3&#125;ARGIND==2&#123;c=$3;if(a[c])&#123;print $0,a[c]&#125; else &#123;print $0,&quot;-&quot;&#125;&#125;&#x27;</span> .<span class="variable">$id_group_file</span>  <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span> | awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;print $14,$3,$6,$1,$9,$10,$11,$12,$8&#125;&#x27;</span> |  awk -F<span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;a[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]+=$4;b[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]=b[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]$3&quot;,&quot;;c[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]+=$9;d[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]++&#125;END&#123;for (i in a)print i,a[i],c[i]/d[i],b[i]&#125;&#x27;</span>   | sed <span class="string">&#x27;s/,$//g&#x27;</span> | awk -F <span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;printf &quot;%s\t%s\t%s\t%s\t%s\t%.2f\t%s\t%s\t%s\n&quot;,$1,$2,$3,$4,$6,$7/1024/1024/1024,$8,$5,$9&#125;&#x27;</span> &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$overall</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$other_storage_cache</span>.<span class="variable">$overall</span> <span class="variable">$other_storage_cache</span><span class="variable">$overall</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num]&quot;&quot;$5;t=wenku[num]&quot;-&quot;$2&quot;&quot;$5;a[s]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9;b[t]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&#125;ARGIND==2&#123;c=$6&quot;&quot;$3;if(!a[c] &amp;&amp; ! b[c])&#123;print $0,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;&#125;&#125;&#x27;</span> <span class="variable">$library_file</span>  <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>  &amp;&gt;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$libproj_location</span></span><br><span class="line">mv <span class="variable">$other_storage_cache</span>.<span class="variable">$overall</span> <span class="variable">$other_storage_cache</span><span class="variable">$overall</span></span><br></pre></td></tr></table></figure>
<h3 id="xjsan-nodepartment-sh-无法精确匹配、使用正则"><a href="#xjsan-nodepartment-sh-无法精确匹配、使用正则" class="headerlink" title="xjsan_nodepartment.sh  无法精确匹配、使用正则"></a>xjsan_nodepartment.sh  无法精确匹配、使用正则</h3><p>有一些特殊情况的数据需要使用正则来特殊处理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 项目相关环境变量这里不再重复，可以调用, 主shell 脚本，也可以在这里重新定义。</span></span><br><span class="line">stop_cycle=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">time_year_month_day=`date -d -<span class="variable">$cycle</span>\day +<span class="string">&#x27;%Y-%m-%d&#x27;</span>`</span><br><span class="line">libproj=<span class="string">&quot;able_lib.xls&quot;</span></span><br><span class="line">libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line">overall=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.ProjInfo.XJpath.xls&quot;</span></span><br><span class="line">other_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.other.xls&quot;</span></span><br><span class="line">pub_other_file=<span class="string">&quot;pub_<span class="variable">$other_file</span>&quot;</span></span><br><span class="line">work_other_file=<span class="string">&quot;work_<span class="variable">$other_file</span>&quot;</span></span><br><span class="line">dir_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.dir.xls&quot;</span></span><br><span class="line">over_due_name=<span class="string">&#x27;_overdue&#x27;</span></span><br><span class="line">libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line"><span class="function"><span class="title">dir10x_func</span></span>() &#123;</span><br><span class="line">    grep <span class="variable">$dir_10x</span> <span class="variable">$other_storage_cache</span><span class="variable">$pub_other_file</span> |  egrep  <span class="string">&quot;F[[:upper:]]&#123;1,4&#125;[[:digit:]]&#123;6,13&#125;-[[:alnum:]][[:alnum:]]&quot;</span> | sed -r  <span class="string">&#x27;s/(.*)(F[[:upper:]]&#123;1,4&#125;[[:digit:]]&#123;6,13&#125;-[[:alnum:]][[:alnum:]])(.*)/\1\2\3\t\2/g&#x27;</span> &amp;&gt;  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num];a[s]=$5&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&quot;\t&quot;$10;&#125;ARGIND==2&#123;c=$6;if(a[c])&#123;print $0,a[c]&#125;&#125;&#x27;</span> <span class="variable">$library_file</span> <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span> &amp;&gt;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    rm -f <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    grep <span class="variable">$dir_10x</span> <span class="variable">$other_storage_cache</span><span class="variable">$pub_other_file</span> |  egrep  -v <span class="string">&quot;F[[:upper:]]&#123;1,4&#125;[[:digit:]]&#123;6,13&#125;-[[:alnum:]][[:alnum:]]&quot;</span> |egrep  <span class="string">&quot;/.*[[:digit:]]&#123;4,8&#125;_[[:alnum:]]&#123;4,8&#125;_[[:digit:]]&#123;3,5&#125;_[[:alnum:]]&#123;8,12&#125;-?[[:alnum:]]&#123;1,4&#125;?-?[[:alnum:]]&#123;1,4&#125;?-?[[:alnum:]]&#123;1,4&#125;?&quot;</span> | sed -r  <span class="string">&#x27;s#(.*)(/.*/.*/.*/.*/.*[[:digit:]]&#123;4,8&#125;_[[:alnum:]]&#123;4,8&#125;_[[:digit:]]&#123;3,5&#125;_[[:alnum:]]&#123;8,12&#125;-?[[:alnum:]]&#123;1,4&#125;?-?[[:alnum:]]&#123;1,4&#125;?-?[[:alnum:]]&#123;1,4&#125;?)(.*)#\1\2\3\t\2#g&#x27;</span>   &amp;&gt;  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">     awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);s=&quot;/&quot;wenku[2]&quot;/&quot;wenku[3]&quot;/&quot;wenku[4]&quot;/&quot;wenku[5]&quot;/&quot;wenku[6];a[s]=$5&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&quot;\t&quot;$10;&#125;ARGIND==2&#123;c=$6;if(a[c])&#123;print $0,a[c]&#125;&#125;&#x27;</span> <span class="variable">$library_file</span> <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span>  &amp;&gt;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    rm -f  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">dirs5_func</span></span>() &#123;</span><br><span class="line">    grep <span class="variable">$s5_dir</span>  <span class="variable">$other_storage_cache</span><span class="variable">$pub_other_file</span> | egrep  <span class="string">&quot;F[[:upper:]]&#123;1,4&#125;[[:alnum:]]&#123;6,13&#125;-?[[:alnum:]][[:alnum:]]&quot;</span>  | sed -r  <span class="string">&#x27;s/(.*)(F[[:upper:]]&#123;1,4&#125;[[:alnum:]]&#123;6,13&#125;-?[[:alnum:]][[:alnum:]])(.*)/\1\2\3\t\2/g&#x27;</span>  &amp;&gt;  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num];a[s]=$5&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&quot;\t&quot;$10;&#125;ARGIND==2&#123;c=$6;if(a[c])&#123;print $0,a[c]&#125;&#125;&#x27;</span> <span class="variable">$library_file</span> <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span>  &amp;&gt;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    rm -f  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">share_func</span></span>() &#123;</span><br><span class="line">    grep <span class="variable">$share_dir</span> <span class="variable">$other_storage_cache</span><span class="variable">$pub_other_file</span> | egrep  <span class="string">&quot;F[[:upper:]]&#123;1,4&#125;[[:alnum:]]&#123;6,13&#125;-?[[:alnum:]][[:alnum:]]&quot;</span> | sed -r  <span class="string">&#x27;s/(.*)(F[[:upper:]]&#123;1,4&#125;[[:alnum:]]&#123;6,13&#125;-?[[:alnum:]][[:alnum:]])(.*)/\1\2\3\t\2/g&#x27;</span> &amp;&gt;  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> </span><br><span class="line"><span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num];a[s]=&quot;share\t-\t-\t-\t&quot;$9&quot;\t-\t-&quot;;&#125; ARGIND==2&#123;c=$6;if(a[c])&#123;print $0,a[c]&#125;&#125;&#x27;</span>  <span class="variable">$library_file</span> <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span>   &amp;&gt;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line"></span><br><span class="line">    rm -f  <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">create_func</span></span>() &#123;</span><br><span class="line">     awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;print $1,$2,$7,$3,$4,$6,&quot;-&quot;,$5,$8,$9,$10,$11,$12&#125;&#x27;</span> <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span> &amp;&gt; <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span></span><br><span class="line">     mv <span class="variable">$other_storage_cache</span>.<span class="variable">$dir_file</span> <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line">     cat  <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span> &amp;&gt;&gt; <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span></span><br><span class="line">&#125;</span><br><span class="line">dir10x_func</span><br><span class="line">dirs5_func</span><br><span class="line">share_func</span><br><span class="line">create_func</span><br></pre></td></tr></table></figure>
<h3 id="delete-old-函数模块"><a href="#delete-old-函数模块" class="headerlink" title="delete_old 函数模块"></a>delete_old 函数模块</h3><p>将精匹配的详情数据，切割大小，并发检测目录的存在性;<br>注: 因为数据的特殊性，下机类的数据删除后，目录为空或者目录不存在;<br>因此，这里使用以下函数来实现数据的时效性。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">delete_old</span></span> () &#123;</span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span>\ablelib-split*</span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>\_cache*</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span> &amp;&amp; split <span class="variable">$libproj</span> ablelib-split -l 2000</span><br><span class="line">    num=0</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `ls <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span>\ablelib-split*`; <span class="keyword">do</span></span><br><span class="line">       awk <span class="string">&#x27;&#123;cmd=&quot;ls -A &quot; $5 &quot; 2&gt; /dev/null  | wc -w&quot;&#125;&#123;cmd| getline dir;close(cmd)&#125;&#123;if(dir&gt;0)&#123;print $0&#125;&#125;&#x27;</span> <span class="variable">$i</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>\_cache<span class="variable">$num</span> &amp;</span><br><span class="line">       num=$[<span class="variable">$num</span>+1]</span><br><span class="line">       sleep 0.5</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    awk_ps_num=`ps aux | grep <span class="string">&#x27;awk&#x27;</span> |  grep <span class="string">&#x27;cmd&#x27;</span> | grep <span class="string">&#x27;getline&#x27;</span> |wc -l`</span><br><span class="line">    <span class="keyword">while</span> [ <span class="variable">$awk_ps_num</span> -gt 1 ] ; <span class="keyword">do</span></span><br><span class="line">        sleep 10</span><br><span class="line">    awk_ps_num=`ps aux | grep <span class="string">&#x27;awk&#x27;</span> |  grep <span class="string">&#x27;cmd&#x27;</span> | grep <span class="string">&#x27;getline&#x27;</span> |wc -l`</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    cat <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>\_cache* &amp;&gt;  <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$libproj</span></span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span>\ablelib-split*</span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$libproj</span>\_cache*</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="delete-no-exists-函数模块"><a href="#delete-no-exists-函数模块" class="headerlink" title="delete_no_exists 函数模块"></a>delete_no_exists 函数模块</h3><p>确保没有匹配到部门的数据，使用正则二次匹配的数据条目的实效性;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">delete_no_exists</span></span> () &#123;</span><br><span class="line">    cat <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$other_file</span> | egrep <span class="string">&quot;(<span class="variable">$dir_10x</span>|<span class="variable">$share_dir</span>|<span class="variable">$s5_dir</span>)&quot;</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$pub_other_file</span></span><br><span class="line">    cat <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$other_file</span> | egrep -v <span class="string">&quot;(<span class="variable">$dir_10x</span>|<span class="variable">$share_dir</span>|<span class="variable">$s5_dir</span>)&quot;</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$work_other_file</span></span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span>\other-file-split*</span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$other_file</span>\_other\_cache*</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span> &amp;&amp; split <span class="variable">$pub_other_file</span> other-file-split -l 2000</span><br><span class="line">    num=0</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `ls <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span>\other-file-split*`; <span class="keyword">do</span></span><br><span class="line">       awk <span class="string">&#x27;&#123;cmd=&quot;ls -A &quot; $4 &quot; 2&gt; /dev/null  | wc -w&quot;&#125;&#123;cmd| getline dir;close(cmd)&#125;&#123;if(dir&gt;0)&#123;print $0&#125;&#125;&#x27;</span> <span class="variable">$i</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$other_file</span>\_other\_cache<span class="variable">$num</span> &amp;</span><br><span class="line">       num=$[<span class="variable">$num</span>+1]</span><br><span class="line">       sleep 0.5</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    awk_ps_num=`ps aux | grep <span class="string">&#x27;awk&#x27;</span> |  grep <span class="string">&#x27;cmd&#x27;</span> | grep <span class="string">&#x27;getline&#x27;</span> |wc -l`</span><br><span class="line">    <span class="keyword">while</span> [ <span class="variable">$awk_ps_num</span> -gt 1 ] ; <span class="keyword">do</span></span><br><span class="line">        sleep 10</span><br><span class="line">    awk_ps_num=`ps aux | grep <span class="string">&#x27;awk&#x27;</span> |  grep <span class="string">&#x27;cmd&#x27;</span> | grep <span class="string">&#x27;getline&#x27;</span> |wc -l`</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    cat <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$other_file</span>\_other\_cache* &amp;&gt;  <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$pub_other_file</span></span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span>\other-file-split*</span><br><span class="line">    rm -f <span class="variable">$project_dir</span><span class="variable">$other_storage_cache</span><span class="variable">$other_file</span>\_other\_cache*</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数的整合"><a href="#函数的整合" class="headerlink" title="函数的整合"></a>函数的整合</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [ ! <span class="variable">$1</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> -e <span class="string">&quot;Please input (delivery: &#x27;Post generated data&#x27; OR merge: &#x27;Merge the generated data&#x27; OR  38:&#x27;Are days overdue&#x27;)&quot;</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">&quot;delivery&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">   if_days=`date +<span class="string">&quot;%d&quot;</span>`</span><br><span class="line">   <span class="keyword">if</span> [ <span class="variable">$if_days</span> -ge 27 ]; <span class="keyword">then</span></span><br><span class="line">        now_time=`date +<span class="string">&quot;%Y-%m&quot;</span>`</span><br><span class="line">        now_time=`date -d +1\Month +<span class="string">&#x27;%Y-%m&#x27;</span>`</span><br><span class="line">        [ -d <span class="variable">$now_time</span> ] || mkdir <span class="variable">$now_time</span></span><br><span class="line">        other_storage_dir=<span class="string">&quot;<span class="variable">$now_time</span>/other&quot;</span></span><br><span class="line">        [ -d <span class="variable">$other_storage_dir</span> ] || mkdir <span class="variable">$other_storage_dir</span></span><br><span class="line">        other_storage_data=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/data/&quot;</span></span><br><span class="line">        [ -d <span class="variable">$other_storage_data</span> ] || mkdir <span class="variable">$other_storage_data</span></span><br><span class="line">        other_storage_cache=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/cache/&quot;</span></span><br><span class="line">        [ -d <span class="variable">$other_storage_cache</span> ] || mkdir <span class="variable">$other_storage_cache</span></span><br><span class="line">        other_storage_shell=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/shell/&quot;</span></span><br><span class="line">        [ -d <span class="variable">$other_storage_shell</span> ] || mkdir <span class="variable">$other_storage_shell</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; rm -f <span class="variable">$other_storage_data</span><span class="variable">$XXxj5_name</span>*FIND*2</span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; rm -f <span class="variable">$other_storage_data</span><span class="variable">$XXxj4_name</span>*FIND*2</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; rm -f <span class="variable">$other_storage_data</span><span class="variable">$XX5test_name</span>*FIND*2</span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; rm -f <span class="variable">$other_storage_shell</span><span class="variable">$XXxj5_name</span>*sh</span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; rm -f <span class="variable">$other_storage_shell</span><span class="variable">$XXxj4_name</span>*sh</span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; rm -f <span class="variable">$other_storage_shell</span><span class="variable">$XX5test_name</span>*sh</span><br><span class="line">  create_data_xx1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">&quot;merge&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">   data_aggregation</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$1</span> =~ [0-9] ]] &amp;&amp; [[ <span class="variable">$2</span> =~ [0-9] ]] ; <span class="keyword">then</span></span><br><span class="line">   over_due_name=<span class="string">&#x27;_overdue&#x27;</span></span><br><span class="line">   cycle=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">   stop_cycle=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">   time_year_month_day=`date -d -<span class="variable">$cycle</span>\day +<span class="string">&#x27;%Y-%m-%d&#x27;</span>`</span><br><span class="line">   libproj=<span class="string">&quot;able_lib.xls&quot;</span></span><br><span class="line">   libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line">   overall=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.ProjInfo.XJpath.xls&quot;</span></span><br><span class="line">   other_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.other.xls&quot;</span></span><br><span class="line">   ntime=`date +%s`</span><br><span class="line">   pub_other_file=<span class="string">&quot;pub_<span class="variable">$other_file</span>&quot;</span></span><br><span class="line">   work_other_file=<span class="string">&quot;work_<span class="variable">$other_file</span>&quot;</span></span><br><span class="line">   dir_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.dir.xls&quot;</span></span><br><span class="line">   over_due_name=<span class="string">&#x27;_overdue&#x27;</span></span><br><span class="line">   &gt; <span class="variable">$other_storage_cache</span><span class="variable">$dir_file</span></span><br><span class="line">   &gt; <span class="variable">$other_storage_cache</span><span class="variable">$libproj</span></span><br><span class="line">   &gt; <span class="variable">$other_storage_cache</span><span class="variable">$other_file</span></span><br><span class="line">   over_due_xx1</span><br><span class="line">   add_over_date</span><br><span class="line">   delete_old</span><br><span class="line">   delete_no_exists</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">&quot;create&quot;</span> ] &amp;&amp; [[ <span class="variable">$2</span> =~ [0-9] ]] ;<span class="keyword">then</span></span><br><span class="line">   over_due_name=<span class="string">&#x27;_overdue&#x27;</span></span><br><span class="line">   cycle=<span class="variable">$2</span></span><br><span class="line">   time_year_month_day=`date -d -<span class="variable">$cycle</span>\day +<span class="string">&#x27;%Y-%m-%d&#x27;</span>`</span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$time_year_month_day</span></span><br><span class="line">   libproj=<span class="string">&quot;able_lib.xls&quot;</span></span><br><span class="line">   libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line">   overall=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.ProjInfo.XJpath.xls&quot;</span></span><br><span class="line">   other_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.other.xls&quot;</span></span><br><span class="line">   ntime=`date +%s`</span><br><span class="line">   overall_XX</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h2 id="补充获取信息获取"><a href="#补充获取信息获取" class="headerlink" title="补充获取信息获取"></a>补充获取信息获取</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">project_dir=<span class="string">&#x27;/test/data/xjscan/&#x27;</span></span><br><span class="line">library_file=<span class="string">&#x27;project_library.xls&#x27;</span></span><br><span class="line">lms_dir_01=<span class="string">&#x27;/home/xxx/xxx/&#x27;</span></span><br><span class="line">lms_dir_02=<span class="string">&#x27;/home/xxx/xxx/&#x27;</span></span><br><span class="line">&gt; <span class="variable">$project_dir</span><span class="variable">$library_file</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `ls <span class="variable">$lms_dir_02</span>[0-9][0-9][0-9][0-9].[0-9][0-9]`;<span class="keyword">do</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;gsub(/;/,&quot;-&quot;,$13)&#125;&#123;gsub(/;/,&quot;-&quot;,$12)&#125;&#123;print $20&quot;/&quot;$10,$12,$13,$1,$24,$3,$22,$23,$4,$&quot;there is over days num&quot; &#125;&#x27;</span> <span class="variable">$i</span> &amp;&gt;&gt; <span class="variable">$project_dir</span><span class="variable">$library_file</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> `ls <span class="variable">$lms_dir_01</span>[0-9][0-9][0-9][0-9].[0-9][0-9]`;<span class="keyword">do</span></span><br><span class="line">    awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;gsub(/;/,&quot;-&quot;,$13)&#125;&#123;gsub(/;/,&quot;-&quot;,$12)&#125;&#123;print $20&quot;/&quot;$10,$12,$13,$1,$24,$3,$22,$23,$4,$&quot;there is over days num&quot; &#125;&#x27;</span> <span class="variable">$j</span> &amp;&gt;&gt; <span class="variable">$project_dir</span><span class="variable">$library_file</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="各报表生成脚本"><a href="#各报表生成脚本" class="headerlink" title="各报表生成脚本"></a>各报表生成脚本</h2><p>截止目前为止，数据扫描、数据合并、数据分离、数据分析、生成文档报表等模块已完成;<br>下面实现的，是使用python生成web页面表格、excel表格、vlookup数据透视(任务推进)</p>
<p>各项表格的生成包涵以下内容</p>
<p><strong>概况</strong> : 部门-属组-集群管理人员  信息分析人员 涉及数据量   平均超期天数；<br><strong>总体情况</strong>: 包涵部门名称 部门编号 运营 信息分析人员 项目编号 涉及数据量 项目名称 等信息；<br><strong>未匹配到相关负责任人的数据</strong>：包涵 部门编号和数据量信息；<br><strong>详情页</strong> 即所有目录条录与之对应的人员 部门 编号 数据量 超期天数等相关信息。</p>
<h3 id="web页面表格生成"><a href="#web页面表格生成" class="headerlink" title="web页面表格生成"></a>web页面表格生成</h3><p>生成web页面形势的表格最后可以发送nginx httpd 等相关服务器的uri路径;<br>使用WebStackPage开源javascript静态页url路径调用至同步生成的数据表格静态页;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> html</span><br><span class="line">report_dir = <span class="string">&quot;./report/&quot;</span> </span><br><span class="line">cycle=<span class="built_in">float</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">time_year_month_day = <span class="built_in">str</span>(datetime.date.today()-datetime.timedelta(days=cycle))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proj_xls_to_html</span>(<span class="params">file_path,sheet_name,save_name,table_title</span>):</span></span><br><span class="line">    lst1 = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        value = d.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        value[<span class="number">-1</span>] = value[<span class="number">-1</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value[<span class="number">5</span>]=<span class="built_in">float</span>(value[<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        lst1.append(value)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">    frame = pd.DataFrame(lst1,index=<span class="literal">None</span>,columns=table_title)</span><br><span class="line">    frame = pd.DataFrame(frame)</span><br><span class="line">    <span class="comment">#print(frame[&#x27;超期天数&#x27;])</span></span><br><span class="line">    frame[<span class="string">&#x27;超期天数&#x27;</span>] = frame[<span class="string">&#x27;超期天数&#x27;</span>].<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="string">f&#x27;&lt;font color=&quot;red&quot;&gt;<span class="subst">&#123;x&#125;</span>&lt;font&gt;&#x27;</span> <span class="keyword">if</span> <span class="built_in">float</span>(x) &gt;= <span class="number">44</span> <span class="keyword">else</span> x)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)  <span class="comment"># FOR TABLE &lt;th&gt;</span></span><br><span class="line">    html_string = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">     &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;####&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;gs_style.css&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;script type=&quot;text/javascript&quot; src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            .df tbody tr:last-child  &#123; background-color: #FF0000;&#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;p align=&quot;center&quot;&gt; &lt;br&gt;&lt;input id=&quot;myInput&quot; name=&quot;myInput&quot;&gt; &lt;span class=&quot;search&quot;&gt;  搜索  &lt;/span&gt; &lt;br&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;  </span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1777&quot; height=&quot;841&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;maodian.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1390&quot; height=&quot;797&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">         ##table##</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">         $(function() &#123;</span></span><br><span class="line"><span class="string">             $(&#x27;.search&#x27;).on(&#x27;click&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">                 // console.log($(&#x27;#myInput&#x27;).val());</span></span><br><span class="line"><span class="string">                 $(&#x27;table tbody tr&#x27;).hide()</span></span><br><span class="line"><span class="string">                     .filter(&quot;:contains(&#x27;&quot; + ($(&#x27;#myInput&#x27;).val()) + &quot;&#x27;)&quot;)</span></span><br><span class="line"><span class="string">                     .show();</span></span><br><span class="line"><span class="string">             &#125;)</span></span><br><span class="line"><span class="string">         &#125;)</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;####&#x27;</span>,sheet_name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(html.unescape(html_string.replace(<span class="string">&quot;##table##&quot;</span>,frame.to_html(classes=<span class="string">&#x27;mystyle&#x27;</span>,table_id=<span class="string">&#x27;mytable&#x27;</span>))))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proj_xls2_to_html</span>(<span class="params">file_path,sheet_name,save_name,table_title</span>):</span></span><br><span class="line">    lst1 = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        value = d.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        value[<span class="number">-1</span>] = value[<span class="number">-1</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        value = value[<span class="number">0</span>:<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value[<span class="number">5</span>]=<span class="built_in">float</span>(value[<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        lst1.append(value)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">    frame = pd.DataFrame(lst1,index=<span class="literal">None</span>,columns=table_title)</span><br><span class="line">    frame = pd.DataFrame(frame)</span><br><span class="line">    <span class="comment">#print(frame[&#x27;超期天数&#x27;])</span></span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)  <span class="comment"># FOR TABLE &lt;th&gt;</span></span><br><span class="line">    html_string = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;####&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;gs_style.css&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;script type=&quot;text/javascript&quot; src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            .df tbody tr:last-child  &#123; background-color: #FF0000;&#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;p align=&quot;center&quot;&gt; &lt;br&gt;&lt;input id=&quot;myInput&quot; name=&quot;myInput&quot;&gt; &lt;span class=&quot;search&quot;&gt;  搜索  &lt;/span&gt; &lt;br&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;  </span></span><br><span class="line"><span class="string">        &lt;canvas width=&quot;1777&quot; height=&quot;841&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;maodian.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1390&quot; height=&quot;797&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">         ##table##</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">         $(function() &#123;</span></span><br><span class="line"><span class="string">             $(&#x27;.search&#x27;).on(&#x27;click&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">                 // console.log($(&#x27;#myInput&#x27;).val());</span></span><br><span class="line"><span class="string">                 $(&#x27;table tbody tr&#x27;).hide()</span></span><br><span class="line"><span class="string">                     .filter(&quot;:contains(&#x27;&quot; + ($(&#x27;#myInput&#x27;).val()) + &quot;&#x27;)&quot;)</span></span><br><span class="line"><span class="string">                     .show();</span></span><br><span class="line"><span class="string">             &#125;)</span></span><br><span class="line"><span class="string">         &#125;)</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;####&#x27;</span>,sheet_name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(html.unescape(html_string.replace(<span class="string">&quot;##table##&quot;</span>,frame.to_html(classes=<span class="string">&#x27;mystyle&#x27;</span>,table_id=<span class="string">&#x27;mytable&#x27;</span>))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">projother_xls_to_html</span>(<span class="params">file_path,sheet_name,save_name,table_title</span>):</span></span><br><span class="line">    lst1 = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        value = d.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        value[<span class="number">-1</span>] = value[<span class="number">-1</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value[<span class="number">5</span>]=<span class="built_in">float</span>(value[<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        lst1.append(value)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">    frame = pd.DataFrame(lst1,index=<span class="literal">None</span>,columns=table_title)</span><br><span class="line">    frame = pd.DataFrame(frame)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)  <span class="comment"># FOR TABLE &lt;th&gt;</span></span><br><span class="line">    html_string = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;####&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;gs_style.css&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;script type=&quot;text/javascript&quot; src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            .df tbody tr:last-child  &#123; background-color: #FF0000;&#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;p align=&quot;center&quot;&gt; &lt;br&gt;&lt;input id=&quot;myInput&quot; name=&quot;myInput&quot;&gt; &lt;span class=&quot;search&quot;&gt;  搜索  &lt;/span&gt; &lt;br&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;  </span></span><br><span class="line"><span class="string">        &lt;canvas width=&quot;1777&quot; height=&quot;841&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;maodian.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1390&quot; height=&quot;797&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">         ##table##</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">         $(function() &#123;</span></span><br><span class="line"><span class="string">             $(&#x27;.search&#x27;).on(&#x27;click&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">                 // console.log($(&#x27;#myInput&#x27;).val());</span></span><br><span class="line"><span class="string">                 $(&#x27;table tbody tr&#x27;).hide()</span></span><br><span class="line"><span class="string">                     .filter(&quot;:contains(&#x27;&quot; + ($(&#x27;#myInput&#x27;).val()) + &quot;&#x27;)&quot;)</span></span><br><span class="line"><span class="string">                     .show();</span></span><br><span class="line"><span class="string">             &#125;)</span></span><br><span class="line"><span class="string">         &#125;)</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;####&#x27;</span>,sheet_name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">         f.write(html.unescape(html_string.replace(<span class="string">&quot;##table##&quot;</span>,frame.to_html(classes=<span class="string">&#x27;mystyle&#x27;</span>,table_id=<span class="string">&#x27;mytable&#x27;</span>))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proj_ztxls_to_html</span>(<span class="params">file_path,sheet_name,save_name,table_title</span>):</span></span><br><span class="line">    lst1 = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        value = d.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        value[<span class="number">-1</span>] = value[<span class="number">-1</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value[<span class="number">5</span>]=<span class="built_in">float</span>(value[<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        lst1.append(value)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">    frame = pd.DataFrame(lst1,index=<span class="literal">None</span>,columns=table_title)</span><br><span class="line">    frame = pd.DataFrame(frame)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)  <span class="comment"># FOR TABLE &lt;th&gt;</span></span><br><span class="line">    html_string = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;####&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;gs_style.css&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;script type=&quot;text/javascript&quot; src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            .df tbody tr:last-child  &#123; background-color: #FF0000;&#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;p align=&quot;center&quot;&gt; &lt;br&gt;&lt;input id=&quot;myInput&quot; name=&quot;myInput&quot;&gt; &lt;span class=&quot;search&quot;&gt;  搜索  &lt;/span&gt; &lt;br&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;  </span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1777&quot; height=&quot;841&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;maodian.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1390&quot; height=&quot;797&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">         ##table##</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">         $(function() &#123;</span></span><br><span class="line"><span class="string">             $(&#x27;.search&#x27;).on(&#x27;click&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">                 // console.log($(&#x27;#myInput&#x27;).val());</span></span><br><span class="line"><span class="string">                 $(&#x27;table tbody tr&#x27;).hide()</span></span><br><span class="line"><span class="string">                     .filter(&quot;:contains(&#x27;&quot; + ($(&#x27;#myInput&#x27;).val()) + &quot;&#x27;)&quot;)</span></span><br><span class="line"><span class="string">                     .show();</span></span><br><span class="line"><span class="string">             &#125;)</span></span><br><span class="line"><span class="string">         &#125;)</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;####&#x27;</span>,sheet_name)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(html.unescape(html_string.replace(<span class="string">&quot;##table##&quot;</span>,frame.to_html(classes=<span class="string">&#x27;mystyle&#x27;</span>,table_id=<span class="string">&#x27;mytable&#x27;</span>))))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crate_shuju_toushi</span>(<span class="params">file_path,sheet_name2,index_name,values_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                       department_name,new_department_name,personnel_name,table_title,values_name_over,over_name</span>):</span></span><br><span class="line">    f = pd.read_table(file_path,sep=<span class="string">&#x27;\t&#x27;</span>,header=<span class="literal">None</span>)</span><br><span class="line">    f.columns=table_title</span><br><span class="line">    res = pd.pivot_table(f, index=[index_name], values=[values_name, values_name_over],</span><br><span class="line">                         aggfunc=&#123;values_name: np.<span class="built_in">sum</span>, values_name_over: np.mean&#125;, margins=<span class="literal">True</span>)</span><br><span class="line">    all_xinxi_title = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((res.index)), <span class="built_in">list</span>(res[values_name]),<span class="built_in">list</span>(res[values_name_over])))</span><br><span class="line">    <span class="comment"># print(all_xinxi_title)</span></span><br><span class="line">    department_personnel = <span class="built_in">list</span>(<span class="built_in">zip</span>(f[department_name], f[index_name],f[values_name_over]))</span><br><span class="line">    department_personnel_size_list = []</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_xinxi_title:</span><br><span class="line">         <span class="keyword">for</span> department_personnel_list <span class="keyword">in</span> department_personnel:</span><br><span class="line">             <span class="keyword">if</span> user[<span class="number">0</span>] <span class="keyword">in</span> department_personnel_list:</span><br><span class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                     <span class="keyword">continue</span></span><br><span class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">                     <span class="keyword">continue</span></span><br><span class="line">                 department_personnel_size_list.append((department_personnel_list[<span class="number">0</span>],user[<span class="number">0</span>],user[<span class="number">1</span>],user[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">    end_department_personnel_size_list = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(department_personnel_size_list)), key=<span class="keyword">lambda</span> x:x[<span class="number">2</span>] ,reverse=<span class="literal">True</span>)</span><br><span class="line">    all_xinxi_title_end = all_xinxi_title[<span class="number">-1</span>]</span><br><span class="line">    all_xinxi_title_end = <span class="built_in">list</span>(all_xinxi_title_end)</span><br><span class="line">    all_xinxi_title_end.insert(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    end_department_personnel_size_list.append(all_xinxi_title_end)</span><br><span class="line">    <span class="comment">#end_department_personnel_size_list.insert(0,[new_department_name,personnel_name,values_name])</span></span><br><span class="line">    end_department_personnel_size_list.pop()</span><br><span class="line"></span><br><span class="line">    input_list=[]</span><br><span class="line">    user_volue = []</span><br><span class="line">    <span class="keyword">for</span> user2 <span class="keyword">in</span> end_department_personnel_size_list:</span><br><span class="line">        user2 = <span class="built_in">list</span>(user2)</span><br><span class="line">        <span class="keyword">if</span> user2[<span class="number">1</span>] == user_volue:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        user_volue = user2[<span class="number">1</span>]</span><br><span class="line">        input_list.append(user2)</span><br><span class="line">    sum_list = np.array(input_list)</span><br><span class="line">    all_size = <span class="built_in">sum</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">float</span>,sum_list[:,<span class="number">-2</span>][:])))</span><br><span class="line">    input_list.append([<span class="string">&quot; &quot;</span>,<span class="string">&quot;ALL size&quot;</span>,all_size])</span><br><span class="line">    pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">    <span class="comment">#frame = pd.DataFrame(input_list,index=None)</span></span><br><span class="line">    frame = pd.DataFrame(input_list,columns=[new_department_name,personnel_name,values_name,over_name])</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)  <span class="comment"># FOR TABLE &lt;th&gt;</span></span><br><span class="line">    html_string = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;####&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;gs_style.css&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;script type=&quot;text/javascript&quot; src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            .df tbody tr:last-child  &#123; background-color: #FF0000;&#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;p align=&quot;center&quot;&gt; &lt;br&gt;&lt;input id=&quot;myInput&quot; name=&quot;myInput&quot;&gt; &lt;span class=&quot;search&quot;&gt;  搜索  &lt;/span&gt; &lt;br&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;</span></span><br><span class="line"><span class="string">        &lt;canvas width=&quot;1777&quot; height=&quot;841&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;maodian.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1390&quot; height=&quot;797&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">         ##table##</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">         $(function() &#123;</span></span><br><span class="line"><span class="string">             $(&#x27;.search&#x27;).on(&#x27;click&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">                 // console.log($(&#x27;#myInput&#x27;).val());</span></span><br><span class="line"><span class="string">                 $(&#x27;table tbody tr&#x27;).hide()</span></span><br><span class="line"><span class="string">                     .filter(&quot;:contains(&#x27;&quot; + ($(&#x27;#myInput&#x27;).val()) + &quot;&#x27;)&quot;)</span></span><br><span class="line"><span class="string">                     .show();</span></span><br><span class="line"><span class="string">             &#125;)</span></span><br><span class="line"><span class="string">         &#125;)</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;####&#x27;</span>,sheet_name2)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">         f.write(html.unescape(html_string.replace(<span class="string">&quot;##table##&quot;</span>,frame.to_html(classes=<span class="string">&#x27;mystyle&#x27;</span>,table_id=<span class="string">&#x27;mytable&#x27;</span>))))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_space_toushi</span>(<span class="params">save_name,sheet_name2,department_num,</span></span></span><br><span class="line"><span class="function"><span class="params">                        sum_name,data_total,index_name,values_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                        file_path,table_title,values_name_over,over_name</span>):</span></span><br><span class="line">    f = pd.read_table(file_path,sep=<span class="string">&#x27;\t&#x27;</span>,header=<span class="literal">None</span>,dtype=&#123;<span class="string">&#x27;业务部门利润编号&#x27;</span>:<span class="built_in">str</span>&#125;)</span><br><span class="line">    f.columns = table_title</span><br><span class="line">    res = pd.pivot_table(f, index=index_name, values=[values_name,values_name_over], aggfunc=&#123;values_name:np.<span class="built_in">sum</span>,values_name_over:np.mean&#125;,margins=<span class="literal">True</span>)</span><br><span class="line">    all_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>(res.index), <span class="built_in">list</span>(res[values_name]),<span class="built_in">list</span>(res[values_name_over])))</span><br><span class="line"></span><br><span class="line">    space_list = []</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_list:</span><br><span class="line">        user2 = <span class="built_in">list</span>(user)[<span class="number">1</span>]</span><br><span class="line">        user4 = <span class="built_in">list</span>(user)[<span class="number">2</span>]</span><br><span class="line">        user3 = <span class="built_in">list</span>(<span class="built_in">list</span>(user)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            space_list.append((user3[<span class="number">1</span>],user2,user4))</span><br><span class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">            space_list.append((user3[<span class="number">1</span>],user2,user4))</span><br><span class="line"></span><br><span class="line">    sum_list = []</span><br><span class="line"></span><br><span class="line">    space_data = pd.DataFrame(space_list)</span><br><span class="line">    space_data_group = space_data.groupby([<span class="number">0</span>]).agg(&#123;[<span class="number">1</span>][<span class="number">0</span>]:<span class="string">&#x27;sum&#x27;</span>,[<span class="number">2</span>][<span class="number">0</span>]:<span class="string">&#x27;mean&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    space_list_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(space_data_group.index.tolist(), space_data_group.values.tolist()))</span><br><span class="line">    space_list = []</span><br><span class="line">    <span class="keyword">for</span> space <span class="keyword">in</span> space_list_list:</span><br><span class="line">        print(space)</span><br><span class="line">        space_index_value = space[<span class="number">0</span>], space[<span class="number">1</span>][<span class="number">0</span>], space[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">        space_list.append(space_index_value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> slist <span class="keyword">in</span> space_list:</span><br><span class="line">        sum_list.append(slist[<span class="number">1</span>])</span><br><span class="line">    sum_list=<span class="built_in">sum</span>(sum_list)</span><br><span class="line">    sort_space_list = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(space_list)), key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>] ,reverse=<span class="literal">True</span>)</span><br><span class="line">    sort_space_list.append((sum_name, sum_list))</span><br><span class="line">    <span class="comment">#sort_space_list.insert(0,(department_num,data_total))</span></span><br><span class="line">    pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">    frame = pd.DataFrame(sort_space_list,index=<span class="literal">None</span>,columns=[department_num,data_total,over_name])</span><br><span class="line">    <span class="comment">#frame = pd.DataFrame(sort_space_list,index=None)</span></span><br><span class="line">    <span class="comment">#frame = pd.DataFrame(frame)</span></span><br><span class="line">    pd.set_option(<span class="string">&#x27;colheader_justify&#x27;</span>, <span class="string">&#x27;center&#x27;</span>)  <span class="comment"># FOR TABLE &lt;th&gt;</span></span><br><span class="line">    html_string = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;####&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;gs_style.css&quot;/&gt;</span></span><br><span class="line"><span class="string">        &lt;script type=&quot;text/javascript&quot; src=&quot;jquery.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">            .df tbody tr:last-child  &#123; background-color: #FF0000;&#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">      &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;p align=&quot;center&quot;&gt; &lt;br&gt;&lt;input id=&quot;myInput&quot; name=&quot;myInput&quot;&gt; &lt;span class=&quot;search&quot;&gt;  搜索  &lt;/span&gt; &lt;br&gt; &lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;div&gt;  </span></span><br><span class="line"><span class="string">        &lt;canvas width=&quot;1777&quot; height=&quot;841&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">&lt;script src=&quot;maodian.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;canvas width=&quot;1390&quot; height=&quot;797&quot; style=&quot;position: fixed; left: 0px; top: 0px; z-index: 2147483647; pointer-events: none;&quot;&gt;&lt;/canvas&gt;</span></span><br><span class="line"><span class="string">         ##table##</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">         $(function() &#123;</span></span><br><span class="line"><span class="string">             $(&#x27;.search&#x27;).on(&#x27;click&#x27;, function() &#123;</span></span><br><span class="line"><span class="string">                 // console.log($(&#x27;#myInput&#x27;).val());</span></span><br><span class="line"><span class="string">                 $(&#x27;table tbody tr&#x27;).hide()</span></span><br><span class="line"><span class="string">                     .filter(&quot;:contains(&#x27;&quot; + ($(&#x27;#myInput&#x27;).val()) + &quot;&#x27;)&quot;)</span></span><br><span class="line"><span class="string">                     .show();</span></span><br><span class="line"><span class="string">             &#125;)</span></span><br><span class="line"><span class="string">         &#125;)</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">      &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;####&#x27;</span>,sheet_name2)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(save_name, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(html.unescape(html_string.replace(<span class="string">&quot;##table##&quot;</span>,frame.to_html(classes=<span class="string">&#x27;mystyle&#x27;</span>,table_id=<span class="string">&#x27;mytable&#x27;</span>))))</span><br><span class="line">    <span class="comment"># for all_space_list in sort_space_list:</span></span><br><span class="line">    <span class="comment">#     sheet.append(all_space_list)</span></span><br><span class="line">    <span class="comment"># wb.save(save_name)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sheet_name = <span class="string">&#x27;详情&#x27;</span></span><br><span class="line">    save_name = report_dir +  <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + sheet_name + <span class="string">&#x27;.html&#x27;</span></span><br><span class="line">    file_path = report_dir + <span class="string">&#x27;able.&#x27;</span> + time_year_month_day +<span class="string">&#x27;.lib.xls&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;数据大小B&#x27;</span>,<span class="string">&#x27;文件生成时间&#x27;</span>,<span class="string">&#x27;部门编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;文件属主&#x27;</span>,<span class="string">&#x27;项目目录&#x27;</span>,<span class="string">&#x27;文库编号&#x27;</span>,<span class="string">&#x27;所属组&#x27;</span>,<span class="string">&#x27;超期天数&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;项目编号&#x27;</span>, <span class="string">&#x27;运营经理&#x27;</span>, <span class="string">&#x27;信息分析&#x27;</span>, <span class="string">&#x27;项目名称&#x27;</span>,<span class="string">&#x27;分期号&#x27;</span>]</span><br><span class="line">    proj_xls_to_html(file_path=file_path,</span><br><span class="line">                     sheet_name=sheet_name,</span><br><span class="line">                     table_title=table_title,</span><br><span class="line">                     save_name=save_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sheet_name2 = <span class="string">&#x27;概况&#x27;</span></span><br><span class="line">    file_path = report_dir +  time_year_month_day + <span class="string">&#x27;.ProjInfo.XJpath.xls&#x27;</span></span><br><span class="line">    save_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + sheet_name2 + <span class="string">&#x27;.html&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;业务部门名称&#x27;</span>,<span class="string">&#x27;业务部门XX编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;运营经理&#x27;</span>,<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;项目编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;涉及数据量大小（G）&#x27;</span>,<span class="string">&#x27;项目平均超期(天)&#x27;</span>,<span class="string">&#x27;项目名称&#x27;</span>,<span class="string">&#x27;文库编号&#x27;</span>,]</span><br><span class="line">    index_name = <span class="string">&#x27;信息分析&#x27;</span></span><br><span class="line">    values_name = <span class="string">&#x27;涉及数据量大小（G）&#x27;</span></span><br><span class="line">    department_name = <span class="string">&#x27;业务部门名称&#x27;</span></span><br><span class="line">    new_department_name = <span class="string">&#x27;部门&#x27;</span></span><br><span class="line">    personnel_name = <span class="string">&#x27;人员&#x27;</span></span><br><span class="line">    values_name_over = <span class="string">&#x27;项目平均超期(天)&#x27;</span></span><br><span class="line">    over_name = <span class="string">&#x27;总体平均超期(天)&#x27;</span></span><br><span class="line">    crate_shuju_toushi(</span><br><span class="line">                       sheet_name2=sheet_name2,</span><br><span class="line">                       index_name=index_name,</span><br><span class="line">                       values_name=values_name,</span><br><span class="line">                       department_name=department_name,</span><br><span class="line">                       new_department_name=new_department_name,</span><br><span class="line">                       file_path = file_path,</span><br><span class="line">                       personnel_name=personnel_name,</span><br><span class="line">                       table_title=table_title,</span><br><span class="line">                       over_name=over_name,</span><br><span class="line">                       values_name_over=values_name_over,)</span><br><span class="line"></span><br><span class="line">    sheet_name2 = <span class="string">&#x27;未匹配人员数据量&#x27;</span></span><br><span class="line">    index_name = [<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;业务部门XX编号&#x27;</span>]</span><br><span class="line">    file_path = report_dir +  time_year_month_day + <span class="string">&#x27;.ProjInfo.XJpath.xls&#x27;</span></span><br><span class="line">    save_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + sheet_name2 + <span class="string">&#x27;.html&#x27;</span></span><br><span class="line">    department_num = <span class="string">&#x27;部门编号&#x27;</span></span><br><span class="line">    data_total = <span class="string">&#x27;数据量（G）&#x27;</span></span><br><span class="line">    values_name = <span class="string">&#x27;涉及数据量大小（G）&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;XX部门名称&#x27;</span>,<span class="string">&#x27;XX部门利润编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;运营XX&#x27;</span>,<span class="string">&#x27;XX信息分析&#x27;</span>,<span class="string">&#x27;项目编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;涉及数据量大小（G）&#x27;</span>,<span class="string">&#x27;项目平均超期(天)&#x27;</span>,<span class="string">&#x27;项目名称&#x27;</span>,<span class="string">&#x27;文库XX编号&#x27;</span>,]</span><br><span class="line">    sum_name = <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">    values_name_over = <span class="string">&#x27;项目平均超期(天)&#x27;</span></span><br><span class="line">    over_name = <span class="string">&#x27;总体平均超期(天)&#x27;</span></span><br><span class="line">    create_space_toushi(index_name=index_name,</span><br><span class="line">                        save_name=save_name,</span><br><span class="line">                        department_num=department_num,</span><br><span class="line">                        data_total=data_total,</span><br><span class="line">                        file_path=file_path,</span><br><span class="line">                        table_title=table_title,</span><br><span class="line">                        values_name=values_name,</span><br><span class="line">                        sheet_name2=sheet_name2,</span><br><span class="line">                        sum_name=sum_name,</span><br><span class="line">                        over_name=over_name,</span><br><span class="line">                        values_name_over=values_name_over, )</span><br><span class="line">    sheet_name = <span class="string">&#x27;总体情况&#x27;</span></span><br><span class="line">    file_path = report_dir +  time_year_month_day + <span class="string">&#x27;.ProjInfo.XJpath.xls&#x27;</span></span><br><span class="line">    save_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + sheet_name + <span class="string">&#x27;.html&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;XX部门名称&#x27;</span>,<span class="string">&#x27;XX部门XX编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;运营XX&#x27;</span>,<span class="string">&#x27;信息分析XX&#x27;</span>,<span class="string">&#x27;XX项目编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;涉及数据量大小（G）&#x27;</span>,<span class="string">&#x27;项目平均超期(天)&#x27;</span>,<span class="string">&#x27;项目名称&#x27;</span>,]</span><br><span class="line">    proj_xls2_to_html(file_path=file_path,</span><br><span class="line">                     sheet_name=sheet_name,</span><br><span class="line">                     table_title=table_title,</span><br><span class="line">                     save_name=save_name)</span><br></pre></td></tr></table></figure>
<h3 id="excel-表格生成"><a href="#excel-表格生成" class="headerlink" title="excel 表格生成"></a>excel 表格生成</h3><p>这个表格的生成，包涵页面中的所有数据和信息，由于详情页较大，不便上线上过滤，提供多种形势的分析与数据下载;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> openpyxl <span class="keyword">as</span> xl</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> openpyxl.cell.cell <span class="keyword">import</span> ILLEGAL_CHARACTERS_RE</span><br><span class="line"></span><br><span class="line">report_dir = <span class="string">&#x27;./report/&#x27;</span></span><br><span class="line">cycle =  <span class="built_in">float</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">time_year_month_day = <span class="built_in">str</span>(datetime.date.today()-datetime.timedelta(days=cycle))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proj_xls_to_xlsx</span>(<span class="params">file_path,sheet_name,save_name,tableTitle=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(save_name):</span><br><span class="line">        wb = xl.Workbook()</span><br><span class="line">        wb.save(save_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        wb = xl.load_workbook(save_name)</span><br><span class="line">    ws1 = wb.create_sheet(<span class="number">0</span>)</span><br><span class="line">    ws1.title = sheet_name</span><br><span class="line">    <span class="keyword">if</span> tableTitle != <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tableTitle)):</span><br><span class="line">            c = n + <span class="number">1</span></span><br><span class="line">            ws1.cell(row=<span class="number">1</span>, column=c).value = tableTitle[n]</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        d = ILLEGAL_CHARACTERS_RE.sub(<span class="string">r&#x27;&#x27;</span>, <span class="built_in">str</span>(d))</span><br><span class="line">        value = d.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">           <span class="comment"># print(value)</span></span><br><span class="line">            value[<span class="number">5</span>]=<span class="built_in">float</span>(value[<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        ws1.append(value)</span><br><span class="line">    wb.save(save_name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crate_shuju_toushi</span>(<span class="params">save_name, sheet_name, sheet_name2, index_name, values_name, department_name,values_name_over,</span></span></span><br><span class="line"><span class="function"><span class="params">                       new_department_name, personnel_name,over_name</span>):</span></span><br><span class="line">    f = pd.read_excel(io=save_name, sheet_name=sheet_name)</span><br><span class="line">    res = pd.pivot_table(f, index=[index_name], values=[values_name,values_name_over], aggfunc=&#123;values_name:np.<span class="built_in">sum</span>, values_name_over:np.mean&#125;,margins=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    wb = xl.load_workbook(save_name)</span><br><span class="line">    old_title = wb.worksheets[<span class="number">0</span>]</span><br><span class="line">    old_title.title = sheet_name2</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    all_xinxi_title = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((res.index)), <span class="built_in">list</span>(res[values_name]),<span class="built_in">list</span>(res[values_name_over])))</span><br><span class="line">    <span class="comment"># print(all_xinxi_title)</span></span><br><span class="line">    department_personnel = <span class="built_in">list</span>(<span class="built_in">zip</span>(f[department_name], f[index_name],f[values_name_over]))</span><br><span class="line">    <span class="comment"># print(department_personnel)</span></span><br><span class="line">    department_personnel_size_list = []</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_xinxi_title:</span><br><span class="line">         <span class="keyword">for</span> department_personnel_list <span class="keyword">in</span> department_personnel:</span><br><span class="line">             <span class="keyword">if</span> user[<span class="number">0</span>] <span class="keyword">in</span> department_personnel_list:</span><br><span class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                     <span class="keyword">continue</span></span><br><span class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">                     <span class="keyword">continue</span></span><br><span class="line">                 department_personnel_size_list.append((department_personnel_list[<span class="number">0</span>], user[<span class="number">0</span>], user[<span class="number">1</span>],user[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">    end_department_personnel_size_list = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(department_personnel_size_list)), key=<span class="keyword">lambda</span> x: x[<span class="number">2</span>],</span><br><span class="line">                                                 reverse=<span class="literal">True</span>)</span><br><span class="line">    all_xinxi_title_end = all_xinxi_title[<span class="number">-1</span>]</span><br><span class="line">    all_xinxi_title_end = <span class="built_in">list</span>(all_xinxi_title_end)</span><br><span class="line">    all_xinxi_title_end.insert(<span class="number">0</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    end_department_personnel_size_list.append(all_xinxi_title_end)</span><br><span class="line">    end_department_personnel_size_list.insert(<span class="number">0</span>, [new_department_name, personnel_name, values_name,over_name])</span><br><span class="line">    end_department_personnel_size_list.pop()</span><br><span class="line"></span><br><span class="line">    user_volue = []</span><br><span class="line">    <span class="keyword">for</span> user2 <span class="keyword">in</span> end_department_personnel_size_list:</span><br><span class="line">        user2 = <span class="built_in">list</span>(user2)</span><br><span class="line">        <span class="keyword">if</span> user2[<span class="number">1</span>] == user_volue:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        user_volue = user2[<span class="number">1</span>]</span><br><span class="line">        old_title.append(user2)</span><br><span class="line">    wb.save(save_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_space_toushi</span>(<span class="params">save_name, sheet_name, sheet_name2, department_num, sum_name, data_total, index_name,over_name,values_name_over,</span></span></span><br><span class="line"><span class="function"><span class="params">                        values_name</span>):</span></span><br><span class="line">    f = pd.read_excel(io=save_name, sheet_name=sheet_name, dtype=&#123;<span class="string">&#x27;业务部门利润编号&#x27;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">    res = pd.pivot_table(f, index=index_name, values=[values_name,values_name_over], aggfunc=&#123;values_name:np.<span class="built_in">sum</span>,values_name_over:np.mean&#125;,margins=<span class="literal">True</span>)</span><br><span class="line">    all_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>(res.index), <span class="built_in">list</span>(res[values_name]),<span class="built_in">list</span>(res[values_name_over])))</span><br><span class="line"></span><br><span class="line">    wb = xl.load_workbook(save_name)</span><br><span class="line">    sheet = wb.create_sheet(sheet_name2)</span><br><span class="line"></span><br><span class="line">    space_list = []</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_list:</span><br><span class="line"></span><br><span class="line">        user2 = <span class="built_in">list</span>(user)[<span class="number">1</span>]</span><br><span class="line">        user4 = <span class="built_in">list</span>(user)[<span class="number">2</span>]</span><br><span class="line">        user3 = <span class="built_in">list</span>(<span class="built_in">list</span>(user)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            space_list.append((user3[<span class="number">1</span>], user2,user4))</span><br><span class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">            space_list.append((user3[<span class="number">1</span>], user2,user4))</span><br><span class="line">    sum_list = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    space_data = pd.DataFrame(space_list)</span><br><span class="line">    space_data_group = space_data.groupby([<span class="number">0</span>]).agg(&#123;[<span class="number">1</span>][<span class="number">0</span>]:<span class="string">&#x27;sum&#x27;</span>,[<span class="number">2</span>][<span class="number">0</span>]:<span class="string">&#x27;mean&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    space_list_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(space_data_group.index.tolist(), space_data_group.values.tolist()))</span><br><span class="line"></span><br><span class="line">    space_list = []</span><br><span class="line">    <span class="keyword">for</span> space <span class="keyword">in</span> space_list_list:</span><br><span class="line">        print(space)</span><br><span class="line">        space_index_value = space[<span class="number">0</span>], space[<span class="number">1</span>][<span class="number">0</span>], space[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">        space_list.append(space_index_value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> slist <span class="keyword">in</span> space_list:</span><br><span class="line">        print(slist)</span><br><span class="line">        sum_list.append(slist[<span class="number">1</span>])</span><br><span class="line">    sum_list = <span class="built_in">sum</span>(sum_list)</span><br><span class="line">    sort_space_list = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(space_list)), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    sort_space_list.append((sum_name, sum_list))</span><br><span class="line">    sort_space_list.insert(<span class="number">0</span>, (department_num, data_total,over_name))</span><br><span class="line">    <span class="keyword">for</span> all_space_list <span class="keyword">in</span> sort_space_list:</span><br><span class="line">        print(all_space_list)</span><br><span class="line">        sheet.append(all_space_list)</span><br><span class="line">    wb.save(save_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sheet_name = <span class="string">&#x27;详情&#x27;</span></span><br><span class="line">    </span><br><span class="line">    SAVE_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    save_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    file_path = report_dir + <span class="string">&#x27;able.&#x27;</span> + time_year_month_day +<span class="string">&#x27;.lib.xls&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;数据大小B&#x27;</span>,<span class="string">&#x27;文件生成时间&#x27;</span>,<span class="string">&#x27;部门编号&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;文件属主&#x27;</span>,<span class="string">&#x27;项目目录&#x27;</span>,<span class="string">&#x27;文库编号&#x27;</span>,<span class="string">&#x27;所属组&#x27;</span>,<span class="string">&#x27;超期天数&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;项目编号&#x27;</span>,<span class="string">&#x27;运营XX&#x27;</span>,<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;项目名称&#x27;</span>,<span class="string">&#x27;分期号&#x27;</span>]</span><br><span class="line">    proj_xls_to_xlsx(file_path=file_path,</span><br><span class="line">                     sheet_name=sheet_name,</span><br><span class="line">                     save_name=save_name,</span><br><span class="line">                     tableTitle=table_title,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sheet_name = <span class="string">&#x27;总体情况&#x27;</span></span><br><span class="line">    save_name = report_dir +  <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    file_path = report_dir + time_year_month_day + <span class="string">&#x27;.ProjInfo.XJpath.xls&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;业务部门名称&#x27;</span>,<span class="string">&#x27;业务部门利润编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;运营经理&#x27;</span>,<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;项目编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;涉及数据量大小（G）&#x27;</span>,<span class="string">&#x27;项目平均超期(天)&#x27;</span>,<span class="string">&#x27;项目名称&#x27;</span>,<span class="string">&#x27;文库编号&#x27;</span>,]</span><br><span class="line">    proj_xls_to_xlsx(file_path=file_path,</span><br><span class="line">                     sheet_name=sheet_name,</span><br><span class="line">                     tableTitle=table_title,</span><br><span class="line">                     save_name=save_name)</span><br><span class="line"></span><br><span class="line">    save_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    sheet_name = <span class="string">&#x27;总体情况&#x27;</span></span><br><span class="line">    sheet_name2 = <span class="string">&#x27;概况&#x27;</span></span><br><span class="line">    index_name = <span class="string">&#x27;信息分析&#x27;</span></span><br><span class="line">    values_name = <span class="string">&#x27;涉及数据量大小（G）&#x27;</span></span><br><span class="line">    department_name = <span class="string">&#x27;业务部门名称&#x27;</span></span><br><span class="line">    new_department_name = <span class="string">&#x27;部门&#x27;</span></span><br><span class="line">    personnel_name = <span class="string">&#x27;人员&#x27;</span></span><br><span class="line">    values_name_over = <span class="string">&#x27;项目平均超期(天)&#x27;</span></span><br><span class="line">    over_name = <span class="string">&#x27;总体平均超期(天)&#x27;</span></span><br><span class="line">    crate_shuju_toushi(save_name=save_name,</span><br><span class="line">                       sheet_name=sheet_name,</span><br><span class="line">                       sheet_name2=sheet_name2,</span><br><span class="line">                       index_name=index_name,</span><br><span class="line">                       values_name=values_name,</span><br><span class="line">                       department_name=department_name,</span><br><span class="line">                       new_department_name=new_department_name,</span><br><span class="line">                       personnel_name=personnel_name,</span><br><span class="line">                       values_name_over=values_name_over,</span><br><span class="line">                       over_name=over_name</span><br><span class="line">                       )</span><br><span class="line"></span><br><span class="line">    index_name = [<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;业务部门利润编号&#x27;</span>]</span><br><span class="line">    save_name = report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    sheet_name = <span class="string">&#x27;总体情况&#x27;</span></span><br><span class="line">    department_num = <span class="string">&#x27;部门编号&#x27;</span></span><br><span class="line">    data_total = <span class="string">&#x27;数据量（G）&#x27;</span></span><br><span class="line">    values_name = <span class="string">&#x27;涉及数据量大小（G）&#x27;</span></span><br><span class="line">    sheet_name2 = <span class="string">&#x27;未匹配人员数据量&#x27;</span></span><br><span class="line">    sum_name = <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">    values_name_over = <span class="string">&#x27;项目平均超期(天)&#x27;</span></span><br><span class="line">    over_name = <span class="string">&#x27;总体平均超期(天)&#x27;</span></span><br><span class="line">    create_space_toushi(index_name=index_name,</span><br><span class="line">                        save_name=save_name,</span><br><span class="line">                        sheet_name=sheet_name,</span><br><span class="line">                        department_num=department_num,</span><br><span class="line">                        data_total=data_total,</span><br><span class="line">                        values_name=values_name,</span><br><span class="line">                        sheet_name2=sheet_name2,</span><br><span class="line">                        sum_name=sum_name,</span><br><span class="line">                        values_name_over=values_name_over,</span><br><span class="line">                        over_name=over_name)</span><br></pre></td></tr></table></figure>
<h3 id="数据提交、删除进度把控"><a href="#数据提交、删除进度把控" class="headerlink" title="数据提交、删除进度把控"></a>数据提交、删除进度把控</h3><p>多表格vlookup进度分析;<br>有一部份变量采用主脚本的环境变量，这里不再列出;<br>把主脚本公示当天生成的数据拷贝过来，按删除的进度再进行二次表格生成;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">id_group_file=<span class="string">&#x27;xj_id_class&#x27;</span></span><br><span class="line">library_file=<span class="string">&#x27;project_library.xls&#x27;</span></span><br><span class="line">over_due_name=<span class="string">&#x27;_overdue&#x27;</span></span><br><span class="line">now_time=`date +<span class="string">&quot;%Y-%m&quot;</span>`</span><br><span class="line">report_dir=<span class="string">&#x27;./report/&#x27;</span></span><br><span class="line">send_dir=<span class="string">&#x27;./send/&#x27;</span></span><br><span class="line">[ -d <span class="variable">$now_time</span> ] || mkdir <span class="variable">$now_time</span></span><br><span class="line">other_storage_dir=<span class="string">&quot;<span class="variable">$now_time</span>/other&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_dir</span> ] || mkdir <span class="variable">$other_storage_dir</span></span><br><span class="line">other_storage_data=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/data/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_data</span> ] || mkdir <span class="variable">$other_storage_data</span></span><br><span class="line">other_storage_cache=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/cache/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_cache</span> ] || mkdir <span class="variable">$other_storage_cache</span></span><br><span class="line">other_storage_shell=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/shell/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_shell</span> ] || mkdir <span class="variable">$other_storage_shell</span></span><br><span class="line">cycle=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">time_year_month_day=`date -d -<span class="variable">$cycle</span>\day +<span class="string">&#x27;%Y-%m-%d&#x27;</span>`</span><br><span class="line">libproj=<span class="string">&quot;able_lib.xls&quot;</span></span><br><span class="line">libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line">overall=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.ProjInfo.XJpath.xls&quot;</span></span><br><span class="line">other_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.other.xls&quot;</span></span><br><span class="line">ntime=`date +%s`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">vlook_up</span></span> () &#123;</span><br><span class="line">   <span class="keyword">if</span> ! [ -f <span class="variable">$send_dir</span>/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>-old.xlsx ] ; <span class="keyword">then</span></span><br><span class="line">       cp -a <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span> <span class="variable">$send_dir</span></span><br><span class="line">       cp -a <span class="variable">$other_storage_cache</span><span class="variable">$overall</span> <span class="variable">$send_dir</span></span><br><span class="line">       LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> &amp;&amp; <span class="built_in">source</span> py3_new/bin/activate &amp;&amp; python re_create.py <span class="variable">$cycle</span></span><br><span class="line">    mv <span class="variable">$send_dir</span>/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>.xlsx <span class="variable">$send_dir</span>/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>-old.xlsx</span><br><span class="line">    rm -f <span class="variable">$send_dir</span><span class="variable">$libproj_location</span></span><br><span class="line">    rm -f <span class="variable">$send_dir</span><span class="variable">$overall</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">if</span>   [ -f <span class="variable">$send_dir</span>/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>\.xlsx ] ; <span class="keyword">then</span></span><br><span class="line">        rm -f  <span class="variable">$send_dir</span>/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>\.xlsx</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">if</span> ! [ -f <span class="variable">$send_dir</span>/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>\.xlsx ] ; <span class="keyword">then</span></span><br><span class="line">        cp -a <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span> <span class="variable">$send_dir</span></span><br><span class="line">        (<span class="built_in">cd</span> <span class="variable">$send_dir</span> &amp;&amp; split <span class="variable">$libproj_location</span> ablelib-split -l 2000)</span><br><span class="line">    num=0</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `ls <span class="variable">$send_dir</span>\ablelib-split*`; <span class="keyword">do</span></span><br><span class="line">       awk <span class="string">&#x27;&#123;cmd=&quot;ls -A &quot; $5 &quot; 2&gt; /dev/null  | wc -w&quot;&#125;&#123;cmd| getline dir;close(cmd)&#125;&#123;if(dir&gt;0)&#123;print $0&#125;&#125;&#x27;</span> <span class="variable">$i</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$send_dir</span>\_cache<span class="variable">$num</span> &amp;</span><br><span class="line">       num=$[<span class="variable">$num</span>+1]</span><br><span class="line">       sleep 0.5</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    awk_ps_num=`ps aux | grep <span class="string">&#x27;awk&#x27;</span> |  grep <span class="string">&#x27;cmd&#x27;</span> | grep <span class="string">&#x27;getline&#x27;</span> |wc -l`</span><br><span class="line">    <span class="keyword">while</span> [ <span class="variable">$awk_ps_num</span> -gt 1 ] ; <span class="keyword">do</span></span><br><span class="line">        sleep 10</span><br><span class="line">    awk_ps_num=`ps aux | grep <span class="string">&#x27;awk&#x27;</span> |  grep <span class="string">&#x27;cmd&#x27;</span> | grep <span class="string">&#x27;getline&#x27;</span> |wc -l`</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    cat <span class="variable">$send_dir</span>\_cache* | awk -F =<span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;print $1,$2,$3,$4,$5,$6,$7,$8&#125;&#x27;</span> &amp;&gt; <span class="variable">$send_dir</span><span class="variable">$libproj</span></span><br><span class="line">    rm -f <span class="variable">$send_dir</span>\ablelib-split*</span><br><span class="line">    rm -f <span class="variable">$send_dir</span>\_cache*</span><br><span class="line">    &gt; <span class="variable">$project_dir</span><span class="variable">$send_dir</span><span class="variable">$overall</span></span><br><span class="line">     awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num]&quot;&quot;$5;t=wenku[num]&quot;-&quot;$2&quot;&quot;$5;a[s]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9;b[t]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&#125;ARGIND==2&#123;c=$6&quot;&quot;$3;if(a[c])&#123;print $0,a[c]&#125; else if(b[c])&#123;print $0,b[c]&#125;&#125;&#x27;</span> <span class="variable">$project_dir</span><span class="variable">$library_file</span>  <span class="variable">$project_dir</span><span class="variable">$send_dir</span><span class="variable">$libproj</span>  &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$libproj_location</span></span><br><span class="line">     awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;split($1,wenku,&quot;/&quot;);num=length(wenku);s=wenku[num]&quot;&quot;$5;t=wenku[num]&quot;-&quot;$2&quot;&quot;$5;a[s]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9;b[t]=$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$9&#125;ARGIND==2&#123;c=$6&quot;&quot;$3;if(!a[c] &amp;&amp; ! b[c])&#123;print $0,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;,&quot;-&quot;&#125;&#125;&#x27;</span> <span class="variable">$project_dir</span><span class="variable">$library_file</span>  <span class="variable">$project_dir</span><span class="variable">$send_dir</span><span class="variable">$libproj</span>  &amp;&gt;&gt; <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$libproj_location</span></span><br><span class="line">     mv <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$libproj_location</span> <span class="variable">$project_dir</span><span class="variable">$send_dir</span><span class="variable">$libproj_location</span></span><br><span class="line">     cat <span class="variable">$project_dir</span><span class="variable">$id_group_file</span> | awk -F <span class="string">&#x27;,&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;print $1,$2,$3,$4,$5&#125;&#x27;</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$id_group_file</span></span><br><span class="line">     awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;ARGIND==1&#123;s=$1;a[s]=$4&quot;-&quot;$2&quot;-&quot;$3&#125;ARGIND==2&#123;c=$3;if(a[c])&#123;print $0,a[c]&#125; else &#123;print $0,&quot;-&quot;&#125;&#125;&#x27;</span> <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$id_group_file</span>  <span class="variable">$project_dir</span><span class="variable">$send_dir</span><span class="variable">$libproj_location</span> | awk -F <span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;print $14,$3,$6,$1,$9,$10,$11,$12,$8&#125;&#x27;</span> |  awk -F<span class="string">&#x27;\t&#x27;</span> -v OFS=<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;a[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]+=$4;b[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]=b[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]$3&quot;,&quot;;c[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]+=$9;d[$1&quot;\t&quot;$2&quot;\t&quot;$6&quot;\t&quot;$7&quot;\t&quot;$8&quot;\t&quot;$5]++&#125;END&#123;for (i in a)print i,a[i],c[i]/d[i],b[i]&#125;&#x27;</span>   | sed <span class="string">&#x27;s/,$//g&#x27;</span> | awk -F <span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;&#123;printf &quot;%s\t%s\t%s\t%s\t%s\t%.2f\t%s\t%s\t%s\n&quot;,$1,$2,$3,$4,$6,$7/1024/1024/1024,$8,$5,$9&#125;&#x27;</span> &amp;&gt; <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$overall</span></span><br><span class="line">    mv <span class="variable">$project_dir</span><span class="variable">$send_dir</span>.<span class="variable">$overall</span> <span class="variable">$project_dir</span><span class="variable">$send_dir</span><span class="variable">$overall</span>  </span><br><span class="line">    LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> &amp;&amp; <span class="built_in">source</span> py3_new/bin/activate &amp;&amp; python re_create.py <span class="variable">$cycle</span>   </span><br><span class="line">    LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> &amp;&amp; <span class="built_in">source</span> py3_new/bin/activate &amp;&amp; python vlook_XXxc.py <span class="variable">$cycle</span>   </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vlook_up</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> openpyxl <span class="keyword">as</span> xl</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">report_dir = <span class="string">&#x27;./send/&#x27;</span></span><br><span class="line">difference_cycle=<span class="built_in">float</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">time_year_month_day = <span class="built_in">str</span>(datetime.date.today()-datetime.timedelta(days=difference_cycle))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_last_excel</span>(<span class="params">old_sheet,new_sheet,gaikuang</span>):</span></span><br><span class="line">    pd01 = pd.read_excel(old_sheet,sheet_name=gaikuang,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    pd02 = pd.read_excel(new_sheet,sheet_name=gaikuang,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    pd11 = pd.read_excel(old_sheet,sheet_name=<span class="string">&#x27;未匹配人员数据量&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    pd12 = pd.read_excel(new_sheet,sheet_name=<span class="string">&#x27;未匹配人员数据量&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    result = pd.merge(pd01,pd02[[<span class="string">&#x27;人员&#x27;</span>,<span class="string">&#x27;涉及数据量大小（G）&#x27;</span>]],on=<span class="string">&#x27;人员&#x27;</span>)</span><br><span class="line">    result_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((result[<span class="string">&#x27;部门&#x27;</span>])),<span class="built_in">list</span>((result[<span class="string">&#x27;人员&#x27;</span>])),<span class="built_in">list</span>((result[<span class="string">&#x27;涉及数据量大小（G）_x&#x27;</span>])),<span class="built_in">list</span>((result[<span class="string">&#x27;涉及数据量大小（G）_y&#x27;</span>]))))</span><br><span class="line"></span><br><span class="line">    not_match = pd.merge(pd11,pd12[[<span class="string">&#x27;部门编号&#x27;</span>,<span class="string">&#x27;数据量（G）&#x27;</span>]],left_on=<span class="string">&#x27;部门编号&#x27;</span>,right_on=<span class="string">&#x27;部门编号&#x27;</span>)</span><br><span class="line">    print(not_match)</span><br><span class="line">    not_match_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((not_match[<span class="string">&#x27;部门编号&#x27;</span>])),<span class="built_in">list</span>((not_match[<span class="string">&#x27;数据量（G）_x&#x27;</span>])),<span class="built_in">list</span>((not_match[<span class="string">&#x27;数据量（G）_y&#x27;</span>]))))</span><br><span class="line"></span><br><span class="line">    wb2 = xl.load_workbook(new_sheet)</span><br><span class="line">    remove_sheet1 = wb2[gaikuang]</span><br><span class="line">    remove_sheet2 = wb2[<span class="string">&#x27;未匹配人员数据量&#x27;</span>]</span><br><span class="line">    wb2.remove(remove_sheet1)</span><br><span class="line">    wb2.remove(remove_sheet2)</span><br><span class="line">    wb2.save(new_sheet)</span><br><span class="line"></span><br><span class="line">    wb2 = xl.load_workbook(new_sheet)</span><br><span class="line">    sheet21 = wb2.create_sheet(gaikuang,<span class="number">0</span>)</span><br><span class="line">    sheet22 = wb2.create_sheet(<span class="string">&#x27;未匹配人员数据量&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    result_head = [<span class="string">&#x27;部门&#x27;</span>,<span class="string">&#x27;人员&#x27;</span>,<span class="string">&#x27;涉及数据量（G）&#x27;</span>,<span class="string">&#x27;第二次涉及数据量（G）&#x27;</span>,<span class="string">&#x27;任务额差&#x27;</span>]</span><br><span class="line">    result_list.insert(<span class="number">0</span>,result_head)</span><br><span class="line">    result_for_num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result_list:</span><br><span class="line">        result_i = <span class="built_in">list</span>(i)</span><br><span class="line">        <span class="keyword">if</span> result_for_num != <span class="number">1</span>:</span><br><span class="line">            result_chae=i[<span class="number">2</span>]-i[<span class="number">3</span>]-i[<span class="number">2</span>]*<span class="number">0.2</span></span><br><span class="line">            result_i.append(<span class="built_in">float</span>(<span class="string">&#x27;%.2f&#x27;</span>% result_chae))</span><br><span class="line">        result_for_num = result_for_num + <span class="number">1</span></span><br><span class="line">        sheet21.append(result_i)</span><br><span class="line"></span><br><span class="line">    not_match_head = [<span class="string">&#x27;部门编号&#x27;</span>,<span class="string">&#x27;数据量（G）&#x27;</span>,<span class="string">&#x27;第二次数据量（G）&#x27;</span>,<span class="string">&#x27;任务额差&#x27;</span>]</span><br><span class="line">    not_match_list.insert(<span class="number">0</span>,not_match_head)</span><br><span class="line">    not_match_for_num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span>  not_match_list:</span><br><span class="line">        not_match_j = <span class="built_in">list</span>(j)</span><br><span class="line">        <span class="keyword">if</span> not_match_for_num != <span class="number">1</span>:</span><br><span class="line">            not_match_chae=j[<span class="number">1</span>]-j[<span class="number">2</span>]-j[<span class="number">1</span>]*<span class="number">0.2</span></span><br><span class="line">            not_match_j.append(<span class="built_in">float</span>(<span class="string">&#x27;%.2f&#x27;</span>% not_match_chae))</span><br><span class="line">        not_match_for_num = not_match_for_num + <span class="number">1</span></span><br><span class="line">        sheet22.append(not_match_j)</span><br><span class="line">    wb2.save(new_sheet)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    old_sheet=report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;-old.xlsx&#x27;</span></span><br><span class="line">    new_sheet=report_dir + <span class="string">&#x27;XX-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    gaikuang=<span class="string">&#x27;概况&#x27;</span></span><br><span class="line">    add_last_excel(old_sheet=old_sheet,new_sheet=new_sheet,gaikuang=gaikuang)</span><br></pre></td></tr></table></figure>
<p>到此为止，主要核心部分已经完成；<br><strong>这里这只是测试的形势列出了一个存储、一个地区的形势，按生产环境时的需求可以多地部署，多存储扫描。</strong><br>下面呢，可以定义定时投递扫描盘，screen 中加入执行更新自动化</p>
<h2 id="定义每月投递扫盘"><a href="#定义每月投递扫盘" class="headerlink" title="定义每月投递扫盘"></a>定义每月投递扫盘</h2><p>定义每月投递扫盘，并记录执行日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crontab -e </span></span><br><span class="line">47 15 26,14,1 * * <span class="built_in">cd</span> /<span class="built_in">test</span>/data/xjscan &amp;&amp; bash -x  xjsan_other.sh delivery &amp;&gt;  /<span class="built_in">test</span>/data/xjscan/logfile</span><br></pre></td></tr></table></figure>
<h2 id="定义整合数据分析脚本、自动结果同步"><a href="#定义整合数据分析脚本、自动结果同步" class="headerlink" title="定义整合数据分析脚本、自动结果同步;"></a>定义整合数据分析脚本、自动结果同步;</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">id_group_file=<span class="string">&#x27;xj_id_class&#x27;</span></span><br><span class="line">library_file=<span class="string">&#x27;project_library.xls&#x27;</span></span><br><span class="line">over_due_name=<span class="string">&#x27;_overdue&#x27;</span></span><br><span class="line">now_time=`date +<span class="string">&quot;%Y-%m&quot;</span>`</span><br><span class="line">report_dir=<span class="string">&#x27;./report/&#x27;</span></span><br><span class="line">[ -d <span class="variable">$now_time</span> ] || mkdir <span class="variable">$now_time</span></span><br><span class="line">other_storage_dir=<span class="string">&quot;<span class="variable">$now_time</span>/other&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_dir</span> ] || mkdir <span class="variable">$other_storage_dir</span></span><br><span class="line">other_storage_data=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/data/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_data</span> ] || mkdir <span class="variable">$other_storage_data</span></span><br><span class="line">other_storage_cache=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/cache/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_cache</span> ] || mkdir <span class="variable">$other_storage_cache</span></span><br><span class="line">other_storage_shell=<span class="string">&quot;<span class="variable">$other_storage_dir</span>/shell/&quot;</span></span><br><span class="line">[ -d <span class="variable">$other_storage_shell</span> ] || mkdir <span class="variable">$other_storage_shell</span></span><br><span class="line"></span><br><span class="line">cycle=<span class="string">&quot;# &quot;</span>there is over days num<span class="string">&quot;&quot;</span></span><br><span class="line">time_year_month_day=`date -d -<span class="variable">$cycle</span>\day +<span class="string">&#x27;%Y-%m-%d&#x27;</span>`</span><br><span class="line">libproj=<span class="string">&quot;able_lib.xls&quot;</span></span><br><span class="line">libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line">overall=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.ProjInfo.XJpath.xls&quot;</span></span><br><span class="line">other_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.other.xls&quot;</span></span><br><span class="line">ntime=`date +%s`</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; bash -x xjsan_other.sh <span class="variable">$cycle</span> 100000 &amp;&gt; real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; bash -x xjsan_other.sh create <span class="variable">$cycle</span> &amp;&gt;&gt; real_time.log</span><br><span class="line">sleep 5</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; cp -a <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span>  <span class="variable">$report_dir</span> &amp;&gt;&gt; real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; cp -a  <span class="variable">$other_storage_cache</span><span class="variable">$overall</span> <span class="variable">$report_dir</span> &amp;&gt;&gt; real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; cp -a <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span>  <span class="variable">$xiangqing_cache</span>  &amp;&gt;&gt; real_time.log</span><br><span class="line">LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> &amp;&amp; <span class="built_in">source</span> py3_new/bin/activate &amp;&amp; python html_create.py <span class="variable">$cycle</span>  &amp;&gt;&gt; real_time.log</span><br><span class="line">LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> &amp;&amp; <span class="built_in">source</span> py3_new/bin/activate &amp;&amp; python create.py <span class="variable">$cycle</span>  &amp;&gt;&gt; real_time.log</span><br><span class="line">ssh  root@xx.xx.xx.10 <span class="string">&quot;sed -i &quot;</span>s/XX-XJ-DATASHOW-20.*xlsx/XX-XJ-DATASHOW-<span class="variable">$time_year_month_day</span>.xlsx/g<span class="string">&quot; /var/www/html/public/index.html&quot;</span>  &amp;&gt;&gt; real_time.log</span><br><span class="line">scp <span class="variable">$report_dir</span>\XX-XJ-DATASHOW* root@xx.xx.xx.10:/var/www/html/public  &amp;&gt;&gt; real_time.log</span><br><span class="line">cycle=<span class="string">&quot;&quot;</span>there is over days num<span class="string">&quot; &quot;</span></span><br><span class="line">time_year_month_day=`date -d -<span class="variable">$cycle</span>\day +<span class="string">&#x27;%Y-%m-%d&#x27;</span>`</span><br><span class="line">libproj=<span class="string">&quot;able_lib.xls&quot;</span></span><br><span class="line">libproj_location=<span class="string">&quot;able.<span class="variable">$time_year_month_day</span>.lib.xls &quot;</span></span><br><span class="line">overall=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.ProjInfo.XJpath.xls&quot;</span></span><br><span class="line">other_file=<span class="string">&quot;<span class="variable">$time_year_month_day</span>.other.xls&quot;</span></span><br><span class="line">ntime=`date +%s`</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; bash -x xjsan_other.sh <span class="variable">$cycle</span> <span class="string">&quot;there is over days num&quot;</span> &amp;&gt; real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; bash -x xjsan_other.sh create <span class="variable">$cycle</span> &amp;&gt;&gt; real_time.log</span><br><span class="line">sleep 5</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; cp -a <span class="variable">$other_storage_cache</span><span class="variable">$libproj_location</span>  <span class="variable">$report_dir</span> &amp;&gt;&gt; real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span> &amp;&amp; cp -a  <span class="variable">$other_storage_cache</span><span class="variable">$overall</span> <span class="variable">$report_dir</span> &amp;&gt;&gt; real_time.log</span><br><span class="line">LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> &amp;&amp; <span class="built_in">source</span> py3_new/bin/activate &amp;&amp; python add_7days_create.py <span class="variable">$cycle</span>  &amp;&gt;&gt; real_time.log</span><br><span class="line">scp <span class="variable">$report_dir</span>\XX-XJ-DATASHOW* root@xx.xx.xx.10:/var/www/html/public  &amp;&gt;&gt; real_time.log</span><br><span class="line">update_time=`date +<span class="string">&quot;%Y年%m月%d日%H时%M分&quot;</span>`</span><br><span class="line">ssh  root@xx.xx.xx.10 <span class="string">&quot;sed -i &quot;</span>s/<span class="comment">##.*##/##$update_time##/g&quot; /var/www/html/public/index.html&quot;  &amp;&gt;&gt; real_time.log</span></span><br><span class="line">ssh  root@xx.xx.xx.10 <span class="string">&quot;sed -i &quot;</span>s/XX-XJ-DATASHOW-INTERVAL-.*xlsx/XX-XJ-DATASHOW-INTERVAL-<span class="variable">$time_year_month_day</span>.xlsx/g<span class="string">&quot; /var/www/html/public/index.html&quot;</span>  &amp;&gt;&gt; real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span>  &amp;&amp; rm -f <span class="variable">$report_dir</span>*xls &amp;&gt;&gt;  real_time.log</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$project_dir</span>  &amp;&amp; rm -f <span class="variable">$report_dir</span>\XX-XJ-DATASHOW* &amp;&gt;&gt; real_time.log</span><br></pre></td></tr></table></figure>
<p>找一台计算性质的节点，进行后台运算与结果同步</p>
<h2 id="运算置入会话后台"><a href="#运算置入会话后台" class="headerlink" title="运算置入会话后台"></a>运算置入会话后台</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># screen -S xjscan</span></span><br><span class="line"><span class="comment">#  while sleep 1 ; do bash -x run_create.sh ; done</span></span><br><span class="line"><span class="comment"># ctrl + a,d #置入后台</span></span><br></pre></td></tr></table></figure>
<h2 id="WebStackPage开源地址与链接修改"><a href="#WebStackPage开源地址与链接修改" class="headerlink" title="WebStackPage开源地址与链接修改"></a>WebStackPage开源地址与链接修改</h2><p><a href="https://github.com/WebStackPage/WebStackPage.github.io">WebStackPage地址</a></p>
<p>web页面部署到httpd或(nginx)环境后修改链接地址与公示提示信息内容即可;<br>因这里结果涉及部门信息不再展示。</p>
<h2 id="补充awk-统计相关"><a href="#补充awk-统计相关" class="headerlink" title="补充awk 统计相关"></a>补充awk 统计相关</h2><h3 id="一条命令分类标签、并相加、标签对应的目录个数"><a href="#一条命令分类标签、并相加、标签对应的目录个数" class="headerlink" title="一条命令分类标签、并相加、标签对应的目录个数"></a>一条命令分类标签、并相加、标签对应的目录个数</h3><p><strong>格试如下</strong></p>
<p><strong>254522 oss://gentype-hz/hangzhou_project/xxx.depth.stat.xls “nj_project” “1”</strong><br>对应<strong>size dir tags tag_num</strong></p>
<p>实现功能: tags与 tag_num 列对应的位置相同，则size相加，统计目录个数，最后一列是各个目录明细用,号分隔</p>
<p><code>awk &#39;&#123;b[$3&quot; &quot;$4]=a[$3&quot; &quot;$4]++?b[$3&quot; &quot;$4]&quot;,&quot;$2:$2;c[$3&quot; &quot;$4]+=$1&#125;END&#123;for(i in b)&#123;if(a[i]&gt;1)print i,a[i],c[i],b[i]&#125;&#125;&#39;</code><br>最后输出<strong>tags tags_num dir_num size_sum dir_detail,dir_detail,dir_detail…</strong></p>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p><strong>主气常静，客气常动，客气先盛而后衰，主气先微而后壮</strong></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>关于某业务线域名未及时备案导致的脱机故障与报告</title>
    <url>/2019/09/20/%E5%85%B3%E4%BA%8E%E6%9F%90%E4%B8%9A%E5%8A%A1%E7%BA%BF%E8%84%B1%E6%9C%BA%E6%8A%A5%E5%91%8A/</url>
    <content><![CDATA[<p>[toc]</p>
<p><strong>注: 因公司相关保密信息，相关域名及敏感词汇用xx代替</strong>;</p>
<h1 id="关于某业务线域名未及时备案导致的故障与脱机报告"><a href="#关于某业务线域名未及时备案导致的故障与脱机报告" class="headerlink" title="关于某业务线域名未及时备案导致的故障与脱机报告"></a>关于某业务线域名未及时备案导致的故障与脱机报告</h1><p>以下是对接的开发第一时间反馈的故障图</p>
<p><img src="/images/tuojibaogao.png" class="lazyload" data-srcset="/images/tuojibaogao.png" srcset="data:image/png;base64,666" alt=""></p>
<ol>
<li>因教师XX-APP及服务器部署环境架构由XX技术团队独立搭建，交接给XX中心仅做正常运维保障，教师XX业务一直进行中。XX、购买、XX系统、XX系统…未停止，且xx部人力投放在其他大项目中开发和维护。</li>
</ol>
<h2 id="问题的反馈"><a href="#问题的反馈" class="headerlink" title="问题的反馈"></a>问题的反馈</h2><ol>
<li>于2019年09月03日晚对接的相关业务部门反馈教师相关线务业的网站和接口不能访问与调用超时；</li>
<li>研发对接的相关接口如上图，当对接的业务线的开发反馈时，说可能与上次故障Cassandr 数据库未能正常访问类似;</li>
<li>在运维组与部门总监未曾沟通协作的情况下，负责对接此业务线的相关运维将问题暂定到Cassandr 数据库上;</li>
<li>9月4日上午8点多，研发部和运维组同学协同查找问题，最后发现xxx.xxxteacher.net;未在阿里云备案，导致域名失效无法访问的结果。</li>
</ol>
<h2 id="故障总结"><a href="#故障总结" class="headerlink" title="故障总结"></a>故障总结</h2><ol>
<li>由于xxx.xxxteacher.net未备案导致被阿里云拦截后无法请求到数据库，实际上当时数据库正常运行。</li>
<li>运维组对应业务线的同学接到保障以后第一时间处理，发现系统并无异常，但一直无法访问，无法恢复。</li>
<li>运维同学未能想到是域名的问题，以为是数据库应用无法处理请求的未知故障，所以尝试重启数据库。</li>
<li>因为此数据库之前一直由福建方面单独维护，大量参数设置问题，导致数据库加载过慢。</li>
<li>运维组同学尝试迁移，但发现XX团队申请时的数据库的服务器不在集团的集群之内，数据量太大所以放弃。</li>
<li>运维组连夜尝试恢复数据库应用，但都是显示系统日志正常，Cassandr未能启动，直到后半夜未能找到解决原因。</li>
<li>早上升级了数据库二进制文件后成功启动。然后进行接口测试时发现请求不到的原因是域名被阿里云禁止，接着通过Nginx域名转发与反代技术恢复了业务。</li>
</ol>
<h2 id="业务核心问题"><a href="#业务核心问题" class="headerlink" title="业务核心问题"></a>业务核心问题</h2><ol>
<li>域名没有备案，主要原因与教师业务线团队沟通是因为法人变更流程没完成，导致无法备案。</li>
<li>数据库重启后恢复过慢，这是由于应用架构是福建团队搭建，当时独立于运维组，运维组对这个数据库系统不熟悉，并且原方案中没有高可用性，致使数据库单点失败。 </li>
</ol>
<h2 id="XX中心紧急处理方案"><a href="#XX中心紧急处理方案" class="headerlink" title="XX中心紧急处理方案"></a>XX中心紧急处理方案</h2><ol>
<li>当时业务线对应的研发技术团队，在上午定位到问题后，技术总监曾沟与个人沟通，能否有什么办法先尽快恢复生产的服务器;</li>
<li>经思量、 因阿里云DNS结合阿里云公网IP扫描到未备案经需数小时的时间，而若扫描别的云平台公网IP与别的公网ip需要数十天，甚至数月的时间;</li>
<li>故~ 考虑公司有相关IDC机房的多个公网IP，可以将公网ip映射至现有的keepalived虚拟ip;</li>
<li>并将keepalived 上的nginx 添加一个虚拟主机的配置文件，使用nginx 反向代理的方法再代理至原有的业务线所在的各阿里云的服务器私有ip(因公司内部有专线，若无专线的情况下，可以考虑直接反代至阿里云的公网ip，但在反向代理的时候不对host 请求做转发)；</li>
<li>最后在测试无误的情况下，对应的域名解析做变更，解析至公司IDC公网ip;</li>
<li>最终于上午10时20分左右，相关域名的整体业务线恢复访问。</li>
</ol>
<h2 id="领导后续重点工作安排"><a href="#领导后续重点工作安排" class="headerlink" title="领导后续重点工作安排"></a>领导后续重点工作安排</h2><ol>
<li>教师XX-xx部xxx继续对域名备案，进度实时通知到XX中心。</li>
<li>XX中心将对教师xx阿里云服务器架构多部署新一套负载服务器环境及数据备份，完成时间：2019年9月13日。</li>
</ol>
<h2 id="责任鉴定"><a href="#责任鉴定" class="headerlink" title="责任鉴定"></a>责任鉴定</h2><ol>
<li>教师XX-xx部-xx 掌握阿里云域名管理，域名管理不善，阿里云已多次提示域名未备案，未曾及时反应;</li>
<li>运维组对教师xx保障服务器运维处理存在判断有误，未能积极组建问题处理小组群,并及时通知大家寻求帮助与协调处理;</li>
</ol>
<h2 id="故障后感"><a href="#故障后感" class="headerlink" title="故障后感"></a>故障后感</h2><ol>
<li>做为技术人员的我们应该对我们的技术专业有深入的理解，在判断到是大的问题或故障时需及时主动协调部门人员与寻求帮助;</li>
<li>不断的积累各项运维架构技术与学习各个应用的场景;</li>
<li>不断积累曾遇到的问题、与故障的处理经验、并标准化且规范化录入文案;</li>
<li>遇到问题时，不要着急，需冷静且快速的定位问题，要明白打不倒你的终将使你变得强大;</li>
<li>感慨nginx 功能之强大，还需要深入研究。</li>
</ol>
<p><strong>文章发布后也愿能提供给更多公司的技术团队一些经验与帮助</strong></p>
<h2 id="补充nginx-反向代理的配置"><a href="#补充nginx-反向代理的配置" class="headerlink" title="补充nginx 反向代理的配置"></a>补充nginx 反向代理的配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">upstream xxx.teachxxxx.net &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里就是要反代的阿里云ip与端口</span></span><br><span class="line">    <span class="comment"># 相当访问中间加了一层</span></span><br><span class="line">    server xx.xx.xxx.xx:xxxx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    charset utf-8;</span><br><span class="line">    listen xxx;</span><br><span class="line">    server_name xxx.teachxxxx.net ;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="comment"># 注类似这样的故障，host 不再转发，不然还会被检测到</span></span><br><span class="line">        proxy_buffer_size 64k;</span><br><span class="line">        proxy_buffers 32 32k;</span><br><span class="line">        proxy_busy_buffers_size 128k;</span><br><span class="line">        proxy_pass http://xxx.teachxxxx.net;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log /var/<span class="built_in">log</span>/nginx/xxx.teachxxxx.net.log;</span><br><span class="line">    error_log /var/<span class="built_in">log</span>/nginx/xxx.teachxxxx.net.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注，至于平常生产中的443转发的实现，可参考博客中其余的nginx配置</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xxx.teachxxxx.net;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$HOST</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>其余系统应急恢复与该配置的实现类似</strong></p>
<h3 id="nginx-相关学习文章与总结"><a href="#nginx-相关学习文章与总结" class="headerlink" title="nginx 相关学习文章与总结"></a>nginx 相关学习文章与总结</h3><p><a href="https://www.asjin.com/2018/10/29/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E6%98%8E%E7%BB%86/">常用服务器配置明细</a><br><a href="https://www.asjin.com/2019/03/11/nginx-lua-redis%E5%AE%9E%E7%9F%AD%E9%93%BE%E6%8E%A5%E8%BD%AC%E5%8F%91%E9%95%BF%E9%93%BE%E6%8E%A5/">nginx+lua+redis实现短链接转发</a><br><a href="https://www.asjin.com/2018/04/26/nginx%E5%B8%B8%E7%94%A8%E6%9E%B6%E6%9E%84/">nginx常用架构</a></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>fabric自动化之kvm私有云服务器快速开通与交付</title>
    <url>/2019/03/20/fabric%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bkvm%E7%A7%81%E6%9C%89%E4%BA%91%E5%BF%AB%E9%80%9F%E5%BC%80%E9%80%9A/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="一、先来看看需求及对应的设计图"><a href="#一、先来看看需求及对应的设计图" class="headerlink" title="一、先来看看需求及对应的设计图"></a>一、先来看看需求及对应的设计图</h2><p><img src="/images/kvm-automation.png" class="lazyload" data-srcset="/images/kvm-automation.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li><p>什么是Fabric<br>Fabric是一个Python的库，提供了丰富的同SSH交互的接口，可以用来在本地或远程机器上自动化、流水化地执行Shell命令。<br>非常适合用来做应用的远程部署及系统维护。简单易用，只需懂得基本的Shell命令。</p>
</li>
<li><p>版本区分<br>Fabric：官方Fabric，兼容 Python 2 &amp; Python 3，但不兼容Fabric 1.x的fabfile；<br>fabric2： 与Fabric相同，仅作为平滑迁移（使用Fabric包安装1.x 版本，使用Fabric2包安装2.x版本，来实现1.x和2.x的共存）；<br>Fabric3：是一个基于Fabric 1.x 的fork，兼容Python2 &amp; Python3，兼容 Fabric1.x 的 fabfile；</p>
</li>
</ul>
<h2 id="二、项目结构"><a href="#二、项目结构" class="headerlink" title="二、项目结构"></a>二、项目结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kvm_create&#x2F;</span><br><span class="line">├── application</span><br><span class="line">│   ├── appcreate.py</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── kvmcreate.py</span><br><span class="line">├── config</span><br><span class="line">│   ├── hosts.py</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── messages.py</span><br><span class="line">│   └── test</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       ├── kvm_config.py</span><br><span class="line">├── files</span><br><span class="line">│   ├── adminset_agent.tar.gz</span><br><span class="line">│   ├── mysqlxxxx</span><br><span class="line">│   │   ├── backup.sh</span><br><span class="line">│   │   ├── init_backup.sh</span><br><span class="line">│   │   ├── lepus_slowquery.sh</span><br><span class="line">│   │   ├── mysql-x.x.xx-linux-glibcx.xx-x86_64.tar.gz</span><br><span class="line">│   │   └── percona-toolkit_x.x.xx-x.tar.gz</span><br><span class="line">│   ├── mysqlxxxx</span><br><span class="line">│   │   ├── backup.sh</span><br><span class="line">│   │   ├── init_backup.sh</span><br><span class="line">│   │   ├── lepus_slowquery.sh</span><br><span class="line">│   │   ├── mysql-x.xx.xx-linux-glibcx.xx-86_64.tar.gz</span><br><span class="line">│   │   └── percona-toolkit_x.x.xx-x.tar.gz</span><br><span class="line">│   ├── nginx</span><br><span class="line">│   │   ├── nginx-1.xx.x.tar.gz</span><br><span class="line">│   │   └── nginx-1.xx.x.tar.gz</span><br><span class="line">│   ├── node_exporter</span><br><span class="line">│   │   ├── LICENSE</span><br><span class="line">│   │   ├── node_exporter</span><br><span class="line">│   │   └── NOTICE</span><br><span class="line">│   ├── php</span><br><span class="line">│   │   ├── php-x.x.xx.tar.gz</span><br><span class="line">│   │   ├── php-x.x.xx.tar.gz</span><br><span class="line">│   │   ├── php-x.x.xx.tar.gz</span><br><span class="line">│   │   ├── php-x.x.xx.tar.gz</span><br><span class="line">│   │   ├── php-x.x.xx.tar.gz</span><br><span class="line">│   │   └── php.ini</span><br><span class="line">│   ├── redis</span><br><span class="line">│   │   └── redis-x.x.x.tar.gz</span><br><span class="line">│   └── zabbix</span><br><span class="line">│       └── zabbix-x.x.x.tar.gz</span><br><span class="line">├── kernel</span><br><span class="line">│   ├── clone.py</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── last.py</span><br><span class="line">│   ├── mysqlxxxx.py</span><br><span class="line">│   ├── mysqlxx.py</span><br><span class="line">│   ├── nginx.py</span><br><span class="line">│   ├── php.py</span><br><span class="line">│   ├── redis.py</span><br><span class="line">│   ├── standard.py</span><br><span class="line">│   ├── start.py</span><br><span class="line">│   ├── yum.py</span><br><span class="line">│   ├── zabbix_agent.py</span><br><span class="line">├── kvm.py</span><br><span class="line">├── local</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── localall.py</span><br><span class="line">│   ├── mysqlxxxxreplace.py</span><br><span class="line">│   ├── mysqlxxreplace.py</span><br><span class="line">│   ├── nginxreplace.py</span><br><span class="line">│   ├── phpreplace.py</span><br><span class="line">│   ├── redisreplace.py</span><br><span class="line">│   ├── replacetemp.py</span><br><span class="line">│   ├── zabbixreplace.py</span><br><span class="line">├── templates</span><br><span class="line">│   ├── hosts</span><br><span class="line">│   ├── ifcfg-eth0</span><br><span class="line">│   ├── mysqlxx</span><br><span class="line">│   │   ├── my.cnf</span><br><span class="line">│   │   ├── mysql_install.sh</span><br><span class="line">│   │   └── mysql.service</span><br><span class="line">│   ├── mysqlxxxx</span><br><span class="line">│   │   ├── my.cnf</span><br><span class="line">│   │   ├── mysql_install.sh</span><br><span class="line">│   │   └── mysql.service</span><br><span class="line">│   ├── nginx</span><br><span class="line">│   │   ├── nginx.conf</span><br><span class="line">│   │   ├── nginx_install.sh</span><br><span class="line">│   │   ├── nginx.service</span><br><span class="line">│   │   └── vhost.conf</span><br><span class="line">│   ├── php</span><br><span class="line">│   │   ├── php-fpm.conf</span><br><span class="line">│   │   ├── php-fpm.service</span><br><span class="line">│   │   ├── php_install.sh</span><br><span class="line">│   │   └── www.conf</span><br><span class="line">│   ├── redis</span><br><span class="line">│   │   ├── redis.conf</span><br><span class="line">│   │   ├── redis_install.sh</span><br><span class="line">│   │   └── redis.service</span><br><span class="line">│   └── zabbix</span><br><span class="line">│       ├── zabbix_agentd</span><br><span class="line">│       ├── zabbix_agentd.conf</span><br><span class="line">│       └── zabbixagent_install.sh</span><br><span class="line">├── tmp_cache</span><br><span class="line">└── vars</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── kvmvar.py</span><br><span class="line">    ├── mysqlxxxx.py</span><br><span class="line">    ├── mysqlxxxx.py</span><br><span class="line">    ├── nginxvar.py</span><br><span class="line">    ├── phpvar.py</span><br><span class="line">    ├── redisvar.py</span><br><span class="line">    └── zabbix_agentvar.py</span><br></pre></td></tr></table></figure>
<h2 id="三、kernel-目录下的功能模块"><a href="#三、kernel-目录下的功能模块" class="headerlink" title="三、kernel 目录下的功能模块"></a>三、kernel 目录下的功能模块</h2><h3 id="kvm服务器镜像clone-同步、kvm-xml-配置模板的生成同步，网卡配置文件整合kvm新服务器"><a href="#kvm服务器镜像clone-同步、kvm-xml-配置模板的生成同步，网卡配置文件整合kvm新服务器" class="headerlink" title="kvm服务器镜像clone 同步、kvm xml 配置模板的生成同步，网卡配置文件整合kvm新服务器;"></a>kvm服务器镜像clone 同步、kvm xml 配置模板的生成同步，网卡配置文件整合kvm新服务器;</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> local.replacetemp <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">generate_kvmimg</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clone_cevsxx</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        run(<span class="string">&#x27; [ -d&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + <span class="string">&#x27; &#x27;</span> +<span class="string">&#x27;]&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span>  + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir)</span><br><span class="line">        run(<span class="string">&#x27;virt-clone -o &#x27;</span> + kvmce7name + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-n&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">&#x27;.img&#x27;</span>)</span><br><span class="line">      <span class="comment">#  run(&#x27;mv&#x27; + &#x27; &#x27; + kvmdata + KVM_IP_HOSTNAME + &#x27;.img&#x27; + &#x27; &#x27; + kvmtmpdir)</span></span><br><span class="line">        run(<span class="string">&#x27;sed -i&#x27;</span> + <span class="string">&#x27; &#x27;</span>  + <span class="string">&#x27;&quot;s&#x27;</span> + <span class="string">&#x27;#&#x27;</span> +  kvmtmpdir + <span class="string">&#x27;#&#x27;</span> + kvmdata + <span class="string">&#x27;#g&quot;&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span> )</span><br><span class="line">        run(<span class="string">&#x27;cp&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir)</span><br><span class="line">        run(<span class="string">&#x27;virsh undefine&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_imgip</span>(<span class="params">self</span>):</span></span><br><span class="line">        rekvmeth = replace_tmp_file()</span><br><span class="line">        rekvmeth.kvm_eth0()</span><br><span class="line">        put(local_write_eth0 , kvmtmpdir)</span><br><span class="line">        rekvmeth.kvm_eth0_local_remove()</span><br><span class="line">        <span class="keyword">with</span> cd(kvmtmpdir):</span><br><span class="line">            run(<span class="string">&#x27;virt-copy-in&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;ifcfg-eth0&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-a&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME + <span class="string">&#x27;.img&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvm_eth0_dir + <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">            run(<span class="string">&#x27;rm -f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir  + <span class="string">&#x27;ifcfg-eth0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_imgxml_cpu</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(kvmtmpdir):</span><br><span class="line">            run(<span class="string">&#x27;sed -i \&quot;s\\current=\&#x27;2\&#x27;\\current=\&#x27;&#x27;</span> + KVM_CPU +<span class="string">&#x27;\&#x27;\\g\&quot;&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_imgxml_mem</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(kvmtmpdir):</span><br><span class="line">            run(<span class="string">&#x27;sed -i \&quot;s\\4194304\\&#x27;</span> + KVM_MEM + <span class="string">&#x27;\\g\&quot;&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scp_cloned_img</span>(<span class="params">self</span>):</span></span><br><span class="line">            run(<span class="string">&#x27;scp&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">&#x27;.img&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;root@&#x27;</span> + TARGETS_HOST + <span class="string">&#x27;:&#x27;</span> + kvmdata)</span><br><span class="line">            <span class="comment">#run(&#x27;scp&#x27; + &#x27; &#x27;  + &#x27;-l 25000&#x27; + &#x27; &#x27; + kvmtmpdir + KVM_IP_HOSTNAME + &#x27;.img&#x27; + &#x27; &#x27; + &#x27;root@&#x27; + TARGETS_HOST + &#x27;:&#x27; + kvmdata)</span></span><br><span class="line">            run(<span class="string">&#x27;rm -f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">&#x27;.img&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scp_cloned_xml</span>(<span class="params">self</span>):</span></span><br><span class="line">            run(<span class="string">&#x27;scp&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;root@&#x27;</span> + TARGETS_HOST + <span class="string">&#x27;:&#x27;</span> + kvmqemu)</span><br><span class="line">            run(<span class="string">&#x27;rm -f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>突破 <code>virt-copy-in 命令可以将已生成的网卡配置文件焙进镜像，依赖工具包libguestfs-tools-c 这样虚拟服务器开机后就可以直接分配指定的ip</code> </p>
<h3 id="操作目标服务器，将已经同步xml配置定义为虚拟机，扩展相应磁盘、并开启虚拟服务器"><a href="#操作目标服务器，将已经同步xml配置定义为虚拟机，扩展相应磁盘、并开启虚拟服务器" class="headerlink" title="操作目标服务器，将已经同步xml配置定义为虚拟机，扩展相应磁盘、并开启虚拟服务器;"></a>操作目标服务器，将已经同步xml配置定义为虚拟机，扩展相应磁盘、并开启虚拟服务器;</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">define_kvm</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;virsh define&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27; [ -d&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;]&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmtmpdir)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_kvm</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;virsh start&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extend_disk</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;qemu-img create -f qcow2&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmdata + KVM_IP_HOSTNAME + <span class="string">&#x27;-data1.img&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_DISK)</span><br><span class="line">        run(<span class="string">&#x27;virsh attach-disk&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME + <span class="string">&#x27; &#x27;</span> + kvmdata + KVM_IP_HOSTNAME + <span class="string">&#x27;-data1.img&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;vdc --subdriver=qcow2&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;virsh dumpxml&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;&gt;&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;virsh destroy&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME )</span><br><span class="line">        run(<span class="string">&#x27;virsh define&#x27;</span> + <span class="string">&#x27; &#x27;</span> + kvmqemu  + KVM_IP_HOSTNAME + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;virsh start&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME)</span><br></pre></td></tr></table></figure>
<h3 id="虚拟服务器开机后完成相应的补充操作"><a href="#虚拟服务器开机后完成相应的补充操作" class="headerlink" title="虚拟服务器开机后完成相应的补充操作"></a>虚拟服务器开机后完成相应的补充操作</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> localsrc,kvmsrc,kvm_install_local</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> LOGING_USER</span><br><span class="line"><span class="keyword">from</span> local.replacetemp <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">standard_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_kvm_hosts</span>(<span class="params">self</span>):</span></span><br><span class="line">        kvm_host_init  = replace_tmp_file()</span><br><span class="line">        kvm_host_init.kvm_hosts()</span><br><span class="line">        put(local_write_hosts,<span class="string">&#x27;/etc&#x27;</span>)</span><br><span class="line">        local(<span class="string">&#x27;rm -f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + local_write_hosts)</span><br><span class="line">        run(<span class="string">&#x27;hostnamectl set-hostname&#x27;</span> + <span class="string">&#x27; &#x27;</span> + KVM_IP_HOSTNAME)</span><br><span class="line">        run(<span class="string">&#x27;mkfs.xfs /dev/vdb&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ls -l /data &amp;&gt;/dev/null || mkdir /data&#x27;</span>)</span><br><span class="line">        fstab_shell_list = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            cat /etc/fstab | grep data &gt; /dev/null || \\</span></span><br><span class="line"><span class="string">            for i in `ls -l  /dev/disk/by-uuid/  | grep vdb  | awk &#x27;&#123;print $9&#125;&#x27;` ; \\</span></span><br><span class="line"><span class="string">            do echo &quot;UUID=$i  /data                   xfs     defaults        0 0&quot; &gt;&gt; /etc/fstab; \\</span></span><br><span class="line"><span class="string">            done</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span></span><br><span class="line">        run(fstab_shell_list)</span><br><span class="line">        run(<span class="string">&#x27;mount -a&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_kvm_adminsetd</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(localsrc + <span class="string">&#x27;/&#x27;</span> + <span class="string">&#x27;adminset_agent.tar.gz&#x27;</span>,kvmsrc)</span><br><span class="line">        run(<span class="string">&#x27;yum clean all&#x27;</span>)</span><br><span class="line">        yum_clean_wait = command(<span class="number">25</span>)</span><br><span class="line">        yum_clean_wait.wait_sleep()</span><br><span class="line">        <span class="keyword">with</span> cd(kvmsrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;adminset_agent.tar.gz&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> cd(kvmsrc +<span class="string">&#x27;/&#x27;</span> + <span class="string">&#x27;adminset_agent&#x27;</span>):</span><br><span class="line">            run(<span class="string">&#x27;sh install.sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_node_exporter</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(localsrc + <span class="string">&#x27;/&#x27;</span> + <span class="string">&#x27;node_exporter&#x27;</span>, kvm_install_local) </span><br><span class="line">        run(<span class="string">&#x27;chmod +x /usr/local/node_exporter/node_exporter&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;echo \&quot; nohup /usr/local/node_exporter/node_exporter &amp;&gt; /dev/null &amp; \&quot; &gt;&gt; /etc/rc.local&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;nohup /usr/local/node_exporter/node_exporter &amp;&gt; /dev/null &amp;&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;hwclock --systohc&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_kvm_passwd</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;echo&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;\&quot;&#x27;</span> + new_pass  + <span class="string">&#x27;\&quot;&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;| passwd --stdin&#x27;</span> + <span class="string">&#x27; &#x27;</span> + LOGING_USER)</span><br></pre></td></tr></table></figure>
<h3 id="mysqlxx-补充模块-实现功能与ansible-playbook-roles-类似，现整合在kvm自动化中"><a href="#mysqlxx-补充模块-实现功能与ansible-playbook-roles-类似，现整合在kvm自动化中" class="headerlink" title="mysqlxx 补充模块, 实现功能与ansible-playbook roles 类似，现整合在kvm自动化中"></a>mysqlxx 补充模块, 实现功能与ansible-playbook roles 类似，现整合在kvm自动化中</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.mysqlxx <span class="keyword">import</span>  *</span><br><span class="line"><span class="keyword">from</span> local.mysqlxxreplace <span class="keyword">import</span> replace_mysqlxx_tmp</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span>  tmp_cache, systemd</span><br><span class="line">replace_mysqlxx = replace_mysqlxx_tmp()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysqlxx_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;rm -f /etc/my.cnf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;rm -rf /etc/my.cnf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;mysql-&#x27;</span> + mysqlversion + <span class="string">&#x27;.tar.gz&#x27;</span>, datasrc)</span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;mysql-&#x27;</span> + mysqlversion + <span class="string">&#x27;.tar.gz&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-C /usr/local&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_mysql_conf</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(mysqltemp + <span class="string">&#x27;my.cnf&#x27;</span>, <span class="string">&#x27;/etc/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_install_sh</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_mysqlxx.mysql_install_sh()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;mysql_install.sh&#x27;</span>, datasrc)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_user_and_group</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;id -g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;groupadd&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlgroup)</span><br><span class="line">        run(<span class="string">&#x27;id -u&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;useradd -r&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-s&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/sbin/nologin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_related_directories</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqldatapath )</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlbinlogpath)</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath)</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqltmppath)</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlerrlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqldatapath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlbinlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqltmppath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlerrlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqldatapath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlbinlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqltmppath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlerrlogpath)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_slowlog_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;touch&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath + <span class="string">&#x27;slowquery.log&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chmod 644&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath + <span class="string">&#x27;slowquery.log&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath + <span class="string">&#x27;slowquery.log&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_mysql</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;/bin/bash&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;mysql_install.sh&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;&amp;&amp; touch /tmp/mysql_installed&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_to_PATH</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;echo \&#x27;export PATH=$PATH:&#x27;</span> + mysqlinstallpath + <span class="string">&#x27;bin\&#x27; &gt;&gt; /etc/profile &amp;&amp; touch /tmp/mysql_addtopath&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_service_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_mysqlxx.mysql_service()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;mysql.service&#x27;</span>, systemd)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_mysqlxx.clean_mysqlxx_tmp_cache()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_mysql_and_enable_it_onboot</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;systemctl daemon-reload&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl start mysql&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl enable mysql&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;pip install MySQL-python&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ln -s /data/mysqltmp/mysql.sock /tmp/mysql.sock&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ln -s /usr/local/mysql-x.x.xx-linux-glibcx.xx-x86_64/lib/libmysqlclient.so.20 /usr/lib64/libmysqlclient.so.20&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ln -s /usr/local/mysql-x.x.xx-linux-glibcx.xx-x86_64/ /usr/local/mysql&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;[ -d /data/scripts/ ] || mkdir /data/scripts/&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;backup.sh&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;lepus_slowquery.sh&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;percona-toolkit_x.x.xx-x.tar.gz&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;init_backup.sh&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="mysqlxxxx-同上，实现多版本并存"><a href="#mysqlxxxx-同上，实现多版本并存" class="headerlink" title="mysqlxxxx 同上，实现多版本并存"></a>mysqlxxxx 同上，实现多版本并存</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.mysqlxxxx <span class="keyword">import</span>  *</span><br><span class="line"><span class="keyword">from</span> local.mysqlxxxxreplace <span class="keyword">import</span> replace_mysqlxx13_tmp</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span>  tmp_cache, systemd</span><br><span class="line">replace_mysqlxxxx = replace_mysqlxxxx_tmp()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysqlxxxx_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;rm -f /etc/my.cnf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;rm -rf /etc/my.cnf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;mysql-&#x27;</span> + mysqlversion + <span class="string">&#x27;.tar.gz&#x27;</span>, datasrc)</span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;mysql-&#x27;</span> + mysqlversion + <span class="string">&#x27;.tar.gz&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-C /usr/local&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_mysql_conf</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(mysqltemp + <span class="string">&#x27;my.cnf&#x27;</span>, <span class="string">&#x27;/etc/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_install_sh</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_mysqlxxxx.mysql_install_sh()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;mysql_install.sh&#x27;</span>, datasrc)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_user_and_group</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;id -g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;groupadd&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlgroup)</span><br><span class="line">        run(<span class="string">&#x27;id -u&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;useradd -r&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-s&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/sbin/nologin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_related_directories</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqldatapath )</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlbinlogpath)</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath)</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqltmppath)</span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlerrlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqldatapath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlbinlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqltmppath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlerrlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqldatapath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlbinlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqltmppath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlerrlogpath)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_slowlog_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;touch&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath + <span class="string">&#x27;slowquery.log&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chmod 644&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath + <span class="string">&#x27;slowquery.log&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + mysqluser + <span class="string">&#x27;:&#x27;</span> + mysqlgroup + <span class="string">&#x27; &#x27;</span> + mysqlslowlogpath + <span class="string">&#x27;slowquery.log&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_mysql</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;/bin/bash&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;mysql_install.sh&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;&amp;&amp; touch /tmp/mysql_installed&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_to_PATH</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;echo \&#x27;export PATH=$PATH:&#x27;</span> + mysqlinstallpath + <span class="string">&#x27;bin\&#x27; &gt;&gt; /etc/profile &amp;&amp; touch /tmp/mysql_addtopath&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_service_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_mysqlxxxx.mysql_service()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;mysql.service&#x27;</span>, systemd)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_mysqlxxxx.clean_mysqlxxxx_tmp_cache()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_mysql_and_enable_it_onboot</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;systemctl daemon-reload&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl start mysql&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl enable mysql&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;pip install MySQL-python&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ln -s /data/mysqltmp/mysql.sock /tmp/mysql.sock&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ln -s /usr/local/mysql-x.x.xx-linux-glibc2.5-x86_64/lib/libmysqlclient.so.20 /usr/lib64/libmysqlclient.so.20&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;ln -s /usr/local/mysql-x.x.xx-linux-glibc2.5-x86_64/ /usr/local/mysql&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;[ -d /data/scripts/ ] || mkdir /data/scripts/&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;backup.sh&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;lepus_slowquery.sh&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;percona-toolkit_x.x.xx-1.tar.gz&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br><span class="line">        put(mysqlfile + <span class="string">&#x27;init_backup.sh&#x27;</span>, <span class="string">&#x27;/data/scripts&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="kvm-整合-redis安装自动化"><a href="#kvm-整合-redis安装自动化" class="headerlink" title="kvm 整合 redis安装自动化"></a>kvm 整合 redis安装自动化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> local.redisreplace <span class="keyword">import</span>  replace_redis_tmp</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.redisvar <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> tmp_cache, systemd</span><br><span class="line">replace_redis = replace_redis_tmp()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">redis_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(redisfile + <span class="string">&#x27;redis-&#x27;</span> + redisversion + <span class="string">&#x27;.tar.gz&#x27;</span>, datasrc)</span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;redis-&#x27;</span> + redisversion + <span class="string">&#x27;.tar.gz&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_redis_install_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_redis.redis_install_sh()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;redis_install.sh&#x27;</span>, datasrc)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_redis_group_and_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;id -g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;groupadd&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisgroup)</span><br><span class="line">        run(<span class="string">&#x27;id -u&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;useradd -r&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-s&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/sbin/nologin&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_redis</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;/bin/bash&#x27;</span> + <span class="string">&#x27; &#x27;</span> + datasrc + <span class="string">&#x27;redis_install.sh&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;&amp;&amp; touch /tmp/redis_installed&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_redis_log_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;touch&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redislogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 644&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redislogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisuser + <span class="string">&#x27;:&#x27;</span> + redisgroup + <span class="string">&#x27; &#x27;</span> + redislogpath)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crate_redis_data_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisdatapath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisdatapath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisuser + <span class="string">&#x27;:&#x27;</span> + redisgroup + <span class="string">&#x27; &#x27;</span> + redisdatapath)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_redis_config</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_redis.redis_conf()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;redis.conf&#x27;</span>, redisdatapath + <span class="string">&#x27;redis&#x27;</span> + redisport + <span class="string">&#x27;.conf&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chmod 644&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisdatapath + <span class="string">&#x27;redis&#x27;</span> + redisport + <span class="string">&#x27;.conf&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + redisuser + <span class="string">&#x27;:&#x27;</span> + redisgroup + <span class="string">&#x27; &#x27;</span> + redisdatapath + <span class="string">&#x27;redis&#x27;</span> + redisport + <span class="string">&#x27;.conf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_redis_service_config</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_redis.redis_service()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;redis.service&#x27;</span>, systemd + <span class="string">&#x27;redis&#x27;</span> + redisport + <span class="string">&#x27;.service&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl daemon-reload&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl start&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;redis&#x27;</span> + redisport)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_redis.clean_redis_tmp_cache()</span><br><span class="line">        run(<span class="string">&#x27;echo \&#x27;export PATH=$PATH:/usr/local/src/redis-&#x27;</span> + redisversion + <span class="string">&#x27;/src/&#x27;</span> + <span class="string">&#x27;\&#x27; &gt;&gt; /etc/profile&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="kvm整合nginx-安装自动化"><a href="#kvm整合nginx-安装自动化" class="headerlink" title="kvm整合nginx 安装自动化"></a>kvm整合nginx 安装自动化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> local.nginxreplace <span class="keyword">import</span> replace_nginx_tmp</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.nginxvar <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> kvmsrc,tmp_cache,systemd</span><br><span class="line">replace_nginx = replace_nginx_tmp()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">nginx_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_source</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(nginxfile + <span class="string">&#x27;nginx-&#x27;</span> + nginxversion + <span class="string">&#x27;.tar.gz&#x27;</span> , kvmsrc)</span><br><span class="line">        <span class="keyword">with</span> cd(kvmsrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;nginx-&#x27;</span> + nginxversion + <span class="string">&#x27;.tar.gz&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_nginx_install_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_nginx.nginx_install_sh()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;nginx_install.sh&#x27;</span>, kvmsrc)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_nginx_log_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxlogpath)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_nginx_group_and_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;id -g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;groupadd&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxgroup)</span><br><span class="line">        run(<span class="string">&#x27;id -u&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;useradd -r&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-s&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/sbin/nologin&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_nginx</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(kvmsrc):</span><br><span class="line">            run(<span class="string">&#x27;/bin/bash&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;nginx_install.sh&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_nginx_vhosts_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxinstallpath + <span class="string">&#x27;conf/vhost&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + nginxinstallpath + <span class="string">&#x27;conf/vhost&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_main_template_config_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_nginx.nginx_conf()</span><br><span class="line">      <span class="comment">#  run(&#x27;mv&#x27; + &#x27; &#x27; + nginxinstallpath + &#x27;conf/nginx.conf&#123;,.bak&#125;&#x27;)</span></span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;nginx.conf&#x27;</span>, nginxinstallpath + <span class="string">&#x27;conf/nginx.conf&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_vhost_template_config_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_nginx.nginx_vhost()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;vhost.conf&#x27;</span>, nginxinstallpath + <span class="string">&#x27;conf/vhost&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_nginx.clean_nginx_tmp_cache()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_service_config_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_nginx.nginx_service()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;nginx.service&#x27;</span>,systemd)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_nginx</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;systemctl daemon-reload&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl start nginx&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="kvm-整合php-自动化"><a href="#kvm-整合php-自动化" class="headerlink" title="kvm 整合php 自动化"></a>kvm 整合php 自动化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">!/usr/<span class="built_in">bin</span>/env python2</span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> local.phpreplace <span class="keyword">import</span> replace_php_tmp</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.phpvar <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> kvmsrc, tmp_cache, systemd</span><br><span class="line">replace_php = replace_php_tmp()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">php_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(phpfile + <span class="string">&#x27;php-&#x27;</span> + phpversion + <span class="string">&#x27;.tar.gz&#x27;</span>, kvmsrc)</span><br><span class="line">        <span class="keyword">with</span> cd(kvmsrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27;php-&#x27;</span> + phpversion + <span class="string">&#x27;.tar.gz&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_install_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_php.php_install_sh()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;php_install.sh&#x27;</span>, kvmsrc)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_php_group_and_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;id -g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;groupadd&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpgroup)</span><br><span class="line">        run(<span class="string">&#x27;id -u&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;useradd -r&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-s&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/sbin/nologin&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_php_log_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phplogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phplogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpuser + <span class="string">&#x27;:&#x27;</span> + phpgroup + <span class="string">&#x27; &#x27;</span> + phplogpath)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_php_error_log_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;touch&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phplogpath + <span class="string">&#x27;php_errors.log&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chmod 644&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phplogpath + <span class="string">&#x27;php_errors.log&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + phpuser + <span class="string">&#x27;:&#x27;</span> + phpgroup + <span class="string">&#x27; &#x27;</span> + phplogpath + <span class="string">&#x27;php_errors.log&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_php</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(kvmsrc):</span><br><span class="line">            run(<span class="string">&#x27;/bin/bash&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;php_install.sh&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_main_phpini_config</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(phpfile + <span class="string">&#x27;php.ini&#x27;</span>, phpinstallpath + <span class="string">&#x27;etc/&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_www_conf_config</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_php.php_www()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;www.conf&#x27;</span>, phpinstallpath + <span class="string">&#x27;etc/php-fpm.d/&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_php_fpm_config</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_php.php_conf()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;php-fpm.conf&#x27;</span>, phpinstallpath + <span class="string">&#x27;etc/&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_php_fpm_service</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_php.php_service()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;php-fpm.service&#x27;</span>, systemd)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_php</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;systemctl daemon-reload&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;systemctl start php-fpm || ss -tnl | grep 9000&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_files</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_php.clean_php_tmp_cache()</span><br></pre></td></tr></table></figure>
<h3 id="kvm-整合zabbix-agent自动化"><a href="#kvm-整合zabbix-agent自动化" class="headerlink" title="kvm 整合zabbix_agent自动化"></a>kvm 整合zabbix_agent自动化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.zabbix_agentvar <span class="keyword">import</span>  *</span><br><span class="line"><span class="keyword">from</span> local.zabbixreplace <span class="keyword">import</span>  replace_zabbix_tmp</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> kvmsrc, tmp_cache, systemd</span><br><span class="line">replace_zabbix_agent = replace_zabbix_tmp()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zabbix_agent_kvm</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span>(<span class="params">self</span>):</span></span><br><span class="line">        put(zabbixfile + <span class="string">&#x27;zabbix-&#x27;</span> + zabbixagentversion + <span class="string">&#x27;.tar.gz&#x27;</span> , datasrc)</span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;tar -xvf&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;zabbix-&#x27;</span> + zabbixagentversion + <span class="string">&#x27;.tar.gz&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_zabbix_agent_install_shell</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_zabbix_agent.zabbix_agent_install_sh()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;zabbixagent_install.sh&#x27;</span>, datasrc)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_zabbix_group_and_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;id -g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;groupadd&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentgroup)</span><br><span class="line">        run(<span class="string">&#x27;id -u&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;||&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;useradd -r&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentuser + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-g&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentgroup + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;-s&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/sbin/nologin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_zabbix_agent_log_dir</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;mkdir -pv&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentlogpath)</span><br><span class="line">        run(<span class="string">&#x27;chown&#x27;</span> + <span class="string">&#x27; &#x27;</span> + zabbixagentuser + <span class="string">&#x27;:&#x27;</span> + zabbixagentgroup + <span class="string">&#x27; &#x27;</span> + zabbixagentlogpath)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_zabbix_agent</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">with</span> cd(datasrc):</span><br><span class="line">            run(<span class="string">&#x27;/bin/bash&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;zabbixagent_install.sh&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;touch /tmp/zabbixagent_installed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_zabbix_agent_config_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_zabbix_agent.zabbix_agent_conf()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;zabbix_agentd.conf&#x27;</span>, zabbixagentinstallpath + <span class="string">&#x27;/etc/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_zabbix_agent_init_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_zabbix_agent.zabbix_agent_service()</span><br><span class="line">        put(tmp_cache + <span class="string">&#x27;zabbix_agentd&#x27;</span>, <span class="string">&#x27;/etc/init.d/&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chmod 755&#x27;</span> + <span class="string">&#x27; &#x27;</span> + <span class="string">&#x27;/etc/init.d/zabbix_agentd&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span>(<span class="params">self</span>):</span></span><br><span class="line">        replace_zabbix_agent.clean_zabbix_tmp_cache()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_zabbix_agent_init</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;chkconfig --add zabbix_agentd&#x27;</span>)</span><br><span class="line">        run(<span class="string">&#x27;chkconfig zabbix_agentd on&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_zabbix_agentd</span>(<span class="params">self</span>):</span></span><br><span class="line">        run(<span class="string">&#x27;service zabbix_agentd start&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="yum-安装相关依赖包"><a href="#yum-安装相关依赖包" class="headerlink" title="yum 安装相关依赖包"></a>yum 安装相关依赖包</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> yum_install_require_packages,yum_install_jdk_packages</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">yum_install_packages</span>():</span></span><br><span class="line">    run(<span class="string">&#x27;yum -y install&#x27;</span> + <span class="string">&#x27;\\&#x27;</span> + yum_install_require_packages)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">yum_install_jdk</span>():</span></span><br><span class="line">    run(<span class="string">&#x27;yum -y install&#x27;</span> + <span class="string">&#x27;\\&#x27;</span> + yum_install_jdk_packages)</span><br></pre></td></tr></table></figure>
<h3 id="输入输出信息打印"><a href="#输入输出信息打印" class="headerlink" title="输入输出信息打印"></a>输入输出信息打印</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> red</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> TARGETS_HOST, KVM_IP_HOSTNAME, KVM_IP_HOST, KVM_IP_GATEWAY, KVM_IP_NETMASK, ENV, APP, KVM_CPU, KVM_MEM ,KVM_DISK,KVM_IP_PASSWD</span><br><span class="line"><span class="keyword">from</span> config.messages <span class="keyword">import</span> MESSAGE_INFO</span><br><span class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> new_pass, common_first</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">last</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_start_kvm_message</span>(<span class="params">self</span>):</span></span><br><span class="line">        app_list = <span class="built_in">str</span>(APP)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;[&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;]&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        first_print = common_first(MESSAGE_INFO[<span class="string">&#x27;env&#x27;</span>] + ENV, MESSAGE_INFO[<span class="string">&#x27;name&#x27;</span>] + KVM_IP_HOSTNAME,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;ip&#x27;</span>] + KVM_IP_HOST, MESSAGE_INFO[<span class="string">&#x27;target&#x27;</span>] +TARGETS_HOST,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;gateway&#x27;</span>] + KVM_IP_GATEWAY, MESSAGE_INFO[<span class="string">&#x27;netmask&#x27;</span>] + KVM_IP_NETMASK,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;app&#x27;</span>] + app_list, MESSAGE_INFO[<span class="string">&#x27;cpu&#x27;</span>] + KVM_CPU,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;memory&#x27;</span>] + KVM_MEM, MESSAGE_INFO[<span class="string">&#x27;disk&#x27;</span>] + KVM_DISK,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;passwd&#x27;</span>] + KVM_IP_PASSWD)</span><br><span class="line">        first_print.message_all()</span><br><span class="line">        user_choice = raw_input(red(<span class="string">&#x27;If the information is incorrect, please input no: &#x27;</span>))</span><br><span class="line">        <span class="keyword">if</span> user_choice == <span class="string">&quot;N&quot;</span> <span class="keyword">or</span> user_choice == <span class="string">&quot;n&quot;</span> <span class="keyword">or</span> user_choice == <span class="string">&quot;no&quot;</span> <span class="keyword">or</span> user_choice == <span class="string">&quot;No&quot;</span> <span class="keyword">or</span> user_choice == <span class="string">&quot;NO&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span></span><br><span class="line">            print(red(<span class="string">&#x27;User check configuration is incorrect. Please rewrite configuration!&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span></span><br><span class="line">            exit(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_kvm_message</span>(<span class="params">self</span>):</span></span><br><span class="line">        app_list = <span class="built_in">str</span>(APP)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;[&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;]&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        app_list = app_list.replace(<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        last_print = common_first(MESSAGE_INFO[<span class="string">&#x27;env&#x27;</span>] + ENV, MESSAGE_INFO[<span class="string">&#x27;name&#x27;</span>] + KVM_IP_HOSTNAME,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;ip&#x27;</span>] + KVM_IP_HOST, MESSAGE_INFO[<span class="string">&#x27;target&#x27;</span>] + TARGETS_HOST,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;gateway&#x27;</span>] + KVM_IP_GATEWAY, MESSAGE_INFO[<span class="string">&#x27;netmask&#x27;</span>] + KVM_IP_NETMASK,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;app&#x27;</span>] + app_list, MESSAGE_INFO[<span class="string">&#x27;cpu&#x27;</span>] + KVM_CPU,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;memory&#x27;</span>] + KVM_MEM, MESSAGE_INFO[<span class="string">&#x27;disk&#x27;</span>] + KVM_DISK,</span><br><span class="line">                                   MESSAGE_INFO[<span class="string">&#x27;passwd&#x27;</span>] + new_pass)</span><br><span class="line">        last_print.last_message_all()</span><br></pre></td></tr></table></figure>
<h2 id="local-实现配置文件修改与替换"><a href="#local-实现配置文件修改与替换" class="headerlink" title="local 实现配置文件修改与替换"></a>local 实现配置文件修改与替换</h2><p>例ifcfg-eth0</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> <span class="built_in">vars</span>.kvmvar <span class="keyword">import</span> local_read_eth0,local_write_eth0,local_read_hosts,local_write_hosts,tmp_cache</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> KVM_IP_HOST,KVM_IP_NETMASK,KVM_IP_GATEWAY,KVM_IP_STATUE,KVM_IP_HOSTNAME</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">replace_tmp_file</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_eth0</span>(<span class="params">self</span>):</span></span><br><span class="line">        network_file_read = <span class="built_in">open</span>(local_read_eth0,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">        network_file_write = <span class="built_in">open</span>(local_write_eth0,<span class="string">&quot;w&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> network_file_read <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">            data = data.replace(<span class="string">&#x27;$NETWORK_STATUS$&#x27;</span>,KVM_IP_STATUE)</span><br><span class="line">            data = data.replace(<span class="string">&#x27;$NETWORK_IPADDR$&#x27;</span>,KVM_IP_HOST)</span><br><span class="line">            data = data.replace(<span class="string">&#x27;$NETWORK_NETMASK$&#x27;</span>,KVM_IP_NETMASK)</span><br><span class="line">            data = data.replace(<span class="string">&#x27;$NETWORK_GATEWAY$&#x27;</span>,KVM_IP_GATEWAY)</span><br><span class="line">        <span class="keyword">with</span> network_file_write <span class="keyword">as</span> f:</span><br><span class="line">            f.write(data)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_eth0_local_remove</span>(<span class="params">self</span>):</span></span><br><span class="line">        local(<span class="string">&#x27;rm -f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + local_write_eth0)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_hosts</span>(<span class="params">self</span>):</span></span><br><span class="line">        hosts_file_read = <span class="built_in">open</span>(local_read_hosts,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">        hosts_file_write = <span class="built_in">open</span>(local_write_hosts,<span class="string">&quot;w&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> hosts_file_read <span class="keyword">as</span> f:</span><br><span class="line">            hosts = f.read()</span><br><span class="line">            hosts = hosts.replace(<span class="string">&#x27;$HOSTSIP$&#x27;</span>, KVM_IP_HOST)</span><br><span class="line">            hosts = hosts.replace(<span class="string">&#x27;$HOSTNAME$&#x27;</span>, KVM_IP_HOSTNAME)</span><br><span class="line">        <span class="keyword">with</span> hosts_file_write <span class="keyword">as</span> f:</span><br><span class="line">            f.write(hosts)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_hosts_remove</span>(<span class="params">self</span>):</span></span><br><span class="line">        local(<span class="string">&#x27;rm -f&#x27;</span> + <span class="string">&#x27; &#x27;</span> + local_write_eth0)</span><br></pre></td></tr></table></figure>
<p>其它功相关调用 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">command</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,info</span>):</span></span><br><span class="line">        self.info = info</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_sleep</span>(<span class="params">self</span>):</span></span><br><span class="line">        sleep(self.info)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_pass</span>(<span class="params">self,chars=string.ascii_uppercase+string.ascii_lowercase+string.digits</span>):</span></span><br><span class="line"><span class="comment">#string.punctuation</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([random.choice(chars) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.info)])</span><br><span class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">common</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,info</span>):</span></span><br><span class="line">        self.info = info</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> waits <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">2</span>):</span><br><span class="line">            sleep(waits)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_green</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> green(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span> green(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:^80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, self.info , <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> green(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_blue</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> blue(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span> blue(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:^80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, self.info , <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> blue(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_orange</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> yellow(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span> yellow(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:^80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, self.info , <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> yellow(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">common_first</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, env, name, ip, target, gateway, netmask, app, cpu, memory, disk ,passwd</span>):</span></span><br><span class="line">        self.env = env</span><br><span class="line">        self.name = name</span><br><span class="line">        self.ip = ip</span><br><span class="line">        self.target = target</span><br><span class="line">        self.gateway = gateway</span><br><span class="line">        self.netmask = netmask</span><br><span class="line">        self.app = app</span><br><span class="line">        self.cpu = cpu</span><br><span class="line">        self.memory = memory</span><br><span class="line">        self.disk = disk</span><br><span class="line">        self.passwd = passwd</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_all</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.env, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.name, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.ip, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.target, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.gateway, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.netmask, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.app, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.cpu, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.memory, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.disk, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.passwd, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> magenta(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">last_message_all</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.env, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.name, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.ip, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.target, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.gateway, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.netmask, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.app, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.cpu, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.memory, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.disk, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>, <span class="string">&#x27;  &#x27;</span> + self.passwd, <span class="string">&#x27;*&#x27;</span> * <span class="number">10</span>))</span><br><span class="line">        <span class="built_in">print</span> cyan(<span class="string">&#x27;**&#x27;</span> * <span class="number">50</span>)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line">newpasswd = command(<span class="number">12</span>)</span><br><span class="line">new_pass = newpasswd.create_pass()</span><br></pre></td></tr></table></figure>
<h3 id="config-目录存放配置相关的信息"><a href="#config-目录存放配置相关的信息" class="headerlink" title="config 目录存放配置相关的信息"></a>config 目录存放配置相关的信息</h3><p>message.py</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python2</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from config import ENV</span><br><span class="line">MESSAGE_INFO &#x3D; &#123;</span><br><span class="line">    &#39;start_kvm_site&#39;: &#39;Now Start KVM Create&#39;,</span><br><span class="line">    &#39;app_clone&#39;: &#39;App Clone Genreate CentOS74&#39;,</span><br><span class="line">    &#39;site_image_ip&#39;: &#39;Source Hosts Site Image IP&#39;,</span><br><span class="line">    &#39;site_imgxml_cpu&#39;: &#39;Sources Hosts Site Image XML CPU&#39;,</span><br><span class="line">    &#39;site_imgxml_mem&#39;: &#39;Sources Hosts Site Image XML Memory&#39;,</span><br><span class="line">    &#39;scp_cloned_img&#39;: &#39;Sources Hosts Scp Cloned Image To Targets hosts&#39;,</span><br><span class="line">    &#39;scp_cloned_xml&#39;: &#39;Sources Hosts Scp Cloned XML To Targets hosts&#39;,</span><br><span class="line">    &#39;define_kvm&#39;: &#39;Targets Hosts Define Kvm Hosts&#39;,</span><br><span class="line">    &#39;start_kvm&#39;: &#39;Targets Hosts Start Kvm Hosts&#39;,</span><br><span class="line">    &#39;extend_disk&#39;: &#39;Targets Hosts Extend Kvm Disk&#39;,</span><br><span class="line">    &#39;wait_sleep&#39;: &#39;Sleep 60s For Wait Start Kvm Hosts&#39;,</span><br><span class="line">    &#39;site_kvm_hosts&#39;: &#39;KVM Site KVM Hosts&#39;,</span><br><span class="line">    &#39;install_kvm_adminsetd&#39;: &#39;KVM Install  Adminsetd And Node_exporter&#39;,</span><br><span class="line">    &#39;start_yum_tools_install&#39;: &#39;Now Start Yum Tools Install&#39;,</span><br><span class="line">    &#39;start_nginx_install&#39;: &#39;Now Start Nginx Install&#39;,</span><br><span class="line">    &#39;nginx_copy&#39;: &#39;Nginx Copy Source File&#39;,</span><br><span class="line">    &#39;copy_nginx_install_shell&#39;: &#39;Nginx Copy Install Shell&#39;,</span><br><span class="line">    &#39;create_nginx_log_dir&#39;: &#39;Nginx Create Log Dir&#39;,</span><br><span class="line">    &#39;create_nginx_group_and_user&#39;: &#39;Nginx Create Group And User&#39;,</span><br><span class="line">    &#39;install_nginx&#39;: &#39;Nginx Install&#39;,</span><br><span class="line">    &#39;create_nginx_vhosts_dir&#39;: &#39;Nginx Create Vhosts Dir&#39;,</span><br><span class="line">    &#39;copy_main_template_config_file&#39;: &#39;Nginx Main Template Config File&#39;,</span><br><span class="line">    &#39;copy_vhost_template_config_file&#39;: &#39;Nginx Copy Vhost Template Config File&#39;,</span><br><span class="line">    &#39;copy_service_config_file&#39;: &#39;Nginx Copy Service Config File&#39;,</span><br><span class="line">    &#39;start_nginx&#39;: &#39;Nginx Start&#39;,</span><br><span class="line">    &#39;nginx_clean_local_tmp_cache_file&#39;: &#39;Nginx Clean local Tmp Cache File&#39;,</span><br><span class="line">    &#39;start_php_install&#39;: &#39;Now Start PHP Install&#39;,</span><br><span class="line">    &#39;php_copy&#39;: &#39;PHP Copy Source File&#39;,</span><br><span class="line">    &#39;cp_php_install_shell&#39;: &#39;PHP Copy Install Shell&#39;,</span><br><span class="line">    &#39;create_php_group_and_user&#39;: &#39;PHP Create Group And User&#39;,</span><br><span class="line">    &#39;create_php_log_dir&#39;: &#39;PHP Create Log Dir&#39;,</span><br><span class="line">    &#39;create_php_error_log_file&#39;: &#39;PHP Create Error Log File&#39;,</span><br><span class="line">    &#39;install_php&#39;: &#39;PHP Install&#39;,</span><br><span class="line">    &#39;cp_main_phpini_config&#39;: &#39;PHP Copy Phpini Config&#39;,</span><br><span class="line">    &#39;cp_php_www_conf_config&#39;: &#39;PHP Copy PHP WWW Config&#39;,</span><br><span class="line">    &#39;cp_php_php_fpm_config&#39;: &#39;PHP Copy php-fpm Config&#39;,</span><br><span class="line">    &#39;cp_php_php_fpm_service&#39;: &#39;PHP Copy php-fpm Service&#39;,</span><br><span class="line">    &#39;start_php&#39;: &#39;PHP Start&#39;,</span><br><span class="line">    &#39;php_clean_local_tmp_cache_files&#39;: &#39;PHP Clean local Tmp Cache File&#39;,</span><br><span class="line">    &#39;start_redis_install&#39;: &#39;Now Start Reids Install&#39;,</span><br><span class="line">    &#39;redis_copy&#39;: &#39;Redis Copy Source File&#39;,</span><br><span class="line">    &#39;cp_redis_install_shell&#39;: &#39;Redis Copy Install Shell&#39;,</span><br><span class="line">    &#39;create_redis_group_and_user&#39;: &#39;Redis Create Grup And User&#39;,</span><br><span class="line">    &#39;install_redis&#39;: &#39;Redis Install&#39;,</span><br><span class="line">    &#39;create_redis_log_file&#39;: &#39;Redis Create Redis Log File&#39;,</span><br><span class="line">    &#39;crate_redis_data_dir&#39;: &#39;Redis Create Data Dir&#39;,</span><br><span class="line">    &#39;copy_redis_config&#39;: &#39;Redis Copy Config&#39;,</span><br><span class="line">    &#39;copy_redis_service_config&#39;: &#39;Redis Copy Service Config&#39;,</span><br><span class="line">    &#39;redis_clean_local_tmp_cache_file&#39;: &#39;Redis Clean Local Tmp Cache File&#39;,</span><br><span class="line">    &#39;start_jdk_install&#39;: &#39;Now Start Install JDK&#39;,</span><br><span class="line">    &#39;yum_install_jdk&#39;: &#39;JDK Yum Install&#39;,</span><br><span class="line">    &#39;start_zabbix_agentd_install&#39;: &#39;Now Start Zabbix Agent Install&#39;,</span><br><span class="line">    &#39;zabbix_copy&#39;: &#39;Zabbix Copy Source File&#39;,</span><br><span class="line">    &#39;cp_zabbix_agent_install_shell&#39;: &#39;Zabbix Copy Agent Install Shell&#39;,</span><br><span class="line">    &#39;create_zabbix_group_and_user&#39;: &#39;Zabbix Create Zabbix Group And User&#39;,</span><br><span class="line">    &#39;create_zabbix_agent_log_dir&#39;: &#39;Zabbix Create Agent Log Dir&#39;,</span><br><span class="line">    &#39;install_zabbix_agent&#39;: &#39;Zabbix Install Agent&#39;,</span><br><span class="line">    &#39;copy_zabbix_agent_config_file&#39;: &#39;Zabbix Copy Zabbix Agent Config&#39;,</span><br><span class="line">    &#39;copy_zabbix_agent_init_file&#39;: &#39;Zabbix Copy Zabbix Agent init&#39;,</span><br><span class="line">    &#39;add_zabbix_agent_init&#39;: &#39;Zabbix Agent init&#39;,</span><br><span class="line">    &#39;start_zabbix_agentd&#39;: &#39;Zabbix Agent start&#39;,</span><br><span class="line">    &#39;zabbix_clean_local_tmp_cache_file&#39;: &#39;Zabbix Clean Local Tmp Cache File&#39;,</span><br><span class="line">    &#39;start_mysqlxx_install&#39;: &#39;Now Start Mysqlxx Install&#39;,</span><br><span class="line">    &#39;deletexx_old_conf&#39;: &#39;MySQLxx Delete Old Conf&#39;,</span><br><span class="line">    &#39;deletexx_old_conf_dir&#39;: &#39;MySQLxx Delete Old Conf Dir&#39;,</span><br><span class="line">    &#39;mysqlxx_source&#39;: &#39;MySQLxx Copy Source File&#39;,</span><br><span class="line">    &#39;cp_mysqlxx_conf&#39;: &#39;MySQLxx Copy Conf&#39;,</span><br><span class="line">    &#39;copy_mysqlxx_install_sh&#39;: &#39;MySQLxx Copy Install Shell&#39;,</span><br><span class="line">    &#39;add_mysqlxx_user_and_group&#39;: &#39;MySQLxx Add User And Group&#39;,</span><br><span class="line">    &#39;createxx_related_directories&#39;: &#39;MySQlxx Create Related Directories&#39;,</span><br><span class="line">    &#39;createxx_slowlog_file&#39;: &#39;MySQLxx Create Slowlog File&#39;,</span><br><span class="line">    &#39;install_mysqlxx&#39;: &#39;MySQLxx Install&#39;,</span><br><span class="line">    &#39;add_mysqlxx_to_PATH&#39;: &#39;MySQLxx Add To PATH&#39;,</span><br><span class="line">    &#39;cleanxx_local_tmp_cache_file&#39;: &quot;MySQLxx Clean Local Tmp Cache File&quot;,</span><br><span class="line">    &#39;copy_mysqlxx_service_file&#39;: &quot;MySQLxx Copy Service File&quot;,</span><br><span class="line">    &#39;start_mysqlxx_and_enable_it_onboot&#39;: &#39;MySQLxx start And Enable Onboot&#39;,</span><br><span class="line">    &#39;start_mysqlxx13_install&#39;: &#39;Now Start Mysqlxx13 Install&#39;,</span><br><span class="line">    &#39;deletexx13_old_conf&#39;: &#39;MySQLxx13 Delete Old Conf&#39;,</span><br><span class="line">    &#39;deletexx13_old_conf_dir&#39;: &#39;MySQLxx13 Delete Old Conf Dir&#39;,</span><br><span class="line">    &#39;mysqlxx13_source&#39;: &#39;MySQLxx13 Copy Source File&#39;,</span><br><span class="line">    &#39;cp_mysqlxx13_conf&#39;: &#39;MySQLxx13 Copy Conf&#39;,</span><br><span class="line">    &#39;copy_mysqlxx13_install_sh&#39;: &#39;MySQLxx13 Copy Install Shell&#39;,</span><br><span class="line">    &#39;add_mysqlxx13_user_and_group&#39;: &#39;MySQLxx13 Add User And Group&#39;,</span><br><span class="line">    &#39;createxx13_related_directories&#39;: &#39;MySQlxx13 Create Related Directories&#39;,</span><br><span class="line">    &#39;createxx13_slowlog_file&#39;: &#39;MySQLxx13 Create Slowlog File&#39;,</span><br><span class="line">    &#39;install_mysqlxx13&#39;: &#39;MySQLxx13 Install&#39;,</span><br><span class="line">    &#39;add_mysqlxx13_to_PATH&#39;: &#39;MySQLxx13 Add To PATH&#39;,</span><br><span class="line">    &#39;cleanxx13_local_tmp_cache_file&#39;: &quot;MySQLxx13 Clean Local Tmp Cache File&quot;,</span><br><span class="line">    &#39;copy_mysqlxx13_service_file&#39;: &quot;MySQLxx13 Copy Service File&quot;,</span><br><span class="line">    &#39;start_mysqlxx13_and_enable_it_onboot&#39;: &#39;MySQLxx13 Start And Enable Onboot&#39;,</span><br><span class="line">    &#39;set_kvm_passwd&#39;: &#39;KVM Set root passwd&#39;,</span><br><span class="line">    &#39;env&#39;: &#39;KVM ENV Is: &#39;,</span><br><span class="line">    &#39;name&#39;: &#39;KVM Host Name Is: &#39;,</span><br><span class="line">    &#39;ip&#39;: &#39;KVM IP Is: &#39;,</span><br><span class="line">    &#39;target&#39;: &#39;TARGET IP Is: &#39;,</span><br><span class="line">    &#39;gateway&#39;: &#39;KVM Gateway Is: &#39;,</span><br><span class="line">    &#39;netmask&#39;: &#39;KVM Netmask Is: &#39;,</span><br><span class="line">    &#39;app&#39;: &#39;KVM APP Is: &#39;,</span><br><span class="line">    &#39;cpu&#39;: &#39;KVM CPU Is: &#39;,</span><br><span class="line">    &#39;memory&#39;: &#39;KVM Memory Is: &#39;,</span><br><span class="line">    &#39;disk&#39;: &#39;KVM Disk Is: &#39;,</span><br><span class="line">    &#39;passwd&#39;: &#39;KVM Passwd IS: &#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>host.py 开通服务器所要操控的三台服务器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line">SOURCES_HOSTS = [</span><br><span class="line">    LOGING_USER + <span class="string">&#x27;@&#x27;</span> + SOURCES_HOST</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">TARGETS_HOSTS = [</span><br><span class="line">    LOGING_USER + <span class="string">&#x27;@&#x27;</span> + TARGETS_HOST</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">KVM_HOSTS = [</span><br><span class="line">    LOGING_USER + <span class="string">&#x27;@&#x27;</span> + KVM_IP_HOST</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong>init</strong>.py 生产与生产环境配置的开关</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#from config.prod.kvm_config import *</span></span><br><span class="line"><span class="keyword">from</span> config.test.kvm_config <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<p>kvm_create.py 每次开通服务器所需要的配置信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env</span><br><span class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> newpasswd</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################### 以下为通常不变的信息 ########################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 登录用户信息，默认为root</span></span><br><span class="line">ENV = <span class="string">&#x27;prod&#x27;</span></span><br><span class="line">LOGING_USER = <span class="string">&#x27;root&#x27;</span></span><br><span class="line"><span class="comment">## 生产环境网关信息,生产网关默认不变</span></span><br><span class="line">KVM_IP_GATEWAY = <span class="string">&#x27;xxx.xx.xx.xx&#x27;</span></span><br><span class="line"><span class="comment">## kvm服务器密码信息kvm服务器中的模板，一般不变</span></span><br><span class="line">KVM_IP_PASSWD = <span class="string">&#x27;xxxxxxxxXXXX&#x27;</span></span><br><span class="line"><span class="comment">## 源服务器信息，一般从物理服务器(xxx.xx.xx.xx)进行克隆</span></span><br><span class="line">SOURCES_HOST = <span class="string">&#x27;xxx.xx.xx.xx&#x27;</span></span><br><span class="line">SOURCES_PASS = <span class="string">&#x27;xxxxxxxxxxxxxxxxxxxxxxx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## kvm虚拟机启动后网卡的开启状态，一般不变</span></span><br><span class="line">KVM_IP_STATUE = <span class="string">&#x27;yes&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################## 以下为通常改变的信息 #########################################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">### 目标服务器信息(切记改变配置信息)</span></span><br><span class="line"><span class="comment">#TARGETS_HOST = &#x27;xxx.xx.xxx.xx&#x27;</span></span><br><span class="line"><span class="comment">#TARGETS_PASS = &#x27;xxxxxxxxxxxxxxxxxxxxxxxx&#x27;</span></span><br><span class="line"><span class="comment">### kvm服务器信息(切记改变配置信息)</span></span><br><span class="line"><span class="comment">#KVM_IP_HOSTNAME = &#x27;xx-xxxx-xx-xxx-xxxx-xxxx&#x27;</span></span><br><span class="line"><span class="comment">#KVM_IP_HOST = &#x27;172.30.70.&#x27;</span></span><br><span class="line"><span class="comment">#KVM_IP_NETMASK = &#x27;255.255.192.0&#x27;</span></span><br><span class="line"><span class="comment">#KVM_CPU = &#x27;2&#x27;</span></span><br><span class="line"><span class="comment">#KVM_DISK = &#x27;100G&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;10xx144&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;2114288&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;2097152&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;4194304&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;6291456&#x27;</span></span><br><span class="line"><span class="comment">#KVM_MEM = &#x27;8388608&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;1048xx60&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;12582912&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;14680064&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;16777216&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;20971520&#x27;</span></span><br><span class="line"><span class="comment">##KVM_MEM = &#x27;25165824&#x27;</span></span><br><span class="line"><span class="comment">#APP = [&#x27;zabbix_agent&#x27;, &#x27;jdk&#x27;]</span></span><br><span class="line"><span class="comment">##APP = [&#x27;zabbix_agent&#x27;, &#x27;nginx&#x27;, &#x27;php&#x27;, &#x27;redis&#x27;, &#x27;jdk&#x27;, &#x27;mysql_xx&#x27;, &#x27;mysql_xx13&#x27;]</span></span><br><span class="line"><span class="comment">############################################# 以下为代替的执行登录信息 ####################################</span></span><br><span class="line">env.passwords[LOGING_USER + <span class="string">&#x27;@&#x27;</span> + SOURCES_HOST + <span class="string">&#x27;:22&#x27;</span>] = SOURCES_PASS</span><br><span class="line">env.passwords[LOGING_USER + <span class="string">&#x27;@&#x27;</span> + TARGETS_HOST + <span class="string">&#x27;:22&#x27;</span>] = TARGETS_PASS</span><br><span class="line">env.passwords[LOGING_USER + <span class="string">&#x27;@&#x27;</span> + KVM_IP_HOST + <span class="string">&#x27;:22&#x27;</span>] = KVM_IP_PASSWD</span><br></pre></td></tr></table></figure>
<h2 id="application-定义自动化执行流程"><a href="#application-定义自动化执行流程" class="headerlink" title="application 定义自动化执行流程"></a>application 定义自动化执行流程</h2><p> kvmcreate.py 定义kvm 自动部署流程</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> KVM_CPU,KVM_MEM,KVM_DISK</span><br><span class="line"><span class="keyword">from</span> config.messages <span class="keyword">import</span> MESSAGE_INFO</span><br><span class="line"><span class="keyword">from</span> kernel.clone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> kernel.start <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> kernel.standard <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> kernel.last <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> common</span><br><span class="line">app_clone_generate = generate_kvmimg()</span><br><span class="line">app_targets_hosts_start = start_kvm()</span><br><span class="line">app_kvm_hosts_start_site = standard_kvm()</span><br><span class="line">app_kvm_hosts_start_print = last()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_create</span>():</span></span><br><span class="line">    print_first_message = last()</span><br><span class="line">    print_first_message.print_start_kvm_message()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;start_kvm_site&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_blue()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;app_clone&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_clone_generate.clone_cevs74()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;site_image_ip&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_clone_generate.site_imgip()</span><br><span class="line">    <span class="keyword">if</span> KVM_CPU != <span class="string">&#x27;2&#x27;</span> <span class="keyword">and</span> KVM_MEM != <span class="string">&#x27;4194304&#x27;</span>:</span><br><span class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;site_imgxml_cpu&#x27;</span>])</span><br><span class="line">        print_kvm_message.message_green()</span><br><span class="line">        app_clone_generate.site_imgxml_cpu()</span><br><span class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;site_imgxml_mem&#x27;</span>])</span><br><span class="line">        print_kvm_message.message_green()</span><br><span class="line">        app_clone_generate.site_imgxml_mem()</span><br><span class="line">    <span class="keyword">if</span> KVM_CPU != <span class="string">&#x27;2&#x27;</span> <span class="keyword">and</span> KVM_MEM == <span class="string">&#x27;4194304&#x27;</span>:</span><br><span class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;site_imgxml_cpu&#x27;</span>])</span><br><span class="line">        print_kvm_message.message_green()</span><br><span class="line">        app_clone_generate.site_imgxml_cpu()</span><br><span class="line">    <span class="keyword">if</span> KVM_MEM != <span class="string">&#x27;4194304&#x27;</span> <span class="keyword">and</span> KVM_CPU == <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;site_imgxml_mem&#x27;</span>])</span><br><span class="line">        print_kvm_message.message_green()</span><br><span class="line">        app_clone_generate.site_imgxml_mem()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;scp_cloned_img&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_clone_generate.scp_cloned_img()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;scp_cloned_xml&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_clone_generate.scp_cloned_xml()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">targets_hosts_start_kvm</span>():</span></span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;define_kvm&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_targets_hosts_start.define_kvm()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;start_kvm&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_targets_hosts_start.start_kvm()</span><br><span class="line">    <span class="keyword">if</span> KVM_DISK <span class="keyword">is</span> <span class="keyword">not</span> <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;extend_disk&#x27;</span>])</span><br><span class="line">        print_kvm_message.message_green()</span><br><span class="line">        app_targets_hosts_start.extend_disk()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;wait_sleep&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    time_sleep_wait_start = command(<span class="number">60</span>)</span><br><span class="line">    time_sleep_wait_start.wait_sleep()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_virture_hosts_site</span>():</span></span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;site_kvm_hosts&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_kvm_hosts_start_site.site_kvm_hosts()</span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;install_kvm_adminsetd&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_kvm_hosts_start_site.install_kvm_adminsetd()</span><br><span class="line">    app_kvm_hosts_start_site.install_node_exporter()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_tirture_hosts_site_passwd</span>():</span></span><br><span class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">&#x27;set_kvm_passwd&#x27;</span>])</span><br><span class="line">    print_kvm_message.message_green()</span><br><span class="line">    app_kvm_hosts_start_site.set_kvm_passwd()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_virture_hosts_print</span>():</span></span><br><span class="line">    app_kvm_hosts_start_print.print_kvm_message()</span><br></pre></td></tr></table></figure>
<p>appcreate.py 用于定义应用程序的部署流程</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> config.messages <span class="keyword">import</span> MESSAGE_INFO</span><br><span class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> common</span><br><span class="line"><span class="keyword">from</span> kernel.yum <span class="keyword">import</span> yum_install_packages, yum_install_jdk</span><br><span class="line"><span class="keyword">from</span> kernel.nginx <span class="keyword">import</span> nginx_kvm</span><br><span class="line"><span class="keyword">from</span> kernel.php <span class="keyword">import</span> php_kvm</span><br><span class="line"><span class="keyword">from</span> kernel.redis <span class="keyword">import</span> redis_kvm</span><br><span class="line"><span class="keyword">from</span> kernel.zabbix_agent <span class="keyword">import</span> zabbix_agent_kvm</span><br><span class="line"><span class="keyword">from</span> kernel.mysqlxx <span class="keyword">import</span>  mysqlxx_kvm</span><br><span class="line"><span class="keyword">from</span> kernel.mysqlxxxx <span class="keyword">import</span> mysqlxxxx_kvm</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> APP</span><br><span class="line"></span><br><span class="line">nginx_install = nginx_kvm()</span><br><span class="line">php_install = php_kvm()</span><br><span class="line">redis_install = redis_kvm()</span><br><span class="line">zabbix_agent_install = zabbix_agent_kvm()</span><br><span class="line">mysqlxx_install = mysqlxx_kvm()</span><br><span class="line">mysqlxxxx_install = mysqlxxxx_kvm()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_yum_install</span>():</span></span><br><span class="line">    yum_install_packages()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_nginx</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;nginx_copy&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.copy_source()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_nginx_install_shell&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.copy_nginx_install_shell()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_nginx_log_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.create_nginx_log_dir()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_nginx_group_and_user&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.create_nginx_group_and_user()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;install_nginx&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.install_nginx()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_nginx_vhosts_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.create_nginx_vhosts_dir()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_main_template_config_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.copy_main_template_config_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_vhost_template_config_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.copy_vhost_template_config_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_service_config_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.copy_service_config_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_nginx&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.start_nginx()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;nginx_clean_local_tmp_cache_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    nginx_install.clean_local_tmp_cache_file()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_php</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;php_copy&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.cp_source()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_php_install_shell&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.cp_php_install_shell()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_php_group_and_user&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.create_php_group_and_user()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_php_log_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.create_php_log_dir()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_php_error_log_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.create_php_error_log_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;install_php&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.install_php()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_main_phpini_config&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.cp_main_phpini_config()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_php_www_conf_config&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.cp_php_www_conf_config()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_php_php_fpm_config&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.cp_php_php_fpm_config()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_php_php_fpm_service&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.cp_php_php_fpm_service()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_php&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.start_php()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;php_clean_local_tmp_cache_files&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    php_install.clean_local_tmp_cache_files()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_redis</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;redis_copy&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.cp_source()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_redis_install_shell&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.cp_redis_install_shell()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_redis_group_and_user&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.create_redis_group_and_user()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;install_redis&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.install_redis()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_redis_log_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.create_redis_log_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;crate_redis_data_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.crate_redis_data_dir()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_redis_config&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.copy_redis_config()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_redis_service_config&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.copy_redis_service_config()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;redis_clean_local_tmp_cache_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    redis_install.clean_local_tmp_cache_file()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_jdk</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;yum_install_jdk&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    yum_install_jdk()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_zabbix_agent</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;zabbix_copy&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.cp_source()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_zabbix_agent_install_shell&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.cp_zabbix_agent_install_shell()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_zabbix_group_and_user&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.create_zabbix_group_and_user()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;create_zabbix_agent_log_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.create_zabbix_agent_log_dir()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;install_zabbix_agent&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.install_zabbix_agent()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_zabbix_agent_config_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.copy_zabbix_agent_config_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_zabbix_agent_init_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.copy_zabbix_agent_init_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;zabbix_clean_local_tmp_cache_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.clean_local_tmp_cache_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;add_zabbix_agent_init&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.add_zabbix_agent_init()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_zabbix_agentd&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    zabbix_agent_install.start_zabbix_agentd()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_mysqlxx</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;deletexx_old_conf&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.delete_old_conf()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;deletexx_old_conf_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.delete_old_conf_dir()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;mysqlxx_source&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.cp_source()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_mysqlxx_conf&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.cp_mysql_conf()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_mysqlxx_install_sh&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.copy_mysql_install_sh()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;add_mysqlxx_user_and_group&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.add_mysql_user_and_group()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;createxx_related_directories&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.create_related_directories()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;createxx_slowlog_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.create_slowlog_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;install_mysqlxx&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.install_mysql()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;add_mysqlxx_to_PATH&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.add_mysql_to_PATH()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_mysqlxx_service_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.copy_mysql_service_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cleanxx_local_tmp_cache_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.clean_local_tmp_cache_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_mysqlxx_and_enable_it_onboot&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx_install.start_mysql_and_enable_it_onboot()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_mysqlxx13</span>():</span></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;deletexx13_old_conf&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.delete_old_conf()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;deletexx13_old_conf_dir&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.delete_old_conf_dir()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;mysqlxx13_source&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.cp_source()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cp_mysqlxx13_conf&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.cp_mysql_conf()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_mysqlxx13_install_sh&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.copy_mysql_install_sh()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;add_mysqlxx13_user_and_group&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.add_mysql_user_and_group()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;createxx13_related_directories&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.create_related_directories()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;createxx13_slowlog_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.create_slowlog_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;install_mysqlxx13&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.install_mysql()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;add_mysqlxx13_to_PATH&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.add_mysql_to_PATH()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;copy_mysqlxx13_service_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.copy_mysql_service_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;cleanxx13_local_tmp_cache_file&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.clean_local_tmp_cache_file()</span><br><span class="line"></span><br><span class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_mysqlxx13_and_enable_it_onboot&#x27;</span>])</span><br><span class="line">    print_application_message.message_green()</span><br><span class="line">    mysqlxx13_install.start_mysql_and_enable_it_onboot()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_all_application_package</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(APP) != (<span class="number">0</span>):</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_yum_tools_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_yum_install()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;nginx&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_nginx_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_nginx()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;php&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_php_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_php()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;redis&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_redis_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_redis()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;jdk&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_jdk_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_jdk()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;zabbix_agent&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_zabbix_agentd_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_zabbix_agent()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;mysql_xx&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_mysqlxx_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_mysqlxx()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;mysql_xx13&#x27;</span> <span class="keyword">in</span> APP:</span><br><span class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">&#x27;start_mysqlxx13_install&#x27;</span>])</span><br><span class="line">        print_application_message.message_blue()</span><br><span class="line">        run_install_mysqlxx13()</span><br></pre></td></tr></table></figure>
<h2 id="定义入口文件"><a href="#定义入口文件" class="headerlink" title="定义入口文件"></a>定义入口文件</h2><p>kvm.py 是所有程序执行的入口文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> PrettyTable</span><br><span class="line"><span class="keyword">from</span> config.hosts <span class="keyword">import</span> SOURCES_HOSTS,TARGETS_HOSTS,KVM_HOSTS</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> application.kvmcreate <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> application.appcreate <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">@hosts(SOURCES_HOSTS)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_sources_clone_scp</span>():</span></span><br><span class="line">    kvm_create()</span><br><span class="line"><span class="meta">@hosts(TARGETS_HOSTS)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_targets_site</span>():</span></span><br><span class="line">    targets_hosts_start_kvm()</span><br><span class="line"><span class="meta">@hosts(KVM_HOSTS)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_virture_host_start_site</span>():</span></span><br><span class="line">    kvm_virture_hosts_site()</span><br><span class="line">    run_install_all_application_package()</span><br><span class="line">    kvm_tirture_hosts_site_passwd()</span><br><span class="line">    kvm_virture_hosts_print()</span><br><span class="line"><span class="meta">@task(name=&#x27;install&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_all</span>():</span></span><br><span class="line">    execute(kvm_sources_clone_scp)</span><br><span class="line">    execute(kvm_targets_site)</span><br><span class="line">    execute(kvm_virture_host_start_site)</span><br><span class="line"><span class="meta">@task(name=&#x27;help&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deploy_help</span>():</span></span><br><span class="line">    <span class="built_in">print</span> green(<span class="string">&quot;KVM产品及CentOS7应用部署&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> yellow(<span class="string">&quot;    1.配置文件&quot;</span>)</span><br><span class="line">    helper = PrettyTable()</span><br><span class="line">    helper.field_names = [<span class="string">&quot;配置&quot;</span>,<span class="string">&quot;说明&quot;</span>]</span><br><span class="line">    helper.align = <span class="string">&quot;l&quot;</span></span><br><span class="line">    helper.add_row([<span class="string">&quot;config/__init__.py&quot;</span>, <span class="string">&quot;配置文件开关&quot;</span>])</span><br><span class="line">    helper.add_row([<span class="string">&quot;config/test/kvm_config.py&quot;</span>, <span class="string">&quot;测试环境部署配置&quot;</span>])</span><br><span class="line">    helper.add_row([<span class="string">&quot;config/prod/kvm_config.py&quot;</span>, <span class="string">&quot;生产环境部署配置&quot;</span>])</span><br><span class="line">    <span class="built_in">print</span> helper</span><br><span class="line">    <span class="built_in">print</span> red(<span class="string">&quot;    2.指令说明&quot;</span>)</span><br><span class="line">    helper = PrettyTable()</span><br><span class="line">    helper.field_names = [<span class="string">&quot;指令&quot;</span>,<span class="string">&quot;说明&quot;</span>]</span><br><span class="line">    helper.align = <span class="string">&quot;l&quot;</span></span><br><span class="line">    helper.add_row([<span class="string">&quot;fab -f kvm.py -l&quot;</span>, <span class="string">&quot;列出部署产品&quot;</span>])</span><br><span class="line">    helper.add_row([<span class="string">&quot;fab -f kvm.py install&quot;</span>, <span class="string">&quot;安装kvm,并整合配置的应用至kvm新虚拟服务器&quot;</span>])</span><br><span class="line">    <span class="built_in">print</span> helper</span><br><span class="line">    <span class="built_in">print</span> blue(<span class="string">&quot;    3.作者信息&quot;</span>)</span><br><span class="line">    helper = PrettyTable()</span><br><span class="line">    helper.field_names = [<span class="string">&quot;作者&quot;</span>,<span class="string">&quot;信息&quot;</span>]</span><br><span class="line">    helper.add_row([<span class="string">&quot;姓名&quot;</span>, <span class="string">&quot;任锦&quot;</span>])</span><br><span class="line">    helper.add_row([<span class="string">&quot;手机号&quot;</span>, <span class="string">&quot;13161389224&quot;</span>])</span><br><span class="line">    helper.add_row([<span class="string">&quot;博客地址&quot;</span>, <span class="string">&quot;www.ssjinyao.com&quot;</span>])</span><br><span class="line">    <span class="built_in">print</span> helper</span><br></pre></td></tr></table></figure>
<h2 id="服务器部署完此代码后，定义别名调用kvm-py实现快速开通"><a href="#服务器部署完此代码后，定义别名调用kvm-py实现快速开通" class="headerlink" title="服务器部署完此代码后，定义别名调用kvm.py实现快速开通"></a>服务器部署完此代码后，定义别名调用kvm.py实现快速开通</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># alias kc1=&#x27;source  /root/renjin/kvm_pyenv/bin/activate &amp;&amp; vim /root/renjin/kvm_create/config/__init__.py&#x27;</span></span><br><span class="line"><span class="comment"># alias kc2p=&#x27;vim +33 /root/renjin/kvm_create/config/prod/kvm_config.py&#x27;</span></span><br><span class="line"><span class="comment"># alias kc2t=&#x27;vim +33 /root/renjin/kvm_create/config/test/kvm_config.py&#x27;</span></span><br><span class="line"><span class="comment"># alias kc3=&#x27;cd /root/renjin/kvm_create/ &amp;&amp; fab -f kvm.py install&#x27;</span></span><br><span class="line"><span class="comment"># alias kcok1=&#x27;vim /root/renjin/kvm_create/config/__init__.py&#x27;</span></span><br><span class="line"><span class="comment"># alias kcok2p=&#x27;vim +33 /root/renjin/kvm_create/config/prod/kvm_config.py&#x27;</span></span><br><span class="line"><span class="comment"># alias kcok2t=&#x27;vim +33 /root/renjin/kvm_create/config/test/kvm_config.py&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="自动化快速开启开通kvm虚拟化服务器"><a href="#自动化快速开启开通kvm虚拟化服务器" class="headerlink" title="自动化快速开启开通kvm虚拟化服务器"></a>自动化快速开启开通kvm虚拟化服务器</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">****************************************************************************************************</span><br><span class="line">**********  KVM ENV Is: <span class="built_in">test</span>                                                              **********</span><br><span class="line">**********  KVM Host Name Is: xx-xxxx-xx-xxx-xxxx-xxxx                                   **********</span><br><span class="line">**********  KVM IP Is: xxx.xx.xx.xx                                                       **********</span><br><span class="line">**********  TARGET IP Is: xxx.xx.xxx.xx                                                   **********</span><br><span class="line">**********  KVM Gateway Is: xxx.xx.x.x                                                    **********</span><br><span class="line">**********  KVM Netmask Is: xxx.xxx.xxx.x                                                 **********</span><br><span class="line">**********  KVM APP Is: zabbix_agent nginx mysql_xx                                       **********</span><br><span class="line">**********  KVM CPU Is: 2                                                                 **********</span><br><span class="line">**********  KVM Memory Is: 4194304                                                        **********</span><br><span class="line">**********  KVM Disk Is: 100G                                                             **********</span><br><span class="line">**********  KVM Passwd IS: xxxxxxxXXXX                                                    **********</span><br><span class="line">****************************************************************************************************</span><br><span class="line"></span><br><span class="line">If the information is incorrect, please input no: </span><br></pre></td></tr></table></figure>
<p><img src="/images/kvm_start_install.png" class="lazyload" data-srcset="/images/kvm_start_install.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="开通kvm虚似服务器已经完成，信息如下"><a href="#开通kvm虚似服务器已经完成，信息如下" class="headerlink" title="开通kvm虚似服务器已经完成，信息如下"></a>开通kvm虚似服务器已经完成，信息如下</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">****************************************************************************************************</span><br><span class="line">**********  KVM ENV Is: <span class="built_in">test</span>                                                              **********</span><br><span class="line">**********  KVM Host Name Is: bj-xxxx-xx-xxx-xxxx-xxxxx                                   **********</span><br><span class="line">**********  KVM IP Is: xxx.xx.xx.xx                                                       **********</span><br><span class="line">**********  TARGET IP Is: xxx.xx.xxx.xx                                                   **********</span><br><span class="line">**********  KVM Gateway Is: xxx.xx.xx.x                                                   **********</span><br><span class="line">**********  KVM Netmask Is: xxx.xxx.xxx.0                                                 **********</span><br><span class="line">**********  KVM APP Is:  zabbix_agent nginx mysql_xx                                      **********</span><br><span class="line">**********  KVM CPU Is: 2                                                                 **********</span><br><span class="line">**********  KVM Memory Is: 4194304                                                        **********</span><br><span class="line">**********  KVM Disk Is: 100G                                                             **********</span><br><span class="line">**********  KVM Passwd IS: XXXXXXXX                                                       **********</span><br><span class="line">****************************************************************************************************</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Done.</span><br><span class="line">Disconnecting from xxx.xx.xx.xx... <span class="keyword">done</span>.</span><br><span class="line">Disconnecting from xxx.xx.xx.xx... <span class="keyword">done</span>.</span><br><span class="line">Disconnecting from xxx.xx.xx.xx... <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>关于某系统阵发性网络问题的处理。</title>
    <url>/2019/03/16/%E5%85%B3%E4%BA%8E%E6%9F%90%E7%B3%BB%E7%BB%9F%E9%98%B5%E5%8F%91%E6%80%A7%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="关于某系统阵发性网络问题的处理。"><a href="#关于某系统阵发性网络问题的处理。" class="headerlink" title="关于某系统阵发性网络问题的处理。"></a>关于某系统阵发性网络问题的处理。</h2><p> <img src="/images/tcp_problem.jpeg" class="lazyload" data-srcset="/images/tcp_problem.jpeg" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="一、问题描述"><a href="#一、问题描述" class="headerlink" title="一、问题描述"></a>一、问题描述</h3><ul>
<li>1、xxx 、移动 xx 等系统阵发性网络连接失败;</li>
<li>2、keepalived 虚拟ip未发生切换，nginx 访问日志记录正常，未收到错误日志，网络及链路测试正常;</li>
<li>3、keepalvied+ nginx 反代的其余系统未发现阵发性网络问题;</li>
<li><p>4、修改本地解析到keepalived虚拟ip，XXX相关系统访问正常。</p>
<p><img src="/images/granfana-network-problem.jpg" class="lazyload" data-srcset="/images/granfana-network-problem.jpg" srcset="data:image/png;base64,666" alt=""></p>
</li>
</ul>
<h3 id="二、应急切换与故障重现"><a href="#二、应急切换与故障重现" class="headerlink" title="二、应急切换与故障重现"></a>二、应急切换与故障重现</h3><ul>
<li>1、周二频繁出现阵发性网络连接失败，应急将XXX虚ip切换回原私有云服务器，系统恢复;</li>
<li>2、后考虑移动xx系统出现的网络问题频率较高，因此考虑在个人客户端重现故障;</li>
<li>3、在个人macos中搭建dns服务器，配置xx域名解析到非XXX 系统keepavlied虚ip所映射的公网ip;</li>
<li>4、在手机上刷新app，多次刷新，锁屏再打开后故障重现。</li>
</ul>
<h3 id="三、问题定位"><a href="#三、问题定位" class="headerlink" title="三、问题定位"></a>三、问题定位</h3><ul>
<li>1、故障重现后，在XXX系统 keepailved 所在的服务器上进行 tcpdump 抓包分析;</li>
<li>2、因目前只有一个客户端访问非XXX nginx，因此可以看到nginx日志是一个公网ip访问过来的;</li>
<li>3、开启两个终端，一个实时监控日志，另一个用于tcpdump抓包保存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;oa.huatu.com.log </span><br><span class="line"># tcpdump -i team1 -s 0 -n &#39;host xxx.xxx.xxx.xxx&#39; -w &#x2F;tmp&#x2F;xx_packet.pcap</span><br></pre></td></tr></table></figure>
<ul>
<li>4、当app端问题复现后，发现nginx 未记录日志, 将 xx_packet.pcap 导出，用wireshark 导出分析</li>
<li>5、发现有三次tcp请求是正常进入网卡的，但是服务器没有回应，问题定位在服务器网络层面;</li>
<li>6、google搜索 linux tcp 没有回包 ，发现原理是由以下两个参数导致的</li>
<li>7、net.ipv4.tcp_timestamps net.ipv4.tcp_tw_recycle;</li>
<li>8、发现服务器上的net.ipv4.tcp_timestamps，net.ipv4.tcp_tw_recycle 都为1;</li>
</ul>
<h3 id="四、故障处理"><a href="#四、故障处理" class="headerlink" title="四、故障处理"></a>四、故障处理</h3><p>修改两台服务器的 /etc/sysctl.conf  以下两条内核参数，并生效;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim  &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">net.ipv4.tcp_tw_recycle &#x3D; 0</span><br><span class="line">net.ipv4.tcp_timestamps &#x3D; 0 </span><br><span class="line"></span><br><span class="line"># sysctl -p 生效</span><br></pre></td></tr></table></figure>
<p>将keepalived 虚拟ip再切换回物理服务器，故障处理;</p>
<h3 id="五、内核参数说明"><a href="#五、内核参数说明" class="headerlink" title="五、内核参数说明;"></a>五、内核参数说明;</h3><ul>
<li>1、net.ipv4.tcp_timestamps 是给所有进入服务器网卡的流量打时间标签，就像生产的面包打印生产日期;</li>
<li>2、net.ipv4.tcp_tw_recycle 是对连接时间超过60s的tcp资源进行回收并reject，同一时间内同一ip访问过多的tcp连接，它只会认为最近的一次SYN有效，其余的SYN拒绝;</li>
<li>这两条参数配合起来，当都开启时用于防范tcp攻击;</li>
<li>3、这两个参数结合起来是为了防止同一ip的tcp攻击，因同一局域网内是同一个公网ip，故造成同一局域网内多人访问时，SYN被拒绝，报网络错误，这也解释了为何非XXX业务访问未出现这样的问题、通过修改本地host解析直接访问私网ip未出现这样的问题。</li>
</ul>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx+lua+redis 实现短链接转发长链接</title>
    <url>/2019/03/11/nginx-lua-redis%E5%AE%9E%E7%9F%AD%E9%93%BE%E6%8E%A5%E8%BD%AC%E5%8F%91%E9%95%BF%E9%93%BE%E6%8E%A5/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="nginx-lua-redis-实现短链接转发长链接"><a href="#nginx-lua-redis-实现短链接转发长链接" class="headerlink" title="nginx + lua + redis 实现短链接转发长链接"></a>nginx + lua + redis 实现短链接转发长链接</h2><p><img src="/images/nginx-redis-lua.png" class="lazyload" data-srcset="/images/nginx-redis-lua.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="重新编译安装-nginx-及相关依赖"><a href="#重新编译安装-nginx-及相关依赖" class="headerlink" title="重新编译安装 nginx  及相关依赖"></a>重新编译安装 nginx  及相关依赖</h3><p>安装相关依赖包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel  lua-devel luajit-devel pcre pcre-devel libxml2 libxml2-dev libxslt-devel gd-devel perl-devel perl-ExtUtils-Embed  GeoIP GeoIP-devel GeoIP-data gperftools </span></span><br></pre></td></tr></table></figure>
<p>下载nginx_devel_kit lua-nginx-module</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  wget https://github.com/simplresty/ngx_devel_kit/archive/master.zip</span></span><br><span class="line"><span class="comment">#  wget https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz</span></span><br><span class="line"><span class="comment">#  unzip master.zip &amp;&amp; mv ngx_devel_kit-master/ /usr/local/</span></span><br><span class="line"><span class="comment">#  tar -xvf v0.10.13.tar.gz  -C /usr/local/</span></span><br></pre></td></tr></table></figure>
<p>重新安装  nginx </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/src/nginx-1.12.2</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&#x27; --add-module=/usr/local/lua-nginx-module-0.10.13 --add-module=/usr/local/ngx_devel_kit-master</span></span><br><span class="line"><span class="comment"># make  &amp;&amp; make install </span></span><br></pre></td></tr></table></figure>
<p>安装lua-resty-redis</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/src</span></span><br><span class="line"><span class="comment"># wget https://github.com/openresty/lua-resty-redis/archive/master.zip</span></span><br><span class="line"><span class="comment"># unzip master.zip</span></span><br><span class="line"><span class="comment"># cd lua-resty-redis-master/</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">make: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `all<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">install -d /usr/local/lib/lua//resty</span></span><br><span class="line"><span class="string">install lib/resty/*.lua /usr/local/lib/lua//resty</span></span><br></pre></td></tr></table></figure>
<h2 id="修改nginx-http-段内配置文件"><a href="#修改nginx-http-段内配置文件" class="headerlink" title="修改nginx http 段内配置文件"></a>修改nginx http 段内配置文件</h2><p>http内添加 <code>lua_package_path &quot;/usr/local/lib/lua/?.lua;;&quot;;</code><br><code>;;</code> 代表的是LuaJIT安装时的原始搜索路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># nginx -t &amp;&amp; nginx -s reload</span></span><br></pre></td></tr></table></figure>
<h2 id="修改nginx-server或location-字段"><a href="#修改nginx-server或location-字段" class="headerlink" title="修改nginx server或location 字段"></a>修改nginx server或location 字段</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location /lua &#123;</span><br><span class="line">       default_type text/plain;</span><br><span class="line">       content_by_lua_file /usr/<span class="built_in">local</span>/lua/request.lua;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<h2 id="request-lua"><a href="#request-lua" class="headerlink" title="request.lua"></a>request.lua</h2><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"># vim /usr/<span class="keyword">local</span>/lua/request.lua</span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">&quot;resty.redis&quot;</span></span><br><span class="line"><span class="keyword">local</span> cache = redis:new()</span><br><span class="line"><span class="comment">-- redis连接</span></span><br><span class="line"><span class="keyword">local</span> ok,err = cache.connect(cache, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="string">&#x27;25612&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;failed to connect redis cache:&quot;</span>, err);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- redis认证</span></span><br><span class="line"><span class="keyword">local</span> count</span><br><span class="line">count, err = cache:get_reused_times()</span><br><span class="line"><span class="keyword">if</span> <span class="number">0</span> == count <span class="keyword">then</span></span><br><span class="line">    ok,err = cache:auth(<span class="string">&quot;xxxxx&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">        ngx.say(<span class="string">&quot;failed to auth redis: &quot;</span> , err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">elseif</span> err <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;failed to get reused times: &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 选择使用的redis数据库</span></span><br><span class="line">cache:<span class="built_in">select</span>(<span class="number">7</span>)</span><br><span class="line"><span class="comment">-- 当前访问地址</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> url = ngx.var.uri</span><br><span class="line"></span><br><span class="line"><span class="comment">--  主机名</span></span><br><span class="line"><span class="keyword">local</span> host = ngx.var.host</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 链接参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> args = ngx.var.args</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取方法</span></span><br><span class="line"><span class="keyword">local</span> sch =ngx.var.scheme</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取端口</span></span><br><span class="line"><span class="comment">--local pot =ngx.var.server_port</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义通用完整 url 路径</span></span><br><span class="line"><span class="keyword">local</span> url_full_path = sch .. <span class="string">&quot;://&quot;</span> .. host .. url</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取redis 中的值</span></span><br><span class="line"><span class="keyword">local</span> res, err = cache:get(url_full_path)</span><br><span class="line"><span class="comment">-- ngx.req.set_uri(url)</span></span><br><span class="line"><span class="keyword">if</span> res <span class="keyword">then</span></span><br><span class="line">   <span class="comment">--ngx.say(sch .. &quot;://&quot; .. host .. url .. &quot; &quot; .. res)</span></span><br><span class="line">   ngx.redirect(res,<span class="number">302</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"># nginx -s reload </span><br></pre></td></tr></table></figure>
<h2 id="在redis-写入key-并测试"><a href="#在redis-写入key-并测试" class="headerlink" title="在redis 写入key 并测试"></a>在redis 写入key 并测试</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># redis-cli -h 127.0.0.1 -p 25612</span></span><br><span class="line">127.0.0.1:25612&gt; AUTH xxxxxxxxxx</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612&gt; SELECT 7</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612[7]&gt; <span class="built_in">set</span> https://www.ssjinyao.com/lua/<span class="built_in">test</span> https://www.ssjinyao.com/2019/03/16/%E5%85%B3%E4%BA%8E%E6%9F%90%E7%B3%BB%E7%BB%9F%E9%98%B5%E5%8F%91%E6%80%7%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86/</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p><img src="/images/nginx-redis-lua-test.png" class="lazyload" data-srcset="/images/nginx-redis-lua-test.png" srcset="data:image/png;base64,666" alt=""></p>
<p>可以看到访问时的中转</p>
<p><img src="/images/nginx-redis-lua-test-redirect.png" class="lazyload" data-srcset="/images/nginx-redis-lua-test-redirect.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="补充nginx-rewrite转发正则匹配"><a href="#补充nginx-rewrite转发正则匹配" class="headerlink" title="补充nginx rewrite转发正则匹配"></a>补充nginx rewrite转发正则匹配</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rewrite ^/([0-9][0-9][0-9][0-9])/([0-1][0-9][0-9][0-9])/([0-9]+\.html) http://test.ssjinyao.com/<span class="variable">$1</span>/<span class="variable">$2</span>/<span class="variable">$3</span>  permanent;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>服务器常用配置参数明细</title>
    <url>/2018/10/29/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E6%98%8E%E7%BB%86/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="线上服务配置参数明细"><a href="#线上服务配置参数明细" class="headerlink" title="线上服务配置参数明细"></a>线上服务配置参数明细</h1><p><img src="/images/ops.png" class="lazyload" data-srcset="/images/ops.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li><p>问答nginx 反向代理的作用<br>1、使用反向代理可以理解为7层应用层的负载均衡，使用负载均衡之后可以非常便捷的横向扩展服务器集群，实现集群整体并发能力、抗压能力的提高。<br>2、通常反向代理服务器会带有本地 Cache 功能，通过静态资源的 Cache，有效的减少后端服务器所承载的压力，从而提高性能。</p>
</li>
<li><p>磨刀意识</p>
</li>
</ul>
<p>1、关于任何操作配置，最好先搞明白操作或配置的原理，然后再去操作。应一句话叫做“磨刀不误砍柴功”，而且对于类似的操作可以举一反三。</p>
<h2 id="nginx服务配置项"><a href="#nginx服务配置项" class="headerlink" title="nginx服务配置项"></a>nginx服务配置项</h2><p>1、 nginx 全局配置明细</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 默认 &#x2F;etc&#x2F;nginx&#x2F;nginx.conf 全局配置文件 </span><br><span class="line">#指定nginx worker进程运行用户以及用户组，也可以是 user www-data www-data;</span><br><span class="line">user www-data; </span><br><span class="line"># 指明nginx要开启的进程数为4，一般为CPU核心数的1到2倍;</span><br><span class="line">worker_processes 4;</span><br><span class="line"></span><br><span class="line"># nginx pid文件存放位置 </span><br><span class="line">pid &#x2F;run&#x2F;nginx.pid;</span><br><span class="line"></span><br><span class="line"># events &#123;这里都是nginx的事件模块&#125;</span><br><span class="line">events &#123;</span><br><span class="line"># worker_connetctions 是指nginx最大的并发连接数;</span><br><span class="line">	worker_connections 768;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># http &#123;设定http服务&#125;</span><br><span class="line">http &#123;</span><br><span class="line"># 设置nginx上传文件最大限制</span><br><span class="line">   client_max_body_size 50m;   </span><br><span class="line">   </span><br><span class="line">#  配置可以提高 Nginx 静态资源托管效率。sendfile 是一个系统调用，直接在内核空间完成文件发送，不需要先 read 再 write，没有上下文切换开销;	</span><br><span class="line">	sendfile on;</span><br><span class="line">	</span><br><span class="line"># Nginx 里统一用 tcp_nopush 来控制它,只有在启用了 sendfile 之后才生效，启用它之后，数据包会累计到一定大小之后才会发送，减小了额外开销，提高网络效率;</span><br><span class="line">	tcp_nopush on;</span><br><span class="line">	</span><br><span class="line"># 启用后会禁用 Nagle 算法，尽快发送数据，Nginx 只会针对处于 keep-alive 状态的 TCP 连接才会启用;</span><br><span class="line">	tcp_nodelay on;</span><br><span class="line">	</span><br><span class="line"># 长连接超时时间，单位是秒,长连接请求大量小文件的时候，可以减少重建连接的开销，但假如有大文件上传  </span><br><span class="line"># 65s内没上传完成会导致失败。如果设置时间过长，用户又多，长时间保持连接会占用大量资源。</span><br><span class="line">	keepalive_timeout 65;</span><br><span class="line">	</span><br><span class="line"># types_hash_max_size 影响散列表的冲突率。types_hash_max_size越大，就会消耗更多的内存</span><br><span class="line"># 但散列key的冲突率会降低，检索速度就更快</span><br><span class="line"># types_hash_max_size越小，消耗的内存就越小，但散列key的冲突率可能上升</span><br><span class="line">	types_hash_max_size 2048;	</span><br><span class="line">	</span><br><span class="line"># 定义 mime 配置文件的文位</span><br><span class="line">	include &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">	</span><br><span class="line"># 当用户请求的文件类型 不在服务器定义的mime类型映射时，使用DefaultType</span><br><span class="line">	default_type application&#x2F;octet-stream;</span><br><span class="line">	</span><br><span class="line"># 定义nginx正常访问日志位置 </span><br><span class="line">	access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log;</span><br><span class="line">	</span><br><span class="line"># 定义nginx错误访问日志位置 </span><br><span class="line">	error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;</span><br><span class="line">	</span><br><span class="line"># 开启nginx压缩功能，压缩的过程是个消耗CPU的过程，而压缩过后传输过程可以节省带宽;</span><br><span class="line">	gzip on;</span><br><span class="line">	</span><br><span class="line"># 对于microsoft explorer 6 不启用gzip压缩功能; </span><br><span class="line">	gzip_disable &quot;msie6&quot;;</span><br><span class="line"></span><br><span class="line"># nginx 虚拟服务器配置文件所在目录;</span><br><span class="line">	include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;</span><br><span class="line">	</span><br><span class="line"># nginx 虚拟服务器配置文件所在目录;</span><br><span class="line">	include &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;*.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2、 nginx 默认80重定向443配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 每个server代表一台虚拟主机;</span><br><span class="line">server &#123;  </span><br><span class="line"></span><br><span class="line"># listen 80 监听80端口;</span><br><span class="line">    listen  80;  </span><br><span class="line"></span><br><span class="line"># server_name  _; 定义任意域名;</span><br><span class="line">    server_name _；</span><br><span class="line"></span><br><span class="line"># 将返回301的重写到https:&#x2F;&#x2F;源服务器源uri;</span><br><span class="line">    return 301 https:&#x2F;&#x2F;$HOST$request_uri;</span><br><span class="line"></span><br><span class="line"># 将server_name 永久的将任意字符开头结尾的 重写至https:&#x2F;&#x2F;源主机源uri位置;</span><br><span class="line">#    server_name test.com;  </span><br><span class="line">#    rewrite ^(.*)$  https:&#x2F;&#x2F;$host$1 permanent;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、 nginx 线上虚拟主机配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 每个server代表到哪虚拟主机;</span><br><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line"># 监听https传输协议的443端口，ssl为采用加密传输，并且身份证明;</span><br><span class="line">	listen 443 ssl;</span><br><span class="line"></span><br><span class="line"># ssl安全传输开启;</span><br><span class="line">	ssl on;</span><br><span class="line"></span><br><span class="line"># 注在apache中证书与加密传输还有pem是三个文件</span><br><span class="line"># ssl授权证书文件，也可以理解为身份的证明文件;</span><br><span class="line">	ssl_certificate &#x2F;home&#x2F;admin&#x2F;api_ssl&#x2F;server.crt;</span><br><span class="line"></span><br><span class="line"># ssl加密文件,数据传输过程中，通过此密钥文件将传送的数据加密码;</span><br><span class="line">	ssl_certificate_key &#x2F;home&#x2F;admin&#x2F;api_ssl&#x2F;server.key;</span><br><span class="line"></span><br><span class="line"># 设置客户端能够重复使用存储在缓存中的会话参数时间为5分钟;</span><br><span class="line">	ssl_session_timeout 5m;</span><br><span class="line"></span><br><span class="line"># 指定使用的SSL协议</span><br><span class="line">	ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line"></span><br><span class="line"># 指定许可密码的描述。密码以openssl支持的格式指定；</span><br><span class="line">	ssl_ciphers &quot;HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES&quot;;</span><br><span class="line"></span><br><span class="line"># 对SSLv3和TLSv1协议的服务器端密码需求优先级高于客户端密码;</span><br><span class="line">	ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line"># 指定虚拟主机的主机名;</span><br><span class="line">	server_name api.ssjinyao.com.com;</span><br><span class="line">	</span><br><span class="line"># location 指定匹配规则, &#x2F; 这里指默认匹配项;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">        </span><br><span class="line"># 将匹配到的location反代到至http:&#x2F;&#x2F;127.0.0.1:17777;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;127.0.0.1:17777; # 这里是指向 gunicorn host 的服务地址</span><br><span class="line"></span><br><span class="line"># 设置反向代理的请求头部host为源http的请求host;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line"># 设置反向代理的请求头部转发的内容为请求url的源地址;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line"># 设置将用户的IP赋值给X-Real-IP以供各应用调用;  </span><br><span class="line">	  		proxy_set_header X-Real-Ip $Remote_addr;</span><br><span class="line"></span><br><span class="line"># 设置代理缓冲大小为128k			</span><br><span class="line">			proxy_buffer_size   128k;</span><br><span class="line"></span><br><span class="line"># 设置代理缓冲区间4至 256k       </span><br><span class="line">            proxy_buffers   4 256k;</span><br><span class="line">            </span><br><span class="line"># 设置代理最大缓冲区间为256k;            </span><br><span class="line">            proxy_busy_buffers_size   256k;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、需求-负载均衡配置项:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在http段中加入以下配置</span><br><span class="line"># 指定upstream负载均衡模块,指定将要在server中调用的调度服务名称;</span><br><span class="line">	upstream tewww &#123;</span><br><span class="line"></span><br><span class="line"># 指定web服务的第一个节点; 注:之后配置使用IP来配置，而不使用域名</span><br><span class="line">		server wwwnode1.ssjinyao.com.com:443;</span><br><span class="line">		</span><br><span class="line"># 若有性能较高的服务器，可以采用加权轮询，那么这台服务器的权重是3&#x2F;5;</span><br><span class="line">		server wwwnode2.ssjinyao.com.com:443 weight&#x3D;3;</span><br><span class="line"></span><br><span class="line"># 指定web服务的第三个节点;</span><br><span class="line">		server wwwnode3.ssjinyao.com.com:443;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在定义一台虚拟主机；</span><br><span class="line">server &#123;</span><br><span class="line">      listen 443;</span><br><span class="line">      server_name www.ssjinyao.com.com;</span><br><span class="line"></span><br><span class="line">      ssl on;</span><br><span class="line">      ssl_certificate &#x2F;etc&#x2F;nginx&#x2F;te_ssl&#x2F;ssjinyao.com.crt;</span><br><span class="line">      ssl_certificate_key &#x2F;etc&#x2F;nginx&#x2F;te_ssl&#x2F;ssjinyao.com.key;</span><br><span class="line"></span><br><span class="line">      ssl_session_timeout 5m;</span><br><span class="line"></span><br><span class="line">      ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">      ssl_ciphers &quot;HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES&quot;;</span><br><span class="line">      ssl_prefer_server_ciphers on;</span><br><span class="line">      location &#x2F;</span><br><span class="line">      &#123;</span><br><span class="line"># 指定反代的服务器，为tewww负载均衡集群;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;tewww;</span><br><span class="line">		proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>5、nginx操作注意项</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a、不影响其它服务的情况下重读配置文件, 一定要先对nginx的配置语法进行测试;</span><br><span class="line">	# sudo nginx -t </span><br><span class="line"></span><br><span class="line">b、在没有nginx监听端口变更的情况下，则不要重启服务;</span><br><span class="line">	# sudo nginx -s reload </span><br><span class="line"></span><br><span class="line">c、如上，反之，则必需重启服务器</span><br><span class="line">	# sudo nginx -s restart # sudo &#x2F;etc&#x2F;init.d&#x2F;nginx restart </span><br></pre></td></tr></table></figure>
<p>6、nginx监控</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">服务端的监控，监控nginx 443端口，80端口, 最近最后一次值不为1时报警;</span><br></pre></td></tr></table></figure>
<p>7、手头存一份标准的配置文件</p>
<p>8、一次比较复杂的虚拟主机配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  jr.local.ssjinyao.com;</span><br><span class="line">        charset gb2312;</span><br><span class="line">        </span><br><span class="line"> access_log  &#x2F;Users&#x2F;zlz&#x2F;wwwroot&#x2F;logs&#x2F;jr.access.log;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">  root &#x2F;Users&#x2F;zlz&#x2F;wwwroot&#x2F;dedecms&#x2F;a&#x2F;bank;</span><br><span class="line">  index index.html index.htm index.php;</span><br><span class="line">      location ~ \.php$ &#123;</span><br><span class="line">               # default_type text&#x2F;html;</span><br><span class="line">               # add_header Content-Type &#39;text&#x2F;html; charset&#x3D;utf-8&#39;;</span><br><span class="line">               # return 200 &quot;$document_root  , $fastcgi_script_name&quot;;</span><br><span class="line">                fastcgi_split_path_info ^(.+\.php)(.*)$;</span><br><span class="line">                fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">                fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">                fastcgi_index  index.php;</span><br><span class="line">                fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">                include        fastcgi_params;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">        location &#x2F;zt &#123; </span><br><span class="line">    alias &#x2F;Users&#x2F;zlz&#x2F;wwwroot&#x2F;dedecms&#x2F;zt;</span><br><span class="line">    #default_type text&#x2F;html;</span><br><span class="line">           #add_header Content-Type &#39;text&#x2F;html; charset&#x3D;utf-8&#39;;</span><br><span class="line">           #return 200 &quot;&lt;h1&gt;十月十七&lt;&#x2F;h1&gt;&quot;;</span><br><span class="line"> </span><br><span class="line">    location ~ &#x2F;zt&#x2F;(.*)\.php(.*)$ &#123;</span><br><span class="line">               #default_type text&#x2F;html;</span><br><span class="line">               #add_header Content-Type &#39;text&#x2F;html; charset&#x3D;utf-8&#39;;</span><br><span class="line">               #return 200 &quot;$document_root  , $fastcgi_script_name&quot;;</span><br><span class="line">        alias &#x2F;Users&#x2F;zlz&#x2F;wwwroot&#x2F;dedecms;</span><br><span class="line">               fastcgi_split_path_info ^(.+\.php)(.*)$;</span><br><span class="line">               fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">               fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">               fastcgi_index  index.php;</span><br><span class="line">               fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">               include        fastcgi_params;</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">        </span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line">        </span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ &#x2F;\.ht &#123;</span><br><span class="line">            deny  all;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"># proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;;</span><br><span class="line">#&#x2F;Users&#x2F;zlz&#x2F;wwwroot&#x2F;dedecms&#x2F;zt;</span><br><span class="line">#proxy_pass http:&#x2F;&#x2F;127.0.0.1:8089&#x2F;;</span><br></pre></td></tr></table></figure>
<p>补充一伪静态的重写，即 ww.ssjinyao.com/xxxx/xxxxx  重写至 <a href="http://www.ssjinyao.com/xxxx/xxxx/">www.ssjinyao.com/xxxx/xxxx/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rewrite &#x2F;(.*) https:&#x2F;&#x2F;www.ssjinyao.com&#x2F;$1&#x2F; permanent;</span><br></pre></td></tr></table></figure>
<p>rewrite 直接重写目录</p>
<p>rewrite 301</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rewrite ^&#x2F;zhaokao&#x2F; &#x2F;list&#x2F;zhaokao&#x2F; permanent;</span><br><span class="line">rewrite ^&#x2F;szrd&#x2F;    &#x2F;list&#x2F;szrd&#x2F; permanent;</span><br></pre></td></tr></table></figure>
<p>rewrite 302 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rewrite ^&#x2F;zhaokao&#x2F; &#x2F;list&#x2F;zhaokao&#x2F; redirect;</span><br><span class="line">rewrite ^&#x2F;szrd&#x2F;    &#x2F;list&#x2F;szrd&#x2F; redirect;</span><br></pre></td></tr></table></figure>
<p>nginx php-fpm 安全项配置 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># php-fpm.conf</span><br><span class="line">security.limit_extensions &#x3D; .php .php2 .php4 .php5 .php7 .html .htm</span><br><span class="line"># nginx vhosts</span><br><span class="line">location ~* ^&#x2F;jt&#x2F;.*.(php|php3|php4|php5)$ &#123;deny all;&#125;</span><br><span class="line"># 测试访问调度 </span><br><span class="line">location ~ \.php|\.php7|\.html|.htm$ &#123;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">        fastcgi_read_timeout 600;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="redis服务配置项"><a href="#redis服务配置项" class="headerlink" title="redis服务配置项"></a>redis服务配置项</h2><p>1、redis持久化配置</p>
<p>注: 若不需要则关闭以下配置； </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 持久化数据保存规则</span><br><span class="line"># 自己支实现一下</span><br><span class="line">#   900 秒内如果至少有 1 个 key 的值变化，则保存</span><br><span class="line">#   300 秒内如果至少有 10 个 key 的值变化，则保存</span><br><span class="line">#   60 秒内如果至少有 10000 个 key 的值变化，则保存</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"># redis持久化保存数据配置</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"></span><br><span class="line"># 数据保存的位置</span><br><span class="line">dir &#x2F;usr&#x2F;local&#x2F;redis&#x2F;db&#x2F;</span><br><span class="line"></span><br><span class="line"># 数据库的文件名称,另外要确定数据保存的位置redis有owner权限</span><br><span class="line">dbfilename dump.rdb</span><br></pre></td></tr></table></figure>
<p>2、redis是否需要外网连接;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 绑定的ip </span><br><span class="line"># bind 127.0.0.1</span><br><span class="line"># port 6379 或者port 25133</span><br><span class="line"></span><br><span class="line"># 若需要外网连接，则</span><br><span class="line"># bind 0.0.0.0</span><br><span class="line"># port 6379 或者port 25133 </span><br><span class="line">注: 另外还需要在阿里云上添加对应的需要访问的地址白名单与端口白名单; </span><br></pre></td></tr></table></figure>
<p>3、目前三条业务线上的redis数据重要性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置未开持久化，保存的数据皆为临时数据，可以清空;</span><br><span class="line"># 配置已经开启持久化，保存的数据为数据索引;数据不可以清空;</span><br><span class="line"># 配置已经开启持久化，保存的数据为用户数据;数据不可以清空;</span><br><span class="line">注: 不论数据是否为临时数据，每次对服务器的操作都要先对数据临时保存，确保操作后不会造成数据丢失;</span><br><span class="line"># 操作过程如下</span><br><span class="line"># redis-cli </span><br><span class="line">127.0.0.1:6379&gt; AUTH Amdce0De1fxxxxx</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET dir &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;db&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; SAVE</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>
<p>4、掌握redis重启命令 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;redis-server stop</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;redis-server start</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;redis-server restart</span><br><span class="line"># redis-cli -h 127.0.0.1 -p 6379 shutdown </span><br><span class="line"># kill -9 REDISPID</span><br></pre></td></tr></table></figure>
<p>5、redis监控</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a、监控服务redis端口 25133 或者 6379</span><br></pre></td></tr></table></figure>
<p>6、记得在/etc/redis/redis.conf中要配置密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># requirepass Amdce0De1fxxxxx</span><br></pre></td></tr></table></figure>
<p>7、注意白名单配置，让线上的服务器可以访问;</p>
<h2 id="mongo服务配置项"><a href="#mongo服务配置项" class="headerlink" title="mongo服务配置项"></a>mongo服务配置项</h2><p>1、保证有需要开机自启mongo的服务器,开机启动mongo </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在mongo的&#x2F;etc&#x2F;rc.local中加入以下内容 </span><br><span class="line"># mongod --auth --fork -f &#x2F;etc&#x2F;mongod.conf </span><br><span class="line"># 并保证 &#x2F;etc&#x2F;rc.local有执行权限</span><br></pre></td></tr></table></figure>
<p>2、保证线上使用的mongo服务器都是3.4的 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># sudo apt-key adv --keyserver hkp:&#x2F;&#x2F;keyserver.ubuntu.com:80 --recv # 0C49F3730359A14518585931BC711F9BA15703C6  </span><br><span class="line"># echo &quot;deb [ arch&#x3D;amd64 ] http:&#x2F;&#x2F;repo.mongodb.org&#x2F;apt&#x2F;ubuntu &quot;$(lsb_release -sc)&quot;&#x2F;mongodb-org&#x2F;3.4 multiverse&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;mongodb-3.4.list&#39;  </span><br><span class="line"># sudo apt-get update  </span><br><span class="line"># sudo apt-get install mongodb-org  </span><br><span class="line"># sudo killall mongod</span><br><span class="line"># sudo echo &#39;never&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line"># sudo echo &#39;never&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;defrag</span><br><span class="line"># sudo service mongod restart  </span><br><span class="line"># sudo chkconfig mongod on  </span><br></pre></td></tr></table></figure>
<p>3、会对用户的操作(增/删/改/查)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 添加admin用户</span><br><span class="line">use admin</span><br><span class="line">db.auth(&quot;admin&quot;,&quot;passwdxxxxxxxxxxx&quot;)</span><br><span class="line">use bc_ccc</span><br><span class="line"></span><br><span class="line">db.createUser(</span><br><span class="line"> &#123;</span><br><span class="line"> user:&quot;ht_eedu&quot;,</span><br><span class="line"> pwd:&#39;ht_eedom99xxx&#39;,</span><br><span class="line"> roles:[</span><br><span class="line"> &#123;role:&quot;dbOwner&quot;,db:&#39;ht_eedu&#39;&#125;</span><br><span class="line"> ]</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line"> </span><br><span class="line"> db.createUser(</span><br><span class="line"> &#123;</span><br><span class="line"> user:&quot;admin&quot;,</span><br><span class="line"> pwd:&#39;passwdxxxxxxxxxxx&#39;,</span><br><span class="line"> roles:[</span><br><span class="line"> &#123;role:&quot;dbOwner&quot;,db:&#39;test&#39;&#125;</span><br><span class="line"> ]</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"> db.createUser(</span><br><span class="line"> &#123;</span><br><span class="line"> user:&quot;admin&quot;,</span><br><span class="line"> pwd:&#39;passwdxxxxxxxxxxx&#39;,</span><br><span class="line"> roles:[</span><br><span class="line"> &#123;role:&quot;userAdminAnyDatabase&quot;,db:&#39;admin&#39;&#125;</span><br><span class="line"> ]</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># 添加对应数据库的用户 </span><br><span class="line">use te_data;</span><br><span class="line">db.createUser(</span><br><span class="line"> &#123;</span><br><span class="line"> user:&quot;admin&quot;,</span><br><span class="line"> pwd:&#39;passwdxxxxxxxxxxxx&#39;,</span><br><span class="line"> roles:[</span><br><span class="line"> &#123;role:&quot;dbOwner&quot;,db:&#39;test_data&#39;&#125;</span><br><span class="line"> ]</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line"># 删除用户</span><br><span class="line">db.dropUser(&quot;test_data&quot;)</span><br><span class="line"></span><br><span class="line"> db.createUser(</span><br><span class="line"> &#123;</span><br><span class="line"> user:&quot;test_data_read&quot;,</span><br><span class="line"> pwd:&#39;passwdxxxxxxxxxxx&#39;,</span><br><span class="line"> roles:[</span><br><span class="line"> &#123;role:&quot;read&quot;,db:&#39;test_data&#39;&#125;</span><br><span class="line"> ]</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line"></span><br><span class="line"> db.createUser(</span><br><span class="line"> &#123;</span><br><span class="line"> user:&quot;test_read&quot;,</span><br><span class="line"> pwd:&#39;passwdxxxxxxxxxxx&#39;,</span><br><span class="line"> roles:[</span><br><span class="line"> &#123;role:&quot;read&quot;,db:&#39;test&#39;&#125;</span><br><span class="line"> ]</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line"> </span><br><span class="line"># 修改用户密码</span><br><span class="line">db.changeUserPassword(&#39;admin&#39;,&#39;passwdxxxxxxxxxxxx&#39;);</span><br><span class="line"></span><br><span class="line"># 查看目前存在的用户</span><br><span class="line">&gt; show dbs</span><br><span class="line">admin         0.000GB</span><br><span class="line">bac_data      0.000GB</span><br><span class="line">kk            0.000GB</span><br><span class="line">local         0.000GB</span><br><span class="line">migrate_data  0.000GB</span><br><span class="line">te_data       0.031GB</span><br><span class="line">&gt; show users</span><br><span class="line">&#123;</span><br><span class="line">	&quot;_id&quot; : &quot;admin.admin&quot;,</span><br><span class="line">	&quot;user&quot; : &quot;admin&quot;,</span><br><span class="line">	&quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">	&quot;roles&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;role&quot; : &quot;userAdminAnyDatabase&quot;,</span><br><span class="line">			&quot;db&quot; : &quot;admin&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; use trisk_tmp</span><br><span class="line">&gt; show users;</span><br><span class="line">&gt; db.dropAllUsers()</span><br><span class="line"></span><br><span class="line"># 在库中增新建表</span><br><span class="line">use bm_kyc</span><br><span class="line">db.createCollection(&quot;ep_search&quot;)</span><br><span class="line">db.createCollection(&quot;screening_sections&quot;)</span><br><span class="line"></span><br><span class="line"># 删除字段</span><br><span class="line">db.screening_sections.remove(&#123;&#39;no&#39;:&#39;5a279xxxxxxxxx&#39;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4、数据的备份(导入/导出)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir &#x2F;tmp&#x2F;bak&#x2F;mongo</span><br><span class="line">mongodump --db test_kyc --out &#x2F;tmp&#x2F;bak&#x2F;mongo&#x2F;&#96;date +&quot;%m-%d-%y&quot;&#96;</span><br><span class="line">cd &#x2F;tmp&#x2F;bak&#x2F;mongo &amp;&amp; tar -cvf xxxx-xx-xx.tar.gz xxxx-xx-xx</span><br><span class="line">scp &#x2F;tmp&#x2F;bak&#x2F;mongo&#x2F;xxxx-xx-xx.tar.gz root@xx.xxx.xx.xxx:&#x2F;tmp&#x2F;</span><br><span class="line">crontab -e</span><br><span class="line">3 1 * * * find &#x2F;tmp&#x2F;bak&#x2F;mongo -mtime +7 -exec rm -rf &#123;&#125; \;</span><br><span class="line">mongorestore -u admin -p xxxx --db newdb --drop &#x2F;tmp&#x2F;bak&#x2F;mongo  注: --drop 要小心使用</span><br></pre></td></tr></table></figure>
<p>5、php模块编译安装3.4的支持</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a、mac 安装php mongo模块的支持</span><br><span class="line"># brew install mongo</span><br><span class="line"># brew install mongodb</span><br><span class="line"># cd &#x2F;Library&#x2F;WebServer&#x2F;Documents</span><br><span class="line"># brew install php56-mongo</span><br><span class="line"># 以下为测试连接文件 </span><br><span class="line">➜ cat index.php </span><br><span class="line">&lt;?php</span><br><span class="line">    $m &#x3D; new MongoClient(&#39;mongodb:&#x2F;&#x2F;admin:passwdxxxxxxxxxxx@47.92.xxx.xxxx:20911&#x2F;bc_ccc&#39;);</span><br><span class="line">    echo &quot;Connection to database successfully&quot;;  </span><br><span class="line">    &#x2F;&#x2F; 选择一个数据库  </span><br><span class="line">  $db &#x3D; $m-&gt;bm_kyc;  </span><br><span class="line">   echo &quot;Database mydb selected&quot;;  </span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">➜  cat test2.php </span><br><span class="line">&lt;?php </span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"># sudo vim &#x2F;etc&#x2F;php.ini</span><br><span class="line">    extension&#x3D;&#x2F;usr&#x2F;local&#x2F;opt&#x2F;php56-mongodb&#x2F;mongodb.so</span><br><span class="line">    extension&#x3D;&#x2F;usr&#x2F;local&#x2F;opt&#x2F;php56-mongo&#x2F;mongo.so</span><br><span class="line">    </span><br><span class="line">b、ubuntu 安装 php mongo模块的支持</span><br><span class="line"></span><br><span class="line">#  cd root &amp;&amp; wget https:&#x2F;&#x2F;github.com&#x2F;mongodb&#x2F;mongo-php-driver-legacy&#x2F;archive&#x2F;master.zip</span><br><span class="line">#  cd root &amp;&amp; unzip master.zip </span><br><span class="line">#  cd &#x2F;root&#x2F;mongo-php-driver-legacy-master&#x2F;</span><br><span class="line">#  phpize</span><br><span class="line">#  .&#x2F;configure </span><br><span class="line">#  make</span><br><span class="line">#  make install</span><br><span class="line">#  ls &#x2F;usr&#x2F;lib&#x2F;php5&#x2F;20121212&#x2F;mongo.so </span><br><span class="line"># vim &#x2F;etc&#x2F;php5&#x2F;apache2&#x2F;php.ini</span><br><span class="line">extension &#x3D; &#x2F;usr&#x2F;lib&#x2F;php5&#x2F;20121212&#x2F;mongo.so</span><br><span class="line">#  apachectl restart</span><br><span class="line">测试</span><br><span class="line"></span><br><span class="line">➜ cat index.php </span><br><span class="line">&lt;?php</span><br><span class="line">    $m &#x3D; new MongoClient(&#39;mongodb:&#x2F;&#x2F;admin:passwdxxxxxxxxxxx@47.92.162.27:20911&#x2F;bc_ccc&#39;);</span><br><span class="line">    echo &quot;Connection to database successfully&quot;;  </span><br><span class="line">    &#x2F;&#x2F; 选择一个数据库  </span><br><span class="line">  $db &#x3D; $m-&gt;bc_ccc;  </span><br><span class="line">   echo &quot;Database mydb selected&quot;;  </span><br><span class="line">?&gt;  </span><br><span class="line"></span><br><span class="line">➜  cat test2.php </span><br><span class="line">&lt;?php </span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"># 访问test2.php可以过滤到以下内容</span><br><span class="line">MONGODB-CR  enabled</span><br><span class="line">SCRAM-SHA-1 enabled</span><br><span class="line">MONGODB-X509    enabled</span><br><span class="line">GSSAPI (Kerberos)   disabled</span><br><span class="line">PLAIN   disabled</span><br></pre></td></tr></table></figure>
<p>6、注意白名单配置，让线上的服务器可以访问;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net:</span><br><span class="line">  port &#x3D;20133   # 配置mongo监听地址</span><br><span class="line">  bind_ip &#x3D;0.0.0.0  # 配置绑定的IP</span><br></pre></td></tr></table></figure>
<p>7、 注意配置文件中开启auth认证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">auth &#x3D;true</span><br></pre></td></tr></table></figure>
<p>8、代码中不支持带有@的密码</p>
<h2 id="mysql服务配置项"><a href="#mysql服务配置项" class="headerlink" title="mysql服务配置项"></a>mysql服务配置项</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 注意清空连接mysql的使用记录</span><br><span class="line"># 注意数据库的备份文件所在的服务器只能以密钥登录</span><br><span class="line"># 注意RDS的使用率</span><br></pre></td></tr></table></figure>
<h2 id="apache服务配置项"><a href="#apache服务配置项" class="headerlink" title="apache服务配置项"></a>apache服务配置项</h2><p>1、apache全局配置项</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Mutex file:$&#123;APACHE_LOCK_DIR&#125; default</span><br><span class="line">PidFile $&#123;APACHE_PID_FILE&#125;</span><br><span class="line">Timeout 300</span><br><span class="line">KeepAlive On</span><br><span class="line">MaxKeepAliveRequests 100</span><br><span class="line">KeepAliveTimeout 5</span><br><span class="line">User $&#123;APACHE_RUN_USER&#125;</span><br><span class="line">Group $&#123;APACHE_RUN_GROUP&#125;</span><br><span class="line"></span><br><span class="line"># 使得主机名能被记入日志</span><br><span class="line">HostnameLookups Off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log</span><br><span class="line"></span><br><span class="line"># 定义apache记录日志的级别为warn</span><br><span class="line">LogLevel warn</span><br><span class="line"></span><br><span class="line">#加载模块配置文件，虚拟主机配置文件，与端配置文件</span><br><span class="line">IncludeOptional mods-enabled&#x2F;*.load</span><br><span class="line">IncludeOptional mods-enabled&#x2F;*.conf</span><br><span class="line">Include ports.conf</span><br><span class="line"></span><br><span class="line"># 定义不允许访问站点根目录索引</span><br><span class="line">&lt;Directory &#x2F;&gt;</span><br><span class="line">	Options FollowSymLinks</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all denied</span><br><span class="line">&lt;&#x2F;Directory&gt;</span><br><span class="line">&lt;Directory &#x2F;usr&#x2F;share&gt;</span><br><span class="line">	AllowOverride None</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;&#x2F;Directory&gt;</span><br><span class="line"></span><br><span class="line"># 允许在&#x2F;var&#x2F;www&#x2F;中建立url</span><br><span class="line">&lt;Directory &#x2F;var&#x2F;www&#x2F;&gt;</span><br><span class="line">	AllowOverride All</span><br><span class="line">	Require all granted</span><br><span class="line">&lt;&#x2F;Directory&gt;</span><br><span class="line"></span><br><span class="line"># 定义允许访问的用户， .htaccess定义了用户名</span><br><span class="line">AccessFileName .htaccess</span><br><span class="line"></span><br><span class="line"># 拒绝所以 任意以.ht后缀结尾的文件 </span><br><span class="line">&lt;FilesMatch &quot;^\.ht&quot;&gt;</span><br><span class="line">	Require all denied</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br><span class="line"></span><br><span class="line"># 定义 vhost_combined combined comman referer的四种日志格式,供虚拟主机调用</span><br><span class="line">LogFormat &quot;%v:%p %h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; vhost_combined</span><br><span class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</span><br><span class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O&quot; common</span><br><span class="line">LogFormat &quot;%&#123;Referer&#125;i -&gt; %U&quot; referer</span><br><span class="line">LogFormat &quot;%&#123;User-agent&#125;i&quot; agent</span><br><span class="line">IncludeOptional conf-enabled&#x2F;*.conf</span><br><span class="line">IncludeOptional sites-enabled&#x2F;*.conf</span><br></pre></td></tr></table></figure>
<p>2、apache虚拟主机配置项</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 指定 VirtualHost 以端口进行定义</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8001&gt;</span><br><span class="line"></span><br><span class="line"># 指定VirtualHost域名</span><br><span class="line">	ServerAdmin www.ssjinyao.com.com</span><br><span class="line"></span><br><span class="line"># 指定虚拟主机url根路径</span><br><span class="line">	DocumentRoot &#x2F;var&#x2F;www&#x2F;html&#x2F;tweb</span><br><span class="line"></span><br><span class="line"># 指定访问错误日志保路径</span><br><span class="line">	ErrorLog $&#123;APACHE_LOG_DIR&#125;&#x2F;error.log</span><br><span class="line"></span><br><span class="line"># 指定访问日志保存路径	</span><br><span class="line">	CustomLog $&#123;APACHE_LOG_DIR&#125;&#x2F;access.log combined</span><br><span class="line">&lt;&#x2F;VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p>3、同nginx一样，做完变更之后需要先测试语法再重读，或重起</p>
<p>4、端口配置文件 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 将虚拟主机中所用到的对应端口启动; </span><br><span class="line"># Listen 80</span><br><span class="line">Listen 8001</span><br><span class="line">Listen 8002</span><br><span class="line">Listen 8003</span><br><span class="line">Listen 8004</span><br><span class="line">Listen 8101</span><br></pre></td></tr></table></figure>
<h2 id="supvisord-服务配置项"><a href="#supvisord-服务配置项" class="headerlink" title="supvisord 服务配置项"></a>supvisord 服务配置项</h2><p>1、更换服务器之后，需要修改服务器的监听地址；</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 部署监听端口的问题</span><br><span class="line">[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line">port&#x3D;172.17.xxx.xxx:7558        ; (ip_address:port specifier, *:port for all iface)</span><br></pre></td></tr></table></figure>
<p>2、部署python系统时报依赖问题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;admin&#x2F;xbasement&#x2F;</span><br><span class="line">source .&#x2F;ENV&#x2F;bin&#x2F;activate</span><br><span class="line">pip install -r requirements.txt </span><br><span class="line">如果安装软件包存在问题，把对应的软件包给删除; </span><br></pre></td></tr></table></figure>
<p>3、查看对应服务器启动时的报错 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin@iZ2zegjb9m90kxovynpkbzZ:~$ tail -f ~&#x2F;xbasement&#x2F;log&#x2F;xbasement-server-stdout.log </span><br><span class="line">  File &quot;server.py&quot;, line 3, in &lt;module&gt;</span><br><span class="line">    from tornado.wsgi import WSGIContainer</span><br><span class="line">ImportError: No module named tornado.wsgiTraceback (most recent call last):</span><br><span class="line">  File &quot;server.py&quot;, line 3, in &lt;module&gt;</span><br><span class="line">    from tornado.wsgi import WSGIContainer</span><br><span class="line">ImportError: No module named tornado.wsgi</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;server.py&quot;, line 3, in &lt;module&gt;</span><br><span class="line">    from tornado.wsgi import WSGIContainer</span><br><span class="line">ImportError: No module named tornado.wsgi</span><br></pre></td></tr></table></figure>
<p>4、python部署时缺少模块的问题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 问题如下</span><br><span class="line">supervisor&gt; status</span><br><span class="line">customer:customer-0              RUNNING   pid 7981, uptime 0:00:19</span><br><span class="line">customer:job-recieve-0           RUNNING   pid 7980, uptime 0:00:19</span><br><span class="line">order:api-0                      FATAL     Exited too quickly (process log may have details)</span><br><span class="line">order:forward-job-0              FATAL     Exited too quickly (process log may have details)</span><br><span class="line">order:order-job-payment-0        FATAL     Exited too quickly (process log may have details)</span><br><span class="line">order:order-risk-job-0           FATAL     Exited too quickly (process log may have details)</span><br><span class="line">supervisor&gt; staus</span><br><span class="line">*** Unknown syntax: staus</span><br><span class="line">supervisor&gt; </span><br><span class="line">admin@ssjinyao.com-007:~&#x2F;torder&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages$ !tail</span><br><span class="line">tail -f torder&#x2F;log&#x2F;order-api-out.log </span><br><span class="line">    from api import app</span><br><span class="line">ImportError: No module named api</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;api&#x2F;server.py&quot;, line 10, in &lt;module&gt;</span><br><span class="line">    from api import app</span><br><span class="line">ImportError: No module named api</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;api&#x2F;server.py&quot;, line 10, in &lt;module&gt;</span><br><span class="line">    from api import app</span><br><span class="line">ImportError: No module named api</span><br><span class="line"># 解决方式 </span><br><span class="line">admin@ssjinyao.com-007:~&#x2F;torder&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages$ cat v.pth </span><br><span class="line">&#x2F;home&#x2F;admin&#x2F;torder</span><br><span class="line">admin@ssjinyao.com-007:~&#x2F;torder&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages$ pwd</span><br><span class="line">&#x2F;home&#x2F;admin&#x2F;torder&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages</span><br><span class="line">admin@ssjinyao.com-007:~&#x2F;torder&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages$ history | grep ln </span><br><span class="line">ln -s &#x2F;home&#x2F;admin&#x2F;torder&#x2F; .</span><br></pre></td></tr></table></figure>
<p>5、加入新工程时，要复制编辑~/opt/supervisord.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[include]</span><br><span class="line">files &#x3D; &#x2F;home&#x2F;admin&#x2F;xbasement&#x2F;config&#x2F;supervisor&#x2F;xbasement.server.ini &#x2F;home&#x2F;admin&#x2F;topen&#x2F;config&#x2F;supervisor&#x2F;*.ini &#x2F;home&#x2F;admin&#x2F;cashier&#x2F;config&#x2F;supervisor&#x2F;*.ini</span><br></pre></td></tr></table></figure>
<p>6、部署open 工程时，要把ssl也复制上<br>7、应用变动时，要注意mongo,redis白名单</p>
<h2 id="zabbix-配置"><a href="#zabbix-配置" class="headerlink" title="zabbix 配置"></a>zabbix 配置</h2><p>1、zabbix_agent 配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 进程的pid保存的配置</span><br><span class="line">PidFile&#x3D;&#x2F;tmp&#x2F;zabbix_agentd.pid</span><br><span class="line"></span><br><span class="line"># zabbix_agent 端日志保存位置 </span><br><span class="line">LogFile&#x3D;&#x2F;var&#x2F;log&#x2F;zabbix-agent&#x2F;zabbix_agentd.log</span><br><span class="line"></span><br><span class="line"># 日志文件存储大小 </span><br><span class="line">LogFileSize&#x3D;33</span><br><span class="line"></span><br><span class="line"># 日志级别</span><br><span class="line">DebugLevel&#x3D;4</span><br><span class="line"></span><br><span class="line"># 注:这个是重点，需要指定zabbix_server端的ip zabbix_server端才能实别</span><br><span class="line">Server&#x3D;121.xxx.xx.xxx</span><br><span class="line"></span><br><span class="line"># 监听的端口</span><br><span class="line">ListenPort&#x3D;10050</span><br><span class="line"></span><br><span class="line"># zabbix_agent 端进程监听的地址 </span><br><span class="line">ListenIP&#x3D;0.0.0.0</span><br><span class="line"></span><br><span class="line"># zabbix_agent 主动请求服务端时的地址 与 Server配合使用</span><br><span class="line">ServerActive&#x3D;121.xxx.xx.xxx</span><br><span class="line">Hostname&#x3D;te_server</span><br></pre></td></tr></table></figure>
<p>2、 zabbix_server 端配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 指定zabbix_server 端监听的地址</span><br><span class="line">ListenPort&#x3D;10051</span><br><span class="line"></span><br><span class="line"># 指定zabbix_server 产生的日志所保存的文件位置 </span><br><span class="line">LogFile&#x3D;&#x2F;var&#x2F;log&#x2F;zabbixsrv&#x2F;zabbix_server.log</span><br><span class="line"></span><br><span class="line"># 指定日志的大小</span><br><span class="line">LogFileSize&#x3D;0</span><br><span class="line"></span><br><span class="line"># 指定zabbix_server PidFile所保存的位置</span><br><span class="line">PidFile&#x3D;&#x2F;var&#x2F;run&#x2F;zabbixsrv&#x2F;zabbix_server.pid</span><br><span class="line"></span><br><span class="line"># 指定zabbix 调用的数据库库名</span><br><span class="line">DBName&#x3D;zabbix</span><br><span class="line"></span><br><span class="line"># 指定zabbix 调用的数据库的用户名 </span><br><span class="line">DBUser&#x3D;zabbix</span><br><span class="line"></span><br><span class="line"># 指定zabbix 使用的数据库密码</span><br><span class="line">DBPassword&#x3D;centos.xxxxxxxx</span><br><span class="line"></span><br><span class="line"># 指定mysql的sock文件</span><br><span class="line">DBSocket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line"></span><br><span class="line"># 指定mysql所监听的端口，注，zabbix_server所占用的数据库不大，且只需要监听本地</span><br><span class="line">DBPort&#x3D;3306</span><br><span class="line"></span><br><span class="line"># 指定zabbix_server 所监听的地址</span><br><span class="line">ListenIP&#x3D;0.0.0.0</span><br><span class="line"></span><br><span class="line"># 指定供zabbix调用的脚本程序(bash || python || perl),目前使用的是bash</span><br><span class="line">AlertScriptsPath&#x3D;&#x2F;var&#x2F;lib&#x2F;zabbixsrv&#x2F;alertscripts</span><br><span class="line"></span><br><span class="line"># 自定义监控项时的保存位置 </span><br><span class="line">ExternalScripts&#x3D;&#x2F;var&#x2F;lib&#x2F;zabbixsrv&#x2F;externalscripts</span><br><span class="line"></span><br><span class="line"># 指定临时的脚本程序 </span><br><span class="line">TmpDir&#x3D;&#x2F;var&#x2F;lib&#x2F;zabbixsrv&#x2F;tmp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 调用接口程序</span><br><span class="line"></span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin</span><br><span class="line">echo &quot;$2</span><br><span class="line">$3&quot; | &#x2F;usr&#x2F;bin&#x2F;mutt -s &quot;ZABBIX 报警&quot; $1</span><br><span class="line"></span><br><span class="line">zabbix.sh </span><br><span class="line"></span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#Can send weixin mail </span><br><span class="line">export path&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin</span><br><span class="line">#&#x2F;bin&#x2F;weixin --corpid&#x3D;ww3bba6a2898b91e69 --corpsecret&#x3D;3GqhGNZeEYuVvr9SRSyBWCOsbGvNcc6LXAn0uCO24XM --msg&#x3D;&quot;$2         $3&quot; --user&#x3D;&quot;$1&quot; --agentid&#x3D;1000002</span><br><span class="line">&#x2F;bin&#x2F;weixin --corpid&#x3D;wwfc47b4739f369c7c --corpsecret&#x3D;hD0ITPFehD8WJm-3ydJVxWamXQYs2l64xPCx9K76doM --msg&#x3D;&quot;$2</span><br><span class="line">$3&quot; --user&#x3D;$1 --agentid&#x3D;1000003</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 安装发送邮件报警程序的依赖</span><br><span class="line"># yum -y install msmtp mutt</span><br><span class="line"></span><br><span class="line"># 邮件发是由系统用户zabbixsrv调用，所以配置文件要在公共配置目录&#x2F;etc&#x2F;中配置</span><br><span class="line"># 不可以在 admin&#x2F;root 或者其它用户下配置</span><br><span class="line"># muttrc  配置项</span><br><span class="line">&#x2F;etc&#x2F;muttrc </span><br><span class="line">set sendmail&#x3D;&quot;&#x2F;usr&#x2F;bin&#x2F;msmtp&quot;</span><br><span class="line">set use_from&#x3D;yes</span><br><span class="line">set realname&#x3D;&quot;15822097176@139.com&quot;</span><br><span class="line">set editor&#x3D;&quot;vim&quot;</span><br><span class="line"></span><br><span class="line"># msmtprc 配置项</span><br><span class="line">&#x2F;etc&#x2F;msmtprc </span><br><span class="line">account default</span><br><span class="line">host smtp.ssjinyao.com</span><br><span class="line">port 25</span><br><span class="line">from dev@ssjinyao.com</span><br><span class="line">auth login</span><br><span class="line">tls off</span><br><span class="line">user dev@ssjinyao.com</span><br><span class="line">password xxxxxxxxxx</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">需求, 代码要一条条的写 </span><br><span class="line">设计, 先实现再设计优化</span><br></pre></td></tr></table></figure>
<h2 id="线上ssh服务配置项"><a href="#线上ssh服务配置项" class="headerlink" title="线上ssh服务配置项"></a>线上ssh服务配置项</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 指定ssh默认监听的地址</span><br><span class="line">Port 22</span><br><span class="line"></span><br><span class="line"># 指定ssh使用的协议</span><br><span class="line">Protocol 2</span><br><span class="line"></span><br><span class="line"># 指定当前服务器使用的私钥</span><br><span class="line">HostKey &#x2F;etc&#x2F;ssh&#x2F;ssh_host_rsa_key</span><br><span class="line">HostKey &#x2F;etc&#x2F;ssh&#x2F;ssh_host_dsa_key</span><br><span class="line">HostKey &#x2F;etc&#x2F;ssh&#x2F;ssh_host_ecdsa_key</span><br><span class="line">HostKey &#x2F;etc&#x2F;ssh&#x2F;ssh_host_ed25519_key</span><br><span class="line"></span><br><span class="line"># 是否让sshd通过创建非特权子进程处理接入请求的方法来进行权限分离。默认值是&quot;yes&quot;。认证成功后，将以该认证用户的身份创建另一个子进程。这样做的目的是为了防止通过有缺陷的子进程提升权限，从而使系统更加安全</span><br><span class="line">UsePrivilegeSeparation yes</span><br><span class="line"></span><br><span class="line"># 设置在多少秒之后自动重新生成服务器的密匙（如果使用密匙）。重新生成密匙是为了防止用盗用的密匙解密被截获的信息。</span><br><span class="line">KeyRegenerationInterval 3600</span><br><span class="line"></span><br><span class="line"># Server Key 的加密码强度，强度越大越安全，传输速率也越慢</span><br><span class="line">ServerKeyBits 1024</span><br><span class="line"></span><br><span class="line"># sshd 记录日志的级别 </span><br><span class="line">LogLevel INFO</span><br><span class="line"></span><br><span class="line"># 用户登录时可视界面及时间</span><br><span class="line">LoginGraceTime 120</span><br><span class="line"></span><br><span class="line"># 当使用者的 host key 改变之后，Server 就不接受联机，</span><br><span class="line">StrictModes yes</span><br><span class="line"></span><br><span class="line"># 使用纯rsa认证方式</span><br><span class="line">RSAAuthentication yes</span><br><span class="line"></span><br><span class="line"># 是否允许pubkey认证</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"></span><br><span class="line"># 是否取消使用 ~&#x2F;.ssh&#x2F;.hosts 来做为认证</span><br><span class="line">IgnoreRhosts yes</span><br><span class="line"></span><br><span class="line"># 这个选项是专门给 version 1 用的</span><br><span class="line">RhostsRSAAuthentication no</span><br><span class="line"></span><br><span class="line"># 这个项目与上面的项目类似，不过是给 version 2 使用的</span><br><span class="line">HostbasedAuthentication no</span><br><span class="line"></span><br><span class="line">#这个项目在是否允许以空的密码登入！# 此项要注意</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line"></span><br><span class="line"># 挑战任何的密码认证, 任何 login.conf都能使用 </span><br><span class="line">ChallengeResponseAuthentication no</span><br><span class="line"></span><br><span class="line"># x11转发功能开启，可以使用基于ssh的加密码图形工具</span><br><span class="line">X11Forwarding yes</span><br><span class="line"></span><br><span class="line"># 自适大小</span><br><span class="line">X11DisplayOffset 10</span><br><span class="line"></span><br><span class="line"># 打印Motd信息</span><br><span class="line">PrintMotd no</span><br><span class="line"></span><br><span class="line"># 登录前后输出日志</span><br><span class="line">PrintLastLog yes</span><br><span class="line"></span><br><span class="line"># 开启tcp长连接</span><br><span class="line">TCPKeepAlive yes</span><br><span class="line"></span><br><span class="line"># 设置x11的转输语言及编码</span><br><span class="line">AcceptEnv LANG LC_*</span><br><span class="line"></span><br><span class="line"># 基于ssh 的vftp服务</span><br><span class="line">Subsystem sftp &#x2F;usr&#x2F;lib&#x2F;openssh&#x2F;sftp-server</span><br><span class="line"></span><br><span class="line">#利用 PAM 管理使用者认证</span><br><span class="line">UsePAM yes</span><br><span class="line"></span><br><span class="line">#使用dns解析 </span><br><span class="line">UseDNS no</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">AddressFamily inet</span><br><span class="line"></span><br><span class="line"># 允许root用户直接登录 </span><br><span class="line">PermitRootLogin yes</span><br><span class="line"></span><br><span class="line"># 记录系统日志</span><br><span class="line">SyslogFacility AUTHPRIV</span><br><span class="line"></span><br><span class="line"># 开启用户认证登录</span><br><span class="line">PasswordAuthentication yes</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>linux 系统定制</title>
    <url>/2018/09/01/linux%E7%B3%BB%E7%BB%9F%E5%AE%9A%E5%88%B6/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="linux系统与应用定制"><a href="#linux系统与应用定制" class="headerlink" title="linux系统与应用定制"></a>linux系统与应用定制</h1><p>linux 系统层面工作原结构<br><img src="/images/linux-kernel.png" class="lazyload" data-srcset="/images/linux-kernel.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="必需要熟悉系统启动流程"><a href="#必需要熟悉系统启动流程" class="headerlink" title="必需要熟悉系统启动流程"></a>必需要熟悉系统启动流程</h2><blockquote>
<p>CentOS 6 系统启动流程</p>
</blockquote>
<p><img src="/images/kernerl-boot-statg-ce6.png" class="lazyload" data-srcset="/images/kernerl-boot-statg-ce6.png" srcset="data:image/png;base64,666" alt=""></p>
<blockquote>
<p>CentOS 7 系统启动流程</p>
</blockquote>
<p><img src="/images/kernel-boot-statg-ce7.jpg" class="lazyload" data-srcset="/images/kernel-boot-statg-ce7.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><table>
<thead>
<tr>
<th>服务器</th>
<th>系统环境</th>
<th>主机名</th>
<th>内核版本</th>
<th>必装环境</th>
</tr>
</thead>
<tbody>
<tr>
<td>宿主机</td>
<td>CentOS 6.9</td>
<td>Node11</td>
<td>Kernel 2.6.32-696.el6.x86_64</td>
<td>Development Tools</td>
</tr>
<tr>
<td>制作机</td>
<td>ssjinyao  Linux</td>
<td>Node21</td>
<td>Kernel linux-4.18.4</td>
<td>Busybox 1.29</td>
</tr>
</tbody>
</table>
<p>将下载的包上传到服务器中 </p>
<p><img src="/images/kernel-org.png" class="lazyload" data-srcset="/images/kernel-org.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/busybox-dowland.png" class="lazyload" data-srcset="/images/busybox-dowland.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~ ➤ scp ~&#x2F;Downloads&#x2F;linux-4.18.4.tar.xz root@node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;                                                                                                                          </span><br><span class="line">~ ➤ scp ~&#x2F;Downloads&#x2F;busybox-1.29.2.tar.bz2 root@node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br></pre></td></tr></table></figure>
<p>安装宿主机所需要编译环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:~]# yum groupinstall &quot;Development tools&quot; &quot;Desktop Platform Development&quot; -y</span><br></pre></td></tr></table></figure>
<h2 id="内核编译"><a href="#内核编译" class="headerlink" title="内核编译"></a>内核编译</h2><h3 id="解压文件"><a href="#解压文件" class="headerlink" title="解压文件"></a>解压文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:~]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">[root@ssjinyao-node11:~]# ln -s linux-4.18.4 linux</span><br><span class="line">[root@ssjinyao-node11:~]# cd linux</span><br><span class="line">[root@ssjinyao-node11:~]# make help   # 查看make帮助</span><br><span class="line"># 如果在centos不能解压时，需要执行</span><br><span class="line"># yum -y install xz 因为在CentOS 6 的环境中 tar 解压xz文件调用的是xz命令</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:/usr/<span class="built_in">local</span>/src/linux]<span class="comment"># make allnoconfig</span></span><br><span class="line"><span class="comment"># 把原默认配置都清空，根据我们的需要选则编译</span></span><br><span class="line">[root@ssjinyao-node11:/usr/<span class="built_in">local</span>/src/linux]<span class="comment"># make menuconfig</span></span><br><span class="line"><span class="comment"># 根据自己的需求，选则内核需要支持模块 </span></span><br></pre></td></tr></table></figure>
<h3 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h3><p><img src="/images/kernel-org-make-menuconfig.png" class="lazyload" data-srcset="/images/kernel-org-make-menuconfig.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><p><img src="/images/kernel-config-all.png" class="lazyload" data-srcset="/images/kernel-config-all.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="kernel-config-general-setup"><a href="#kernel-config-general-setup" class="headerlink" title="kernel-config-general-setup"></a>kernel-config-general-setup</h3><p><img src="/images/kernel-config-generalsetup.png" class="lazyload" data-srcset="/images/kernel-config-generalsetup.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="kernel-config-enable-loadble-module"><a href="#kernel-config-enable-loadble-module" class="headerlink" title="kernel-config-enable-loadble-module"></a>kernel-config-enable-loadble-module</h3><p><img src="/images/kernel-config-enable-loadble-module.png" class="lazyload" data-srcset="/images/kernel-config-enable-loadble-module.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="kernel-config-device-drivers"><a href="#kernel-config-device-drivers" class="headerlink" title="kernel-config-device-drivers"></a>kernel-config-device-drivers</h3><p><img src="/images/kernel-config-device-drivers.png" class="lazyload" data-srcset="/images/kernel-config-device-drivers.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="kernel-config-file-systems"><a href="#kernel-config-file-systems" class="headerlink" title="kernel-config-file-systems"></a>kernel-config-file-systems</h3><p><img src="/images/kernel-config-file-systems.png" class="lazyload" data-srcset="/images/kernel-config-file-systems.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="详细配置与操作过程如下"><a href="#详细配置与操作过程如下" class="headerlink" title="详细配置与操作过程如下"></a>详细配置与操作过程如下</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">* 启用 <span class="number">64</span>-bit kernel # 让内核支持 <span class="number">64</span>位架构</span><br><span class="line">* 启用 Enable loadable <span class="keyword">module</span> support # 支持内核模块装载</span><br><span class="line">* 点进 Enable loadable <span class="keyword">module</span> support --&gt;  Module unloading # 让内核支持动态装卸载</span><br><span class="line">* 点进 Enable loadable <span class="keyword">module</span> support --&gt; Module signature verification </span><br><span class="line">        # 让内核校验装载的模块是否是已经认证的公司，避免内核被污染，以确保内核层面的安全</span><br><span class="line">* 点进 Processor type and features --&gt; processor family(Generic-x86-64) ---&gt; Generic-x86-64  </span><br><span class="line">        # 支持通用cpu，当然也可以对应选则适合自己的</span><br><span class="line">* 点进 Processor type <span class="keyword">and</span> features --&gt; Symmetric multi-processing support  </span><br><span class="line">        # 支持多核cpu</span><br><span class="line">* 点进 Bus options (PCI etc.) --&gt; PCI support # 选中支持</span><br><span class="line">* 启用 Enable the block layer  # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; SCSI device support  # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; SCSI disk support # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Fusion MPT device support（启用） ---&gt; Fusion MPT ScsiHost drivers <span class="keyword">for</span> SPI # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Fusion MPT device support（启用） ---&gt; Fusion MPT ScsiHost drivers <span class="keyword">for</span> SAS # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Fusion MPT device support（启用） ---&gt; Fusion MPT misc device (ioctl) driver # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Fusion MPT device support（启用） ---&gt; Fusion MPT logging facility # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Input device support   ---&gt; Keyboards (NEW) (启用 ) ----&gt;  &lt;*&gt;   AT keyboard (NEW) # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; Input device support ---&gt;  Mouse interface # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Input device support ---&gt; Provide legacy /dev/psaux device # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; USB support  ---&gt; Support <span class="keyword">for</span> Host-side USB # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt; Enable USB persist by default (NEW) # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt; xHCI HCD (USB 3.0) support # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt;  Generic xHCI driver <span class="keyword">for</span> a platform device # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt; EHCI HCD (USB 2.0) support # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt; Root Hub Transaction Translators # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt; Improved Transaction Translator scheduling (NEW) # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt;  OHCI HCD (USB 1.1) support # 选中支持 </span><br><span class="line">* 点进 Device Drivers --&gt; USB support ---&gt; OHCI support for PCI-bus USB controllers (NEW) # 选中支持 </span><br><span class="line">* 点进 Device Drivers  --&gt; Generic Driver Options  ---&gt; Maintain a devtmpfs filesystem to mount at /dev # 选中支持</span><br><span class="line">* 点进 Device Drivers --&gt; Generic Driver Options ---&gt; Automount devtmpfs at /dev, after the kernel mounted the rootfs # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; Second extended fs support # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; Ext2 extended attributes # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; Ext2 POSIX Access Control Lists # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; Ext2 Security Labels # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; The Extended <span class="number">3</span> (ext3) filesystem # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; Ext3 POSIX Access Control Lists # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; Ext3 Security Labels  # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; The Extended <span class="number">4</span> (ext4) filesystem # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; Ext4 POSIX Access Control Lists # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; Ext4 Security Labels # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; Ext4 Encryption #  选中支持 </span><br><span class="line">* 点进 File systems  --&gt; XFS filesystem support # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; XFS Quota support # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; XFS POSIX ACL support # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; XFS Realtime subvolume support # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; XFS online metadata check support # 选中支持 </span><br><span class="line">* 点进 File systems  --&gt; XFS online metadata repair support # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; XFS Debugging support # 选中支持</span><br><span class="line">* 点进 File systems  --&gt; XFS fatal asserts (NEW) # 选中支持 </span><br><span class="line"># 注：这里选择文件系统时可以选择自己常用的一种就好，我这里为方便以后使用，都加入进去了</span><br><span class="line"># 一般xfs 文件系统类型是目前性能最好的文件系统，而ext3 ext4 则有较成熟的数据恢复技术，如ext3grep</span><br><span class="line">* 点进 Executable file formats / Emulations  --&gt; Kernel support <span class="keyword">for</span> ELF binaries # 选中支持</span><br><span class="line">* 点进 Executable file formats / Emulations  --&gt;  Kernel support <span class="keyword">for</span> scripts starting with #! # 选中支持，即文件系统shell支持机制 </span><br><span class="line">* 点进 Executable file formats / Emulations  --&gt;  Kernel support <span class="keyword">for</span> MISC binaries # 选中支持</span><br><span class="line">* Networking support (启用) --&gt; Networking options  ---&gt;  TCP/IP networking # 选中支持，为以后做实验或者使用方便。将TCP/IP networking 下面的核心项即tcp/ip 与devel项安装</span><br><span class="line">* Device Drivers  --&gt; Network device support  ---&gt; Ethernet driver support (NEW)  ----&gt; (启用) ----&gt; Intel devices (NEW)(启用) -----&gt;  Intel(R) PRO/1000 Gigabit </span><br><span class="line">* * Device Drivers  --&gt; Network device support  ---&gt; Ethernet driver support (NEW)  ----&gt; (启用) ----&gt; AMD devices(启用) -----&gt;  AMD相关的我这里全部勾选 </span><br><span class="line">Ethernet support # 添加模块  , 其它的所有 Ethernet driver support 可以取消，依据自己的需求选则</span><br><span class="line">* 点进 General setup  --&gt; (huatu-ssjinyao-kernel) Local version - append to kernel release # 点加Kernel release </span><br><span class="line">* 点进 General setup --&gt; (huatu-ssjinyao) Default hostname </span><br></pre></td></tr></table></figure>
<p>编译内核是个比较复杂的过程，这里的大家如果一直编译不成功，或者编译完内核后不有成功启动系统<br>可以使用我这里给大家建立的模板</p>
<p><a href="https://www.ssjinyao.com/images/kernel-config-ok-net-all-ok">建立可以使用的内核配置模板</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cp kernel-config-ok-net-all-ok &#x2F;usr&#x2F;local&#x2F;src&#x2F;linux&#x2F;.config # 可以使用这个模板来进行编译生成内核文件 </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:/usr/local/src/linux-4.18.4]# cat init/main.c | grep -C 8 &#x27; !try_to_run_init_process(&quot;/etc/init&quot;)&#x27;</span><br><span class="line">	<span class="keyword">if</span> (execute_command) &#123;</span><br><span class="line">		ret = run_init_process(execute_command);</span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		panic(<span class="string">&quot;Requested init %s failed (error %d).&quot;</span>,</span><br><span class="line">		      execute_command, ret);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!try_to_run_init_process(<span class="string">&quot;/sbin/init&quot;</span>) ||</span><br><span class="line">	    !try_to_run_init_process(<span class="string">&quot;/etc/init&quot;</span>) ||</span><br><span class="line">	    !try_to_run_init_process(<span class="string">&quot;/bin/init&quot;</span>) ||</span><br><span class="line">	    !try_to_run_init_process(<span class="string">&quot;/bin/sh&quot;</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	panic(<span class="string">&quot;No working init found.  Try passing init= option to kernel. &quot;</span></span><br><span class="line">	      <span class="string">&quot;See Linux Documentation/admin-guide/init.rst for guidance.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ssjinyao-node11:/usr/local/src/linux<span class="number">-4.18</span><span class="number">.4</span>]<span class="meta"># pwd</span></span><br><span class="line">/usr/local/src/linux<span class="number">-4.18</span><span class="number">.4</span></span><br><span class="line"># 注: 通过查看这段内核源码，则可以看到系统启动时查到init的流程</span><br><span class="line">  先找 /sbin/init --&gt; 若不存在</span><br><span class="line">  再找 /etc/init --&gt; 若不存在</span><br><span class="line">  再找 /bin/init --&gt; 若不存在</span><br><span class="line">  再找 /bin/sh   --&gt; 若不存在</span><br><span class="line">  启动报内核恐慌</span><br><span class="line">当然也可以在grub 的配置文件中指定 init= 来指定init的位置  </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;linux]# make -j 4 bzImage</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;linux]# du -sh arch&#x2F;x86&#x2F;boot&#x2F;bzImage</span><br><span class="line">3.0M	arch&#x2F;x86&#x2F;boot&#x2F;bzImage</span><br></pre></td></tr></table></figure>
<h3 id="编译单个网卡模块"><a href="#编译单个网卡模块" class="headerlink" title="编译单个网卡模块"></a>编译单个网卡模块</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;linux]# ls drivers&#x2F;net&#x2F;ethernet&#x2F;intel&#x2F;e1000&#x2F;</span><br><span class="line">e1000_ethtool.c  e1000.h  e1000_hw.c  e1000_hw.h  e1000_main.c  e1000_osdep.h  e1000_param.c  Makefile</span><br><span class="line">root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;linux]# ls drivers&#x2F;net&#x2F;ethernet&#x2F;intel&#x2F;e1000&#x2F;e1000.ko</span><br><span class="line">drivers&#x2F;net&#x2F;ethernet&#x2F;intel&#x2F;e1000&#x2F;e1000.ko</span><br><span class="line"># insmod &#x2F;lib64&#x2F;modules&#x2F;e1000.ko</span><br></pre></td></tr></table></figure>
<h2 id="安装-编译安装busybox"><a href="#安装-编译安装busybox" class="headerlink" title="安装 编译安装busybox"></a>安装 编译安装busybox</h2><p>因静态编译依赖于软件包 glibc-static, 因此在编译busybox时需要安装 glibc-static</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# tar -xvf busybox-1.29.2.tar.bz2</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cd busybox-1.29.2</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# yum -y install glibc-static</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;busybox-1.29.2]# make menuconfig</span><br></pre></td></tr></table></figure>
<p><img src="/images/busybox-make.png" class="lazyload" data-srcset="/images/busybox-make.png" srcset="data:image/png;base64,666" alt=""><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Settings  --&gt;   --- Build Options  标题栏中 Build static binary (no shared libs) # 选中支持</span><br><span class="line">Settings  --&gt;    --- Installation Options (&quot;make install&quot; behavior)  What kind of applet links to install (as soft-links)  ---&gt; 这个默认的 as soft-links 就可以了 </span><br><span class="line">Settings  --&gt;    --- Installation Options (&quot;make install&quot; behavior)  (.&#x2F;_install) Destination path for &#39;make install&#39; ---&gt; 这个也选用默认的编译安装完到默认当前路径 </span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">make install # 注编译出错的时候要去了 Coreutils --&gt; sync 后面需要再同步过去</span><br></pre></td></tr></table></figure>
<h2 id="利用busybox-制作initrd"><a href="#利用busybox-制作initrd" class="headerlink" title="利用busybox 制作initrd"></a>利用busybox 制作initrd</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;busybox-1.29.2]# mkdir &#x2F;tmp&#x2F;busybox</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;busybox-1.29.2]# cp -a .&#x2F;_install&#x2F;*</span><br><span class="line">bin&#x2F;     linuxrc  sbin&#x2F;    usr&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;busybox-1.29.2]# cp -a .&#x2F;_install&#x2F;* &#x2F;tmp&#x2F;busybox&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;busybox-1.29.2]# cd &#x2F;tmp&#x2F;busybox&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]#</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# mkdir -pv  proc  sys  etc&#x2F;init.d  tmp  dev  mnt&#x2F;sysroot </span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# vim init</span><br><span class="line">#!&#x2F;bin&#x2F;ash</span><br><span class="line">echo -e &quot;\t\033[32m Now start init and switch root ! \033[0m &quot;</span><br><span class="line">mount -t proc proc &#x2F;proc</span><br><span class="line">mount -t sysfs sysfs &#x2F;sys</span><br><span class="line">mdev -s</span><br><span class="line">mount -t xfs &#x2F;dev&#x2F;sda2  &#x2F;mnt&#x2F;sysroot</span><br><span class="line">exec  switch_root  &#x2F;mnt&#x2F;sysroot  &#x2F;sbin&#x2F;init</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# chmod +x init</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# mknod  dev&#x2F;console  c  5  1</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# mknod  dev&#x2F;null  c  1  3</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# find  .  | cpio  --quiet  -H newc  -o  | gzip  -9 -n &gt; .&#x2F;huatu-ssjinyao-initrd.gz</span><br><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# du -sh huatu-ssjinyao-initrd.gz</span><br><span class="line">1.3M	huatu-ssjinyao-initrd.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="安装grub-整合内核与initrd"><a href="#安装grub-整合内核与initrd" class="headerlink" title="安装grub,整合内核与initrd"></a>安装grub,整合内核与initrd</h2><p>此时将宿主机关掉，挂载一块scsi磁盘，用于将grub,内核,initrd写嵌入<br>我这里用的是vmware fusion 虚拟工具，windows大家习惯用vmware workstation<br>只要给虚拟机添加一块磁盘即可,如下图   </p>
<p><img src="/images/vmware-fusion-add-disk.png" class="lazyload" data-srcset="/images/vmware-fusion-add-disk.png" srcset="data:image/png;base64,666" alt=""></p>
<p>注意: 现在挂载磁盘一定是要和宿主机共享磁盘，不然的话信息不会实时同步 ;<br>也是说，添加的这块磁盘是为宿主机和制作机之间同步数据使用，也就是说共用一块虚拟磁盘;<br>添加完后将宿主服务器启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:~]<span class="comment"># lsblk</span></span><br><span class="line">NAME                                 MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda                                    8:0    0   20G  0 disk</span><br><span class="line">├─sda1                                 8:1    0  500M  0 part /boot</span><br><span class="line">└─sda2                                 8:2    0 19.5G  0 part</span><br><span class="line">  ├─vg_ssjinyaonode11-lv_root (dm-0) 253:0    0 17.6G  0 lvm  /</span><br><span class="line">  └─vg_ssjinyaonode11-lv_swap (dm-1) 253:1    0    2G  0 lvm  [SWAP]</span><br><span class="line">sdb                                    8:16   0   38G  0 disk</span><br></pre></td></tr></table></figure>
<p>由上可以看出，已经添加了一块磁盘 sdb,将磁盘分区并挂载至/mnt目录下boot,与sysroot</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:~]# mkdir &#x2F;mnt&#x2F;&#123;boot,sysroot&#125;</span><br><span class="line">[root@ssjinyao-node11:~]# fdisk &#x2F;dev&#x2F;sdb</span><br><span class="line">Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</span><br><span class="line">Building a new DOS disklabel with disk identifier 0x42ed0c1e.</span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">After that, of course, the previous content won&#39;t be recoverable.</span><br><span class="line"></span><br><span class="line">Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</span><br><span class="line"></span><br><span class="line">WARNING: DOS-compatible mode is deprecated. It&#39;s strongly recommended to</span><br><span class="line">         switch off the mode (command &#39;c&#39;) and change display units to</span><br><span class="line">         sectors (command &#39;u&#39;).</span><br><span class="line"></span><br><span class="line">Command (m for help): n</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p</span><br><span class="line">Partition number (1-4): 1</span><br><span class="line">First cylinder (1-4960, default 1): 1</span><br><span class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-4960, default 4960): +300M</span><br><span class="line"></span><br><span class="line">Command (m for help): n</span><br><span class="line">Command action</span><br><span class="line">   e   extended</span><br><span class="line">   p   primary partition (1-4)</span><br><span class="line">p</span><br><span class="line">Partition number (1-4): 2</span><br><span class="line">First cylinder (40-4960, default 40): 40</span><br><span class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (40-4960, default 4960): 4960</span><br><span class="line"></span><br><span class="line">Command (m for help): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br><span class="line">[root@ssjinyao-node11:~]# mkfs.xfs &#x2F;dev&#x2F;sdb1</span><br><span class="line">[root@ssjinyao-node11:~]# mkfs.xfs &#x2F;dev&#x2F;sdb2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir &#x2F;mnt&#x2F;&#123;boot,sysroot&#125;</span><br><span class="line"># mount &#x2F;dev&#x2F;sdb1 &#x2F;mnt&#x2F;boot</span><br><span class="line"># mount &#x2F;dev&#x2F;sdb2 &#x2F;mnt&#x2F;sysroot</span><br><span class="line">[root@ssjinyao-node11:~]# mount &#x2F;dev&#x2F;sdb1 &#x2F;mnt&#x2F;boot&#x2F;</span><br><span class="line">[root@ssjinyao-node11:~]# mount &#x2F;dev&#x2F;sdb2 &#x2F;mnt&#x2F;sysroot&#x2F;</span><br><span class="line">[root@ssjinyao-node11:~]# cd &#x2F;tmp&#x2F;busybox&#x2F;</span><br></pre></td></tr></table></figure>
<p>将编译好的内核与制作好的initrd入到boot启动目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# cp huatu-ssjinyao-initrd.gz &#x2F;mnt&#x2F;boot&#x2F;</span><br><span class="line">[root@ssjinyao-node11:~]# cp &#x2F;usr&#x2F;local&#x2F;src&#x2F;linux&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage  &#x2F;mnt&#x2F;boot&#x2F;huatu-ssjinyao-kernel</span><br></pre></td></tr></table></figure>
<p>安装 grub 至新添加的硬盘 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;tmp&#x2F;busybox]# grub-install  --root-directory&#x3D;&#x2F;mnt&#x2F; &#x2F;dev&#x2F;sdb</span><br></pre></td></tr></table></figure>
<p>提供 grub 配置文件 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# vim &#x2F;mnt&#x2F;boot&#x2F;grub&#x2F;grub.conf</span><br><span class="line">default        0</span><br><span class="line">timeout        3</span><br><span class="line">color    light-green&#x2F;black light-magenta&#x2F;black</span><br><span class="line">title    huatu-ssinyao-kernel 4.18.5</span><br><span class="line">    root (hd0,0)</span><br><span class="line">    kernel &#x2F;huatu-ssjinyao-kernel ro root&#x3D;&#x2F;dev&#x2F;sda2 vga&#x3D;877 quiet</span><br><span class="line">    initrd &#x2F;huatu-ssjinyao-initrd.gz</span><br></pre></td></tr></table></figure>
<p>vga=877 这里是根据我的屏目分辨率而调整的适应的;<br>这里可以在启动 vga=ask grub开机时会给你一个列表，让你选择自己的分辨率;<br>最后可以选择自己屏幕的分辨率大小;<br><img src="/images/fenbianlv.png" class="lazyload" data-srcset="/images/fenbianlv.png" srcset="data:image/png;base64,666" alt=""></p>
<p>如，这里的我的分辨率是 1400x900，这里选的是36D，再将16进制36D转换为十进制数，即是我在grub.conf<br>中配置的vga=877</p>
<p>其它项配置项  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default  配置这个项目为0默认启动项;</span><br><span class="line">timeout  配置超过3秒不选则，则自动选则第一个title启动;</span><br><span class="line">color    配置grub菜单栏颜色;</span><br><span class="line">title    配置启动项标题;</span><br><span class="line">root (hd0,0)    配置root先识别第一块盘的第一个分区;</span><br><span class="line">kernel  配置指定启动内核，这里即是我们编译好的内核，root 指定启动后的根分区;</span><br><span class="line">initrd  配置启动虚根，与第一个进程;</span><br></pre></td></tr></table></figure>
<h2 id="建立真实文件系统"><a href="#建立真实文件系统" class="headerlink" title="建立真实文件系统"></a>建立真实文件系统</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# cp &#x2F;usr&#x2F;local&#x2F;src&#x2F;busybox-1.29.2&#x2F;_install&#x2F;*  . -a</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# rm -f linuxrc</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# mkdir -pv etc  dev proc sys bin sbin usr&#x2F;&#123;bin,sbin,lib,lib64,local&#125; lib64 lib&#x2F;modules home var&#x2F;&#123;log,run,lock&#125; tmp mnt media root boot</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# vim etc&#x2F;inittab</span><br><span class="line"># console:respawn:-&#x2F;bin&#x2F;ash</span><br><span class="line"># tty1::askfirst:&#x2F;bin&#x2F;ash</span><br><span class="line"># tty2::askfirst:&#x2F;bin&#x2F;ash</span><br><span class="line"># tty3::askfirst:&#x2F;bin&#x2F;ash</span><br><span class="line">::sysinit:&#x2F;etc&#x2F;rc.d&#x2F;rc.sysinit</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty1</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty2</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty3</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty4</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty5</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty6</span><br><span class="line">::respawn:&#x2F;sbin&#x2F;getty 9600 tty7</span><br><span class="line">::ctrlaltdel:&#x2F;sbin&#x2F;reboot</span><br><span class="line">::shutdown:&#x2F;bin&#x2F;umount -a -r &amp;&gt; &#x2F;dev&#x2F;null</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# chmod +x etc&#x2F;inittab</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#[root@ssjinyao-node11:/mnt/sysroot]# mkdir etc/rc.d/</span></span><br><span class="line"><span class="comment">#[root@ssjinyao-node11:/mnt/sysroot]# vim  etc/rc.d/rc.sysinit</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\t welcome to \033[31m HuaTu SSJinYao \033[0m Linux&quot;</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;scan /sys and to populate to /dev...&quot;</span></span><br><span class="line">mdev -s</span><br><span class="line">mount -o remount,rw  /dev/sda2 /</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mounting all filesystems...&quot;</span></span><br><span class="line">mount -a</span><br><span class="line">ifconfig eth0 10.180.66.31 netmask 255.255.255.0</span><br><span class="line">ifconfig lo 127.0.0.1</span><br><span class="line"></span><br><span class="line">route add default gw 10.180.66.2</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m Start Network Manager.........................\033[0m \033[32m [OK] \033[0m&quot;</span></span><br><span class="line">/usr/<span class="built_in">local</span>/sbin/dropbear -E -F &amp;&gt; /var/<span class="built_in">log</span>/dropbear/sshd.log &amp;</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m Start dropbear sshd ..........................\033[0m \033[32m [OK] \033[0m&quot;</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m Start Nginx Service ..........................\033[0m \033[32m [OK] \033[0m&quot;</span></span><br><span class="line">/usr/<span class="built_in">local</span>/keepalived/sbin/keepalived -D -S 0 -f /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m Start Keepalived Service .....................\033[0m \033[32m [OK] \033[0m&quot;</span></span><br><span class="line">rsync.sh &amp;&gt; /dev/null &amp;</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m Start Rsync Service ..........................\033[0m \033[32m [OK] \033[0m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m</span></span><br><span class="line"><span class="string">            \</span></span><br><span class="line"><span class="string">              - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                                 ** **</span></span><br><span class="line"><span class="string">                                // //            **   **</span></span><br><span class="line"><span class="string">               ******  ******    ** ** *******  //** **   ******    ******</span></span><br><span class="line"><span class="string">              **////  **////    /**/**//**///**  //***   //////**  **////**</span></span><br><span class="line"><span class="string">             //***** //*****    /**/** /**  /**   /**     ******* /**   /**</span></span><br><span class="line"><span class="string">              /////** /////** **/**/** /**  /**   **     **////** /**   /**</span></span><br><span class="line"><span class="string">              ******  ****** //*** /** ***  /**  **     //********//******</span></span><br><span class="line"><span class="string">             //////  //////   ///  // ///   //  //       ////////  //////</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            \\</span></span><br><span class="line"><span class="string">              - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \\</span></span><br><span class="line"><span class="string">\033[0m&quot;</span></span><br><span class="line"><span class="comment"># chmod +x etc/rc.d/rc.sysinit</span></span><br></pre></td></tr></table></figure>
<p>建系统系统挂载目录 fstab </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# mkdir &#x2F;dev&#x2F;pts</span><br><span class="line"># 注: 在此之前一定要有 dev&#x2F;pts 目录 </span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# vim etc&#x2F;fstab </span><br><span class="line">sysfs       &#x2F;sys      sysfs defaults 0 0 </span><br><span class="line">proc        &#x2F;proc     proc      defaults 0 0 </span><br><span class="line">devpts      &#x2F;dev&#x2F;pts  devpts    mode&#x3D;620 0 0 </span><br><span class="line">&#x2F;dev&#x2F;sda1   &#x2F;boot     xfs      defaults 0 0 </span><br><span class="line">&#x2F;dev&#x2F;sda2   &#x2F;         xfs      defaults 0 0 </span><br></pre></td></tr></table></figure>
<p>添加登录后脚本/etc/profile</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> PS1=<span class="string">&#x27;[\[\033[01;36m\]\u\[\033[00m\]@\[\033[01;34m\]\h\[\033[00m\]:\[\033[01;32m\]\w\[\033[00m\]]\[\033[01;34m\]\$\[\033[00m\] &#x27;</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/bin:/usr/<span class="built_in">local</span>/sbin/:/sbin:/bin:/usr/bin:/usr/sbin</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# vim etc&#x2F;shells </span><br><span class="line">&#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F;bin&#x2F;ash</span><br><span class="line">&#x2F;bin&#x2F;hush</span><br><span class="line">&#x2F;bin&#x2F;bash</span><br><span class="line">&#x2F;sbin&#x2F;nologin</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# etc&#x2F;nsswitch.conf</span><br><span class="line">passwd: files</span><br><span class="line">grup: files</span><br><span class="line">shadow: files</span><br><span class="line">hosts: files dns</span><br></pre></td></tr></table></figure>
<h2 id="编译安装dropbear"><a href="#编译安装dropbear" class="headerlink" title="编译安装dropbear"></a>编译安装dropbear</h2><p>注 dropbear 可以在<a href="https://matt.ucc.asn.au/dropbear/">dropbear官网</a>下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# tar -xvf dropbear-2018.76.tar.bz2</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cd dropbear-2018.76</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;dropbear-2018.76]#  make PROGRAMS&#x3D;&quot;dropbear dbclient dropbearkey dropbearconvert scp&quot; install</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# cd &#x2F;mnt&#x2F;sysroot&#x2F;etc&#x2F;dropbear&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot&#x2F;etc&#x2F;dropbear&#x2F;]# openssl passwd -1 -salt $(openssl rand -hex 4)</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot&#x2F;etc&#x2F;dropbear&#x2F;]# dropbearkey -t rsa -s 2048 -f dropbear_rsa_host_key</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot&#x2F;etc&#x2F;dropbear&#x2F;]# dropbearkey -t dss -f dropbear_dss_host_key</span><br><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot&#x2F;etc&#x2F;dropbear&#x2F;]# dropbear -E -F 启动</span><br></pre></td></tr></table></figure>
<h2 id="移植系统认证、登录、解析相关的依赖库"><a href="#移植系统认证、登录、解析相关的依赖库" class="headerlink" title="移植系统认证、登录、解析相关的依赖库"></a>移植系统认证、登录、解析相关的依赖库</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:/mnt/sysroot] mkdir  usr/lib64/</span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /lib64/libnss_files* lib64/</span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /usr/lib64/libnss3.so usr/lib64/</span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /usr/lib64/libnss_files.so* usr/lib64/</span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /lib64/libresolv*  lib64/</span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /lib64/libnss_dns* lib64/</span><br></pre></td></tr></table></figure>
<h2 id="编译安装nginx"><a href="#编译安装nginx" class="headerlink" title="编译安装nginx"></a>编译安装nginx</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# tar -xvf nginx-1.14.0.tar.gz</span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx   --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --with-http_gzip_static_module --with-http_stub_status_module --with-http_ssl_module --user&#x3D;root --group&#x3D;root</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cp -a &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx  &#x2F;usr&#x2F;sbin&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cp -a &#x2F;usr&#x2F;local&#x2F;nginx&#x2F; &#x2F;mnt&#x2F;sysroot&#x2F;usr&#x2F;local&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="编译安装inotify并移植"><a href="#编译安装inotify并移植" class="headerlink" title="编译安装inotify并移植"></a>编译安装inotify并移植</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# tar -xvf inotify-tools-3.14.tar.gz</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cd inotify-tools-3.14</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;inotify-tools-3.14]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;inotify&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;inotify-tools-3.14]# cp -a &#x2F;usr&#x2F;local&#x2F;inotify&#x2F; &#x2F;mnt&#x2F;sysroot&#x2F;usr&#x2F;local</span><br></pre></td></tr></table></figure>
<h2 id="编译安装keepalived"><a href="#编译安装keepalived" class="headerlink" title="编译安装keepalived"></a>编译安装keepalived</h2><p>注: keepalived 依赖net-tools psmisc 两个工具包，因此需要将这两个工具包的命令移植</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@laoba-10-17:&#x2F;usr&#x2F;local&#x2F;src&#x2F;linux-4.18.5]# rpm -ql net-tools | grep bin &amp;&amp; rpm -ql psmisc | grep bin</span><br><span class="line">&#x2F;bin&#x2F;netstat</span><br><span class="line">&#x2F;sbin&#x2F;arp</span><br><span class="line">&#x2F;sbin&#x2F;ether-wake</span><br><span class="line">&#x2F;sbin&#x2F;ifconfig</span><br><span class="line">&#x2F;sbin&#x2F;ipmaddr</span><br><span class="line">&#x2F;sbin&#x2F;iptunnel</span><br><span class="line">&#x2F;sbin&#x2F;mii-diag</span><br><span class="line">&#x2F;sbin&#x2F;mii-tool</span><br><span class="line">&#x2F;sbin&#x2F;nameif</span><br><span class="line">&#x2F;sbin&#x2F;plipconfig</span><br><span class="line">&#x2F;sbin&#x2F;route</span><br><span class="line">&#x2F;sbin&#x2F;slattach</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;killall</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;peekfd</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;prtstat</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;pstree</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;pstree.x11</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;fuser</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# tar -xvf keepalived-2.0.6.tar.gz</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cd keepalived-2.0.6</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cp &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;sbin&#x2F;keepalived &#x2F;usr&#x2F;sbin&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src&#x2F;keepalived-2.0.6]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# cp -a &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F; &#x2F;mnt&#x2F;sysroot&#x2F;usr&#x2F;local</span><br></pre></td></tr></table></figure>
<h2 id="编写bincp-脚本"><a href="#编写bincp-脚本" class="headerlink" title="编写bincp 脚本"></a>编写bincp 脚本</h2><p>ldd 命令可以查看命令所依赖的库的位置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:&#x2F;mnt&#x2F;sysroot]# ldd &#x2F;bin&#x2F;cp</span><br></pre></td></tr></table></figure>
<p>编写脚本，将需要的命令同步到/mnt/sysroot 目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@ssjinyao-node11:/mnt/sysroot]<span class="comment"># mkdir /root/bin</span></span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot]<span class="comment"># vim /root/bin/bincp.sh</span></span><br><span class="line">[root@ssjinyao-node11:/mnt/sysroot]<span class="comment"># chmod +x /root/bin/bincp.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#The scripts can copy bin file and that bin libs</span></span><br><span class="line"><span class="comment">#author renjin</span></span><br><span class="line"><span class="comment">#date 2016 11 19</span></span><br><span class="line"><span class="comment">#version 3.0</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;acquiesce copy bin file in /mnt/sysroot!! &quot;</span></span><br><span class="line">MNT=<span class="string">&quot;/mnt/sysroot&quot;</span></span><br><span class="line"><span class="function"><span class="title">BIN_FILE</span></span>() &#123; bindir=`dirname <span class="variable">$file</span>`</span><br><span class="line">             [ -e <span class="variable">$MNT</span> ] || mkdir -p <span class="variable">$MNT</span></span><br><span class="line">             [ -e <span class="variable">$MNT</span><span class="variable">$bindir</span> ] || mkdir -p <span class="variable">$MNT</span><span class="variable">$bindir</span></span><br><span class="line">             <span class="keyword">if</span> [ -e <span class="variable">$MNT</span><span class="variable">$file</span> ] ; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;you will copy bin file exsit !&quot;</span></span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">               cp <span class="variable">$file</span> <span class="variable">$MNT</span><span class="variable">$bindir</span></span><br><span class="line">             <span class="keyword">fi</span></span><br><span class="line">          &#125;</span><br><span class="line"><span class="function"><span class="title">LIB_FILE</span></span>() &#123; lib=`ldd <span class="variable">$file</span> | grep -Eo <span class="string">&quot;/.*lib(64)&#123;0,1&#125;/[^[:space:]]&#123;1,&#125;&quot;</span>`</span><br><span class="line">             <span class="keyword">for</span> lib64 <span class="keyword">in</span> <span class="variable">$lib</span>; <span class="keyword">do</span></span><br><span class="line">                 libdir=`dirname <span class="variable">$lib64</span>`</span><br><span class="line">                 <span class="keyword">if</span> [ ! -e <span class="variable">$MNT</span><span class="variable">$libdir</span> ]; <span class="keyword">then</span></span><br><span class="line">                       mkdir -p <span class="variable">$MNT</span><span class="variable">$libdir</span></span><br><span class="line">                 <span class="keyword">elif</span>  [ -e <span class="variable">$MNT</span><span class="variable">$lib64</span> ] ; <span class="keyword">then</span></span><br><span class="line">                     <span class="built_in">echo</span> <span class="string">&quot;you will copy lib file exsit &quot;</span> &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">                 <span class="keyword">else</span> cp <span class="variable">$lib</span> <span class="variable">$MNT</span><span class="variable">$libdir</span></span><br><span class="line">                 <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;please input your will copy bin file name,or input quit quitng: &quot;</span> BIN</span><br><span class="line">until [ <span class="variable">$BIN</span> == <span class="string">&#x27;quit&#x27;</span> -o <span class="variable">$BIN</span> == <span class="string">&#x27;q&#x27;</span> ]; <span class="keyword">do</span></span><br><span class="line">! <span class="built_in">which</span> <span class="variable">$BIN</span> 2&gt; /dev/null &amp;&amp; <span class="built_in">read</span> -p  <span class="string">&quot;you input command no exsit,please again input or input quit ,quiting  &quot;</span> BIN &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">file=`<span class="built_in">which</span> --skip-alias <span class="variable">$BIN</span> 2&gt; /dev/null | grep <span class="string">&quot;/.*[^[:space:]]&quot;</span> `</span><br><span class="line">      BIN_FILE <span class="variable">$BIN</span> &amp;&amp; LIB_FILE <span class="variable">$BIN</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;continue!,or input quit ,quting: &quot;</span> BIN</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># chmod +x &#x2F;root&#x2F;bincp.sh &amp;&amp; cp &#x2F;root&#x2F;bincp.sh &#x2F;bin</span><br><span class="line">[root@ssjinyao-node11:&#x2F;usr&#x2F;local&#x2F;src]# bincp.sh</span><br><span class="line">acquiesce copy bin file in &#x2F;mnt&#x2F;sysroot!!</span><br><span class="line">please input your will copy bin file name,or input quit quitng:</span><br></pre></td></tr></table></figure>
<p>需要移植的命令有</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash dropbear ssh scp rysnc dbclient dropbearconvert dropbearkey genhash nginx 等等</span><br></pre></td></tr></table></figure>
<p>利上这个脚本将自己需要的命令拷贝到/mnt/sysroot中 </p>
<p>添加root用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># adduser root </span><br><span class="line"># passwd root</span><br><span class="line">这里要注意把 root id 在 &#x2F;etc&#x2F;passwd 中改0</span><br><span class="line">在Linux内核中，系统权限只对应id</span><br></pre></td></tr></table></figure>
<h2 id="微系统-keepaived-nginx-rsync-inotify的实现"><a href="#微系统-keepaived-nginx-rsync-inotify的实现" class="headerlink" title="微系统 keepaived+nginx+rsync+inotify的实现"></a>微系统 keepaived+nginx+rsync+inotify的实现</h2><p>keepalived+nginx+rsync+intofity 在之前的文章中有实现<br>大家可以再克隆一个小系统，来实现keepalived的双主</p>
<h2 id="系统启动后如下图"><a href="#系统启动后如下图" class="headerlink" title="系统启动后如下图"></a>系统启动后如下图</h2><p><img src="/images/huatu-ssjinyao-little-linux.png" class="lazyload" data-srcset="/images/huatu-ssjinyao-little-linux.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/linux-little-ps.png" class="lazyload" data-srcset="/images/linux-little-ps.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>keepalived+nginx+inotify+rsync的实现</title>
    <url>/2018/08/08/keepalived+nginx+inotify+rsync%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="环境架构与实现"><a href="#环境架构与实现" class="headerlink" title="环境架构与实现"></a>环境架构与实现</h1><p>[toc]</p>
<h2 id="实验环境介绍"><a href="#实验环境介绍" class="headerlink" title="实验环境介绍"></a>实验环境介绍</h2><table>
<thead>
<tr>
<th>服务器ip</th>
<th>操作系统</th>
<th>主机名</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.180.66.11</td>
<td>CentOS7.4</td>
<td>node1</td>
<td>ansible自动推送</td>
</tr>
<tr>
<td>10.180.66.12</td>
<td>CentOS7.4</td>
<td>node2</td>
<td>keepalived+nginx+rsync客户端</td>
</tr>
<tr>
<td>10.180.66.13</td>
<td>CentOS7.4</td>
<td>node3</td>
<td>keepalived+nginx+rsync服务端</td>
</tr>
</tbody>
</table>
<p><img src="/images/keepalived-huajin1.png" class="lazyload" data-srcset="/images/keepalived-huajin1.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="实现逻辑架构图"><a href="#实现逻辑架构图" class="headerlink" title="实现逻辑架构图"></a>实现逻辑架构图</h2><p><img src="/images/keepalived+nginx+rsync+inotify.png" class="lazyload" data-srcset="/images/keepalived+nginx+rsync+inotify.png" srcset="data:image/png;base64,666" alt=""><br>注: 上图node{1..7}是指nginx upstream 的各节点  </p>
<h2 id="ansible-环境准备"><a href="#ansible-环境准备" class="headerlink" title="ansible 环境准备"></a>ansible 环境准备</h2><p>node1 ansible 环境的准备</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.180.66.11 node1 node1.ssjinyao.com</span><br><span class="line">10.180.66.12 node2 node2.ssjinyao.com</span><br><span class="line">10.180.66.13 node3 node3.ssjinyao.com</span><br><span class="line"><span class="comment"># for i in &#123;1..3&#125;; do ssh-copy-id -i ~/.ssh/id_rsa.pub root@node$i ; done # 双机互信</span></span><br><span class="line"><span class="comment"># yum -y install epel-release</span></span><br><span class="line"><span class="comment"># yum -y install ansible</span></span><br><span class="line"><span class="comment"># vim /etc/ansible/hosts</span></span><br><span class="line">[keepalived]</span><br><span class="line">10.180.66.12</span><br><span class="line">10.180.66.13</span><br></pre></td></tr></table></figure>
<h2 id="keepalived-手动安装"><a href="#keepalived-手动安装" class="headerlink" title="keepalived 手动安装"></a>keepalived 手动安装</h2><p>node2 与 node3 keepalived手动安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install  gcc \</span><br><span class="line">            openssl-devel \</span><br><span class="line">            libnl3-devel \</span><br><span class="line">            ipset-devel \</span><br><span class="line">            iptables-devel \</span><br><span class="line">            libnfnetlink-devel \</span><br><span class="line">            net-snmp-devel  \</span><br><span class="line">            procps-ng  \</span><br><span class="line">            psmisc  \</span><br><span class="line">            lsof \</span><br><span class="line">            grep</span><br><span class="line"># ntpdate ntp.aliyun.com</span><br><span class="line"># timedatectl set-timezone Asia&#x2F;Shanghai</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line"># 上传keepalived-2.0.6.tar.gz</span><br></pre></td></tr></table></figure>
<p>没有keepavlied包的当然也可以在keepalived <a href="http://www.keepalived.org/">官网</a>下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;keepalived-2.0.6</span><br><span class="line"># .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;keepalived </span><br><span class="line"># make &amp;&amp; make install</span><br><span class="line"># mkdir &#x2F;var&#x2F;log&#x2F;keepalived&#x2F;</span><br><span class="line"># vim &#x2F;etc&#x2F;rsyslog.conf  # 最后加入</span><br><span class="line">local0.*                                                &#x2F;var&#x2F;log&#x2F;keepalived&#x2F;keepalived.log</span><br><span class="line"># </span><br><span class="line"># systemctl restart rsyslog</span><br><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;sysconfig&#x2F;keepalived # 将最后一行改为</span><br><span class="line">KEEPALIVED_OPTIONS&#x3D;&quot;-D -S 0 -f &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf&quot;</span><br></pre></td></tr></table></figure>
<p>node2 keepalived 的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id node2</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;bin&#x2F;bash &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;nginx_check.sh&quot;</span><br><span class="line">    interval 5</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 55</span><br><span class="line">    priority 80</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    notify_master &quot;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;message.sh  master&quot;</span><br><span class="line">    notify_backup &quot;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;message.sh  backup&quot;</span><br><span class="line">    notify_fault  &quot;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;message.sh  fault&quot;</span><br><span class="line">    unicast_src_ip 10.180.66.12</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">     10.180.66.13</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">       chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass testLLb</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      10.180.66.100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>node3 keepalived 的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id node2</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;bin&#x2F;bash &#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;nginx_check.sh&quot;</span><br><span class="line">    interval 5</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 55</span><br><span class="line">    priority 80</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    notify_master &quot;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;message.sh  master&quot;</span><br><span class="line">    notify_backup &quot;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;message.sh  backup&quot;</span><br><span class="line">    notify_fault  &quot;&#x2F;usr&#x2F;local&#x2F;keepalived&#x2F;etc&#x2F;keepalived&#x2F;message.sh  fault&quot;</span><br><span class="line">    unicast_src_ip 10.180.66.13</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">     10.180.66.12</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">       chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass testLLb</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">      10.180.66.100</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装启用nginx</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install nginx </span><br><span class="line"># systemctl start nginx </span><br><span class="line"># systemctl enable nginx </span><br><span class="line">node2 # echo &quot;node2.ssjinyao.com&quot; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br><span class="line">node3 # echo &quot;node3.ssjinyao.com&quot; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br><span class="line"># 至于配置nginx的负载均衡之前写的文章有提到过</span><br></pre></td></tr></table></figure>
<p>node2,node3 缩写keepalived nginx服务监测脚本 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/local/keepalived/etc/keepalived/nginx_check.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">package</span></span>() &#123;</span><br><span class="line">    rpm -qf /bin/ps &amp;&gt; /dev/null || yum -y install procps-ng &amp;&gt; /dev/null</span><br><span class="line">    rpm -qf /bin/grep &amp;&gt; /dev/null || yum -y install grep &amp;&gt; /dev/null</span><br><span class="line">    rpm -qf /usr/bin/killall &amp; &gt; /dev/null || yum -y install psmisc &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line">package</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">nginx_state</span></span> () &#123;</span><br><span class="line">	ps aux | grep nginx &amp;&gt; /dev/null &amp;&amp; ps -C nginx --no-header &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line">nginx_state ; nginx_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_state_num</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">nginx_port</span></span> () &#123;</span><br><span class="line">       netstat -tnlup | egrep <span class="string">&quot;:80\&gt;&quot;</span> &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">kill_keepalived</span></span> () &#123;</span><br><span class="line">      <span class="built_in">kill</span> -9 `cat /var/run/keepalived.pid`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$nginx_state_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` nginx_status_one_check problem &quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</span><br><span class="line">   nginx_port ; nginx_port_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_port_num</span></span><br><span class="line">   <span class="keyword">if</span> [ <span class="variable">$nginx_port_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">   	<span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` nginx_port_one_check problem&quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</span><br><span class="line">	systemctl restart nginx</span><br><span class="line">        sleep 2</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">nginx_state ; nginx_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_state_num</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$nginx_state_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` restart nginx and nginx_status_two_check problem &quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</span><br><span class="line">    nginx_port ; nginx_port_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_port_num</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$nginx_port_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` restart nginx and nginx_port_two_check problem &quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</span><br><span class="line">        kill_keepalived</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p><code>注: keepalived 中调用命令时不要用lsof;</code><br><code>当访问量较高时，lsof 查询进程很慢，会造成keepalived频繁切换;</code></p>
<p>node2,node3 上的keepalived 现在可以启动了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># systemctl start keepalived</span><br><span class="line"># systemctl stop  keepalived</span><br><span class="line">注:需要关闭selinux 和iptables </span><br><span class="line"># iptables -F</span><br><span class="line"># setenforce 0 </span><br></pre></td></tr></table></figure>
<p>测试效果<br>目前ip 在node2上<br><img src="/images/keepavlied-ip-a.png" class="lazyload" data-srcset="/images/keepavlied-ip-a.png" srcset="data:image/png;base64,666" alt=""></p>
<p>tcmpdump 监测单播心跳信息<br><img src="/images/tcpdump-keepalived2.png" class="lazyload" data-srcset="/images/tcpdump-keepalived2.png" srcset="data:image/png;base64,666" alt=""><br>当把node2上的nginx停止时<br><img src="/images/keepavlied-nginx-ok2.png" class="lazyload" data-srcset="/images/keepavlied-nginx-ok2.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/keepavlied-stop-nginx-ok.png" class="lazyload" data-srcset="/images/keepavlied-stop-nginx-ok.png" srcset="data:image/png;base64,666" alt=""><br>当node2上的nginx用监测脚本无法自动恢复时<br><img src="/images/keepavlied-stop-nginx2.png" class="lazyload" data-srcset="/images/keepavlied-stop-nginx2.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/keepalived-return-node3.png" class="lazyload" data-srcset="/images/keepalived-return-node3.png" srcset="data:image/png;base64,666" alt=""><br>当node2 nginx恢复时<br><img src="/images/keepavlied-status-keepalived.png" class="lazyload" data-srcset="/images/keepavlied-status-keepalived.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/keepavied-node3.png" class="lazyload" data-srcset="/images/keepavied-node3.png" srcset="data:image/png;base64,666" alt=""><br>可以多次服务宕了时，规范划的检查nginx的启动日志<br><img src="/images/keepalived-messages.png" class="lazyload" data-srcset="/images/keepalived-messages.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="ansible-编写keepalived-自动化roles"><a href="#ansible-编写keepalived-自动化roles" class="headerlink" title="ansible 编写keepalived 自动化roles"></a>ansible 编写keepalived 自动化roles</h2><p>在 node1 上编写 keepalived 自动化脚本</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tree</span></span><br><span class="line"><span class="string">.</span></span><br><span class="line"><span class="string">├──</span> <span class="string">keepalived.yml</span></span><br><span class="line"><span class="string">└──</span> <span class="string">roles</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">keepalived</span></span><br><span class="line">        <span class="string">├──</span> <span class="string">files</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">├──</span> <span class="string">keepalived</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">├──</span> <span class="string">keepalived-2.0.6.tar.gz</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">├──</span> <span class="string">keepalived.conf.bak</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">├──</span> <span class="string">message.sh</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">├──</span> <span class="string">nginx_check.sh</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">└──</span> <span class="string">rsyslog.conf</span></span><br><span class="line">        <span class="string">├──</span> <span class="string">tasks</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line">        <span class="string">├──</span> <span class="string">templates</span></span><br><span class="line">        <span class="string">│</span>   <span class="string">└──</span> <span class="string">keepalived.conf</span></span><br><span class="line">        <span class="string">└──</span> <span class="string">vars</span></span><br><span class="line">            <span class="string">└──</span> <span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span> <span class="string">directories,</span> <span class="number">10</span> <span class="string">files</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vim keepalived.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; keepalivedhosts &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">keepalived</span></span><br><span class="line"><span class="comment"># vim roles/keepalived/tasks/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">off</span> <span class="string">selinux</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">setenforce</span> <span class="number">0</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">of</span> <span class="string">iptables</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">iptables</span> <span class="string">-F</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">required</span> <span class="string">packges</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gcc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">openssl-devel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">libnl3-devel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ipset-devel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">iptables-devel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">libnfnetlink-devel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">net-snmp-devel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">procps-ng</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">psmisc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">lsof</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">grep</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ntpdate</span> <span class="string">time</span> <span class="string">to</span> <span class="string">keepavlied</span> <span class="string">hosts</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">ntpdate</span> <span class="string">ntp.aliyun.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">site</span> <span class="string">time</span> <span class="string">zone</span> <span class="string">to</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">timedatectl</span> <span class="string">set-timezone</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">keepalived_file</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">servers</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=keepalived-&#123;&#123;</span> <span class="string">keepalivedversion</span> <span class="string">&#125;&#125;.tar.gz</span>  <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedsrc</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">decompression</span> <span class="string">keepalived</span> <span class="string">Source</span> <span class="string">code</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">cd</span> <span class="string">/usr/local/src/</span> <span class="string">&amp;&amp;</span> <span class="string">tar</span> <span class="string">-xvf</span> <span class="string">keepalived-2.0.6.tar.gz</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span> <span class="string">install</span> <span class="string">keepalived</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">cd</span> <span class="string">/usr/local/src/keepalived-&#123;&#123;</span> <span class="string">keepalivedversion</span> <span class="string">&#125;&#125;</span> <span class="string">&amp;&amp;</span> <span class="string">./configure</span> <span class="string">--prefix=/usr/local/keepalived</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mkdir</span> <span class="string">keepalived</span> <span class="string">log</span> <span class="string">floder</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">mkdir</span> &#123;&#123; <span class="string">keepalivedlogpath</span> &#125;&#125; <span class="string">-pv</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">rsyslog</span> <span class="string">config</span> <span class="string">to</span> <span class="string">keepalived</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=rsyslog.conf</span> <span class="string">dest=/etc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">rsyslog</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=rsyslog</span> <span class="string">state=restarted</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">keepalived</span>  <span class="string">sysconfig</span> <span class="string">file</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=keepalived</span>  <span class="string">dest=/usr/local/keepalived/etc/sysconfig</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">keepalived</span> <span class="string">nginx</span> <span class="string">monitor</span> <span class="string">bash</span> <span class="string">script</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=nginx_check.sh</span>  <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedpath</span> <span class="string">&#125;&#125;etc/keepalived/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">keepalived</span> <span class="string">nginx</span> <span class="string">messge</span> <span class="string">bash</span> <span class="string">script</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=message.sh</span>  <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedpath</span> <span class="string">&#125;&#125;etc/keepalived/</span> <span class="string">mode=755</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">keepalived</span> <span class="string">config</span> <span class="string">file</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=keepalived.conf</span> <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedpath</span> <span class="string">&#125;&#125;etc/keepalived/</span></span><br><span class="line"><span class="comment"># vim roles/keepalived/vars/main.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">keepalivedhosts:</span> <span class="string">keepalived</span></span><br><span class="line"><span class="attr">keepalivedversion:</span> <span class="number">2.0</span><span class="number">.6</span></span><br><span class="line"><span class="attr">keepalivedpath:</span> <span class="string">/usr/local/keepalived/</span></span><br><span class="line"><span class="attr">keepalivedsrc:</span> <span class="string">/usr/local/src/</span></span><br><span class="line"><span class="attr">keepalivedlogpath:</span> <span class="string">/var/log/keepalived/</span></span><br><span class="line"><span class="attr">priority:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">unicast_src_ip:</span> <span class="string">keepalived</span></span><br><span class="line"><span class="attr">unicast_peer1:</span> <span class="number">10.180</span><span class="number">.66</span><span class="number">.13</span></span><br><span class="line"><span class="attr">unicast_peer2:</span> <span class="number">10.180</span><span class="number">.66</span><span class="number">.12</span></span><br><span class="line"><span class="attr">virtual_ipaddress:</span> <span class="number">10.180</span><span class="number">.66</span><span class="number">.100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vim roles/keepalived/templates/keepalived.conf</span></span><br><span class="line"> <span class="string">!</span> <span class="string">Configuration</span> <span class="string">File</span> <span class="string">for</span> <span class="string">keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="string">global_defs</span> &#123;</span><br><span class="line">   <span class="string">notification_email</span> &#123;</span><br><span class="line">     <span class="string">root@localhost</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="string">notification_email_from</span> <span class="string">Alexandre.Cassen@firewall.loc</span></span><br><span class="line">   <span class="string">smtp_server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">   <span class="string">smtp_connect_timeout</span> <span class="number">30</span></span><br><span class="line">   <span class="string">router_id</span> <span class="string">node2</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="string">vrrp_script</span> <span class="string">chk_nginx</span> &#123;</span><br><span class="line">    <span class="string">script</span> <span class="string">&quot;/bin/bash /usr/local/keepalived/etc/keepalived/nginx_check.sh&quot;</span></span><br><span class="line">    <span class="string">interval</span> <span class="number">5</span></span><br><span class="line">    <span class="string">weight</span> <span class="number">-20</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">vrrp_instance</span> <span class="string">VI_1</span> &#123;</span><br><span class="line">    <span class="string">state</span> <span class="string">MASTER</span></span><br><span class="line">    <span class="string">interface</span> <span class="string">eth0</span></span><br><span class="line">    <span class="string">virtual_router_id</span> <span class="number">55</span></span><br><span class="line">    <span class="string">priority</span> &#123;&#123; <span class="string">priority</span> &#125;&#125;</span><br><span class="line">    <span class="string">nopreempt</span></span><br><span class="line">    <span class="string">advert_int</span> <span class="number">1</span></span><br><span class="line">    <span class="string">notify_master</span> <span class="string">&quot;/usr/local/keepalived/etc/keepalived/message.sh  master&quot;</span></span><br><span class="line">    <span class="string">notify_backup</span> <span class="string">&quot;/usr/local/keepalived/etc/keepalived/message.sh  backup&quot;</span></span><br><span class="line">    <span class="string">notify_fault</span>  <span class="string">&quot;/usr/local/keepalived/etc/keepalived/message.sh  fault&quot;</span></span><br><span class="line">    <span class="string">unicast_src_ip</span> <span class="string">xxx.xx.xxx.xx</span></span><br><span class="line">    <span class="string">unicast_peer</span> &#123;</span><br><span class="line">     <span class="string">xxx.xx.xxx.xx</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">track_script</span> &#123;</span><br><span class="line">       <span class="string">chk_nginx</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">authentication</span> &#123;</span><br><span class="line">        <span class="string">auth_type</span> <span class="string">PASS</span></span><br><span class="line">        <span class="string">auth_pass</span> <span class="string">zE2kNsRQ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">virtual_ipaddress</span> &#123;</span><br><span class="line">	<span class="string">xxx.xx.xxx.xxx</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 注：为避免意外停止生产中的nginx服务，在生产中，最好先把有关nginx监测配置的注释了</span></span><br><span class="line"><span class="comment"># vim roles/keepalived/files/message.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="string">/usr/bin/echo</span> <span class="string">&quot;`date +&quot;</span><span class="string">%Y-%m-%d-%H-%M-%S&quot;`</span> <span class="string">node2</span> <span class="string">notify</span> <span class="string">$1</span> <span class="string">&quot; &gt;&gt; /var/log/keepalived/shell-message.log</span></span><br><span class="line"><span class="string"># 其余文keepalived、keepalived-2.0.6.tar.gz、</span></span><br><span class="line"><span class="string">keepalived.conf.bak、message.sh、nginx_check.sh、rsyslog.conf件与以上的使用的一样</span></span><br></pre></td></tr></table></figure>
<p>接下来把node2,node3恢复快照到初始状态跑一次试试<br><img src="/images/ansible-keepalived.png" class="lazyload" data-srcset="/images/ansible-keepalived.png" srcset="data:image/png;base64,666" alt=""><br>为避免生产中出现突发情况，检查变更完keepalived 主配置文件后手动启动服务</p>
<h2 id="rsync-inotify-nginx配置文件实时同步"><a href="#rsync-inotify-nginx配置文件实时同步" class="headerlink" title="rsync+inotify nginx配置文件实时同步"></a>rsync+inotify nginx配置文件实时同步</h2><h3 id="主服务器配置10-180-66-13"><a href="#主服务器配置10-180-66-13" class="headerlink" title="主服务器配置10.180.66.13"></a>主服务器配置10.180.66.13</h3><p>1、 安装rsync</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line"># 上传rsync源码包</span><br><span class="line"># tar -xvf rsync-3.0.9.tar.gz</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;rsync-3.0.9</span><br><span class="line"># .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;rsync</span><br><span class="line"># make </span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>
<p>2、 建立密码认证文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo &#39;Tpz99YJV1p&#39; &gt;&gt; &#x2F;usr&#x2F;local&#x2F;rsync&#x2F;rsync.passwd</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;rsync&#x2F;</span><br><span class="line"># chown root.root rsync.passwd</span><br><span class="line"># chmod 600 rsync.passwd</span><br><span class="line"># ll rsync.passwd # 查看文件权限是否正确</span><br></pre></td></tr></table></figure>
<p>3、 安装 inotify </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line"># 上传inotify 源码包</span><br><span class="line"># tar -xvf inotify-tools-3.14.tar.gz</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;inotify-tools-3.14</span><br><span class="line"># .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;inotify</span><br><span class="line"># make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>
<p>4、创建 rsync复制脚本(要注意同步的方向与操作)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">host=10.180.66.13</span><br><span class="line">src=/etc/nginx/</span><br><span class="line">des=web</span><br><span class="line">user=usernode</span><br><span class="line">src_ssl=/tmp/</span><br><span class="line">des_ssl=ssl</span><br><span class="line">/usr/<span class="built_in">local</span>/inotify/bin/inotifywait -mrq --timefmt <span class="string">&#x27;%d/%m/%y %H:%M&#x27;</span> --format <span class="string">&#x27;%T %w%f%e&#x27;</span> -e modify,delete,create,attrib <span class="variable">$src</span> <span class="variable">$src_ssl</span> | <span class="keyword">while</span> <span class="built_in">read</span> files</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">/usr/<span class="built_in">local</span>/rsync/bin/rsync -vzrtopg --delete --progress --password-file=/usr/<span class="built_in">local</span>/rsync/rsync.passwd <span class="variable">$src</span> <span class="variable">$user</span>@<span class="variable">$host</span>::<span class="variable">$des</span></span><br><span class="line">/usr/<span class="built_in">local</span>/rsync/bin/rsync -vzrtopg --delete --progress --password-file=/usr/<span class="built_in">local</span>/rsync/rsync.passwd <span class="variable">$src_ssl</span> <span class="variable">$user</span>@<span class="variable">$host</span>::<span class="variable">$des_ssl</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;files&#125;</span> was rsynced&quot;</span> &amp;&gt;&gt; /var/<span class="built_in">log</span>/rsync.log</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo &#39;bash &#x2F;root&#x2F;rsync.sh &amp;&gt; &#x2F;dev&#x2F;null &amp;&#39; &gt;&gt; &#x2F;etc&#x2F;rc.local</span><br><span class="line"># chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local  </span><br></pre></td></tr></table></figure>
<p>备服务器同步配置10.180.66.13</p>
<p>1、 安装rsync(备服务器只安装rsync，也就是说同步文件的目标服务)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line"># 上传rsync源码包</span><br><span class="line"># tar -xvf rsync-3.0.9.tar.gz</span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;rsync-3.0.9</span><br><span class="line"># .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;rsync</span><br><span class="line"># make </span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>
<p>2、 建立用户与密码认证文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;rsync&#x2F;</span><br><span class="line"># echo &#39;usernode:Tpz99YJV1p&#39; &gt;&gt; rsync.passwd</span><br><span class="line"># chown root.root rsync.passwd</span><br><span class="line"># chmod 600 rsync.passwd</span><br><span class="line"># ll # 查看文件权限是否正确</span><br></pre></td></tr></table></figure>
<p>3、 建立rsync的启动配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;rsync</span><br><span class="line"># vim rsync.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uid &#x3D; root</span><br><span class="line">gid &#x3D; root</span><br><span class="line">use chroot &#x3D; no</span><br><span class="line">max connections &#x3D; 10</span><br><span class="line">strict modes &#x3D; yes</span><br><span class="line">pid file &#x3D; &#x2F;var&#x2F;run&#x2F;rsyncd.pid</span><br><span class="line">lock file &#x3D; &#x2F;var&#x2F;run&#x2F;rsync.lock</span><br><span class="line">log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log</span><br><span class="line">[web]</span><br><span class="line">path &#x3D; &#x2F;etc&#x2F;nginx&#x2F;</span><br><span class="line">comment &#x3D; web file</span><br><span class="line">ignore errors</span><br><span class="line">read only &#x3D; no</span><br><span class="line">write only &#x3D; no</span><br><span class="line">hosts allow &#x3D; 10.180.66.12</span><br><span class="line">hosts deny &#x3D; *</span><br><span class="line">list &#x3D; false</span><br><span class="line">uid &#x3D; root</span><br><span class="line">gid &#x3D; root</span><br><span class="line">auth users &#x3D; usernode</span><br><span class="line">secrets file &#x3D; &#x2F;usr&#x2F;local&#x2F;rsync&#x2F;rsync.passwd</span><br><span class="line"></span><br><span class="line">[ssl]</span><br><span class="line">path &#x3D; &#x2F;tmp&#x2F;</span><br><span class="line">comment &#x3D; ssl file</span><br><span class="line">ignore errors</span><br><span class="line">read only &#x3D; no</span><br><span class="line">write only &#x3D; no</span><br><span class="line">hosts allow &#x3D; 10.180.66.12</span><br><span class="line">hosts deny &#x3D; *</span><br><span class="line">list &#x3D; false</span><br><span class="line">uid &#x3D; root</span><br><span class="line">gid &#x3D; root</span><br><span class="line">auth users &#x3D; usernode</span><br><span class="line">secrets file &#x3D; &#x2F;usr&#x2F;local&#x2F;rsync&#x2F;rsync.passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  &#x2F;usr&#x2F;local&#x2F;rsync&#x2F;bin&#x2F;rsync --daemon --config&#x3D;&#x2F;usr&#x2F;local&#x2F;rsync&#x2F;rsync.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo &#39;&#x2F;usr&#x2F;local&#x2F;rsync&#x2F;bin&#x2F;rsync --daemon --config&#x3D;&#x2F;usr&#x2F;local&#x2F;rsync&#x2F;rsync.conf&#39; &gt;&gt; &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line"># chmod +x &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br></pre></td></tr></table></figure>
<h3 id="在10-180-66-12-开始往-10-180-66-13上面同步"><a href="#在10-180-66-12-开始往-10-180-66-13上面同步" class="headerlink" title="在10.180.66.12 开始往 10.180.66.13上面同步"></a>在10.180.66.12 开始往 10.180.66.13上面同步</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># bash &#x2F;root&#x2F;rsync.sh &amp;&gt; &#x2F;dev&#x2F;null &amp;  注: shell</span><br></pre></td></tr></table></figure>
<h3 id="配置同步结果如下"><a href="#配置同步结果如下" class="headerlink" title="配置同步结果如下"></a>配置同步结果如下</h3><p><img src="/images/rysnc+inotify.png" class="lazyload" data-srcset="/images/rysnc+inotify.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/rsync+inotify2.png" class="lazyload" data-srcset="/images/rsync+inotify2.png" srcset="data:image/png;base64,666" alt=""></p>
<p>注意:<br>nginx 同步配置的源地址与目标地址一定要注意，如果对以上配置不是很清楚，一定要测试无误后<br>      再上生产环境， 不要把生产中的配置替换了<br>keepalived 在自动化初始化时，不要启用nginx监测，另外注意在生产中的虚拟ip冲突;  </p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>python 日志处理一</title>
    <url>/2020/10/18/python%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-日志处理一"><a href="#python-日志处理一" class="headerlink" title="python 日志处理一"></a>python 日志处理一</h1><p><img src="/images/python-log-parsing.png" class="lazyload" data-srcset="/images/python-log-parsing.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><ul>
<li>实现ls 命令功能，实现-l、-a和 -all、 -h 选项</li>
</ul>
<ol>
<li>实现显示路径下的文件列表;</li>
<li>-a和 -all显示包含.开头的文件;</li>
<li>-l 详细列表显示;</li>
<li>-h 和 -l 配合，人性化显示文件大小，例如1K、1G、1T等。可以认为1G=1000M;</li>
<li>c 字符;d目录;-普通文件;l软链接;b块设备;s socket文件;p pip文件，即FIFO;</li>
<li>-rw-rw-r– 1 python python 5 Oct 00:07 test4;</li>
<li>mode 硬链接 属主 属组 字节 时间 文件名;</li>
<li>按照文件名排序输出，可以和ls的顺序不一样，但要求文件名排序;</li>
<li>要求详细列表显示时，时间可以按照”年-月-日 时:分:秒” 格式显示。</li>
</ol>
<h3 id="argparse-模块"><a href="#argparse-模块" class="headerlink" title="* argparse 模块"></a>* argparse 模块</h3><p>一个可执行文件或者脚本可以接收参数;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ls -l /etc</span></span><br><span class="line">/etc <span class="comment"># 是位置参数</span></span><br><span class="line">-l <span class="comment"># 是短选项</span></span><br></pre></td></tr></table></figure>
<p>如何把这些参数传递给程序呢  ？<br>从3.2开始Python提供了参数分析的argparse。</p>
<ul>
<li>参数分类</li>
</ul>
<p>位置参数放在哪里，就要对应一个参数位置。例如/etc 就是对应一个参数位置;<br>选项参数，前面必须是通过<code>-</code>的短选项，或者<code>--</code> 长选项， 然后后面的才算它的参数，当然短选项后面也可以没有参数;</p>
<p>上述中 ‘/etc’ 对应的是位置参数， -l  是选项参数;</p>
<h3 id="基本目录的实现"><a href="#基本目录的实现" class="headerlink" title="基本目录的实现"></a>基本目录的实现</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showdir</span>(<span class="params">path:<span class="built_in">str</span>=<span class="string">&#x27;.&#x27;</span></span>):</span></span><br><span class="line">    p = Path(path)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> p.iterdir():</span><br><span class="line">        print(file.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    showdir(<span class="string">&#x27;/etc&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="基本的解析"><a href="#基本的解析" class="headerlink" title="基本的解析"></a>基本的解析</h3><p>先来看一段最简单的程序 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="keyword">import</span> argparse </span><br><span class="line">parser = argparse.ArgumentParser() <span class="comment"># 获得一个参数解析器</span></span><br><span class="line">args = parser.parse_args() <span class="comment"># 分析参数</span></span><br><span class="line">parser.<span class="built_in">help</span>() <span class="comment"># 打印帮助</span></span><br></pre></td></tr></table></figure>
<p>打印结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">usage: if_not.py [-h]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>  show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p>argparse 不仅仅做了参数的定义和解析，还自动帮助生成了帮助信息。尤其是usage,可以看到定义参数是否是自己想要的;</p>
<h4 id="解析器的参数"><a href="#解析器的参数" class="headerlink" title="解析器的参数"></a>解析器的参数</h4><p>prog 程序的名字，缺省使用<code>sys.argv[0]</code><br>add_help 自动解析增加-h 和–help 的选项，默认为True<br>description 为程序功能添加描述<br><code>parser = argparse.ArgumentParser(prog=&#39;ls&#39;,add_help=True,description=&#39;list directory contents&#39;)</code></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 文件的IO三</title>
    <url>/2020/10/13/python%E6%96%87%E4%BB%B6%E7%9A%84IO%E4%B8%89/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-文件的IO三"><a href="#python-文件的IO三" class="headerlink" title="python 文件的IO三"></a>python 文件的IO三</h1><p><img src="/images/python-file-io-01.jpg" class="lazyload" data-srcset="/images/python-file-io-01.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="CSV文件"><a href="#CSV文件" class="headerlink" title="CSV文件"></a>CSV文件</h2><p><strong>csv文件简介</strong></p>
<p>逗号分隔值 Comma-Separated Values。<br>CSV是一个被行分隔符、列分隔符分成行和列的文本文件;<br>没有指定字符编码。<br><a href="http://www.ietf.org/rfc/rfc4180.txt">参看RFC4180</a></p>
<p>行分隔符为\r\n，最后一行可以没有换行符;<br>列分隔符常为逗号或者制表符;<br>每一行为一条记录record。</p>
<p>字段可以使用双引号括起来，也可以不使用。如果字段中出现了双引号、逗号、换行符必须使用双引号括起来。如果字段的值是双引号，使用两个双引号表示一个转义。</p>
<p>表头可选，和段列对就就可以了。</p>
<p>csv生成测试<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1,tom,20</span></span><br><span class="line"><span class="string">2,jerry,16,</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./test.csv&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> s.splitlines():</span><br><span class="line">        f.write(line + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">p = Path(<span class="string">&#x27;./tmp/myscv.test.csv&#x27;</span>)</span><br><span class="line">parent = p.parent</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> parent.exists():</span><br><span class="line">    parent.mkdir(parents=<span class="literal">True</span>)</span><br><span class="line">csv_body= <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">id,name,age,comment</span></span><br><span class="line"><span class="string">1,zs,18,&quot;I&#x27;m18&quot;</span></span><br><span class="line"><span class="string">2,ls,20,&quot;This is a &quot;&quot;test&quot;&quot; string.&quot;</span></span><br><span class="line"><span class="string">3,ww,23,&quot;中国</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">国庆</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p.write_text(csv_body)</span><br></pre></td></tr></table></figure>
<h2 id="scv-模块"><a href="#scv-模块" class="headerlink" title="scv 模块"></a>scv 模块</h2><p><strong>reader(csvfile,dialect=’excel’,**fmtparams)</strong><br>返回DictReader的实例，是个行迭代器;<br>delimiter 列分隔符逗号<br>lineterminator 行分隔符\r\n<br>quotechar 字段的引用符号，缺少为”, 双引号</p>
<p>双引号的处理:<br>doublequote比引号的处理，默认为True。如果和quoterchar为同一个，True则使用2个双引号表示;<br>False表示使用转义字符将作为双引号的前缀;<br>escapechar一个转义字符，默认为None;<br>quoting指定双引号的规则。QUOTE_ALL所有字段;QUOTE_MINIMAL特殊符字段;<br>QUOtE_NONNUMERIC非数字字段; QUOTE_NONE都不使用引号。</p>
<p><strong>write(csvfile,dialect=’excel’,**fmtparams)</strong><br>返回DictWriter的实例。<br>主要方法有writerow、writerows。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line">path = <span class="string">&#x27;./csv/test.csv&#x27;</span></span><br><span class="line">p = Path(path)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> p.parent.exists():</span><br><span class="line">    p.parent.mkdir(parents=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">line1 = [<span class="number">1</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;&#x27;</span>]</span><br><span class="line">line2 = [<span class="number">2</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="number">20</span>,<span class="string">&#x27;&#x27;</span>]</span><br><span class="line">line3 = [line1,line2]</span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">1,tom,20,</span></span><br><span class="line"><span class="string">2,jerry,16,</span></span><br><span class="line"><span class="string">3,,,</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f)</span><br><span class="line">    writer.writerow(line1)</span><br><span class="line">    writer.writerow(line2)</span><br><span class="line">    writer.writerows(line3)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path) <span class="keyword">as</span> f :</span><br><span class="line">    reader = csv.reader(f)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> reader:</span><br><span class="line">        <span class="keyword">if</span> line:</span><br><span class="line">            print(line)</span><br></pre></td></tr></table></figure>
<h2 id="ini-文件处理"><a href="#ini-文件处理" class="headerlink" title="ini 文件处理"></a>ini 文件处理</h2><p>作为配置文件，ini文件格式的很流行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">a = test</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-<span class="built_in">set</span> = utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /dbserver/data</span><br><span class="line">prot = <span class="number">33060</span></span><br><span class="line">character-<span class="built_in">set</span>-sever=utf8</span><br><span class="line">sql_mode=NO_ENGIN_SUBSITUTION,STRICT_TRANS_TABLES</span><br></pre></td></tr></table></figure>
<h2 id="configparser"><a href="#configparser" class="headerlink" title="configparser"></a>configparser</h2><p>configparser模块的ConfigParser类就是用来操作<br><strong>read(filenames, endcoding=None)</strong><br>读取ini文件，可以是单个文件，也可以是文件列表。可以指定文件编码;<br>sections()返回section列表。缺省section不包括在内;<br>add_section(section_name)增加一个section;<br>has_section(section_name)判断section是否存在;<br>opentions(section)返回section的所有option;</p>
<p><strong>get(section,option,*,raw=False,vars=None[,fallback])</strong></p>
<p>从指定的段的选项上取值，如果找到返回，如果没有找到就去找DEFAULT段有没有;</p>
<p><strong>getint(section,option,,raw=False,vars=None[,fallback])</strong><br><strong>getfloat(section,option,raw=Flase,vars=None[,fallback])</strong><br><strong>getboolean(section,option,*,raw=False,vars=None[,fallback])</strong><br>上面3 个方法和get一样，返回指定定类型数据</p>
<p><strong>items(raw=False,vars=None)</strong><br><strong>items(section,raw=Fase,vars=None)</strong></p>
<p>没有section，则返回所有section名字及其对象；如果指定section，则返回这个section的键值对组成二元组;<br><strong>set(section,option,value)</strong><br>section存在的情况下，写入option=value，要求option、value必须是字符串；</p>
<p>remove_section(section)<br>移除section及其所有option<br>remove_option(section,option)<br>移除section下的option。</p>
<p><strong>write(fileobject,space_around_delimiters=True)</strong><br>将当前config的所有的内容写入fileobject中，一般open的函数使用w模式;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"></span><br><span class="line">cfg = ConfigParser()</span><br><span class="line">cfg.read(<span class="string">&#x27;./mysql.ini&#x27;</span>)</span><br><span class="line">print(cfg.sections())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> section <span class="keyword">in</span> cfg.sections():</span><br><span class="line">    <span class="comment"># for opt in cfg.options(section):</span></span><br><span class="line">    <span class="comment">#     print(section,opt)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> cfg.items(section):</span><br><span class="line">        print(k,v)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> cfg.has_section(<span class="string">&#x27;test&#x27;</span>):</span><br><span class="line">    cfg.add_section(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">cfg.<span class="built_in">set</span>(<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;test1&#x27;</span>,<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">cfg.<span class="built_in">set</span>(<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;test2&#x27;</span>,<span class="string">&#x27;abc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./mysql.ini&#x27;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    cfg.write(f)</span><br></pre></td></tr></table></figure>
<p>写入后如下</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">a</span> = test</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">datadir</span> = /dbserver/data</span><br><span class="line"><span class="attr">prot</span> = <span class="number">33060</span></span><br><span class="line"><span class="attr">character-set-sever</span> = utf8</span><br><span class="line"><span class="attr">sql_mode</span> = NO_ENGIN_SUBSITUTION,STRICT_TRANS_TABLES</span><br><span class="line"></span><br><span class="line"><span class="section">[test]</span></span><br><span class="line"><span class="attr">test1</span> = <span class="number">123</span></span><br><span class="line"><span class="attr">test2</span> = abc</span><br></pre></td></tr></table></figure>
<p>获取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"></span><br><span class="line">cfg = ConfigParser()</span><br><span class="line">cfg.read(<span class="string">&#x27;./mysql.ini&#x27;</span>)</span><br><span class="line">print(cfg.sections())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> section <span class="keyword">in</span> cfg.sections():</span><br><span class="line">    <span class="comment"># for opt in cfg.options(section):</span></span><br><span class="line">    <span class="comment">#     print(section,opt)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> cfg.items(section):</span><br><span class="line">        print(k,v)</span><br><span class="line"><span class="comment"># if not cfg.has_section(&#x27;test&#x27;):</span></span><br><span class="line"><span class="comment">#     cfg.add_section(&#x27;test&#x27;)</span></span><br><span class="line"><span class="comment"># cfg.set(&#x27;test&#x27;,&#x27;test1&#x27;,&#x27;123&#x27;)</span></span><br><span class="line"><span class="comment"># cfg.set(&#x27;test&#x27;,&#x27;test2&#x27;,&#x27;abc&#x27;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># with open(&#x27;./mysql.ini&#x27;,&#x27;w&#x27;) as f:</span></span><br><span class="line"><span class="comment">#     cfg.write(f)</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;!&#x27;</span>*<span class="number">50</span>)</span><br><span class="line">a = cfg.get(<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;test1&#x27;</span>)</span><br><span class="line">print(a,<span class="built_in">type</span>(a))</span><br><span class="line">b = cfg.getint(<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;test1&#x27;</span>)</span><br><span class="line">print(b+<span class="number">1</span>,<span class="built_in">type</span>(b))</span><br><span class="line"><span class="comment"># 输出 </span></span><br><span class="line">[<span class="string">&#x27;mysql&#x27;</span>, <span class="string">&#x27;mysqld&#x27;</span>, <span class="string">&#x27;test&#x27;</span>]</span><br><span class="line">a test</span><br><span class="line">default-character-<span class="built_in">set</span> utf8</span><br><span class="line">a test</span><br><span class="line">datadir /dbserver/data</span><br><span class="line">prot <span class="number">33060</span></span><br><span class="line">character-<span class="built_in">set</span>-sever utf8</span><br><span class="line">sql_mode NO_ENGIN_SUBSITUTION,STRICT_TRANS_TABLES</span><br><span class="line">a test</span><br><span class="line">test1 <span class="number">123</span></span><br><span class="line">test2 abc</span><br><span class="line">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line"><span class="number">123</span> &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">124 &lt;<span class="title">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h2><h3 id="为什么要序列化"><a href="#为什么要序列化" class="headerlink" title="为什么要序列化"></a>为什么要序列化</h3><p>内存中的字典，链表如何保存到一个文件中 ？<br>如果是自己定义的类的实例，如何保存到一个文件中？<br>如何从文件中读取数据，并让它们的内存中再次变成自己对应的类的实例 ？</p>
<p>要设计一套协议，按照某种规则，把内存中数据保存到文件中。文件是一个字节序列，所以必须把数据转换成字节序列，输出到文件。这就是序列化。反之，从文件的字节序列恢复到内存，就是反序列化。</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>serialization序列化<br>将内存中的对象存储下来，把它变成一个个字节。 -&gt; 二进制</p>
<p>deserialization反序列化<br>将文件中的一个个字恢复成内存中对象。 &lt;- 二进制</p>
<p>序列化保存到文件 就是持久化;<br>可以将数据序列化后持久化，或者网络传输；也可以将从文件中或者网络接收到的字节序列反序列化;</p>
<p>Python提供了pickle库。</p>
<h3 id="pickle库"><a href="#pickle库" class="headerlink" title="pickle库"></a>pickle库</h3><p>Python中的序列化、反序列化模块;<br>dumps对象序列化;<br>dump对象列化到文件对象，就是存入文件;<br>loads 对象反序列化;<br>load 对象反序列化，从文件读取数据 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">lst = <span class="string">&#x27;a b c&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">d = <span class="built_in">dict</span>(<span class="built_in">zip</span>(<span class="string">&#x27;abc&#x27;</span>,<span class="built_in">range</span>(<span class="number">3</span>)))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        a = <span class="string">&#x27;abcdefghijklmn1230456789&#x27;</span></span><br><span class="line">        print(a)</span><br><span class="line"></span><br><span class="line">aa = AA()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./bin&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># pickle.dump(lst,f)</span></span><br><span class="line">    <span class="comment"># pickle.dump(d,f)</span></span><br><span class="line">    pickle.dump(aa,f)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./bin&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    tmp = pickle.load(f)</span><br><span class="line">    print(<span class="built_in">type</span>(tmp))</span><br><span class="line">    tt = tmp</span><br><span class="line">    tmp.show()</span><br></pre></td></tr></table></figure>
<p>文件序列化和反序列化 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;bin&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    t = pickle.load(f)</span><br><span class="line">    t.show()</span><br></pre></td></tr></table></figure>
<h3 id="对象序列化"><a href="#对象序列化" class="headerlink" title="对象序列化"></a>对象序列化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span>:</span></span><br><span class="line">    tttt = <span class="string">&#x27;ABC&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;abc&#x27;</span>)</span><br><span class="line">a1 = AA()</span><br><span class="line">sr = pickle.dumps(a1)</span><br><span class="line">print(<span class="string">&#x27;sr=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(sr)) <span class="comment"># AA</span></span><br><span class="line"></span><br><span class="line">a2 = pickle.loads(sr)</span><br><span class="line">print(a2.tttt)</span><br><span class="line">a2.show()</span><br></pre></td></tr></table></figure>
<p>上面的例子中，其实就保存了一个类名，因为所有的东西都是类定义的东西，是不变的，所以只序列化一个AA类名。反序列化的时候找到类可以恢复一个对象。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__ini__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.tttt = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line">b1 = AAA()</span><br><span class="line"></span><br><span class="line">sr = pickle.dumps(bs)</span><br><span class="line">print(<span class="string">&#x27;sr=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(sr))</span><br><span class="line">b2 = pickle.loads(sr)</span><br><span class="line">print(b2.tttt)</span><br></pre></td></tr></table></figure>
<p>可以看出，保存了AAA、ttt 和abc，因为每一个对象每次都是变化的。但是反序列化的时候要找到AAA类的定义，才能成功。否则会抛出异常;<br>这样可以理解，反序列化的时候，类是模子，二进制序列就是铁水。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>本地序列化的情况应用较少；<br>一般来说大多场景都应用在网络中。将数据序列化通过网络传输到远程节点，远程服务器上的接收到数据反序列化后，就可以使用了;<br>但是，要注意一点，远程接收端，反序列化时必须有对应的数据类型，否则就会报错。尤其是自定义类型，必须远程得有。</p>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AA</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.tttt = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line">aaa = AA()</span><br><span class="line">sr = pickle.dumps(aaa)</span><br><span class="line">print(<span class="built_in">len</span>(sr))</span><br><span class="line"></span><br><span class="line">file = <span class="string">&#x27;./ser&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(aaa,f)</span><br></pre></td></tr></table></figure>
<p>将生产的充列化文件发往其它节点，运行:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;ser&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    a = pickle.load(f) </span><br></pre></td></tr></table></figure>
<p>增加类定义即可解决<br>现在大多数项目，都不是单机的，也不是单服务的，需要通过网络数据传送到其它节点上去，这就需要大量的序列化，反序列化。</p>
<p>但是，问题是，Python 程序之间还可以通过pickle解决序列化、反序列化，如果是跨平台、跨语言、跨协议pickle就不太合适了，就需要共公的协议。 如XML、Json、ProtocolBuffer 等。</p>
<p>不同的协议，效率不同，学习曲线不同，适用的场景不同，要根据不同情况造型。</p>
<h2 id="Json"><a href="#Json" class="headerlink" title="Json"></a>Json</h2><p>Json(Javascript Object Notation JS标记对象)， 是一种轻量级的数据交互格式。它基于ECMASciprt(w3c制定的JS规范)的一个子集。采用完全独立的编程语言文本格式来存储和表示数据;</p>
<h3 id="Json-数据类型"><a href="#Json-数据类型" class="headerlink" title="Json 数据类型"></a>Json 数据类型</h3><p>值<br>双引号引起来的字符串，数值。 True和False,null,对象,数组这些都是值；</p>
<p><img src="/images/json-value.png" class="lazyload" data-srcset="/images/json-value.png" srcset="data:image/png;base64,666" alt=""></p>
<p><strong>字符串</strong><br>由双引号包围起来的任意符号组合，可以有转义符;</p>
<p><strong>数值</strong><br>有负数、有整数、有浮点数;</p>
<p><strong>对象</strong><br>无序的健值对的组合;<br>格式<code>&#123;key:vluae1 ,...,key:vlualen&#125;</code><br>key 必须是一个字符串，需要双引号包围这个字符串;<br>value 可以是任意合法的值;</p>
<p><img src="/images/json-object.png" class="lazyload" data-srcset="/images/json-object.png" srcset="data:image/png;base64,666" alt=""></p>
<p><strong>数组</strong></p>
<p>有序的值的集合<br>格式:[val1,…,valn]</p>
<p><img src="/images/json-array.png" class="lazyload" data-srcset="/images/json-array.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;persion&quot;</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;n&quot;</span>: <span class="string">&quot;tom&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;a&quot;</span>: <span class="number">18</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;n&quot;</span>: <span class="string">&quot;jerry&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: <span class="number">16</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ben&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: <span class="number">24</span></span><br><span class="line">  &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;total&quot;</span>:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h3 id="Python-与-Json"><a href="#Python-与-Json" class="headerlink" title="Python 与 Json"></a>Python 与 Json</h3><p>Python支持少量内建数据类型到Json类型的转换。</p>
<table>
<thead>
<tr>
<th>Python类型</th>
<th>Json类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>True</td>
<td>True</td>
</tr>
<tr>
<td>False</td>
<td>false</td>
</tr>
<tr>
<td>None</td>
<td>null</td>
</tr>
<tr>
<td>str</td>
<td>string</td>
</tr>
<tr>
<td>int</td>
<td>integer</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
</tr>
</tbody>
</table>
<h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><p><strong>dumps json编码</strong></p>
<p>dumps json编码并存入文件<br>loads json解码<br>load json解码，从文件读取数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">d = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:<span class="string">&#x27;20&#x27;</span>,<span class="string">&#x27;interset&#x27;</span>:[<span class="string">&#x27;music&#x27;</span>,<span class="string">&#x27;movie&#x27;</span>],<span class="string">&#x27;e&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;f&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">j = json.dumps(d)</span><br><span class="line">print(j)</span><br><span class="line"></span><br><span class="line">d1 = json.loads(j)</span><br><span class="line">print(d1)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="string">&quot;20&quot;</span>, <span class="string">&quot;interset&quot;</span>: [<span class="string">&quot;music&quot;</span>, <span class="string">&quot;movie&quot;</span>], <span class="string">&quot;e&quot;</span>: false, <span class="string">&quot;f&quot;</span>: null&#125;</span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;interset&#x27;</span>: [<span class="string">&#x27;music&#x27;</span>, <span class="string">&#x27;movie&#x27;</span>], <span class="string">&#x27;e&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;f&#x27;</span>: <span class="literal">None</span>&#125;</span><br></pre></td></tr></table></figure>
<p>一般json编码的数据很少落地，数据都是通过网络传输。传输的时候，要考虑压缩它;<br>本质上来说 它就是个文本，就是个字符串;<br>json很简单，几乎语言编程都支持json，所以应用范围十分广泛。</p>
<h2 id="MesagePack"><a href="#MesagePack" class="headerlink" title="MesagePack"></a>MesagePack</h2><p>MessagePack 是一个基于二进制高效的对象序列化类库，可用于跨语言通信;<br>它可以像Json那样，在许多语言之间交换数据对象;<br>但是它比Json更快速也更轻巧;<br>支持Python、Ruby、 Java、 C/C++ 等众多语言。宣称比Google Protocol Buffer 还要快4倍;<br>兼容Json和pickle。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><code>pip install msgpack-python</code></p>
<h3 id="常用方法-1"><a href="#常用方法-1" class="headerlink" title="常用方法"></a>常用方法</h3><p>packb 序列化对象。提供了dumps来兼容pickle和json;<br>unpackb 反充列化对象。提供了loads 来兼容;<br>pack序列化对象保存到文件对象，提供了dump 来兼容;<br>unpack 反序列化对象保存到文件对象，提供laod来兼容。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> msgpack</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">js = <span class="string">&#x27;&#123;&quot;person&quot;:[&#123;&quot;name&quot;:&quot;tom&quot;,&quot;age&quot;:10&#125;,&#123;&quot;name&quot;:&quot;jerry&quot;,&quot;age&quot;:16&#125;,&#123;&quot;name&quot;:&quot;ben&quot;,&quot;age&quot;:24&#125;],&quot;total&quot;:2&#125;&#x27;</span></span><br><span class="line">d = json.loads(js)</span><br><span class="line">print(d)</span><br><span class="line">msg = msgpack.packb(d)</span><br><span class="line">print(<span class="built_in">len</span>(msg))</span><br><span class="line">print(msg)</span><br><span class="line">bts = msgpack.unpackb(msg)</span><br><span class="line">print(<span class="built_in">type</span>(bts))</span><br><span class="line">print(bts)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&#123;<span class="string">&#x27;person&#x27;</span>: [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;tom&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">10</span>&#125;, &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;jerry&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">16</span>&#125;, &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;ben&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">24</span>&#125;], <span class="string">&#x27;total&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="number">63</span></span><br><span class="line"><span class="string">b&#x27;\x82\xa6person\x93\x82\xa4name\xa3tom\xa3age\n\x82\xa4name\xa5jerry\xa3age\x10\x82\xa4name\xa3ben\xa3age\x18\xa5total\x02&#x27;</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">dict</span>&#x27;&gt;</span></span><br><span class="line">&#123;b&#x27;person&#x27;: [&#123;b&#x27;name&#x27;: b&#x27;tom&#x27;, b&#x27;age&#x27;: 10&#125;, &#123;b&#x27;name&#x27;: b&#x27;jerry&#x27;, b&#x27;age&#x27;: 16&#125;, &#123;b&#x27;name&#x27;: b&#x27;ben&#x27;, b&#x27;age&#x27;: 24&#125;], b&#x27;total&#x27;: 2&#125;</span><br></pre></td></tr></table></figure>
<p>MessagePack简单易，高效压缩，支持语言丰富;<br>所以，用它序列化也是一种很好的选择;</p>
<h3 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h3><p><strong>做一个出乎意料的决定:”好汉打脱呀和血吞”。这是一句湖南的土话，好汉被打家打掉了牙，不要吐出来让别人看到，要咽到肚子里，继续战斗。他不再和长沙官场纠缠争辩，而是卷起铺盖，带着自己募来的湘军。前往僻静的衡阳。全省官员都瞧不起我，我不争一日之短长。等到我在衡阳练成一支劲旅，打几个胜仗给你们看看，那时自会分出高。这才是挽回面子的最好办法–即逆境时不暴露也不让人看到，冷嘲热讽时也不争一日之短长，不争乃大争</strong></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 文件的IO二</title>
    <url>/2020/09/17/python%E6%96%87%E4%BB%B6%E7%9A%84IO%E4%BA%8C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-文件的IO一"><a href="#python-文件的IO一" class="headerlink" title="python 文件的IO一"></a>python 文件的IO一</h1><p><img src="/images/python-file-io-01.jpg" class="lazyload" data-srcset="/images/python-file-io-01.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>有一个文件，对其进行单词统计，不区分大小写，并显示单词重复最多的10个单词</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 第一次处理</span></span><br><span class="line"><span class="comment"># os.path /usr/local/lib &#x27;/usr/local/lib&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wordcount</span>(<span class="params">file=<span class="string">&#x27;sample.txt&#x27;</span></span>):</span></span><br><span class="line">    chars = <span class="string">&#x27;&#x27;&#x27;~!@#$%^&amp;*()_+&#123;&#125;[]|\\/&quot;&#x27;=;:.-&lt;&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        word_count = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            words = line.split()</span><br><span class="line">            <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">zip</span>(words,(<span class="number">1</span>,)*<span class="built_in">len</span>(words)):</span><br><span class="line">                k  = k.strip(chars)</span><br><span class="line">                k = k.lower()</span><br><span class="line">                word_count[k] = word_count.get(k,<span class="number">0</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    lst = <span class="built_in">sorted</span>(word_count.items(), key=<span class="keyword">lambda</span>  x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        print(<span class="built_in">str</span>(lst[i]).strip(<span class="string">&quot;&#x27;()&quot;</span>).replace(<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> lst</span><br><span class="line"></span><br><span class="line">wordcount()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">the, <span class="number">5</span></span><br><span class="line">a, <span class="number">5</span></span><br><span class="line">can, <span class="number">3</span></span><br><span class="line">download, <span class="number">3</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">for</span>, <span class="number">3</span></span><br><span class="line">version, <span class="number">2</span></span><br><span class="line">these, <span class="number">2</span></span><br><span class="line"><span class="keyword">in</span>, <span class="number">2</span></span><br><span class="line">this, <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>第二次改进</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wordcount</span>(<span class="params">file=<span class="string">&#x27;sample.txt&#x27;</span></span>):</span></span><br><span class="line">    chars = <span class="string">&#x27;&#x27;&#x27;~!@#$%^&amp;*()_+&#123;&#125;[]|\\/&quot;&#x27;=;:.-&lt;&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">    charset = <span class="built_in">set</span>(chars)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        word_count = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            words = line.split()</span><br><span class="line">            <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">zip</span>(words,(<span class="number">1</span>,)*<span class="built_in">len</span>(words)):</span><br><span class="line">                k  = k.strip(chars)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(k) &lt; <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                k = k.lower()</span><br><span class="line">                start = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(k):</span><br><span class="line">                    <span class="keyword">if</span> c <span class="keyword">in</span> charset:</span><br><span class="line">                        <span class="keyword">if</span> start ==i :</span><br><span class="line">                            start = i +<span class="number">1</span></span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        key = k[start:i]</span><br><span class="line">                        word_count[key] = word_count.get(key,<span class="number">0</span>) +<span class="number">1</span></span><br><span class="line">                        start = i + <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    key = k[start:]</span><br><span class="line">                    word_count[key] = word_count.get(key,<span class="number">0</span>) +<span class="number">1</span></span><br><span class="line">                print()</span><br><span class="line"></span><br><span class="line">    lst = <span class="built_in">sorted</span>(word_count.items(), key=<span class="keyword">lambda</span>  x:x[<span class="number">1</span>],reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">if</span> i &lt; <span class="built_in">len</span>(lst):</span><br><span class="line">            print(<span class="built_in">str</span>(lst[i]).strip(<span class="string">&quot;&#x27;()&quot;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> lst</span><br><span class="line"></span><br><span class="line">wc = wordcount()</span><br><span class="line">print(wc)</span><br><span class="line">print(<span class="built_in">len</span>(wc))</span><br><span class="line">the, <span class="number">5</span></span><br><span class="line">a, <span class="number">5</span></span><br><span class="line">can, <span class="number">3</span></span><br><span class="line">download, <span class="number">3</span></span><br><span class="line"><span class="keyword">and</span>, <span class="number">3</span></span><br><span class="line"><span class="keyword">for</span>, <span class="number">3</span></span><br><span class="line">version, <span class="number">2</span></span><br><span class="line">these, <span class="number">2</span></span><br><span class="line"><span class="keyword">in</span>, <span class="number">2</span></span><br><span class="line">this, <span class="number">2</span></span><br><span class="line">[(<span class="string">&#x27;the&#x27;</span>, <span class="number">5</span>), (<span class="string">&#x27;a&#x27;</span>, <span class="number">5</span>), (<span class="string">&#x27;can&#x27;</span>, <span class="number">3</span>), (<span class="string">&#x27;download&#x27;</span>, <span class="number">3</span>), (<span class="string">&#x27;and&#x27;</span>, <span class="number">3</span>), (<span class="string">&#x27;for&#x27;</span>, <span class="number">3</span>), (<span class="string">&#x27;version&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;these&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;in&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;this&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;to&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;as&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;new&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;of&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;changes,&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;with&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;linux&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;common&#x27;</span>, <span class="number">2</span>), (<span class="string">&#x27;control&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;systems&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;keep&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;revisions&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;straight,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;storing&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;modifications&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;central&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;repository&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;allows&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;developers&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;easily&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;collaborate,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;they&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;software,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;make&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;upload&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;newest&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;revision&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;every&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;developer&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;see&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;them,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;contribute&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;similarly,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;people&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;who&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;have&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;nothing&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;do&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;development&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;project&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;still&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;files&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;use&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;them&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;most&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;users&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;should&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;be&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;familiar&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;process,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;using&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;git,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;subversion,&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;or&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;some&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;other&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;similar&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;method&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;is&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;pretty&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;downloading&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;needed&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;files—especially&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;preparation&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;compiling&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;program&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;from&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;source&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;code&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;rather&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;practice&#x27;</span>, <span class="number">1</span>), (<span class="string">&#x27;geeks&#x27;</span>, <span class="number">1</span>)]</span><br><span class="line"><span class="number">82</span></span><br></pre></td></tr></table></figure>
<h2 id="StringIO"><a href="#StringIO" class="headerlink" title="StringIO"></a>StringIO</h2><ul>
<li>io 模块中的类;</li>
<li>from io import StringIO;</li>
<li>内存中，开辟的一个文本模式的buffer, 可以像文件对象一样操作它：</li>
<li>当close方法被调用的时候，这个buffer会被释放。</li>
</ul>
<h2 id="StringIO操作"><a href="#StringIO操作" class="headerlink" title="StringIO操作"></a>StringIO操作</h2><ul>
<li>getvalue() 获取全部内容。跟文件指针没有关系;</li>
</ul>
<p>用法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"></span><br><span class="line">sio = StringIO()</span><br><span class="line">print(sio.readable(),sio.writable(),sio.seekable())</span><br><span class="line">sio.write(<span class="string">&quot;asjin.com\npython&quot;</span>)</span><br><span class="line">sio.seek(<span class="number">0</span>)</span><br><span class="line">print(sio.readlines())</span><br><span class="line">print(sio.getvalue())</span><br><span class="line">print()</span><br><span class="line">sio.seek(<span class="number">0</span>)</span><br><span class="line">print(sio.read())</span><br><span class="line">sio.close()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="literal">True</span> <span class="literal">True</span> <span class="literal">True</span></span><br><span class="line">[<span class="string">&#x27;asjin.com\n&#x27;</span>, <span class="string">&#x27;python&#x27;</span>]</span><br><span class="line">asjin.com</span><br><span class="line">python</span><br><span class="line">asjin.com</span><br><span class="line">python</span><br></pre></td></tr></table></figure>
<ul>
<li>好处</li>
<li>一般来说，磁盘的操作比内存的操作要慢得多，内存足够的情况下，一般的优化思路是少落地，减少磁盘IO的过程，可以大大提高程序的运行效率。</li>
</ul>
<h2 id="BytesIO"><a href="#BytesIO" class="headerlink" title="BytesIO"></a>BytesIO</h2><ul>
<li>io模块中的类</li>
<li><code>from io import BytesIO</code></li>
<li>内存中，开辟一个二进制模式的buffer，可以像文件对象一样操作它;</li>
<li>当close方法被调用的时候，这个buffer会被释放。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO <span class="comment"># 内存中构建</span></span><br><span class="line">bio = BytesIO()</span><br><span class="line">print(bio.readable(),bio.writable(),bio.seekable())</span><br><span class="line">bio.write(<span class="string">b&quot;ssjinyao.com\nPython&quot;</span>)</span><br><span class="line">bio.seek(<span class="number">0</span>)</span><br><span class="line">print(bio.readlines())</span><br><span class="line">print(bio.getvalue()) <span class="comment"># 无视指针，输出全部内容</span></span><br><span class="line">bio.close()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="literal">True</span> <span class="literal">True</span> <span class="literal">True</span></span><br><span class="line">[<span class="string">b&#x27;ssjinyao.com\n&#x27;</span>, <span class="string">b&#x27;Python&#x27;</span>]</span><br><span class="line"><span class="string">b&#x27;ssjinyao.com\nPython&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="file-like-对象"><a href="#file-like-对象" class="headerlink" title="file-like 对象"></a>file-like 对象</h2><ul>
<li>类文件对象，可以像文件对象一样操作;</li>
<li>sock对象、输入输出对象(stdin、stdout)都是类文件对象;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdout</span><br><span class="line">f = stdout</span><br><span class="line">print(<span class="built_in">type</span>(f))</span><br><span class="line">f.write(<span class="string">&#x27;asjin.com&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="os-path-模块"><a href="#os-path-模块" class="headerlink" title="os.path 模块"></a>os.path 模块</h2><p>python3.4 之前</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line">p = path.join(<span class="string">&#x27;/etc&#x27;</span>,<span class="string">&#x27;hosts&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(p),p)</span><br><span class="line">print(path.exists(p))</span><br><span class="line">print(path.split(p))</span><br><span class="line">print(path.abspath(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line">p = path.join(<span class="string">&#x27;o://&#x27;</span>,p,<span class="string">&#x27;test.txt&#x27;</span>)</span><br><span class="line">print(path.dirname(p))</span><br><span class="line">print(path.basename(p))</span><br><span class="line">print(path.splitdrive(p))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt; /<span class="title">etc</span>/<span class="title">hosts</span></span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line"><span class="class">(<span class="params"><span class="string">&#x27;/etc&#x27;</span>, <span class="string">&#x27;hosts&#x27;</span></span>)</span></span><br><span class="line"><span class="class">/<span class="title">Users</span>/<span class="title">ssjinyao</span>/<span class="title">Desktop</span>/<span class="title">MyPython</span>/<span class="title">testpy</span>/<span class="title">kernel</span></span></span><br><span class="line"><span class="class">/<span class="title">etc</span>/<span class="title">hosts</span></span></span><br><span class="line"><span class="class"><span class="title">test</span>.<span class="title">txt</span></span></span><br><span class="line"><span class="class">(<span class="params"><span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/etc/hosts/test.txt&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="3-4版本开始"><a href="#3-4版本开始" class="headerlink" title="3.4版本开始"></a>3.4版本开始</h3><p>建议使用pathlib模块，提供Path对象来操作。包括目录和文件；</p>
<h3 id="pathlib模块"><a href="#pathlib模块" class="headerlink" title="pathlib模块"></a>pathlib模块</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">In [<span class="number">2</span>]: p = Path()</span><br><span class="line">In [<span class="number">3</span>]: <span class="built_in">type</span>(p)</span><br><span class="line">Out[<span class="number">3</span>]: pathlib.PosixPath</span><br></pre></td></tr></table></figure>
<p>实现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">In [<span class="number">2</span>]: p = Path()</span><br><span class="line">In [<span class="number">3</span>]: <span class="built_in">type</span>(p)</span><br><span class="line">Out[<span class="number">3</span>]: pathlib.PosixPath</span><br><span class="line">In [<span class="number">4</span>]: p.absolute()</span><br><span class="line">Out[<span class="number">4</span>]: PosixPath(<span class="string">&#x27;/root/mypython/python3&#x27;</span>)</span><br><span class="line">In [<span class="number">5</span>]: p.joinpath(<span class="string">&#x27;as&#x27;</span>,<span class="string">&#x27;jin&#x27;</span>)</span><br><span class="line">Out[<span class="number">5</span>]: PosixPath(<span class="string">&#x27;as/jin&#x27;</span>)</span><br><span class="line">In [<span class="number">6</span>]: p.absolute()</span><br><span class="line">Out[<span class="number">6</span>]: PosixPath(<span class="string">&#x27;/root/mypython/python3&#x27;</span>)</span><br><span class="line">In [<span class="number">7</span>]: p = p.joinpath(<span class="string">&#x27;as&#x27;</span>,<span class="string">&#x27;jin&#x27;</span>)</span><br><span class="line">In [<span class="number">8</span>]: p.absolute()</span><br><span class="line">Out[<span class="number">8</span>]: PosixPath(<span class="string">&#x27;/root/mypython/python3/as/jin&#x27;</span>)</span><br><span class="line">In [<span class="number">9</span>]: p = p / <span class="string">&#x27;a&#x27;</span> / <span class="string">&#x27;b&#x27;</span></span><br><span class="line">In [<span class="number">10</span>]: p.absolute()</span><br><span class="line">Out[<span class="number">10</span>]: PosixPath(<span class="string">&#x27;/root/mypython/python3/as/jin/a/b&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>拼接 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">13</span>]: p2 = Path(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">In [<span class="number">14</span>]: p2 = p2 / <span class="string">&#x27;/etc/&#x27;</span> / <span class="string">&#x27;sysconfig&#x27;</span></span><br><span class="line">In [<span class="number">15</span>]: p2</span><br><span class="line">Out[<span class="number">15</span>]: PosixPath(<span class="string">&#x27;/etc/sysconfig&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>路径拼接和分解<br><strong>操作符/</strong><br>Path对象/ Path对象<br>Path对象/ 字符串或者字符串 / Path 对象<br><strong>分解</strong><br>parts 属性， 可以返回路径中的每一个部分<br>joinpath<br>joinpath(*other)连接多个字符串到Path对象中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">16</span>]: p = Path()</span><br><span class="line">In [<span class="number">17</span>]: p = p / <span class="string">&#x27;a&#x27;</span></span><br><span class="line">In [<span class="number">18</span>]: p1 = <span class="string">&#x27;b&#x27;</span> / p</span><br><span class="line">In [<span class="number">19</span>]: p2 = Path(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">In [<span class="number">20</span>]: p3 = p2 / p1</span><br><span class="line">In [<span class="number">21</span>]: print(p3.parts)</span><br><span class="line">(<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">In [<span class="number">22</span>]: p3.joinpath(<span class="string">&#x27;etc&#x27;</span>,<span class="string">&#x27;init.d&#x27;</span>,Path(<span class="string">&#x27;httpd&#x27;</span>))</span><br><span class="line">Out[<span class="number">22</span>]: PosixPath(<span class="string">&#x27;c/b/a/etc/init.d/httpd&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>获取路径<br>str获取路径字符串<br>bytes获取路径字符串的bytes</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">24</span>]: p = Path(<span class="string">&#x27;/etc&#x27;</span>)</span><br><span class="line">In [<span class="number">25</span>]: print(<span class="built_in">str</span>(p),<span class="built_in">bytes</span>(p))</span><br><span class="line">/etc <span class="string">b&#x27;/etc&#x27;</span></span><br></pre></td></tr></table></figure>
<p>parent 目录的逻辑父目录<br>parents 父目录序列，索引|0是直接父</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p =Path(<span class="string">&#x27;/a/b/c/d&#x27;</span>)</span><br><span class="line">In [<span class="number">29</span>]: p = Path(<span class="string">&#x27;/a/b/c/d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">30</span>]: print(p.parent.parent)</span><br><span class="line">/a/</span><br><span class="line">In [<span class="number">31</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> p.parents:</span><br><span class="line">    ...:     print(x)</span><br><span class="line">    ...:</span><br><span class="line">/a/b/c</span><br><span class="line">/a/b</span><br><span class="line">/a</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<p>name、stem、 suffix、 suffixes、 with_suffix(suffix)、with_name(name)<br>name 目录的最后一个部分<br>suffix 目录中最后一个部分的扩展名<br>stem 目录最后一个部分，没有后缀<br>suffixes 返回多个扩展名列表<br>with_suffix(suffix)补充扩展名到路径尾部，返回新的路径，扩展名存在则无效;<br>with_name(name) 替换目录最后一个部分并返回一个新的路径。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">33</span>]: p4 = Path(<span class="string">&#x27;/etc/sysconfig/network/xx.ifg.gz&#x27;</span>)</span><br><span class="line">In [<span class="number">34</span>]: p4.name</span><br><span class="line">Out[<span class="number">34</span>]: <span class="string">&#x27;xx.ifg.gz&#x27;</span></span><br><span class="line">In [<span class="number">35</span>]: p4.stem</span><br><span class="line">Out[<span class="number">35</span>]: <span class="string">&#x27;xx.ifg&#x27;</span></span><br><span class="line">In [<span class="number">36</span>]: p4.suffix</span><br><span class="line">Out[<span class="number">36</span>]: <span class="string">&#x27;.gz&#x27;</span></span><br><span class="line">In [<span class="number">39</span>]: p4.suffixes</span><br><span class="line">Out[<span class="number">39</span>]: [<span class="string">&#x27;.ifg&#x27;</span>, <span class="string">&#x27;.gz&#x27;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">40</span>]: p4.with_suffix(<span class="string">&#x27;.tgz&#x27;</span>)</span><br><span class="line">Out[<span class="number">40</span>]: PosixPath(<span class="string">&#x27;/etc/sysconfig/network/xx.ifg.tgz&#x27;</span>)</span><br><span class="line">In [<span class="number">41</span>]: p4.with_name(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">Out[<span class="number">41</span>]: PosixPath(<span class="string">&#x27;/etc/sysconfig/network/test&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>cwd() 返回当前工作目录;<br>home() 返回当前家目录;</p>
<p>is_dir() 是否是目录;<br>is_file() 是滞是普通文件;<br>is_symlink() 是否是软链接;<br>is_socket() 是否是socket文件;<br>is_block_device() 是否是块设备;<br>is_char_device() 是否是字符设备;<br>is_absolute() 是否是绝对路径;</p>
<p>resove() 返回一个新的路径，这个新路径就是当前Path对象的绝对路径，如果是软链接则直接被解析;<br>absolute() 也可以获取绝对路径，但是推荐使用resolve();<br>exists() 目录或文件是否存在;<br>remdir() 删除空目录。没有提供判断目录为空的方法;<br>touch(mode=0o666,exist_ok=True)创建一个文件;<br>as_uri() 将路径返回成URL，例如’file:///etc/passwd’<br>mkdir(mode=0o777,parents=False,exist_ok=False)<br>parents, 是否创建父目录，True等同于mkdir -p; False时父目录不存在，则抛出;<br>FileNotFoundError<br>exist_ok参数，在3.5版本加入。False时，路径存在，抛出FileExistsError; True 时FileExistsError被忽略；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">3</span>]: p =Path(<span class="string">&#x27;/a/b/c/d&#x27;</span>)</span><br><span class="line">In [<span class="number">4</span>]: p.home()</span><br><span class="line">Out[<span class="number">4</span>]: PosixPath(<span class="string">&#x27;/root&#x27;</span>)</span><br><span class="line">In [<span class="number">5</span>]: p.is_dir()</span><br><span class="line">Out[<span class="number">5</span>]: <span class="literal">False</span></span><br><span class="line">In [<span class="number">6</span>]: p.is_absolute()</span><br><span class="line">Out[<span class="number">6</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">7</span>]: p.absolute().parent</span><br><span class="line">Out[<span class="number">7</span>]: PosixPath(<span class="string">&#x27;/a/b/c&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>iterdir()<br>迭代当前目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">12</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> Path().iterdir():</span><br><span class="line">    ...:     <span class="keyword">if</span> x.is_dir():</span><br><span class="line">    ...:         print(x)</span><br><span class="line">.ipynb_checkpoints</span><br></pre></td></tr></table></figure>
<p>通配符</p>
<p>glob(pattern)通配给定的模式<br>rglob(pattern)通配给定的模式，递归目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(p.glob(<span class="string">&#x27;test*&#x27;</span>)) <span class="comment"># 返回当前目录对象下的test开头的文件</span></span><br><span class="line"><span class="built_in">list</span>(p.glob(<span class="string">&#x27;**/*.py&#x27;</span>)) <span class="comment"># 递归所有目录，等同rglob</span></span><br><span class="line"><span class="built_in">list</span>(p.rglob(<span class="string">&#x27;*.py&#x27;</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">In [<span class="number">2</span>]: <span class="built_in">list</span>(Path().glob(<span class="string">&#x27;*.py&#x27;</span>))</span><br><span class="line">Out[<span class="number">2</span>]:</span><br><span class="line"> PosixPath(<span class="string">&#x27;random_max_min2.py&#x27;</span>),</span><br></pre></td></tr></table></figure>
<p>匹配<br><strong>match(pattern)</strong><br>模式匹配，成功返回True</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: Path(<span class="string">&#x27;.py&#x27;</span>).match(<span class="string">&#x27;*.py&#x27;</span>)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">5</span>]: Path(<span class="string">&#x27;/a/b/c.py&#x27;</span>).match(<span class="string">&#x27;b/*.py&#x27;</span>)</span><br><span class="line">Out[<span class="number">5</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">6</span>]: Path(<span class="string">&#x27;/a/b/c.py&#x27;</span>).match(<span class="string">&#x27;a/*.py&#x27;</span>)</span><br><span class="line">Out[<span class="number">6</span>]: <span class="literal">False</span></span><br><span class="line">In [<span class="number">7</span>]: Path(<span class="string">&#x27;/a/b/c.py&#x27;</span>).match(<span class="string">&#x27;a/*/*.py&#x27;</span>)</span><br><span class="line">Out[<span class="number">7</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">8</span>]: Path(<span class="string">&#x27;/a/b/c.py&#x27;</span>).match(<span class="string">&#x27;a/**/*.py&#x27;</span>)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">9</span>]: Path(<span class="string">&#x27;/a/b/c.py&#x27;</span>).match(<span class="string">&#x27;**/*.py&#x27;</span>)</span><br><span class="line">Out[<span class="number">9</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p><strong>open(mode=’r’,buffering=-1,encoding=None, errors=None,newline=None)</strong><br>使用的方法类似内建函数open。返回一个文件对象</p>
<p>3.5 增加的新函数<br><strong>read_bytes()</strong><br>以’rb’ 读取路径对应文件，并返回二进制流;</p>
<p><strong>Path.write_bytes(date)</strong><br>以’wb’ 方式写入数据到路径对应文件;</p>
<p><strong>write_text(data,enconding=None,errors=None)</strong><br>以’wt’方式写入字符串到路径对应文件;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: p4 = Path(<span class="string">&#x27;/root/testfile&#x27;</span>)</span><br><span class="line">In [<span class="number">11</span>]: p4.<span class="built_in">open</span>(<span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line">Out[<span class="number">11</span>]: &lt;_io.TextIOWrapper name=<span class="string">&#x27;/root/testfile&#x27;</span> mode=<span class="string">&#x27;w+&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>&gt;</span><br><span class="line">In [<span class="number">12</span>]: p4.touch()</span><br><span class="line">In [<span class="number">13</span>]: <span class="keyword">with</span> p4.<span class="built_in">open</span>(<span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    ...:     f.write(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">14</span>]: f.closed</span><br><span class="line"><span class="comment"># 可以直接写入</span></span><br><span class="line">In [<span class="number">15</span>]: p4.write_text(<span class="string">&#x27;test_write_text&#x27;</span>)</span><br><span class="line">In [<span class="number">17</span>]: p4.read_text()</span><br><span class="line">Out[<span class="number">17</span>]: <span class="string">&#x27;test_write_text&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line">p = Path(<span class="string">&#x27;/etc/config.py&#x27;</span>)</span><br><span class="line">p.write_text(<span class="string">&#x27;workprocess=16&#x27;</span>)</span><br><span class="line">print(p.read_text())</span><br><span class="line"><span class="keyword">with</span> p.<span class="built_in">open</span>() <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>
<h2 id="os模块"><a href="#os模块" class="headerlink" title="os模块"></a>os模块</h2><p>os.name  windows是nt，linux 是posix;<br>os.uname() Linux支持显示;<br>sys.platform windows 显示32，Linux是Linux<br>os.listdir(‘/etc’)<br>返回目录内容列表。<br>os 也有open、 read、 write 等方法，但是太低级，建议使用内建函数open、read、 write;<br>调用Linux系统的stat;<br>path: 路径的sting 或者bytes, 或者fd<br>follow symlinks True 返回文件本身信息，False如果是软链接则显示软链接本身;</p>
<p><strong>os.chmod(path,mode,*,dir_fd=None, follow_symlinks=True)</strong><br><strong>os.chmod(‘test’,0o777)</strong><br><strong>os.chown(path,uid,gid)</strong><br>改变文件的属主、属组，但需要足够的权限</p>
<h2 id="shutil-模块"><a href="#shutil-模块" class="headerlink" title="shutil 模块"></a>shutil 模块</h2><p>到目前为止<br>文件拷贝：使用打开2个文件对象，源文件读取内容，写入目标文件中来完成拷贝过程。但是这样丢失stat数据信息(权限等)，因为根本就没有复制过去。<br>目录怎么办呢 ？<br>Python提供了一个方便的库shutil(高级文件操作)。</p>
<h2 id="copy复制"><a href="#copy复制" class="headerlink" title="copy复制"></a>copy复制</h2><p><strong>copyfileobj(fsrc,fdst[,length])</strong></p>
<p>文件对象的复制，fsrc和fdst 是open打开的文件对象，复制内容。fdst要求可写。<br>length指定了表示buffer的大小;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = Path(<span class="string">&#x27;./test&#x27;</span>)</span><br><span class="line">p1.touch()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./test&#x27;</span>,<span class="string">&#x27;r+&#x27;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">    f1.write(<span class="string">&#x27;abcd\n asjin&#x27;</span>)</span><br><span class="line">    f1.flush()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./test1&#x27;</span>,<span class="string">&#x27;w+&#x27;</span>) <span class="keyword">as</span> f2:</span><br><span class="line">        shutil.copyfileobj(f1,f2)</span><br><span class="line">(py3_env) testpy ➤ cat kernel/test                                                                                                                                                      </span><br><span class="line">abcd</span><br><span class="line">asjin%                                                                                                                                                       (py3_env) testpy ➤ cat kernel/test1   </span><br></pre></td></tr></table></figure>
<p><strong>copyfile(src,dst,*,follow_symlinks=True)</strong><br>复制文件内容，不含元数据。src、dst为文件的路径字符串;<br>本质上调用的就是copyfileobj，所以不带元数据二进制内容复制;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line">shutil.copyfile(<span class="string">&#x27;./test&#x27;</span>,<span class="string">&#x27;./test2&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>copymode(src,dst,*,follow_symlinks=True)</strong></p>
<p>仅仅复制权限</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(py3_env) testpy ➤chmod <span class="number">400</span> kernel/test2</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line">shutil.copymode(<span class="string">&#x27;./test&#x27;</span>,<span class="string">&#x27;./test2&#x27;</span>)</span><br><span class="line"><span class="comment">#执行后再查看copy的权限</span></span><br><span class="line">-rw-r--r--  <span class="number">1</span> ssjinyao  staff     <span class="number">0</span>B Oct <span class="number">11</span> <span class="number">21</span>:<span class="number">58</span> kernel/test1</span><br><span class="line">-rw-r--r--  <span class="number">1</span> ssjinyao  staff    <span class="number">11</span>B Oct <span class="number">11</span> <span class="number">22</span>:<span class="number">10</span> kernel/test2</span><br></pre></td></tr></table></figure>
<p><strong>copystat(src,dst,*,follow_symlinks=True)</strong></p>
<p>复制元数据，stat包含权限</p>
<p><strong>copy(src,dst,*,follow_symlinks=True)</strong></p>
<p>复制文件内容、权限和部分元数据，不包括创建时间和修改时间。<br>本质上调用的是</p>
<p><strong>copyfile(src,dst,follow_symlinks=follow_symlinks)</strong><br><strong>copymode(src,dst,follow_symlinks=follow_symlinks)</strong></p>
<p>copy2 比copy多了复制全部元数据，但需要平台支持;<br>本质上调用的是<br><strong>copyfile(src,dst,follow_symlinks=follow_symlinks)</strong><br><strong>copystat(src,dst,follow_symlinks=follow_symlinks)</strong></p>
<p><strong>copytree(src,dst,symlinks=False,ignore=None,copy_function=copy2,ignore_dangling_symlinks=False)</strong></p>
<p>递归复制目录。默认使用copy2，也就是带更多的元数据复制；</p>
<p>src、dst 必须是目录，src必须是存在 dst必须不存在;<br>ignore=func, 提供一个callabe(src,names) -&gt; ignored_names。提供一个函数，它会被调用。src是源目录，names是os.listdir(src)的结果，就是列出src中的文件名，返回值是要被过滤的文件名的set类型数据。</p>
<p><strong>copytree</strong> 是最常用的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ignore</span>(<span class="params">src, names</span>):</span></span><br><span class="line">    ig = <span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x.startswith(<span class="string">&#x27;a&#x27;</span>), names) <span class="comment">#忽略a</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">set</span>(ig)</span><br><span class="line">shutil.copytree(<span class="string">&#x27;./testdir&#x27;</span>,<span class="string">&#x27;/test/dir&#x27;</span>,ignore=ignore)</span><br></pre></td></tr></table></figure>
<h2 id="rm删除"><a href="#rm删除" class="headerlink" title="rm删除"></a>rm删除</h2><p><strong>shutil.rmtree(path,ignore_errors=False,onerror=None)</strong><br>递归删除。如同<strong>rm -rf</strong> 一样危险，慎用。<br>它不是原子操作，有可能删除错误，就会中断，已经删除的就删除了;<br>ignore_errors为ture，忽略错误。当为False或者omitted时onerror生效;<br>onerror为callable，接受函数function、path和execinfo。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">shutil.rmtree(<span class="string">&#x27;./test&#x27;</span>) <span class="comment">#类似rm -rf</span></span><br></pre></td></tr></table></figure>
<h2 id="move-移动"><a href="#move-移动" class="headerlink" title="move 移动"></a>move 移动</h2><p><strong>move(src,dst,copy_function=copy2)</strong></p>
<p>递归移动文件、目录到目标，返回目录;<br>本身移动文件、目录到目标，返回目标;<br>如果不支持rename，如果是目录则想copytree再删除源目录;<br>默认使用copy2方法。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">os.rename(<span class="string">&#x27;./test.txt&#x27;</span>,<span class="string">&#x27;/temp/t&#x27;</span>)</span><br><span class="line">os.rename(<span class="string">&#x27;test3&#x27;</span>,<span class="string">&#x27;/temp/test/test300&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>shutil还有打包功能。生成tar并压缩。支持zip、gz、bz、xz。</p>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p><strong>共情的实质–把你的生活扩展到别人的生活里，把你的耳朵放到别人的灵魂中，用心去聆听那里最急切的喃喃私语</strong></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 文件的IO一</title>
    <url>/2020/09/14/python%E6%96%87%E4%BB%B6%E7%9A%84IO%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-文件的IO一"><a href="#python-文件的IO一" class="headerlink" title="python 文件的IO一"></a>python 文件的IO一</h1><p><img src="/images/python-file-io-01.jpg" class="lazyload" data-srcset="/images/python-file-io-01.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="函数相关练习补充"><a href="#函数相关练习补充" class="headerlink" title="函数相关练习补充"></a>函数相关练习补充</h2><ul>
<li>实现Base64 解码</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># base64 解码实现</span></span><br><span class="line">alphabet = <span class="string">b&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64decode</span>(<span class="params">src:<span class="built_in">bytes</span></span>):</span></span><br><span class="line">    ret = <span class="built_in">bytearray</span>()</span><br><span class="line">    length = <span class="built_in">len</span>(src)</span><br><span class="line"></span><br><span class="line">    step = <span class="number">4</span> <span class="comment">#对齐的，每次取4个</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,length, step):</span><br><span class="line">        tmp = <span class="number">0x00</span></span><br><span class="line">        block = src[offset:offset + step]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 开始移位计算</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i,c <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">reversed</span>(block)):</span><br><span class="line">            <span class="comment"># 替换字符为序号</span></span><br><span class="line">            index = alphabet.find(c)</span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">-1</span>:</span><br><span class="line">                <span class="keyword">continue</span> <span class="comment"># 找不到就是0.</span></span><br><span class="line">            tmp += index &lt;&lt; i*<span class="number">6</span></span><br><span class="line"></span><br><span class="line">        ret.extend(tmp.to_bytes(<span class="number">3</span>,<span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(ret.rstrip(<span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># 把最右的 \x00去掉，不可变</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># base64的decode</span></span><br><span class="line"><span class="comment">#txt = &quot;TWFu&quot;</span></span><br><span class="line"><span class="comment">#txt = &quot;TWE=&quot;</span></span><br><span class="line"><span class="comment">#txt = &quot;TQ==&quot;</span></span><br><span class="line"><span class="comment">#txt = &quot;TWEuTWE=&quot;</span></span><br><span class="line">txt = <span class="string">&quot;TWEUTQ==&quot;</span></span><br><span class="line">txt = txt.encode()</span><br><span class="line">print(txt)</span><br><span class="line">print(base64decode(txt).decode())</span><br><span class="line"><span class="comment"># base64实现</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">print(base64.b64decode(txt).decode())</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="string">b&#x27;TWEUTQ==&#x27;</span></span><br><span class="line">MaM</span><br><span class="line">MaM</span><br></pre></td></tr></table></figure>
<p>还是有提高效率的地方</p>
<ol>
<li>revesed可以不需要</li>
<li>alphabet.find效率底</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line">base_tbl = <span class="string">b&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line">alphabet = OrderedDict(<span class="built_in">zip</span>(base_tbl,<span class="built_in">range</span>(<span class="number">64</span>)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64decode</span>(<span class="params">src:<span class="built_in">bytes</span></span>):</span></span><br><span class="line">    ret = <span class="built_in">bytearray</span>()</span><br><span class="line">    length = <span class="built_in">len</span>(src)</span><br><span class="line"></span><br><span class="line">    step = <span class="number">4</span> <span class="comment"># 对齐的，每次取4个</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,length, step):</span><br><span class="line">        tmp = <span class="number">0x00</span></span><br><span class="line">        block = src[offset:offset + step]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 开始移位计算</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            index = alphabet.get(block[-i<span class="number">-1</span>])</span><br><span class="line">            <span class="keyword">if</span> index <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                tmp += index &lt;&lt; i*<span class="number">6</span></span><br><span class="line">        <span class="comment"># 找不到，不用移位相加了</span></span><br><span class="line"></span><br><span class="line">        ret.extend(tmp.to_bytes(<span class="number">3</span>,<span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(ret.rstrip(<span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># 把最右边的\x00 去掉，不可变</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># base64的decode</span></span><br><span class="line"><span class="comment">#txt = &quot;TWFu&quot;</span></span><br><span class="line"><span class="comment">#txt = &quot;TWE=&quot;</span></span><br><span class="line"><span class="comment">#txt = &quot;TQ==&quot;</span></span><br><span class="line"><span class="comment">#txt = &quot;TWEuTWE=&quot;</span></span><br><span class="line">txt = <span class="string">&quot;TWEUTQ==&quot;</span></span><br><span class="line">txt = txt.encode()</span><br><span class="line">print(txt)</span><br><span class="line">print(base64decode(txt).decode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># base64实现</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">print(base64.b64decode(txt).decode())</span><br></pre></td></tr></table></figure>
<ul>
<li>完善命令分发器，实现函数可以带任意参数(可变参数除外)，解析参数并要求用户输入</li>
</ul>
<p>即解决下面的问题:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmds_dispatcher</span>():</span></span><br><span class="line">    <span class="comment">#命令和函数存储的地方</span></span><br><span class="line">    commands = &#123;&#125;</span><br><span class="line">    <span class="comment"># 注册</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">name</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_reg</span>(<span class="params">fn</span>):</span></span><br><span class="line">            commands[name] =fn</span><br><span class="line">        <span class="keyword">return</span> _reg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfunc</span>():</span></span><br><span class="line">        print(<span class="string">&quot;Unknown command&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span>():</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">&#x27;quit&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            commands.get(cmd,defaultfunc)()</span><br><span class="line">    <span class="keyword">return</span> reg,dispatcher</span><br><span class="line">    </span><br><span class="line">cr,cp = cmds_dispatcher()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定久函数，注册</span></span><br><span class="line"><span class="meta">@cr(&#x27;mag&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span>():</span></span><br><span class="line">    print(<span class="string">&quot;welcome ssjinyao&quot;</span>)</span><br><span class="line"><span class="meta">@cr(&#x27;py&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span>():</span></span><br><span class="line">    print(<span class="string">&quot;welcome python&quot;</span>)</span><br><span class="line">cp()</span><br></pre></td></tr></table></figure>
<ul>
<li>思路:</li>
</ul>
<ol>
<li>注册的时候，因定死，<code>@reg(&#39;py&#39;,200,100)</code><br>可以认为<code>@reg(&#39;py&#39;,200,100)</code>和 <code>@reg(&#39;py&#39;,300,100)</code>是不同的函数，可以用partial函数;</li>
<li>运行时，在输出cmd的时候，逗号分割 ，获取参数;</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数可以有任意参数，可变参数、keyword-only 除外</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">command_dispatcher</span>():</span></span><br><span class="line">    <span class="comment"># 构建全局字典</span></span><br><span class="line">    cmd_tbl = &#123;&#125;</span><br><span class="line">    <span class="comment"># 注册函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">cmd,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_reg</span>(<span class="params">fn</span>):</span></span><br><span class="line">            func = partial(fn,*args,**kwargs)</span><br><span class="line">            cmd_tbl[cmd] = func</span><br><span class="line">            <span class="keyword">return</span> func</span><br><span class="line">        <span class="keyword">return</span> _reg</span><br><span class="line">    <span class="comment"># 缺省函数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default_func</span>():</span></span><br><span class="line">        print(<span class="string">&quot;Unknown command&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调度器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span>():</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = <span class="built_in">input</span>(<span class="string">&#x27;Pleaase input cmd &gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 退出条件</span></span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            cmd_tbl.get(cmd,default_func)()</span><br><span class="line">    <span class="keyword">return</span> reg,dispatcher</span><br><span class="line"></span><br><span class="line">reg,dispatcher = command_dispatcher()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@reg(&#x27;jy&#x27;,z=200,y=300,x=100)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span>(<span class="params">x,y,z</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;ssjinyao&#x27;</span>,x,y,z)</span><br><span class="line"></span><br><span class="line"><span class="meta">@reg(&#x27;py&#x27;,300,b=400)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span>(<span class="params">a,b=<span class="number">200</span></span>):</span></span><br><span class="line">    print(<span class="string">&#x27;python&#x27;</span>,a,b)</span><br><span class="line"></span><br><span class="line">dispatcher()</span><br></pre></td></tr></table></figure>
<h2 id="文件IO常用操作"><a href="#文件IO常用操作" class="headerlink" title="文件IO常用操作"></a>文件IO常用操作</h2><p>数据落地、不管怎样数据都要写到磁盘上固态上、这种称为数据落地、持久化;</p>
<h3 id="回顾CPU组成及作用"><a href="#回顾CPU组成及作用" class="headerlink" title="回顾CPU组成及作用"></a>回顾CPU组成及作用</h3><ul>
<li>运算器，完成各种算数运算、逻辑运算、数据传输等数据加工处理;</li>
<li>控制器，控制程序的执行;</li>
<li>存储器，用于记忆程序和数据，例如内存;</li>
<li>输入设备，将数据或者程序输入到计算机中，例如键盘、鼠标;</li>
<li>输出设备，将数据或程序的处理结果展示给用户，例如显示器、打印机等;<br>一般说IO操作，指的是文件IO，如果指的是网络IO，都会直接说网络IO。</li>
</ul>
<table>
<thead>
<tr>
<th>open</th>
<th>打开</th>
</tr>
</thead>
<tbody>
<tr>
<td>read</td>
<td>读取</td>
</tr>
<tr>
<td>write</td>
<td>写入</td>
</tr>
<tr>
<td>close</td>
<td>关闭</td>
</tr>
<tr>
<td>readline</td>
<td>行读取</td>
</tr>
<tr>
<td>readlines</td>
<td>多行读取</td>
</tr>
<tr>
<td>seek</td>
<td>文件指针操作</td>
</tr>
<tr>
<td>tell</td>
<td>指针位置</td>
</tr>
</tbody>
</table>
<p>文件操作中，最常用的就是读和写;<br>文件访问的模式有两种: 文本模式和二进制模式。不同模式上函数不尽相同。表现的结果也是不一样的；</p>
<h3 id="open的参数"><a href="#open的参数" class="headerlink" title="open的参数"></a>open的参数</h3><p><code>file</code><br>打开或者要创建的文件名。 如果不指定路径，默认是当前路径; </p>
<p><strong>mode模式</strong></p>
<table>
<thead>
<tr>
<th>描述字符</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>缺省的，表示只读打开</td>
</tr>
<tr>
<td>w</td>
<td>只写打开</td>
</tr>
<tr>
<td>x</td>
<td>创建并写入一个新文件</td>
</tr>
<tr>
<td>a</td>
<td>写入打开，如果文件存在，则追加</td>
</tr>
<tr>
<td>b</td>
<td>二进制模式</td>
</tr>
<tr>
<td>t</td>
<td>缺省的，文本模式</td>
</tr>
<tr>
<td>+</td>
<td>读写打开一个文件。给原来只读、只写方式打开提供缺失的读或者写能力</td>
</tr>
</tbody>
</table>
<p>open 默认是只读模式r打开已经存在的文件。<br>r<br>只读打开文件，也果使用write方法，会抛异常;<br>如果文件不存在，抛出FileNotFoundError异常;<br>w<br>表示只写方式打开，如果读取则抛出异常;<br>如果文件不存在，则直接创建文件;<br>如果文件存在，则清空文件内容;</p>
<p>x<br>文件不存在，创建文件，并只写方式打开;<br>文件存在，抛出FileExistsError异常;</p>
<p>a<br>文件存在，只写打开，追回内容;<br>文件不存在，则创建后，只写打开，追加内容</p>
<p>r 是只读,wxa 是只写<br>wxa 都可以产生新文件，w不管文件存在与否，都会生成全新内容的文件;<br>a 不管文件是否存在，都能打开的文件尾部追加;x必须需求文件事先不存在，自己造一个新文件;</p>
<h3 id="encoding-编码，-仅文本模式使用"><a href="#encoding-编码，-仅文本模式使用" class="headerlink" title="encoding: 编码， 仅文本模式使用"></a>encoding: 编码， 仅文本模式使用</h3><p>None 表示使用缺省编码，依赖操作系统。win、 linux下测试如下代码<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;test1&#x27;</span>,w)</span><br><span class="line">f.write(<span class="string">&#x27;写入&#x27;</span>)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment">#windows下缺缺省GBK(0XBOA1), Linux下缺省UTF-8(0xE5 95 8a)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="其它参数"><a href="#其它参数" class="headerlink" title="其它参数"></a>其它参数</h3><ol>
<li>errors: 什么样的编码错误将被捕获;</li>
<li>None和strict表示有编码错误将抛出ValueError异常;ignore表示忽略;</li>
<li>newline: 文本模式中，换行的转换。可以为None、’’、’\r’、’\n’、’\r\n’</li>
<li>读时，None表示’\r’、’\n’、’\r\n’都被转换为’\n’； 表示不会自动转换通用换行符;</li>
<li>其它合法字符表示换行符就是指定字符，就会按照指定字符分行;</li>
<li>写时，None表示’\n’都会被替换为系统缺省分隔符os.linesep;’\n’或’’表示’\n’不替换; 其它合法字符表示’\n’会被替换为指定 的字符;</li>
<li>colsefd: 关闭文件描述符，True表示关闭它。False会在文件关闭后保持这个描述符；</li>
<li><code>fileobj.fileno()</code>查看;</li>
</ol>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p><code>read(size=-1)</code><br>size表示读取多少个字符或字节; 负数或者None表示读取到EOF;</p>
<h3 id="行读取"><a href="#行读取" class="headerlink" title="行读取"></a>行读取</h3><p><code>readline(size=-1)</code><br>一行行读取文件内容，size设置一次能读取行内几个字符或字节;<br><code>readline(hint=-1)</code><br>读取所有行的列表。指定hint则返回指定的行数;</p>
<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p><code>write(s)</code>把字符串s写入到文件中并返回字符的个数;</p>
<h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p>flush并关闭文件对象;<br>文件已经关闭，再次关闭没有任何效果</p>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p><code>seekable()</code> 是否可seek<br><code>readable()</code> 是否可读<br><code>writeable()</code> 是否可写<br><code>closed</code> 是否已经关闭</p>
<h2 id="上下文件管理"><a href="#上下文件管理" class="headerlink" title="上下文件管理"></a>上下文件管理</h2><p>问题的引出<br>在Linux中执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">13</span>]: lst = []</span><br><span class="line"></span><br><span class="line">In [<span class="number">14</span>]: <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">60000</span>):</span><br><span class="line">    ...:     lst.append(<span class="built_in">open</span>(<span class="string">&#x27;test&#x27;</span>))</span><br><span class="line">    ...:</span><br></pre></td></tr></table></figure>
<p>在linux上查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lsof | grep ipython | wc -l</span></span><br><span class="line">120158</span><br><span class="line"><span class="comment"># ulimit  -a | grep &quot;open file&quot;</span></span><br><span class="line">open files                      (-n) 65535</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">18</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst:</span><br><span class="line">    ...:     x.close()</span><br><span class="line">    ...:</span><br></pre></td></tr></table></figure>
<p>关闭后对比</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lsof | grep ipython | wc -l</span></span><br><span class="line">158</span><br></pre></td></tr></table></figure>
<p>ulimit -a 查看所有限制。其中open files 就是打开文件数的限制，默认1024;<br>将文件一次关闭，然后就可以继续打开了。再看一次losf</p>
<p>如何解决 ？</p>
<p>1、 异常处理<br>当出现异常的时候，拦截异常。但是，因为很多代码可都可能出现OSError异常，还不好判断异常就是应为资源限制产生的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    f.write(<span class="string">&quot;abc&quot;</span>) <span class="comment"># 文件只读，写入失败</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    f.close()  <span class="comment"># 这样才行</span></span><br></pre></td></tr></table></figure>
<p>2、 上下文管理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span> </span></span><br><span class="line"><span class="function"><span class="title">with</span> <span class="title">open</span>(<span class="params"><span class="string">&#x27;test&#x27;</span></span>) <span class="title">as</span> <span class="title">f</span>:</span></span><br><span class="line">    f.write(<span class="string">&quot;abc&quot;</span>) <span class="comment"># 文件只读，写入失败</span></span><br><span class="line"><span class="comment">#测试f是否关闭</span></span><br><span class="line">f.closed <span class="comment"># f 的作用域</span></span><br></pre></td></tr></table></figure>
<p>一种特殊的语法、交级解释器去释放文件对象;</p>
<ol>
<li>使用with .. as 关键字;</li>
<li>上下文管理的语句块并不会开启新的作用域;</li>
<li>with语句块执行完的时候，会自动关闭文件;</li>
</ol>
<p>另一种写法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f1 = <span class="built_in">open</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> f1:</span><br><span class="line">    f1.write(<span class="string">&quot;abc&quot;</span>) <span class="comment">#文件只读，写入失败</span></span><br><span class="line"><span class="comment"># 测试f是否关闭</span></span><br><span class="line">f1.closed <span class="comment"># f1的作用域</span></span><br></pre></td></tr></table></figure>
<p>对于类似于文件对象的IO对象，一般来说都需要在不使用的时候关闭、注销，以释放资源;<br>IO被打开的时候，会获得一个文件描述符。计算机资源是有限的，所有操作系统都会做限制;<br>就是为了保护计算机的资源要被完全耗尽，计算资源是共享的，不是独占的;<br>一般情况下，除非特别明确的知道资源情况，否则不要提高资源的限制值来解决问题，不好的情况下只会让系统资源崩溃;</p>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p><strong>为求善聚不如善散，善始不如善终</strong></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python高阶函数函数和装饰器三</title>
    <url>/2020/09/07/python%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0%E5%92%8C%E8%A3%85%E9%A5%B0%E5%99%A8%E4%B8%89/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python高阶函数和装饰器三"><a href="#python高阶函数和装饰器三" class="headerlink" title="python高阶函数和装饰器三"></a>python高阶函数和装饰器三</h1><p><img src="/images/python_function.png" class="lazyload" data-srcset="/images/python_function.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="函数定义的弊端"><a href="#函数定义的弊端" class="headerlink" title="函数定义的弊端"></a>函数定义的弊端</h2><ul>
<li>Python 是动态语言，变量随时可以被赋值，且能赋值为不同的类型;</li>
<li>Python 不是表态编译型语言，变量类型是在运行时决定的;</li>
<li>动态语言很灵活，但是这种我也是弊端;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">   ...:     <span class="keyword">return</span> x + y</span><br><span class="line">In [<span class="number">2</span>]: print(add(<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line"><span class="number">9</span></span><br><span class="line">In [<span class="number">3</span>]: print(add(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>))</span><br><span class="line">helloworld</span><br><span class="line">In [<span class="number">4</span>]: print(add(<span class="number">4</span>,<span class="string">&#x27;world&#x27;</span>))</span><br><span class="line"><span class="comment"># 这时报错 </span></span><br></pre></td></tr></table></figure>
<ol>
<li>难发现: 由于不做任何类型检查，直到运行期间问题才显现出来，或者线上运行时才能暴露出问题;</li>
<li>难使用: 函数的使用者看到函数的时候，并不知道你的函数设计，并不知道应该传入什么类型的数据;</li>
</ol>
<ul>
<li>函数注解(Function Annotations)</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x:<span class="built_in">int</span> ,y:<span class="built_in">int</span></span>) -&gt; int:</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param x:</span></span><br><span class="line"><span class="string">    :param y:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">print(add(<span class="string">&#x27;ssjinyao&#x27;</span>,<span class="string">&#x27;.com&#x27;</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>函数注解</li>
</ul>
<ol>
<li>Python3.5引入;</li>
<li>对函数的参数进行类型注解;</li>
<li>对函数的返回值进行类型注解;</li>
<li>只对函数参数做一个辅助的说，并不对函数参数进行类型检查;</li>
<li>提供给第三方工具，做代码分析，发现隐藏的bug;</li>
<li>函数注解的信息，保存在<code>__annotations__</code> 属性中</li>
</ol>
<ul>
<li>变量注解<br>  Pyton3.6引入<br>  <code>i:int =3</code></li>
</ul>
<h3 id="业务应用"><a href="#业务应用" class="headerlink" title="业务应用"></a>业务应用</h3><pre><code>* 函数参数类型检查
* 思路
</code></pre><ol>
<li>函数参数的检查，一定是在函数外;</li>
<li>函数应该作为参数，传入到检查函数中;</li>
<li>检查函数拿到函数传的实际参数，与形参声明对比;</li>
<li><code>__annotations__</code>属jntg是一个字典，其中包括返回值类型的声明。假设要做位置参数的判断，无法和字典中的声明对应，使用inpsect 模块;</li>
<li><code>inspect</code>模块: 提供获取对象信息的函数，可以检查函数和类、类型检查;</li>
</ol>
<h2 id="inspect-模块"><a href="#inspect-模块" class="headerlink" title="inspect 模块"></a>inspect 模块</h2><p><code>signature(callable)</code>，获取签名(函数签名包含了一个函数的信息，包括函数名，它的参数类型、它所在的类和名称空间及其他信息)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x:<span class="built_in">int</span>,y:<span class="built_in">int</span>,*args,**kwargs</span>)-&gt;int:</span></span><br><span class="line">    <span class="keyword">return</span> x+y</span><br><span class="line">sig = inspect.signature(add)</span><br><span class="line">print(sig)</span><br><span class="line">print(<span class="string">&#x27;params:&#x27;</span>,sig.parameters) <span class="comment"># OrderedDict</span></span><br><span class="line">print(<span class="string">&#x27;return:&#x27;</span>,sig.return_annotation)</span><br><span class="line">print(sig.parameters[<span class="string">&#x27;y&#x27;</span>])</span><br><span class="line">print(sig.parameters[<span class="string">&#x27;x&#x27;</span>].annotation)</span><br><span class="line">print(sig.parameters[<span class="string">&#x27;args&#x27;</span>])</span><br><span class="line">print(sig.parameters[<span class="string">&#x27;args&#x27;</span>].annotation)</span><br><span class="line">print(sig.parameters[<span class="string">&#x27;kwargs&#x27;</span>])</span><br><span class="line">print(sig.parameters[<span class="string">&#x27;kwargs&#x27;</span>].annotation)</span><br><span class="line"><span class="comment"># 输出信息</span></span><br><span class="line">(x: int, y: int, *args, **kwargs) -&gt; int</span><br><span class="line">params: OrderedDict([(<span class="string">&#x27;x&#x27;</span>, &lt;Parameter <span class="string">&quot;x: int&quot;</span>&gt;), (<span class="string">&#x27;y&#x27;</span>, &lt;Parameter <span class="string">&quot;y: int&quot;</span>&gt;), (<span class="string">&#x27;args&#x27;</span>, &lt;Parameter <span class="string">&quot;*args&quot;</span>&gt;), (<span class="string">&#x27;kwargs&#x27;</span>, &lt;Parameter <span class="string">&quot;**kwargs&quot;</span>&gt;)])</span><br><span class="line"><span class="keyword">return</span>: &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">y</span>:</span> <span class="built_in">int</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">*<span class="title">args</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">**<span class="title">kwargs</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">inspect.isfunction(add) <span class="comment"># 是否是函数</span></span><br><span class="line">inspect.ismethod(add) <span class="comment"># 是否是类的方法</span></span><br><span class="line">inspect.isgenerator(add) <span class="comment"># 是否是生成器对象</span></span><br><span class="line">inspect.isgenratorfunction(add)<span class="comment"># 是否是生成器函数</span></span><br><span class="line">inspect.isclass(add) <span class="comment"># 是否是类</span></span><br><span class="line">inspect.ismodule(inspect) <span class="comment">#是否是模块</span></span><br><span class="line">inspect.isbuiltin(<span class="built_in">print</span>) <span class="comment">#是否是内建对象</span></span><br><span class="line"><span class="comment"># 还很多is函数，需要的时候查阅inpect模块帮助</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Parameter对象</li>
</ul>
<ol>
<li>保存在元组中，是只读的;</li>
<li>name, 参数的名字;</li>
<li>annotation，参数的注解，可能没有定义;</li>
<li>default，参数的缺省值，可能没有定义;</li>
<li>empty, 特殊的类，用来标记default属性或者注释annotation属性的空值;</li>
<li><p>kind，实参如何绑定到形参，就是形参的类型;</p>
<p> <code>POSITIONAL_ONLY</code>, 值必须是位置参数提供;<br> <code>VAR_POSITIONAL</code>, 可变位置参数,对应<code>*args</code>;<br> <code>KEKWORD_ONLY</code>, keyword-only参数，对应* 或者*args之后的出现的非可变关键字参数;<br> <code>VAR_KEYWORD</code>, 可变关键字参数, 对应<code>**kwargs</code></p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y:<span class="built_in">int</span>=<span class="number">7</span>, *args, z, t=<span class="number">10</span>,**kwargs</span>) -&gt; int:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">sig = inspect.signature(add)</span><br><span class="line">print(<span class="string">&#x27;params: &#x27;</span>, sig.parameters)</span><br><span class="line">print(<span class="string">&#x27;return: &#x27;</span>, sig.return_annotation)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,(name,param) <span class="keyword">in</span> <span class="built_in">enumerate</span>(sig.parameters.items()):</span><br><span class="line">    print(i+<span class="number">1</span>, name, param.annotation, param.kind, param.default)</span><br><span class="line">    print(param.default <span class="keyword">is</span> param.empty, end = <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="number">1</span> x &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt; <span class="title">POSITIONAL_OR_KEYWORD</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line"><span class="class">2 <span class="title">y</span> &lt;<span class="title">class</span> &#x27;<span class="title">int</span>&#x27;&gt; <span class="title">POSITIONAL_OR_KEYWORD</span> 7</span></span><br><span class="line"><span class="class"><span class="title">False</span></span></span><br><span class="line"><span class="class">3 <span class="title">args</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt; <span class="title">VAR_POSITIONAL</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line"><span class="class">4 <span class="title">z</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt; <span class="title">KEYWORD_ONLY</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line"><span class="class">5 <span class="title">t</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt; <span class="title">KEYWORD_ONLY</span> 10</span></span><br><span class="line"><span class="class"><span class="title">False</span></span></span><br><span class="line"><span class="class">6 <span class="title">kwargs</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt; <span class="title">VAR_KEYWORD</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">fn</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 实参检查</span></span><br><span class="line">        print(args,kwargs)</span><br><span class="line">        sig = inspect.signature(fn)</span><br><span class="line">        print(sig)</span><br><span class="line">        print(<span class="string">&#x27;params: &#x27;</span>, sig.parameters)</span><br><span class="line">        print(<span class="string">&#x27;return: &#x27;</span>, sig.return_annotation)</span><br><span class="line">        print(<span class="string">&#x27;-------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> sig.parameters.values():</span><br><span class="line">            print(param.name,param)</span><br><span class="line">            print(param.name, param.annotation, param.kind, param.default)</span><br><span class="line">            print(param.default <span class="keyword">is</span> param.empty, end=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        ret = fn(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span>  ret</span><br><span class="line">    <span class="keyword">return</span>  wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@check</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x:<span class="built_in">int</span> , y:<span class="built_in">int</span>=<span class="number">7</span></span>) -&gt; int:</span></span><br><span class="line">    print(x + y)</span><br><span class="line">add(<span class="number">4</span>,y=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">(<span class="number">4</span>,) &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">8</span>&#125;</span><br><span class="line">(x: int, y: int = 7) -&gt; int</span><br><span class="line">params:  OrderedDict([(<span class="string">&#x27;x&#x27;</span>, &lt;Parameter <span class="string">&quot;x: int&quot;</span>&gt;), (<span class="string">&#x27;y&#x27;</span>, &lt;Parameter <span class="string">&quot;y: int = 7&quot;</span>&gt;)])</span><br><span class="line"><span class="keyword">return</span>:  &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">-------------------------</span></span><br><span class="line"><span class="class"><span class="title">x</span> <span class="title">x</span>:</span> <span class="built_in">int</span></span><br><span class="line">x &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt; <span class="title">POSITIONAL_OR_KEYWORD</span> &lt;<span class="title">class</span> &#x27;<span class="title">inspect</span>.<span class="title">_empty</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line"><span class="class"><span class="title">y</span> <span class="title">y</span>:</span> <span class="built_in">int</span> = <span class="number">7</span></span><br><span class="line">y &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt; <span class="title">POSITIONAL_OR_KEYWORD</span> 7</span></span><br><span class="line"><span class="class"><span class="title">False</span></span></span><br><span class="line"><span class="class">12</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 实参检查</span></span><br><span class="line">        print(args,kwargs)</span><br><span class="line">        sig = inspect.signature(fn)</span><br><span class="line">        params = sig.parameters <span class="comment"># 有序字典</span></span><br><span class="line"></span><br><span class="line">        param_list = <span class="built_in">tuple</span>(params.keys())</span><br><span class="line">        <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(args):</span><br><span class="line">            k = param_list[i]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(v,params[k].annotation):</span><br><span class="line">                print(v,<span class="string">&#x27;is&#x27;</span>,params[k].annotation)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                errstr = <span class="string">&quot;&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(v,<span class="string">&#x27;is not&#x27;</span>,params[k].annotation)</span><br><span class="line">                print(errstr)</span><br><span class="line">                <span class="keyword">raise</span> TypeError(errstr)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 关键字传参处理</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(v,params[k].annotation):</span><br><span class="line">                print(v,<span class="string">&#x27;is&#x27;</span>,params[k].annotation)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                errstr = <span class="string">&quot;&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>.<span class="built_in">format</span>(v, <span class="string">&quot;is not&quot;</span>, params[k].annotation)</span><br><span class="line">                print(errstr)</span><br><span class="line">                <span class="keyword">raise</span> TypeError(errstr)</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@check</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x: <span class="built_in">int</span>, y:<span class="built_in">int</span> = <span class="number">7</span></span>) -&gt; int:</span></span><br><span class="line">    print(x + y)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">add(<span class="number">4</span>,y=<span class="number">10</span>)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">(<span class="number">4</span>,) &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">10</span>&#125;</span><br><span class="line"><span class="number">4</span> <span class="keyword">is</span> &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">10 <span class="title">is</span> &lt;<span class="title">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">14</span></span><br></pre></td></tr></table></figure>
<h2 id="functools-模块"><a href="#functools-模块" class="headerlink" title="functools 模块"></a>functools 模块</h2><ul>
<li>partial方法<br>比较有用函数，尤其是在做函数封装的时候</li>
</ul>
<ol>
<li>偏函数，把函数的部分的参数固定下来，相当于部分的参数添加了一个固定的默认值，形成一个新的函数返回;</li>
<li>从partial 生成的新函数，是对函数的封装;</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y:<span class="built_in">int</span></span>)-&gt; int:</span></span><br><span class="line">    ret = x + y</span><br><span class="line">    print(ret)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line">print(inspect.signature(add))</span><br><span class="line"></span><br><span class="line">newadd = functools.partial(add,y=<span class="number">6</span>)</span><br><span class="line">newadd(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># 输出 </span></span><br><span class="line">(x, y: int) -&gt; int</span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<ul>
<li><a href="mailto:`@functools.lr">`@functools.lr</a>u_cache(maxsize=128, typed=False)`</li>
</ul>
<ol>
<li>Least-recently-used 装饰器。 lru，最近最少使用。cache缓存;</li>
<li>如果maxsize设置为None，则禁用LRU功能，并且缓存可以无限制增长。当maxsize 是二的幂时，LRU功能执行得最好;</li>
<li>如果typed 设置为True，则不同类型的函数参数将单独缓存。例如,<code>f(3)</code>和<code>f(3.0)</code> 将被视为具有不同结果的不同调用。</li>
</ol>
<p>测试一下不同函数参数的不同第二次调用速度<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: <span class="keyword">import</span> functools</span><br><span class="line">In [<span class="number">9</span>]: <span class="keyword">import</span> time</span><br><span class="line">In [<span class="number">13</span>]: @functools.lru_cache()</span><br><span class="line">    ...: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y=<span class="number">5</span></span>):</span></span><br><span class="line">    ...:     time.sleep(<span class="number">3</span>)</span><br><span class="line">    ...:     ret = x + y</span><br><span class="line">    ...:     print(ret)</span><br><span class="line">    ...:     <span class="keyword">return</span> ret</span><br><span class="line">In [<span class="number">14</span>]: add(<span class="number">4</span>)</span><br><span class="line"><span class="number">9</span></span><br><span class="line">Out[<span class="number">14</span>]: <span class="number">9</span></span><br><span class="line">In [<span class="number">15</span>]: add(<span class="number">4</span>)</span><br><span class="line">Out[<span class="number">15</span>]: <span class="number">9</span></span><br><span class="line">In [<span class="number">16</span>]: add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"><span class="number">9</span></span><br><span class="line">Out[<span class="number">16</span>]: <span class="number">9</span></span><br><span class="line">In [<span class="number">17</span>]: add(<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line"><span class="number">9</span></span><br><span class="line">Out[<span class="number">17</span>]: <span class="number">9</span></span><br><span class="line">In [<span class="number">18</span>]: add(x=<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line"><span class="number">9</span></span><br><span class="line">Out[<span class="number">18</span>]: <span class="number">9</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>lru_cache 装饰器</li>
</ul>
<ol>
<li>通过一个字典缓存被装饰函数的调用和返回值;</li>
</ol>
<p>tuple 转 list 补充方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">19</span>]: lst = []</span><br><span class="line">In [<span class="number">20</span>]: lst[:] = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">In [<span class="number">21</span>]: lst</span><br><span class="line">Out[<span class="number">21</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>斐波那契数列递归方法的改造</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="meta">@functools.lru_cache()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> fib(n<span class="number">-1</span>) + fib(n<span class="number">-2</span>)</span><br><span class="line">print([fib(x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>)])</span><br></pre></td></tr></table></figure>
<ul>
<li>lru_cache 装饰器的应用</li>
</ul>
<ol>
<li>使用前提<br> 同样的函数参数一定得到同样的结果;<br> 函数执行时间长，且要多次执行;</li>
<li>本质是函数调用的参数 =&gt; 返回值</li>
<li>缺点:<br>不支持缓存过期，key 无法过期、失效;<br>不支持清除操作;<br>不支持分布式，是一个单机的缓存;</li>
<li>适用场景，单机上需要空间换时间的地方，可以用缓存来将计算变成快速的查询;</li>
</ol>
<h2 id="装饰器练习"><a href="#装饰器练习" class="headerlink" title="装饰器练习"></a>装饰器练习</h2><ul>
<li>实现一个cache装饰器，实现可过期，可删除的功能。可以不换出;<br>简化设计，函数的形参定义不包含可变位置、可变关键词参数和keyword-only参数可以不考虑缓存满了之后的换出问题;</li>
</ul>
<p>数据类型的选择:<br>缓存的应用场景，是有数据需要频繁查询，且每次查询都需要大量计算或者等待时间之后才能返回的结果的情况，使用缓存来提高查询速度，用空间换取时间;</p>
<p>cache 应用选用什么数据结构？<br>便于查询的，且能快速找到数据的数据结构;<br>每次查询的时候，只要输入致，就应该得到同样的结果(顺序一致，例如减法函数，参数顺序不一致，结果不一样);<br>基于上面的分析，些数据结构应该是字典;<br>通过一个key, 对应一个value;<br>key是参数列表组成的结构，value 是函数返回值。难点在于key如何处理。</p>
<p>key的存储;<br>key 必须是hash类;<br>key能接受到位置参数和关键字参数传参;<br>位置参数是被收集在一个tuple中的，本身就有顺序;</p>
<p>key 的要求;<br>key必须是hashable;<br>由于key是所有实参组合而成的, 而且最好要作为key的, key一定要可以hash, 但是如果key有不可hash类型数据，就无法完成;<br>缓存必须使用key，但是key必须可hash,所以只能适用实参是不可变类型的函数调用;</p>
<p>key 算法设计<br>inspect模块获取函数签名后，取parameters，这是一个有序字典，会保存所有参数的信息;<br>构建一个字典params_dict，按照位置顺序从args中依次对应参数名和传入的实参，组成kv对，存入params_dict中;<br>kwargs所有值update到parmas_dict中;<br>如果使用了缺省的参数，不会出现实参params_dict中，会出现在签名的取parameters中,缺省值也在定义中;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">m_cache</span>(<span class="params">fn</span>):</span></span><br><span class="line">    local_cache = &#123;&#125;</span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        print(args, kwargs)</span><br><span class="line">        key_dict = &#123;&#125; <span class="comment">#sorted</span></span><br><span class="line">        sig = inspect.signature(fn)</span><br><span class="line">        params = sig.parameters <span class="comment">#有序字典</span></span><br><span class="line">        param_list = <span class="built_in">list</span>(params.keys())</span><br><span class="line">        <span class="comment"># 位置参数</span></span><br><span class="line">        <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(args):</span><br><span class="line">            <span class="comment"># print(i,v)</span></span><br><span class="line">            k = param_list[i]</span><br><span class="line">            key_dict[k] =v</span><br><span class="line">        <span class="comment"># 关键字参数</span></span><br><span class="line">        <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">        <span class="comment">#     key_dict[k] = v</span></span><br><span class="line">        key_dict.update(kwargs)</span><br><span class="line">        <span class="comment"># 缺省值的处理</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> params.keys():</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> key_dict.keys():</span><br><span class="line">                key_dict[k] = params[k].default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        key = <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(key_dict.items()))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">            ret = fn(*args, **kwargs)</span><br><span class="line">            local_cache[key] = ret</span><br><span class="line">        <span class="keyword">return</span>  local_cache[key]</span><br><span class="line">    <span class="keyword">return</span>  wrapper</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        dalta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(dalta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@m_cache</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y=<span class="number">5</span></span>):</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    ret = x + y</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line">add(x=<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line">add(y=<span class="number">5</span>,x=<span class="number">4</span>)</span><br><span class="line"><span class="comment">## 对比输出结果，缓存输执行的效率</span></span><br><span class="line">(<span class="number">4</span>,) &#123;&#125;</span><br><span class="line"><span class="number">3.001863</span></span><br><span class="line">(<span class="number">4</span>, <span class="number">5</span>) &#123;&#125;</span><br><span class="line"><span class="number">0.000151</span></span><br><span class="line">(<span class="number">4</span>,) &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>&#125;</span><br><span class="line"><span class="number">8.1e-05</span></span><br><span class="line">() &#123;<span class="string">&#x27;x&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>&#125;</span><br><span class="line"><span class="number">7.6e-05</span></span><br><span class="line">() &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;x&#x27;</span>: <span class="number">4</span>&#125;</span><br><span class="line"><span class="number">7.3e-05</span></span><br></pre></td></tr></table></figure>
<p>过期功能;<br>一般缓存系统都有过期功能;<br>带参装饰器及格离化、函数封装</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">m_cache</span>(<span class="params">duration</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_m_cache</span>(<span class="params">fn</span>):</span></span><br><span class="line">        local_cache = &#123;&#125;</span><br><span class="line"><span class="meta">        @wraps(fn)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="comment"># local_cache 有没有过期的key</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">clear_expire</span>(<span class="params">cache</span>):</span></span><br><span class="line">                expire_keys = []</span><br><span class="line">                <span class="keyword">for</span> k, (_, ts) <span class="keyword">in</span> cache.items():</span><br><span class="line">                    <span class="keyword">if</span> datetime.datetime.now().timestamp() - ts &gt; duration:</span><br><span class="line">                        expire_keys.append(k)</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> expire_keys:</span><br><span class="line">                    cache.pop(k)</span><br><span class="line">                print(args, kwargs)</span><br><span class="line">            clear_expire(local_cache)</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">make_key</span>():</span></span><br><span class="line">                key_dict = &#123;&#125; <span class="comment">#sorted</span></span><br><span class="line">                sig = inspect.signature(fn)</span><br><span class="line">                params = sig.parameters <span class="comment">#有序字典</span></span><br><span class="line">                param_list = <span class="built_in">list</span>(params.keys())</span><br><span class="line">                <span class="comment"># 位置参数</span></span><br><span class="line">                <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(args):</span><br><span class="line">                    <span class="comment"># print(i,v)</span></span><br><span class="line">                    k = param_list[i]</span><br><span class="line">                    key_dict[k] =v</span><br><span class="line">                <span class="comment"># 关键字参数</span></span><br><span class="line">                <span class="comment"># for k,v in kwargs.items():</span></span><br><span class="line">                <span class="comment">#     key_dict[k] = v</span></span><br><span class="line">                key_dict.update(kwargs)</span><br><span class="line">                <span class="comment"># 缺省值的处理</span></span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> params.keys():</span><br><span class="line">                    <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> key_dict.keys():</span><br><span class="line">                        key_dict[k] = params[k].default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">tuple</span>(<span class="built_in">sorted</span>(key_dict.items()))</span><br><span class="line">            key = make_key()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> local_cache.keys():</span><br><span class="line">                ret = fn(*args, **kwargs)</span><br><span class="line">                local_cache[key] = (ret, datetime.datetime.now().timestamp()) <span class="comment"># (,,) = key, tuple =&gt; value</span></span><br><span class="line">                <span class="comment"># local_cache[key] = ret</span></span><br><span class="line">            <span class="keyword">return</span>  local_cache[key]</span><br><span class="line">        <span class="keyword">return</span>  wrapper</span><br><span class="line">    <span class="keyword">return</span> _m_cache</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">    @wraps(fn)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        dalta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">        print(dalta)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="meta">@m_cache(6)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y=<span class="number">5</span></span>):</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    ret = x + y</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line">add(x=<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line">add(y=<span class="number">5</span>,x=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line">add(x=<span class="number">4</span>,y=<span class="number">5</span>)</span><br><span class="line">add(y=<span class="number">5</span>,x=<span class="number">4</span>)</span><br><span class="line"><span class="comment">## 调试清除缓存功能</span></span><br><span class="line">(<span class="number">4</span>,) &#123;&#125;</span><br><span class="line"><span class="number">3.003023</span></span><br><span class="line">(<span class="number">4</span>, <span class="number">5</span>) &#123;&#125;</span><br><span class="line"><span class="number">0.000211</span></span><br><span class="line">(<span class="number">4</span>,) &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>&#125;</span><br><span class="line"><span class="number">0.000121</span></span><br><span class="line">() &#123;<span class="string">&#x27;x&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>&#125;</span><br><span class="line"><span class="number">0.000418</span></span><br><span class="line">() &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;x&#x27;</span>: <span class="number">4</span>&#125;</span><br><span class="line"><span class="number">0.000123</span></span><br><span class="line">(<span class="number">4</span>,) &#123;&#125;</span><br><span class="line"><span class="number">3.003332</span></span><br><span class="line">(<span class="number">4</span>, <span class="number">5</span>) &#123;&#125;</span><br><span class="line"><span class="number">0.000277</span></span><br><span class="line">(<span class="number">4</span>,) &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>&#125;</span><br><span class="line"><span class="number">0.000198</span></span><br><span class="line">() &#123;<span class="string">&#x27;x&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>&#125;</span><br><span class="line"><span class="number">0.000182</span></span><br><span class="line">() &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;x&#x27;</span>: <span class="number">4</span>&#125;</span><br><span class="line"><span class="number">0.000179</span></span><br></pre></td></tr></table></figure>
<p>补充: 过期是什么 ？<br>它是某一个key过期，可以对每个key单独设置过期时间，也可以对这些key统一设定过期时间;<br>本次的实现就简单点，统一设定key的过期时间，当key生存超过了这个时间，就自动被清除;</p>
<ol start="2">
<li>写一个命令分发器<br>程序员可以方便的注册函数到某一个命令，用户输入命令时，路由到注册的函数;<br>如果此命令没有对应的注册函数，执行默认函数;<br>用户输入用input(“&gt;&gt;”)</li>
</ol>
<p>代码实现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmds_dispatcher</span>():</span></span><br><span class="line">    <span class="comment">#命令和函数存储的地方</span></span><br><span class="line">    commands = &#123;&#125;</span><br><span class="line">    <span class="comment"># 注册</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">name</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_reg</span>(<span class="params">fn</span>):</span></span><br><span class="line">            commands[name] =fn</span><br><span class="line">        <span class="keyword">return</span> _reg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">defaultfunc</span>():</span></span><br><span class="line">        print(<span class="string">&quot;Unknown command&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatcher</span>():</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> cmd.strip() == <span class="string">&#x27;quit&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            commands.get(cmd,defaultfunc)()</span><br><span class="line">    <span class="keyword">return</span> reg,dispatcher</span><br><span class="line">    </span><br><span class="line">cr,cp = cmds_dispatcher()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定久函数，注册</span></span><br><span class="line"><span class="meta">@cr(&#x27;mag&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span>():</span></span><br><span class="line">    print(<span class="string">&quot;welcome ssjinyao&quot;</span>)</span><br><span class="line"><span class="meta">@cr(&#x27;py&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span>():</span></span><br><span class="line">    print(<span class="string">&quot;welcome python&quot;</span>)</span><br><span class="line">cp()</span><br></pre></td></tr></table></figure>
<h3 id="装饰器的用途"><a href="#装饰器的用途" class="headerlink" title="装饰器的用途"></a>装饰器的用途</h3><p>装饰器是<strong>AOP面向切面编程 Aspect Oriented Programming</strong>的思想的体现;<br>面向对象往往需要通过继承或者组合依赖等方式调用一些功能，这些功能的代码往往可能在多个类中出现，例如logger。这样造成代码的重复，增加了耦合。logger的改变影响所有使用它的类或方法。<br>而AOP在需要的类或方法上切下，前后的切入点可以加入增强的功能。让调用者和被调用者解耦。<br>这是一种不修改原来的业务代码，给程序动态加功能的技术。例如logger函数功能就是对业务函数增加日志的，而业务函数中应该把业务无关的日志功能剥离干净。</p>
<p>装饰器应用场景<br>日志、监控、权限、设计、参数检查、路由等处理；<br>这些功能与业务功能无关，很多业务都需要的公共功能，所以适合独立出来，需要的时候，对目标对象增强。</p>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p><strong>不应以圣贤自命、以小人目人、面色如铁、话语如刀</strong></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python高阶函数函数和装饰器二</title>
    <url>/2020/08/31/python%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0%E5%92%8C%E8%A3%85%E9%A5%B0%E5%99%A8%E4%BA%8C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python高阶函数和装饰器二"><a href="#python高阶函数和装饰器二" class="headerlink" title="python高阶函数和装饰器二"></a>python高阶函数和装饰器二</h1><p><img src="/images/python_function.png" class="lazyload" data-srcset="/images/python_function.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="1-把一个字典扁平化"><a href="#1-把一个字典扁平化" class="headerlink" title="1. 把一个字典扁平化"></a>1. 把一个字典扁平化</h3><ul>
<li>源字典<code>&#123;&#39;a&#39;:&#123;&#39;b&#39;:1,&#39;c&#39;:2&#125;,&#39;d&#39;:&#123;&#39;e&#39;:3,&#39;f&#39;:&#123;&#39;g&#39;:4&#125;&#125;&#125;</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line">source = &#123;<span class="string">&#x27;a&#x27;</span>:&#123;<span class="string">&#x27;b&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;c&#x27;</span>:<span class="number">2</span>&#125;,<span class="string">&#x27;d&#x27;</span>:&#123;<span class="string">&#x27;e&#x27;</span>:<span class="number">3</span>,<span class="string">&#x27;f&#x27;</span>:&#123;<span class="string">&#x27;g&#x27;</span>:<span class="number">4</span>&#125;&#125;&#125;</span><br><span class="line">target = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatmap</span>(<span class="params">src,prefix=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(v,(<span class="built_in">list</span>,<span class="built_in">tuple</span>,<span class="built_in">set</span>,<span class="built_in">dict</span>)):</span><br><span class="line">            flatmap(v,prefix=prefix+k+<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            target[prefix+k] =v</span><br><span class="line">flatmap(source)</span><br><span class="line">print(target)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&#123;<span class="string">&#x27;a.b&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;a.c&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;d.e&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;d.f.g&#x27;</span>: <span class="number">4</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>方法二</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">source = &#123;<span class="string">&#x27;a&#x27;</span>:&#123;<span class="string">&#x27;b&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;c&#x27;</span>:<span class="number">2</span>&#125;,<span class="string">&#x27;d&#x27;</span>:&#123;<span class="string">&#x27;e&#x27;</span>:<span class="number">3</span>,<span class="string">&#x27;f&#x27;</span>:&#123;<span class="string">&#x27;g&#x27;</span>:<span class="number">4</span>&#125;&#125;&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatmap</span>(<span class="params">src,dest=<span class="literal">None</span>,prefix=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> dest == <span class="literal">None</span>:</span><br><span class="line">        dest = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(v,(<span class="built_in">list</span>,<span class="built_in">tuple</span>,<span class="built_in">set</span>,<span class="built_in">dict</span>)):</span><br><span class="line">            flatmap(v,dest,prefix=prefix+k+<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dest[prefix+k] = v</span><br><span class="line">    <span class="keyword">return</span> dest</span><br><span class="line">print(flatmap(source))</span><br></pre></td></tr></table></figure>
<ul>
<li>能否不暴露给外界内部的字典呢 ？</li>
<li>能否函数就提供一个参数源字典，返回一个新的扁平化字典呢 ？</li>
<li>递归的时候要把目录字典的引用传递多层，怎么处理？</li>
</ul>
<p>即: 方法三</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">source = &#123;<span class="string">&#x27;a&#x27;</span>:&#123;<span class="string">&#x27;b&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;c&#x27;</span>:<span class="number">2</span>&#125;,<span class="string">&#x27;d&#x27;</span>:&#123;<span class="string">&#x27;e&#x27;</span>:<span class="number">3</span>,<span class="string">&#x27;f&#x27;</span>:&#123;<span class="string">&#x27;g&#x27;</span>:<span class="number">4</span>&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatmap</span>(<span class="params">src</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_flatmap</span>(<span class="params">src,dest=<span class="literal">None</span>,prefix=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> src.items():</span><br><span class="line">            key = prefix + k</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(v,(<span class="built_in">list</span>,<span class="built_in">tuple</span>,<span class="built_in">set</span>,<span class="built_in">dict</span>)):</span><br><span class="line">                _flatmap(v,dest,key + <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dest[key] = v</span><br><span class="line"></span><br><span class="line">    dest = &#123;&#125;</span><br><span class="line">    _flatmap(src,dest)</span><br><span class="line">    <span class="keyword">return</span> dest</span><br><span class="line"></span><br><span class="line">print(flatmap(source))</span><br><span class="line"><span class="comment">#  输出</span></span><br><span class="line">&#123;<span class="string">&#x27;a.b&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;a.c&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;d.e&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;d.f.g&#x27;</span>: <span class="number">4</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-实现Base64编码"><a href="#2-实现Base64编码" class="headerlink" title="2. 实现Base64编码"></a>2. 实现Base64编码</h3><p>要求自己实现算法，不用库</p>
<p>说明:<br>将输入每3个字节断开，拿出一个3个字节，每6个bit断开成4段;<br>2**6 = 64，因此有了base64的编码表;<br>每一段当一个8big看它的值，这个值就是Base64编码表的索引值，找到对应字符；<br>再取3个字节，同样处理，直到最后。</p>
<p>举例:<br>abc对应原ASCII码为: 0x610 0x620 0x63<br>01100001 01100010 011000011 # abc<br>011000 010110 001001 100011<br>000111000 00010110 0001001 00100011 # 每6位补齐为8位</p>
<p>未尾的处理？<br>1、 正好3个字节，处理方式同上;<br>2、 剩1个字节或2个字节，用0满补3个字节;<br>3、 补0的的字节用=表示；</p>
<p>实现代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># 自已实现对一段字符串进行base64编码</span></span><br><span class="line">alphabet = <span class="string">b&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line">teststr = <span class="string">&quot;abcd&quot;</span></span><br><span class="line"><span class="comment">#teststr =&quot;ManMa&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64</span>(<span class="params">src</span>):</span></span><br><span class="line">    ret = <span class="built_in">bytearray</span>()</span><br><span class="line">    length = <span class="built_in">len</span>(src)</span><br><span class="line">    <span class="comment"># r记录补0的个数</span></span><br><span class="line">    r = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,length,<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">if</span> offset + <span class="number">3</span> &lt;= length:</span><br><span class="line">            triple = src[offset:offset+<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            triple = src[offset:]</span><br><span class="line">            r = <span class="number">3</span> - <span class="built_in">len</span>(triple)</span><br><span class="line">            triple = triple + <span class="string">&#x27;\x00&#x27;</span> * r <span class="comment"># 补几个0</span></span><br><span class="line">        <span class="comment"># print(triple,r)</span></span><br><span class="line">        <span class="comment"># 将3个字节看成一个整体转成字节bytes， 大端模式</span></span><br><span class="line">        <span class="comment"># abc =&gt; 0x616263</span></span><br><span class="line">        b = <span class="built_in">int</span>.from_bytes(triple.encode(),<span class="string">&#x27;big&#x27;</span>) <span class="comment">#小端模式为&#x27;little&#x27;</span></span><br><span class="line">        print(<span class="built_in">hex</span>(b))</span><br><span class="line">        <span class="comment"># 011000001 011000010 01100011 # abc</span></span><br><span class="line">        <span class="comment"># 011000 010110 001001 100011 # 每6位断开</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>, <span class="number">-1</span>, <span class="number">-6</span>):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">18</span>:</span><br><span class="line">                index = b &gt;&gt; i</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                index = b &gt;&gt; i &amp; <span class="number">0x3F</span> <span class="comment">#0b0011 1111</span></span><br><span class="line">            <span class="comment"># 得到base64编码的列表</span></span><br><span class="line">            ret.append(alphabet[index])</span><br><span class="line">        <span class="comment"># 策略是不管是不是补零，都填满， 只有最后一次可能出现补零的;</span></span><br><span class="line">        <span class="comment"># 在最后替换掉就是了，代码清晰，而且替换至多2次;</span></span><br><span class="line">        <span class="comment"># 在上一个循环中判断 r!=0，效率可能会高些;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, r+<span class="number">1</span>): <span class="comment"># 1到r,补几个0替换几个=</span></span><br><span class="line">            ret[-i]  = <span class="number">0x3D</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(ret)</span><br><span class="line">print(base64(teststr))</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">print(base64.b64encode(teststr.encode()))</span><br><span class="line"><span class="comment"># 输出 </span></span><br><span class="line"><span class="number">0x616263</span></span><br><span class="line"><span class="number">0x640000</span></span><br><span class="line"><span class="string">b&#x27;YWJjZA==&#x27;</span></span><br><span class="line"><span class="string">b&#x27;YWJjZA==&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-求2个字符串的最长公共子串"><a href="#3-求2个字符串的最长公共子串" class="headerlink" title="3. 求2个字符串的最长公共子串"></a>3. 求2个字符串的最长公共子串</h3><p>思考:</p>
<p><code>s1 = &#39;abcdefg&#39;</code><br><code>s2 = &#39;defabcd&#39;</code></p>
<p>可不可以这样思考？<br>字符串都是连续的字符，所以才有了下面的思路。</p>
<p>思路一:<br>第一轮<br>从s1中依次取1个字符，在s2查找，看是否能够找到子串;<br>如果没 一个字符在s2中找到，说明就没有公共子串，直接退出。如果找到了至少一个公共子串，则很有可能还有更长的公共子串，可以进入下一轮;</p>
<p>第二轮<br>然后从s1中取连续的2个字符，在s2中找，看看能否找到公共的子串。如果没找到，说明最大公共子串就是上一轮的随便的一个就行了。如果找到至少一个，则说明公共子串可能还可以再长一些。可进入下一轮;</p>
<p>改进，其实只要找到第一轮的公共子串的索引，最长公共子串也是从它开始的，所以以后的轮次都从这些索引位置开始，可以减少比较的次数;</p>
<p>思路二:<br>既然是求最大的字串，我先看s1全长作为子串;<br>在s2中搜索，是否返回正常的index, 正常就找到了最长子串。</p>
<p>没有找到，把s1按照 length-1取多个子串;<br>在s2中搜索，是否能返回正常的index。</p>
<p>注意:<br>不要一次把s1的所有子串生成，用不了，也不要从最短开始，因为题目要最长的;<br>但是也要注意，万一他们公共子串就只有一个字符，或者很少字符的，思路就一就会占优势。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line">s1 = <span class="string">&#x27;abcdefg&#x27;</span></span><br><span class="line">s2 = <span class="string">&#x27;defabcdoabcdeftw&#x27;</span></span><br><span class="line">s3 = <span class="string">&#x27;1234a&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findit</span>(<span class="params">str1,str2</span>):</span></span><br><span class="line">    count = <span class="number">0</span><span class="comment"># 看看效率，计数;</span></span><br><span class="line">    length = <span class="built_in">len</span>(str1)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> sublen <span class="keyword">in</span> <span class="built_in">range</span>(length,<span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">for</span> start <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length - sublen +<span class="number">1</span>):</span><br><span class="line">            substr = str1[start:start + sublen]</span><br><span class="line">            count +=<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> str2.find(substr) &gt; <span class="number">-1</span>: <span class="comment"># found</span></span><br><span class="line">                print(<span class="string">&quot;count=&#123;&#125;, substrlen=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(count,sublen))</span><br><span class="line">                <span class="keyword">return</span> substr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(findit(s1,s2))</span><br><span class="line">print(findit(s1,s3))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">count=<span class="number">2</span>, substrlen=<span class="number">6</span></span><br><span class="line">abcdef</span><br><span class="line">count=<span class="number">22</span>, substrlen=<span class="number">1</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>
<p>让s2的每一个元素，去分别和s2的每一个元素比较，相同就是1，不同就是0，有下面的矩阵;</p>
<table>
<thead>
<tr>
<th></th>
<th>S1</th>
</tr>
</thead>
<tbody>
<tr>
<td>S1</td>
<td>0001000</td>
</tr>
<tr>
<td>S1</td>
<td>0000100</td>
</tr>
<tr>
<td>S1</td>
<td>0000010</td>
</tr>
<tr>
<td>S1</td>
<td>1000000</td>
</tr>
<tr>
<td>S1</td>
<td>0010000</td>
</tr>
<tr>
<td>S1</td>
<td>0001000</td>
</tr>
</tbody>
</table>
<p>上面都是s1的索引<br>看与斜对角线平行的线，这个线是穿过1的，那么最长的就是最长子串;<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(s1[<span class="number">3</span>:<span class="number">3</span>+<span class="number">3</span>])</span><br><span class="line">print(s1[<span class="number">0</span>:<span class="number">0</span>+<span class="number">4</span>])最长</span><br></pre></td></tr></table></figure><br>矩阵求法还fdms一个字符扫描最子子串的过程，扫描的过程就是<code>len(s1) len(s2)次，0(nm)</code><br>有办法一遍循环就找出最长的子串吗？<br><code>0001000</code>第一行，索引为3,0;<br>第二行的时候如果4,1是1，就判断3,0是否为1，为1就把3,0加1;<br>第二行的进修如果5,2是1，就判断4,1是否为1，是1就加1，再就判断3,0是否为1，为1就把3,0加1;</p>
<table>
<thead>
<tr>
<th></th>
<th>S1</th>
</tr>
</thead>
<tbody>
<tr>
<td>s1</td>
<td>0003000</td>
</tr>
<tr>
<td>s1</td>
<td>0000200</td>
</tr>
<tr>
<td>s1</td>
<td>0000010</td>
</tr>
<tr>
<td>s1</td>
<td>4000000</td>
</tr>
<tr>
<td>s1</td>
<td>0300000</td>
</tr>
<tr>
<td>s1</td>
<td>0020000</td>
</tr>
<tr>
<td>s1</td>
<td>0001000</td>
</tr>
</tbody>
</table>
<p>上面的方法是个递归问题，不好。<br>最后在矩阵中找到最大的元素，从它开始就能写出最长的子串了。<br>但是这个不好算，因为是逆推的，改为顺推。</p>
<table>
<thead>
<tr>
<th></th>
<th>s1</th>
</tr>
</thead>
<tbody>
<tr>
<td>S1</td>
<td>0001000</td>
</tr>
<tr>
<td>s1</td>
<td>0000200</td>
</tr>
<tr>
<td>s1</td>
<td>0000030</td>
</tr>
<tr>
<td>s1</td>
<td>1000000</td>
</tr>
<tr>
<td>s1</td>
<td>0200000</td>
</tr>
<tr>
<td>s1</td>
<td>0030000</td>
</tr>
<tr>
<td>s1</td>
<td>0004000</td>
</tr>
</tbody>
</table>
<p>顺推的意思，就是如果找到一个就看前一个的数字是几，然后在它的基础上加1。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s1 = <span class="string">&#x27;abcdefg&#x27;</span></span><br><span class="line">s2 = <span class="string">&#x27;defabcd&#x27;</span></span><br><span class="line">s2 = <span class="string">&#x27;defabcdoabcdeftw&#x27;</span></span><br><span class="line">s3 = <span class="string">&#x27;1234a&#x27;</span></span><br><span class="line">s4 = <span class="string">&#x27;5678&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findit</span>(<span class="params">str1,str2</span>):</span></span><br><span class="line">    matrix = []</span><br><span class="line">    <span class="comment"># 从x轴或者y轴取都可以，选择x轴，xmax和xindex</span></span><br><span class="line">    xmax = <span class="number">0</span></span><br><span class="line">    xindex = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i,x <span class="keyword">in</span> <span class="built_in">enumerate</span>(str2):</span><br><span class="line">        matrix.append([])</span><br><span class="line">        <span class="keyword">for</span> j,y <span class="keyword">in</span> <span class="built_in">enumerate</span>(str1):</span><br><span class="line">            <span class="keyword">if</span> x !=y :</span><br><span class="line">                matrix[i].append(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> x == <span class="number">0</span> <span class="keyword">or</span> y ==<span class="number">0</span>: <span class="comment"># 在边上</span></span><br><span class="line">                    matrix[i].append(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>: <span class="comment"># 不在边上</span></span><br><span class="line">                    matrix[i].append(matrix[i<span class="number">-1</span>][j<span class="number">-1</span>]+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> matrix[i][j] &gt; xmax: <span class="comment"># 判断当前加入的值和记录的最大值比较</span></span><br><span class="line">                    xmax =  matrix[i][j]<span class="comment"># 记录最大值，用于下次比较</span></span><br><span class="line">                    xindex = j          <span class="comment"># 记录当前值的x轴偏移量</span></span><br><span class="line">                    xindex += <span class="number">1</span>         <span class="comment"># 切片的时候不包，因此+1</span></span><br><span class="line">    <span class="keyword">return</span> str1[xindex - xmax: xindex]<span class="comment"># xmax 正好是子串的长度</span></span><br><span class="line"></span><br><span class="line">print(findit(s1,s2))</span><br><span class="line">print(findit(s1,s3)) <span class="comment">#a</span></span><br><span class="line">print(findit(s1,s4)) <span class="comment">#空串</span></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">abcdef</span><br><span class="line">a</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Python树的遍历和堆排序"><a href="#Python树的遍历和堆排序" class="headerlink" title="Python树的遍历和堆排序"></a>Python树的遍历和堆排序</h2><h3 id="二叉树的遍历"><a href="#二叉树的遍历" class="headerlink" title="二叉树的遍历"></a>二叉树的遍历</h3><ul>
<li>遍历: 迭代所有元素一遍;</li>
<li><p>树的遍历: 对树中的所有元素不重复地访问一遍，也称作扫描;</p>
</li>
<li><p>广度优先遍历</p>
</li>
</ul>
<ol>
<li>层序遍历</li>
</ol>
<ul>
<li>深度优先遍历</li>
</ul>
<ol>
<li>前序遍历</li>
<li>中序遍历</li>
<li>后序遍历</li>
</ol>
<ul>
<li><p>遍历序列: 将树中的所有元素遍历一遍后，得到的无素的序列。将层次结构转换成了线性结构;</p>
</li>
<li><p>层序遍历</p>
</li>
</ul>
<ol>
<li>按照树的层次，从第一层开始，自左向右的遍历元素;</li>
<li><p>遍历序列<br> ABCDEFGHI</p>
<p> <img src="/images/erchashu001.png" class="lazyload" data-srcset="/images/erchashu001.png" srcset="data:image/png;base64,666" alt=""></p>
</li>
</ol>
<ul>
<li>深度优先遍历</li>
</ul>
<ol>
<li>设树的根结点为D，左子树为L，右子树为R，且要求L一定在R之前，则有下面几种遍历方式:</li>
<li>前序遍历，也叫先序遍历，也叫先根遍历，DLR;</li>
<li>中序遍历，也叫中根遍历， LDR;</li>
<li>后序遍历，也叫后根遍历，LRD;</li>
</ol>
<p>二叉树的遍历</p>
<ul>
<li>前序遍历DLR</li>
</ul>
<ol>
<li>从根结点开始，先左子树后右子树;</li>
<li>每个子树内部依然是先根结点，再左子树后右子树，递归遍历;</li>
<li>遍历序列;<br> A BDGH CEIF</li>
</ol>
<p><img src="/images/erchashu002.png" class="lazyload" data-srcset="/images/erchashu002.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>中序遍历LDR</li>
</ul>
<ol>
<li>从根结点的左子树开始遍历，然后是根结点，再右子树；</li>
<li>每个子树内部，也是先左子树，后根结点，再右子树。递归遍历;</li>
<li>遍历序列;</li>
</ol>
<p>GDHB A IECF</p>
<p><img src="/images/erchashu003.png" class="lazyload" data-srcset="/images/erchashu003.png" srcset="data:image/png;base64,666" alt=""></p>
<p>GDHB A EICF</p>
<p><img src="/images/erchashu004.png" class="lazyload" data-srcset="/images/erchashu004.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>后序遍历LRD</li>
</ul>
<ol>
<li>先左子树，后右子树，再根结点;</li>
<li>每个子树内部依然是先左子树，后右子树，再根结点。递归遍历;</li>
<li>遍历序列;</li>
</ol>
<p>GHDB IEFC A </p>
<p><img src="/images/erchashu005.png" class="lazyload" data-srcset="/images/erchashu005.png" srcset="data:image/png;base64,666" alt=""></p>
<h4 id="堆排序Heap-Sort"><a href="#堆排序Heap-Sort" class="headerlink" title="堆排序Heap Sort"></a>堆排序Heap Sort</h4><ul>
<li>堆Heap</li>
</ul>
<ol>
<li>堆是一个完全二叉树;</li>
<li>每个非叶子结点都要大于或者等于其左右孩子结点的值称为大顶堆;</li>
<li>每个非叶子结点都要小于或者等于其左右孩子结点的值称为小顶堆;</li>
<li>根结点一定是大顶堆中的最大值，一定是小顶堆中的最小值;</li>
</ol>
<ul>
<li>大顶堆</li>
</ul>
<ol>
<li>完全二叉树的每个非叶子结点都要大于或者等于其左右孩子结点的值称为大顶堆;</li>
<li>根结点一定是大顶堆中的最大值;</li>
</ol>
<p><img src="/images/dadingdui001.png" class="lazyload" data-srcset="/images/dadingdui001.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>小顶堆</li>
</ul>
<ol>
<li>完全二叉树的每个非叶子结点都要小于或者等于其左右孩子结点的值称为小顶堆;</li>
<li>根结点一定是小顶堆的最小值;</li>
</ol>
<p><img src="/images/xiaodingdui001.png" class="lazyload" data-srcset="/images/xiaodingdui001.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>构建完全二叉树</li>
</ul>
<ol>
<li>待排序数字为 30,20,80,40,50,10,60,70,90;</li>
<li>构建一个完全二叉存放数据，并根据性质5对元素编号，放入顺序的数据结构中;</li>
<li>构建一个列表为[0,30,20,80,40,50,10,60,70,90]</li>
</ol>
<p><img src="/images/heap_sort001.png" class="lazyload" data-srcset="/images/heap_sort001.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>构建大顶堆–核心算法</li>
</ul>
<ol>
<li>度数为2的结点A, 如果它的左右孩子结点的最大值比它大的，将这个最大值和该结点交换;</li>
<li>度数为1的结点A, 如果它的左孩子的值在于它，则交换;</li>
<li>如果结点A被交换到新的位置，还需要和其孩子结点重复上面的过程;</li>
</ol>
<p><img src="/images/goujiandadui001.png" class="lazyload" data-srcset="/images/goujiandadui001.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>构建大顶堆–起点结点的选择;</li>
</ul>
<ol>
<li>从完全二叉树的最后一个结点的双亲结点开始，即最后一层的最右边叶子结点的父结点开始;</li>
<li>结点数为n，则起始结点的编号n//2</li>
</ol>
<ul>
<li>构建大顶堆–下一个结点的把选择</li>
<li>从起始结点开始向左找其同层结点，到头后再从上一层的最右边结开始继续向左逐个查找，下直到根结点;</li>
<li><p>大顶堆的目标</p>
<p>确保每个结点的都比左右右结点的值大;</p>
</li>
<li><p>排序</p>
</li>
</ul>
<ol>
<li><p>将大顶堆根结点这个最大值和最后一个叶子结点交换，那么最后一个叶子结点就是最大值，将这个叶子结点排除在待排序结点之后;</p>
</li>
<li><p>从根结点开始(新的结点)，重新调整为大顶堆后，重复上一步;</p>
</li>
</ol>
<p><img src="/images/dadingdui-sort.png" class="lazyload" data-srcset="/images/dadingdui-sort.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>排序</li>
</ul>
<ol>
<li>堆顶和最后一个结点交换，并排除最后一个结点;</li>
</ol>
<p><img src="/images/dadingdui-sort-001.png" class="lazyload" data-srcset="/images/dadingdui-sort-001.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/dadingdui_sort003.png" class="lazyload" data-srcset="/images/dadingdui_sort003.png" srcset="data:image/png;base64,666" alt=""></p>
<h4 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h4><p>打印一个树</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">origin = [<span class="number">30</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">40</span>,<span class="number">50</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">70</span>,<span class="number">90</span>]</span><br><span class="line">                                <span class="number">30</span></span><br><span class="line">                        <span class="number">20</span>                  <span class="number">80</span></span><br><span class="line">                <span class="number">40</span>              <span class="number">50</span>  <span class="number">10</span>              <span class="number">60</span></span><br><span class="line">        <span class="number">70</span>              <span class="number">90</span></span><br></pre></td></tr></table></figure>
<p>思路:<br>每一行取1个，第二行取2个，第三行取3个，以此类推;<br>投影来思考一个栅格系统;</p>
<p>代码实现<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_tree</span>(<span class="params">array</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    前空格  元素间</span></span><br><span class="line"><span class="string">1   7       0</span></span><br><span class="line"><span class="string">2   3       7</span></span><br><span class="line"><span class="string">3   1       3</span></span><br><span class="line"><span class="string">4   0       1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    depth = math.ceil(math.log2(<span class="built_in">len</span>(array))) <span class="comment"># 因为补0了，不然应该是math.ceil(math.log2(len(array)+1))</span></span><br><span class="line">    sep = <span class="string">&#x27;    &#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">        offset = <span class="number">2</span> ** i</span><br><span class="line">        print(sep *(<span class="number">2</span> **(depth -i <span class="number">-1</span>) <span class="number">-1</span>),end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        line = array[index:index+offset]</span><br><span class="line">        <span class="keyword">for</span> j,x <span class="keyword">in</span> <span class="built_in">enumerate</span>(line):</span><br><span class="line">            print(<span class="string">&quot;&#123;:&gt;&#123;&#125;&#125;&quot;</span>.<span class="built_in">format</span>(x,<span class="built_in">len</span>(sep)), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            interval =<span class="number">0</span> <span class="keyword">if</span> i ==<span class="number">0</span> <span class="keyword">else</span> <span class="number">2</span>**(depth -i) <span class="number">-1</span></span><br><span class="line">            <span class="keyword">if</span> j &lt; <span class="built_in">len</span>(line) <span class="number">-1</span>:</span><br><span class="line">                print(sep * interval,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        index += offset</span><br><span class="line">        print()</span><br><span class="line"></span><br><span class="line">print_tree([<span class="number">0</span>,<span class="number">30</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">40</span>,<span class="number">50</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">70</span>,<span class="number">90</span>,<span class="number">22</span>])</span><br><span class="line">print_tree([<span class="number">0</span>,<span class="number">30</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">40</span>,<span class="number">50</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">70</span>,<span class="number">90</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>,<span class="number">55</span>,<span class="number">66</span>,<span class="number">77</span>])</span><br><span class="line">print_tree([<span class="number">0</span>,<span class="number">30</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">40</span>,<span class="number">50</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">70</span>,<span class="number">90</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>,<span class="number">55</span>,<span class="number">66</span>,<span class="number">77</span>,<span class="number">88</span>,<span class="number">99</span>])</span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line">                              <span class="number">30</span></span><br><span class="line">              <span class="number">20</span>                              <span class="number">80</span></span><br><span class="line">      <span class="number">40</span>              <span class="number">50</span>              <span class="number">10</span>              <span class="number">60</span></span><br><span class="line">  <span class="number">70</span>      <span class="number">90</span>      <span class="number">22</span></span><br><span class="line">                              <span class="number">30</span></span><br><span class="line">              <span class="number">20</span>                              <span class="number">80</span></span><br><span class="line">      <span class="number">40</span>              <span class="number">50</span>              <span class="number">10</span>              <span class="number">60</span></span><br><span class="line">  <span class="number">70</span>      <span class="number">90</span>      <span class="number">22</span>      <span class="number">33</span>      <span class="number">44</span>      <span class="number">55</span>      <span class="number">66</span>      <span class="number">77</span></span><br><span class="line">                                                              <span class="number">30</span></span><br><span class="line">                              <span class="number">20</span>                                                              <span class="number">80</span></span><br><span class="line">              <span class="number">40</span>                              <span class="number">50</span>                              <span class="number">10</span>                              <span class="number">60</span></span><br><span class="line">      <span class="number">70</span>              <span class="number">90</span>              <span class="number">22</span>              <span class="number">33</span>              <span class="number">44</span>              <span class="number">55</span>              <span class="number">66</span>              <span class="number">77</span></span><br><span class="line">  <span class="number">88</span>      <span class="number">99</span></span><br></pre></td></tr></table></figure></p>
<h4 id="堆调整"><a href="#堆调整" class="headerlink" title="堆调整"></a>堆调整</h4><ul>
<li>核心算法<br>对于堆排序的核心算法就是堆结点的调整</li>
</ul>
<ol>
<li>度数为2的结点A，如果它的左右孩子结点的最大值比它大的，将这个最大值和该结点交换;</li>
<li>度数为1的结点A，如果它的左右孩子的值大于它，则交换;</li>
<li>如果结点A被交换到新的位置，还需要和其孩子 结点重复上面的过程;</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_tree</span>(<span class="params">array</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    前空格  元素间</span></span><br><span class="line"><span class="string">1   7       0</span></span><br><span class="line"><span class="string">2   3       7</span></span><br><span class="line"><span class="string">3   1       3</span></span><br><span class="line"><span class="string">4   0       1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    depth = math.ceil(math.log2(<span class="built_in">len</span>(array))) <span class="comment"># 因为补0了，不然应该是math.ceil(math.log2(len(array)+1))</span></span><br><span class="line">    sep = <span class="string">&#x27;    &#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">        offset = <span class="number">2</span> ** i</span><br><span class="line">        print(sep *(<span class="number">2</span> **(depth -i <span class="number">-1</span>) <span class="number">-1</span>),end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        line = array[index:index+offset]</span><br><span class="line">        <span class="keyword">for</span> j,x <span class="keyword">in</span> <span class="built_in">enumerate</span>(line):</span><br><span class="line">            print(<span class="string">&quot;&#123;:&gt;&#123;&#125;&#125;&quot;</span>.<span class="built_in">format</span>(x,<span class="built_in">len</span>(sep)), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            interval =<span class="number">0</span> <span class="keyword">if</span> i ==<span class="number">0</span> <span class="keyword">else</span> <span class="number">2</span>**(depth -i) <span class="number">-1</span></span><br><span class="line">            <span class="keyword">if</span> j &lt; <span class="built_in">len</span>(line) <span class="number">-1</span>:</span><br><span class="line">                print(sep * interval,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        index += offset</span><br><span class="line">        print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Heap Sort</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了和编码对应，增加一个无用的0在首位</span></span><br><span class="line"><span class="comment"># origin = [0,50,10,90,30,70,40,80,60,20]</span></span><br><span class="line">origin = [<span class="number">0</span>,<span class="number">30</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">40</span>,<span class="number">50</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">70</span>,<span class="number">90</span>]</span><br><span class="line"></span><br><span class="line">total = <span class="built_in">len</span>(origin) <span class="number">-1</span> <span class="comment"># 初始待排序元素个数，即n</span></span><br><span class="line"><span class="comment"># print_tree([0,30,20,80,40,50,10,60,70,90,22])</span></span><br><span class="line"><span class="comment"># print_tree([0,30,20,80,40,50,10,60,70,90,22,33,44,55,66,77])</span></span><br><span class="line"><span class="comment"># print_tree([0,30,20,80,40,50,10,60,70,90,22,33,44,55,66,77,88,99])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_adjust</span>(<span class="params">n, i, array: <span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    调整当前结点(核心算法)</span></span><br><span class="line"><span class="string">    调整的结点的起点在n//2，保证所有调整的结点都有孩子结点</span></span><br><span class="line"><span class="string">    :param n: 待比较数个数</span></span><br><span class="line"><span class="string">    :param i: 当前结点的下标</span></span><br><span class="line"><span class="string">    :param array: 待排序数据</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="number">2</span> * i &lt;=n:</span><br><span class="line">        <span class="comment">#孩子结点判断2i为左孩子，2i+1为右孩子</span></span><br><span class="line">        lchile_index = <span class="number">2</span> * i</span><br><span class="line">        max_child_index = lchile_index <span class="comment"># n=2i</span></span><br><span class="line">        <span class="keyword">if</span> n &gt; lchile_index <span class="keyword">and</span> array[lchile_index +<span class="number">1</span> ]&gt; array[lchile_index]:<span class="comment"># n&gt;2i说明还有右孩子</span></span><br><span class="line">            max_child_index = lchile_index +<span class="number">1</span></span><br><span class="line">        <span class="comment"># 和子树的根结点比较</span></span><br><span class="line">        <span class="keyword">if</span> array[max_child_index] &gt; array[i]:</span><br><span class="line">            array[i],array[max_child_index] = array[max_child_index],array[i]</span><br><span class="line">            i = max_child_index <span class="comment"># 被交换后，需要判断是否还需要调整</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#print_tree(array)</span></span><br><span class="line">heap_adjust(total,total//<span class="number">2</span>,origin)</span><br><span class="line">print(origin)</span><br><span class="line">print_tree((origin))</span><br></pre></td></tr></table></figure>
<p>到目前为止也只是解决了单个结点的调整，下面要使用循环来今次解决比起始结点编号小的结点;</p>
<h4 id="构建大顶堆"><a href="#构建大顶堆" class="headerlink" title="构建大顶堆"></a>构建大顶堆</h4><ul>
<li><p>起点的选择<br>从最下层最右叶子结点的父结点开始；<br>由于构造了一个前置的0，所以编号和列表索引正好重合;</p>
</li>
<li><p>下一个结点</p>
</li>
</ul>
<p>按照二叉树性质5编号的结点，从起点开始找编号逐个递减的结点，直到编号1;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_tree</span>(<span class="params">array</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    前空格  元素间</span></span><br><span class="line"><span class="string">1   7       0</span></span><br><span class="line"><span class="string">2   3       7</span></span><br><span class="line"><span class="string">3   1       3</span></span><br><span class="line"><span class="string">4   0       1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line">    depth = math.ceil(math.log2(<span class="built_in">len</span>(array))) <span class="comment"># 因为补0了，不然应该是math.ceil(math.log2(len(array)+1))</span></span><br><span class="line">    sep = <span class="string">&#x27;    &#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(depth):</span><br><span class="line">        offset = <span class="number">2</span> ** i</span><br><span class="line">        print(sep *(<span class="number">2</span> **(depth -i <span class="number">-1</span>) <span class="number">-1</span>),end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        line = array[index:index+offset]</span><br><span class="line">        <span class="keyword">for</span> j,x <span class="keyword">in</span> <span class="built_in">enumerate</span>(line):</span><br><span class="line">            print(<span class="string">&quot;&#123;:&gt;&#123;&#125;&#125;&quot;</span>.<span class="built_in">format</span>(x,<span class="built_in">len</span>(sep)), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            interval =<span class="number">0</span> <span class="keyword">if</span> i ==<span class="number">0</span> <span class="keyword">else</span> <span class="number">2</span>**(depth -i) <span class="number">-1</span></span><br><span class="line">            <span class="keyword">if</span> j &lt; <span class="built_in">len</span>(line) <span class="number">-1</span>:</span><br><span class="line">                print(sep * interval,end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        index += offset</span><br><span class="line">        print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Heap Sort</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了和编码对应，增加一个无用的0在首位</span></span><br><span class="line"><span class="comment"># origin = [0,50,10,90,30,70,40,80,60,20]</span></span><br><span class="line">origin = [<span class="number">0</span>,<span class="number">30</span>,<span class="number">20</span>,<span class="number">80</span>,<span class="number">40</span>,<span class="number">50</span>,<span class="number">10</span>,<span class="number">60</span>,<span class="number">70</span>,<span class="number">90</span>]</span><br><span class="line"></span><br><span class="line">total = <span class="built_in">len</span>(origin) <span class="number">-1</span> <span class="comment"># 初始待排序元素个数，即n</span></span><br><span class="line"><span class="comment"># print_tree([0,30,20,80,40,50,10,60,70,90,22])</span></span><br><span class="line"><span class="comment"># print_tree([0,30,20,80,40,50,10,60,70,90,22,33,44,55,66,77])</span></span><br><span class="line"><span class="comment"># print_tree([0,30,20,80,40,50,10,60,70,90,22,33,44,55,66,77,88,99])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_adjust</span>(<span class="params">n, i, array: <span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    调整当前结点(核心算法)</span></span><br><span class="line"><span class="string">    调整的结点的起点在n//2，保证所有调整的结点都有孩子结点</span></span><br><span class="line"><span class="string">    :param n: 待比较数个数</span></span><br><span class="line"><span class="string">    :param i: 当前结点的下标</span></span><br><span class="line"><span class="string">    :param array: 待排序数据</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="number">2</span> * i &lt;=n:</span><br><span class="line">        <span class="comment">#孩子结点判断2i为左孩子，2i+1为右孩子</span></span><br><span class="line">        lchile_index = <span class="number">2</span> * i</span><br><span class="line">        max_child_index = lchile_index <span class="comment"># n=2i</span></span><br><span class="line">        <span class="keyword">if</span> n &gt; lchile_index <span class="keyword">and</span> array[lchile_index +<span class="number">1</span> ]&gt; array[lchile_index]:<span class="comment"># n&gt;2i说明还有右孩子</span></span><br><span class="line">            max_child_index = lchile_index +<span class="number">1</span></span><br><span class="line">        <span class="comment"># 和子树的根结点比较</span></span><br><span class="line">        <span class="keyword">if</span> array[max_child_index] &gt; array[i]:</span><br><span class="line">            array[i],array[max_child_index] = array[max_child_index],array[i]</span><br><span class="line">            i = max_child_index <span class="comment"># 被交换后，需要判断是否还需要调整</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#print_tree(array)</span></span><br><span class="line"><span class="comment"># 构建大顶堆、大根堆</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_heap</span>(<span class="params">total,array:<span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(total//<span class="number">2</span>,<span class="number">0</span>,<span class="number">-1</span>):</span><br><span class="line">        heap_adjust(total,i,array)</span><br><span class="line">    <span class="keyword">return</span> array</span><br><span class="line"></span><br><span class="line">print_tree(origin)</span><br><span class="line">print_tree(max_heap(total,origin))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">                              <span class="number">30</span></span><br><span class="line">              <span class="number">20</span>                              <span class="number">80</span></span><br><span class="line">      <span class="number">40</span>              <span class="number">50</span>              <span class="number">10</span>              <span class="number">60</span></span><br><span class="line">  <span class="number">70</span>      <span class="number">90</span></span><br><span class="line">                              <span class="number">90</span></span><br><span class="line">              <span class="number">70</span>                              <span class="number">80</span></span><br><span class="line">      <span class="number">40</span>              <span class="number">50</span>              <span class="number">10</span>              <span class="number">60</span></span><br><span class="line">  <span class="number">20</span>      <span class="number">30</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>结论，最大的一定在第一层，第二层一定有一个次大的;</p>
</li>
<li><p>排序</p>
</li>
</ul>
<ol>
<li>每次都要让堆顶的元素和最后一个结点交换，然后排除最后一些元素，开成一个新的被破坏的堆；</li>
<li>让它重新调整，调整后，堆顶一定是最大的元素;</li>
<li>再次重复第1、2步直剩余一个元素;</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span>(<span class="params">total,array:<span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="keyword">while</span> total &gt; <span class="number">1</span>:</span><br><span class="line">        array[<span class="number">1</span>], array[total] = array[total],array[<span class="number">1</span>] <span class="comment">#堆顶和最后一个结点交换</span></span><br><span class="line">        total -=<span class="number">1</span></span><br><span class="line">        heap_adjust(total,<span class="number">1</span>,array)</span><br><span class="line">    <span class="keyword">return</span> array</span><br><span class="line">print_tree(sort(total,origin))</span><br></pre></td></tr></table></figure>
<p>改进</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span>(<span class="params">total, array:<span class="built_in">list</span></span>):</span></span><br><span class="line">    <span class="keyword">while</span> total &gt;<span class="number">1</span>:</span><br><span class="line">        array[<span class="number">1</span>],array[total] = array[total],array[<span class="number">1</span>]<span class="comment"># 堆顶和最后一个结点交换</span></span><br><span class="line">        total -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> total == <span class="number">2</span> <span class="keyword">and</span> array[total] &gt;= array[total<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        heap_adjust(total,<span class="number">1</span>,array)</span><br><span class="line">    <span class="keyword">return</span>  array</span><br><span class="line">print_tree(origin)</span><br><span class="line">print_tree(sort(total,origin))</span><br></pre></td></tr></table></figure>
<h5 id="总结堆排序"><a href="#总结堆排序" class="headerlink" title="总结堆排序"></a>总结堆排序</h5><ul>
<li>是利用堆性质的一种选择排序，在堆 顶选出最大值或者最小值;</li>
<li><p>时间复杂度;</p>
<ol>
<li>堆排序的时间复杂度为O(nlogn)</li>
<li>由于堆排序对原始记录的排序状态并不敏感，因hxpx无论是最好、最坏和平均时间复杂度均为O(nlogn)<br>nlogn 可以大大提高排序的效率；</li>
</ol>
</li>
<li><p>空间复杂度</p>
<ol>
<li>只是使用了一个交换用的空间，空间复杂度就是O(1)</li>
</ol>
</li>
<li><p>稳定性</p>
<ol>
<li>不稳定的排序算法；</li>
</ol>
</li>
</ul>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p>天下事无所为而成者极少，有所贪有所利而成者居其半，有所激有所逼而成者居其半;<br>百端拂逆之时，亦只有逆来顺受之法;<br>“所谓’好汉打掉牙和血吞’ 真处离境之良法也；</p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python高阶函数函数和装饰器一</title>
    <url>/2020/08/25/python%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0%E5%92%8C%E8%A3%85%E9%A5%B0%E5%99%A8%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python高阶函数和装饰器一"><a href="#python高阶函数和装饰器一" class="headerlink" title="python高阶函数和装饰器一"></a>python高阶函数和装饰器一</h1><p><img src="/images/python_function.png" class="lazyload" data-srcset="/images/python_function.png" srcset="data:image/png;base64,666" alt=""></p>
<ul>
<li>First Class Object;</li>
</ul>
<p>1.函数在python中是一等公民;<br>2.函数也是对象，可调用的对象;<br>3.函数可以作为普通变量、参数、返回值等;</p>
<ul>
<li>高阶函数</li>
</ul>
<p>1.数据概念<code>y=g(f(x))</code>;<br>2.在数学和计算机科学中，高阶函数应当是至少满足下面一个条件的函数;</p>
<p>接受一个多个函数作为参数;<br>输出一个函数;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">counter</span>(<span class="params">base</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inc</span>(<span class="params">step=<span class="number">1</span></span>):</span></span><br><span class="line">        <span class="keyword">nonlocal</span> base</span><br><span class="line">        base = base + step</span><br><span class="line">        <span class="keyword">return</span> base</span><br><span class="line">    <span class="keyword">return</span> inc</span><br><span class="line">foo = counter(<span class="number">10</span>)</span><br><span class="line">foo1 = counter(<span class="number">10</span>)</span><br><span class="line">print(foo())</span><br><span class="line">print(foo1())</span><br></pre></td></tr></table></figure>
<h2 id="自定义sort-函数"><a href="#自定义sort-函数" class="headerlink" title="自定义sort 函数"></a>自定义sort 函数</h2><ul>
<li>排序问题</li>
</ul>
<p>1.仿照内建函数sorted, 请自行实现一个sort函数(不使用内建函数),能够为列表元素排序;</p>
<ul>
<li>思路</li>
</ul>
<p>1.内建函数sorted函数是一个返回一个<strong>新的列表</strong>， 可以设置<strong>升序或降序</strong>,也可以设置一个 <strong>排序的函数</strong>;自定义的sort函数也要实现这个功能;<br>2.新建一个列表, 遍历原列表，和新列表的值依次比较决定如何插入新列表中;</p>
<ul>
<li>思考<br>sorted  函数的实现原理，扩展到map、 filter函数的实现原理;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort</span>(<span class="params">iterable,key=<span class="keyword">lambda</span> a,b:a&lt;b, reverse=<span class="literal">False</span></span>):</span></span><br><span class="line">    ret = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> iterable:</span><br><span class="line">        <span class="keyword">for</span> i,y <span class="keyword">in</span> <span class="built_in">enumerate</span>(ret):</span><br><span class="line">            flag = key(x, y) <span class="keyword">if</span> reverse <span class="keyword">else</span> key(y,x)</span><br><span class="line">            <span class="keyword">if</span> flag:</span><br><span class="line">                ret.insert(i,x)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret.append(x)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">lst = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">11</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">9</span>]</span><br><span class="line">print(sort(lst,reverse=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">11</span>]</span><br></pre></td></tr></table></figure>
<h2 id="内建函数-高阶函数"><a href="#内建函数-高阶函数" class="headerlink" title="内建函数-高阶函数"></a>内建函数-高阶函数</h2><ul>
<li><code>sorted(iterable[,key][,reverse])</code> 排序</li>
<li><code>filter(function, iterable) --&gt; filter objcet</code> 过滤数据</li>
<li><code>map(func, *iterables) --&gt; map object</code> 映射</li>
</ul>
<p><code>sorted(iterable[, key][, reverse]) 排序</code><br>返回一个新的列表，对一个可迭代对象的所有元素排序，排序规则为key定义的函数，reverse表是否排序翻转<br><code>sorted(lst,key=lambda x:6-x)</code> # 返回新列表<br><code>lst.sort(key=lambda x:6-x)</code> # 就地修改<br><code>filter(function, iterable)</code></p>
<ul>
<li>过滤可迭代对象的元素，返回一个迭代器;</li>
<li>function一个具有一个参数的函数，返回bool;</li>
<li>例如，过滤出数列中能被3整除的数字;</li>
</ul>
<p><code>list(filter(lambda x: x%3 == 0,[1,9,55,150,-3,78,28,123]))</code><br><code>map(function, *iterables) --&gt;  map object</code></p>
<ul>
<li>对多个可迭代对象的元素按照指定的函数进行映射，返回一个迭代器;</li>
<li><code>list(map(lambda x:2*x+1,range(5)))</code></li>
<li><code>dict(map(lambda x:(x%5,x), range(500)))</code></li>
</ul>
<h2 id="柯里化-Currying"><a href="#柯里化-Currying" class="headerlink" title="柯里化(Currying)"></a>柯里化(Currying)</h2><ul>
<li><p>柯里化<br>指的是将原来接受两个参数的函数变成新的一接受一个参数的过程。新的函数返回一个以原有第二个参数的函数;<br><code>z = f(x,y)</code> 转换成<code>z= f(x)(y)</code>的形式</p>
</li>
<li><p>举例<br>将加法函数柯里化</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x +y </span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x</span>):</span></span><br><span class="line">   ...:     <span class="function"><span class="keyword">def</span> <span class="title">_add</span>(<span class="params">y</span>):</span></span><br><span class="line">   ...:         <span class="keyword">return</span> x + y</span><br><span class="line">   ...:     <span class="keyword">return</span> _add</span><br><span class="line">In [<span class="number">2</span>]: foo = add(<span class="number">4</span>)</span><br><span class="line">In [<span class="number">3</span>]: print(foo(<span class="number">5</span>))</span><br><span class="line"><span class="number">9</span></span><br><span class="line">In [<span class="number">4</span>]: print(add(<span class="number">4</span>)(<span class="number">5</span>))</span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>通过嵌套函数就可以把函数转换成柯里化函数</p>
<h2 id="Python-装饰器"><a href="#Python-装饰器" class="headerlink" title="Python 装饰器"></a>Python 装饰器</h2><ul>
<li>需求</li>
</ul>
<p>一个加法函数，想增强它的功能，能够输出被调用过以及调用的参数信息;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">5</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">   ...:     <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<p>增加信息输出功能</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [6]: def add(x,y):</span><br><span class="line">   ...:     print(&quot;calladd, x+y&quot;) # 日志输出到控制台</span><br><span class="line">   ...:     return x+y</span><br></pre></td></tr></table></figure>
<p>上面的加法函数是完成了需求，但是有以下的缺点</p>
<ul>
<li>打印语句的耦合太高;</li>
<li>加法函数属于业务功能，而输出信息的功能，属于非业务功能代码，不该放在业务函数加法中;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    ...:         print(<span class="string">&quot;call &#123;&#125;,&#123;&#125;+&#123;&#125;&quot;</span>.<span class="built_in">format</span>(add.__name__,x,y))</span><br><span class="line">    ...:         <span class="keyword">return</span> x + y</span><br><span class="line">    ...: add(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">    ...:</span><br><span class="line">call add,<span class="number">4</span>+<span class="number">5</span></span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>做到了业务功能分离，但是fn函数调用传参是个问题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;begin&#x27;</span>)</span><br><span class="line">    x =fn(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">    print(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">print(logger(add))</span><br><span class="line">begin</span><br><span class="line">end</span><br><span class="line"><span class="number">9</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">x,y,z</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x+y+z</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn,*args,**kwargs</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">    ret = fn(*args,**kwargs)</span><br><span class="line">    print(<span class="string">&#x27;after&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">print(logger(add2,<span class="number">4</span>,z=<span class="number">5</span>,y=<span class="number">6</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add1</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span>(<span class="params">x,y,z</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x+y+z</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn,*args,**kwargs</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__logger</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        print(<span class="string">&#x27;after&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> __logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = logger(add1)</span><br><span class="line">print(foo(<span class="number">40</span>,<span class="number">10</span>))</span><br><span class="line">print(logger(add1)(<span class="number">100</span>,<span class="number">500</span>))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">before</span><br><span class="line">after</span><br><span class="line"><span class="number">50</span></span><br><span class="line">before</span><br><span class="line">after</span><br><span class="line"><span class="number">600</span></span><br></pre></td></tr></table></figure>
<p>改进: 引入装饰器</p>
<ul>
<li>装饰器语法糖</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__logger</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        print(<span class="string">&#x27;after&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> __logger</span><br><span class="line"><span class="meta">@logger  # 相当于 add1 = logger(add1)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add1</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">print(add1(<span class="number">100</span>,<span class="number">1000</span>))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">before</span><br><span class="line">after</span><br><span class="line"><span class="number">1100</span></span><br></pre></td></tr></table></figure>
<p>写个装饰器，它就会把下面的的函数名提取出来，传给这个名称;</p>
<ul>
<li>装饰器(无参)</li>
</ul>
<p>它是一个函数<br>函数作为它的形参<br>返回值也是一个函数@functionname方式，简化调用</p>
<ul>
<li>装饰器和高阶函数</li>
</ul>
<p>装饰器是高阶函数，但装饰器是对传函数的功能的装饰(功能增强)</p>
<p>例子:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrap</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        print(<span class="string">&quot;*args=&#123;&#125;,kwargs=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(args,kwargs))</span><br><span class="line">        start = datetime.datetime.now()</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        <span class="comment"># after 功能增强</span></span><br><span class="line">        duration = datetime.datetime.now() - start</span><br><span class="line">        print(<span class="string">&quot;function &#123;&#125; took &#123;&#125;s.&quot;</span>.<span class="built_in">format</span>(fn.__name__,duration.total_seconds()))</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrap</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger # 相当于 add = logger(add)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    print(<span class="string">&quot;====call add ========&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">print(add(<span class="number">4</span>,y=<span class="number">7</span>))</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">====call add ========</span><br><span class="line">function add took <span class="number">2.00511</span>s.</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<ul>
<li>装饰器函数</li>
<li>前置功能增强</li>
<li>被增强函数</li>
<li>后置功能增强</li>
</ul>
<h2 id="文档字符串"><a href="#文档字符串" class="headerlink" title="文档字符串"></a>文档字符串</h2><ul>
<li>Python 的文档</li>
</ul>
<ol>
<li>Python 是文档字符串的Documentation Strings;</li>
<li>在函数语句块的第一行，且习惯是多行的文本，所以多使用三引导;</li>
<li>惯例是首字母大写，第一行写概述，空一行，第三行写详细描述;</li>
<li>可以使用特殊属性<strong>doc</strong>访问这个文档;</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add1</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;This is a function</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return int</span></span><br><span class="line"><span class="string">    x int</span></span><br><span class="line"><span class="string">    y int</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ret = x + y</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">add1(<span class="number">4</span>,<span class="number">1000</span>)</span><br><span class="line">print(add1.__name__,add1.__doc__,sep=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment"># 输出 </span></span><br><span class="line">add1</span><br><span class="line">This <span class="keyword">is</span> a function</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span></span><br><span class="line">    x <span class="built_in">int</span></span><br><span class="line">    y <span class="built_in">int</span></span><br></pre></td></tr></table></figure>
<p>注: <code>print(help(add1))</code> 函数本身就是调的<code>__doc__</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Help on function add1 <span class="keyword">in</span> module __main__:</span><br><span class="line">add1(x, y)</span><br><span class="line">    This <span class="keyword">is</span> a function</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span></span><br><span class="line">    x <span class="built_in">int</span></span><br><span class="line">    y <span class="built_in">int</span></span><br><span class="line"><span class="literal">None</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_properties</span>(<span class="params">src,dst</span>):</span></span><br><span class="line">    dst.__name__ = src.__name__</span><br><span class="line">    dst.__doc__ = src.__doc__</span><br><span class="line">    dst.__qualname__ = src.__qualname__</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;This is a wrapper&#x27;&#x27;&#x27;</span></span><br><span class="line">        print(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        print(<span class="string">&#x27;after&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    copy_properties(fn,wrapper)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    This is a function</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    return int</span></span><br><span class="line"><span class="string">    x int</span></span><br><span class="line"><span class="string">    y int</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ret = x + y</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">print(add.__name__,add.__doc__,add.__qualname__,sep=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">add</span><br><span class="line"></span><br><span class="line">    This <span class="keyword">is</span> a function</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span></span><br><span class="line">    x <span class="built_in">int</span></span><br><span class="line">    y <span class="built_in">int</span></span><br><span class="line">    </span><br><span class="line">add</span><br></pre></td></tr></table></figure>
<ul>
<li>装饰器副作用</li>
</ul>
<p>原函数对象的属性都被替换了，而使用装饰器，我们的需求是查看被封装函数的属性;</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_properties</span>(<span class="params">src</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_copy</span>(<span class="params">dst</span>):</span></span><br><span class="line">        dst.__name__ = src.__name__</span><br><span class="line">        dst.__doc__ = src.__name__</span><br><span class="line">        dst.__qualname__ = src.__qualname__</span><br><span class="line">        <span class="keyword">return</span> dst</span><br><span class="line">    <span class="keyword">return</span> _copy</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">    @copy_properties(fn) # @ copy =&gt; wrapper = _copy(wrapper)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;This is a wrapper&#x27;&#x27;&#x27;</span></span><br><span class="line">        print(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        print(<span class="string">&#x27;after&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    This is a function</span></span><br><span class="line"><span class="string">    return int</span></span><br><span class="line"><span class="string">    x int</span></span><br><span class="line"><span class="string">    y int</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ret = x + y</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">print(add.__name__,add.__doc__,add.__qualname__,sep=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">add add add</span><br></pre></td></tr></table></figure>
<ul>
<li>python 提供一个函数，被封装函数属性 == copy ==&gt; 包装函数属性;</li>
<li>能过<strong>copy_properties</strong>函数将被包装函数的属性覆盖掉包装函数;</li>
<li>凡是被装饰的函数都城要复制这些属性，这个函数很通用;</li>
<li>可以将复制属性的函数构建成装饰器函数，带参装饰器;</li>
</ul>
<h2 id="带参装饰器"><a href="#带参装饰器" class="headerlink" title="带参装饰器"></a>带参装饰器</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">t</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__logger</span>(<span class="params">fn</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrap</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">            start = datetime.datetime.now()</span><br><span class="line">            ret = fn(*args,**kwargs)</span><br><span class="line">            duration = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">            <span class="keyword">if</span> duration &gt; t:</span><br><span class="line">                print(<span class="string">&quot;function &#123;&#125; took &#123;&#125; s.&quot;</span>.<span class="built_in">format</span>(fn.__name__,duration))</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">return</span> wrap</span><br><span class="line">    <span class="keyword">return</span> __logger</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger(3)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    print(<span class="string">&quot;===call add===&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">print(add(<span class="number">4</span>, y=<span class="number">7</span>))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">===call add===</span><br><span class="line">function add took <span class="number">5.001952</span> s.</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<ul>
<li>带参装饰器</li>
</ul>
<ol>
<li>它是一个函数;</li>
<li>函数作为它的的形参;</li>
<li>返回值是一个不带参的装饰器函数;</li>
<li>使用@functionname(参数列表)方式调用;</li>
<li>可以看做在装饰器外层又加了一层函数;</li>
</ol>
<ul>
<li>将记录的功能提取出来，这样就可以能过外部提供的函数来灵我没有的控制输出</li>
<li>再次改造</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_properties</span>(<span class="params">src</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_copy</span>(<span class="params">dst</span>):</span></span><br><span class="line">        dst.__name__ = src.__name__</span><br><span class="line">        dst.__doc__ = src.__name__</span><br><span class="line">        dst.__qualname__ = src.__qualname__</span><br><span class="line">        <span class="keyword">return</span> dst</span><br><span class="line">    <span class="keyword">return</span> _copy</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">duration,func=<span class="keyword">lambda</span> name,duration: <span class="built_in">print</span>(<span class="params"><span class="string">&quot;&#123;&#125; took &#123;&#125;s&quot;</span>.<span class="built_in">format</span>(<span class="params">name,duration</span>)</span>)</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_logger</span>(<span class="params">fn</span>):</span></span><br><span class="line"><span class="meta">        @copy_properties(fn)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">            start = datetime.datetime.now()</span><br><span class="line">            ret = fn(*args,**kwargs)</span><br><span class="line">            delta = (datetime.datetime.now() - start).total_seconds()</span><br><span class="line">            <span class="keyword">if</span> delta &gt; duration:</span><br><span class="line">                func(fn.__name__,duration)</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> _logger</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger(3)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    print(<span class="string">&quot;===call add===&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">print(add(<span class="number">4</span>, y=<span class="number">7</span>))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">===call add===</span><br><span class="line">add took <span class="number">3</span>s</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<h2 id="functools-模块"><a href="#functools-模块" class="headerlink" title="functools 模块"></a>functools 模块</h2><ul>
<li><code>functools.update_wrapper(wrapper,wrapped, assigned=WRAPPER_ASSGNMENTS, update=WRAPPER_UPDATES)</code></li>
</ul>
<ol>
<li>类似<code>copy_properties</code> 功能;</li>
<li>wrapper 包装函数，wrapped被包装函数;</li>
<li>元组<code>WRAPPER_ASSIGNMENTS</code>中是要被覆盖的属性;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;__module__&#39;,&#39;__name__&#39;,&#39;__qualname__&#39;,&#39;__doc__&#39;,&#39;__annotations__&#39;</span><br><span class="line">模块名、名称、限定名、文档、参数注解</span><br></pre></td></tr></table></figure>
<ul>
<li>元组WRAPPER_UDPATES中是要被更新的属性, <code>__dict__</code>属性字典</li>
<li>增加一个<code>__wapped__</code>属性，保留着wrapped函数;</li>
</ul>
<p><code>funtools.update_wrapper</code> 实例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy_properties</span>(<span class="params">src</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_copy</span>(<span class="params">dst</span>):</span></span><br><span class="line">        dst.__name__ = src.__name__</span><br><span class="line">        dst.__doc__ = src.__name__</span><br><span class="line">        dst.__qualname__ = src.__qualname__</span><br><span class="line">        <span class="keyword">return</span> dst</span><br><span class="line">    <span class="keyword">return</span> _copy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span>(<span class="params">fn</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;This is a wrapper&#x27;&#x27;&#x27;</span></span><br><span class="line">        print(<span class="string">&#x27;before&#x27;</span>)</span><br><span class="line">        ret = fn(*args,**kwargs)</span><br><span class="line">        print(<span class="string">&#x27;after&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    functools.update_wrapper(wrapper,fn)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    This is a function</span></span><br><span class="line"><span class="string">    return int</span></span><br><span class="line"><span class="string">    x int</span></span><br><span class="line"><span class="string">    y int</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    ret = x + y</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">print(add.__name__,add.__doc__,add.__qualname__,sep=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">print(<span class="string">&#x27;#&#x27;</span>*<span class="number">50</span>)</span><br><span class="line">print(add.__wrapped__)</span><br><span class="line"><span class="comment">## 输出 </span></span><br><span class="line">add</span><br><span class="line"></span><br><span class="line">    This <span class="keyword">is</span> a function</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span></span><br><span class="line">    x <span class="built_in">int</span></span><br><span class="line">    y <span class="built_in">int</span></span><br><span class="line">    </span><br><span class="line">add</span><br><span class="line"><span class="comment">##################################################</span></span><br><span class="line">&lt;function add at <span class="number">0x11539e488</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p><strong>凡人做一事，便须全副精神注在些一事，首尾不懈，不可见异思迁，做这样想那样，坐之山望 那山，人而无恒，终身一事无成</strong></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python函数(三)</title>
    <url>/2020/08/19/python%E5%87%BD%E6%95%B0%E4%B8%89/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-函数-三"><a href="#python-函数-三" class="headerlink" title="python 函数(三)"></a>python 函数(三)</h1><p><img src="/images/python_function.png" class="lazyload" data-srcset="/images/python_function.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="变量名解析原则LEGB"><a href="#变量名解析原则LEGB" class="headerlink" title="变量名解析原则LEGB"></a>变量名解析原则LEGB</h3><ul>
<li>Local本地作用域、局部作用域的local命名空间,函数调时创建,调用结束消亡;</li>
<li>Enclosing, Python2.2时引入了嵌套函数,实现了闭包,这个就是嵌套函数的外部函数的全名空间;</li>
<li>Global,全局作用域,即一个模块的命名空间。模块被import 时创建，解释器退出时消亡;</li>
<li>Build-in,内置模块的命名空间,生命周期从python解释器启动时创建 到解释器退出时消亡。例如 <code>print(open)</code>，<code>print</code> 和<code>open</code>都是内置的变量;</li>
<li>所以一个名词的查找顺序就是<code>LEGB</code>;</li>
</ul>
<h2 id="函数执行流程"><a href="#函数执行流程" class="headerlink" title="函数执行流程"></a>函数执行流程</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span>(<span class="params">b,b1=<span class="number">3</span></span>):</span></span><br><span class="line">    print(<span class="string">&quot;foo1 called&quot;</span>,b,b1)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span>(<span class="params">c</span>):</span></span><br><span class="line">    foo3(c)</span><br><span class="line">    print(<span class="string">&quot;foo2 called&quot;</span>,c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo3</span>(<span class="params">d</span>):</span></span><br><span class="line">    print(<span class="string">&quot;foo3 called&quot;</span>, d)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    print(<span class="string">&quot;main called&quot;</span>)</span><br><span class="line">    foo1(<span class="number">100</span>,<span class="number">101</span>)</span><br><span class="line">    foo2(<span class="number">200</span>)</span><br><span class="line">    print(<span class="string">&quot;main ending&quot;</span>)</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">main called</span><br><span class="line">foo1 called <span class="number">100</span> <span class="number">101</span></span><br><span class="line">foo3 called <span class="number">200</span></span><br><span class="line">foo2 called <span class="number">200</span></span><br><span class="line">main ending</span><br></pre></td></tr></table></figure>
<ul>
<li>全局帧中生成foo1、foo2、foo3、main函数对象;</li>
<li>main函数调用;</li>
<li>main中查找内建函数print压栈，将常量字符串压栈，调用函数，弹出栈顶;</li>
<li>main中全局查找函数foo1压栈，将常量100、101压栈，调用函数foo1，创建栈帧。print函数压栈，字符串和亦是b、b1压栈、调用函数，弹出栈顶，返回值。</li>
<li>main中全局查找foo2函数压栈，将常量200压栈，调用foo2，创建栈帧。foo3函数压栈，变量c引用压栈，调用foo3，创建栈帧。foo3完成print函数调用后返回。foo2恢复调用。执行print后，返回值。main中foo2调用结束弹出栈顶，继续执行print函数调用，弹出栈顶。main函数返回。</li>
</ul>
<h2 id="递归Recursion"><a href="#递归Recursion" class="headerlink" title="递归Recursion"></a>递归Recursion</h2><ul>
<li>函数直接或者间接调用自身就是 递归;</li>
<li>递归需要有边界条件、递归前进段、递归返回段;</li>
<li>递归一定要有<strong>边界操作</strong>;</li>
<li>当办界条件不满足的时候，递归前进;</li>
<li><p>当边界条件满足的时候，递归返回;</p>
</li>
<li><p>斐波那契数列<code>Fibonacci number: 1,1,2,3,5,8,13,21,34,55,89,144,...</code></p>
</li>
<li>如果设F(n)为该数列的第n项(n∈N* )，那么这句话可以写成如下形式:<code>F(n)=F(n-1)+F(n-2)</code></li>
<li><code>F(0)=0, F(1)=1,F(n)=F(n-1)+F(n-2)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pre = <span class="number">0</span></span><br><span class="line">cur = <span class="number">1</span></span><br><span class="line">print(pre,cur,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">n = <span class="number">10</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n<span class="number">-1</span>):</span><br><span class="line">    pre, cur = cur,pre+cur</span><br><span class="line">    print(cur,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#结果: 0 1 1 2 3 5 8 13 21 34 55 </span></span><br></pre></td></tr></table></figure>
<p>递归实现</p>
<p><code>F(0)=0,F(1)=1,F(n)=F(n-1)+F(n-2)</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> n &lt; <span class="number">2</span> <span class="keyword">else</span> fib(n<span class="number">-1</span>) + fib(n<span class="number">-2</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    print(fib(i), end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="comment"># 1 1 2 3 5 8 13 21 34 55         </span></span><br></pre></td></tr></table></figure>
<p>解析:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fib(<span class="number">3</span>) + fib(<span class="number">2</span>)</span><br><span class="line">fib(<span class="number">3</span>) 调用fib(<span class="number">3</span>)、fib(<span class="number">2</span>)、fib(<span class="number">1</span>)</span><br><span class="line">fib(<span class="number">2</span>) 调用fib2(<span class="number">2</span>)、fib(<span class="number">1</span>)</span><br><span class="line">fib(<span class="number">1</span>) 是边界</span><br></pre></td></tr></table></figure>
<h3 id="递归要求"><a href="#递归要求" class="headerlink" title="递归要求"></a>递归要求</h3><ul>
<li>递归一定要有退出条件，递归调用一定要执行到这个退出条件。没有退出条件的递归调用，就是无限调用;</li>
<li>递归调用的深度不宜过深;</li>
</ul>
<ol>
<li>Python 对递归调用的深度做了限制，以保护解释器;</li>
<li>超过递归深度限制，抛出<code>RecurisonError: maxinum recursion depth exceeded</code>超出最大深度;</li>
<li><code>sys.getrecursionlimit()</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> sys</span><br><span class="line">In [<span class="number">2</span>]: print(sys.getrecursionlimit())</span><br><span class="line"><span class="number">3000</span></span><br><span class="line">In [<span class="number">4</span>]: sys.setrecursionlimit(<span class="number">1000</span>)</span><br><span class="line">In [<span class="number">5</span>]: print(sys.getrecursionlimit())</span><br><span class="line"><span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>优化改进</p>
<p>fib函数和循环的思想类似;<br>参数n是边界条件，用n来计数;<br>上一次的计算结果直接作为函数的实参;<br>效率很高;<br>和循环比较，性能相近。所以并不是递归一定是效率底下，但是递归有深度的限制;<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pre = <span class="number">0</span></span><br><span class="line">cur = <span class="number">1</span></span><br><span class="line">print(pre, cur)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">n, pre=<span class="number">0</span>,cur=<span class="number">1</span></span>):</span></span><br><span class="line">    pre, cur = cur, pre + cur</span><br><span class="line">    print(cur, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">2</span> :</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    fib(n<span class="number">-1</span>, pre, cur)</span><br><span class="line"></span><br><span class="line">fib(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># 输出 1 2 3 5 8 13 21 34 55 </span></span><br></pre></td></tr></table></figure></p>
<h3 id="间接递归"><a href="#间接递归" class="headerlink" title="间接递归"></a>间接递归</h3><p>如<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo1</span>():</span></span><br><span class="line">    foo2()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo2</span>():</span></span><br><span class="line">    foo1()</span><br><span class="line"></span><br><span class="line">foo1()</span><br></pre></td></tr></table></figure></p>
<p>间接递归，是通过别的函数调用了函数自身;<br>但是，如果构成了循环递归调用是非常危险的，但是往往这种情况下代码复杂的情况下，还是可能发生这种调用。要用代码的规范来避免这种递归调用的发生。</p>
<h3 id="递归总结"><a href="#递归总结" class="headerlink" title="递归总结"></a>递归总结</h3><ul>
<li>递归是一种很自然的表达，符合逻辑思维;</li>
<li>递归相对运行效率低，每一次调用函数都要开辟栈帧;</li>
<li>递归有深度限制，如果递归层次太深，函数反复压栈，栈内存很快就溢出了;</li>
<li>如果是有限次数的递归，可以使用递归调用，或者使用循环代替，循环代码稍微复杂一些，但是只要不是死trggsk以多次迭代直至算出结果；</li>
<li>绝大多数递归，都可以使用循环实现;</li>
<li>即使递归代码很简洁，但是能不用则不用递归。</li>
</ul>
<h3 id="递归练习"><a href="#递归练习" class="headerlink" title="递归练习"></a>递归练习</h3><ul>
<li>求n的阶乘</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fac</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span> :</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> n * fac(n<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fac1</span>(<span class="params">n, p =<span class="number">1</span> </span>):</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    p *= n</span><br><span class="line">    print(p)</span><br><span class="line">    fac1(n<span class="number">-1</span>,p)</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fac2</span>(<span class="params">n, p = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        p = [<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span> :</span><br><span class="line">        <span class="keyword">return</span> p[<span class="number">0</span>]</span><br><span class="line">    p[<span class="number">0</span>] *= n</span><br><span class="line">    print(p[<span class="number">0</span>])</span><br><span class="line">    fac2(n<span class="number">-1</span>, p)</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">n = <span class="number">10</span></span><br><span class="line">print(fac(n))</span><br><span class="line">print(fac1(n))</span><br><span class="line">print(fac2(n))</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="number">3628800</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">720</span></span><br><span class="line"><span class="number">5040</span></span><br><span class="line"><span class="number">30240</span></span><br><span class="line"><span class="number">151200</span></span><br><span class="line"><span class="number">604800</span></span><br><span class="line"><span class="number">1814400</span></span><br><span class="line"><span class="number">3628800</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">90</span></span><br><span class="line"><span class="number">720</span></span><br><span class="line"><span class="number">5040</span></span><br><span class="line"><span class="number">30240</span></span><br><span class="line"><span class="number">151200</span></span><br><span class="line"><span class="number">604800</span></span><br><span class="line"><span class="number">1814400</span></span><br><span class="line"><span class="number">3628800</span></span><br><span class="line">[<span class="number">3628800</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>将一个数逆序放入列表中，例如<code>1234 =&gt; [4,3,2,1]</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">num = <span class="number">1234</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">revert</span>(<span class="params">num, target=[]</span>):</span></span><br><span class="line">    <span class="keyword">if</span> num:</span><br><span class="line">        target.append(num[<span class="built_in">len</span>(num) <span class="number">-1</span>]) <span class="comment"># target.append(num[-1:])</span></span><br><span class="line">        revert(num[:<span class="built_in">len</span>(num) <span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">print(revert(<span class="built_in">str</span>(num)))</span><br></pre></td></tr></table></figure>
<ul>
<li>解决猴子吃桃问题</li>
</ul>
<p>猴子第一天摘下苦干个桃子，当即吃了一半，还不过瘾，又多吃了一个，第二天早上又剩下的桃子吃掉一半，又多吃了一个。以后每天早上都各吃了前一天剩下的一半零一个。到第10天早上想吃时，只剩下一个桃子了。求第一天共摘多少个桃子。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peach</span>(<span class="params">days=<span class="number">10</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> days == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span>(peach(days<span class="number">-1</span>)+<span class="number">1</span>)*<span class="number">2</span></span><br><span class="line">print(peach())</span><br></pre></td></tr></table></figure>
<p>注意这里必须是10， 因为return(peach(days-1)+1)*2 立即拿不到结果，必须通过再一次进入函数时判断是不是到了最后一天。<br>也就是当前使用的值是由下一次函数调用得到，所以要执行10次函数调用。</p>
<p>换种方式表达</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peatch</span>(<span class="params">days=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> days == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span>(peatch(days+<span class="number">1</span>)+<span class="number">1</span>)*<span class="number">2</span></span><br><span class="line">print(peatch())</span><br></pre></td></tr></table></figure>
<h2 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h2><p>Python 借助Lambda表达式构建匿名函数</p>
<p>例<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: (<span class="keyword">lambda</span> x:x*<span class="number">2</span>)((<span class="number">4</span>,<span class="number">2</span>))</span><br><span class="line">Out[<span class="number">1</span>]: (<span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>使用lambda 关键字来定义匿名函数;</li>
<li>参数列表不需要小括号;</li>
<li>冒号是用来分割参数列表和表达式的;</li>
<li>不需要使用return，表达式的值，就是匿名函数返回值;</li>
<li>lambda表达式(匿名函数)<strong>只能写在一行上</strong>，被称为单行函数</li>
<li>用途<br>在高阶函数传参时，使用lambda表达式，往往能简化代码;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print((<span class="keyword">lambda</span> :<span class="number">0</span>)())</span><br><span class="line">print((<span class="keyword">lambda</span> x,y=<span class="number">3</span>: x + y )(<span class="number">5</span>))</span><br><span class="line">print((<span class="keyword">lambda</span> x,y=<span class="number">3</span>: x + y)(<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line">print((<span class="keyword">lambda</span> x, *, y=<span class="number">30</span>: x + y)(<span class="number">5</span>))</span><br><span class="line">print((<span class="keyword">lambda</span> x, *, y=<span class="number">30</span>: x + y)(<span class="number">5</span>, y=<span class="number">10</span>))</span><br><span class="line">print((<span class="keyword">lambda</span> *args: (x <span class="keyword">for</span> x <span class="keyword">in</span> args))(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line">print((<span class="keyword">lambda</span> *args:[x+<span class="number">1</span> <span class="keyword">for</span> x <span class="keyword">in</span> args])(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line">print((<span class="keyword">lambda</span> *args: [x + <span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> args])(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line">print((<span class="keyword">lambda</span> *args: &#123; x + <span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> args &#125;)(*<span class="built_in">range</span>(<span class="number">5</span>)))</span><br><span class="line"><span class="comment">###高阶函数</span></span><br><span class="line">lst = [x <span class="keyword">for</span> x <span class="keyword">in</span> (<span class="keyword">lambda</span> *args: <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x+<span class="number">1</span>,args))(*<span class="built_in">range</span>(<span class="number">5</span>))]</span><br><span class="line">print(lst)</span><br><span class="line">lst2 = [x <span class="keyword">for</span> x <span class="keyword">in</span> (<span class="keyword">lambda</span> *args: <span class="built_in">map</span>(<span class="keyword">lambda</span> x:(x+<span class="number">1</span>,args),args))(*<span class="built_in">range</span>(<span class="number">5</span>))]</span><br><span class="line">print(lst2)</span><br><span class="line"></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">35</span></span><br><span class="line"><span class="number">15</span></span><br><span class="line">&lt;generator <span class="built_in">object</span> &lt;<span class="keyword">lambda</span>&gt;.&lt;<span class="built_in">locals</span>&gt;.&lt;genexpr&gt; at <span class="number">0x10742dcf0</span>&gt;</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">[(<span class="number">1</span>, (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)), (<span class="number">2</span>, (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)), (<span class="number">3</span>, (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)), (<span class="number">4</span>, (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)), (<span class="number">5</span>, (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>))]</span><br></pre></td></tr></table></figure>
<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><ul>
<li><p>生成器generator<br>生成器指的是生成器对象，可以由生成器表达式得到，也可以使用yeild关键字得到一个生成器函数，调用这个函数得到一个生成器对象</p>
</li>
<li><p>生成器函数<br>函数体中包含yield语句的函数，返回生成器对象;<br>生成器对象，是一个可迭代对象，是一个迭代对象;<br>生成器对象，是延迟计算、惰性求值的。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">print(<span class="built_in">type</span>(inc))</span><br><span class="line">print(<span class="built_in">type</span>(inc()))</span><br><span class="line">x = inc()</span><br><span class="line">print(<span class="built_in">type</span>(x))</span><br><span class="line">print(<span class="built_in">next</span>(x))</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> x:</span><br><span class="line">    print(m, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> x:</span><br><span class="line">    print(m, <span class="string">&#x27;**&#x27;</span>)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">function</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">generator</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">generator</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">0</span></span><br><span class="line"><span class="class">1 *</span></span><br><span class="line"><span class="class">2 *</span></span><br><span class="line"><span class="class">3 *</span></span><br><span class="line"><span class="class">4 *</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: y = (i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">In [<span class="number">2</span>]: print(<span class="built_in">type</span>(y))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">generator</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">In</span> [3]:</span> print(<span class="built_in">next</span>(y))</span><br><span class="line"><span class="number">0</span></span><br><span class="line">In [<span class="number">4</span>]: print(<span class="built_in">next</span>(y))</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>普通的函数调用fn()， 函数会立即执行完毕，但是生成器函数可以使用next函数多次执行;</li>
<li>生成器函数等价于生成器表达式，只不过生成器函数可以更加的复杂;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">5</span>]: <span class="function"><span class="keyword">def</span> <span class="title">gen</span>():</span></span><br><span class="line">   ...:     print(<span class="string">&#x27;line 1&#x27;</span>)</span><br><span class="line">   ...:     <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">   ...:     print(<span class="string">&#x27;line 2&#x27;</span>)</span><br><span class="line">   ...:     <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">   ...:     print(<span class="string">&#x27;line 3&#x27;</span>)</span><br><span class="line">   ...:     <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">In [<span class="number">6</span>]: <span class="built_in">next</span>(gen())</span><br><span class="line">line <span class="number">1</span></span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: <span class="built_in">next</span>(gen())</span><br><span class="line">line <span class="number">1</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">1</span></span><br><span class="line">In [<span class="number">8</span>]: g = gen()</span><br><span class="line">In [<span class="number">9</span>]: print(<span class="built_in">next</span>(g))</span><br><span class="line">line <span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">10</span>]: print(<span class="built_in">next</span>(g))</span><br><span class="line">line <span class="number">2</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">In [<span class="number">11</span>]: print(<span class="built_in">next</span>(g))</span><br><span class="line">line <span class="number">3</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">StopIteration                             Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span><span class="number">-11</span><span class="number">-1</span>dfb29d6357e&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 print(next(g))</span><br><span class="line">StopIteration: <span class="number">3</span></span><br><span class="line">In [<span class="number">12</span>]: print(<span class="built_in">next</span>(g, <span class="string">&#x27;End&#x27;</span>))</span><br><span class="line">End</span><br></pre></td></tr></table></figure>
<ul>
<li>在生成器函数中，使用多个yield语句，执行一次后会暂停执行，把yeild表达式的值返回;</li>
<li>再次执行会执行到下一个yield语句;</li>
<li>return语句依然可以终止函数运行,但是return语句的返回值不能被获取到;</li>
<li>return会导致无法继续获取一下个值，抛出StopIteration异常;</li>
<li>如果函数没有显示的return语句，如果生成器函数执行到结尾，一样会抛出StopIteration异常;</li>
</ul>
<h3 id="生成器函数"><a href="#生成器函数" class="headerlink" title="生成器函数"></a>生成器函数</h3><ul>
<li>包含yield语句的生成器函数生成生成器对象，<strong>生成器函数的函数体不会立即执行</strong></li>
<li>next(generator)会从函数的当前位置向后执行到之后踫到的第一个yeild语句，会弹出值，并暂停函数执行;</li>
<li>再次调用next函数，和上一条一样的处理过程;</li>
<li>没有多余的yield语句的能被执行，继续调用next函数，会抛出StopIteration异常;</li>
</ul>
<h3 id="生成器应用"><a href="#生成器应用" class="headerlink" title="生成器应用"></a>生成器应用</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">13</span>]: <span class="function"><span class="keyword">def</span> <span class="title">counter</span>():</span></span><br><span class="line">    ...:     i = <span class="number">0</span></span><br><span class="line">    ...:     <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    ...:         i +=<span class="number">1</span></span><br><span class="line">    ...:         <span class="keyword">yield</span> i</span><br><span class="line">In [<span class="number">14</span>]: <span class="function"><span class="keyword">def</span> <span class="title">inc</span>(<span class="params">c</span>):</span></span><br><span class="line">    ...:     <span class="keyword">return</span> <span class="built_in">next</span>(c)</span><br><span class="line">In [<span class="number">15</span>]: c = counter()</span><br><span class="line">In [<span class="number">16</span>]: print(inc(c))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">17</span>]: print(inc(c))</span><br><span class="line"><span class="number">2</span></span><br><span class="line">In [<span class="number">18</span>]: print(inc(c))</span><br><span class="line"><span class="number">3</span></span><br><span class="line">In [<span class="number">19</span>]: print(inc(c))</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">In [<span class="number">21</span>]: <span class="function"><span class="keyword">def</span> <span class="title">counter</span>():</span></span><br><span class="line">    ...:     i = <span class="number">0</span></span><br><span class="line">    ...:     <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    ...:         i += <span class="number">1</span></span><br><span class="line">    ...:         <span class="keyword">yield</span> i</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">22</span>]: <span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">    ...:     c = counter()</span><br><span class="line">    ...:     <span class="keyword">return</span> <span class="built_in">next</span>(c)</span><br><span class="line">In [<span class="number">23</span>]: print(inc())</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">24</span>]: print(inc())</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">25</span>]: print(inc())</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>计数器 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">counter</span>():</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            i +=<span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">    c = counter()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">lambda</span> : <span class="built_in">next</span>(c)</span><br><span class="line">foo = inc()</span><br><span class="line">print(foo())</span><br><span class="line">print(foo())</span><br><span class="line">print(foo())</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>lambda 表达式是匿名函数<br>return 返回的是一个匿名函数<br>等价于下面的代码 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">counter</span>():</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            i +=<span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">    c = counter()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_inc</span>():</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">next</span>(c)</span><br><span class="line">    <span class="keyword">return</span> _inc</span><br><span class="line">foo = inc()</span><br><span class="line">print(foo())</span><br><span class="line">print(foo())</span><br><span class="line">print(foo())</span><br></pre></td></tr></table></figure>
<p>处理递归问题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>():</span></span><br><span class="line">    x = <span class="number">0</span></span><br><span class="line">    y = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> y</span><br><span class="line">        x,y = x, x+y</span><br><span class="line">foo = fib()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    <span class="built_in">next</span>(foo)</span><br><span class="line">print(<span class="built_in">next</span>(foo))</span><br></pre></td></tr></table></figure>
<p>等价于下面的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pre = <span class="number">0</span></span><br><span class="line">cur = <span class="number">1</span></span><br><span class="line">print(pre, cur, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib1</span>(<span class="params">n, pre=<span class="number">0</span>, cur=<span class="number">1</span></span>):</span></span><br><span class="line">    pre, cur = cur, pre + cur</span><br><span class="line">    print(cur, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> n ==<span class="number">2</span> :</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    fib1(n<span class="number">-1</span>,pre,cur)</span><br></pre></td></tr></table></figure>
<ul>
<li>协程coroutine </li>
</ul>
<ol>
<li>生成器的高级用法 ;</li>
<li>比进程、线程轻量级;</li>
<li>是在用户空间调度函数的一种实现;</li>
<li>Python3 asyncio就是协程实现，已经加入到标准库;</li>
<li>Python3.5使用async、await关键字直接原生支持协程;</li>
</ol>
<ul>
<li>协程高度器实现思路;</li>
</ul>
<ol>
<li>有2个生成器A、B</li>
<li>next(A)后，A执行到了yeild语句暂停，然后去执行next(B)，B执行到yield语句也暂停，然后再次调用next(A)，再调用next(B)在，周而复始，就实现了调度的效果;</li>
<li>可以引入调度的策略来实现切换的方式;</li>
</ol>
<ul>
<li>协程是一种非抢占调度</li>
</ul>
<h3 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h3><ul>
<li>举例</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">26</span>]: <span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">    ...:     <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    ...:         <span class="keyword">yield</span> x</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">27</span>]: foo = inc()</span><br><span class="line"></span><br><span class="line">In [<span class="number">28</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">0</span></span><br><span class="line">In [<span class="number">29</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">30</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>等价于下面的代码 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">31</span>]: <span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">    ...:     <span class="keyword">yield</span> <span class="keyword">from</span> <span class="built_in">range</span>(<span class="number">1000</span>)</span><br><span class="line">In [<span class="number">32</span>]: foo = inc()</span><br><span class="line">In [<span class="number">33</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">0</span></span><br><span class="line">In [<span class="number">34</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">35</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>yield from 是Python 3.3 出现的新的语法</li>
<li><p>yield from iterable 是 for item in iterable: yield item 形式的语法粮</p>
</li>
<li><p>可迭代对象中一个个拿元素</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">36</span>]: <span class="function"><span class="keyword">def</span> <span class="title">counter</span>(<span class="params">n</span>):</span></span><br><span class="line">    ...:     <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    ...:         <span class="keyword">yield</span> x</span><br><span class="line">In [<span class="number">37</span>]: <span class="function"><span class="keyword">def</span> <span class="title">inc</span>(<span class="params">n</span>):</span></span><br><span class="line">    ...:     <span class="keyword">yield</span> <span class="keyword">from</span> counter(n)</span><br><span class="line">In [<span class="number">38</span>]: foo = inc(<span class="number">10</span>)</span><br><span class="line">In [<span class="number">39</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">0</span></span><br><span class="line">In [<span class="number">40</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">41</span>]: print(<span class="built_in">next</span>(foo))</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p><strong>知止而后有定，定而后能静，静而后能安，安而后能虑，虑而后能得</strong> 数语，尽矣;</p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 函数(二)</title>
    <url>/2020/08/11/python%E5%87%BD%E6%95%B0%E4%BA%8C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-函数-二"><a href="#python-函数-二" class="headerlink" title="python 函数(二)"></a>python 函数(二)</h1><p><img src="/images/python_function.png" class="lazyload" data-srcset="/images/python_function.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="nolocal-关键字"><a href="#nolocal-关键字" class="headerlink" title="nolocal 关键字"></a>nolocal 关键字</h2><ul>
<li>使用了nolocal关键字，将变量标记为在上级的局部作用域中的定义，但<strong>不能是全局作用域中</strong>定义</li>
<li>count 是外层函数的局部变量，被内部函数引用</li>
<li>内部函数使用nonlocal 关键字声明count 变量是在上一级作用域中</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="function"><span class="keyword">def</span> <span class="title">counter</span>():</span></span><br><span class="line">   ...:     count =<span class="number">0</span></span><br><span class="line">   ...:     <span class="function"><span class="keyword">def</span> <span class="title">inc</span>():</span></span><br><span class="line">   ...:         <span class="keyword">nonlocal</span> count</span><br><span class="line">   ...:         count +=<span class="number">1</span></span><br><span class="line">   ...:         <span class="keyword">return</span> count</span><br><span class="line">   ...:     <span class="keyword">return</span> inc</span><br><span class="line">In [<span class="number">3</span>]: foo = counter()</span><br><span class="line">In [<span class="number">4</span>]: print(foo())</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">5</span>]: print(foo())</span><br><span class="line"><span class="number">2</span></span><br><span class="line">In [<span class="number">6</span>]: print(foo())</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<h2 id="默认值的作用域"><a href="#默认值的作用域" class="headerlink" title="默认值的作用域"></a>默认值的作用域</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">7</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">xyz=[]</span>):</span></span><br><span class="line">   ...:     xyz.append(<span class="string">&#x27;100&#x27;</span>)</span><br><span class="line">   ...:     print(xyz)</span><br><span class="line">   ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: foo()</span><br><span class="line">[<span class="string">&#x27;100&#x27;</span>]</span><br><span class="line">In [<span class="number">9</span>]: foo()</span><br><span class="line">[<span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;100&#x27;</span>]</span><br><span class="line">In [<span class="number">10</span>]: foo()</span><br><span class="line">[<span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;100&#x27;</span>, <span class="string">&#x27;100&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>例子</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">xyz=[],u=<span class="string">&#x27;abc&#x27;</span>,z=<span class="number">123</span></span>):</span></span><br><span class="line">   ...:     xyz.append(<span class="number">1</span>)</span><br><span class="line">   ...:     <span class="keyword">return</span> xyz</span><br><span class="line">In [<span class="number">2</span>]: print(foo(),<span class="built_in">id</span>(foo))</span><br><span class="line">[<span class="number">1</span>] <span class="number">4569788064</span></span><br><span class="line">In [<span class="number">3</span>]: print(foo.__defaults__)</span><br><span class="line">([<span class="number">1</span>], <span class="string">&#x27;abc&#x27;</span>, <span class="number">123</span>)</span><br><span class="line">In [<span class="number">4</span>]: print(foo(),<span class="built_in">id</span>(foo))</span><br><span class="line">[<span class="number">1</span>, <span class="number">1</span>] <span class="number">4569788064</span></span><br></pre></td></tr></table></figure>
<ul>
<li>函数地址并没有变，就是说函数这个对象的没有变，调用它，它的属性<strong>defaults</strong>中使用元组保存所有默认值;</li>
<li>xyz 默认值是引用类型，引用类型的元素变动，并不是元组的变动;</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">w,u=<span class="string">&#x27;abc&#x27;</span>,z=<span class="number">123</span></span>):</span></span><br><span class="line">   ...:     u = <span class="string">&#x27;xyz&#x27;</span></span><br><span class="line">   ...:     z = <span class="number">789</span></span><br><span class="line">   ...:     print(w,u,z)</span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: print(foo.__defaults__)</span><br><span class="line">(<span class="string">&#x27;abc&#x27;</span>, <span class="number">123</span>)</span><br><span class="line">In [<span class="number">10</span>]: foo(<span class="string">&#x27;asjin&#x27;</span>)</span><br><span class="line">asjin xyz <span class="number">789</span></span><br><span class="line">In [<span class="number">11</span>]: print(foo.__defaults__)</span><br><span class="line">(<span class="string">&#x27;abc&#x27;</span>, <span class="number">123</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>属性<strong>defaults</strong>  中使用元组保存所有默认值，它不会因为在函数体内使用了它而发生改变;</li>
<li>可变类型默认值，如果使用默认值，就可能修改这个默认值;</li>
<li><p>有时候这个特性是好的，有的时候这种我是不是好的，有副作用;</p>
</li>
<li><p>第一种方法<br>  使用影子拷贝创建一个新的对象，永远不能改变传入的参数;</p>
</li>
<li><p>第二种方法<br>  通过值的判断就可以灵活的选择创建或者修改传入对象;<br>  这种方式灵活，应用广泛 ;<br>  很多函数的定义，都可以看到使用None这个不可变的值作为默认参数，可以说是这一种惯用法。</p>
</li>
</ul>
<h2 id="函数的销毁"><a href="#函数的销毁" class="headerlink" title="函数的销毁"></a>函数的销毁</h2><pre><code>* 全局函数销毁
重新定义同名函数
del 语句删除函数对象
程序结束时
</code></pre><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">    In [<span class="number">5</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">xyz=[], u=<span class="string">&#x27;abc&#x27;</span>, z=<span class="number">123</span></span>):</span></span><br><span class="line">   ...:     xyz.append(<span class="number">1</span>)</span><br><span class="line">   ...:     <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">a=<span class="number">10</span></span>):</span></span><br><span class="line">   ...:         <span class="keyword">pass</span></span><br><span class="line">   ...:     print(inner)</span><br><span class="line">   ...:     <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">a=<span class="number">100</span></span>):</span></span><br><span class="line">   ...:         print(xyz)</span><br><span class="line">   ...:     print(inner)</span><br><span class="line">   ...:     <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: bar =foo()</span><br><span class="line">&lt;function foo.&lt;<span class="built_in">locals</span>&gt;.inner at <span class="number">0x10529dbf8</span>&gt;</span><br><span class="line">&lt;function foo.&lt;<span class="built_in">locals</span>&gt;.inner at <span class="number">0x1053c8f28</span>&gt;</span><br><span class="line">In [<span class="number">7</span>]: print(<span class="built_in">id</span>(foo),<span class="built_in">id</span>(bar), foo.__defaults__, bar.__defaults__)</span><br><span class="line"><span class="number">4382889232</span> <span class="number">4382822184</span> ([<span class="number">1</span>], <span class="string">&#x27;abc&#x27;</span>, <span class="number">123</span>) (<span class="number">100</span>,)</span><br><span class="line">In [<span class="number">8</span>]: <span class="keyword">del</span> bar</span><br><span class="line">In [<span class="number">9</span>]: print(<span class="built_in">id</span>(foo),<span class="built_in">id</span>(bar), foo.__defaults__, bar.__defaults__)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">NameError                                 Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span><span class="number">-9</span><span class="number">-7</span>b5c35b2c85a&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 print(id(foo),id(bar), foo.__defaults__, bar.__defaults__)</span><br><span class="line">NameError: name <span class="string">&#x27;bar&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>
<h2 id="树"><a href="#树" class="headerlink" title="树"></a>树</h2><ul>
<li>非线性结构，每个元素可以有多个前驱和后继</li>
<li><p>树是n(n&gt;=0)个元素的集合<br>  n = 0 时， 称为空树;<br>  树只有一个特殊的没有前驱的元素，称为树的根Root;<br>  树中除了根结点外，其余元素只能有一个前驱，可以有零个或多个后继;</p>
</li>
<li><p>递归定义<br>  树T是n(n&gt;=0)个元素的集合。n=0时，称为空树;<br>  有且只有一个特殊元素根，剩余元素都可以被划分为m个互不相交的集合T1、T2、T3、… Tm，而每一个集合都有树，称为T的子树Subtree<br>  子树也有自己的根</p>
</li>
</ul>
<h2 id="树的概念"><a href="#树的概念" class="headerlink" title="树的概念"></a>树的概念</h2><ul>
<li>结点: 树中的数据元素;</li>
<li>结点的度degree:结点拥有的子树的数目称为度，记作d(v);</li>
<li>叶子结点: 结点的度0， 称为叶子结点leaf、终端结点、末端结点;</li>
<li>分支结点: 结点的度不为0， 称为非终端结点或分结点;</li>
<li>分支: 结点之间的关系;</li>
<li>内部结点: 除根结点外的分支结点，当然也不包括叶子结点;</li>
<li>树的度是树内各结点的度的最大值。D结点度最大为3，树的度数就是3;</li>
<li>孩子(儿子Child)结点: 结点的子树的根结点成为该结点的孩子;</li>
<li>双亲(父Parent)结点: 一个结点是它各子树的根结点的双亲;</li>
<li>兄弟(Sibling)结点: 具有相同双亲结点的结点;</li>
<li>祖先结点:  从要结点到该结点所经分支上所有的结点。 A、B、D 都是G的祖先结点;</li>
<li>子孙结点: 结点的所有子树上的结点都称为该结点的子孙。B的子孙是D、G、H、I</li>
<li>结点的层次(Level): 根节点为第一层，根的孩子为第二层，以此类推，记作L(v)</li>
<li>树的深度(高度Depth); 树的层次的最大值。上图的树深度为4</li>
<li><p>堂兄弟:双亲在同一层结点。</p>
</li>
<li><p>有序树: 结点的子树是有顺序的(兄弟有大小，有先后次序)，不能交换。</p>
</li>
<li>无序树: 结点的子树是无序的，可以交换;</li>
<li><p>路径: 树中的k 个结点n1、n2、….、nk ，满足n1是n(i+1)的双亲，成为n1到nk的一条路径。就是一条线串下来的，前一个都是后一个父(前驱)结点。</p>
</li>
<li><p>路径长度=路径 上结点-1，也是分支数;</p>
</li>
<li>森林:m(m&gt;=0)棵不相交的树的集合;<br>对于结点而言，其子树的集合就是森林。A结点的2棵子树的集合就是森林。</li>
</ul>
<h2 id="树-1"><a href="#树-1" class="headerlink" title="树"></a>树</h2><ul>
<li>树的特点<br>  唯一的根<br>  子树不相交<br>  除了根以外，每个元素只能有一个前驱，可以有零个或多个后继;<br>  根结点没有双亲结点(前驱)，叶子结点没有孩子结点(后继)<br>  vi是 vj 的双亲，则L(vi) = L(vj)-1，也就是说双亲比孩子结点的层小1</li>
</ul>
<h2 id="二叉树"><a href="#二叉树" class="headerlink" title="二叉树"></a>二叉树</h2><ul>
<li>每个结点最多2棵了树<br>  二叉树不存在度数大于2的结点</li>
<li>它是有序树，左子树、右子树是顺序的，不能交换次序;</li>
<li>即使某个结点只有一棵子树，也要确定它是左子树还是右子树;</li>
<li>二叉树的的五种基本形态<br>  空二叉树<br>  只有一个根结点<br>  根结点只有左子树<br>  根结点只有右子树<br>  根结点有左子树和右子树</li>
</ul>
<h2 id="斜树"><a href="#斜树" class="headerlink" title="斜树"></a>斜树</h2><ul>
<li>左斜树，所有结点都只有左子树;</li>
<li><p>右斜树，所有节点都只有右子树;</p>
<h2 id="满二叉树"><a href="#满二叉树" class="headerlink" title="满二叉树"></a>满二叉树</h2></li>
<li><p>一棵二叉树的所有分支结点都存在左子树和右子树，并且所有叶子结点只存在在最下面一层;</p>
</li>
<li>同样深度二叉树中，满二叉树结点最多;</li>
<li>k 为深度(1&lt;=k&lt;=n)，则结点总数为2^k-1;</li>
</ul>
<h2 id="完全二叉树Complete-Binary-Tree"><a href="#完全二叉树Complete-Binary-Tree" class="headerlink" title="完全二叉树Complete Binary Tree"></a>完全二叉树Complete Binary Tree</h2><ul>
<li>若二叉树的深度为k, 二叉树的层数从1到k-1层的结点数都达到了最大个数,在第k层的所有结点都集中在最左边，这就是完全二叉树;</li>
<li>完全二叉树由满二叉树引出;</li>
<li>满二叉树一定是完全二叉树，但完全二叉树不是满二叉树;</li>
<li>k为深度(1&lt;=k&lt;=n)，则结点总数最大值为2^k-1，当达到最大值的时候就是满二叉树；</li>
</ul>
<h2 id="二叉树性质"><a href="#二叉树性质" class="headerlink" title="二叉树性质"></a>二叉树性质</h2><ul>
<li>对任何一棵二叉树T，如果其终端节点数为n0，度数为2的结点为n2，则有n0=n2+1;</li>
<li>换句话说，就是叶子结点数-1就等于度数为2的结点数;</li>
<li>证明:</li>
</ul>
<ol>
<li>总结点数为n=n0+n1+n2，n1为度数为1的结点数;</li>
<li>一棵树的分支数为n-1，因为除了根结点外，其余结点都有一个分支，即n0+n1+n2-1;</li>
<li>分支数还等于n0*0+n1*1+n2*2，n2 是2分支结点所以乘以2，2*n2+n1。</li>
<li>可得2*n2+n1 = n0+n1+n2-1 =&gt; n2 =n0-1</li>
</ol>
<ul>
<li>其他性质</li>
</ul>
<ol>
<li>高度为k的二叉树，至少有k个结点;</li>
<li>含有n(n&gt;=1)的结点的二叉树高度至多为n，和上句一个意思;</li>
<li>含有n(n&gt;=1)的结点的二叉树高度至多为n，最小为meth.ceil(log2(n+1))，不小于对数值的最小整数，向上取整;</li>
<li>假设高度为h，2^h-1=n =&gt; h= log2(n+1)，层次数是取整。如果是8个节点，3.1699就要向上取整为4, 为4层。</li>
</ol>
<ul>
<li>具有n 个结点的完全二叉树的深度为int(log2n)+1 或者meth.ceil(log2(n+1))</li>
</ul>
<h2 id="性质5"><a href="#性质5" class="headerlink" title="性质5"></a>性质5</h2><ul>
<li>如果有一棵n个结点的完全二叉树，结点按照层序编号;</li>
<li>如果i=1, 则结点i是二叉树的根，无双亲;如果i&gt;1，则其双亲是int(i/2)，向下取整。就是子节点的编号整除2得到的就是父结点的编号。父结点如果是i，那么左孩子结点就是2i，右孩子结点就是2i+1;</li>
<li>如果2i&gt;n, 则结点i无左孩子，即结点i为叶子结点；否则其左孩子结点存在的编号为2i;</li>
<li>如果2i+1 &gt;n，则结点i无右孩子，注意这里并不能说明结点i 没有左孩子; 否则右孩子结点存在编号为2i+1。</li>
</ul>
<h2 id="格言"><a href="#格言" class="headerlink" title="格言"></a>格言</h2><p>有恒，乃为作圣之基<br>凡人作一事，便须全副精神注在此一事，首尾不懈，不可见异思迁，做这样想那样，坐之山望那山。人而无恒，终身一无所成。</p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 函数(一)</title>
    <url>/2020/08/05/python%E5%87%BD%E6%95%B0%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-函数-一"><a href="#python-函数-一" class="headerlink" title="python 函数(一)"></a>python 函数(一)</h1><p><img src="/images/python_function.png" class="lazyload" data-srcset="/images/python_function.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>数学定义: y=f(x)，y是x的函数，x是自变量</p>
<ul>
<li>python 函数</li>
</ul>
<p>由苦干语句组成的语句块、函数名称、参数列表构成，它是组织代码的最小单元格<br>完成一定的功能</p>
<ul>
<li>函数的作用</li>
</ul>
<p>结构化编程对代码的最基本的封装，一般按照功能组织一段代码;<br>封装的目的为了复用，减少冗余代码<br>代码更加简洁美化、可读易懂</p>
<ul>
<li>函数的分类</li>
</ul>
<p>内建的函数，如max()、reversed()等<br>库函数,如math.ceil()等</p>
<h3 id="函数定义、调用"><a href="#函数定义、调用" class="headerlink" title="函数定义、调用"></a>函数定义、调用</h3><ul>
<li><p>def语句定义函数<br>def 函数名(参数列表):<br>函数体(代码块)<br>[return 返回值]</p>
</li>
<li><p>函数名就是标识符，命名要求一样：</p>
</li>
<li>语句块必须缩进，约定4个空格;</li>
<li>Python 的函数没有return语句，隐式返回 一个None值</li>
<li><p>定义中的参数列表成为形式参数，只是一种符号表达，简称<strong>形参</strong></p>
</li>
<li><p>调用<br>函数定义，只是声明了一个函数，它不会被执行，需要调用;<br>调用的方式，就是函数名加上小括号，括号内写上参数;<br>调用时写的参数是实际参数，是实实在在传的值，简称<strong>实参</strong></p>
</li>
</ul>
<ul>
<li>函数举例</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">3</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">   ...:     result = x+y</span><br><span class="line">   ...:     <span class="keyword">return</span> result</span><br><span class="line">   ...:</span><br><span class="line">   ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: out = add(<span class="number">100</span>,<span class="number">255</span>)</span><br><span class="line">In [<span class="number">5</span>]: out</span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">355</span></span><br></pre></td></tr></table></figure>
<p>上面只是一个函数的定义，有一个函数叫做add，接收2个参数<br>计算的结果，通过返回值返回<br>调用通过函数名add加2个参数，返回值可使用变量接收;<br>定义需要在调用前，也就是说调用时，已经被定义过了，否则抛NameError异常<br>函数是可调用的对象,callable()</p>
<h3 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h3><ul>
<li>参数调用时传入的参数要和定义的个数相匹配(可变参数例外)</li>
<li>位置参数<br>def f(x, y, z) 调用使用 f(1, 3, 5)<br>按照参数定义顺序传入实参</li>
</ul>
<p>关键字参数<br>def f(x, y ,z) 调用使用f(x=1,y=3,z=5)<br>使用形参的名字来出入实参的方式，如果使用了形象名字，那么传参顺序就可以定义顺序不同</p>
<ul>
<li>传参</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f(z=<span class="literal">None</span>, y=<span class="number">10</span>, x=[<span class="number">1</span>])</span><br><span class="line">f((<span class="number">1</span>,), z=<span class="number">6</span>, y=<span class="number">4.1</span>)</span><br><span class="line">f(y=<span class="number">5</span>,z=<span class="number">6.2</span>)</span><br><span class="line"><span class="comment"># 要求位置参数必须在关键字参数之前传入，位置参数是按位置对应的</span></span><br></pre></td></tr></table></figure>
<h3 id="函数参数默认值"><a href="#函数参数默认值" class="headerlink" title="函数参数默认值"></a>函数参数默认值</h3><ul>
<li>定义时，在形参后跟上一个值 </li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">6</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x=<span class="number">1</span>,y=<span class="number">5</span></span>):</span></span><br><span class="line">   ...:     <span class="keyword">return</span> x+y</span><br><span class="line">In [<span class="number">7</span>]: <span class="built_in">callable</span>(add)</span><br><span class="line">Out[<span class="number">7</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">8</span>]: add()</span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">6</span></span><br><span class="line">In [<span class="number">9</span>]: add(<span class="number">6</span>)</span><br><span class="line">Out[<span class="number">9</span>]: <span class="number">11</span></span><br><span class="line">In [<span class="number">10</span>]: add(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">13</span></span><br><span class="line">In [<span class="number">11</span>]: add(y=<span class="number">8</span>,x=<span class="number">1</span>)</span><br><span class="line">Out[<span class="number">11</span>]: <span class="number">9</span></span><br></pre></td></tr></table></figure>
<ul>
<li>作用<br>参数的默认值可以在未传入足够的实参的时候，对没有给定的参数赋值为默认值<br>参数的非常多的时候，并不需要用户每次都输入所有的参数，简化函数调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">12</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y=<span class="number">5</span></span>):</span></span><br><span class="line">    ...:     <span class="keyword">return</span> x+y</span><br><span class="line">In [<span class="number">13</span>]: add(<span class="number">3</span>)</span><br><span class="line">Out[<span class="number">13</span>]: <span class="number">8</span></span><br><span class="line">In [<span class="number">14</span>]: add(<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line">Out[<span class="number">14</span>]: <span class="number">9</span></span><br></pre></td></tr></table></figure>
<ul>
<li>举例<br>定义一个函数login，参数名称为host、port、username、passwd</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="string">&#x27;8080&#x27;</span>,username=<span class="string">&#x27;rj&#x27;</span>,password=<span class="string">&#x27;test&#x27;</span></span>):</span></span><br><span class="line">    print(<span class="string">&#x27;&#123;&#125;:&#123;&#125;@&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(host,port,username,password))</span><br><span class="line">login()</span><br><span class="line">login(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">80</span>,<span class="string">&#x27;tom&#x27;</span>,<span class="string">&#x27;tom&#x27;</span>)</span><br><span class="line">login(<span class="string">&#x27;127.0.0.1&#x27;</span>,username=<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">login(<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">80</span>,password=<span class="string">&#x27;com&#x27;</span>)</span><br><span class="line">login(port=<span class="number">80</span>,password=<span class="string">&#x27;test&#x27;</span>,host=<span class="string">&#x27;web&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><ul>
<li>问题<br>有多个数，需要求累加求和</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">15</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">nums</span>):</span></span><br><span class="line">    ...:     <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    ...:     <span class="keyword">for</span> x <span class="keyword">in</span> nums:</span><br><span class="line">    ...:         <span class="built_in">sum</span> += x</span><br><span class="line">    ...:     <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line">In [<span class="number">16</span>]: add([<span class="number">1</span>,<span class="number">2</span>,<span class="number">5</span>])</span><br><span class="line">Out[<span class="number">16</span>]: <span class="number">8</span></span><br><span class="line">In [<span class="number">17</span>]: add((<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>))</span><br><span class="line">Out[<span class="number">17</span>]: <span class="number">12</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可变参数</li>
</ul>
<p>一个形参可以匹配任意个参数<br>有多个数，需要累加求和</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">22</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">*nums</span>):</span></span><br><span class="line">    ...:     <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    ...:     print(<span class="built_in">type</span>(nums))</span><br><span class="line">    ...:     <span class="keyword">for</span> x <span class="keyword">in</span> nums:</span><br><span class="line">    ...:         <span class="built_in">sum</span> += x</span><br><span class="line">    ...:     print(<span class="built_in">sum</span>)</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">23</span>]: add(<span class="number">3</span>,<span class="number">6</span>,<span class="number">9</span>)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">tuple</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">18</span></span><br></pre></td></tr></table></figure>
<p>在形参前使用*表示该形参是可变参数，可以接收多个实参;<br>收集的实参名称和值组成一个tuple;</p>
<h3 id="可变参数-1"><a href="#可变参数-1" class="headerlink" title="可变参数"></a>可变参数</h3><p>关键字参数的可变参数</p>
<ul>
<li>配置信息打印</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">9</span>]: <span class="function"><span class="keyword">def</span> <span class="title">showconfig</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">   ...:     <span class="keyword">for</span> k,v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">   ...:         print(<span class="string">&#x27;&#123;&#125; = &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(k,v))</span><br><span class="line">   ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]:</span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]: showconfig(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="string">&#x27;8080&#x27;</span>,username=<span class="string">&#x27;asjin&#x27;</span>,password=<span class="string">&#x27;ssjinyao&#x27;</span>)</span><br><span class="line">host = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">port = <span class="number">8080</span></span><br><span class="line">username = asjin</span><br><span class="line">password = ssjinyao</span><br></pre></td></tr></table></figure>
<ul>
<li>形参前使用**符号，表示可以接收多个关键字参数</li>
<li>收集的实参名称和值组成一个字典</li>
</ul>
<p>混着写，关键的默认定义好，其它的用kwargs</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showconfig</span>(<span class="params">username, password, **kwargs</span>)</span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">showconfig</span>(<span class="params">username, *args, **kwargs</span>)</span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">showconfig</span>(<span class="params">username, password,**kwargs, *args</span>)</span></span><br></pre></td></tr></table></figure>
<p>总结</p>
<ul>
<li>有位置可变参数和关键字可变参数;</li>
<li>位置可变参数在形参前使用一个星号*;</li>
<li>关键字可变参在形参前使用两个星号**;</li>
<li>位置可变参数和关键字可变参数都可以收集若干个实参，位置可变参数收集形成一个tuple，关键字可变参数收集形成一个dict;</li>
<li>混合使用参数的时候，可变参数要放到参数列表的最后，普通参数要放到参数列表前面，位置可变参数需要在关键字可变参数之前。</li>
</ul>
<p>举例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">x, y, *args, **kwargs</span>):</span></span><br><span class="line">    print(x)</span><br><span class="line">    print(y)</span><br><span class="line">    print(args)</span><br><span class="line">    print(kwargs)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>,a=<span class="number">1</span>,b=<span class="string">&#x27;python&#x27;</span>)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, a=<span class="number">1</span>,b=<span class="string">&#x27;python&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>举例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">*args, x, y, **kwargs</span>)</span></span><br><span class="line"><span class="function">    <span class="title">print</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function">    <span class="title">print</span>(<span class="params">y</span>)</span></span><br><span class="line"><span class="function">    <span class="title">print</span>(<span class="params">args</span>)</span></span><br><span class="line"><span class="function">    <span class="title">print</span>(<span class="params">kwargs</span>)</span></span><br><span class="line"><span class="function"><span class="title">fn</span>(<span class="params"><span class="number">7</span>, <span class="number">9</span>, y=<span class="number">5</span>, x=<span class="number">3</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;python&#x27;</span> </span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="keyword-only-参数"><a href="#keyword-only-参数" class="headerlink" title="keyword-only 参数"></a>keyword-only 参数</h3><ul>
<li>keyword-only 参数(Python3 加入)</li>
</ul>
<p>如果在一个星号参数后，或者一个位置可变参数后，出现的普通参数，实际上已经不是普通的参数了，而是keyword-only参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">*args, x</span>):</span></span><br><span class="line">    print(x)</span><br><span class="line">    print(args)</span><br><span class="line">fn(<span class="number">3</span>, <span class="number">5</span>, x=<span class="number">7</span>)</span><br></pre></td></tr></table></figure>
<p>args 可以看做已经截获了所有的位置参数，x不使用关键字参数就可能拿到实参</p>
<ul>
<li>keyword-only 参数另一种形式</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">*, x, y</span>):</span></span><br><span class="line">    print(x,y)</span><br><span class="line"></span><br><span class="line">fn(x=<span class="number">5</span>, y=<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<p>*号之后，普通形参都变成了必须给出的keyword-only参数</p>
<ul>
<li>可变参数和参数默认值 </li>
</ul>
<p>举例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">*args, x=<span class="number">5</span></span>):</span></span><br><span class="line">    print(x)</span><br><span class="line">    print(args)</span><br><span class="line"></span><br><span class="line">fn() <span class="comment"># 等价于fn(x=5)</span></span><br><span class="line">fn(<span class="number">5</span>)</span><br><span class="line">fn(x=<span class="number">6</span>)</span><br><span class="line">fn(<span class="number">1</span> , <span class="number">2</span>, <span class="number">3</span>, x=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>x 是keyword-only 参数</p>
<p>举例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">x=<span class="number">5</span>, **kwargs</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;x=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">    print(kwargs)</span><br><span class="line">fn()</span><br><span class="line">fn(<span class="number">5</span>)</span><br><span class="line">fn(x=<span class="number">6</span>)</span><br><span class="line">fn(y=<span class="number">3</span>,x=<span class="number">10</span>)</span><br><span class="line">fn(<span class="number">3</span>,y=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>函数参数</p>
<ul>
<li>参数规则<br>参数列表参数一般顺序是，普通参数、缺省参数、可变位置参数、keyword-only参数(可带缺省值)、可变关键字参数</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">x, y, z=<span class="number">3</span>, *arg, m=<span class="number">4</span>, n, **kwargs</span>):</span></span><br><span class="line">    print(x, y, z, m,n)</span><br><span class="line">    print(args)</span><br><span class="line">    print(kwargs)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="string">&#x27;3306&#x27;</span>,user=<span class="string">&#x27;admin&#x27;</span>,password=<span class="string">&#x27;admin&#x27;</span>,**kwargs</span>):</span></span><br><span class="line">    print(host,port)</span><br><span class="line">    print(user,passowrd)</span><br><span class="line">    print(kwargs)</span><br><span class="line">connect(db=<span class="string">&#x27;cmdb&#x27;</span>)</span><br><span class="line">connect(host=<span class="string">&#x27;172.16.0.8&#x27;</span>,db=<span class="string">&#x27;cmdb&#x27;</span>)</span><br><span class="line">connect(host=<span class="string">&#x27;172.160.0.9&#x27;</span>,db=<span class="string">&#x27;cmdb&#x27;</span>,password=<span class="string">&#x27;mysql&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="参数解构"><a href="#参数解构" class="headerlink" title="参数解构"></a>参数解构</h3><p>举例: 加法函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x+y</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">add((<span class="number">4</span>, <span class="number">5</span>))</span><br><span class="line">t = (<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">add(t[<span class="number">0</span>], t[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># add(*t) 或 add(*(4, 5)) add(*[4,5]) add(*&#123;4,6&#125;)</span></span><br><span class="line"><span class="comment"># add(*range(1,3))</span></span><br><span class="line">In [<span class="number">1</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">   ...:     <span class="keyword">return</span> x+y</span><br><span class="line">In [<span class="number">3</span>]: add((<span class="number">1</span>,<span class="number">2</span>)[<span class="number">0</span>],[<span class="number">3</span>][<span class="number">0</span>])</span><br><span class="line">Out[<span class="number">3</span>]: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">   ...:     <span class="keyword">return</span> x+y</span><br><span class="line">In [<span class="number">9</span>]: lst = [<span class="number">1</span>,<span class="number">3</span>]</span><br><span class="line">In [<span class="number">10</span>]: add(*lst)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">4</span></span><br><span class="line"><span class="comment"># 当给定一个集合</span></span><br><span class="line">In [<span class="number">12</span>]: add(*&#123;<span class="number">5</span>,<span class="number">6</span>&#125;)</span><br><span class="line">Out[<span class="number">12</span>]: <span class="number">11</span></span><br></pre></td></tr></table></figure>
<p>例:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">28</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">*keys</span>):</span></span><br><span class="line">    ...:     sumnum = <span class="number">0</span></span><br><span class="line">    ...:     <span class="keyword">for</span> i <span class="keyword">in</span> keys:</span><br><span class="line">    ...:         sumnum = sumnum + i</span><br><span class="line">    ...:     <span class="keyword">return</span> sumnum</span><br><span class="line">In [<span class="number">29</span>]: add(*<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>))</span><br><span class="line">Out[<span class="number">29</span>]: <span class="number">5050</span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数解构</li>
</ul>
<p>给函数提供实参的时候，可以在集合类型前使用* 或者** , 把集合类型的结构解开，提取所有元素做为函数的实参<br>非字典类型使用*解构成位置参数<br>字典类型使用*解构成位置参数<br>提取出来的元素数王要和参数的要求匹配，也要和参数的类型匹配</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x+y</span><br><span class="line">add(*(<span class="number">4</span> ,<span class="number">5</span>)) </span><br><span class="line">add(*[<span class="number">4</span>,<span class="number">5</span>])</span><br><span class="line">add(*&#123;<span class="number">4</span>,<span class="number">6</span>&#125;)</span><br><span class="line">d = &#123;<span class="string">&#x27;x&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;y&#x27;</span>:<span class="number">6</span>&#125;</span><br><span class="line">add(**d)</span><br><span class="line">add(**&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">5</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">6</span>&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">39</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    ...:     <span class="keyword">return</span> x+y</span><br><span class="line">In [<span class="number">40</span>]: dct = &#123;<span class="string">&#x27;x&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;y&#x27;</span>:<span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">41</span>]: add(*dct.values())</span><br><span class="line">Out[<span class="number">41</span>]: <span class="number">7</span></span><br></pre></td></tr></table></figure>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>编写一个函数，能够接受至少2个参数，返回最小值和最大值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">49</span>]: <span class="function"><span class="keyword">def</span> <span class="title">mums</span>(<span class="params">x, y, *args</span>):</span></span><br><span class="line">    ...:     print(<span class="built_in">min</span>(x,y,*args))</span><br><span class="line">    ...:     print(<span class="built_in">max</span>(x,y,*args))</span><br><span class="line">In [<span class="number">50</span>]: mums(*<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100001</span>))</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">100000</span></span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">51</span>]: <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">In [<span class="number">52</span>]: <span class="function"><span class="keyword">def</span> <span class="title">double_values</span>(<span class="params">*nums</span>):</span></span><br><span class="line">    ...:     print(nums)</span><br><span class="line">    ...:     <span class="keyword">return</span> <span class="built_in">max</span>(nums), <span class="built_in">min</span>(nums)</span><br><span class="line">In [<span class="number">53</span>]: print(*double_values(*[random.randint(<span class="number">10</span>,<span class="number">20</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]))</span><br><span class="line">(<span class="number">14</span>, <span class="number">11</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">17</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">18</span>, <span class="number">12</span>, <span class="number">13</span>)</span><br><span class="line"><span class="number">19</span> <span class="number">11</span></span><br></pre></td></tr></table></figure>
<p>编写 一个函数，接受一个参数n， n为正整数, 左右两种打印方式, 要求数字必须对齐</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">In [<span class="number">59</span>]: <span class="function"><span class="keyword">def</span> <span class="title">trangle_print</span>(<span class="params">n</span>):</span></span><br><span class="line">    ...:     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n+<span class="number">1</span>):</span><br><span class="line">    ...:         <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">    ...:             <span class="keyword">if</span> i &lt; j:</span><br><span class="line">    ...:                 print(<span class="string">&#x27; &#x27;</span>*<span class="built_in">len</span>(<span class="built_in">str</span>(j)), end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    ...:             <span class="keyword">else</span>:</span><br><span class="line">    ...:                 print(j, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    ...:         print()</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">60</span>]: trangle_print(<span class="number">16</span>)</span><br><span class="line">                                     <span class="number">1</span></span><br><span class="line">                                   <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                                 <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                               <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                             <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                           <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                         <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                       <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                     <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                  <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">               <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">            <span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">         <span class="number">13</span> <span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">      <span class="number">14</span> <span class="number">13</span> <span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">   <span class="number">15</span> <span class="number">14</span> <span class="number">13</span> <span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line"><span class="number">16</span> <span class="number">15</span> <span class="number">14</span> <span class="number">13</span> <span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">61</span>]: <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">n</span>):</span></span><br><span class="line">    ...:     tail = <span class="string">&quot; &quot;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n,<span class="number">0</span>,<span class="number">-1</span>)])</span><br><span class="line">    ...:     print(tail)</span><br><span class="line">    ...:     width = <span class="built_in">len</span>(tail)</span><br><span class="line">    ...:     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n):</span><br><span class="line">    ...:         print(<span class="string">&quot;&#123;:&gt;&#123;&#125;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot; &quot;</span>.join([<span class="built_in">str</span>(j) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i,<span class="number">0</span>,<span class="number">-1</span>)]), width))</span><br><span class="line">    ...:     print(tail)</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">62</span>]: show(<span class="number">12</span>)</span><br><span class="line"><span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                         <span class="number">1</span></span><br><span class="line">                       <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                     <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                   <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                 <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">               <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">             <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">           <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">         <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">      <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">   <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line"><span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">63</span>]: <span class="function"><span class="keyword">def</span> <span class="title">showtail</span>(<span class="params">n</span>):</span></span><br><span class="line">    ...:     tail = <span class="string">&quot; &quot;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n,<span class="number">0</span>,<span class="number">-1</span>)])</span><br><span class="line">    ...:     print(tail)</span><br><span class="line">    ...:     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tail)):</span><br><span class="line">    ...:         <span class="keyword">if</span> tail[i] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">    ...:             print(<span class="string">&#x27; &#x27;</span>*i, tail[i+<span class="number">1</span>:])</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">64</span>]: showtail(<span class="number">12</span>)</span><br><span class="line"><span class="number">12</span> <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">   <span class="number">11</span> <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">      <span class="number">10</span> <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">         <span class="number">9</span> <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">           <span class="number">8</span> <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">             <span class="number">7</span> <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">               <span class="number">6</span> <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                 <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                   <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                     <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                       <span class="number">2</span> <span class="number">1</span></span><br><span class="line">                         <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="直接插入排序"><a href="#直接插入排序" class="headerlink" title="直接插入排序"></a>直接插入排序</h3><p>在未排序序列中，构建一个子排序序列，直至全部数据排序完成;<br>将待排序的数，插到<strong>已经排序</strong>的序列中合适的位置;<br>增加一个哨兵，放入待比较值，让它和后面已经排好的序列比较，找到适合的插入点;</p>
<ul>
<li>增加一个哨兵位，每轮比较将待比较数入;</li>
<li>哨兵依次和待比较数的前一个数据比较，大数靠右移动，找到哨兵中值的插入位置;</li>
<li>每一轮结束后，得到一个从开始到待比较数位置的一个有序序列</li>
</ul>
<p>实例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">m_list = [[<span class="number">1</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span> ], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">          [<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span> ], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">          [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>]]</span><br><span class="line">nums = [<span class="number">0</span>] + m_list[<span class="number">0</span>]</span><br><span class="line">sentinel, *origin = nums  <span class="comment">#哨兵位，待比较数字</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,length): <span class="comment">#从2开始</span></span><br><span class="line">    nums[<span class="number">0</span>] = nums[i] <span class="comment"># 放置哨兵</span></span><br><span class="line">    j = i <span class="number">-1</span></span><br><span class="line">    count_iter +=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> nums[j] &gt; nums[<span class="number">0</span>]: <span class="comment"># 大数右移，找到插入位置</span></span><br><span class="line">        <span class="keyword">while</span> nums[j] &gt; nums[<span class="number">0</span>]:</span><br><span class="line">            nums[j+<span class="number">1</span>] = nums[j] <span class="comment"># 依次右移</span></span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">            count_swap +=<span class="number">1</span></span><br><span class="line">        nums[j+<span class="number">1</span>] = nums[<span class="number">0</span>] <span class="comment"># 将哨兵插入，注意挺好入的右侧要+1</span></span><br><span class="line">print(nums, count_swap, count_iter)</span><br></pre></td></tr></table></figure>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><ul>
<li>一个标识符的可见范围，这就是标识符的作用域。一般常说的是变量的作用域</li>
<li>举例，对比左右2个函数</li>
</ul>
<figure class="highlight ipython"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: x = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">   ...:     print(x)</span><br><span class="line">In [<span class="number">7</span>]: show()</span><br><span class="line"><span class="number">50</span></span><br></pre></td></tr></table></figure>
<p>看似是可见的，但尝试以下语句 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: x = <span class="number">5</span></span><br><span class="line">In [<span class="number">9</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">   ...:     x += <span class="number">1</span></span><br><span class="line">   ...:     print(x)</span><br><span class="line">In [<span class="number">10</span>]: foo()</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">UnboundLocalError                         Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span><span class="number">-10</span>-c19b6d9633cf&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 foo()</span><br><span class="line">&lt;ipython-<span class="built_in">input</span><span class="number">-9</span><span class="number">-69</span>a7705e0064&gt; <span class="keyword">in</span> foo()</span><br><span class="line">      <span class="number">1</span> <span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">----&gt; 2     x += 1</span><br><span class="line">      <span class="number">3</span>     print(x)</span><br><span class="line">      <span class="number">4</span></span><br><span class="line">UnboundLocalError: local variable <span class="string">&#x27;x&#x27;</span> referenced before assignment</span><br><span class="line">In [<span class="number">11</span>]:</span><br></pre></td></tr></table></figure>
<ul>
<li><p>全局作用域<br>在整个程序运行环境中都可见</p>
</li>
<li><p>局部作用域<br>在函数、类等内部可见<br>局部变量使用范围不能超过期所有的局部作用域</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn1</span>():</span></span><br><span class="line">    x = <span class="number">1</span> <span class="comment"># 局部作用域，在fn1内</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn2</span>():</span></span><br><span class="line">    print(x) </span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">16</span>]: <span class="function"><span class="keyword">def</span> <span class="title">outer</span>():</span></span><br><span class="line">    ...:     o = <span class="number">65</span></span><br><span class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">    ...:         print(<span class="string">&quot;inner &#123;&#125;&quot;</span>.<span class="built_in">format</span>(o))</span><br><span class="line">    ...:         print(<span class="built_in">chr</span>(o))</span><br><span class="line">    ...:     print(<span class="string">&quot;outer &#123;&#125;&quot;</span>.<span class="built_in">format</span>(o))</span><br><span class="line">    ...:     inner()</span><br><span class="line">In [<span class="number">18</span>]: outer()</span><br><span class="line">outer <span class="number">65</span></span><br><span class="line">inner <span class="number">65</span></span><br><span class="line">A</span><br></pre></td></tr></table></figure>
<p>对比</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">19</span>]: <span class="function"><span class="keyword">def</span> <span class="title">outer2</span>():</span></span><br><span class="line">    ...:     o = <span class="number">65</span></span><br><span class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">    ...:         o = <span class="number">97</span></span><br><span class="line">    ...:         print(<span class="string">&quot;inner &#123;&#125;&quot;</span>.<span class="built_in">format</span>(o))</span><br><span class="line">    ...:         print(<span class="built_in">chr</span>(o))</span><br><span class="line">    ...:     print(<span class="string">&quot;outer &#123;&#125;&quot;</span>.<span class="built_in">format</span>(o))</span><br><span class="line">    ...:     inner()</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">20</span>]: outer2()</span><br><span class="line">outer <span class="number">65</span></span><br><span class="line">inner <span class="number">97</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>
<p>全局变量global</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="number">5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">    <span class="keyword">global</span> x </span><br><span class="line">    x += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用global关键字的变量，将foo内的x声明为使用外部的全局作用域定义的x</li>
<li>全局作用域中必须有x的定义</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">    <span class="keyword">global</span> x</span><br><span class="line">    x = <span class="number">10</span></span><br><span class="line">    x += <span class="number">1</span></span><br><span class="line">    print(x)</span><br><span class="line">foo()</span><br><span class="line">print(x)</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<ul>
<li>但是, x=10 赋值即定义， x 在内部作用域为一个外部作用域的变量赋值, 所以x+=1会报错。</li>
<li>注意，这里的x的作用域还是全局的</li>
</ul>
<h3 id="global-总结"><a href="#global-总结" class="headerlink" title="global 总结"></a>global 总结</h3><ul>
<li>x+=1这种是特珠形式产生的错误的原因？ 先引用后赋值，而python动态语言是赋值才算定义，才能被引用。解决办法，在这条语句前加x=0之类的赋值语句，或者使用global告诉内部作用域，去全局作用域查变量定义</li>
<li><strong>内部作用域作用x =5 之类的赋值语句会重新定义局部作用域使用的变量x，但是，一旦这个作用域中使用global声明x为全局的，那么x=5相当于在为全局作用域的变量x赋值</strong></li>
<li>global的使用原则</li>
<li>外部作用域亦是会内部作用域可见，但也不要在这个内部的局部作用域中直接使用，因为函数的目的就是为了封装，尽量与外界隔离</li>
<li>如果函数需要使用外部全局变量，请使用函数的形参传参解决</li>
</ul>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><ul>
<li>自由变量:  未在本地作用域中定义的变量。例如定义在内存函数外的外层函数作用域中的变量</li>
<li>闭包: 就是一个概念，出现在嵌套函数中，指的<strong>内层函数引用到了外层函数的自由变量</strong>就形成了闭包。很多语言都有这个概念，最熟悉就是JavaScript</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: <span class="function"><span class="keyword">def</span> <span class="title">counter</span>():</span></span><br><span class="line">   ...:     c = [<span class="number">0</span>]</span><br><span class="line">   ...:     <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">   ...:         c[<span class="number">0</span>] +=<span class="number">1</span></span><br><span class="line">   ...:         <span class="keyword">return</span> c[<span class="number">0</span>]</span><br><span class="line">   ...:     <span class="keyword">return</span> inner</span><br><span class="line">In [<span class="number">9</span>]: foo = counter()</span><br><span class="line">In [<span class="number">11</span>]: print(<span class="built_in">type</span>(foo))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">function</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">In</span> [12]:</span> print(<span class="built_in">type</span>(foo()))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">int</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">In</span> [13]:</span> print(foo(),foo())</span><br><span class="line"><span class="number">2</span> <span class="number">3</span></span><br><span class="line">In [<span class="number">15</span>]: print(foo())</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 集合字典</title>
    <url>/2020/06/27/python_dict/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-集合、-字典"><a href="#python-集合、-字典" class="headerlink" title="python 集合、 字典"></a>python 集合、 字典</h1><p><img src="/images/python_dict.png" class="lazyload" data-srcset="/images/python_dict.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><ul>
<li>基本概念<br>全集：所有元素的集合。例如实数集，所有实数组成的集合就是全集;<br>子集subset和超集superset: 一个集合A所有元素都在另一个集合B是A的真超集;<br>并集: 多个集合合并的结果;<br>交集: 多个集合的公共部分;<br>差集: 集合中除去和其他集合公共部分。</li>
</ul>
<h3 id="并集"><a href="#并集" class="headerlink" title="并集"></a>并集</h3><p>将多个集合A和B的所有的元素合并到一起<br><code>union(*others)</code><br>返回和多个集合合并后的新的集合<br>运算符重载，等同<code>union</code><br><code>update(*others)</code><br>和多个集合合并，就地修改<br><code>|=</code><br>等同update</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">In [<span class="number">9</span>]: b = &#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">In [<span class="number">10</span>]: c = b.union(a)</span><br><span class="line">In [<span class="number">11</span>]: c</span><br><span class="line">Out[<span class="number">11</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">29</span>]: a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">In [<span class="number">30</span>]: b = &#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line">In [<span class="number">31</span>]: b.update(a)</span><br><span class="line">In [<span class="number">32</span>]: b</span><br><span class="line">Out[<span class="number">32</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="交集"><a href="#交集" class="headerlink" title="交集"></a>交集</h3><ul>
<li>集合A和B，由所有属于A且属于B的元素组成的集合<br><code>intersection(*others)</code></li>
<li>返回和多个集合的交集<br><code>&amp; 等同insersection</code><br><code>intersection_update(*others)</code><br>获取和多个集合的交集，并就地修改<br><code>&amp;=</code><br>等同<code>intersection_update</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: a=&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">In [<span class="number">2</span>]: b=&#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line">In [<span class="number">3</span>]: c = a &amp; b</span><br><span class="line">In [<span class="number">4</span>]: c</span><br><span class="line">Out[<span class="number">4</span>]: &#123;<span class="number">3</span>&#125;</span><br><span class="line">Out[<span class="number">7</span>]: &#123;<span class="number">3</span>&#125;</span><br><span class="line">In [<span class="number">8</span>]: a.intersection_update(b)</span><br><span class="line">In [<span class="number">9</span>]: a</span><br><span class="line">Out[<span class="number">9</span>]: &#123;<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="差集"><a href="#差集" class="headerlink" title="差集"></a>差集</h3><p>集合A和B，是所有属于A且不属于B的元素组成的集合<br><code>difference(*others)</code><br>返回和多个集合的差集<br><code>-</code> 等同<code>difference</code><br><code>difference_update(*others)</code><br>获取和多个集合的差集并就地修改<br><code>-=</code><br>等同difference_update<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: a.update(&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;)</span><br><span class="line">In [<span class="number">11</span>]: a</span><br><span class="line">Out[<span class="number">11</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">12</span>]: b.update(&#123;<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;)</span><br><span class="line">In [<span class="number">13</span>]: a - b</span><br><span class="line">Out[<span class="number">13</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">15</span>]: a -= b</span><br><span class="line">In [<span class="number">16</span>]: a</span><br><span class="line">Out[<span class="number">16</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">6</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="对称差集"><a href="#对称差集" class="headerlink" title="对称差集"></a>对称差集</h3><p>集合A和B，由所有不属于A和B的交集元素组成的集合，记作(A-B)U(B-A)<br><code>symmetric_differece(other)</code><br>返回和另一个集合的差集<br><code>^</code><br>等同于<code>symmetric_differece</code><br><code>symmetric_differece_update(other)</code><br>获取和另一个集合的差集并就地修改<br><code>^=</code><br>等同于<code>symmetric_differece_update</code><br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">17</span>]: a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">In [<span class="number">18</span>]: b = &#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">In [<span class="number">19</span>]: a ^ b</span><br><span class="line">Out[<span class="number">19</span>]: &#123;<span class="number">1</span>&#125;</span><br><span class="line">In [<span class="number">20</span>]: a ^= b</span><br><span class="line">In [<span class="number">21</span>]: a</span><br><span class="line">Out[<span class="number">21</span>]: &#123;<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h3><p><code>issubset(other)、&lt;=</code><br>判断当前集合是否是另一个集合的子集<br><code>set1 &lt; set2</code><br>判断set1是否是set2的真子集<br><code>issuperset(other)、&gt;=</code><br>判断当前集合是否是other的超集<br><code>set1 &gt; set2</code><br>判断set1是否是set的真超集<br><code>isdisjoint(other)</code><br>当前集合和另一个集合没有交集<br>没有交集，返回Ture</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">In [<span class="number">2</span>]: b = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">In [<span class="number">3</span>]: b.issuperset(a)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h2 id="set-和线性结构"><a href="#set-和线性结构" class="headerlink" title="set 和线性结构"></a>set 和线性结构</h2><ul>
<li>线性结构的查询时间复杂度是O(n),即随着数据规模的增大而增加耗时</li>
<li>set、dict 等结构，内部使用hash值作为key，时间复杂度可以做O(1)，查询时间和数据规模无关</li>
</ul>
<p>可hash 的数据类型<br>数据型 int、float、complex<br>布尔型 True、False<br>字符串string、bytes<br>tuple<br>None<br> 以上都是不可变类型，成为可哈希类型 ,hashble</p>
<ul>
<li>set 的元素必须是可hash的</li>
</ul>
<h3 id="简单选择排序"><a href="#简单选择排序" class="headerlink" title="简单选择排序"></a>简单选择排序</h3><ul>
<li>属于选择排序</li>
<li>两两比较在大小，找出极值(极大值或极小值)被放置在固定的位置，这个固定位置一般指的是某一端</li>
<li>结果分为升序和降序列</li>
<li><p>降序</p>
<p>   n 个数从左至右，索引从0开始到n-1，两两依次比较，记录大值过引，此轮所有数比较完比，将大数和索引0数效换，如果大数就是索引1，不交换，第二轮，从1开始比较，找到最大值，将它和过引1位置交换，如果它就在过引1 位置则不交换。今次类推，每次左边都会固定下一个大数。</p>
</li>
<li><p>升序</p>
<p>   和降序相反</p>
</li>
</ul>
<p><img src="/images/Selection-Sort.gif" class="lazyload" data-srcset="/images/Selection-Sort.gif" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="简单选择排序代码实现-一"><a href="#简单选择排序代码实现-一" class="headerlink" title="简单选择排序代码实现(一)"></a>简单选择排序代码实现(一)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">nums = m_list[<span class="number">1</span>]</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line">print(nums)</span><br><span class="line"></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    maxindex = i</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i+<span class="number">1</span>,length):</span><br><span class="line">        count_iter +=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[maxindex] &lt; nums[j]:</span><br><span class="line">            maxindex = j</span><br><span class="line">    <span class="keyword">if</span> i != maxindex:</span><br><span class="line">        tmp = nums[i]</span><br><span class="line">        nums[i] = nums[maxindex]</span><br><span class="line">        nums[maxindex] = tmp</span><br><span class="line">        count_swap +=<span class="number">1</span></span><br><span class="line">print(nums,count_swap,count_iter)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line">[<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>] <span class="number">4</span> <span class="number">36</span></span><br></pre></td></tr></table></figure>
<h3 id="简单选择排序代码实现-二-，二元排序法"><a href="#简单选择排序代码实现-二-，二元排序法" class="headerlink" title="简单选择排序代码实现(二)，二元排序法"></a>简单选择排序代码实现(二)，二元排序法</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">m_list = [</span><br><span class="line">    [<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],</span><br><span class="line">    [<span class="number">9</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">nums = m_list[<span class="number">1</span>]</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line">print(nums)</span><br><span class="line"></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line">count_iter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length // <span class="number">2</span>):</span><br><span class="line">    maxindex = i</span><br><span class="line">    minindex = -i <span class="number">-1</span></span><br><span class="line">    minorigin = minindex</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, length -i):</span><br><span class="line">        count_iter += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[maxindex] &lt; nums[j]:</span><br><span class="line">            maxindex = j</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> nums[minindex] &gt; nums[-j <span class="number">-1</span>]:</span><br><span class="line">            minindex = -j <span class="number">-1</span></span><br><span class="line">        print(maxindex,minindex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i != maxindex:</span><br><span class="line">        tmp = nums[i]</span><br><span class="line">        nums[i] = nums[maxindex]</span><br><span class="line">        nums[maxindex] = tmp</span><br><span class="line">        count_swap += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i == minindex <span class="keyword">or</span> i == length + minindex:</span><br><span class="line">            minindex = maxindex</span><br><span class="line">    <span class="keyword">if</span> minorigin != minindex:</span><br><span class="line">        tmp = nums[minorigin]</span><br><span class="line">        nums[minorigin] = nums[minindex]</span><br><span class="line">        nums[minindex] = tmp</span><br><span class="line">        count_swap +=<span class="number">1</span></span><br><span class="line">print(nums, count_swap,count_iter)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="number">1</span> <span class="number">-2</span></span><br><span class="line"><span class="number">2</span> <span class="number">-3</span></span><br><span class="line"><span class="number">3</span> <span class="number">-4</span></span><br><span class="line"><span class="number">4</span> <span class="number">-5</span></span><br><span class="line"><span class="number">5</span> <span class="number">-6</span></span><br><span class="line"><span class="number">6</span> <span class="number">-7</span></span><br><span class="line"><span class="number">7</span> <span class="number">-8</span></span><br><span class="line"><span class="number">8</span> <span class="number">-9</span></span><br><span class="line"><span class="number">2</span> <span class="number">-3</span></span><br><span class="line"><span class="number">3</span> <span class="number">-4</span></span><br><span class="line"><span class="number">4</span> <span class="number">-5</span></span><br><span class="line"><span class="number">5</span> <span class="number">-6</span></span><br><span class="line"><span class="number">6</span> <span class="number">-7</span></span><br><span class="line"><span class="number">7</span> <span class="number">-8</span></span><br><span class="line"><span class="number">3</span> <span class="number">-4</span></span><br><span class="line"><span class="number">4</span> <span class="number">-5</span></span><br><span class="line"><span class="number">5</span> <span class="number">-6</span></span><br><span class="line"><span class="number">6</span> <span class="number">-7</span></span><br><span class="line"><span class="number">4</span> <span class="number">-5</span></span><br><span class="line"><span class="number">5</span> <span class="number">-6</span></span><br><span class="line">[<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>] <span class="number">8</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<h3 id="简单选择排序总结"><a href="#简单选择排序总结" class="headerlink" title="简单选择排序总结"></a>简单选择排序总结</h3><ul>
<li>简单选择排序需要数据一轮轮比较，并在每一轮中发现极值</li>
<li>没有办法知道当前轮是否已经达到排序要求，但是可以知道极值是滞在目标索引位置上</li>
<li>遍历次数1,…,n-1之后n(n-1)/2</li>
<li>时间复杂度O(n2次方)</li>
<li>减少了交换次数，提高了效率，性能略好于冒泡法</li>
</ul>
<h2 id="字典dict"><a href="#字典dict" class="headerlink" title="字典dict"></a>字典dict</h2><p>可变的、无序的 、key 不重复</p>
<h3 id="字典dict定义-初始化"><a href="#字典dict定义-初始化" class="headerlink" title="字典dict定义 初始化"></a>字典dict定义 初始化</h3><ul>
<li>d = dict() 或者 <code>d=&#123;&#125;</code></li>
<li>dict(**kwargs)使用name=value 对初始化一个字典</li>
<li>dcit(iterable,**kwarg) 使用可迭代对象征和name=value对构造字典，不过可迭代对象的元素必须是一个二元结构</li>
<li>d = dict(((1,’a’),(2,’b’))) 或者 d = dict(([1,’a’],[2,’b’]))</li>
<li>dict(mapping, ** kwarg)使用一个字典构建另一个字典<br><code>d = &#123;&#39;a&#39;:10,&#39;b&#39;:20,&#39;c&#39;:None,&#39;d&#39;:[1,2,3]&#125;</code></li>
</ul>
<p>例: 常用的变量赋值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: d = <span class="built_in">dict</span>(a=<span class="number">5</span>,b=<span class="number">6</span>,z=[<span class="number">123</span>])</span><br><span class="line">In [<span class="number">2</span>]: d</span><br><span class="line">Out[<span class="number">2</span>]: &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;z&#x27;</span>: [<span class="number">123</span>]&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">43</span>]: d = <span class="built_in">dict</span>(((<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>),))</span><br><span class="line">In [<span class="number">44</span>]: d</span><br><span class="line">Out[<span class="number">44</span>]: &#123;<span class="number">1</span>: <span class="string">&#x27;a&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">45</span>]: d = <span class="built_in">dict</span>(([<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>],[<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>]))</span><br><span class="line">In [<span class="number">46</span>]: d</span><br><span class="line">Out[<span class="number">46</span>]: &#123;<span class="number">1</span>: <span class="string">&#x27;a&#x27;</span>, <span class="number">2</span>: <span class="string">&#x27;b&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>类方法使用时需要注意</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">47</span>]: d1 = <span class="built_in">dict</span>.fromkeys(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>),[<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="number">48</span>]: d1</span><br><span class="line">Out[<span class="number">48</span>]:</span><br><span class="line">&#123;<span class="number">1</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">2</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">3</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">4</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">5</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">6</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">7</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">8</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">9</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line"> <span class="number">10</span>: [<span class="number">1</span>, <span class="number">2</span>]&#125;</span><br><span class="line">In [<span class="number">49</span>]: d1[<span class="number">10</span>].append(<span class="number">3</span>)</span><br><span class="line">In [<span class="number">50</span>]: d1</span><br><span class="line">Out[<span class="number">50</span>]:</span><br><span class="line">&#123;<span class="number">1</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">2</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">3</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">4</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">5</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">6</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">7</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">8</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">9</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line"> <span class="number">10</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字典元素的访问"><a href="#字典元素的访问" class="headerlink" title="字典元素的访问"></a>字典元素的访问</h3><ul>
<li><p>d[key]<br>返回key对应的值value<br>key 不存在抛出KeyError异常</p>
</li>
<li><p>get(key[,default])<br>返回key对应的值value<br>key不存在返回缺省值，如果没有设置缺省值就返回None</p>
</li>
<li>setdefault(key[,default])<br>返回key对应的值value<br>key不存在，添加kv对，value为default，并返回default,如果default没有设置，缺省为None</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">51</span>]: d2 = <span class="built_in">dict</span>(([(<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>),&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;],))</span><br><span class="line">In [<span class="number">52</span>]: d2</span><br><span class="line">Out[<span class="number">52</span>]: &#123;(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>): &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;&#125;</span><br><span class="line">In [<span class="number">53</span>]: d2[(<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>)]</span><br><span class="line">Out[<span class="number">53</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">54</span>]: f = d2.get((<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>))</span><br><span class="line">In [<span class="number">55</span>]: f</span><br><span class="line">Out[<span class="number">55</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">56</span>]: <span class="built_in">type</span>(f)</span><br><span class="line">Out[<span class="number">56</span>]: <span class="built_in">set</span></span><br><span class="line"><span class="comment">#如果不存在，则返回</span></span><br><span class="line">In [<span class="number">57</span>]: d2.get(<span class="number">1</span>,<span class="number">50</span>)</span><br><span class="line">Out[<span class="number">57</span>]: <span class="number">50</span></span><br><span class="line"><span class="comment"># 如果存在，则返回</span></span><br><span class="line">In [<span class="number">59</span>]: d2.get((<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>),<span class="number">50</span>)</span><br><span class="line">Out[<span class="number">59</span>]: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">60</span>]: f = d2.setdefault(<span class="number">4</span>,<span class="number">400</span>)</span><br><span class="line">In [<span class="number">61</span>]: f</span><br><span class="line">Out[<span class="number">61</span>]: <span class="number">400</span></span><br><span class="line">In [<span class="number">62</span>]: d2</span><br><span class="line">Out[<span class="number">62</span>]: &#123;(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>): &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">4</span>: <span class="number">400</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字典增加和修改"><a href="#字典增加和修改" class="headerlink" title="字典增加和修改"></a>字典增加和修改</h3><ul>
<li>d[key] = value<br>将key对应的值修改为value<br>key 不存在添加新的kv对</li>
<li>update([other]) -&gt; None<br>使用一个字典的kv对更新本字典<br>key不存在，就添加<br>key存在，覆盖已经存在的key对应的值<br>就地修改</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">d.upadte(red=<span class="number">1</span>)</span><br><span class="line">d.update(((<span class="string">&#x27;red&#x27;</span>,<span class="number">2</span>),))</span><br><span class="line">d.update(&#123;<span class="string">&#x27;red&#x27;</span>:<span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> In [<span class="number">63</span>]: d2[<span class="number">100</span>] = <span class="number">100</span></span><br><span class="line">In [<span class="number">64</span>]: d2</span><br><span class="line">Out[<span class="number">64</span>]: &#123;(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>): &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">4</span>: <span class="number">400</span>, <span class="number">100</span>: <span class="number">100</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">67</span>]: d2</span><br><span class="line">Out[<span class="number">67</span>]: &#123;(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>): &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">4</span>: <span class="number">300</span>, <span class="number">100</span>: <span class="number">100</span>&#125;</span><br><span class="line">In [<span class="number">68</span>]: d3 = &#123;<span class="number">100</span>:<span class="number">1000</span>, <span class="number">5</span>:<span class="string">&#x27;abc&#x27;</span>&#125;</span><br><span class="line">In [<span class="number">69</span>]: d3</span><br><span class="line">Out[<span class="number">69</span>]: &#123;<span class="number">100</span>: <span class="number">1000</span>, <span class="number">5</span>: <span class="string">&#x27;abc&#x27;</span>&#125;</span><br><span class="line">In [<span class="number">70</span>]: d2.update(d3,red =<span class="number">1</span>)</span><br><span class="line">In [<span class="number">71</span>]: d2</span><br><span class="line">Out[<span class="number">71</span>]: &#123;(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>): &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">4</span>: <span class="number">300</span>, <span class="number">100</span>: <span class="number">1000</span>, <span class="number">5</span>: <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;red&#x27;</span>: <span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字典删除"><a href="#字典删除" class="headerlink" title="字典删除"></a>字典删除</h3><ul>
<li>pop(key[,default])<br>key 存在，移除它，并返回它的value<br>key 不存在，返回给定的default<br>default未设置，key不存在则抛出KeyError异常</li>
<li><p>popitem()<br>移除并返回一个任意的键值对<br>字典为empty,抛出KeyError异常</p>
</li>
<li><p>clear()<br>清空字典</p>
</li>
</ul>
<h2 id="字典删除-1"><a href="#字典删除-1" class="headerlink" title="字典删除"></a>字典删除</h2><p>del语句</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">72</span>]: a = <span class="literal">True</span></span><br><span class="line">In [<span class="number">73</span>]: b = [<span class="number">6</span>]</span><br><span class="line">In [<span class="number">76</span>]: d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>:b,<span class="string">&#x27;c&#x27;</span>:[<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>]&#125;</span><br><span class="line">In [<span class="number">77</span>]: <span class="keyword">del</span> a</span><br><span class="line">In [<span class="number">78</span>]: a</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">NameError                                 Traceback (most recent call last)</span><br><span class="line">&lt;ipython-<span class="built_in">input</span><span class="number">-78</span><span class="number">-3</span>f786850e387&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 a</span><br><span class="line">NameError: name <span class="string">&#x27;a&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line">In [<span class="number">79</span>]: <span class="keyword">del</span> d[<span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">In [<span class="number">80</span>]: d</span><br><span class="line">Out[<span class="number">80</span>]: &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: [<span class="number">6</span>]&#125;</span><br><span class="line">In [<span class="number">81</span>]: <span class="keyword">del</span> b</span><br><span class="line">In [<span class="number">82</span>]: d</span><br><span class="line">Out[<span class="number">82</span>]: &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: [<span class="number">6</span>]&#125;</span><br><span class="line">In [<span class="number">84</span>]: <span class="keyword">del</span> d[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">In [<span class="number">85</span>]: d</span><br><span class="line">Out[<span class="number">85</span>]: &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line"><span class="comment"># del d[&#x27;b&#x27;] 看着像删除了一个对象，本质上减少了一个对象引用，del实际上删除的是名称，而不是对象</span></span><br></pre></td></tr></table></figure>
<h3 id="字典遍历"><a href="#字典遍历" class="headerlink" title="字典遍历"></a>字典遍历</h3><p>默认打印的是keys</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">86</span>]: d2</span><br><span class="line">Out[<span class="number">86</span>]: &#123;(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>): &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">4</span>: <span class="number">300</span>, <span class="number">100</span>: <span class="number">1000</span>, <span class="number">5</span>: <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;red&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line">In [<span class="number">87</span>]: <span class="keyword">for</span> item <span class="keyword">in</span> d2:</span><br><span class="line">    ...:     print(item)</span><br><span class="line">    ...:</span><br><span class="line">(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">red</span><br></pre></td></tr></table></figure>
<p>打印value 和key</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">89</span>]: <span class="keyword">for</span> item <span class="keyword">in</span> d2.values():</span><br><span class="line">    ...:     print(item)</span><br><span class="line">    ...:</span><br><span class="line">&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line"><span class="number">300</span></span><br><span class="line"><span class="number">1000</span></span><br><span class="line">abc</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">90</span>]: <span class="keyword">for</span> item <span class="keyword">in</span> d2.keys():</span><br><span class="line">    ...:     print(item)</span><br><span class="line">    ...:</span><br><span class="line">(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">red</span><br></pre></td></tr></table></figure>
<h3 id="字典解构"><a href="#字典解构" class="headerlink" title="字典解构"></a>字典解构</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">92</span>]: <span class="keyword">for</span> k,b <span class="keyword">in</span> d2.items():</span><br><span class="line">    ...:     print(k,b)</span><br><span class="line">    ...:</span><br><span class="line">(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>) &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line"><span class="number">4</span> <span class="number">300</span></span><br><span class="line"><span class="number">100</span> <span class="number">1000</span></span><br><span class="line"><span class="number">5</span> abc</span><br><span class="line">red <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#只取key的情况</span></span><br><span class="line">In [<span class="number">91</span>]: <span class="keyword">for</span> k,_ <span class="keyword">in</span> d2.items():</span><br><span class="line">    ...:     print(k)</span><br><span class="line">    ...:</span><br><span class="line">(<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">red</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Python3 中 ,keys、values、 items()方法返回一个类似一个生器的可迭代对象，不会把函数的反回结果复制到内存中</li>
<li>Python2 中，上面的方法会返回一个新的列表，占据新的内存空间，所以Python2 建议使用iterkeys、itervalues版本，返回一个迭代器，而不是一个copy</li>
</ul>
<h2 id="标准库datetime"><a href="#标准库datetime" class="headerlink" title="标准库datetime"></a>标准库datetime</h2><ul>
<li><p>datetime模块<br>对日期、时间 、时间戳的处理</p>
</li>
<li><p>datetime类<br>类方法<br>today() 返回本地时区当前时间的datetime对象<br>now(tz=None)返回当前时间的datetime对象，时间到微秒，如果tz为None,返回和today()一样<br>utcnow() 没有时区的当前时间<br>fromtimestamp(timestamp,tz=None)从一个时间戳返回一个datetime对象</p>
</li>
<li>datetime对象<br>timestamp()返回一个到微秒的时间戳<br>时间戳:格林威治时间1970年1月1日0点到现在秒数</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">2</span>]: datetime.datetime.now()</span><br><span class="line">Out[<span class="number">2</span>]: datetime.datetime(<span class="number">2020</span>, <span class="number">7</span>, <span class="number">30</span>, <span class="number">21</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">140745</span>)</span><br><span class="line">In [<span class="number">3</span>]: datetime.datetime.now().timestamp()</span><br><span class="line">Out[<span class="number">3</span>]: <span class="number">1596114189.706269</span></span><br></pre></td></tr></table></figure>
<h3 id="标准库datetime-1"><a href="#标准库datetime-1" class="headerlink" title="标准库datetime"></a>标准库datetime</h3><p>构造方法 datetime.datetime(2016,12,6,16,29,43,79043)<br>year、 month、 day、hour、minute、 second、 microsecond，取datetime对象的年月日时分秒及微秒<br>weekday() 返回星期的天，周一0，周日6<br>isoweekday()返回星期的天,周一1，周日7<br>date()返回日期date对象<br>time()返回时间time对象<br>repliace()修改并返回新的时间<br>isocalendar()返回一个三元组(年，周数，周的天)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">2</span>]: datetime.datetime.now()</span><br><span class="line">Out[<span class="number">2</span>]: datetime.datetime(<span class="number">2020</span>, <span class="number">7</span>, <span class="number">30</span>, <span class="number">21</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">140745</span>)</span><br><span class="line">In [<span class="number">3</span>]: datetime.datetime.now().timestamp()</span><br><span class="line">Out[<span class="number">3</span>]: <span class="number">1596114189.706269</span></span><br><span class="line">In [<span class="number">4</span>]: a = datetime.datetime.now()</span><br><span class="line">In [<span class="number">5</span>]: a</span><br><span class="line">Out[<span class="number">5</span>]: datetime.datetime(<span class="number">2020</span>, <span class="number">7</span>, <span class="number">30</span>, <span class="number">21</span>, <span class="number">14</span>, <span class="number">47</span>, <span class="number">500215</span>)</span><br><span class="line">In [<span class="number">6</span>]: a.weekday()</span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h3 id="标准库datetime-2"><a href="#标准库datetime-2" class="headerlink" title="标准库datetime"></a>标准库datetime</h3><ul>
<li>日期格式化<br>类方法strptime(date_string,format),返回datetime对象<br>对象方法strftime(format),返回字符串<br>字符串format函数格式化</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">16</span>]: dt = datetime.datetime.now()</span><br><span class="line">In [<span class="number">17</span>]: dt = dt.strftime(<span class="string">&#x27;%Y-%m-%d-%H-%M-%S&#x27;</span>)</span><br><span class="line">In [<span class="number">18</span>]: dt</span><br><span class="line">Out[<span class="number">18</span>]: <span class="string">&#x27;2020-07-30-21-21-39&#x27;</span></span><br></pre></td></tr></table></figure>
<p> 利用format 格式化</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">26</span>]: a = datetime.datetime.now()</span><br><span class="line">In [<span class="number">27</span>]: <span class="string">&#x27;&#123;&#125;-&#123;&#125;-&#123;&#125;-&#123;&#125;-&#123;&#125;-&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(a.year,a.month,a.day,a.hour,a.minute,a.second)</span><br><span class="line">Out[<span class="number">27</span>]: <span class="string">&#x27;2020-7-30-21-27-33&#x27;</span></span><br></pre></td></tr></table></figure>
<p>标准库datetime</p>
<ul>
<li><p>timedelta对象<br>datetime2 = datetime1 + timedelta<br>datetime2 = datetime1 - timedelta<br>timedelta = datetime1 - datetime2</p>
</li>
<li><p>构造方法</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">datetime.timedelta(days=<span class="number">0</span>,seconds=<span class="number">0</span>,microseconds=<span class="number">0</span>,milliseconds=<span class="number">0</span>,minutes=<span class="number">0</span>,hours=<span class="number">0</span>,weeks=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>year  = datetime.timedelta(days=365)<br>total_seconds()返回时间差的总秒数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">36</span>]: h</span><br><span class="line">Out[<span class="number">36</span>]: datetime.timedelta(days=<span class="number">1</span>)</span><br><span class="line">In [<span class="number">37</span>]: h = datetime.timedelta(hours=<span class="number">24</span>)</span><br><span class="line">In [<span class="number">38</span>]: h</span><br><span class="line">Out[<span class="number">38</span>]: datetime.timedelta(days=<span class="number">1</span>)</span><br><span class="line">In [<span class="number">39</span>]: datetime.datetime.now() - h</span><br><span class="line">Out[<span class="number">39</span>]: datetime.datetime(<span class="number">2020</span>, <span class="number">7</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">37</span>, <span class="number">6</span>, <span class="number">827493</span>)</span><br></pre></td></tr></table></figure>
<h2 id="标准库time"><a href="#标准库time" class="headerlink" title="标准库time"></a>标准库time</h2><p>将调用的线程挂起指定的秒数 ~<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">40</span>]: <span class="keyword">import</span> time</span><br><span class="line">In [<span class="number">41</span>]: time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="列表解析List"><a href="#列表解析List" class="headerlink" title="列表解析List"></a>列表解析List</h3><ul>
<li><p>语法<br>[返回值for 元素 in 可迭代对象 if 条件]<br>使用中括号[]，内部是for循环，if条件语句可选<br>返回一个新的列表</p>
</li>
<li><p>列表解析式是一种语法糖<br>编译器会优化，不会为简写而影响效率，反而因优化提交了效率;<br>减少程序员工作量，减少出错;<br>简化了代码，但可读性增强</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">9</span>]: newlist1 = [(i+<span class="number">1</span>)**<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">In [<span class="number">10</span>]: newlist1</span><br><span class="line">Out[<span class="number">10</span>]: [<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<p>举例1、获取10以内的偶数，比较执行效率</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">even = []</span><br><span class="line">In [<span class="number">11</span>]: even = []</span><br><span class="line">In [<span class="number">12</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    ...:     <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">    ...:         even.append(x)</span><br><span class="line">In [<span class="number">13</span>]: even</span><br><span class="line">Out[<span class="number">13</span>]: [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]</span><br><span class="line">In [<span class="number">15</span>]: even = [ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>) <span class="keyword">if</span> x%<span class="number">2</span> ==<span class="number">0</span>]</span><br><span class="line">In [<span class="number">16</span>]: even</span><br><span class="line">Out[<span class="number">16</span>]: [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]</span><br></pre></td></tr></table></figure>
<p>举例三种输出结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">19</span>]: list1 = [(i,j)<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>) <span class="keyword">if</span> i&gt;<span class="number">4</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">25</span>) <span class="keyword">if</span> j&gt;<span class="number">23</span>]</span><br><span class="line">In [<span class="number">20</span>]: list1</span><br><span class="line">Out[<span class="number">20</span>]: [(<span class="number">5</span>, <span class="number">24</span>), (<span class="number">6</span>, <span class="number">24</span>)]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">23</span>]: list2 = [(i,j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">25</span>) <span class="keyword">if</span> i&gt;<span class="number">4</span> <span class="keyword">if</span> j&gt;<span class="number">23</span>]</span><br><span class="line">In [<span class="number">24</span>]: list2</span><br><span class="line">Out[<span class="number">24</span>]: [(<span class="number">5</span>, <span class="number">24</span>), (<span class="number">6</span>, <span class="number">24</span>)]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">28</span>]: list3 = [(i,j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">25</span>) <span class="keyword">if</span> i&gt;<span class="number">4</span> <span class="keyword">and</span> j&gt;<span class="number">23</span>]</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">29</span>]: list3</span><br><span class="line">Out[<span class="number">29</span>]: [(<span class="number">5</span>, <span class="number">24</span>), (<span class="number">6</span>, <span class="number">24</span>)]</span><br></pre></td></tr></table></figure>
<p>练习，生成1-10 平方的列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print([i**<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>)])</span><br><span class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure>
<p>练习，有一个列表lst = [1,4,9,16,2,5,10,15],生成一个新列表，要求新列表元素是lst想领2项的和</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">34</span>]: lst = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">9</span>,<span class="number">16</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">10</span>,<span class="number">15</span>]</span><br><span class="line">In [<span class="number">35</span>]: [ lst[i] + lst[i+<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lst)<span class="number">-1</span>)]</span><br><span class="line">Out[<span class="number">35</span>]: [<span class="number">5</span>, <span class="number">13</span>, <span class="number">25</span>, <span class="number">18</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">25</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [44]: lst &#x3D; [1,4,9,16,2,5,10,15]</span><br><span class="line">In [45]: for i in range(len(lst)-1):</span><br><span class="line">    ...:     newlist&#x3D; lst[i] + lst[i+1]</span><br><span class="line">    ...:     print(newlist)</span><br><span class="line">    ...:</span><br><span class="line">5</span><br><span class="line">13</span><br><span class="line">25</span><br><span class="line">18</span><br><span class="line">7</span><br><span class="line">15</span><br><span class="line">25</span><br></pre></td></tr></table></figure>
<p>用一行代码打印9 9乘法表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">56</span>]: print(<span class="string">&#x27;\n&#x27;</span>.join([<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;&#125;*&#123;&#125;=&#123;&#125;\t&#x27;</span>.<span class="built_in">format</span>(x,y,y*x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,y+<span class="number">1</span>)]) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>)]))</span><br><span class="line"><span class="number">1</span>*<span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">1</span>*<span class="number">2</span>=<span class="number">2</span>	<span class="number">2</span>*<span class="number">2</span>=<span class="number">4</span></span><br><span class="line"><span class="number">1</span>*<span class="number">3</span>=<span class="number">3</span>	<span class="number">2</span>*<span class="number">3</span>=<span class="number">6</span>	<span class="number">3</span>*<span class="number">3</span>=<span class="number">9</span></span><br><span class="line"><span class="number">1</span>*<span class="number">4</span>=<span class="number">4</span>	<span class="number">2</span>*<span class="number">4</span>=<span class="number">8</span>	<span class="number">3</span>*<span class="number">4</span>=<span class="number">12</span>	<span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span></span><br><span class="line"><span class="number">1</span>*<span class="number">5</span>=<span class="number">5</span>	<span class="number">2</span>*<span class="number">5</span>=<span class="number">10</span>	<span class="number">3</span>*<span class="number">5</span>=<span class="number">15</span>	<span class="number">4</span>*<span class="number">5</span>=<span class="number">20</span>	<span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span></span><br><span class="line"><span class="number">1</span>*<span class="number">6</span>=<span class="number">6</span>	<span class="number">2</span>*<span class="number">6</span>=<span class="number">12</span>	<span class="number">3</span>*<span class="number">6</span>=<span class="number">18</span>	<span class="number">4</span>*<span class="number">6</span>=<span class="number">24</span>	<span class="number">5</span>*<span class="number">6</span>=<span class="number">30</span>	<span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span></span><br><span class="line"><span class="number">1</span>*<span class="number">7</span>=<span class="number">7</span>	<span class="number">2</span>*<span class="number">7</span>=<span class="number">14</span>	<span class="number">3</span>*<span class="number">7</span>=<span class="number">21</span>	<span class="number">4</span>*<span class="number">7</span>=<span class="number">28</span>	<span class="number">5</span>*<span class="number">7</span>=<span class="number">35</span>	<span class="number">6</span>*<span class="number">7</span>=<span class="number">42</span>	<span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span></span><br><span class="line"><span class="number">1</span>*<span class="number">8</span>=<span class="number">8</span>	<span class="number">2</span>*<span class="number">8</span>=<span class="number">16</span>	<span class="number">3</span>*<span class="number">8</span>=<span class="number">24</span>	<span class="number">4</span>*<span class="number">8</span>=<span class="number">32</span>	<span class="number">5</span>*<span class="number">8</span>=<span class="number">40</span>	<span class="number">6</span>*<span class="number">8</span>=<span class="number">48</span>	<span class="number">7</span>*<span class="number">8</span>=<span class="number">56</span>	<span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span></span><br><span class="line"><span class="number">1</span>*<span class="number">9</span>=<span class="number">9</span>	<span class="number">2</span>*<span class="number">9</span>=<span class="number">18</span>	<span class="number">3</span>*<span class="number">9</span>=<span class="number">27</span>	<span class="number">4</span>*<span class="number">9</span>=<span class="number">36</span>	<span class="number">5</span>*<span class="number">9</span>=<span class="number">45</span>	<span class="number">6</span>*<span class="number">9</span>=<span class="number">54</span>	<span class="number">7</span>*<span class="number">9</span>=<span class="number">63</span>	<span class="number">8</span>*<span class="number">9</span>=<span class="number">72</span>	<span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span></span><br></pre></td></tr></table></figure>
<p>高效方法二 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">86</span>]: print(<span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;&#125;*&#123;&#125;=&#123;:&lt;3&#125;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(j,i,i*j,<span class="string">&#x27;\n&#x27;</span> <span class="keyword">if</span> i==j <span class="keyword">else</span><span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,i+<span class="number">1</span>)]))</span><br><span class="line"><span class="number">1</span>*<span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">1</span>*<span class="number">2</span>=<span class="number">2</span>  <span class="number">2</span>*<span class="number">2</span>=<span class="number">4</span></span><br><span class="line"><span class="number">1</span>*<span class="number">3</span>=<span class="number">3</span>  <span class="number">2</span>*<span class="number">3</span>=<span class="number">6</span>  <span class="number">3</span>*<span class="number">3</span>=<span class="number">9</span></span><br><span class="line"><span class="number">1</span>*<span class="number">4</span>=<span class="number">4</span>  <span class="number">2</span>*<span class="number">4</span>=<span class="number">8</span>  <span class="number">3</span>*<span class="number">4</span>=<span class="number">12</span> <span class="number">4</span>*<span class="number">4</span>=<span class="number">16</span></span><br><span class="line"><span class="number">1</span>*<span class="number">5</span>=<span class="number">5</span>  <span class="number">2</span>*<span class="number">5</span>=<span class="number">10</span> <span class="number">3</span>*<span class="number">5</span>=<span class="number">15</span> <span class="number">4</span>*<span class="number">5</span>=<span class="number">20</span> <span class="number">5</span>*<span class="number">5</span>=<span class="number">25</span></span><br><span class="line"><span class="number">1</span>*<span class="number">6</span>=<span class="number">6</span>  <span class="number">2</span>*<span class="number">6</span>=<span class="number">12</span> <span class="number">3</span>*<span class="number">6</span>=<span class="number">18</span> <span class="number">4</span>*<span class="number">6</span>=<span class="number">24</span> <span class="number">5</span>*<span class="number">6</span>=<span class="number">30</span> <span class="number">6</span>*<span class="number">6</span>=<span class="number">36</span></span><br><span class="line"><span class="number">1</span>*<span class="number">7</span>=<span class="number">7</span>  <span class="number">2</span>*<span class="number">7</span>=<span class="number">14</span> <span class="number">3</span>*<span class="number">7</span>=<span class="number">21</span> <span class="number">4</span>*<span class="number">7</span>=<span class="number">28</span> <span class="number">5</span>*<span class="number">7</span>=<span class="number">35</span> <span class="number">6</span>*<span class="number">7</span>=<span class="number">42</span> <span class="number">7</span>*<span class="number">7</span>=<span class="number">49</span></span><br><span class="line"><span class="number">1</span>*<span class="number">8</span>=<span class="number">8</span>  <span class="number">2</span>*<span class="number">8</span>=<span class="number">16</span> <span class="number">3</span>*<span class="number">8</span>=<span class="number">24</span> <span class="number">4</span>*<span class="number">8</span>=<span class="number">32</span> <span class="number">5</span>*<span class="number">8</span>=<span class="number">40</span> <span class="number">6</span>*<span class="number">8</span>=<span class="number">48</span> <span class="number">7</span>*<span class="number">8</span>=<span class="number">56</span> <span class="number">8</span>*<span class="number">8</span>=<span class="number">64</span></span><br><span class="line"><span class="number">1</span>*<span class="number">9</span>=<span class="number">9</span>  <span class="number">2</span>*<span class="number">9</span>=<span class="number">18</span> <span class="number">3</span>*<span class="number">9</span>=<span class="number">27</span> <span class="number">4</span>*<span class="number">9</span>=<span class="number">36</span> <span class="number">5</span>*<span class="number">9</span>=<span class="number">45</span> <span class="number">6</span>*<span class="number">9</span>=<span class="number">54</span> <span class="number">7</span>*<span class="number">9</span>=<span class="number">63</span> <span class="number">8</span>*<span class="number">9</span>=<span class="number">72</span> <span class="number">9</span>*<span class="number">9</span>=<span class="number">81</span></span><br></pre></td></tr></table></figure>
<p>练习</p>
<p>“0001.abadicddws” 是ID格式，要求ID格式是以点号分割， 左夯实是4位从1开始的整数，右边是10位随机小写英文字母。今次生成前100个列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">100</span>]: [<span class="string">&#x27;&#123;:04&#125;.&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(n,<span class="string">&#x27;&#x27;</span>.join([random.choice(<span class="built_in">bytes</span>(<span class="built_in">range</span>(<span class="number">97</span>,<span class="number">123</span>)).decode()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)])) <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>)]</span><br><span class="line">Out[<span class="number">100</span>]:</span><br><span class="line">[<span class="string">&#x27;0001.yibbcfebfn&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;0002.wvomuwuiaj&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;0003.bplvnhkgfp&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;0004.tnrjwiuipv&#x27;</span>,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="生成器表达式-Generator-expression"><a href="#生成器表达式-Generator-expression" class="headerlink" title="生成器表达式(Generator expression)"></a>生成器表达式(Generator expression)</h2><ul>
<li>语法<br>(返回值for 元素 in 可迭代对象if条件)<br>列表解析式的中括号抱成小括号就行了<br>返回一个生成器</li>
<li>和列表解析式的区别<br>生成器表达式是按<strong>按需计算(或称惰性求值、延迟计算)</strong>，需要的时候才计算值<br>列表解析式是立即返回值</li>
<li>生成器<br>  可迭代对象<br>  迭代器</li>
</ul>
<h2 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h2><ul>
<li><p>和列表解析式的对比<br>计算方式<br>生成器表达式延迟计算，列表解析式立即计算</p>
</li>
<li><p>内存占用<br>单从返回值本身来说，生成器表达式省内存，列表解析式返回新的列表<br>生成器没有数据，内存占用少，但是使用的时候，虽然一个个返回数据，但是合起来占用的内存也差不多<br>列表解析式构造新的列表需要占用内存</p>
</li>
<li><p>计算速度<br>单看计算时间看，生成器表达式耗时非常短，列表解析式耗时长<br>但是生成器本身并没有返回任何值，只返回了一个生成器对象<br>列表解析式构造并返回了一个新的列表</p>
</li>
</ul>
<h2 id="集合解析式"><a href="#集合解析式" class="headerlink" title="集合解析式"></a>集合解析式</h2><ul>
<li><p>语法<br>(返回值  for 元素 in 可迭代对象 if 条件)<br>列表解析式的中括号换成大括号<code>&#123;&#125;</code>就行了<br>立即返回一个集合</p>
</li>
<li><p>用法</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;(x,x+<span class="number">1</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;&#123;x&#125; <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br></pre></td></tr></table></figure>
<h2 id="字典解析式"><a href="#字典解析式" class="headerlink" title="字典解析式"></a>字典解析式</h2><ul>
<li><p>语法<br>(返回值 for 元素in可迭代对象if条件)<br>列表解析式的中括号换成大括号{}就可行了<br>使用key:value 形势<br>立即返回一个字典</p>
</li>
<li><p>用法</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;x:(x,x+<span class="number">1</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;x:[x,x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;(x,):[x,x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;[x]:[x,x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;<span class="built_in">chr</span>(<span class="number">0x41</span>+<span class="number">1</span>):x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)&#125;</span><br><span class="line">&#123;<span class="built_in">str</span>(x):y <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">3</span>]: &#123;<span class="built_in">chr</span>(<span class="number">0x41</span>+x):x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)&#125;</span><br><span class="line">Out[<span class="number">3</span>]: &#123;<span class="string">&#x27;A&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;B&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;C&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;D&#x27;</span>: <span class="number">9</span>, <span class="string">&#x27;E&#x27;</span>: <span class="number">16</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: &#123;<span class="built_in">str</span>(x):y <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)&#125;</span><br><span class="line">Out[<span class="number">4</span>]: &#123;<span class="string">&#x27;0&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;1&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;2&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">In [<span class="number">13</span>]: ret = &#123;&#125;</span><br><span class="line">In [<span class="number">14</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    ...:     <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    ...:         ret[<span class="built_in">str</span>(x)] = y</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">15</span>]: print(ret)</span><br><span class="line">&#123;<span class="string">&#x27;0&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;1&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;2&#x27;</span>: <span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ul>
<li>Python2 引入了列表解析式</li>
<li>Python2.4引入了生成器表达式</li>
<li>Python3 引入集合、字典解析式，并迁移到了2.7</li>
<li>一般来说，应该多应用解析式，简短、高效</li>
<li>如果一个解析式非常复杂，难以读懂，要考虑拆解成for循环</li>
<li>生成器和迭代器是不同的对象，但都是可迭代对象。</li>
</ul>
<h2 id="内建函数"><a href="#内建函数" class="headerlink" title="内建函数"></a>内建函数</h2><ul>
<li><p>标识 id<br>返回对象的唯一标识，CPython 返回内存中</p>
</li>
<li><p>类型hash()</p>
</li>
</ul>
<p>返回一个对象的哈希值</p>
<ul>
<li>类型type()</li>
</ul>
<p>返回对象的类型 </p>
<ul>
<li>类型转换</li>
</ul>
<p><code>float()</code> <code>int()</code> <code>bin()</code> <code>hex()</code> <code>oct()</code> <code>bool()</code> <code>list()</code> <code>tuple()</code> <code>dict()</code> <code>set()</code> <code>complex()</code> <code>bytes() bytearray()</code> </p>
<ul>
<li>输入input([prompt])</li>
</ul>
<p>接收用户输入，返回一个字符串</p>
<ul>
<li>打印 print(*objects, sep=’’,end=’\n’,file=sys.stdout, flush=False)</li>
</ul>
<p>打印输出，默认使用空格分割、换行结尾，输出到控制台</p>
<ul>
<li>对象长度len(s)</li>
</ul>
<p>返回一个集合类型的元素个数</p>
<ul>
<li>isinstance(obj,class_or_tuple)</li>
</ul>
<p>判断对象obj是否属于某种类型或者元组中列出的某个类型<br>isinstance(True,init)</p>
<ul>
<li>issubclass(cls,calss_or_tuple)</li>
</ul>
<p>判断类型cls是否是某种类型的了类或元组中列出的某个类型的子类<br>issubclass(bool,int)</p>
<ul>
<li>绝对值abs(x) x 为数值</li>
<li>最大值max() 最小值min()<br>  返回可迭代对象中最大或最小值<br>  返回多个参数中最大或最小值</li>
<li>round(x) 四舍六入五取偶, round(-0.5)</li>
<li>pow(x,y) 等价于x**y</li>
<li><p>range(stop)从0开始到stop-1 的可迭代对象； range(start,stop,[,step]) 从start开始到stop-1 结束步长为step 的可迭代对象</p>
</li>
<li><p>divmod(x,y) 等价于tuple(x//y,x%y)</p>
</li>
<li>sum(oterable[,start])对可迭代对象的所有数值元素求和<br>sum(range(1,100,2))</li>
</ul>
<h3 id="补充列表全部拷贝"><a href="#补充列表全部拷贝" class="headerlink" title="补充列表全部拷贝"></a>补充列表全部拷贝</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">17</span>]: lst = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">In [<span class="number">18</span>]: test = lst[:]</span><br><span class="line">In [<span class="number">19</span>]: test</span><br><span class="line">Out[<span class="number">19</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>python 求一到100的和</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">20</span>]: <span class="built_in">sum</span>(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>))</span><br><span class="line">Out[<span class="number">20</span>]: <span class="number">5050</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>chr(i) 给一个一定范围的整数返回对应的字符<br>chr(97) chr(20013)</p>
</li>
<li><p>ord(c) 返回字符对应的整数</p>
</li>
</ul>
<p>ord(‘a’) ord(‘中’)</p>
<ul>
<li><p>str() 、 repr()、 ascii() </p>
</li>
<li><p>sorted(iterable)</p>
</li>
<li><p>sorted(iterable[,key][,reverse])排序<br>返回一个新的列表，默认升序<br>reverse 是反转</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sorted</span>([<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>])</span><br><span class="line"><span class="built_in">sorted</span>([<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">sorted</span>(&#123;<span class="string">&#x27;c&#x27;</span>:<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">2</span>, <span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">5</span>]: lst = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">8</span>,<span class="number">7</span>]</span><br><span class="line">In [<span class="number">6</span>]: <span class="built_in">sorted</span>(lst)</span><br><span class="line">Out[<span class="number">6</span>]: [<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line">In [<span class="number">7</span>]: <span class="built_in">sorted</span>(lst,reverse=<span class="literal">True</span>)</span><br><span class="line">Out[<span class="number">7</span>]: [<span class="number">8</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>翻转 reversed(seq)<br>返回一个翻转元素的迭代器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">reversed</span>(*<span class="number">13579</span>*))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">reversed</span>([<span class="string">&quot;c&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>]: )</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">13</span>]: <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">range</span>(<span class="number">5</span>)):</span><br><span class="line">    ...:     print(k,v,end=<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> <span class="number">0</span>	<span class="number">1</span> <span class="number">1</span>	<span class="number">2</span> <span class="number">2</span>	<span class="number">3</span> <span class="number">3</span>	<span class="number">4</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">14</span>]: <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="string">&quot;mnopq&quot;</span>,start=<span class="number">10</span>):</span><br><span class="line">    ...:     print(k,v,end=<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">10</span> m	<span class="number">11</span> n	<span class="number">12</span> o	<span class="number">13</span> p	<span class="number">14</span> q</span><br></pre></td></tr></table></figure>
<ul>
<li>迭代器和取元素iter(terable)、next(iterator)<br>iter 将一个可迭代对象封装成一个迭代器<br>next对一个迭代器取下一个元素。如果全部元素都取过了，再次next会抛StopIteration异常</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">it = <span class="built_in">iter</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">nex(it)</span><br><span class="line">it = <span class="built_in">reversed</span>([<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>])</span><br><span class="line"><span class="built_in">next</span>(it)</span><br></pre></td></tr></table></figure>
<p>可迭代对象<br>能够通过迭代一次次返回不同的元素的对象。所谓相同不是指值是否相同。而元素在容器中是否是同一个，例如列表中值可以重复。<br>可以迭代，但是未必有序，未必可索引。<br>可迭代对象有: list、tuple、string、bytes、bytearray、range、set、dict、生成器等；<br>可以使用成员操作符in 、 not in，in本质上就是在遍历对象；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">3</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)</span><br><span class="line"><span class="number">3</span> <span class="keyword">in</span> (x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line"><span class="number">3</span> <span class="keyword">in</span> &#123;x:y <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">4</span>),<span class="built_in">range</span>(<span class="number">4</span>,<span class="number">10</span>))&#125;</span><br></pre></td></tr></table></figure>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>特殊的对象，一定是可迭代对象，具备可迭代对象的特征;<br>通过iter方法把一个可迭代对象封闭成迭代器;<br>通过next 方法, 迭代 迭代器对象；<br>生成器对象，就是迭代器对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">iter</span>(<span class="built_in">range</span>(<span class="number">10</span>)):</span><br><span class="line">   ...:     print(x)</span><br><span class="line">In [<span class="number">3</span>]: g = (x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">In [<span class="number">4</span>]: print(<span class="built_in">type</span>(g))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">generator</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">In</span> [5]:</span> print(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="number">0</span></span><br><span class="line">In [<span class="number">6</span>]: print(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">In [<span class="number">7</span>]: print(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="number">2</span></span><br><span class="line">In [<span class="number">8</span>]: print(<span class="built_in">next</span>(g))</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<ul>
<li>拉链函数zip(*iterables)</li>
</ul>
<p>像拉链一样，把多个可迭代对象合并在一起，返回一个迭代器<br>将每次从不同对象中取到的元素合并成一个元组</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">5</span>),<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line"><span class="built_in">dict</span>(<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line">&#123;<span class="built_in">str</span>(x):y <span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">10</span>),<span class="built_in">range</span>(<span class="number">10</span>))&#125;</span><br></pre></td></tr></table></figure>
<h2 id="字典练习"><a href="#字典练习" class="headerlink" title="字典练习"></a>字典练习</h2><p>打印每一位数字及期重复的次数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    num = <span class="built_in">input</span>(<span class="string">&#x27;Please input a positice intteger &gt;&gt;&#x27;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> num.isdigit():</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;Only digits are allowed! &#x27;</span>)</span><br><span class="line">record = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> num:</span><br><span class="line">    record[i] = record.get(i,<span class="number">0</span>) +<span class="number">1</span></span><br><span class="line">print(num,record,sep=<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">num = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> num:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> d.get(c):</span><br><span class="line">        d[c] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    d[c] +=<span class="number">1</span></span><br><span class="line">print(d)</span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> num:</span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> d.keys():</span><br><span class="line">        d[c] =<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        d[c] += <span class="number">1</span></span><br><span class="line">print(d)</span><br><span class="line">&gt;&gt; <span class="number">18933</span></span><br><span class="line">&#123;<span class="string">&#x27;1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;8&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;9&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;3&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;8&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;9&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;3&#x27;</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>
<p>字符串重复统计</p>
<p>字符表’abcdefghijklmnopqrstuvwxyz’<br>随机挑选2个字母组成字符串，共挑选100个<br>降序输出这100个字符串及重复的次数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">strs = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">dic = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    randstr = <span class="string">&#x27;&#x27;</span>.join(random.sample(strs,<span class="number">2</span>))</span><br><span class="line">    <span class="comment"># randstr = &#x27;&#x27;.join(random.choice(strs) for _ in range(0,2))</span></span><br><span class="line">    <span class="comment"># randstr = &#x27;&#x27;.join(random.sample(string.ascii_lowercase,2))</span></span><br><span class="line">    <span class="keyword">if</span> randstr <span class="keyword">not</span> <span class="keyword">in</span> dic:</span><br><span class="line">        dic.setdefault(randstr,<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dic[randstr] +=<span class="number">1</span></span><br><span class="line">sortstr = <span class="built_in">sorted</span>(dic.keys())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sortstr:</span><br><span class="line">    print(<span class="string">&#x27;&#123;:&lt;4&#125; &#123;:&lt;4&#125;&#x27;</span>.<span class="built_in">format</span>(i,dic[i]))</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>双网卡team 绑定实践记录</title>
    <url>/2020/06/17/team%20%E7%BB%91%E5%AE%9A/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="双网卡team-绑定"><a href="#双网卡team-绑定" class="headerlink" title="双网卡team 绑定"></a>双网卡team 绑定</h2><p><img src="/images/linux-bond.png" class="lazyload" data-srcset="/images/linux-bond.png" srcset="data:image/png;base64,666" alt=""></p>
<p>很多时候，由于生产环境业务的特殊需求，我们需要对服务器的物理网卡实施特殊的配置，从而来满足不同业务场景下对服务器网络的特殊性要求。如高并发的网络IO型业务，需要高速的网络IO，即对网卡的收收发包处理能力及网卡最大带宽速度等性能指标提出了更高的要求；事务处理型的系统，如金融交易系统、电商平台等，对物理网络线路、网卡等物理设备的稳定可靠性提出了更高的要求。<br>Linux系统中，可以通过多网卡绑定（bonding）和网络组（team）等技术，通过软件的方式来实现，来满足不同业务场景下的各种特殊需求。</p>
<h2 id="用于kvm虚拟化环境的team绑定实例"><a href="#用于kvm虚拟化环境的team绑定实例" class="headerlink" title="用于kvm虚拟化环境的team绑定实例"></a>用于kvm虚拟化环境的team绑定实例</h2><h3 id="配置team1"><a href="#配置team1" class="headerlink" title="配置team1"></a>配置team1</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-team1</span></span><br><span class="line">DEVICE=team1</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">NAME=team1</span><br><span class="line">ONBOOT=yes</span><br><span class="line">DEVICETYPE=Team</span><br><span class="line">BRIDGE=<span class="string">&quot;br-ext&quot;</span></span><br><span class="line">TEAM_CONFIG=<span class="string">&#x27;&#123;&quot;runner&quot;: &#123;&quot;name&quot;: &quot;loadbalance&quot;&#125;, &quot;link_watch&quot;: &#123;&quot;name&quot;: &quot;ethtool&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>bridge 配置<br><strong>注意生产的br-ext 的ip网段 和 测试的br-ext的ip网段 不是同一个网段</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-br-ext</span></span><br><span class="line">DEVICE=<span class="string">&quot;br-ext&quot;</span></span><br><span class="line">ONBOOT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">TYPE=<span class="string">&quot;Bridge&quot;</span></span><br><span class="line">BOOTPROTO=<span class="string">&quot;none&quot;</span></span><br><span class="line">IPADDR=<span class="string">&quot;172.30.x.xx&quot;</span></span><br><span class="line">NETMASK=<span class="string">&quot;255.255.192.0&quot;</span></span><br><span class="line"><span class="comment">#GATEWAY=&quot;172.30.x.x&quot;</span></span><br><span class="line">IPV6INIT=<span class="string">&quot;yes&quot;</span></span><br><span class="line">IPV6_AUTOCONF=<span class="string">&quot;yes&quot;</span></span><br><span class="line">DHCPV6C=<span class="string">&quot;no&quot;</span></span><br><span class="line">STP=<span class="string">&quot;on&quot;</span></span><br><span class="line">DELAY=<span class="string">&quot;0&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="em2-配置"><a href="#em2-配置" class="headerlink" title="em2 配置"></a>em2 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-em2</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=em2</span><br><span class="line">DEVICE=em2</span><br><span class="line">ONBOOT=yes</span><br><span class="line">TEAM_MASTER=team1</span><br><span class="line">DEVICETYPE=TeamPort</span><br></pre></td></tr></table></figure>
<h3 id="em3-配置"><a href="#em3-配置" class="headerlink" title="em3 配置"></a>em3 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/network-scripts/ifcfg-em3</span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=em3</span><br><span class="line">DEVICE=em3</span><br><span class="line">ONBOOT=yes</span><br><span class="line">TEAM_MASTER=team1</span><br><span class="line">DEVICETYPE=TeamPort</span><br></pre></td></tr></table></figure>
<h3 id="systctl-配置"><a href="#systctl-配置" class="headerlink" title="systctl 配置"></a>systctl 配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.conf.em1.rp_filter = 0</span><br><span class="line">net.ipv4.conf.em2.rp_filter = 0</span><br><span class="line">net.ipv4.conf.em3.rp_filter = 0</span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line">net.ipv4.conf.br-ext.rp_filter = 0</span><br><span class="line">net.ipv4.conf.team1.rp_filter = 0</span><br></pre></td></tr></table></figure>
<p><code>rp_filter</code> 简要说明</p>
<ul>
<li>0:表示不开启源检测;</li>
<li>1:严格模式，根据数据包的源，通过查FIB表(Forward Information Table,可以理解为路由表)，检查数据包进入端口是同时也是出端口，以视为最佳路径，如果不符合最佳路径，则丢弃数据包;</li>
<li>2:松散模式,检查数据包的来源，查FIB表，如果通过任意端口都无法到达此源，则丢包。</li>
</ul>
<p>启动并测试 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ifdown br-ext &amp;&amp; ifdown team1</span></span><br><span class="line"><span class="comment"># ifup team1</span></span><br><span class="line"><span class="comment"># ifup br-ext</span></span><br><span class="line"><span class="comment"># ifdown em2 ; ifup em2</span></span><br><span class="line"><span class="comment"># ifdown em3 ; ifup em3</span></span><br><span class="line"><span class="comment"># sysctl -p </span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>python 企业微信-微信信息发送</title>
    <url>/2020/05/13/python%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1-%E5%BE%AE%E4%BF%A1%E4%BF%A1%E6%81%AF%E5%8F%91%E9%80%81/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-企业微信-微信信息发送"><a href="#python-企业微信-微信信息发送" class="headerlink" title="python 企业微信-微信信息发送"></a>python 企业微信-微信信息发送</h1><p><img src="/images/qiyeweixin-python.jpg" class="lazyload" data-srcset="/images/qiyeweixin-python.jpg" srcset="data:image/png;base64,666" alt=""></p>
<p>主要用到的模块 urllib,json,simplejson,requests,bs4 </p>
<ul>
<li>urllib: urllib的request模块可以非常方便地抓取URL内容，也就是发送一个GET请求到指定的页面，然后返回HTTP的响应;</li>
<li>json: JSON(JavaScript Object Notation) 是一种轻量级的数据交换格式。易于人阅读和编写。同时也易于机器解析和生成;</li>
<li>simplesjon: simplejson 是 json 标准模块的扩展（基础功能相同），是 pypi 提供的拓展模块，需要另行安装。不过可以使用 python 自带的 json 库，基本是相同的使用方法(提供的接口功能基本一致)。在 python 的 library 文档中将 JSON 归为网络数据控制类，很好的说明了他们的用途，主要用于网络数据控制，编解码等。但是也具有其他的用途，比如可以用来作为配置文件的读写模块，简单的文件操作等;</li>
<li>requests: python HTTP库，一般用于爬虫;</li>
<li>Beautiful Soup提供一些简单的、python式的函数用来处理导航、搜索、修改分析树等功能。它是一个工具箱，通过解析文档为用户提供需要抓取的数据，因为简单，所以不需要多少代码就可以写出一个完整的应用程序;</li>
</ul>
<h2 id="创建企业微信用应用"><a href="#创建企业微信用应用" class="headerlink" title="创建企业微信用应用"></a>创建企业微信用应用</h2><p>注: 这里我使用的是个人注册的企业微信，因为需要管理员的权限</p>
<p>用企业微信管理员登录后，我们可以新建一个应用程序用于送通知信息</p>
<p><img src="/images/qiyeweixing.png" class="lazyload" data-srcset="/images/qiyeweixing.png" srcset="data:image/png;base64,666" alt=""></p>
<p>我这里已经新建好了专用应用，点进去后添加可见应用的人。也就是所谓的应用授权。</p>
<p><img src="/images/qiyeweixin-user.png" class="lazyload" data-srcset="/images/qiyeweixin-user.png" srcset="data:image/png;base64,666" alt=""></p>
<p>在这里要记录下 <strong>Agentid</strong>  和 <strong>Secert</strong> 用于发送通时的认证口令</p>
<p><img src="/images/weixintongzhi-qiyeid.png" class="lazyload" data-srcset="/images/weixintongzhi-qiyeid.png" srcset="data:image/png;base64,666" alt=""><br>点击我的企业 –&gt;企业信息 ，在这里可以看到<strong>企业ID</strong>, 也用于代码中配置的通知id用</p>
<p>好了，这时候我们就可以开始写代码了，在此，我要发送的信息是<strong>天气信息</strong>，<strong>每日金句</strong>，和<strong>通知专项</strong>等信息</p>
<h2 id="第三方网站、接口"><a href="#第三方网站、接口" class="headerlink" title="第三方网站、接口"></a>第三方网站、接口</h2><p>中国天气网  <a href="http://www.weather.com.cn/weather/101100201.shtml">天气信息</a><br>在这里我选择的是大同的天气页面<br><img src="/images/weixintongzhi-tianqi.png" class="lazyload" data-srcset="/images/weixintongzhi-tianqi.png" srcset="data:image/png;base64,666" alt=""></p>
<p><a href="https://v1.hitokoto.cn/">一言接口</a><br><a href="https://developer.hitokoto.cn/sentence">一言接口使用文档</a></p>
<p>接口信息如下</p>
<p><img src="/images/weixintongzhi-yiyan.png" class="lazyload" data-srcset="/images/weixintongzhi-yiyan.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="python-爬取天气–-gt-调用一言接口–-gt-专项通知"><a href="#python-爬取天气–-gt-调用一言接口–-gt-专项通知" class="headerlink" title="python 爬取天气–&gt;调用一言接口–&gt;专项通知"></a>python 爬取天气–&gt;调用一言接口–&gt;专项通知</h2><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>登录个人服务器，source python3 环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~]<span class="comment"># alias mp3=&#x27;source  ~/mypython/py3_env/bin/activate &amp;&amp; cd ~/mypython/python3&#x27;</span></span><br><span class="line">~]<span class="comment"># mp3</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.request <span class="keyword">as</span> urllib2</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> simplejson</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="comment"># reload(sys)</span></span><br><span class="line"><span class="comment"># sys.setdefaultencoding(&#x27;utf-8&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gettoken</span>(<span class="params">corpid,corpsecret</span>):</span></span><br><span class="line">    gettoken_url = <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#x27;</span> + corpid + <span class="string">&#x27;&amp;corpsecret=&#x27;</span> + corpsecret</span><br><span class="line">    print(gettoken_url)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        token_file = urllib2.urlopen(gettoken_url)</span><br><span class="line">    <span class="keyword">except</span> urllib2.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        print(e.code)</span><br><span class="line">        print(e.read().decode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">        sys.exit()</span><br><span class="line">    token_data = token_file.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    token_json = json.loads(token_data)</span><br><span class="line">    token_json.keys()</span><br><span class="line">    token = token_json[<span class="string">&#x27;access_token&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">senddata</span>(<span class="params">access_token,user,subject,content</span>):</span></span><br><span class="line"></span><br><span class="line">    send_url = <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=&#x27;</span> + access_token</span><br><span class="line">    send_values = &#123;</span><br><span class="line">        <span class="string">&quot;touser&quot;</span>: user,   <span class="comment">#企业号中的用户帐号，如果配置不正常，将按部门发送。</span></span><br><span class="line">        <span class="string">&quot;toparty&quot;</span>:<span class="string">&quot;2&quot;</span>,        <span class="comment">#企业号中的部门id。</span></span><br><span class="line">        <span class="string">&quot;msgtype&quot;</span>:<span class="string">&quot;text&quot;</span>,     <span class="comment">#消息类型。</span></span><br><span class="line">        <span class="string">&quot;agentid&quot;</span>:<span class="string">&quot;100xxxxx&quot;</span>,  <span class="comment">#企业号中的应用id。</span></span><br><span class="line">        <span class="string">&quot;text&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>:subject + <span class="string">&#x27;\n&#x27;</span> + content</span><br><span class="line">           &#125;,</span><br><span class="line">        <span class="string">&quot;safe&quot;</span>:<span class="string">&quot;0&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">#    send_data = json.dumps(send_values, ensure_ascii=False)</span></span><br><span class="line">    send_data = simplejson.dumps(send_values, ensure_ascii=<span class="literal">False</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    send_request = urllib2.Request(send_url, send_data)</span><br><span class="line">    response = json.loads(urllib2.urlopen(send_request).read())</span><br><span class="line">    print(<span class="built_in">str</span>(response))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">get_tianqi</span>(<span class="params">url, data=<span class="literal">None</span></span>):</span>  <span class="comment"># 用来获取天气网页信息</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(url,timeout=<span class="number">30</span>)</span><br><span class="line">        r.raise_for_status()</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        <span class="keyword">return</span>  r.text</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;产生异常&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_qitian_data</span>(<span class="params">html,city</span>):</span> <span class="comment"># 处理网页信息提取近七天的情况</span></span><br><span class="line">    tianqi_list = []</span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">    body = soup.body</span><br><span class="line">    data = body.find(<span class="string">&#x27;div&#x27;</span>,&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;7d&#x27;</span>&#125;)</span><br><span class="line">    ul = data.find(<span class="string">&#x27;ul&#x27;</span>)</span><br><span class="line">    list1 = ul.find_all(<span class="string">&#x27;li&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> day <span class="keyword">in</span> list1:</span><br><span class="line">        temp_list = [city]</span><br><span class="line">        date = day.find(<span class="string">&#x27;h1&#x27;</span>).string</span><br><span class="line">        temp_list.append(date)</span><br><span class="line">        info = day.find_all(<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">        temp_list.append(info[<span class="number">0</span>].string)</span><br><span class="line">        <span class="keyword">if</span> info[<span class="number">1</span>].find(<span class="string">&#x27;span&#x27;</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            temperature_highest = <span class="string">&#x27; &#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            temperature_highest = info[<span class="number">1</span>].find(<span class="string">&#x27;span&#x27;</span>).string</span><br><span class="line">        <span class="keyword">if</span> info[<span class="number">1</span>].find(<span class="string">&#x27;i&#x27;</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            temperature_lowest = <span class="string">&#x27; &#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            temperature_lowest = info[<span class="number">1</span>].find(<span class="string">&#x27;i&#x27;</span>).string</span><br><span class="line">        temp_list.append(temperature_highest)</span><br><span class="line">        temp_list.append(temperature_lowest)</span><br><span class="line">        wind_scale = info[<span class="number">2</span>].find(<span class="string">&#x27;i&#x27;</span>).string</span><br><span class="line">        temp_list.append(wind_scale)</span><br><span class="line">        tianqi_list.append(temp_list)</span><br><span class="line">    <span class="keyword">return</span> tianqi_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">save_tianqi_data</span>(<span class="params">data,filename</span>):</span> <span class="comment"># 将近七天的天气信息存放在文件中</span></span><br><span class="line">    f=<span class="built_in">open</span>(filename,<span class="string">&quot;wt&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data:</span><br><span class="line">        f.write(<span class="built_in">str</span>(line)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hitokoto</span>(<span class="params">get_url</span>):</span></span><br><span class="line">    f = requests.get(get_url)</span><br><span class="line">    hitokoto_message = f.json()</span><br><span class="line">    hitokoto_message_data = <span class="string">&#x27;嗨:  &#x27;</span> + hitokoto_message[<span class="string">&#x27;hitokoto&#x27;</span>]</span><br><span class="line">    hitokoto_message_data = hitokoto_message_data.replace(<span class="string">&quot;，&quot;</span>,<span class="string">&quot;，\n&quot;</span>).replace(<span class="string">&quot;,&quot;</span>,<span class="string">&quot;,\n&quot;</span>)</span><br><span class="line">    hitokoto_message_from = <span class="string">&#x27;来自:  &#x27;</span> + hitokoto_message[<span class="string">&#x27;from&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> [hitokoto_message_data,hitokoto_message_from]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postrsg</span>(<span class="params">filename,get_url,zhuanxiang_file</span>):</span> <span class="comment">#取出信息并且用机器人发消息</span></span><br><span class="line">    hitokoto_memssage_print = get_hitokoto(get_url)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line"></span><br><span class="line">        first = lines[<span class="number">0</span>].rstrip(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        first = first.replace(<span class="string">&quot;[&#x27;&quot;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&quot;&#x27;]&quot;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;（今天）&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        first1 = first.split(<span class="string">&#x27;,&#x27;</span>,<span class="number">2</span>)[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">        str_first1 = <span class="string">&quot;&quot;</span>.join(first1).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        first2 = first.split(<span class="string">&#x27;,&#x27;</span>,<span class="number">2</span>)[<span class="number">-1</span>]</span><br><span class="line">        str_first2 = <span class="string">&quot;&quot;</span>.join(first2).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        sec = lines[<span class="number">1</span>].rstrip(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        sec = sec.replace(<span class="string">&quot;[&#x27;&quot;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&quot;&#x27;]&quot;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;（明天）&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        sec1 = sec.split(<span class="string">&#x27;,&#x27;</span>,<span class="number">2</span>)[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">        str_sec1 = <span class="string">&quot;&quot;</span>.join(sec1).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        sec2 = sec.split(<span class="string">&#x27;,&#x27;</span>,<span class="number">2</span>)[<span class="number">-1</span>]</span><br><span class="line">        str_sec2 = <span class="string">&quot;&quot;</span>.join(sec2).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(zhuanxiang_file,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            zhuanxiang_data = f.readlines()</span><br><span class="line">            zhuanxiang_data = <span class="string">&quot;&quot;</span>.join(zhuanxiang_data)</span><br><span class="line">        <span class="comment"># tianqi_head = &#x27;天津天气信息&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># formate_box = &#x27;☀️&#x27; * 12 + &#x27;\n&#x27;</span></span><br><span class="line">        <span class="comment"># formate_head = &#x27;&#123;:&lt;1&#125;&#123;:^36&#125;&#123;:&gt;1&#125;&#x27;.format(&#x27;☀️&#x27; * 1, tianqi_head, &#x27;☀️&#x27; * 1) + &#x27;\n&#x27;</span></span><br><span class="line">        <span class="comment"># formate_first = &#x27;&#123;:&lt;1&#125;&#123;:^36&#125;&#123;:&gt;1&#125;&#x27;.format(&#x27;&#x27; * 1, str_first1, &#x27;&#x27; * 1) + &#x27;\n&#x27;</span></span><br><span class="line">        <span class="comment"># formae_sec = &#x27;&#123;:&lt;2&#125;&#123;:^26&#125;&#123;:&gt;2&#125;&#x27;.format(&#x27;*&#x27; * 2, str_first2, &#x27;*&#x27; * 2) + &#x27;\n&#x27;</span></span><br><span class="line">        <span class="comment"># formate_box_end = &#x27;*&#x27; * 30</span></span><br><span class="line">        <span class="keyword">if</span>   <span class="string">&#x27;晴&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather = <span class="string">&#x27;☀️&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;雨&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather = <span class="string">&#x27;☂&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;雪&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather = <span class="string">&#x27;❄️&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;云&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather = <span class="string">&#x27;⛅️&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;阴&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather = <span class="string">&#x27;🌑&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            weather = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;晴&#x27;</span> <span class="keyword">in</span> str_sec2:</span><br><span class="line">            weather_2 = <span class="string">&#x27;☀️&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;雨&#x27;</span> <span class="keyword">in</span> str_sec2:</span><br><span class="line">            weather_2 = <span class="string">&#x27;☂&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;雪&#x27;</span> <span class="keyword">in</span> str_sec2:</span><br><span class="line">            weather_2 = <span class="string">&#x27;❄️&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;云&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather_2 = <span class="string">&#x27;⛅️&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;阴&#x27;</span> <span class="keyword">in</span> str_first2:</span><br><span class="line">            weather_2 = <span class="string">&#x27;🌑&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            weather_2 = <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    message_subject = <span class="string">&#x27;&#x27;&#x27;&lt;-----------任锦专用----------&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">    message_content = <span class="string">&#x27;&#x27;&#x27;&lt;-----------今日天气----------&gt;</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string">    *&#123;&#125;</span></span><br><span class="line"><span class="string">&lt;-----------明日天气----------&gt;</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string">    #&#123;&#125;</span></span><br><span class="line"><span class="string">&lt;-----------每日金句----------&gt;</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#125;</span></span><br><span class="line"><span class="string">&lt;-----------提示专项----------&gt;</span></span><br><span class="line"><span class="string">    &#123;&#125;                        &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(str_first1, str_first2, str_sec1, str_sec2,</span><br><span class="line">               hitokoto_memssage_print[<span class="number">0</span>], hitokoto_memssage_print[<span class="number">1</span>],</span><br><span class="line">               zhuanxiang_data).replace(<span class="string">&#x27;*&#x27;</span>, weather).replace(<span class="string">&#x27;#&#x27;</span>, weather_2)</span><br><span class="line">    <span class="keyword">return</span> [message_subject,message_content]</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    zhuanxiang_file = <span class="string">&#x27;/var/www/liuxxxx/liuxxxx_put.txt&#x27;</span></span><br><span class="line">    tianqi_url = <span class="string">&#x27;http://www.weather.com.cn/weather/101100201.shtml&#x27;</span></span><br><span class="line">    html = get_tianqi(tianqi_url)</span><br><span class="line">    result = get_qitian_data(html, <span class="string">&#x27;山西: 大同&#x27;</span>)</span><br><span class="line">    filename = <span class="string">&#x27;./liuxxxx.message&#x27;</span></span><br><span class="line">    save_tianqi_data(result, filename)</span><br><span class="line">    get_url = <span class="string">&#x27;https://v1.hitokoto.cn/&#x27;</span></span><br><span class="line">    postrsg_message = postrsg(filename,get_url,zhuanxiang_file)</span><br><span class="line">    user = <span class="built_in">str</span>(<span class="string">&#x27;RenJin&#x27;</span>)</span><br><span class="line">    subject = <span class="built_in">str</span>(postrsg_message[<span class="number">0</span>])  <span class="comment"># 发送的标题信息</span></span><br><span class="line">    content = <span class="built_in">str</span>(postrsg_message[<span class="number">1</span>]) <span class="comment"># 发送的主体信息</span></span><br><span class="line">    corpid =  <span class="string">&#x27;ww3xxxxxxxxxxxxxxxxx&#x27;</span>     <span class="comment">#企业号的id</span></span><br><span class="line">    corpsecret = <span class="string">&#x27;OF-nuSt6xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#x27;</span>    <span class="comment">#管理组凭证密钥</span></span><br><span class="line">    accesstoken = gettoken(corpid,corpsecret)</span><br><span class="line">    senddata(accesstoken,user,subject,content)</span><br></pre></td></tr></table></figure>
<p>这个时候执行就可以在企业微信上收到信息了</p>
<p><img src="/images/weixintongzhi-qiye-one.png" class="lazyload" data-srcset="/images/weixintongzhi-qiye-one.png" srcset="data:image/png;base64,666" alt=""></p>
<p>企业微信能收到通知后，可以测试一下微信端的收信</p>
<p><strong>在此补充一下，如果想在微信端收到通知信息，在收信息的人关注微信号就可以了</strong></p>
<p>在企业微信页面点击我的企业 –&gt; 微信插件 –&gt; 邀请关注</p>
<p><img src="/images/weixintongzhi-guanzhu.png" class="lazyload" data-srcset="/images/weixintongzhi-guanzhu.png" srcset="data:image/png;base64,666" alt=""></p>
<p>关注后，再发送就会收到如下信息</p>
<p><img src="/images/weixingtongzhi-weixintest.png" class="lazyload" data-srcset="/images/weixingtongzhi-weixintest.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="专项通知实现"><a href="#专项通知实现" class="headerlink" title="专项通知实现"></a>专项通知实现</h2><p>进入nginx  站点根目录，这里需要有nginx环境 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~]<span class="comment"># cd /var/www/liuxxxx/</span></span><br></pre></td></tr></table></figure>
<h3 id="html-web输入框"><a href="#html-web输入框" class="headerlink" title="html web输入框"></a>html web输入框</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>刘xxxx提示专项<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;./index.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    提示内容1: <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">&quot;width:150px; height:50px;color:8B0000&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ts1&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    提示内容2: <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">&quot;width:150px; height:50px;color:8B000&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ts2&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    提示内容3: <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">&quot;width:150px; height:50px;color:1F099&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ts3&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">&quot;width:90px; height:50px;float:160px;color:8B0012&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;本玲确认提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="php-提醒并写入文件"><a href="#php-提醒并写入文件" class="headerlink" title="php 提醒并写入文件"></a>php 提醒并写入文件</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;h1&gt; 写入新提示计划&lt;/h1&gt;</span><br><span class="line">提示通知<span class="number">1</span>的内容是    <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">&quot;ts1&quot;</span>];<span class="meta">?&gt;</span>&lt;br&gt;</span><br><span class="line">提示通知<span class="number">2</span>的内容是    <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">&quot;ts2&quot;</span>];<span class="meta">?&gt;</span>&lt;br&gt;</span><br><span class="line">提示通知<span class="number">3</span>的内容是    <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">&quot;ts3&quot;</span>];<span class="meta">?&gt;</span>&lt;br&gt;</span><br><span class="line">&lt;h1&gt; 清空了旧提示计划&lt;/h1&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&#x27;清空id&#x27;</span>;</span><br><span class="line">   file_put_contents(<span class="string">&#x27;liuxxxx_put.txt&#x27;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">   $file = fopen(<span class="string">&quot;liuxxxx_put.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">   <span class="keyword">echo</span> fwrite($file,$_POST[<span class="string">&quot;ts1&quot;</span>].<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="keyword">echo</span> fwrite($file,<span class="string">&quot;    &quot;</span>.$_POST[<span class="string">&quot;ts2&quot;</span>].<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">   <span class="keyword">echo</span> fwrite($file,<span class="string">&quot;    &quot;</span>.$_POST[<span class="string">&quot;ts3&quot;</span>]);</span><br><span class="line">fclose($file);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="编辑现有的nginx虚拟主机"><a href="#编辑现有的nginx虚拟主机" class="headerlink" title="编辑现有的nginx虚拟主机"></a>编辑现有的nginx虚拟主机</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">location /liuxxxx &#123;</span><br><span class="line">    auth_basic <span class="string">&quot;Auth Base For Liuxxxx&quot;</span>;  <span class="comment">#</span></span><br><span class="line">    auth_basic_user_file /etc/nginx/conf.d/ssjinyao.db; <span class="comment"># 这里用htpasswd  写了一个用户和密码保存在 ssjinyao.db 中</span></span><br><span class="line">    <span class="comment">#error_page 405 =200 $uri;</span></span><br><span class="line">    alias /var/www/liuxxxx;</span><br><span class="line">    <span class="keyword">index</span> <span class="keyword">index</span> index.htm index.html php index.php;</span><br><span class="line">        location ~ <span class="regexp">/liuxxxx/</span>(.*)\.php(.*)$ &#123;</span><br><span class="line">        <span class="comment">#default_type text/html;</span></span><br><span class="line">        <span class="comment">#add_header Content-Type &#x27;text/html; charset=utf-8&#x27;;</span></span><br><span class="line">        <span class="comment">#return 200 &quot;$document_root  , $fastcgi_script_name&quot;;</span></span><br><span class="line">        alias /var/www;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(.*)$;</span><br><span class="line">        <span class="comment">#fastcgi_param PATH_INFO $fastcgi_path_info;</span></span><br><span class="line">        fastcgi_pass   <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">9000</span>;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx 生效后，访问并页面写入专项通知<br><img src="/images/weixintongzhi-zhuanxiang-push.png" class="lazyload" data-srcset="/images/weixintongzhi-zhuanxiang-push.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="加入定时任务计划"><a href="#加入定时任务计划" class="headerlink" title="加入定时任务计划"></a>加入定时任务计划</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0 7,12 * * * <span class="built_in">source</span> /root/mypython/py3_env/bin/activate &amp;&amp; <span class="built_in">cd</span> /root/mypython/python3 &amp;&amp; python liuxxx.py</span><br></pre></td></tr></table></figure>
<p>最后的效果</p>
<p><img src="/images/weixintongzhi-crontab.png" class="lazyload" data-srcset="/images/weixintongzhi-crontab.png" srcset="data:image/png;base64,666" alt=""></p>
<p>其它说明，这个python脚本可以把收信息的变量改为位置变量做zabbix prometehus 报警通知来用</p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python表格操作</title>
    <url>/2020/04/22/python_excel%E8%A1%A8%E6%A0%BC%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-表格操作"><a href="#python-表格操作" class="headerlink" title="python 表格操作"></a>python 表格操作</h1><h2 id="将awk生成的数据导入表格"><a href="#将awk生成的数据导入表格" class="headerlink" title="将awk生成的数据导入表格"></a>将awk生成的数据导入表格</h2><p><img src="/images/python-pandas1.png" class="lazyload" data-srcset="/images/python-pandas1.png" srcset="data:image/png;base64,666" alt=""><br>pandas ：pannel data analysis（面板数据分析）。pandas是基于numpy构建的，为时间序列分析提供了很好的支持。pandas中有两个主要的数据结构，一个是Series，另一个是DataFrame。</p>
<p>Series 类似于一维数组与字典(map)数据结构的结合。它由一组数据和一组与数据相对应的数据标签（索引index）组成。这组数据和索引标签的基础都是一个一维ndarray数组。可将index索引理解为行索引。 Series的表现形式为：索引在左，数据在右。</p>
<p>DataFrame是一个类似表格的数据结构，索引包括列索引和行索引，包含有一组有序的列，每列可以是不同的值类型（数值、字符串、布尔值等）。DataFrame的每一行和每一列都是一个Series，这个Series的name属性为当前的行索引名/列索引名。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> openpyxl <span class="keyword">as</span> xl</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">cycle=<span class="number">38</span></span><br><span class="line">time_year_month_day = <span class="built_in">str</span>(datetime.date.today()-datetime.timedelta(days=cycle))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proj_xls_to_xlsx</span>(<span class="params">file_path,sheet_name,save_name,tableTitle=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(save_name):</span><br><span class="line">        wb = xl.Workbook()</span><br><span class="line">        wb.save(save_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        wb = xl.load_workbook(save_name)</span><br><span class="line">    ws1 = wb.create_sheet(<span class="number">0</span>)</span><br><span class="line">    ws1.title = sheet_name</span><br><span class="line">    <span class="keyword">if</span> tableTitle != <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tableTitle)):</span><br><span class="line">            c = n + <span class="number">1</span></span><br><span class="line">            ws1.cell(row=<span class="number">1</span>, column=c).value = tableTitle[n]</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">        value = d.split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">           <span class="comment"># print(value)</span></span><br><span class="line">            value[<span class="number">5</span>]=<span class="built_in">float</span>(value[<span class="number">5</span>])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        ws1.append(value)</span><br><span class="line">    wb.save(save_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crate_shuju_toushi</span>(<span class="params">save_name,sheet_name,sheet_name2,index_name,values_name,department_name,new_department_name,personnel_name</span>):</span></span><br><span class="line">    f = pd.read_excel(io=save_name,sheet_name=sheet_name)</span><br><span class="line">    res = pd.pivot_table(f,index=[index_name],values=[values_name],aggfunc=np.<span class="built_in">sum</span>, margins=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    wb = xl.load_workbook(save_name)</span><br><span class="line">    old_title = wb.worksheets[<span class="number">0</span>]</span><br><span class="line">    old_title.title = sheet_name2</span><br><span class="line"></span><br><span class="line">    all_xinxi_title=<span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((res.index)),<span class="built_in">list</span>(res[values_name])))</span><br><span class="line">    department_personnel = <span class="built_in">list</span>(<span class="built_in">zip</span>(f[department_name],f[index_name]))</span><br><span class="line">    department_personnel_size_list = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_xinxi_title:</span><br><span class="line">         <span class="keyword">for</span> department_personnel_list <span class="keyword">in</span> department_personnel:</span><br><span class="line">             <span class="keyword">if</span> user[<span class="number">0</span>] <span class="keyword">in</span> department_personnel_list:</span><br><span class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                     <span class="keyword">continue</span></span><br><span class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">                     <span class="keyword">continue</span></span><br><span class="line">                 department_personnel_size_list.append((department_personnel_list[<span class="number">0</span>],user[<span class="number">0</span>],user[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    end_department_personnel_size_list = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(department_personnel_size_list)), key=<span class="keyword">lambda</span> x:x[<span class="number">2</span>] ,reverse=<span class="literal">True</span>)</span><br><span class="line">    all_xinxi_title_end = all_xinxi_title[<span class="number">-1</span>]</span><br><span class="line">    all_xinxi_title_end = <span class="built_in">list</span>(all_xinxi_title_end)</span><br><span class="line">    all_xinxi_title_end.insert(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    end_department_personnel_size_list.append(all_xinxi_title_end)</span><br><span class="line">    end_department_personnel_size_list.insert(<span class="number">0</span>,[new_department_name,personnel_name,values_name])</span><br><span class="line">    end_department_personnel_size_list.pop()</span><br><span class="line"></span><br><span class="line">    user_volue = []</span><br><span class="line">    <span class="keyword">for</span> user2 <span class="keyword">in</span> end_department_personnel_size_list:</span><br><span class="line">        user2 = <span class="built_in">list</span>(user2)</span><br><span class="line">        <span class="keyword">if</span> user2[<span class="number">1</span>] == user_volue:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        user_volue = user2[<span class="number">1</span>]</span><br><span class="line">        old_title.append(user2)</span><br><span class="line">    wb.save(save_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_space_toushi</span>(<span class="params">save_name,sheet_name,sheet_name2,department_num,sum_name,data_total,index_name,values_name</span>):</span></span><br><span class="line">    f = pd.read_excel(io=save_name,sheet_name=sheet_name,dtype=&#123;<span class="string">&#x27;业务XX利润编号&#x27;</span>:<span class="built_in">str</span>&#125;)</span><br><span class="line">    res = pd.pivot_table(f,index=index_name,values=values_name,aggfunc=np.<span class="built_in">sum</span>,margins=<span class="literal">True</span>)</span><br><span class="line">    all_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>(res.index),<span class="built_in">list</span>(res[values_name])))</span><br><span class="line"></span><br><span class="line">    wb = xl.load_workbook(save_name)</span><br><span class="line">    sheet = wb.create_sheet(sheet_name2)</span><br><span class="line"></span><br><span class="line">    space_list = []</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_list:</span><br><span class="line">        user2 = <span class="built_in">list</span>(user)[<span class="number">1</span>]</span><br><span class="line">        user3 = <span class="built_in">list</span>(<span class="built_in">list</span>(user)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            space_list.append((user3[<span class="number">1</span>],user2))</span><br><span class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">            space_list.append((user3[<span class="number">1</span>],user2))</span><br><span class="line">    sum_list = []</span><br><span class="line">    <span class="keyword">for</span> slist <span class="keyword">in</span> space_list:</span><br><span class="line">        sum_list.append(slist[<span class="number">1</span>])</span><br><span class="line">    sum_list=<span class="built_in">sum</span>(sum_list)</span><br><span class="line">    sort_space_list = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>(space_list)), key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>] ,reverse=<span class="literal">True</span>)</span><br><span class="line">    sort_space_list.append((sum_name, sum_list))</span><br><span class="line">    sort_space_list.insert(<span class="number">0</span>,(department_num,data_total))</span><br><span class="line">    <span class="keyword">for</span> all_space_list <span class="keyword">in</span> sort_space_list:</span><br><span class="line">        sheet.append(all_space_list)</span><br><span class="line">    wb.save(save_name)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sheet_name = <span class="string">&#x27;XXX详情&#x27;</span></span><br><span class="line">    save_name = <span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    save_name = <span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    file_path = <span class="string">&#x27;./able.&#x27;</span> + time_year_month_day +<span class="string">&#x27;.lib.xls&#x27;</span></span><br><span class="line">    proj_xls_to_xlsx(file_path=file_path,</span><br><span class="line">                     sheet_name=sheet_name,</span><br><span class="line">                     save_name=save_name)</span><br><span class="line">                     </span><br><span class="line">    sheet_name = <span class="string">&#x27;XXX总体情况&#x27;</span></span><br><span class="line">    save_name = <span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> +  time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    file_path = <span class="string">&#x27;./&#x27;</span> + time_year_month_day + <span class="string">&#x27;.ProjInfo.XJpath.xls&#x27;</span></span><br><span class="line">    table_title = [<span class="string">&#x27;业务XX名称&#x27;</span>,<span class="string">&#x27;业务XX利润编号&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;运营经理&#x27;</span>,<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;涉及项目数&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;涉及数据量大小（G）&#x27;</span>,<span class="string">&#x27;项目编号1&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;项目名称1&#x27;</span>,<span class="string">&#x27;数据量(G)1&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;文库编号1&#x27;</span>,<span class="string">&#x27;项目编号2&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;项目名称2&#x27;</span>,<span class="string">&#x27;数据量(G)2&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;文库编号2&#x27;</span>,<span class="string">&#x27;项目编号3&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;项目名称3&#x27;</span>,<span class="string">&#x27;数据量(G)3&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;文库编号3&#x27;</span>,<span class="string">&#x27;项目编号4&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;项目名称4   数据量(G)4&#x27;</span>,<span class="string">&#x27;文库编号4&#x27;</span>,]</span><br><span class="line">    proj_xls_to_xlsx(file_path=file_path,</span><br><span class="line">                     sheet_name=sheet_name,</span><br><span class="line">                     tableTitle=table_title,</span><br><span class="line">                     save_name=save_name)</span><br><span class="line"></span><br><span class="line">    save_name = <span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    sheet_name = <span class="string">&#x27;XXX总体情况&#x27;</span></span><br><span class="line">    sheet_name2 = <span class="string">&#x27;XXX概况&#x27;</span></span><br><span class="line">    index_name = <span class="string">&#x27;信息分析&#x27;</span></span><br><span class="line">    values_name = <span class="string">&#x27;涉及数据量大小（G）&#x27;</span></span><br><span class="line">    department_name = <span class="string">&#x27;业务XX名称&#x27;</span></span><br><span class="line">    new_department_name = <span class="string">&#x27;XX&#x27;</span></span><br><span class="line">    personnel_name = <span class="string">&#x27;人员&#x27;</span></span><br><span class="line">    crate_shuju_toushi(save_name=save_name,</span><br><span class="line">                       sheet_name=sheet_name,</span><br><span class="line">                       sheet_name2=sheet_name2,</span><br><span class="line">                       index_name=index_name,</span><br><span class="line">                       values_name=values_name,</span><br><span class="line">                       department_name=department_name,</span><br><span class="line">                       new_department_name=new_department_name,</span><br><span class="line">                       personnel_name=personnel_name)</span><br><span class="line"></span><br><span class="line">    index_name = [<span class="string">&#x27;信息分析&#x27;</span>,<span class="string">&#x27;业务XX利润编号&#x27;</span>]</span><br><span class="line">    save_name = <span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    sheet_name = <span class="string">&#x27;XXX总体情况&#x27;</span></span><br><span class="line">    department_num = <span class="string">&#x27;XX编号&#x27;</span></span><br><span class="line">    data_total = <span class="string">&#x27;数据量（G）&#x27;</span></span><br><span class="line">    values_name = <span class="string">&#x27;涉及数据量大小（G）&#x27;</span></span><br><span class="line">    sheet_name2 = <span class="string">&#x27;未匹配人员数据量&#x27;</span></span><br><span class="line">    sum_name = <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">    create_space_toushi(index_name=index_name,</span><br><span class="line">                        save_name=save_name,</span><br><span class="line">                        sheet_name=sheet_name,</span><br><span class="line">                        department_num=department_num,</span><br><span class="line">                        data_total=data_total,</span><br><span class="line">                        values_name=values_name,</span><br><span class="line">                        sheet_name2=sheet_name2,</span><br><span class="line">                        sum_name=sum_name,)</span><br></pre></td></tr></table></figure>
<h2 id="完成数据透视"><a href="#完成数据透视" class="headerlink" title="完成数据透视,"></a>完成数据透视,</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> openpyxl <span class="keyword">as</span> xl</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">difference_cycle=<span class="number">33</span></span><br><span class="line">time_year_month_day = <span class="built_in">str</span>(datetime.date.today()-datetime.timedelta(days=difference_cycle))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_last_excel</span>(<span class="params">old_sheet,new_sheet,gaikuang</span>):</span></span><br><span class="line">    pd01 = pd.read_excel(old_sheet,sheet_name=gaikuang,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    pd02 = pd.read_excel(new_sheet,sheet_name=gaikuang,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    pd11 = pd.read_excel(old_sheet,sheet_name=<span class="string">&#x27;未匹配人员数据量&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    pd12 = pd.read_excel(new_sheet,sheet_name=<span class="string">&#x27;未匹配人员数据量&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    result = pd.merge(pd01,pd02[[<span class="string">&#x27;人员&#x27;</span>,<span class="string">&#x27;涉及数据量大小（G）&#x27;</span>]],on=<span class="string">&#x27;人员&#x27;</span>)</span><br><span class="line">    result_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((result[<span class="string">&#x27;XXX&#x27;</span>])),<span class="built_in">list</span>((result[<span class="string">&#x27;人员&#x27;</span>])),<span class="built_in">list</span>((result[<span class="string">&#x27;涉及数据量大小（G）_x&#x27;</span>])),<span class="built_in">list</span>((result[<span class="string">&#x27;涉及数据量大小（G）_y&#x27;</span>]))))</span><br><span class="line"></span><br><span class="line">    not_match = pd.merge(pd11,pd12[[<span class="string">&#x27;XXX编号&#x27;</span>,<span class="string">&#x27;数据量（G）&#x27;</span>]],left_on=<span class="string">&#x27;XXX编号&#x27;</span>,right_on=<span class="string">&#x27;XXX编号&#x27;</span>)</span><br><span class="line">    print(not_match)</span><br><span class="line">    not_match_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(<span class="built_in">list</span>((not_match[<span class="string">&#x27;XXX编号&#x27;</span>])),<span class="built_in">list</span>((not_match[<span class="string">&#x27;数据量（G）_x&#x27;</span>])),<span class="built_in">list</span>((not_match[<span class="string">&#x27;数据量（G）_y&#x27;</span>]))))</span><br><span class="line"></span><br><span class="line">    wb2 = xl.load_workbook(new_sheet)</span><br><span class="line">    remove_sheet1 = wb2[gaikuang]</span><br><span class="line">    remove_sheet2 = wb2[<span class="string">&#x27;未匹配人员数据量&#x27;</span>]</span><br><span class="line">    wb2.remove(remove_sheet1)</span><br><span class="line">    wb2.remove(remove_sheet2)</span><br><span class="line">    wb2.save(new_sheet)</span><br><span class="line"></span><br><span class="line">    wb2 = xl.load_workbook(new_sheet)</span><br><span class="line">    sheet21 = wb2.create_sheet(gaikuang,<span class="number">0</span>)</span><br><span class="line">    sheet22 = wb2.create_sheet(<span class="string">&#x27;未匹配人员数据量&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    result_head = [<span class="string">&#x27;XXX&#x27;</span>,<span class="string">&#x27;人员&#x27;</span>,<span class="string">&#x27;涉及数据量（G）&#x27;</span>,<span class="string">&#x27;第二次涉及数据量（G）&#x27;</span>,<span class="string">&#x27;任务额差&#x27;</span>]</span><br><span class="line">    result_list.insert(<span class="number">0</span>,result_head)</span><br><span class="line">    result_for_num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result_list:</span><br><span class="line">        result_i = <span class="built_in">list</span>(i)</span><br><span class="line">        <span class="keyword">if</span> result_for_num != <span class="number">1</span>:</span><br><span class="line">            result_chae=i[<span class="number">2</span>]-i[<span class="number">3</span>]-i[<span class="number">2</span>]*<span class="number">0.2</span></span><br><span class="line">            result_i.append(<span class="built_in">float</span>(<span class="string">&#x27;%.2f&#x27;</span>% result_chae))</span><br><span class="line">        result_for_num = result_for_num + <span class="number">1</span></span><br><span class="line">        sheet21.append(result_i)</span><br><span class="line"></span><br><span class="line">    not_match_head = [<span class="string">&#x27;XXX编号&#x27;</span>,<span class="string">&#x27;数据量（G）&#x27;</span>,<span class="string">&#x27;第二次数据量（G）&#x27;</span>,<span class="string">&#x27;任务额差&#x27;</span>]</span><br><span class="line">    not_match_list.insert(<span class="number">0</span>,not_match_head)</span><br><span class="line">    not_match_for_num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span>  not_match_list:</span><br><span class="line">        not_match_j = <span class="built_in">list</span>(j)</span><br><span class="line">        <span class="keyword">if</span> not_match_for_num != <span class="number">1</span>:</span><br><span class="line">            not_match_chae=j[<span class="number">1</span>]-j[<span class="number">2</span>]-j[<span class="number">1</span>]*<span class="number">0.2</span></span><br><span class="line">            not_match_j.append(<span class="built_in">float</span>(<span class="string">&#x27;%.2f&#x27;</span>% not_match_chae))</span><br><span class="line">        not_match_for_num = not_match_for_num + <span class="number">1</span></span><br><span class="line">        sheet22.append(not_match_j)</span><br><span class="line">    wb2.save(new_sheet)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    old_sheet=<span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;-old.xlsx&#x27;</span></span><br><span class="line">    new_sheet=<span class="string">&#x27;TJ-XJ-DATASHOW-&#x27;</span> + time_year_month_day + <span class="string">&#x27;.xlsx&#x27;</span></span><br><span class="line">    gaikuang=<span class="string">&#x27;XXX概况&#x27;</span></span><br><span class="line">    add_last_excel(old_sheet=old_sheet,new_sheet=new_sheet,gaikuang=gaikuang)</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>高可用gitlab服务器搭建</title>
    <url>/2020/03/26/%E9%AB%98%E5%8F%AF%E7%94%A8gitlab%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="高可用gitlab服务器搭建"><a href="#高可用gitlab服务器搭建" class="headerlink" title="高可用gitlab服务器搭建"></a>高可用gitlab服务器搭建</h1><p><img src="/images/gitlab.jpg" class="lazyload" data-srcset="/images/gitlab.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="环境准备-单节点部署"><a href="#环境准备-单节点部署" class="headerlink" title="环境准备,单节点部署"></a>环境准备,单节点部署</h2><table>
<thead>
<tr>
<th>CentOS7.4</th>
<th>64C</th>
<th>192G</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS7.4</td>
<td>64C</td>
<td>192G</td>
</tr>
</tbody>
</table>
<h3 id="服务器时间同步"><a href="#服务器时间同步" class="headerlink" title="服务器时间同步"></a>服务器时间同步</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure>
<h3 id="确保SELinux-是关闭的"><a href="#确保SELinux-是关闭的" class="headerlink" title="确保SELinux 是关闭的"></a>确保SELinux 是关闭的</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# getenforce </span><br><span class="line">Disabled</span><br></pre></td></tr></table></figure>
<h3 id="配置postfix"><a href="#配置postfix" class="headerlink" title="配置postfix"></a>配置postfix</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# yum -y install postfix</span><br><span class="line">~]# sed -i &#39;s&#x2F;inet_interfaces &#x3D; localhost&#x2F;inet_interfaces &#x3D; all&#x2F;g&#39; &#x2F;etc&#x2F;postfix&#x2F;main.cf</span><br><span class="line">~]# systemctl start postfix</span><br><span class="line">~]# systemctl restart postfix</span><br></pre></td></tr></table></figure>
<h3 id="配置gitlab-ce-yum源并安装"><a href="#配置gitlab-ce-yum源并安装" class="headerlink" title="配置gitlab-ce yum源并安装"></a>配置gitlab-ce yum源并安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# vim &#x2F;etc&#x2F;yum.repos.d&#x2F;gitlab-ce.repo</span><br><span class="line">[gitlab-ce]</span><br><span class="line">name&#x3D;Gitlab CE Repository</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;gitlab-ce&#x2F;yum&#x2F;el$releasever&#x2F;</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">enabled&#x3D;1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# yum clean all</span><br><span class="line">~]# yum makecache </span><br><span class="line">~]# yum -y install gitlab-ce </span><br></pre></td></tr></table></figure>
<h3 id="gitlab-配置"><a href="#gitlab-配置" class="headerlink" title="gitlab 配置"></a>gitlab 配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# cd &#x2F;etc&#x2F;gitlab&#x2F;</span><br><span class="line">~]# cp gitlab.rb&#123;,.bak&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="gitlab-配置文件"><a href="#gitlab-配置文件" class="headerlink" title="gitlab 配置文件"></a>gitlab 配置文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 地址配置</span></span><br><span class="line">external_url <span class="string">&#x27;https://gitdb.novogene.com&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ldap AD域配置</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;ldap_enabled&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;ldap_servers&#x27;</span>] = YAML.load &lt;&lt;-<span class="string">&#x27;EOS&#x27;</span></span><br><span class="line">  main:</span><br><span class="line">    label: <span class="string">&#x27;诺禾AD&#x27;</span></span><br><span class="line">    host: <span class="string">&#x27;xx.xxx.xx.xxx&#x27;</span></span><br><span class="line">    port: 3xx</span><br><span class="line">    uid: <span class="string">&#x27;sAMAccountName&#x27;</span></span><br><span class="line">    method: <span class="string">&#x27;plain&#x27;</span></span><br><span class="line">    bind_dn: <span class="string">&#x27;CN=xxx,OU=xxx,DC=xxx,DC=xxx&#x27;</span></span><br><span class="line">    password: <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line">    active_directory: <span class="literal">true</span></span><br><span class="line">    allow_username_or_email_login: ture</span><br><span class="line">    block_auto_created_users: <span class="literal">false</span></span><br><span class="line">    base: <span class="string">&#x27;OU=xxx,DC=xxx,DC=xxx&#x27;</span></span><br><span class="line">    user_filter: <span class="string">&#x27;&#x27;</span></span><br><span class="line">EOS</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># gitlab 邮件配置</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_enable&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_address&#x27;</span>] = <span class="string">&#x27;smtp.exmail.qq.com&#x27;</span>;</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_port&#x27;</span>] = 465;</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_user_name&#x27;</span>] = <span class="string">&quot;xx@xxxxx.com&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_password&#x27;</span>] = <span class="string">&quot;xxxxxxx&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_domain&#x27;</span>] = <span class="string">&#x27;smtp.exmail.qq.com&#x27;</span>;</span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_authentication&#x27;</span>] = <span class="string">&quot;login&quot;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;smtp_tls&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_email_from&#x27;</span>] = <span class="string">&#x27;xxx@xxxxxx.com&#x27;</span></span><br><span class="line">nginx[<span class="string">&#x27;redirect_http_to_https&#x27;</span>] = <span class="literal">true</span></span><br><span class="line">nginx[<span class="string">&#x27;ssl_certificate&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitdb.pem&quot;</span></span><br><span class="line">nginx[<span class="string">&#x27;ssl_certificate_key&#x27;</span>] = <span class="string">&quot;/etc/gitlab/ssl/gitdb.key&quot;</span></span><br><span class="line">nginx[<span class="string">&#x27;redirect_http_to_https_port&#x27;</span>] = 80</span><br><span class="line">nginx[<span class="string">&#x27;listen_port&#x27;</span>] = 443</span><br></pre></td></tr></table></figure>
<h2 id="gitlab服务启动"><a href="#gitlab服务启动" class="headerlink" title="gitlab服务启动"></a>gitlab服务启动</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~]# gitlab-ctl start</span><br></pre></td></tr></table></figure>
<h2 id="lsyncd-主从同步配置"><a href="#lsyncd-主从同步配置" class="headerlink" title="lsyncd 主从同步配置"></a>lsyncd 主从同步配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~]<span class="comment">#  /etc/lsyncd.conf </span></span><br><span class="line">settings &#123;</span><br><span class="line">    logfile =<span class="string">&quot;/var/log/lsyncd/lsyncd.log&quot;</span>,</span><br><span class="line">    statusFile =<span class="string">&quot;/var/log/lsyncd/lsyncd.status&quot;</span>,</span><br><span class="line">    inotifyMode = <span class="string">&quot;Modify&quot;</span>,</span><br><span class="line">    maxProcesses = 20,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">&quot;/var/opt/gitlab&quot;</span>,</span><br><span class="line">    target    = <span class="string">&quot;root@172.30.1.17:/var/opt/gitlab/&quot;</span>,</span><br><span class="line">    exclude = &#123; <span class="string">&quot;backups&quot;</span>, <span class="string">&quot;gitlab-ci&quot;</span>, <span class="string">&quot;sockets&quot;</span>,<span class="string">&quot;gitlab.yml&quot;</span>,<span class="string">&quot;redis&quot;</span>,<span class="string">&quot;postmaster.pid &quot;</span>&#125;,</span><br><span class="line">    maxDelays = 5,</span><br><span class="line">    delay = 30,</span><br><span class="line">    -- init = <span class="literal">true</span>,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = <span class="string">&quot;/usr/bin/rsync&quot;</span>,</span><br><span class="line">        archive = <span class="literal">true</span>,</span><br><span class="line">        compress = <span class="literal">true</span>,</span><br><span class="line">        bwlimit   = 2000</span><br><span class="line">        -- rsh = <span class="string">&quot;/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sync &#123;</span><br><span class="line">    default.rsync,</span><br><span class="line">    <span class="built_in">source</span>    = <span class="string">&quot;/etc/gitlab/&quot;</span>,</span><br><span class="line">    target    = <span class="string">&quot;root@172.30.1.17:/etc/gitlab/&quot;</span>,</span><br><span class="line">    maxDelays = 5,</span><br><span class="line">    delay = 30,</span><br><span class="line">    -- init = <span class="literal">true</span>,</span><br><span class="line">    rsync     = &#123;</span><br><span class="line">        binary = <span class="string">&quot;/usr/bin/rsync&quot;</span>,</span><br><span class="line">        archive = <span class="literal">true</span>,</span><br><span class="line">        compress = <span class="literal">true</span>,</span><br><span class="line">        bwlimit   = 2000</span><br><span class="line">        -- rsh = <span class="string">&quot;/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id node1</span><br><span class="line">   &#125;</span><br><span class="line">vrrp_script chk_gitlab &#123;</span><br><span class="line">    script <span class="string">&quot;/bin/bash /usr/local/keepalived/etc/keepalived/check_gitlab.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface em1</span><br><span class="line">    virtual_router_id 55</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    notify_master <span class="string">&quot;/usr/local/keepalived/etc/keepalived/message.sh  master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/usr/local/keepalived/etc/keepalived/message.sh  backup&quot;</span></span><br><span class="line">    notify_fault  <span class="string">&quot;/usr/local/keepalived/etc/keepalived/message.sh  fault&quot;</span></span><br><span class="line">    unicast_src_ip 172.30.1.16</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">     172.30.1.17</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">       chk_gitlab</span><br><span class="line">    &#125;</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass xxxxxxxx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.30.1.20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="keepalived-检测脚本"><a href="#keepalived-检测脚本" class="headerlink" title="keepalived 检测脚本"></a>keepalived 检测脚本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">package</span></span>() &#123;</span><br><span class="line">    rpm -qf /usr/bin/curl &amp;&gt; /dev/null || yum -y install curl &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line">package</span><br><span class="line"><span class="function"><span class="title">gitlab_state</span></span> () &#123; </span><br><span class="line">    /usr/bin/curl -s  https://gitdb.novogene.com/users/sign_in | grep <span class="string">&quot;Username&quot;</span> &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line">gitlab_state ; gitlab_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state_num</span></span><br><span class="line"><span class="function"><span class="title">gitlab_state2</span></span> () &#123;</span><br><span class="line">   /usr/bin/curl -s  https://gitdb.novogene.com/users/sign_in | grep <span class="string">&quot;Password&quot;</span> &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">kill_keepalived</span></span> () &#123;</span><br><span class="line">      <span class="built_in">kill</span> -9 `cat /var/run/keepalived.pid`</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$gitlab_state_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` gitlab_status_one_check problem &quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log</span><br><span class="line">   gitlab_state2 ; gitlab_state2_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state2_num</span> </span><br><span class="line">   <span class="keyword">if</span> [ <span class="variable">$gitlab_state2_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;`  gitlab_status2_one_check problem&quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log     </span><br><span class="line">        sleep 1</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">gitlab_state ; gitlab_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state_num</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$gitlab_state_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` gitlab_status_two_check problem &quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log</span><br><span class="line">    gitlab_state2 ; gitlab_state2_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state2_num</span> </span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$gitlab_state2_num</span> -ne 0 ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;`date +&quot;</span>%Y-%m-%d-%H-%M-%S<span class="string">&quot;` gitlab_status2_two_check problem &quot;</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;gitdb jiqun change node1&quot;</span> | mutt -s <span class="string">&quot;gitdb.novogene.com&quot;</span> renjin@novogene.com</span><br><span class="line">        kill_keepalived</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h2 id="git-客户端常用命令"><a href="#git-客户端常用命令" class="headerlink" title="git 客户端常用命令"></a>git 客户端常用命令</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># git config --global user.name &quot;name&quot; #设置全局用户名</span><br><span class="line"># git config --global user.email  xxx@novogene.com # 设置全局邮箱</span><br><span class="line"># git config --global --list #列出用户全局设置</span><br><span class="line"># git add index.html &#x2F; . #添加指定文件、目录或当前目录下所有数据到暂存区</span><br><span class="line"># git commit -m &quot;xx&quot; #提交文件到工作区</span><br><span class="line"># git status #查看工作区的状态</span><br><span class="line"># git push #提交代码到服务器</span><br><span class="line"># git pull # 获取代码到本地</span><br><span class="line"># git log # 查看操作日志</span><br><span class="line"># vim .gitignore  # 定义忽略文件</span><br><span class="line"># git rest --hard HEAD^^ # git版本回滚，HEAD为当前版本，加一个^为上一个，^^为上上一个版本</span><br><span class="line"># git reflog # 获取每次提交的ID,可以使用--hard根据提交的ID进行版本回退</span><br><span class="line"># git reset --hard 5ae4b06 #回退到指定id的版本</span><br><span class="line"># git branch # 查看当前所处的分支</span><br><span class="line"># git checkout -b develop # 创建并切换到一个新分支</span><br><span class="line"># git checkout  develop #切换分支</span><br></pre></td></tr></table></figure>
<h2 id="git缓存区与工作区等概念"><a href="#git缓存区与工作区等概念" class="headerlink" title="git缓存区与工作区等概念"></a>git缓存区与工作区等概念</h2><ul>
<li>工作区: clone 的代码或者开发自己编写的代码文件所在的目录，通常是代码所在的一个服务的目录名称;</li>
</ul>
<ul>
<li><p>暂存区: 用于存储在工作区中对代码进行修改后的文件所保存的地方，使用git add添加;</p>
</li>
<li><p>本地仓库: 用于提交存储在工作区和暂存区中改过的文件地方，使用git commit提交;</p>
</li>
<li><p>远程仓库: 多个开发共同协作提交代码的仓库，即gitlab或github服务器。</p>
</li>
</ul>
<h2 id="macos-安装-git"><a href="#macos-安装-git" class="headerlink" title="macos 安装 git"></a>macos 安装 git</h2><p>未安装 Homebrew 的需要先安装Homebrew</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/bin/ruby -e \ </span></span><br><span class="line"><span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>安装git</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># brew install git</span><br></pre></td></tr></table></figure>
<h2 id="CentOS-安装-git"><a href="#CentOS-安装-git" class="headerlink" title="CentOS 安装 git"></a>CentOS 安装 git</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install git </span><br></pre></td></tr></table></figure>
<h2 id="Ubuntu-安装-git"><a href="#Ubuntu-安装-git" class="headerlink" title="Ubuntu 安装 git"></a>Ubuntu 安装 git</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># apt-get install git </span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>总结glibc的升级操作</title>
    <url>/2020/03/11/glibc%20%E5%8D%87%E7%BA%A7%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="总结glibc的升级操作"><a href="#总结glibc的升级操作" class="headerlink" title="总结glibc的升级操作"></a>总结glibc的升级操作</h1><p><img src="/images/glibc.png" class="lazyload" data-srcset="/images/glibc.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="遇到的执行程序报错"><a href="#遇到的执行程序报错" class="headerlink" title="遇到的执行程序报错"></a>遇到的执行程序报错</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fastp.sh 的时候报下面的错，其他节点都没问题</span><br><span class="line">fastp: &#x2F;lib64&#x2F;libc.so.6: version &#96;GLIBC_2.14&#39; not found (required by fastp)</span><br><span class="line">fastp: &#x2F;lib64&#x2F;libc.so.6: version &#96;GLIBC_2.14&#39; not found (required by &#x2F;zlib&#x2F;lib&#x2F;libz.so.1)</span><br></pre></td></tr></table></figure>
<p>在操作之前最好先备份 <code>/lib64/libc.so.6</code> 和它对应指向的链接文件</p>
<h2 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h2><p><code>注: 操作服务器的时候，一定要把这个节点从集群中去除。确保不影响业务的使用</code><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;redhat-release </span><br><span class="line">CentOS release 6.5 (Final)</span><br><span class="line"># strings &#x2F;lib64&#x2F;libc.so.6 |grep GLIBC_ </span><br><span class="line">GLIBC_2.2.5</span><br><span class="line">GLIBC_2.2.6</span><br><span class="line">GLIBC_2.3</span><br><span class="line">GLIBC_2.3.2</span><br><span class="line">GLIBC_2.3.3</span><br><span class="line">GLIBC_2.3.4</span><br><span class="line">GLIBC_2.4</span><br><span class="line">GLIBC_2.5</span><br><span class="line">GLIBC_2.6</span><br><span class="line">GLIBC_2.7</span><br><span class="line">GLIBC_2.8</span><br><span class="line">GLIBC_2.9</span><br><span class="line">GLIBC_2.10</span><br><span class="line">GLIBC_2.11</span><br><span class="line">GLIBC_2.12</span><br><span class="line">GLIBC_PRIVATE</span><br></pre></td></tr></table></figure><br>由上面的信息可以看出系统是CentOS 6.5，最高支持glibc的版本为2.12，而研发程序要2.14版本，所以需要升级。</p>
<h2 id="下载软件并升级"><a href="#下载软件并升级" class="headerlink" title="下载软件并升级"></a>下载软件并升级</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># wget http:&#x2F;&#x2F;ftp.gnu.org&#x2F;gnu&#x2F;glibc&#x2F;glibc-2.14.tar.gz </span><br><span class="line"># wget http:&#x2F;&#x2F;ftp.gnu.org&#x2F;gnu&#x2F;glibc&#x2F;glibc-ports-2.14.tar.gz </span><br><span class="line"># tar -xvf  glibc-2.14.tar.gz </span><br><span class="line"># tar -xvf  glibc-ports-2.14.tar.gz</span><br><span class="line"># mv glibc-ports-2.14 glibc-2.14&#x2F;ports</span><br><span class="line"># mkdir glibc-2.14&#x2F;build</span><br><span class="line"># cd glibc-2.14&#x2F;build </span><br><span class="line"># ..&#x2F;configure  --prefix&#x3D;&#x2F;usr --disable-profile --enable-add-ons --with-headers&#x3D;&#x2F;usr&#x2F;include --with-binutils&#x3D;&#x2F;usr&#x2F;bin</span><br><span class="line"># make</span><br><span class="line"># make install</span><br></pre></td></tr></table></figure>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p><code>这个时候可能遇到以下问题，千万不要断开ssh 执行以下命令进行补救</code><br><img src="/images/glibc-not.jpeg" class="lazyload" data-srcset="/images/glibc-not.jpeg" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># LD_PRELOAD&#x3D;&#x2F;lib64&#x2F;libc-2.14.so </span><br><span class="line"># rm -f &#x2F;lib64&#x2F;libc.so.6</span><br><span class="line"># ln -s &#x2F;lib64&#x2F;libc-2.14.so &#x2F;lib64&#x2F;libc.so.6</span><br></pre></td></tr></table></figure>
<p>这时候再看看系统命令还能否都正常使用</p>
<h2 id="如果断开了ssh-的情况下"><a href="#如果断开了ssh-的情况下" class="headerlink" title="如果断开了ssh 的情况下"></a>如果断开了ssh 的情况下</h2><p>如果断开了ssh 只能进系统救援模式进行补救了;<br>重启，(single/1)单用户模式，/bin/bash，enforcing=0,selinux=0 都是无济于事的，因为它涉及的库是<code>libc.so.6</code>必需的，重启后会报内核恐慌<code>Kernel panic – not syncing: Attempted to kill init</code>;<br>因此进入救援模式进行补救。</p>
<ol>
<li>连接dell服务器远程控制台，映射本地镜像文件到dell服务器;</li>
<li>启动项默认调整为光盘镜像启动;</li>
<li>进入救援模式<code>Rescue installed system</code>;</li>
<li>选择语言和键盘用English、 us;</li>
<li>出现网络设置不需要配置;</li>
<li>挂载/mnt/sysimage 选用Continue;</li>
<li>发现磁盘，选择yes;</li>
<li>启用shell登录;</li>
<li>cd /mnt/sysimage 目录;</li>
<li><code>rm -f /lib64/libc.so.6</code> <code>cd /lib64 &amp;&amp; ln -s libc-2.14.so libc.so.6</code>;</li>
<li><code>chroot /mnt/sysimage</code> 切换根目录测试系统是否无误;</li>
<li>重新启动系统。</li>
</ol>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>网络经济与企业管理(一)</title>
    <url>/2020/03/01/zikao/%E7%BD%91%E7%BB%9C%E7%BB%8F%E6%B5%8E%E4%B8%8E%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h1 id="网络经济与企业管理-一"><a href="#网络经济与企业管理-一" class="headerlink" title="网络经济与企业管理(一)"></a>网络经济与企业管理(一)</h1><p><img src="/images/wangluojinjiyuguanli.jpg" class="lazyload" data-srcset="/images/wangluojinjiyuguanli.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="企业及其形式"><a href="#企业及其形式" class="headerlink" title="企业及其形式"></a>企业及其形式</h2><ol>
<li>企业是以<strong>市场</strong> 为导向从事商品生产和流通的经济组织;</li>
<li>企业是以<strong>价值增值</strong>作为其经济活动的目的;</li>
<li>企业进行<strong>自主经营</strong> <strong>自负盈亏</strong>和<strong>独立核算</strong>。独立核算</li>
</ol>
<p>选择题</p>
<p><strong>工厂制度</strong>的建立，标志着企业的真正形成。</p>
<p>多选，现代企业生产时期的特征</p>
<ol>
<li><strong>拥有现代技术</strong></li>
<li><strong>拥有现代化管理</strong></li>
<li><strong>所有者与经营者相分离</strong></li>
</ol>
<h2 id="管理方面"><a href="#管理方面" class="headerlink" title="管理方面"></a>管理方面</h2><ol>
<li>拥有现代化管理</li>
<li>所有者与经营者相分离</li>
</ol>
<h2 id="生产技术"><a href="#生产技术" class="headerlink" title="生产技术"></a>生产技术</h2><ol>
<li>拥有现代技术</li>
<li>生产规模空前扩大，产生了垄断组织</li>
<li>劳动分工越来截止精细，协作关系复杂、严密</li>
</ol>
<h2 id="竞争"><a href="#竞争" class="headerlink" title="竞争"></a>竞争</h2><ol>
<li>企业之间的竞争激烈</li>
</ol>
<h2 id="社会责任"><a href="#社会责任" class="headerlink" title="社会责任"></a>社会责任</h2><ol>
<li>企业的社会责任改变</li>
</ol>
<h2 id="企业类型"><a href="#企业类型" class="headerlink" title="企业类型"></a>企业类型</h2><p>根据企业所属的经济部(农业企业、工业企业、金融企业、商业企业)<br>根据生产力要素比重(劳动密集型企业、技术密集型企业、知识密集型企业、资源密集型企业)<br>根据企业经营规模(大型企业，中型企业，小型企业)<br>根据企业财产构成和所负法律责任:<br>1、个体企业<br>又叫独资企业，是<strong>由业主个人出资兴办</strong>，由业主自己经营。在国外，许多零售商业、手工业、家庭工业、农业等多采用个体企业。<br>2、 合伙企业<br>由两个或两个以上的个人共同出资，通过签订协议联合经营。<br>3、公司制企业(如有限责任公司和股份有限公司)<br>由两个以上的出资者共同出资、依法组建，<strong>以盈利为目的的企业法人</strong>，是联合经营的企业组织形式。</p>
<h2 id="公司制企业的特点"><a href="#公司制企业的特点" class="headerlink" title="公司制企业的特点"></a>公司制企业的特点</h2><p>公司制企业是法人。<br>公司制企业实行有限责任制度。<br>公司制企业的所有权和经营权相分离。</p>
<h2 id="真题"><a href="#真题" class="headerlink" title="真题"></a>真题</h2><p>1、企业为了满足社会</p>
<h2 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h2><p>1、管理是一个动态过程;<br>2、管理的环抱是达到组织的预定目标;<br>3、管理的载体是组织;<br>4、管理的核心是对资源的合理配置和有效整合。</p>
<h2 id="管理活动所具备的条件"><a href="#管理活动所具备的条件" class="headerlink" title="管理活动所具备的条件"></a>管理活动所具备的条件</h2><p>管理的主体(谁来管) 、 管理的客体(管理谁)、 管理的目的(为啥管)</p>
<h2 id="五职能论"><a href="#五职能论" class="headerlink" title="五职能论"></a>五职能论</h2><p>法约尔认为，企业的管理活动就是由<strong>计划</strong>、<strong>组织</strong>、<strong>指挥</strong>、<strong>协调</strong>、<strong>控制</strong> 这五种职能级成的。 <strong>计划</strong> 是管理职能中的首要职能 –&gt;</p>
<h2 id="管理-的计划职能"><a href="#管理-的计划职能" class="headerlink" title="管理 的计划职能"></a>管理 的计划职能</h2><p><strong>计划</strong>、<strong>组织</strong>、<strong>领导</strong>、<strong>控制</strong> 是管理学派普通的公认的职能。 首要的职能<br><strong>计划职能</strong> 是对<strong>即定的目标</strong>进行具体安排，作为全体员工在一定时期的行动纲领，<br>并规定实现目标的途径、方法的管理活活动。<br>1 年以内是短期计划， 1-5 是中期计划 ，5年后是长期计划</p>
<h2 id="组织工作的基本原则-简答"><a href="#组织工作的基本原则-简答" class="headerlink" title="组织工作的基本原则(简答)"></a>组织工作的基本原则(简答)</h2><p>有效性原则: 能高效地完成工作；机构设置和人员配备到精简。精简人员实现任务和责任到人，有效地避免了推诿和扯皮现象。<br>统一指挥原则: 在指挥和命令，严格执行”一元化”管理。<br>责权利相一致则:为每一个层次和环节都规定责，同时赋予所必须的职权。<br>集权和分权相结合原则: 对重大决策和全局性管理实行集权，对日常管理实行分权。<br>弹性原则: 设计组织结构时要留有余地，制定一些带有伸缩性的组织规则。<br>协调原则: 组织的优势之一是 “整体功能大于部分功能之和”</p>
<h2 id="领导的活动内容"><a href="#领导的活动内容" class="headerlink" title="领导的活动内容"></a>领导的活动内容</h2><p>1、权力的形成和运用<br>2、指导<br>3、激励<br>4、沟通<br>5、协调<br>6、营造组织气氛，建设组织文化</p>
<h2 id="控制的方式-选择"><a href="#控制的方式-选择" class="headerlink" title="控制的方式(选择)"></a>控制的方式(选择)</h2><p>预先控制:是面向未来的控制，又称<strong>前馈控制</strong>。<br>现场控制:指在实施计划过程中，充分体管理控制的那一部分工作，又称<strong>适时控制</strong>，是<strong>最基本的控制方式</strong><br>反馈控制: 也称<strong>过后行为控制或事后控制</strong></p>
<p>企业是以<strong>价值增值</strong>作为其经济活动的目的<br>企业管理的目标是实现企业<strong>价值的最大化</strong></p>
<h2 id="真题-1"><a href="#真题-1" class="headerlink" title="真题"></a>真题</h2><p>形成一项管理活动必须具备的条件，包括 <strong>有效管理的主体</strong> ，<strong>有效管理的客体</strong>  ，<strong>有效管理的目的</strong></p>
<p>管理的首要职能是<strong>计划</strong></p>
<p>中期计划的时间一般是<strong>一到五年以内</strong></p>
<p>运筹帷幄之中，决胜千里之外，这里运筹帷幄反应了管理的哪一个职能 <strong>计划职能</strong></p>
<p>法约尔的企业管理活动“五职能论” 包括计划、组织、指挥及<strong>调协与控制</strong></p>
<p>精简人员实现任务和责任到人，有效地避免了推诿和扯皮的现象，这体现了组织工作的哪项原则 <strong>有效性原则</strong></p>
<p>按照控制方式的不同，一般把控制分为 <strong>预先控制，现场控制，反馈控制</strong></p>
<p>现场控制，又称<strong>适时控制</strong></p>
<p>对既定的目标进行具体安排，作为全体员工在一时时期内的行动纲领，并规定实现目标的途径，方法的管理的 <strong>计划职能</strong></p>
<h2 id="企业管理的目标"><a href="#企业管理的目标" class="headerlink" title="企业管理的目标"></a>企业管理的目标</h2><p>利益相关着(资本所有者、债权人、客户、供应商、政府和社会)</p>
<h2 id="企业管理理论与实践的产生与发展"><a href="#企业管理理论与实践的产生与发展" class="headerlink" title="企业管理理论与实践的产生与发展"></a>企业管理理论与实践的产生与发展</h2><p>泰罗 《科学管理原理》 被称为科学管理之父<br>法约尔《工业管理和一般管理》 管理过程理论之父<br>韦伯《社会和经济理论》 被称为组织管理之父</p>
<p>行为科学理论，20世纪到30年代到60年代</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>理论</th>
</tr>
</thead>
<tbody>
<tr>
<td>马斯洛</td>
<td>需求层次理论</td>
</tr>
<tr>
<td>赫茨伯格</td>
<td>双因素理论</td>
</tr>
<tr>
<td>麦克利兰</td>
<td>激励需求理论</td>
</tr>
<tr>
<td>麦格雷戈</td>
<td>X理论-Y理论</td>
</tr>
</tbody>
</table>
<h3 id="管理理论丛林"><a href="#管理理论丛林" class="headerlink" title="管理理论丛林"></a>管理理论丛林</h3><table>
<thead>
<tr>
<th>姓名</th>
<th>学派</th>
</tr>
</thead>
<tbody>
<tr>
<td>巴纳德</td>
<td>社会系统学派</td>
</tr>
<tr>
<td>西蒙</td>
<td>决策学派</td>
</tr>
<tr>
<td>德鲁克</td>
<td>经验(案例) 学派</td>
</tr>
</tbody>
</table>
<h3 id="战略管理与实践的产生和发展"><a href="#战略管理与实践的产生和发展" class="headerlink" title="战略管理与实践的产生和发展"></a>战略管理与实践的产生和发展</h3><p>20 世纪60年代中后期到80年代初，企业管理学界开始重点研究<strong>战略管理理论</strong><br>20 世纪六七十年代，日本引进美国质量管理专家戴明和朱兰的<strong>全面质量管理</strong>的思想<br><strong>企业文化</strong>成为80年企业管理研究的重点</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>代表人物</th>
<th>理论</th>
</tr>
</thead>
<tbody>
<tr>
<td>20世纪80年代后期</td>
<td>哈默&amp;钱皮</td>
<td>企业再造理论</td>
</tr>
<tr>
<td>20世纪90年代后期</td>
<td>彼德&amp;圣吉</td>
<td>第5项修炼-企业唯一持久的竞争优势源于比竞争对手学得更快、更好的能力</td>
</tr>
</tbody>
</table>
<h2 id="真题-2"><a href="#真题-2" class="headerlink" title="真题"></a>真题</h2><ol>
<li>简述古典管理理论三位主要代表代人物及其贡献<br>a、泰罗的科学管理理论，重点研究了在工厂管理中如何提高效率，倡导要用科学思想，科学方法处理和解决企业管理问题。<br>b、法约尔的管理过程理论，对组织管理进行了系统的、独创的研究，提出了管理具有计划、组织、指挥、协调和控制5大职能和14条管理原则。<br>c、马克斯.韦伯的管理组织理论，提出了理想行政组织体系理论。</li>
</ol>
<ol>
<li><p>被称为”科学管理之父”的是<strong>泰罗</strong></p>
</li>
<li><p>马斯洛的代表性理论成果是<strong>需求层次理论</strong></p>
</li>
<li><p>经验(案例)学派的人物是<strong>巴纳德</strong></p>
</li>
<li><p>20世纪60-70年代日本引入了美国质量管理专家戴明和朱兰的<strong>全面质量管理思想</strong></p>
</li>
<li><p>法约尔认为，企业管理理活动的职能包括计划、组织和 <strong>指挥、协调和控制</strong></p>
</li>
<li><p>被誉为”组织管理之父”的是 <strong>韦伯</strong></p>
</li>
<li><p>被誉为”管理过程理论之父”是 <strong>法约尔</strong></p>
</li>
<li><p>赫茨伯格提出了著名的<strong>双因素理论</strong> </p>
</li>
</ol>
<p>9.麦格雷戈提出了著名的 <strong>X理论-Y理论</strong></p>
<ol>
<li>企业唯一持久的竞争优势源于比竞争对手学得更快、更好的能力，是哪位管理学者的观点 <strong>彼德.圣吉</strong></li>
</ol>
<h2 id="网络时代的企业环境"><a href="#网络时代的企业环境" class="headerlink" title="网络时代的企业环境"></a>网络时代的企业环境</h2><h3 id="网络时代企业面对的机遇"><a href="#网络时代企业面对的机遇" class="headerlink" title="网络时代企业面对的机遇"></a>网络时代企业面对的机遇</h3><ol>
<li>企业可以更好地满足顾客的个性化需求；</li>
<li>企业可以降低交易成本;</li>
<li>企业可以减少库存;</li>
<li>企业可以使合作竞争战略更便利地实施;</li>
<li>提高获取知识、应用知识的能力。</li>
</ol>
<h3 id="网络时代企业面对的挑战"><a href="#网络时代企业面对的挑战" class="headerlink" title="网络时代企业面对的挑战"></a>网络时代企业面对的挑战</h3><ol>
<li>企业面临日益激烈的竞争；</li>
<li>顾客的权力大增加;</li>
<li>企业的整体盈利水平将会降低;</li>
<li>企业关键的成功因素将会改变;</li>
<li>企业资源配置的方式和界限将会发生重大变化。</li>
</ol>
<h2 id="网络时代企业管理的变革"><a href="#网络时代企业管理的变革" class="headerlink" title="网络时代企业管理的变革"></a>网络时代企业管理的变革</h2><h3 id="企业管理拓展的范围有哪些"><a href="#企业管理拓展的范围有哪些" class="headerlink" title="企业管理拓展的范围有哪些"></a>企业管理拓展的范围有哪些</h3><p>网络企业与实体企业相比有如下特点:<br>a、网络企业所占的实现空间非常有限，不像生产企业和销售企业那样占有大面积的实现空间进行产品生产和产品存储;<br>b、网络企业是计算机化和网络化的企业;<br>c、网络企业是全天候运营的企业;<br>d、网络企业是信息技术和信息产品应用型的企业;<br>e、网络企业是高知识开型的松散企业。</p>
<h3 id="企业管理拓展的范围有哪些-1"><a href="#企业管理拓展的范围有哪些-1" class="headerlink" title="企业管理拓展的范围有哪些"></a>企业管理拓展的范围有哪些</h3><p>a、网络企业管理;<br>b、企业的网络化管理;<br>c、更加重视以知识资本为核心的无形资本的管理；<br>d、企业管理的范围拓展到整个供应链。</p>
<h3 id="企业管理创新的内容有哪些"><a href="#企业管理创新的内容有哪些" class="headerlink" title="企业管理创新的内容有哪些"></a>企业管理创新的内容有哪些</h3><ol>
<li>企业战略管理的创新;</li>
<li>企业组织管理的创新;</li>
<li>网络营销成为营销管理的重要内容;</li>
<li>敏捷制造成为企业生产运作管理最重要的方式;</li>
<li>企业管理将向战略型，集成化方向发展;</li>
<li>回归人本管理，重视人力资源管理;</li>
<li>知识管理成为企业管理的重要内容;</li>
<li>更加重视文化管理。</li>
</ol>
<h3 id="企业战略管理的变革"><a href="#企业战略管理的变革" class="headerlink" title="企业战略管理的变革"></a>企业战略管理的变革</h3><p><strong>开发和培育核心能力</strong>成为企业战略管理重点。</p>
<h3 id="企业组织结构变革的方向"><a href="#企业组织结构变革的方向" class="headerlink" title="企业组织结构变革的方向"></a>企业组织结构变革的方向</h3><p>四个现代化(扁平化–&gt; 虚拟化 –&gt; 柔性化 –&gt; 网络化)</p>
<h3 id="企业管理方法和手段的创新"><a href="#企业管理方法和手段的创新" class="headerlink" title="企业管理方法和手段的创新"></a>企业管理方法和手段的创新</h3><table>
<thead>
<tr>
<th>准时制</th>
<th>JIT</th>
<th>Just In Time</th>
<th>在需要的时候，按需要的量，生产所需的产品: 零废品，零库存，零准备时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>制造资源计划</td>
<td>MRP</td>
<td>Manufacturing Resources Planning</td>
<td>确保企业连续、均衡地生产，实现信息流、物流与资金流的有机集成，以计划的与控制为主线</td>
</tr>
<tr>
<td>企业资源计划</td>
<td>ERP</td>
<td>Enterprise Resources Planning</td>
<td>以客户需求为导向，实行企业内外资源优化配置，消除生产经营过程中一切无效的劳动和资源</td>
</tr>
<tr>
<td>电子数据交换</td>
<td>EDI</td>
<td>Electronic Data Interchange</td>
</tr>
<tr>
<td>并行工程</td>
<td>CE</td>
<td>Concurrent Engineering</td>
<td>需要产品开发人员从设计开始设计就考虑产品整个生命周期的所有因素</td>
</tr>
<tr>
<td>计算机集成制造系统</td>
<td>CIMS</td>
<td>Computer Intergrated Manufacturing System</td>
</tr>
<tr>
<td>分销资源计划</td>
<td>DRP</td>
<td>Distribution Resource Planning</td>
<td>使企业具有对定单和供货具有快速反应和持续补充库存的能力</td>
</tr>
<tr>
<td>企业内部网和互联网</td>
<td></td>
<td>Intranet， Internet</td>
</tr>
</tbody>
</table>
<h2 id="真题-3"><a href="#真题-3" class="headerlink" title="真题"></a>真题</h2><ol>
<li>请阐述企业在网络时代会面对哪些机遇和挑战？</li>
</ol>
<table>
<thead>
<tr>
<th>网络时代企业面对的机遇</th>
<th>网络时代企业面对的挑战</th>
</tr>
</thead>
<tbody>
<tr>
<td>企业可以更好地满足顾客的个性化需求</td>
<td>顾客的权力大大增加</td>
</tr>
<tr>
<td>企业可以降底交易成本</td>
<td>企业的整体盈力水平将会以降低</td>
</tr>
<tr>
<td>企业可以减少库存</td>
<td>企业资源的配置方式和界限将会发生重大变化</td>
</tr>
<tr>
<td>企业可以使竞争战略更利地实施</td>
<td>企业面临日益激烈的竞争</td>
</tr>
<tr>
<td>提高获取知识，应用知识的能力</td>
<td>企业关键的成功因素将会改变</td>
</tr>
</tbody>
</table>
<ol>
<li>企业战略管理的重点是<strong>开发和培育核心能力</strong></li>
<li>作为应对网络经济的挑战，企业组织结构变革的方向有<strong>柔性化、虚拟化、网络化、扁平化</strong></li>
<li>哪种管理方法的目标是通过管理，尽可能做到”零废品”、”零库存”和”零准备时间” <strong>JIT</strong></li>
<li>体现了以客户需求为导向，消除生产经营过程中一切无效的劳动和资源的管理思想是<strong>ERP</strong></li>
<li>企业资源计划简称<strong>ERP</strong></li>
<li>企业制造资源计划是指 <strong>MRP</strong></li>
<li>准时制简称 <strong>JIT</strong></li>
<li>网络经济时代，企业经营战略将围绕下列哪一项来制订<strong>企业核心业务和核心竞争力</strong></li>
</ol>
]]></content>
      <tags>
        <tag>zikao</tag>
      </tags>
  </entry>
  <entry>
    <title>python 算法</title>
    <url>/2019/12/15/python%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-算法"><a href="#python-算法" class="headerlink" title="python 算法"></a>python 算法</h1><p><img src="/images/python.jpg" class="lazyload" data-srcset="/images/python.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="命名元组namedtuple"><a href="#命名元组namedtuple" class="headerlink" title="命名元组namedtuple"></a>命名元组namedtuple</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line">In [<span class="number">2</span>]: Point = namedtuple(<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;x,y&#x27;</span>)</span><br><span class="line">In [<span class="number">3</span>]: <span class="built_in">type</span>(Point)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="built_in">type</span></span><br><span class="line">In [<span class="number">4</span>]: p1 = Point(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">In [<span class="number">5</span>]: p1</span><br><span class="line">Out[<span class="number">5</span>]: P(x=<span class="number">1</span>, y=<span class="number">10</span>)</span><br><span class="line">In [<span class="number">6</span>]: p1.x</span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">1</span></span><br><span class="line">In [<span class="number">7</span>]: p1.y</span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">10</span></span><br><span class="line">In [<span class="number">8</span>]: p1.x + p1.y</span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">11</span></span><br></pre></td></tr></table></figure>
<p>排序 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(py3_env) [root@ssjinyao:~/mypython/python3]<span class="comment"># cat sort.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">nums = []</span><br><span class="line">out = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    nums.append(<span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&#x27;&#123;&#125;: &#x27;</span>.<span class="built_in">format</span>(i))))</span><br><span class="line">nums.sort()</span><br><span class="line">print(nums)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">nums = []</span><br><span class="line">out = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    nums.append(<span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&#x27;&#123;&#125;: &#x27;</span>.<span class="built_in">format</span>(i))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cur = <span class="built_in">min</span>(nums)</span><br><span class="line">    print(cur)</span><br><span class="line">    nums.remove(cur)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nums) == <span class="number">1</span>:</span><br><span class="line">        print(nums[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line">nums &#x3D; []</span><br><span class="line">out &#x3D; None</span><br><span class="line">for i in range(3):</span><br><span class="line">    nums.append(int(input(&#39;&#123;&#125;:&#39;.format(i))))</span><br><span class="line"></span><br><span class="line">nums.sort()</span><br><span class="line">print(nums)</span><br></pre></td></tr></table></figure>
<h2 id="冒泡法代码实现-一"><a href="#冒泡法代码实现-一" class="headerlink" title="冒泡法代码实现(一)"></a>冒泡法代码实现(一)</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">num_list = [</span><br><span class="line">        [<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],</span><br><span class="line">        [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],</span><br><span class="line">]</span><br><span class="line">nums = num_list[<span class="number">0</span>]</span><br><span class="line">print(nums)</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length-i<span class="number">-1</span>):</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums [j+<span class="number">1</span>]:</span><br><span class="line">            tmp = nums[j]</span><br><span class="line">            nums[j] = nums [j+<span class="number">1</span>]</span><br><span class="line">            nums[j+<span class="number">1</span>] = tmp</span><br><span class="line">            count_swap +=<span class="number">1</span></span><br><span class="line">print(nums, count_swap, count)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[1, 9, 8, 5, 6, 7, 4, 3, 2]</span><br><span class="line">[1, 2, 3, 4, 5, 6, 7, 8, 9] 25 36</span><br></pre></td></tr></table></figure>
<h2 id="冒泡法代码实现-二"><a href="#冒泡法代码实现-二" class="headerlink" title="冒泡法代码实现(二)"></a>冒泡法代码实现(二)</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">num_list = [</span><br><span class="line">    [<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],</span><br><span class="line">    [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">nums = num_list[<span class="number">0</span>]</span><br><span class="line">print(nums)</span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line">flag = <span class="literal">False</span></span><br><span class="line">count_swap = <span class="number">0</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(length-i<span class="number">-1</span>):</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j+<span class="number">1</span>]:</span><br><span class="line">            tmp = nums[j]</span><br><span class="line">            nums[j] = nums[j+<span class="number">1</span>]</span><br><span class="line">            nums[j+<span class="number">1</span>] = tmp</span><br><span class="line">            flag = <span class="literal">True</span></span><br><span class="line">            count_swap += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(nums,count_swap,count)</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">## 字符串修改</span></span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">s = <span class="string">&quot;I am very very very sorry   &quot;</span></span><br><span class="line">s.strip()</span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">&#x27;I am very very very sorry&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="字符串查找"><a href="#字符串查找" class="headerlink" title="字符串查找"></a>字符串查找</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">find(sub,[,start[end]]) -&gt; int</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: s = <span class="string">&quot;I am very very very sorry &quot;</span></span><br><span class="line">In [<span class="number">2</span>]: s.find(<span class="string">&quot;very&quot;</span>)</span><br><span class="line">Out[<span class="number">2</span>]: <span class="number">5</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">14</span>]: s = <span class="string">&#x27;I am very very very sorry&#x27;</span></span><br><span class="line">In [<span class="number">15</span>]: i = <span class="number">0</span></span><br><span class="line">In [<span class="number">16</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">    ...:     print(<span class="built_in">str</span>(i)+x,end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">    ...:     i +=<span class="number">1</span></span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span>I <span class="number">1</span>  <span class="number">2</span>a <span class="number">3</span>m <span class="number">4</span>  <span class="number">5</span>v <span class="number">6</span>e <span class="number">7</span>r <span class="number">8</span>y <span class="number">9</span>  <span class="number">10</span>v <span class="number">11</span>e <span class="number">12</span>r <span class="number">13</span>y <span class="number">14</span>  <span class="number">15</span>v <span class="number">16</span>e <span class="number">17</span>r <span class="number">18</span>y <span class="number">19</span>  <span class="number">20</span>s <span class="number">21</span>o <span class="number">22</span>r <span class="number">23</span>r <span class="number">24</span>y</span><br></pre></td></tr></table></figure>
<h2 id="字符串格式化"><a href="#字符串格式化" class="headerlink" title="字符串格式化"></a>字符串格式化</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">15</span>]: t = (<span class="string">&#x27;asjin&#x27;</span>,<span class="string">&#x27;.com&#x27;</span>)</span><br><span class="line">In [<span class="number">16</span>]: <span class="string">&quot;&#123;&#125;,&#123;&#125;&quot;</span>.<span class="built_in">format</span>(t[<span class="number">0</span>],t[<span class="number">1</span>])</span><br><span class="line">Out[<span class="number">16</span>]: <span class="string">&#x27;asjin,.com&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [18]: &quot;&#123;0&#125;,&#123;0&#125;&quot;.format(t[0])</span><br><span class="line">Out[18]: &#39;asjin,asjin&#39;</span><br><span class="line"></span><br><span class="line">In [19]: &quot;&#123;&#125;&quot;.format([1,2])</span><br><span class="line">Out[19]: &#39;[1, 2]&#39;</span><br></pre></td></tr></table></figure>
<h2 id="对齐"><a href="#对齐" class="headerlink" title="对齐"></a>对齐</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">28</span>]: <span class="string">&#x27;&#123;0&#125;*&#123;1&#125;=&#123;2:&gt;02&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>*<span class="number">3</span>)</span><br><span class="line">Out[<span class="number">28</span>]: <span class="string">&#x27;3*2=06&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">29</span>]: <span class="string">&#x27;&#123;:^30&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;asjin.com&#x27;</span>)</span><br><span class="line">Out[<span class="number">29</span>]: <span class="string">&#x27;          asjin.com           &#x27;</span></span><br><span class="line">In [<span class="number">30</span>]: <span class="string">&#x27;&#123;:#^30&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;asjin.com&#x27;</span>)</span><br><span class="line">Out[<span class="number">30</span>]: <span class="string">&#x27;##########asjin.com###########&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">12</span>]: <span class="string">&quot;&#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;192.168.1.100&#x27;</span>,<span class="number">8888</span>)</span><br><span class="line">Out[<span class="number">12</span>]: <span class="string">&#x27;192.168.1.100:8888&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">13</span>]: t = (<span class="string">&quot;asjin&quot;</span>,<span class="string">&quot;com&quot;</span>)</span><br><span class="line">In [<span class="number">14</span>]: <span class="string">&quot;&#123;&#125;.&#123;&#125;&quot;</span>.<span class="built_in">format</span>(t[<span class="number">0</span>],t[<span class="number">1</span>])</span><br><span class="line">Out[<span class="number">14</span>]: <span class="string">&#x27;asjin.com&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">15</span>]: <span class="string">&quot;&#123;0[0]&#125;.&#123;0[1]&#125;&quot;</span>.<span class="built_in">format</span>((<span class="string">&quot;asjin&quot;</span>,<span class="string">&quot;com&quot;</span>))</span><br><span class="line">Out[<span class="number">15</span>]: <span class="string">&#x27;asjin.com&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">16</span>]: <span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line">In [<span class="number">17</span>]: Point = namedtuple(<span class="string">&#x27;_Point&#x27;</span>,<span class="string">&#x27;x,y&#x27;</span>)</span><br><span class="line">In [<span class="number">18</span>]: p1 = Point(<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line">In [<span class="number">19</span>]: p1.x</span><br><span class="line">Out[<span class="number">19</span>]: <span class="number">5</span></span><br><span class="line">In [<span class="number">20</span>]: p1.y</span><br><span class="line">Out[<span class="number">20</span>]: <span class="number">6</span></span><br><span class="line">In [<span class="number">23</span>]: <span class="string">&quot;Point = (&#123;&#123;&#123;0.x&#125;,&#123;0.y&#125;&#125;&#125;)&quot;</span>.<span class="built_in">format</span>(p1)</span><br><span class="line">Out[<span class="number">23</span>]: <span class="string">&#x27;Point = (&#123;5,6&#125;)&#x27;</span></span><br></pre></td></tr></table></figure>
<p>进制转换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">26</span>]: <span class="string">&quot;int: &#123;0:d&#125;; hex &#123;0:x&#125;; oct &#123;0:o&#125;; bin: &#123;0:b&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">1996</span>)</span><br><span class="line">Out[<span class="number">26</span>]: <span class="string">&#x27;int: 1996; hex 7cc; oct 3714; bin: 11111001100&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">27</span>]: <span class="string">&quot;int: &#123;0:d&#125;; hex &#123;0:#x&#125;; oct &#123;0:#o&#125;; bin: &#123;0:#b&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">1996</span>)</span><br><span class="line">Out[<span class="number">27</span>]: <span class="string">&#x27;int: 1996; hex 0x7cc; oct 0o3714; bin: 0b11111001100&#x27;</span></span><br></pre></td></tr></table></figure>
<p>ip 转换为十六进制 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">30</span>]: octets = [<span class="number">10</span>,<span class="number">180</span>,<span class="number">55</span>,<span class="number">1</span>]</span><br><span class="line">In [<span class="number">31</span>]: <span class="string">&quot;&#123;:02X&#125;&#123;:02X&#125;&#123;:02X&#125;&#123;:02X&#125;&quot;</span>.<span class="built_in">format</span>(*octets)</span><br><span class="line">Out[<span class="number">31</span>]: <span class="string">&#x27;0AB43701&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>让用户输入一个数，从后往前打印</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*-coding: utf-8 -*-</span></span><br><span class="line">m = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>).strip().lstrip(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;这是&#123;&#125;位数&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(m)))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(m)):</span><br><span class="line">    print(<span class="string">&quot;&#123;&#125;&#x27;s count = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(m[i],m.count(m[i])))</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(m)):</span><br><span class="line">    n=m[-j<span class="number">-1</span>]</span><br><span class="line">    print(n)</span><br><span class="line">print(m)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">num = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    num = <span class="built_in">input</span>(<span class="string">&quot;Please input a interger: &quot;</span>).strip()</span><br><span class="line">    num = <span class="built_in">int</span>(num)</span><br><span class="line">    num = <span class="built_in">str</span>(num)</span><br><span class="line">    <span class="keyword">if</span> num.isdigit():</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;Bad number&quot;</span>)</span><br><span class="line"></span><br><span class="line">count = [<span class="number">0</span>]*<span class="number">10</span> <span class="comment"># 0~9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    count[i] = num.count(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">if</span> count[i]:</span><br><span class="line">        print(i,count[i])</span><br><span class="line"></span><br><span class="line">lst = <span class="built_in">list</span>(num)</span><br><span class="line">lst.reverse()</span><br><span class="line">print(lst)</span><br></pre></td></tr></table></figure>
<h2 id="输入5个数字，打印每个数字的位数，-将这些数字排序打印，要求升序打印"><a href="#输入5个数字，打印每个数字的位数，-将这些数字排序打印，要求升序打印" class="headerlink" title="输入5个数字，打印每个数字的位数， 将这些数字排序打印，要求升序打印"></a>输入5个数字，打印每个数字的位数， 将这些数字排序打印，要求升序打印</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">lst = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    m = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>).strip().lstrip(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    print(<span class="string">&quot;这是&#123;&#125;位数&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(m)))</span><br><span class="line">    lst.append(<span class="built_in">int</span>(m))</span><br><span class="line">print(<span class="built_in">sorted</span>(lst))</span><br></pre></td></tr></table></figure>
<h2 id="字符串格式化-1"><a href="#字符串格式化-1" class="headerlink" title="字符串格式化"></a>字符串格式化</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: <span class="string">&quot;I am %-5d&quot;</span> % (<span class="number">20</span>,)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="string">&#x27;I am 20   &#x27;</span></span><br><span class="line">In [<span class="number">11</span>]: <span class="string">&quot;I am %-5d&quot;</span> % (<span class="number">20202</span>,)</span><br><span class="line">Out[<span class="number">11</span>]: <span class="string">&#x27;I am 20202&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h2><ol>
<li>判断是几位数</li>
<li>打印每位数字及其重复的次数</li>
<li>依次打印每一位数字，顺序个、十、百、千、万位</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">32</span>]: num = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">33</span>]: <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    ...:     num = <span class="built_in">input</span>(<span class="string">&#x27;Input a positive number &gt;&gt;&gt;&#x27;</span>).strip().lstrip(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    ...:     <span class="keyword">if</span> num.isdigit():</span><br><span class="line">    ...:         <span class="keyword">break</span></span><br><span class="line">    ...:</span><br><span class="line">Input a positive number &gt;&gt;&gt;<span class="number">111</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">34</span>]: print(<span class="string">&quot;The length of &#123;&#125; is &#123;&#125;.&quot;</span>.<span class="built_in">format</span>(num,<span class="built_in">len</span>(num)))</span><br><span class="line">The length of <span class="number">111</span> <span class="keyword">is</span> <span class="number">3.</span></span><br></pre></td></tr></table></figure>
<p>倒序打印1</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">36</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num),<span class="number">0</span>,<span class="number">-1</span>):</span><br><span class="line">    ...:     print(num[i<span class="number">-1</span>],end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    ...: print()</span><br><span class="line"><span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">9</span> <span class="number">1</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>倒序打印2 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">37</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(num):</span><br><span class="line">    ...:     print(i,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    ...: print()</span><br><span class="line"><span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">9</span> <span class="number">1</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>负索引方式打印</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">38</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num)):</span><br><span class="line">    ...:     print(num[-i<span class="number">-1</span>],end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    ...: print()</span><br><span class="line"><span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">9</span> <span class="number">1</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>判断0-9的数字在字符中出现的次数，每一次迭代都是用的count,都是0(n)问题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">57</span>]: num = <span class="string">&#x27;1912334&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">58</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    ...:     counter[i] = num.count(<span class="built_in">str</span>(i))</span><br><span class="line">    ...:     <span class="keyword">if</span> counter[i]:</span><br><span class="line">    ...:         print(<span class="string">&quot;The count of &#123;&#125; is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i,counter[i]))</span><br><span class="line">    ...:</span><br><span class="line">The count of <span class="number">1</span> <span class="keyword">is</span> <span class="number">2</span></span><br><span class="line">The count of <span class="number">2</span> <span class="keyword">is</span> <span class="number">1</span></span><br><span class="line">The count of <span class="number">3</span> <span class="keyword">is</span> <span class="number">2</span></span><br><span class="line">The count of <span class="number">4</span> <span class="keyword">is</span> <span class="number">1</span></span><br><span class="line">The count of <span class="number">9</span> <span class="keyword">is</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>失代字符串本身的字符</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">67</span>]: num = <span class="string">&#x27;1912334&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">68</span>]: counter = [<span class="number">0</span>]*<span class="number">10</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">69</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> num:</span><br><span class="line">    ...:     i = <span class="built_in">int</span>(x)</span><br><span class="line">    ...:     <span class="keyword">if</span> counter[i] == <span class="number">0</span>:</span><br><span class="line">    ...:         counter[i] = num.count(x)</span><br><span class="line">    ...:         print(<span class="string">&quot;The count of &#123;&#125; is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(x,counter[i]))</span><br><span class="line">The count of <span class="number">1</span> <span class="keyword">is</span> <span class="number">2</span></span><br><span class="line">The count of <span class="number">9</span> <span class="keyword">is</span> <span class="number">1</span></span><br><span class="line">The count of <span class="number">2</span> <span class="keyword">is</span> <span class="number">1</span></span><br><span class="line">The count of <span class="number">3</span> <span class="keyword">is</span> <span class="number">2</span></span><br><span class="line">The count of <span class="number">4</span> <span class="keyword">is</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>bytes 定义</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="built_in">bytes</span>(<span class="string">&quot;abc&quot;</span>,<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">Out[<span class="number">2</span>]: <span class="string">b&#x27;abc&#x27;</span></span><br><span class="line">In [<span class="number">3</span>]: <span class="string">&quot;abc&quot;</span>.encode()</span><br><span class="line">Out[<span class="number">3</span>]: <span class="string">b&#x27;abc&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="线性结构"><a href="#线性结构" class="headerlink" title="线性结构"></a>线性结构</h2><p>线性结构</p>
<ul>
<li>可抚迭代for  … in </li>
<li>len() 可以获取长度</li>
<li>通过下标可以访问</li>
<li>可以切片</li>
<li>如列表、元组、字符串、bytes、bytearry</li>
</ul>
<h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[<span class="number">4</span>:<span class="number">10</span>]</span><br><span class="line">Out[<span class="number">1</span>]: <span class="string">&#x27;asjin.&#x27;</span></span><br><span class="line">In [<span class="number">2</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[<span class="number">4</span>:<span class="number">9</span>]</span><br><span class="line">Out[<span class="number">2</span>]: <span class="string">&#x27;asjin&#x27;</span></span><br><span class="line">In [<span class="number">3</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[:<span class="number">9</span>]</span><br><span class="line">Out[<span class="number">3</span>]: <span class="string">&#x27;www.asjin&#x27;</span></span><br><span class="line">In [<span class="number">4</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[<span class="number">4</span>:]</span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">&#x27;asjin.com&#x27;</span></span><br><span class="line">In [<span class="number">5</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[:]</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span></span><br><span class="line">In [<span class="number">6</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[:<span class="number">-1</span>]</span><br><span class="line">Out[<span class="number">6</span>]: <span class="string">&#x27;www.asjin.co&#x27;</span></span><br><span class="line">In [<span class="number">7</span>]: <span class="string">&#x27;www.asjin.com&#x27;</span>[<span class="number">4</span>:<span class="number">-4</span>]</span><br><span class="line">Out[<span class="number">7</span>]: <span class="string">&#x27;asjin&#x27;</span></span><br></pre></td></tr></table></figure>
<p>补充for<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">15</span>]: <span class="keyword">for</span> j, i <span class="keyword">in</span> <span class="built_in">enumerate</span>([<span class="string">&#x27;jen&#x27;</span>, <span class="string">&#x27;bb&#x27;</span>,<span class="string">&#x27;eee&#x27;</span>]):</span><br><span class="line">    ...:     print(j,i)</span><br><span class="line"><span class="number">0</span> jen</span><br><span class="line"><span class="number">1</span> bb</span><br><span class="line"><span class="number">2</span> eee  </span><br></pre></td></tr></table></figure></p>
<h2 id="解构"><a href="#解构" class="headerlink" title="解构"></a>解构</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: test,*te,test2 = <span class="string">&quot;bbcccefsdde&quot;</span></span><br><span class="line">In [<span class="number">5</span>]: test</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">&#x27;b&#x27;</span></span><br><span class="line">In [<span class="number">6</span>]: te</span><br><span class="line">Out[<span class="number">6</span>]: [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]</span><br><span class="line">In [<span class="number">7</span>]: test2</span><br><span class="line">Out[<span class="number">7</span>]: <span class="string">&#x27;e&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">24</span>]: lst = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>,<span class="number">2</span>))</span><br><span class="line">In [<span class="number">25</span>]: head,*_,tail = lst</span><br><span class="line">In [<span class="number">26</span>]: head,tail</span><br><span class="line">Out[<span class="number">26</span>]: (<span class="number">1</span>, <span class="number">99</span>)</span><br></pre></td></tr></table></figure>
<p>_是合法的标识符，看到下划线就知道这个变量就是不想被使用</p>
<p>取其中的元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: lst = [<span class="number">1</span>,(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>),<span class="number">5</span>]</span><br><span class="line">In [<span class="number">5</span>]: _,(*_,a),_ = lst</span><br><span class="line">In [<span class="number">6</span>]: a</span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>取JAVA_HOME 和  PATH<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">7</span>]: s = <span class="string">&#x27;JAVA_HOME=/usr/bin&#x27;</span></span><br><span class="line">In [<span class="number">8</span>]: s.partition(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">Out[<span class="number">8</span>]: (<span class="string">&#x27;JAVA_HOME&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;/usr/bin&#x27;</span>)</span><br><span class="line">In [<span class="number">9</span>]: name,_,path=s.partition(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">In [<span class="number">10</span>]: name,path</span><br><span class="line">Out[<span class="number">10</span>]: (<span class="string">&#x27;JAVA_HOME&#x27;</span>, <span class="string">&#x27;/usr/bin&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">12</span>]: s = <span class="string">&#x27;JAVA_HOME=/usr/bin&#x27;</span></span><br><span class="line">In [<span class="number">13</span>]: name,path = s.split(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">In [<span class="number">14</span>]: print(name,path)</span><br><span class="line">JAVA_HOME /usr/<span class="built_in">bin</span></span><br></pre></td></tr></table></figure>
<h2 id="数字统计"><a href="#数字统计" class="headerlink" title="数字统计"></a>数字统计</h2><p>随机产生10个数字<br>要求:<br>每个数字取值范围[1,20]<br>统计重复的数字有几个？分别是什么？<br>统计不重复的数字有几个？ 分别是什么？</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">nums = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    nums.append(random.randrange(<span class="number">21</span>))</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Origin numbers = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(nums))</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line">length = <span class="built_in">len</span>(nums)</span><br><span class="line">samenums = [] <span class="comment"># 记录相同的数字</span></span><br><span class="line">diffnums = [] <span class="comment"># 记录不同的数字</span></span><br><span class="line">states = [<span class="number">0</span>] * length <span class="comment"># 记录不同的索引异同状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">    flag = <span class="literal">False</span> <span class="comment"># 假设没有重复</span></span><br><span class="line">    <span class="keyword">if</span> states[i] == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i+<span class="number">1</span>,length):</span><br><span class="line">        <span class="keyword">if</span> states[j] == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> nums[i] == nums[j]:</span><br><span class="line">            flag = <span class="literal">True</span></span><br><span class="line">            states[j] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> flag: <span class="comment"># 有重复</span></span><br><span class="line">        samenums.append(nums[i])</span><br><span class="line">        states[i] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        diffnums.append(nums[i])</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;Same numbers = &#123;1&#125;, counter = &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(samenums), samenums))</span><br><span class="line">print(<span class="string">&quot;Different numbers = &#123;1&#125;, Counter = &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(diffnums),diffnums))</span><br><span class="line">print(<span class="built_in">list</span>(<span class="built_in">zip</span>(states,nums)))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Same numbers = [<span class="number">8</span>, <span class="number">20</span>], counter = <span class="number">2</span></span><br><span class="line">Different numbers = [<span class="number">19</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">16</span>], Counter = <span class="number">6</span></span><br><span class="line">[(<span class="number">0</span>, <span class="number">19</span>), (<span class="number">0</span>, <span class="number">5</span>), (<span class="number">0</span>, <span class="number">10</span>), (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">1</span>, <span class="number">20</span>), (<span class="number">1</span>, <span class="number">20</span>), (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">0</span>, <span class="number">9</span>), (<span class="number">1</span>, <span class="number">8</span>), (<span class="number">0</span>, <span class="number">16</span>)]</span><br></pre></td></tr></table></figure>
<h2 id="set-定义-初始化"><a href="#set-定义-初始化" class="headerlink" title="set 定义 初始化"></a>set 定义 初始化</h2><ul>
<li>约定</li>
<li>set 翻译为集合</li>
<li>collection 翻译为集合类型，是一个大概念<br><code>set</code> <strong>可变的</strong>、 <strong>无序的</strong> 、 <strong>不重复的</strong> 元素集合</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: s2 = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">In [<span class="number">5</span>]: s2</span><br><span class="line">Out[<span class="number">5</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">In [<span class="number">9</span>]: s6=&#123;<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>&#125;</span><br><span class="line">In [<span class="number">10</span>]: s6</span><br><span class="line">Out[<span class="number">10</span>]: &#123;<span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>&#125;</span><br><span class="line">In [<span class="number">14</span>]: s7</span><br><span class="line">Out[<span class="number">14</span>]: &#123;(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>, <span class="string">&#x27;a&#x27;</span>&#125;</span><br><span class="line">In [<span class="number">15</span>]: s2 = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">In [<span class="number">16</span>]: s2.add(<span class="number">5</span>)</span><br><span class="line">In [<span class="number">17</span>]: s2</span><br><span class="line">Out[<span class="number">17</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>
<p>集合运算, 反单个集合合并到当前集合<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">19</span>]: s2</span><br><span class="line">Out[<span class="number">19</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;</span><br><span class="line">In [<span class="number">20</span>]: s2.update(&#123;<span class="number">2</span>,<span class="number">10</span>,<span class="number">3</span>&#125;)</span><br><span class="line">In [<span class="number">21</span>]: s2</span><br><span class="line">Out[<span class="number">21</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>&#125;</span><br></pre></td></tr></table></figure><br>移除一个元素<br><code>remove(elem)</code></p>
<ul>
<li>从set  中移除一个元素</li>
<li>如果元素不存在，抛出KeyError异常<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">21</span>]: s2</span><br><span class="line">Out[<span class="number">21</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>&#125;</span><br><span class="line">In [<span class="number">22</span>]: s2.remove(<span class="number">2</span>)</span><br><span class="line">In [<span class="number">23</span>]: s2</span><br><span class="line">Out[<span class="number">23</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>&#125;</span><br></pre></td></tr></table></figure>
<code>discard(elem)</code></li>
<li>从set 中移除一个元素，和remove() 类似，只是不报错。</li>
<li>元素不存在，什么都不做<br><code>pop()-&gt;item</code></li>
<li>移除并返回任意的元素</li>
<li>空集返回KeyError异常<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">23</span>]: s2</span><br><span class="line">Out[<span class="number">23</span>]: &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>&#125;</span><br><span class="line">In [<span class="number">25</span>]: s2.pop()</span><br><span class="line">Out[<span class="number">25</span>]: <span class="number">0</span></span><br><span class="line">In [<span class="number">26</span>]: s2</span><br><span class="line">Out[<span class="number">26</span>]: &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">10</span>&#125; <span class="comment"># 随机挑一个</span></span><br></pre></td></tr></table></figure>
<code>clear()</code></li>
<li>移除所有元素</li>
</ul>
<p>set 成员运算与效率</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># list</span></span><br><span class="line">In [<span class="number">27</span>]: %%timeit lst1 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">100</span>))</span><br><span class="line">    ...: a = <span class="number">-1</span> <span class="keyword">in</span> lst1</span><br><span class="line"><span class="number">1.53</span> µs ± <span class="number">67</span> ns per loop (mean ± std. dev. of <span class="number">7</span> runs, <span class="number">1000000</span> loops each)</span><br><span class="line">In [<span class="number">28</span>]: %%timeit lst1 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">100000</span>))</span><br><span class="line">    ...: a = <span class="number">-1</span> <span class="keyword">in</span> lst1</span><br><span class="line"><span class="number">1.55</span> ms ± <span class="number">98.3</span> µs per loop (mean ± std. dev. of <span class="number">7</span> runs, <span class="number">1000</span> loops each)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># set </span></span><br><span class="line">In [<span class="number">29</span>]: %%timeit set1 = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">100</span>))</span><br><span class="line">    ...: a = <span class="number">-1</span> <span class="keyword">in</span> set1</span><br><span class="line"><span class="number">38.3</span> ns ± <span class="number">5.97</span> ns per loop (mean ± std. dev. of <span class="number">7</span> runs, <span class="number">10000000</span> loops each)</span><br><span class="line"></span><br><span class="line">In [<span class="number">30</span>]: %%timeit set1 = <span class="built_in">set</span>(<span class="built_in">range</span>(<span class="number">100000</span>))</span><br><span class="line">    ...: a = <span class="number">-1</span> <span class="keyword">in</span> set1</span><br><span class="line"><span class="number">37</span> ns ± <span class="number">7.05</span> ns per loop (mean ± std. dev. of <span class="number">7</span> runs, <span class="number">10000000</span> loops each)</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>sge linux高性能集群的搭建与使用</title>
    <url>/2019/11/12/sge%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="sge高性能集群的搭建与使用"><a href="#sge高性能集群的搭建与使用" class="headerlink" title="sge高性能集群的搭建与使用"></a>sge高性能集群的搭建与使用</h1><p><img src="/images/sge.jpg" class="lazyload" data-srcset="/images/sge.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="集群环境的准备"><a href="#集群环境的准备" class="headerlink" title="集群环境的准备"></a>集群环境的准备</h2><table>
<thead>
<tr>
<th>Node1(master)</th>
<th>CentOS7.4</th>
<th>iptables/selinux(off)</th>
<th>IP:10.180.66.11</th>
<th>hostname:node1</th>
<th>ali yum源</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node2(slave)</td>
<td>CentOS7.4</td>
<td>iptables/selinux(off)</td>
<td>IP:10.180.66.12</td>
<td>hostname:node2</td>
<td>ali yum源</td>
</tr>
<tr>
<td>Node3(slave)</td>
<td>CentOS7.4</td>
<td>iptables/selinux(off)</td>
<td>IP:10.180.66.13</td>
<td>hostname:node3</td>
<td>ali yum源</td>
</tr>
<tr>
<td>Node4(slave)</td>
<td>CentOS7.4</td>
<td>iptables/selinux(off)</td>
<td>IP:10.180.66.14</td>
<td>hostname:node4</td>
<td>ali yum源</td>
</tr>
<tr>
<td>Node5(slave)</td>
<td>CentOS7.4</td>
<td>iptables/selinux(off)</td>
<td>IP:10.180.66.15</td>
<td>hostname:node5</td>
<td>ali yum源</td>
</tr>
</tbody>
</table>
<h2 id="master-节点安装"><a href="#master-节点安装" class="headerlink" title="master 节点安装"></a>master 节点安装</h2><h3 id="安装相关依赖包"><a href="#安装相关依赖包" class="headerlink" title="安装相关依赖包"></a>安装相关依赖包</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install jemalloc-devel openssl-devel ncurses-devel pam-devel libXmu-devel hwloc-devel hwloc hwloc-libs java-devel javacc ant-junit libdb-devel motif-devel csh ksh xterm db4-utils perl-XML-Simple perl-Env xorg-x11-fonts-ISO8859-1-100dpi xorg-x11-fonts-ISO8859-1-75dpi</span><br></pre></td></tr></table></figure>
<h3 id="新建sge管理员用户"><a href="#新建sge管理员用户" class="headerlink" title="新建sge管理员用户"></a>新建sge管理员用户</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  groupadd -g 490 sgeadmin</span><br><span class="line"># useradd -u 495 -g 490 -r -m  -d &#x2F;home&#x2F;sgeadmin -s &#x2F;bin&#x2F;bash -c &quot;SGE Admin&quot; sgeadmin</span><br><span class="line"># sed -i &#39;&#x2F;^%wheel&#x2F;a\%sgeadmin       ALL&#x3D;(ALL)       NOPASSWD: ALL&#39; &#x2F;etc&#x2F;sudoers</span><br></pre></td></tr></table></figure>
<h3 id="安装sge"><a href="#安装sge" class="headerlink" title="安装sge"></a>安装sge</h3><p><a href="https://pan.baidu.com/s/1GDxo7sKDrr1BcIdERgNU1w">sge 链接</a>  密码:c7hy</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/src/</span></span><br><span class="line"><span class="comment"># tar -xvf ge2011.11.tar.gz</span></span><br><span class="line"><span class="comment"># mkdir -pv /data</span></span><br><span class="line"><span class="comment"># cp -a ge2011.11 /data/sge</span></span><br><span class="line"><span class="comment"># chown sgeadmin.sgeadmin /data/sge</span></span><br></pre></td></tr></table></figure>
<p><strong> qmaster 安装自动回答脚本，依赖软件包<code>expect</code>, 所有节点都需要安装 </strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /data/sge/</span></span><br><span class="line"><span class="comment"># vim master.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">user=<span class="string">&quot;sgeadmin&quot;</span></span><br><span class="line">/usr/bin/expect &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">spawn ./install_qmaster</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;y</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;n</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect eof</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># sh  master.sh</span></span><br></pre></td></tr></table></figure>
<p>修改主节点环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export SGE_ROOT=/data/sge</span></span><br><span class="line"><span class="comment"># echo &#x27;export SGE_ROOT=/data/sge&#x27; &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="comment"># echo &#x27;PATH=$PATH:/data/sge/bin/linux-x64/:/data/sge/bin/&#x27; &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="comment"># cp /data/sge/default/common/settings.sh  /etc/profile.d/</span></span><br><span class="line"><span class="comment"># sh /etc/profile.d/settings.sh</span></span><br><span class="line"><span class="comment"># source  /etc/profile</span></span><br></pre></td></tr></table></figure>
<p>添加节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># qconf -ah node1</span></span><br><span class="line"><span class="comment"># qconf -ah node2</span></span><br><span class="line"><span class="comment"># qconf -ah node3</span></span><br><span class="line"><span class="comment"># qconf -ah node4</span></span><br><span class="line"><span class="comment"># qconf -ah node5</span></span><br></pre></td></tr></table></figure>
<h3 id="master-服务器搭建-nfs-服务"><a href="#master-服务器搭建-nfs-服务" class="headerlink" title="master 服务器搭建 nfs 服务"></a>master 服务器搭建 nfs 服务</h3><p>所有节点都需要安装<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install nfs-utils</span></span><br></pre></td></tr></table></figure><br>master节点操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/sge 10.180.66.0/24(rw,sync)</span><br><span class="line"><span class="comment"># systemctl restart nfs</span></span><br></pre></td></tr></table></figure>
<h3 id="slave-节点挂载"><a href="#slave-节点挂载" class="headerlink" title="slave 节点挂载"></a>slave 节点挂载</h3><p>(node2,node3,node4,node5)执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir  /data/sge -pv</span></span><br><span class="line"><span class="comment"># mount -t nfs 10.180.66.11:/data/sge /data/sge/</span></span><br><span class="line"><span class="comment"># chown sgeadmin.sgeadmin /data/</span></span><br></pre></td></tr></table></figure>
<h3 id="slave-服务器安装sgeexecd"><a href="#slave-服务器安装sgeexecd" class="headerlink" title="slave 服务器安装sgeexecd"></a>slave 服务器安装sgeexecd</h3><p>(node2,node3,node4,node5) 执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install hwloc-devel</span></span><br><span class="line"><span class="comment"># useradd -u 495 -g 490 -r -m  -d /home/sgeadmin -s /bin/bash -c &quot;SGE Admin&quot; sgeadmin</span></span><br><span class="line"><span class="comment"># sed -i &#x27;/^%wheel/a\%sgeadmin       ALL=(ALL)       NOPASSWD: ALL&#x27; /etc/sudoers</span></span><br></pre></td></tr></table></figure>
<p>生效环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo &#x27;export SGE_ROOT=/data/sge&#x27; &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="comment"># echo &#x27;PATH=$PATH:/data/sge/bin/linux-x64/:/data/sge/bin/&#x27; &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="comment"># echo &#x27;export SGE_CELL=default&#x27; &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="comment"># cp /data/sge/default/common/settings.sh /etc/profile.d/ -a</span></span><br><span class="line"><span class="comment"># source ~/.bashrc</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>
<p>进行安装，所有节点都执行此脚本<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim slave.sh</span></span><br><span class="line"><span class="comment"># cat slave.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">user=<span class="string">&quot;sgeadmin&quot;</span></span><br><span class="line">/usr/bin/expect &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">spawn  ./install_execd</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect &quot;*&gt;&gt;&quot;</span></span><br><span class="line"><span class="string">send &quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">expect eof</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># sh slave.sh</span></span><br></pre></td></tr></table></figure></p>
<h2 id="完成集群搭建"><a href="#完成集群搭建" class="headerlink" title="完成集群搭建"></a>完成集群搭建</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># qhost</span></span><br><span class="line">HOSTNAME                ARCH         NCPU  LOAD  MEMTOT  MEMUSE  SWAPTO  SWAPUS</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">global                  -               -     -       -       -       -       -</span><br><span class="line">node1                   linux-x64       1  0.01  968.3M  193.0M    2.0G   64.0K</span><br><span class="line">node2                   linux-x64       1  0.01  976.3M  151.0M    2.0G     0.0</span><br><span class="line">node3                   linux-x64       1  0.02  978.3M  152.2M    2.0G   84.0K</span><br><span class="line">node4                   linux-x64       1  0.02  976.3M  155.4M    2.0G     0.0</span><br><span class="line">node5                   linux-x64       1  0.01  978.3M  148.5M    2.0G   84.0K</span><br></pre></td></tr></table></figure>
<h1 id="sge集群的使用"><a href="#sge集群的使用" class="headerlink" title="sge集群的使用"></a>sge集群的使用</h1>]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>kvm学习笔记</title>
    <url>/2019/08/28/kvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kvm-学习笔记"><a href="#kvm-学习笔记" class="headerlink" title="kvm 学习笔记"></a>kvm 学习笔记</h1><p><img src="/images/kvm_study.png" class="lazyload" data-srcset="/images/kvm_study.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="kvm相关知识梳理"><a href="#kvm相关知识梳理" class="headerlink" title="kvm相关知识梳理"></a>kvm相关知识梳理</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">KVM: kernel-based Virtual Machine, Qumranet 公司，依赖于HVM: Intel VT-x, ADM  ADM-V:</span><br><span class="line">KVM模块载入后的系统的运行模式:</span><br><span class="line">    内核模式: GuestOS执行I&#x2F;O类操作，或其它的特殊指令的操作：称作“来宾-内核”模式;</span><br><span class="line">    用户模式: 代表GuestOS请求I&#x2F;O类操作，宿主机用户模式;</span><br><span class="line">    来宾模式: GuestOS的非I&#x2F;O类操作；事实上，它被称为“来宾-用户”模式。</span><br><span class="line">    kvm hypervisor:</span><br><span class="line">KVM的组件:</span><br><span class="line">    &#x2F;dev&#x2F;kvm: 工作于hypervisor,在用户空间，可通过ioctl()系统调用来完成VM创建、启动管理功能；它是一个字符设备，功能: 创建VM、为VM分配内存、读写VCPU的寄存器、向VCPU注入中断、运行VCPU等等;</span><br><span class="line">    qemu进程: 工作于用户空间，主要用于实现模拟PC机的IO设备;</span><br><span class="line">KVM特性:</span><br><span class="line">    内存管理: </span><br><span class="line">    将分配给VM的内存交换至SWAP;</span><br><span class="line">    支持使用Huge Page;</span><br><span class="line">    支持使用Intel EPT或AMD RVI技术完成内存地址映射; GVA--&gt; GPA --&gt;HPA</span><br><span class="line">    支持KSM(Kernel Same-page Merging)</span><br><span class="line">硬件支持: </span><br><span class="line">    取决于Linux内核</span><br><span class="line">存储:</span><br><span class="line">    本地存储:</span><br><span class="line">    网络附加存储:</span><br><span class="line">    存储区域名网络</span><br><span class="line">    分布式存储: 例如GlustFS</span><br><span class="line">实时迁移:</span><br><span class="line">    实时迁移:</span><br><span class="line">    支持的GuestOS:</span><br><span class="line">        Linux, Windows, OpenBSD, FreeBSD, OpenSolaris;</span><br><span class="line">    设备驱动：</span><br><span class="line">        IO设备的完全虚拟化: 模拟硬件</span><br><span class="line">        IO设备的半虚拟化: 在GuestOS中安装驱动: virtio </span><br><span class="line">            virtio-blk, virtio-net, virtio-pci,virtio-console, virtio-ballon</span><br><span class="line">KVM局限性:</span><br><span class="line">    一般局限性:</span><br><span class="line">             CPU overcommit</span><br><span class="line">            时间记录难以精确，依赖于时间同步机制</span><br><span class="line">    MAC地址:</span><br><span class="line">            VM量特别大时，存在冲突的可能性;</span><br><span class="line">            实时迁移:</span><br><span class="line">            性能局限性:</span><br><span class="line">KVM的工具栈</span><br><span class="line">    qemu:</span><br><span class="line">        qemu-kvm</span><br><span class="line">        qemu-img</span><br><span class="line">    libvirt</span><br><span class="line">        GUI: virt-manager, virt-viewer</span><br><span class="line">        CLI: virt-install, virsh </span><br><span class="line">    QEMU主要用到以下几个部分:</span><br><span class="line">        处理器模拟器</span><br><span class="line">        仿真IO设备</span><br><span class="line">        关联模拟的设备至真实设备;</span><br><span class="line">        调试器</span><br><span class="line">        与模拟器交互的用户接口</span><br></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>1、确保CPU支持HVM<br>    <code># grep -E --color=auto &quot;(vmx|svm)&quot; /proc/cpuinfo</code><br>2、装载模块<br>    <code># modeprobe kvm</code><br>    <code># modeprobe kvm-intel</code><br>3、验证 <code>/dev/kvm</code></p>
<h2 id="管理工具栈"><a href="#管理工具栈" class="headerlink" title="管理工具栈"></a>管理工具栈</h2><p>qemu-kvm<br>libvirt<br>管理kvm虚拟的方案:<br>    <code>qemu: /usr/libexec/</code><br>    安装工具:<br>    <code>libvirt: virt-install virt-manager</code><br>    管理工具:<br>    <code>virsh virt-manager virt-viewer  VM Platform</code><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum install qemu-kvm</span><br><span class="line"># ln -sv &#x2F;usr&#x2F;libexec&#x2F;qemu-kvm  &#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">命令选项 </span><br><span class="line">    标准选项:</span><br><span class="line">    显示选项:</span><br><span class="line">    块设备选项:</span><br><span class="line">    i386平台专用选项:</span><br><span class="line">    字符设备选项:</span><br><span class="line">    蓝牙设备选项:</span><br><span class="line">    Linux 启动专用选项:</span><br><span class="line">    调试&#x2F;专家模式选项:</span><br></pre></td></tr></table></figure></p>
<hr>
<p>补充资料: KVM内存管理<br>KVM继承了Linux系统管理内存的诸多特性，比如，分配给虚拟使用的内存可以被交换至交换空间、能够使用大内存页以实现更的好的性能，以及对NUMA的支持能够让虚拟机高效访问更大的内存空间等。  </p>
<p>KVM基于Intel的EPT(Extended Page Table) 或AMD的 RVI(Rapid Virtualization Indexing) 技术可以支持更新的内存虚拟功能，这可以降低CPU的占用率，并提供较好的吞吐量。</p>
<p>此外，KVM还借助于KSM(kernel Same-page Merging) 这个内核特性实现了内存页面共享，KSM通过扫描每个虚拟机的内存查找各虚拟机间相同的页面，并将这些内存页合并为一个被各相关虚拟机共享的单独页面。在某虚拟机试图修改此页面中的数据时，KSM会重新为其提供 一个新的页面副本。实践中，运行于同一个物理主机的具有相同GuestOS的虚拟机之间出现相同内存页面的概率是很高的，比如共享库，内核或其它内存对象等都有可能表现为机同的页面，因此，KSM技术可以降低内存占用进而提高整体性能。</p>
<hr>
<p>补充资料:<br>    VMM: 对IO的驱动有三种模式:<br>        自主VMM: VMM 自行提供驱动和控制台;<br>        混合VMM: 借助于OS提供驱动;<br>            依赖于外部OS实现特权域<br>            自我提供特权域<br>        寄宿式VMM:<br>    IO虚拟化模型:<br>        模拟<br>        半虚拟化<br>        透传</p>
<p>KVM：hvm<br>    kvm,</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    # modinfo kvm</span><br><span class="line">    # lsmod | grep kvm</span><br><span class="line">kvm_intel             170086  0</span><br><span class="line">kvm                   566340  1 kvm_intel</span><br><span class="line">irqbypass              13503  1 kvm</span><br></pre></td></tr></table></figure>
<h2 id="启动使用微缩版Linux"><a href="#启动使用微缩版Linux" class="headerlink" title="启动使用微缩版Linux"></a>启动使用微缩版Linux</h2><p>cirros project : 为cloud 环境测试vm提供的微缩版Linux:<br>启动第一个虚拟机:</p>
<p><a href="https://launchpad.net/cirros">cirros</a><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -m 128 -smp 2 -name &quot;test&quot; -hda &#x2F;images&#x2F;kvm&#x2F;cirros-0.3.4-x86_64-disk.img</span><br><span class="line">VNC server running on &#96;::1:5900&#39;</span><br></pre></td></tr></table></figure></p>
<p>安装tigervnc </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install tigervnc</span><br></pre></td></tr></table></figure>
<p><img src="/images/qemu-kvm-cirros.png" class="lazyload" data-srcset="/images/qemu-kvm-cirros.png" srcset="data:image/png;base64,666" alt=""></p>
<p>用-drive指定磁盘映像文件 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#   qemu-kvm -m 128 -name test -smp 2 -drive  file&#x3D;&#x2F;images&#x2F;kvm&#x2F;cirros-0.3.4-x86_64-disk.img,if&#x3D;virtio,media&#x3D;disk,cache&#x3D;writeback,fromat&#x3D;qcow2</span><br></pre></td></tr></table></figure>
<p>通过cdrom启动winxp的安装:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -name winxp -smp 4, sockets&#x3D;1,cores&#x3D;2,threads&#x3D;2 -m 512 -drive file&#x3D;&#x2F;images&#x2F;kvm&#x2F;winxp.img,if&#x3D;ide,media&#x3D;disk,cache&#x3D;writeback,format&#x3D;qcow2 -drive file&#x3D;&#x2F;root&#x2F;winxp_ghost.iso,media&#x3D;cdrom</span><br></pre></td></tr></table></figure>
<p>指定使用格拉网络接口:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -m 128 -name test -smp 2 -drive file&#x3D; &#x2F;images&#x2F;kvm&#x2F;cirros-0.3.4-x86_64-disk.img</span><br><span class="line">,if&#x3D;virtio,media&#x3D;disk,cache&#x3D;writeback,format&#x3D;qcow2 -net nic -net tap,script&#x3D;&#x2F;etc&#x2F;if-up,downscript&#x3D;no -nographic</span><br></pre></td></tr></table></figure>
<hr>
<p>qemu-kvm管理KVM虚拟机<br>Qemu是一个广泛使用的开源计算机仿真器和虚拟机。当作为仿真器时，可以在一种架构(如PC机)下运行另一个架构(如ARM)下的操作系统和程序，而通过动态转化，其可以获取很高的运行效率。当作为一个虚拟机时，qemu可以通过直接使用真机的系统资源，让虚拟系统能够获得接近于物理机的性能表现。qemu支持xen或者kvm模式下的虚拟化。当用kvm时，qemu可以虚拟x86、服务器和嵌入式powerpc，以及s390系统。</p>
<p>QEMU 当运行与主机架构相同的目标架构时可以使用KVM例如，当在一个x86兼容处理器上运行 qemu-system-x86时，可以利KVM加速一为宿主机和客户机提供更好的性能。</p>
<p>Qemu 有如下几个部组成:</p>
<ul>
<li>处理器模拟器(x86、PowerPC和Sparc)</li>
<li>仿真设备(显卡、网卡、硬盘、鼠标等)</li>
<li>用于将仿真设备连接至主机设备(真实设备)的通用设备;</li>
<li>虚拟机的描述信息;</li>
<li>调试器；</li>
<li>与模拟器交互的用户接口。</li>
</ul>
<p>使用qemu-kvm安装Guest<br>基于libvirt 的工具如virt-manager和virt-install提供了非常便捷的虚拟机管理接口，但它们事实上已经第二次开发后又封装了qemu-kvm的工具。因此，直接使用qemu-vkm命令也能够完成此前的任务。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -m 128 -cpu host -smp 2 -name &quot;test&quot; -drive file&#x3D;&#x2F;images&#x2F;kvm&#x2F;cirros-0.3.4-x86_64-disk.img,if&#x3D;virtio,media&#x3D;disk,format&#x3D;qcow2,cache&#x3D;writeback</span><br><span class="line"># qemu-img create -o size&#x3D;20G,preallocation&#x3D;metadata -f qcow2 &#x2F;images&#x2F;winxp.qcow2</span><br><span class="line"># qemu-kvm -m 512 -smp 2 -cpu  host -drive file&#x3D;&#x2F;images&#x2F;windows&#x2F;winxp.qcow2,media&#x3D;disk -drive file&#x3D;&#x2F;root&#x2F;winxp_ghost.iso,media&#x3D;cdrom --boot order&#x3D;dc, once&#x3D;d</span><br></pre></td></tr></table></figure>
<p>指定vnc 桌面，如指定桌面号为1 则启用端口为5901, 若指定桌面号为0，则启用端口为5900</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -m 128 -cpu host -smp 2 -name &quot;test&quot; -drive file&#x3D;&#x2F;images&#x2F;kvm&#x2F;cirros-0.3.4-x86_64-disk.img,if&#x3D;virtio,media&#x3D;disk,format&#x3D;qcow2,cache&#x3D;writeback -vnc 0.0.0.0:1</span><br></pre></td></tr></table></figure>
<p><img src="/images/qemu-kvm-vnc-all-port.png" class="lazyload" data-srcset="/images/qemu-kvm-vnc-all-port.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">qemu-kvm命令</span><br><span class="line"></span><br><span class="line">在RHEL6上，qemu-kvm位于&#x2F;usr&#x2F;libexec目录中。由于此目录不属于PATH环境变量，故无法直接使用，这样也阻止了可以直接使用qemu作为创建并管理虚拟机。如若想使用qemu虚拟机，可以通过将&#x2F;usr&#x2F;libexec&#x2F;qemu-kvm链接为&#x2F;usr&#x2F;bin&#x2F;qemu实现。</span><br><span class="line"></span><br><span class="line"># ln  -sv  &#x2F;usr&#x2F;lib&#x2F;exec&#x2F;qemu-kvm  &#x2F;usr&#x2F;bin&#x2F;qemu-kvm</span><br><span class="line"></span><br><span class="line">qemu-kvm命令使用格式为“qemu-kvm  [options]  [disk_image]”，其选项非常多，不过，大致可分为如下几类。</span><br><span class="line"></span><br><span class="line">👉🏾	标准选项；</span><br><span class="line">👉🏾	USB选项；</span><br><span class="line">👉🏾	显示选项；</span><br><span class="line">👉🏾	i386平台专用选项；</span><br><span class="line">👉🏾	网络选项；</span><br><span class="line">👉🏾	字符设备选项；</span><br><span class="line">👉🏾	蓝牙相关选项；</span><br><span class="line">👉🏾	Linux系统引导专用选项；</span><br><span class="line">👉🏾	调试&#x2F;专家模式选项；</span><br><span class="line">👉🏾	PowerPC专用选项；</span><br><span class="line">👉🏾	Sparc32专用选项；</span><br><span class="line"></span><br><span class="line">考虑到篇幅及使用需要，这里介绍的选项主要涉及到标准选项、显示选项、i386平台专用选项及Linux系统引导专用选项等相关的选项。</span><br><span class="line"></span><br><span class="line">qemu-kvm的标准选项</span><br><span class="line"></span><br><span class="line">qemu-kvm的标准选项主要涉及指定主机类型、CPU模式、NUMA、软驱设备、光驱设备及硬件设备等。</span><br><span class="line">👉🏾	-name name：设定虚拟机名称；</span><br><span class="line">👉🏾	-M machine：指定要模拟的主机类型，如Standard PC、ISA-only PC或Intel-Mac等，可以使用“qemu-kvm -M ?”获取所支持的所有类型；</span><br><span class="line">👉🏾	-m megs：设定虚拟机的RAM大小；</span><br><span class="line">👉🏾	-cpu model：设定CPU模型，如coreduo、qemu64等，可以使用“qemu-kvm -cpu ?”获取所支持的所有模型；</span><br><span class="line">👉🏾	-smp n[,cores&#x3D;cores][,threads&#x3D;threads][,sockets&#x3D;sockets][,maxcpus&#x3D;maxcpus]：设定模拟的SMP架构中CPU的个数等、每个CPU的核心数及CPU的socket数目等；PC机上最多可以模拟255颗CPU；maxcpus用于指定热插入的CPU个数上限；</span><br><span class="line">👉🏾	-numa opts：指定模拟多节点的numa设备；</span><br><span class="line">👉🏾	-fda file</span><br><span class="line">👉🏾	-fdb file：使用指定文件(file)作为软盘镜像，file为&#x2F;dev&#x2F;fd0表示使用物理软驱；</span><br><span class="line">👉🏾	-hda file</span><br><span class="line">👉🏾	-hdb file</span><br><span class="line">👉🏾	-hdc file</span><br><span class="line">👉🏾	-hdd file：使用指定file作为硬盘镜像；</span><br><span class="line">👉🏾	-cdrom file：使用指定file作为CD-ROM镜像，需要注意的是-cdrom和-hdc不能同时使用；将file指定为&#x2F;dev&#x2F;cdrom可以直接使用物理光驱；</span><br><span class="line">👉🏾	-drive option[,option[,option[,...]]]：定义一个硬盘设备；可用子选项有很多。</span><br><span class="line">👉🏾	file&#x3D;&#x2F;path&#x2F;to&#x2F;somefile：硬件映像文件路径；</span><br><span class="line">👉🏾	if&#x3D;interface：指定硬盘设备所连接的接口类型，即控制器类型，如ide、scsi、sd、mtd、floppy、pflash及virtio等；</span><br><span class="line">👉🏾	index&#x3D;index：设定同一种控制器类型中不同设备的索引号，即标识号；</span><br><span class="line">👉🏾	media&#x3D;media：定义介质类型为硬盘(disk)还是光盘(cdrom)；</span><br><span class="line">👉🏾	snapshot&#x3D;snapshot：指定当前硬盘设备是否支持快照功能：on或off；</span><br><span class="line">👉🏾	cache&#x3D;cache：定义如何使用物理机缓存来访问块数据，其可用值有none、writeback、unsafe和writethrough四个；</span><br><span class="line">👉🏾	format&#x3D;format：指定映像文件的格式，具体格式可参见qemu-img命令；</span><br><span class="line">👉🏾	-boot [order&#x3D;drives][,once&#x3D;drives][,menu&#x3D;on|off]：定义启动设备的引导次序，每种设备使用一个字符表示；不同的架构所支持的设备及其表示字符不尽相同，在x86 PC架构上，a、b表示软驱、c表示第一块硬盘，d表示第一个光驱设备，n-p表示网络适配器；默认为硬盘设备；</span><br><span class="line">	-boot order&#x3D;dc,once&#x3D;d</span><br><span class="line"></span><br><span class="line">qemu-kvm的显示选项</span><br><span class="line"></span><br><span class="line">显示选项用于定义虚拟机启动后的显示接口相关类型及属性等。</span><br><span class="line"></span><br><span class="line">👉🏾	-nographic：默认情况下，qemu使用SDL来显示VGA输出；而此选项用于禁止图形接口，此时,qemu类似一个简单的命令行程序，其仿真串口设备将被重定向到控制台；</span><br><span class="line">👉🏾	-curses：禁止图形接口，并使用curses&#x2F;ncurses作为交互接口；</span><br><span class="line">👉🏾	-alt-grab：使用Ctrl+Alt+Shift组合键释放鼠标；</span><br><span class="line">👉🏾	-ctrl-grab：使用右Ctrl键释放鼠标；</span><br><span class="line">👉🏾	-sdl：启用SDL；</span><br><span class="line">👉🏾	-spice option[,option[,...]]：启用spice远程桌面协议；其有许多子选项，具体请参照qemu-kvm的手册；</span><br><span class="line">👉🏾	-vga type：指定要仿真的VGA接口类型，常见类型有：</span><br><span class="line">👉🏾	cirrus：Cirrus Logic GD5446显示卡；</span><br><span class="line">👉🏾	std：带有Bochs VBI扩展的标准VGA显示卡；</span><br><span class="line">👉🏾	vmware：VMWare SVGA-II兼容的显示适配器；</span><br><span class="line">👉🏾	qxl：QXL半虚拟化显示卡；与VGA兼容；在Guest中安装qxl驱动后能以很好的方式工作，在使用spice协议时推荐使用此类型；</span><br><span class="line">👉🏾	none：禁用VGA卡；</span><br><span class="line">👉🏾	-vnc display[,option[,option[,...]]]：默认情况下，qemu使用SDL显示VGA输出；使用-vnc选项，可以让qemu监听在VNC上，并将VGA输出重定向至VNC会话；使用此选项时，必须使用-k选项指定键盘布局类型；其有许多子选项，具体请参照qemu-kvm的手册；</span><br><span class="line"></span><br><span class="line">	display:</span><br><span class="line">		（1）host:N</span><br><span class="line">			172.16.100.7:1, 监听于172.16.100.7主的5900+N的端口上</span><br><span class="line">		(2) unix:&#x2F;path&#x2F;to&#x2F;socket_file</span><br><span class="line">		(3) none</span><br><span class="line">	options:</span><br><span class="line">		password: 连接时需要验正密码；设定密码通过monitor接口使用change</span><br><span class="line">		reverse: “反向”连接至某处于监听状态的vncview上；</span><br><span class="line">	-monitor stdio：表示在标准输入输出上显示monitor界面</span><br><span class="line">	-nographic</span><br><span class="line">		Ctrl-a, c: 在console和monitor之间切换</span><br><span class="line">		Ctrl-a, h: 显示帮助信息</span><br><span class="line">SDL: Simple Directmedia Layer</span><br><span class="line">VNC: Virtual Network Computing，基于RFB</span><br></pre></td></tr></table></figure>
<p><code># rpm -ql bridge-utils</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># brctl addbr br0</span><br><span class="line"># brctl stp br0 off</span><br><span class="line"># brctl delbr br0</span><br><span class="line"># brctl show</span><br><span class="line"># ip link set dev br0 down</span><br><span class="line"># ip link set dev br0 up</span><br><span class="line"># ip link show</span><br><span class="line"># 临时生效</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># nmtui</span><br><span class="line"># nmcli</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -net nic,model&#x3D;?</span><br><span class="line">qemu: Supported NIC models: ne2k_pci,i82551,i82557b,i82559er,rtl8139,e1000,pcnet,virtio</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">网络属性相关选项</span><br><span class="line"></span><br><span class="line">网络属性相关选项用于定义网络设备接口类型及其相关的各属性等信息。这里只介绍nic、tap和user三种类型网络接口的属性，其它类型请参照qemu-kvm手册。</span><br><span class="line"></span><br><span class="line">👉🏾	-net nic[,vlan&#x3D;n][,macaddr&#x3D;mac][,model&#x3D;type][,name&#x3D;name][,addr&#x3D;addr][,vectors&#x3D;v]：创建一个新的网卡设备并连接至vlan n中；PC架构上默认的NIC为e1000，macaddr用于为其指定MAC地址，name用于指定一个在监控时显示的网上设备名称；emu可以模拟多个类型的网卡设备，如virtio、i82551、i82557b、i82559er、ne2k_isa、pcnet、rtl8139、e1000、smc91c111、lance及mcf_fec等；不过，不同平台架构上，其支持的类型可能只包含前述列表的一部分，可以使用“qemu-kvm -net nic,model&#x3D;?”来获取当前平台支持的类型；</span><br><span class="line">👉🏾	-net tap[,vlan&#x3D;n][,name&#x3D;name][,fd&#x3D;h][,ifname&#x3D;name][,script&#x3D;file][,downscript&#x3D;dfile]：通过物理机的TAP网络接口连接至vlan n中，使用script&#x3D;file指定的脚本(默认为&#x2F;etc&#x2F;qemu-ifup)来配置当前网络接口，并使用downscript&#x3D;file指定的脚本(默认为&#x2F;etc&#x2F;qemu-ifdown)来撤消接口配置；使用script&#x3D;no和downscript&#x3D;no可分别用来禁止执行脚本；</span><br><span class="line">注意: 默认mac 地址均为: 52:54:00:12:34:56，使用中需要手动指定。</span><br><span class="line">👉🏾	-net user[,option][,option][,...]：在用户模式配置网络栈，其不依赖于管理权限；有效选项有：</span><br><span class="line">👉🏾	vlan&#x3D;n：连接至vlan n，默认n&#x3D;0；</span><br><span class="line">👉🏾	name&#x3D;name：指定接口的显示名称，常用于监控模式中；</span><br><span class="line">👉🏾	net&#x3D;addr[&#x2F;mask]：设定GuestOS可见的IP网络，掩码可选，默认为10.0.2.0&#x2F;8；</span><br><span class="line">👉🏾	host&#x3D;addr：指定GuestOS中看到的物理机的IP地址，默认为指定网络中的第二个，即x.x.x.2；</span><br><span class="line">👉🏾	dhcpstart&#x3D;addr：指定DHCP服务地址池中16个地址的起始IP，默认为第16个至第31个，即x.x.x.16-x.x.x.31；</span><br><span class="line">👉🏾	dns&#x3D;addr：指定GuestOS可见的dns服务器地址；默认为GuestOS网络中的第三个地址，即x.x.x.3；</span><br><span class="line">👉🏾	tftp&#x3D;dir：激活内置的tftp服务器，并使用指定的dir作为tftp服务器的默认根目录；</span><br><span class="line">👉🏾	bootfile&#x3D;file：BOOTP文件名称，用于实现网络引导GuestOS；如：qemu -hda linux.img -boot n -net user,tftp&#x3D;&#x2F;tftpserver&#x2F;pub,bootfile&#x3D;&#x2F;pxelinux.0</span><br><span class="line"></span><br><span class="line">brctl addbr br0</span><br><span class="line">brctl addif br0 eth0</span><br><span class="line"></span><br><span class="line">brctl addbr br1</span><br></pre></td></tr></table></figure>
<p>kvm的网络模型:</p>
<p>1、隔离模型: 在host 创建一个vswitch (bridge device): 每个虚拟机的tap设备直接添加至vswitch上;<br>2、路由模型:激活tap,并将其加入到指定的bridge,给虚拟的brige添加地址，打开核心转发;<br>3、NAT模型:激活tap,并将其加入到指定的bridge; 额外: 打开核心转发，并添加到nat规则;<br>4、桥接模型:激活tap,并将其加入到指定的bridge;</p>
<p>安装示例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-kvm -name &quot;rhel5.8&quot; -m 512 \</span><br><span class="line">-smp 2 -boot d \</span><br><span class="line">-drive file&#x3D;&#x2F;VM&#x2F;images&#x2F;rhel5.8&#x2F;hda,if&#x3D;virtio,index&#x3D;0,media&#x3D;disk,format&#x3D;qcow2 \</span><br><span class="line">-drive file&#x3D;&#x2F;isos&#x2F;rhel-5.8.iso,index&#x3D;1,media&#x3D;cdrom \</span><br><span class="line">-net nic,model&#x3D;virtio,macaddr&#x3D;52:54:00:A5:41:1E \</span><br><span class="line">-vga cirrus -balloon virtio</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># qemu-img create &#x2F;images&#x2F;centos&#x2F;centos6.img -o size&#x3D;120G, preallocation&#x3D;metadata -f qcow2</span><br><span class="line"># qemu-kvm -m 512 -smp 2 -name centos -drive file&#x3D;&#x2F;images&#x2F;centos&#x2F;centos6.img,media&#x3D;disk,if&#x3D;virtio  -net nic,model&#x3D;virtio,macaddr&#x3D;52:54:00:55:31:18 -net tap,ifname&#x3D;centos6.0,script&#x3D;&#x2F;etc&#x2F;qemu-ifup -boot order&#x3D;nc, once&#x3D;n </span><br></pre></td></tr></table></figure>
<h2 id="libvirt-工具栈"><a href="#libvirt-工具栈" class="headerlink" title="libvirt 工具栈"></a>libvirt 工具栈</h2><p>支持的虚拟化技术: KVM, XEN, VMAWARE, Qemu, LXC, OpenVZ;</p>
<p>安装:<br>CentOS6<br><code>yum install libvirt libvirt-client python-virtinst virt-manager</code><br>CentOS7<br><code>yum install libvirt libvirt-client virt-install virt-manager</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libvirt: 工具实现虚拟机管理：</span><br><span class="line">	装系统：virt-manager, virt-install, virsh</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">使用virt-install创建虚拟机并安装GuestOS</span><br><span class="line">virt-install是一个命令行工具，它能够为KVM、Xen或其它支持libvrit API的hypervisor创建虚拟机并完成GuestOS安装；此外，它能够基于串行控制台、VNC或SDL支持文本或图形安装界面。安装过程可以使用本地的安装介质如CDROM，也可以通过网络方式如NFS、HTTP或FTP服务实现。对于通过网络安装的方式，virt-install可以自动加载必要的文件以启动安装过程而无须额外提供引导工具。当然，virt-install也支持PXE方式的安装过程，也能够直接使用现有的磁盘映像直接启动安装过程。</span><br><span class="line">virt-install命令有许多选项，这些选项大体可分为下面几大类，同时对每类中的常用选项也做出简单说明。</span><br><span class="line">👉🏾	一般选项：指定虚拟机的名称、内存大小、VCPU个数及特性等；</span><br><span class="line">👉🏾	-n NAME, --name&#x3D;NAME：虚拟机名称，需全局惟一；</span><br><span class="line">👉🏾	-r MEMORY, --ram&#x3D;MEMORY：虚拟机内在大小，单位为MB；</span><br><span class="line">👉🏾 --vcpus&#x3D;VCPUS[,maxvcpus&#x3D;MAX][,sockets&#x3D;#][,cores&#x3D;#][,threads&#x3D;#]：VCPU个数及相关配置；</span><br><span class="line">👉🏾	--cpu&#x3D;CPU：CPU模式及特性，如coreduo等；可以使用qemu-kvm -cpu ?来获取支持的CPU模式；</span><br><span class="line">👉🏾安装方法：指定安装方法、GuestOS类型等；</span><br><span class="line">👉🏾 -c CDROM, --cdrom&#x3D;CDROM：光盘安装介质；</span><br><span class="line">👉🏾 -l LOCATION, --location&#x3D;LOCATION：安装源URL，支持FTP、HTTP及NFS等，如ftp:&#x2F;&#x2F;172.16.0.1&#x2F;pub；</span><br><span class="line">👉🏾	--pxe：基于PXE完成安装；</span><br><span class="line">👉🏾	--livecd: 把光盘当作LiveCD；</span><br><span class="line">👉🏾	--os-type&#x3D;DISTRO_TYPE：操作系统类型，如linux、unix或windows等；</span><br><span class="line">👉🏾	--os-variant&#x3D;DISTRO_VARIANT：某类型操作系统的变体，如rhel5、fedora8等；</span><br><span class="line">👉🏾	-x EXTRA, --extra-args&#x3D;EXTRA：根据--location指定的方式安装GuestOS时，用于传递给内核的额外选项，例如指定kickstart文件的位置，--extra-args &quot;ks&#x3D;http:&#x2F;&#x2F;172.16.0.1&#x2F;class.cfg&quot;</span><br><span class="line">👉🏾	--boot&#x3D;BOOTOPTS：指定安装过程完成后的配置选项，如指定引导设备次序、使用指定的而非安装的kernel&#x2F;initrd来引导系统启动等 ；例如：</span><br><span class="line">👉🏾	--boot  cdrom,hd,network：指定引导次序；</span><br><span class="line">👉🏾	--boot kernel&#x3D;KERNEL,initrd&#x3D;INITRD,kernel_args&#x3D;”console&#x3D;&#x2F;dev&#x2F;ttyS0”：指定启动系统的内核及initrd文件；</span><br><span class="line">👉🏾	存储配置：指定存储类型、位置及属性等；</span><br><span class="line">👉🏾	--disk&#x3D;DISKOPTS：指定存储设备及其属性；格式为--disk &#x2F;some&#x2F;storage&#x2F;path,opt1&#x3D;val1，opt2&#x3D;val2等；常用的选项有：</span><br><span class="line">👉🏾	device：设备类型，如cdrom、disk或floppy等，默认为disk；</span><br><span class="line">👉🏾	bus：磁盘总结类型，其值可以为ide、scsi、usb、virtio或xen；</span><br><span class="line">👉🏾	perms：访问权限，如rw、ro或sh（共享的可读写），默认为rw；</span><br><span class="line">👉🏾	size：新建磁盘映像的大小，单位为GB；</span><br><span class="line">👉🏾	cache：缓存模型，其值有none、writethrouth（缓存读）及writeback（缓存读写）；</span><br><span class="line">👉🏾	format：磁盘映像格式，如raw、qcow2、vmdk等；</span><br><span class="line">👉🏾	sparse：磁盘映像使用稀疏格式，即不立即分配指定大小的空间；</span><br><span class="line">👉🏾	--nodisks：不使用本地磁盘，在LiveCD模式中常用；</span><br><span class="line">👉🏾网络配置：指定网络接口的网络类型及接口属性如MAC地址、驱动模式等；</span><br><span class="line">👉🏾	-w NETWORK, --network&#x3D;NETWORK,opt1&#x3D;val1,opt2&#x3D;val2：将虚拟机连入宿主机的网络中，其中NETWORK可以为：</span><br><span class="line">👉🏾	bridge&#x3D;BRIDGE：连接至名为“BRIDEG”的桥设备；</span><br><span class="line">👉🏾	network&#x3D;NAME：连接至名为“NAME”的网络；</span><br><span class="line">其它常用的选项还有：</span><br><span class="line">👉🏾	model：GuestOS中看到的网络设备型号，如e1000、rtl8139或virtio等；</span><br><span class="line">👉🏾	mac：固定的MAC地址；省略此选项时将使用随机地址，但无论何种方式，对于KVM来说，其前三段必须为52:54:00；</span><br><span class="line">👉🏾	--nonetworks：虚拟机不使用网络功能；</span><br><span class="line">👉🏾	图形配置：定义虚拟机显示功能相关的配置，如VNC相关配置；</span><br><span class="line">👉🏾	--graphics TYPE,opt1&#x3D;val1,opt2&#x3D;val2：指定图形显示相关的配置，此选项不会配置任何显示硬件（如显卡），而是仅指定虚拟机启动后对其进行访问的接口；</span><br><span class="line">👉🏾	TYPE：指定显示类型，可以为vnc、sdl、spice或none等，默认为vnc；</span><br><span class="line">👉🏾	port：TYPE为vnc或spice时其监听的端口；</span><br><span class="line">👉🏾	listen：TYPE为vnc或spice时所监听的IP地址，默认为127.0.0.1，可以通过修改&#x2F;etc&#x2F;libvirt&#x2F;qemu.conf定义新的默认值；</span><br><span class="line">👉🏾	password：TYPE为vnc或spice时，为远程访问监听的服务进指定认证密码；</span><br><span class="line">👉🏾	--noautoconsole：禁止自动连接至虚拟机的控制台；</span><br><span class="line">👉🏾	设备选项：指定文本控制台、声音设备、串行接口、并行接口、显示接口等；</span><br><span class="line">👉🏾	--serial&#x3D;CHAROPTS：附加一个串行设备至当前虚拟机，根据设备类型的不同，可以使用不同的选项，格式为“--serial type,opt1&#x3D;val1,opt2&#x3D;val2,...”，例如：</span><br><span class="line">👉🏾	--serial pty：创建伪终端；</span><br><span class="line">👉🏾	--serial dev,path&#x3D;HOSTPATH：附加主机设备至此虚拟机；</span><br><span class="line">👉🏾	--video&#x3D;VIDEO：指定显卡设备模型，可用取值为cirrus、vga、qxl或vmvga；</span><br><span class="line"></span><br><span class="line">👉🏾	虚拟化平台：虚拟化模型（hvm或paravirt）、模拟的CPU平台类型、模拟的主机类型、hypervisor类型（如kvm、xen或qemu等）以及当前虚拟机的UUID等；</span><br><span class="line">👉🏾	-v, --hvm：当物理机同时支持完全虚拟化和半虚拟化时，指定使用完全虚拟化；</span><br><span class="line">👉🏾	-p, --paravirt：指定使用半虚拟化；</span><br><span class="line">👉🏾	--virt-type：使用的hypervisor，如kvm、qemu、xen等；所有可用值可以使用’virsh capabilities’命令获取；</span><br><span class="line">👉🏾	其它：</span><br><span class="line">👉🏾	--autostart：指定虚拟机是否在物理启动后自动启动；</span><br><span class="line">👉🏾	--print-xml：如果虚拟机不需要安装过程(--import、--boot)，则显示生成的XML而不是创建此虚拟机；默认情况下，此选项仍会创建磁盘映像；</span><br><span class="line">👉🏾	--force：禁止命令进入交互式模式，如果有需要回答yes或no选项，则自动回答为yes；</span><br><span class="line">👉🏾	--dry-run：执行创建虚拟机的整个过程，但不真正创建虚拟机、改变主机上的设备配置信息及将其创建的需求通知给libvirt；</span><br><span class="line">👉🏾	-d, --debug：显示debug信息；</span><br><span class="line"></span><br><span class="line">尽管virt-install命令有着类似上述的众多选项，但实际使用中，其必须提供的选项仅包括--name、--ram、--disk（也可是--nodisks）及安装过程相关的选项。此外，有时还需要使用括--connect&#x3D;CONNCT选项来指定连接至一个非默认的hypervisor。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># virt-install -n centos6.7 -r 512 -vcpus&#x3D;2, maxvcpus&#x3D;4 --pxe --disk &#x2F;images&#x2F;centos&#x2F;centos6.7.qcow2,size&#x3D;120,format&#x3D;qcow2,bus&#x3D;virtio,spare&#x3D;yes --network bridge&#x3D;br0,model-virtio --force </span><br></pre></td></tr></table></figure>
<p>生产示例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">virt-install --name testwinserver  --memory 6144 --vcpus 2 --disk device&#x3D;cdrom,path&#x3D;&#x2F;kvmiso&#x2F;cn_windows_server_2016_x64_dvd_9718765.iso --disk device&#x3D;cdrom,path&#x3D;&#x2F;usr&#x2F;share&#x2F;virtio-win&#x2F;virtio-win.iso --disk path&#x3D;&#x2F;kvmdata&#x2F;testwinserver.img,size&#x3D;300,bus&#x3D;virtio --network bridge&#x3D;br-ext,model&#x3D;virtio --noautoconsole --accelerate --hvm --graphics vnc,listen&#x3D;0.0.0.0 --video vga --input tablet,bus&#x3D;usb --os-type&#x3D;windows --check path_in_use&#x3D;off</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(七)</title>
    <url>/2019/06/15/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%957/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录七"><a href="#kubernetes-操作记录七" class="headerlink" title="kubernetes 操作记录七"></a>kubernetes 操作记录七</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="资源指标API及自定义指标API"><a href="#资源指标API及自定义指标API" class="headerlink" title="资源指标API及自定义指标API"></a>资源指标API及自定义指标API</h2><p>资源指标: metrics-server<br>自定义指标: prometheus, k8s-prometheus-adapter</p>
<p>新一代架构:<br>    核心指标流水线：由kubelet、metrics-server 以及由API server 提供的api组成;CPU、内存实时使用率、Pod的资源占用率及窗口的磁盘占用率;<br>    监控流水线: 用于从系统收集各种指标数据并提供终端用户、存储系统以及HPA。它们包含核心指标及许多非核心指标。非核心指标本身不能被k8s所解析;<br>    metrics-server: API server </p>
<hr>
<h3 id="部署-metrics-server"><a href="#部署-metrics-server" class="headerlink" title="部署 metrics-server"></a>部署 metrics-server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir metrics-server</span></span><br><span class="line"><span class="comment"># wget https://github.com/kubernetes-incubator/metrics-server/archive/v0.3.1.zip  </span></span><br><span class="line"><span class="comment"># cd metrics-server/metrics-server-0.3.1/deploy/1.8+/</span></span><br><span class="line"><span class="comment"># mv * ../../../</span></span><br></pre></td></tr></table></figure>
<p>问题修正 </p>
<ul>
<li><p>问题1：metrics-server默认使用节点hostname通过kubelet 10250端口获取数据，但是coredns里面没有该数据无法解析(10.96.0.10:53)，可以在metrics server启动命令添加参数 –kubelet-preferred-address-types=InternalIP 直接使用节点IP地址获取数据</p>
</li>
<li><p>问题2：kubelet 的10250端口使用的是https协议，连接需要验证tls证书。可以在metrics server启动命令添加参数–kubelet-insecure-tls不验证客户端证书</p>
</li>
<li><p>问题3：yaml文件中的image地址k8s.gcr.io/metrics-server-amd64:v0.3.0 需要梯子，需要改成中国可以访问的image地址，可以使用aliyun的 <code>registry.cn-hangzhou.aliyuncs.com/google_containers/</code></p>
</li>
</ul>
<p>修改以下内容</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">       <span class="comment">#image: k8s.gcr.io/metrics-server-amd64:v0.3.0</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.0</span></span><br><span class="line">       <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">       <span class="attr">command:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">/metrics-server</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">--metric-resolution=30s</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span></span><br><span class="line">       <span class="attr">volumeMounts:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">         <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl api-versions | grep metrics</span></span><br><span class="line">metrics.k8s.io/v1beta1</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"># curl  http://localhost:8080/apis/metrics.k8s.io/v1beta1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;APIResourceList&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;groupVersion&quot;</span>: <span class="string">&quot;metrics.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;resources&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;nodes&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;singularName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;namespaced&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;NodeMetrics&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;verbs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;pods&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;singularName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;namespaced&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;PodMetrics&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;verbs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>错误日志排查</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl logs -f metrics-server-68cdb458db-rgjtr -c metrics-server -n kube-system</span></span><br></pre></td></tr></table></figure>
<p>主要提供node  和Pod的监控数据;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl  top nodes</span><br><span class="line">NAME                   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">node01                  94m          4%     1574Mi          42%</span><br><span class="line">node02                  92m          4%     1901Mi          51%</span><br><span class="line">node03                  108m         5%     1803Mi          48%</span><br><span class="line">master                  238m         11%    1879Mi          50%</span><br></pre></td></tr></table></figure>
<h3 id="prometheus-部署"><a href="#prometheus-部署" class="headerlink" title="prometheus 部署"></a>prometheus 部署</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># git clone https://github.com/iKubernetes/k8s-prom.git</span></span><br><span class="line"><span class="comment"># cd k8s-prom</span></span><br><span class="line"><span class="comment"># kubectl  apply -f namespace.yaml</span></span><br><span class="line"><span class="comment"># cd node_exporter/</span></span><br><span class="line"><span class="comment"># kubectl  apply -f ./</span></span><br><span class="line"><span class="comment"># kubectl get pods -n prom</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-node-exporter-2xrqp   1/1     Running   0          47s</span><br><span class="line">prometheus-node-exporter-cgkp7   1/1     Running   0          47s</span><br><span class="line">prometheus-node-exporter-t7vh7   1/1     Running   0          47s</span><br><span class="line">prometheus-node-exporter-vrw89   1/1     Running   0          46s</span><br><span class="line"><span class="comment"># cd ../prometheus/</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/kubernetes-prometheus-deploy.png" class="lazyload" data-srcset="/images/kubernetes-prometheus-deploy.png" srcset="data:image/png;base64,666" alt=""></p>
<p>注: 在生产环境中，至少要用pv存储，不然当Pod删除时，数据也会被删除; </p>
<h3 id="安装-kube-state-metrics"><a href="#安装-kube-state-metrics" class="headerlink" title="安装  kube-state-metrics"></a>安装  kube-state-metrics</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ../kube-state-metrics/</span></span><br><span class="line"><span class="comment"># vim kube-state-metrics-deploy.yaml # 修改image镜像源</span></span><br><span class="line">image: quay.io/coreos/kube-state-metrics:v1.3.1</span><br><span class="line"><span class="comment"># kubectl  apply -f ./</span></span><br><span class="line"><span class="comment"># kubectl  get all -n prom</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-k8s-prometheus-adapter"><a href="#安装-k8s-prometheus-adapter" class="headerlink" title="安装 k8s-prometheus-adapter"></a>安装 k8s-prometheus-adapter</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line"># (umask 077; openssl genrsa -out serving.key 2048)</span><br><span class="line"># openssl req -new -key serving.key -out serving.csr -subj &quot;&#x2F;CN&#x3D;serving&quot;</span><br><span class="line"># openssl x509 -req -in serving.csr  -CA .&#x2F;ca.crt -CAkey .&#x2F;ca.key -CAcreateserial -out serving.crt -days 36500</span><br><span class="line"># kubectl create generic cm-adapter-serving-certs --from-file&#x3D;serving.crt --from-file&#x3D;serving.key</span><br><span class="line"># kubectl create secret  generic cm-adapter-serving-certs --from-file&#x3D;serving.crt --from-file&#x3D;serving.key -n prom</span><br><span class="line"># cd manifests&#x2F;metrics&#x2F;k8s-prom&#x2F;k8s-prometheus-adapter</span><br><span class="line"># kubectl apply -f .&#x2F;</span><br></pre></td></tr></table></figure>
<p>发现<code>k8s-prometheus-adapter</code>中的<code>custom-metrics-apiserver-deployment.yaml</code> 配置变了，这里可以根据原有内容 <code>image: directxman12/k8s-prometheus-adapter-amd64</code> google搜索<code>directxman12</code><a href="https://github.com/DirectXMan12/k8s-prometheus-adapter/tree/master/deploy/manifests">更新</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mv custom-metrics-apiserver-deployment.yaml&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/DirectXMan12/k8s-prometheus-adapter/master/deploy/manifests/custom-metrics-apiserver-deployment.yaml</span></span><br><span class="line"><span class="comment"># vim custom-metrics-apiserver-deployment.yaml # 改namespace: prom </span></span><br><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/DirectXMan12/k8s-prometheus-adapter/master/deploy/manifests/custom-metrics-config-map.yaml</span></span><br><span class="line"><span class="comment"># vim custom-metrics-config-map.yaml  # 改namespace: prom </span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get all -n prom</span></span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/custom-metrics-apiserver-667fd4fffd-qs2zk   1/1     Running   0          3m18s</span><br><span class="line">pod/kube-state-metrics-6697d66bbb-w7k4d         1/1     Running   0          20m</span><br><span class="line">pod/prometheus-node-exporter-2xrqp              1/1     Running   0          71m</span><br><span class="line">pod/prometheus-node-exporter-cgkp7              1/1     Running   0          71m</span><br><span class="line">pod/prometheus-node-exporter-t7vh7              1/1     Running   0          71m</span><br><span class="line">pod/prometheus-node-exporter-vrw89              1/1     Running   0          71m</span><br><span class="line">pod/prometheus-server-75cf46bdbc-kpgzs          1/1     Running   0          69m</span><br></pre></td></tr></table></figure>
<p>补充kubelet 启动失败 <code>swapoff -a</code><br>新入新节点时卡住 <code>kubeadm token create</code>  <code>kubeadm token list</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://localhost:8080/apis/custom.metrics.k8s.io/v1beta1</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-grafana"><a href="#安装-grafana" class="headerlink" title="安装 grafana"></a>安装 grafana</h3><p>改原grafana 配置文件 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">monitoring-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prom</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">task:</span> <span class="string">monitoring</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">task:</span> <span class="string">monitoring</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-grafana-amd64:v5.0.4</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ca-certificates</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">grafana-storage</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="comment">#- name: INFLUXDB_HOST</span></span><br><span class="line">        <span class="comment">#  value: monitoring-influxdb</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SERVER_HTTP_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3000&quot;</span></span><br><span class="line">          <span class="comment"># The following env variables are required to make Grafana accessible via</span></span><br><span class="line">          <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></span><br><span class="line">          <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></span><br><span class="line">          <span class="comment"># service using a LoadBalancer or a public IP.</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Admin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_SERVER_ROOT_URL</span></span><br><span class="line">          <span class="comment"># If you&#x27;re only using the API Server proxy, set this value instead:</span></span><br><span class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ca-certificates</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-storage</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></span><br><span class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes.io/name:</span> <span class="string">monitoring-grafana</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">monitoring-grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prom</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span></span><br><span class="line">  <span class="comment"># or through a public IP.</span></span><br><span class="line">  <span class="comment"># type: LoadBalancer</span></span><br><span class="line">  <span class="comment"># You could also use NodePort to expose the service at a randomly-generated port</span></span><br><span class="line">  <span class="comment"># type: NodePort</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30098</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">grafana</span></span><br><span class="line"><span class="comment"># kubectl apply -f grafana.yaml</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/kubernetes-prometheus-grafana.png" class="lazyload" data-srcset="/images/kubernetes-prometheus-grafana.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/kubernetes-prometheus-datasources.png" class="lazyload" data-srcset="/images/kubernetes-prometheus-datasources.png" srcset="data:image/png;base64,666" alt=""></p>
<p>下载并导入<a href="https://grafana.com/dashboards/">模版</a><br><img src="/images/kubernetest-prometheus-dashboard.png" class="lazyload" data-srcset="/images/kubernetest-prometheus-dashboard.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="资源限制与伸缩"><a href="#资源限制与伸缩" class="headerlink" title="资源限制与伸缩"></a>资源限制与伸缩</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=0 --requests=&#x27;cpu=50m,memory=256Mi&#x27; --limits=&#x27;cpu=50m,memory=256Mi&#x27; --labels=&#x27;app=myapp&#x27; --expose --port=80</span></span><br><span class="line"><span class="comment"># kubectl autoscale deployment myapp --min=1 --max=8 --cpu-percent=60</span></span><br><span class="line">horizontalpodautoscaler.autoscaling/myapp autoscaled</span><br><span class="line"><span class="comment">#  kubectl get hpa</span></span><br><span class="line">NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">myapp   Deployment/myapp   0%/60%    1         8         1          22s</span><br><span class="line"><span class="comment"># kubectl patch svc myapp -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line">service/myapp patched</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ssjinyao ➤ ab -c 100 -n 50000 http://xx.x.xx.xx:31257/index.html</span></span><br></pre></td></tr></table></figure>
<p>当压测，CPU 内存资源超出时，会扩展Pod数目</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-hpa-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">55</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">targetAverageValue:</span> <span class="string">50Mi</span></span><br></pre></td></tr></table></figure>
<p>根据请求数升Pod数</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-hpa-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">    <span class="attr">pods:</span></span><br><span class="line">      <span class="attr">metricName:</span> <span class="string">http_requests</span></span><br><span class="line">      <span class="attr">targetAverageValue:</span> <span class="string">800m</span></span><br></pre></td></tr></table></figure>
<h2 id="helm-入门"><a href="#helm-入门" class="headerlink" title="helm 入门"></a>helm 入门</h2><p>核心术语:<br>    Chart: 一个helm程序包;<br>    Repository: Charts仓库,https/http服务器;<br>    Release:特定的Chart部署于目标集群上的一个实例;<br>    Chart -&gt; Config -&gt; Release<br>程序架构:<br>    helm：客户端，管理本地的Chart仓库，管理Chart，与Tiller服务器交互，发送Chart,实例安装、查询、卸载等操作<br>    Tiller:  服务端 ，接收helm发来的Chart与Config,合并生成release;<br> <a href="https://github.com/helm/helm">helm github官网</a></p>
<hr>
<h3 id="安装helm"><a href="#安装helm" class="headerlink" title="安装helm"></a>安装helm</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://get.helm.sh/helm-v2.9.1-linux-amd64.tar.gz</span></span><br><span class="line"><span class="comment"># mv linux-amd64/helm  /usr/sbin/</span></span><br><span class="line"><span class="comment"># helm </span></span><br></pre></td></tr></table></figure>
<p>要使用helm 还需要安装 Tiller<br>helm 会识别 <code>.kube/config</code> 扮演成kubectl 客户端去连接至kubernetes集群 </p>
<h3 id="安装-Tiller"><a href="#安装-Tiller" class="headerlink" title="安装 Tiller"></a>安装 Tiller</h3><p><a href="https://github.com/helm/helm/blob/master/docs/rbac.md">ClusterRoleBinding RBAC配置文件</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir helm</span></span><br><span class="line"><span class="comment"># cd helm/</span></span><br><span class="line"><span class="comment"># vim tiller-rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="comment"># kubectl apply -f tiller-rbac.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller</span></span><br></pre></td></tr></table></figure>
<p>报错与处理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller</span></span><br><span class="line">Creating /root/.helm</span><br><span class="line">Creating /root/.helm/repository</span><br><span class="line">Creating /root/.helm/repository/cache</span><br><span class="line">Creating /root/.helm/repository/<span class="built_in">local</span></span><br><span class="line">Creating /root/.helm/plugins</span><br><span class="line">Creating /root/.helm/starters</span><br><span class="line">Creating /root/.helm/cache/archive</span><br><span class="line">Creating /root/.helm/repository/repositories.yaml</span><br><span class="line">Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com</span><br><span class="line">Error: Looks like <span class="string">&quot;https://kubernetes-charts.storage.googleapis.com&quot;</span> is not a valid chart repository or cannot be reached: Get https://kubernetes-charts.storage.googleapis.com/index.yaml: <span class="built_in">read</span> tcp 10.1.87.80:41084-&gt;172.217.163.240:443: <span class="built_in">read</span>: connection reset by peer</span><br></pre></td></tr></table></figure>
<p>添加国内源 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --client-only --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></span><br></pre></td></tr></table></figure>
<p>如果报如下错误，请按照下面解决</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Error: Couldn<span class="string">&#x27;t load repositories file (/home/docker/.helm/repository/repositories.yaml).</span></span><br><span class="line"><span class="string">You might need to run `helm init` (or `helm init --client-only` if tiller is already installed)</span></span><br></pre></td></tr></table></figure>
<p>解决办法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm init --client-only --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>
<p>–stable-repo-url 指定下载软件从那个源下载，默认的是从google下载，国内下载不下来，所以我们指定源为阿里云的源。</p>
<p>下载完之后我们还把源更换回来，要不然后面会报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller --tiller-image \</span></span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.12.3 \</span><br><span class="line">--stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>
<p>更新 helm 源 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo update</span></span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Skip <span class="built_in">local</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">&quot;stable&quot;</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">&quot;rancher-stable&quot;</span> chart repository</span><br><span class="line">Update Complete. ⎈ Happy Helming!⎈</span><br></pre></td></tr></table></figure>
<p>helm 官方可用的<a href="https://hub.kubeapps.com/">Chart列表</a> </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm search jenkins  # 搜索应用</span></span><br><span class="line"><span class="comment"># helm inspect stable/jenkins  # 查看使用配置信息</span></span><br><span class="line"><span class="comment"># helm install --name mem1 stable/memcached # 安装Memcached</span></span><br><span class="line"><span class="comment"># kubectl get pods --namespace default -l &quot;app=mem1-memcached&quot; -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot; mem1-memcached-0 #验证</span></span><br></pre></td></tr></table></figure>
<h3 id="helm-常用命令"><a href="#helm-常用命令" class="headerlink" title="helm 常用命令"></a>helm 常用命令</h3><p>release 管理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">insstall</span><br><span class="line">delete</span><br><span class="line">upgrade/rollback</span><br><span class="line">list</span><br><span class="line"><span class="built_in">history</span></span><br><span class="line">status 获取release 状态信息</span><br></pre></td></tr></table></figure>
<p>chart 管理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crate</span><br><span class="line">fetch </span><br><span class="line">get </span><br><span class="line">inspect</span><br><span class="line">package</span><br><span class="line">verify</span><br></pre></td></tr></table></figure>
<p>chart get 到本地路径 <code>/root/.helm/cache/archive</code></p>
<p>根据自定义变量创建</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm install --name redis1 -f values.yaml stable/redis</span></span><br><span class="line"><span class="comment"># helm status redis1 # 再次显示NOTES</span></span><br></pre></td></tr></table></figure>
<h2 id="部署EFK-日志系统"><a href="#部署EFK-日志系统" class="headerlink" title="部署EFK 日志系统"></a>部署EFK 日志系统</h2><h3 id="部署elasticsearch"><a href="#部署elasticsearch" class="headerlink" title="部署elasticsearch"></a>部署elasticsearch</h3><p>EFK: Fluentd </p>
<p>在容器集群岩调，再接入Pod查询日志是不可能的，所以必要的有一个统一的日志收集系统;<br>一个完整的kubernetes系统应该有:kubedns or coredns ,ingress-contraler,heapster or metracs server prometheus  , dashboard 。而EFK是一个kubernetes基本上需要提供的完整组件;</p>
<p>添加helm源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add extra https://burdenbear.github.io/kube-charts-mirror/</span></span><br><span class="line"><span class="comment"># helm repo add stable http://mirror.azure.cn/kubernetes/charts/ </span></span><br><span class="line"><span class="comment"># helm repo add incubator http://mirror.azure.cn/kubernetes/charts-incubator/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  helm fetch stable/elasticsearch</span></span><br><span class="line"><span class="comment"># helm fetch stable/fluentd-elasticsearch</span></span><br><span class="line"><span class="comment">#  helm fetch stable/kibana</span></span><br><span class="line"><span class="comment"># tar -xvf elasticsearch-1.28.5.tgz</span></span><br><span class="line"><span class="comment">#  tar -xvf fluentd-elasticsearch-2.0.7.tgz</span></span><br><span class="line"><span class="comment">#  tar -xvf kibana-3.1.0.tgz</span></span><br><span class="line"><span class="comment"># cd elasticsearch</span></span><br><span class="line"><span class="comment">#  vim values.yaml # 修改以下内容 </span></span><br><span class="line">  pullPolicy: <span class="string">&quot;IfNotPresent&quot;</span></span><br><span class="line">    persistence:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line"><span class="comment"># kubectl create namespace efk</span></span><br><span class="line"><span class="comment"># helm package elasticsearch/</span></span><br><span class="line"><span class="comment"># 新开启一个终端</span></span><br><span class="line"><span class="comment"># helm serve</span></span><br><span class="line">Regenerating index. This may take a moment.</span><br><span class="line">Now serving you on 127.0.0.1:8879</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm install --name els1 --namespace=efk  local/elasticsearch</span></span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run cirror-$RANDOM --rm -it --image=cirros -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># nslookup els1-elasticsearch-client.efk.svc</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      els1-elasticsearch-client.efk.svc</span><br><span class="line">Address 1: 10.111.159.57 els1-elasticsearch-client.efk.svc.cluster.local</span><br><span class="line">curl els1-elasticsearch-client.efk.svc.cluster.local:9200</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;els1-elasticsearch-client-787568fb55-9zd9k&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;_na_&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;6.4.3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_type&quot;</span> : <span class="string">&quot;tar&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;fe40335&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2018-10-30T23:17:19.084789Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;7.4.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;5.6.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;5.0.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">/ <span class="comment"># curl els1-elasticsearch-client.efk.svc.cluster.local:9200/_cat/nodes</span></span><br><span class="line">10.244.1.215 15 90 7 0.12 0.36 0.35 di - els1-elasticsearch-data-1</span><br><span class="line">10.244.2.132 19 60 2 0.09 0.23 0.19 di - els1-elasticsearch-data-0</span><br><span class="line">10.244.1.213 22 90 7 0.12 0.36 0.35 i  - els1-elasticsearch-client-787568fb55-9zd9k</span><br><span class="line">10.244.2.131 26 60 2 0.09 0.23 0.19 i  - els1-elasticsearch-client-787568fb55-sxhhp</span><br><span class="line">10.244.1.214 44 90 7 0.12 0.36 0.35 mi * els1-elasticsearch-master-0</span><br></pre></td></tr></table></figure>
<h3 id="部署-fluentd"><a href="#部署-fluentd" class="headerlink" title="部署 fluentd"></a>部署 fluentd</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># cd fluentd-elasticsearch/ </span></span><br><span class="line"><span class="comment"># vim values.yaml</span></span><br><span class="line">image:</span><br><span class="line">  repository: registry.cn-hangzhou.aliyuncs.com/google_containers/fluentd-elasticsearch</span><br><span class="line">elasticsearch:</span><br><span class="line">  host: <span class="string">&#x27;els1-elasticsearch-client.efk.svc.cluster.local&#x27;</span></span><br><span class="line">  port: 9200</span><br><span class="line">  scheme: <span class="string">&#x27;http&#x27;</span></span><br><span class="line">  ssl_version: TLSv1_2</span><br><span class="line">  buffer_chunk_limit: 2M</span><br><span class="line">  buffer_queue_limit: 8</span><br><span class="line">  logstash_prefix: <span class="string">&#x27;logstash&#x27;</span></span><br><span class="line">tolerations:</span><br><span class="line">   - key: node-role.kubernetes.io/master</span><br><span class="line">     operator: Exists</span><br><span class="line">     effect: NoSchedule</span><br><span class="line">podAnnotations:</span><br><span class="line">   prometheus.io/scrape: <span class="string">&quot;true&quot;</span></span><br><span class="line">   prometheus.io/port: <span class="string">&quot;24231&quot;</span></span><br><span class="line">service:</span><br><span class="line">   <span class="built_in">type</span>: ClusterIP</span><br><span class="line">   ports:</span><br><span class="line">     - name: <span class="string">&quot;monitor-agent&quot;</span></span><br><span class="line">       port: 24231</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm package ../fluentd-elasticsearch/</span></span><br><span class="line"><span class="comment"># helm install --name flu1 --namespace=efk local/fluentd-elasticsearch</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-kibana"><a href="#安装-kibana" class="headerlink" title="安装 kibana"></a>安装 kibana</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd kibana</span></span><br><span class="line"><span class="comment"># vim values.yaml # 修改以下内容  </span></span><br><span class="line">    elasticsearch.hosts: http://els1-elasticsearch-client.efk.svc.cluster.local:9200</span><br><span class="line">    service:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"><span class="comment"># helm package ../kibana/</span></span><br><span class="line"><span class="comment"># helm  install --name kibana1 --namespace=efk local/kibana</span></span><br><span class="line"><span class="comment"># kubectl get pods -n efk</span></span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">els1-elasticsearch-client-6b4b8c7485-7grbt   1/1     Running   0          96m</span><br><span class="line">els1-elasticsearch-client-6b4b8c7485-sqgtl   1/1     Running   0          96m</span><br><span class="line">els1-elasticsearch-data-0                    1/1     Running   0          96m</span><br><span class="line">els1-elasticsearch-data-1                    1/1     Running   0          78m</span><br><span class="line">els1-elasticsearch-master-0                  1/1     Running   0          96m</span><br><span class="line">els1-elasticsearch-master-1                  1/1     Running   0          93m</span><br><span class="line">els1-elasticsearch-master-2                  1/1     Running   0          78m</span><br><span class="line">flu1-fluentd-elasticsearch-95b95             1/1     Running   0          26m</span><br><span class="line">flu1-fluentd-elasticsearch-vpcsg             1/1     Running   0          26m</span><br><span class="line">flu1-fluentd-elasticsearch-w5wjj             1/1     Running   0          26m</span><br><span class="line">flu1-fluentd-elasticsearch-xkpv2             1/1     Running   0          26m</span><br><span class="line">kibana1-5dcf5f5d47-rsmqb                     1/1     Running   0          21m</span><br><span class="line"><span class="comment"># kubectl  get svc -n efk</span></span><br><span class="line">NAME                           TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">els1-elasticsearch-client      ClusterIP   10.98.8.75    &lt;none&gt;        9200/TCP        97m</span><br><span class="line">els1-elasticsearch-discovery   ClusterIP   None          &lt;none&gt;        9300/TCP        97m</span><br><span class="line">kibana1                        NodePort    10.96.230.3   &lt;none&gt;        443:31746/TCP   21m</span><br></pre></td></tr></table></figure>
<h3 id="docker-pull-报错信息总结"><a href="#docker-pull-报错信息总结" class="headerlink" title="docker pull 报错信息总结"></a>docker pull 报错信息总结</h3><p><code>error pulling image configuration</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo &quot;DOCKER_OPTS&#x3D;\&quot;\$DOCKER_OPTS --registry-mirror&#x3D;http:&#x2F;&#x2F;f2d6cb40.m.daocloud.io\&quot;&quot; | tee -a &#x2F;etc&#x2F;default&#x2F;docker</span><br><span class="line"># 或者 vim &#x2F;etc&#x2F;default&#x2F;docker 更改以下信息</span><br><span class="line">DOCKER_OPTS&#x3D;&quot;$&#123;DOCKER_OPTS&#125; --registry-mirror&#x3D;https:&#x2F;&#x2F;mirror.gcr.io&quot;</span><br><span class="line"># systemctl restart docker </span><br></pre></td></tr></table></figure>
<h3 id="配置并访问kibana"><a href="#配置并访问kibana" class="headerlink" title="配置并访问kibana"></a>配置并访问kibana</h3><p><img src="/images/kubernetes-helm-efk-kibana.png" class="lazyload" data-srcset="/images/kubernetes-helm-efk-kibana.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(六)</title>
    <url>/2019/05/30/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%956/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录六"><a href="#kubernetes-操作记录六" class="headerlink" title="kubernetes 操作记录六"></a>kubernetes 操作记录六</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="调度器、预选策略及优选函数"><a href="#调度器、预选策略及优选函数" class="headerlink" title="调度器、预选策略及优选函数"></a>调度器、预选策略及优选函数</h2><p>整个调度大致可以分为三个过程: Predicate(预先) –&gt; Priority(优选) –&gt; Select(选定)</p>
<hr>
<p>调度器:<br>    预选策略:<br>        CheckNodeCondition: 检查节点本身是否正常;<br>        GeneralPredicates:<br>            HostName:  检查Pod对象是否定义了 pod.spec.hostname,<br>            PodFitsHostPorts:pods.spec.containers.ports.hostPort<br>            MatchNodeSelector: pods.sepc.nodeSelector<br>            PodFitsResources: 检查Pod的资源需求是否能被节点的需求所满足<br>        NoDiskConflicts:检查Pod依赖的存储卷是否能满足需求;<br>        PodToleratesNodeTaints: 检查Pod上的spec.tolerations可容忍的污点是否完全包含节点上的污点;<br>        PodToleratesNodeNoExecuteTaints:  不能执行的污点,这个预选策略默认是不检查的;<br>        CheckNodeLabelPresence: 检查节点指定标签的存在性;<br>        CheckServiceAffinity: 把这个Pod调度到它所属的Service,已经调度完成其它Pod所在的节点上去;<br>        MaxEBSVolumeCount:<br>        MaxGCEPDVolumeCount:<br>        MaxAzureDiskVolumeCount:<br>        CheckVolumeBinding:<br>        NoVolumeZoneConflict:<br>        CheckNodeMemoryPressure:检查节点内存资源是否处于压力过大的状态;<br>        CheckNodePidPressure:检查PId状态是否紧缺;<br>        CheckNodeDiskPressure:<br>        MatchInterPodAffity:</p>
<hr>
<p>优选函数<br>    LeastRequested:<br>        (cpu(capacity-sum(requested))*10/capacity)+memory((capacity-sum(requested))*10/capacity))/2<br>    BalancedResourceAllocation:<br>        CPU和内存资源被占用率相近的胜出;<br>    NodePreferAvoidPods:<br>        节点注解信息”scheduler .alpha.kubernetes.io/preferAvoidPods”<br>    TaintToleration: 将Pod对象的spec.tolerations列表项与节点的taints列表项进行匹配度检查，匹配条目越多，得分越低;<br>    SelectorSpreading: 标签选择器的分散度，与当前Pod对象同属的标签选择器，选择适配的其它Pod的对象所在的节点，越多的，得分越底，否则得分越高;<br>    InterPodAffinity: 遍历Pod的亲和性条目，并将那些能够匹配到给定节点的条目相加，结果值越大，得分越低;<br>    NodeAffinity:  根据NodeSelecter进行匹配度检查，能成功匹配的越多，得分就越高;<br>    MostRequested:  空闲量越小的，得分越大。他会尽量把一个节点的资源先用完;<br>    NodeLabel: 标签越多，得分越高;<br>    ImageLocality: 此节点是否有此Pod 所需要的镜像，拥有镜像越多的，得分越高，而它是根据镜像体积大小之和来计算的;</p>
<hr>
<h2 id="kubernetes-高级调度方式"><a href="#kubernetes-高级调度方式" class="headerlink" title="kubernetes 高级调度方式"></a>kubernetes 高级调度方式</h2><p>节点选择器: nodeSelector, nodeName<br>节点亲和性调度: nodeAffinity</p>
<p>注: 当调度选择器选择了不存的标签时，Pod 会成为Pending状态<br>  nodeSelector:<br>    disktype: harddisk</p>
<p>   节点亲和性调度;</p>
<p>   硬亲和 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-nodeaffinity-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-node-affinity-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">foo</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure>
<p>软亲和</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vIm  pod-nodeaffinity-demo-2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-node-affinity-demo-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">foo</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">bar</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-required-affinity-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-first</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-second</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">app</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">&quot;myapp&quot;</span>]&#125;</span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>
<p>注: <code>podAntiAffinity</code>  一定不会调度到同一节点上 </p>
<p>taint 的effect定义对Pod排斥效果:<br>    NoSchedule:  仅影响调度过程，对现存的Pod对象不产生影响;<br>    NoExecute: 既影响调度过程，也影响现存的Pod对象; 不容忍的Pod对象将被驱逐;<br>    PreferNoSchedule: </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl taint node node01 node-type=production:NoSchedule</span></span><br><span class="line"><span class="comment"># kubectl  taint node  node02 node-type=dev:NoExecute</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;production&quot;</span> </span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;production&quot;</span> </span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="容器资源需求、限制、及HeapSter"><a href="#容器资源需求、限制、及HeapSter" class="headerlink" title="容器资源需求、限制、及HeapSter"></a>容器资源需求、限制、及HeapSter</h2><p>requests: 需求，最低保障;<br>limits: 限制，硬限制;<br>limits 一般大于等于 requests</p>
<p>CPU:  1颗逻辑CPU<br>           1逻辑核心=1000,millicores<br>                     500m = 0.5CPU<br>内存:<br>        E、P、T、G、M、K<br>        Ei、Pi</p>
<p>取消节点污点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl taint node node01  node-type-</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">renjin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/stress-ng</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/usr/bin/stress-ng&quot;</span>, <span class="string">&quot;-c 1&quot;</span>, <span class="string">&quot;--metrics-brief&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br></pre></td></tr></table></figure>
<p>QoS:<br>    Guranteed: 每个容器同时设置CPU和内在的requests和limits,<br>    cpu.limits=cpu.requests memory.limits=memory.request<br>    Burstable:至少有一个容器设置CPU或内存资源的requests<br>    BestEffort:  没有任何一个容器设置了requests或limits属性;最低优先级别; 是自动配置的;</p>
<h3 id="配置influxdb"><a href="#配置influxdb" class="headerlink" title="配置influxdb"></a>配置influxdb</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">    <span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/influxdb/influxdb.yaml</span></span><br><span class="line">   <span class="comment"># 更改以下内容</span></span><br><span class="line">   apiVersion: apps/v1</span><br><span class="line">   </span><br><span class="line">   spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: influxdb   </span><br><span class="line">        </span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: influxdb</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-influxdb-amd64:v1.5.2</span><br><span class="line"><span class="comment">#  kubectl apply -f influxdb.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="配置heapster-rbac"><a href="#配置heapster-rbac" class="headerlink" title="配置heapster-rbac"></a>配置heapster-rbac</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml</span></span><br><span class="line"><span class="comment"># kubectl  apply -f heapster-rbac.yaml </span></span><br></pre></td></tr></table></figure>
<h3 id="配置heapster"><a href="#配置heapster" class="headerlink" title="配置heapster"></a>配置heapster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/influxdb/heapster.yaml</span></span><br><span class="line"><span class="comment"># 修改以下内容</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: heapster</span><br><span class="line">image: registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-amd64:v1.5.4</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"><span class="comment"># kubectl  apply -f heapster.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">heapster               NodePort    10.101.89.141   &lt;none&gt;        80:31261/TCP             63s</span><br><span class="line">kube-dns               ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   48d</span><br><span class="line">kubernetes-dashboard   NodePort    10.103.25.80    &lt;none&gt;        443:30660/TCP            21d</span><br><span class="line">monitoring-influxdb    ClusterIP   10.103.131.36   &lt;none&gt;        8086/TCP                 153m</span><br></pre></td></tr></table></figure>
<p>看下图说明，heapster此时可以调通</p>
<p><img src="/images/kubernetes-heapster-404.png" class="lazyload" data-srcset="/images/kubernetes-heapster-404.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="grafana配置"><a href="#grafana配置" class="headerlink" title="grafana配置"></a>grafana配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/influxdb/grafana.yaml</span></span><br><span class="line"><span class="comment"># vim grafana.yaml # 修改以下内容</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: grafana</span><br><span class="line">      image: registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"><span class="comment"># kubectl apply -f grafana.yaml</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/kubernetes-grafana-test.png" class="lazyload" data-srcset="/images/kubernetes-grafana-test.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(五)</title>
    <url>/2019/05/24/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%955/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录五"><a href="#kubernetes-操作记录五" class="headerlink" title="kubernetes 操作记录五"></a>kubernetes 操作记录五</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="配置网络插件flannel"><a href="#配置网络插件flannel" class="headerlink" title="配置网络插件flannel"></a>配置网络插件flannel</h2><p>在Kubernetes集群中要解决四种通信的问题;<br>Kubernetes网络通信:<br>   (1) 容器间通信: 同一个Pod内的多个容器间的通信，lo<br>   (2) Pod通信: Pod IP <--> Pod IP<br>   (3) Pod与 Service通信: PodIP <--> ClusterIP,不在同一网段，通过iptables规则实现通信<br>   (4) Service 与集群外部客户端的通信;<br>CNI: (Container Network Interface)<br>      flannel,calico,canel,kube-router …</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get configmap kube-proxy -n kube-system -o yaml</span></span><br><span class="line">mode: <span class="string">&quot;&quot;</span> <span class="comment"># 改为ipvs 就可以了</span></span><br></pre></td></tr></table></figure>
<p>解决方案:<br>    虚拟网桥:  纯软件的方式，实现一个虚拟网卡接到网桥上去;<br>    多路复用: MacVlAN 配置多个Mac物理地址，使得一个物理网卡，可以承载多个容器去使用;<br>    硬件交换: SR-IOV 单根IO虚拟化;<br>    kubelet, /etc/cin/net.d/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;cni&#x2F;net.d&#x2F;10-flannel.conflist</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">      &quot;delegate&quot;: &#123;</span><br><span class="line">        &quot;hairpinMode&quot;: true,</span><br><span class="line">        &quot;isDefaultGateway&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">      &quot;capabilities&quot;: &#123;</span><br><span class="line">        &quot;portMappings&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>flannel:<br>    支持多种后端<br>        VxLAN<br>        host-gw: Host Gateway</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get daemonset -n kube-system</span></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                     AGE</span><br><span class="line">kube-flannel-ds           3         3         3       3            3           beta.kubernetes.io/arch=amd64     31d</span><br><span class="line">kube-flannel-ds-amd64     4         4         4       4            4           beta.kubernetes.io/arch=amd64     31d</span><br><span class="line">kube-flannel-ds-arm       0         0         0       0            0           beta.kubernetes.io/arch=arm       31d</span><br><span class="line">kube-flannel-ds-arm64     0         0         0       0            0           beta.kubernetes.io/arch=arm64     31d</span><br><span class="line">kube-flannel-ds-ppc64le   0         0         0       0            0           beta.kubernetes.io/arch=ppc64le   31d</span><br><span class="line">kube-flannel-ds-s390x     0         0         0       0            0           beta.kubernetes.io/arch=s390x     31d</span><br><span class="line">kube-proxy                4         4         4       4            4           &lt;none&gt;                            31d</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -n kube-system -o wide | grep &quot;flannel&quot;</span></span><br><span class="line">kube-flannel-ds-amd64-45rhc                  1/1     Running   2          31d    10.1.87.80     bj-zb-vm-ops-test5     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-4cs6r                  1/1     Running   0          31d    10.1.87.83     node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-bst7g                  1/1     Running   0          31d    10.1.87.81     node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-gqvz2                  1/1     Running   0          31d    10.1.87.82     node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-brzp7                        2/2     Running   0          31d    10.1.87.83     node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-khpr5                        2/2     Running   2          31d    10.1.87.82     node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-q6z65                        2/2     Running   0          31d    10.1.87.81     node01</span><br></pre></td></tr></table></figure>
<p>kube-flannel-cfg 用来配置以上flannel Pod是如何运行的;</p>
<p>flannel的配置参数:<br>    Network: flannel使用的CIDR格式的网络地址，用于为Pod的配置网络功能;<br>          10.244.0.0/16 -&gt;<br>                      master: 10.244.0.0/24<br>                      node01:10.244.1.0/24<br>                      …<br>                    node255: 10.244.255.0./24<br>    SubnetLen: 把Network切分子网供各节点使用时，使用多长的掩码进行切分，默认为24位;<br>    SubnetMin: 10.244.10.0/24 指定子网使用起始，从哪里开始;<br>    SubnetMax: 10.244.10.0/24 指定子网使用最大限制;<br>    Backend: 各Pod通信时使用什么方式进行通信: vxlan, host-gw , udp</p>
<hr>
<p>测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># kubectl get pods -o wide</span><br><span class="line"># kubectl  get pods -o wide | grep &quot;myapp-deploy&quot;</span><br><span class="line">myapp-deploy-675558bfc5-947g6    1&#x2F;1     Running   0          4d1h    10.244.1.173   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-675558bfc5-9xfdm    1&#x2F;1     Running   0          4d6h    10.244.3.176   node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-deploy-675558bfc5-qhl4w    1&#x2F;1     Running   0          5h41m   10.244.2.195   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>接入一个容器ping另一容器的ip</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it myapp-deploy-675558bfc5-947g6 -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># ping 10.244.2.195</span></span><br><span class="line">PING 10.244.2.195 (10.244.2.195): 56 data bytes</span><br><span class="line">64 bytes from 10.244.2.195: seq=0 ttl=62 time=0.871 ms</span><br><span class="line">64 bytes from 10.244.2.195: seq=1 ttl=62 time=0.925 ms</span><br><span class="line">64 bytes from 10.244.2.195: seq=2 ttl=62 time=0.886 ms</span><br><span class="line">64 bytes from 10.244.2.195: seq=3 ttl=62 time=1.171 ms</span><br></pre></td></tr></table></figure>
<p>在容器所在的物理服务器上抓包,</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tcpdump -i cni0 -nn icmp</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on cni0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:52:45.457148 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 0, length 64</span><br><span class="line">16:52:45.457743 IP 10.244.2.195 &gt; 10.244.1.173: ICMP <span class="built_in">echo</span> reply, id 3328, seq 0, length 64</span><br><span class="line">16:52:46.457445 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 1, length 64</span><br><span class="line">16:52:46.457948 IP 10.244.2.195 &gt; 10.244.1.173: ICMP <span class="built_in">echo</span> reply, id 3328, seq 1, length 64</span><br><span class="line">16:52:47.457722 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 2, length 64</span><br><span class="line">16:52:47.458313 IP 10.244.2.195 &gt; 10.244.1.173: ICMP <span class="built_in">echo</span> reply, id 3328, seq 2, length 64</span><br><span class="line">16:52:48.458036 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 3, length 64</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tcpdump -i flannel.1 -nn</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on flannel.1, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">17:01:13.757750 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 37, length 64</span><br><span class="line">17:01:13.758396 IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 2, seq 37, length 64</span><br><span class="line">17:01:14.758058 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 38, length 64</span><br><span class="line">17:01:14.758791 IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 2, seq 38, length 64</span><br><span class="line">17:01:15.758376 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 39, length 64</span><br><span class="line">17:01:15.759072 IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 2, seq 39, length 64</span><br><span class="line">17:01:16.758661 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 40, length 64</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tcpdump -i eth0 -nn host 10.1.87.82</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">17:03:44.145010 IP 10.1.87.81.44247 &gt; 10.1.87.82.8472: OTV, flags [I] (0x08), overlay 0, instance 1</span><br><span class="line">IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3, seq 0, length 64</span><br><span class="line">17:03:44.145551 IP 10.1.87.82.8942 &gt; 10.1.87.81.8472: OTV, flags [I] (0x08), overlay 0, instance 1</span><br><span class="line">IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 3, seq 0, length 64</span><br><span class="line">17:03:45.145300 IP 10.1.87.81.44247 &gt; 10.1.87.82.8472: OTV, flags [I] (0x08), overlay 0, instance 1</span><br><span class="line">IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3, seq 1, length 64</span><br><span class="line">17:03:45.145854 IP 10.1.87.82.8942 &gt; 10.1.87.81.8472: OTV, flags [I] (0x08), overlay 0, instance 1</span><br></pre></td></tr></table></figure>
<h2 id="Flannel-VxLAN的Direct-routing模式配置"><a href="#Flannel-VxLAN的Direct-routing模式配置" class="headerlink" title="Flannel VxLAN的Direct routing模式配置"></a>Flannel VxLAN的Direct routing模式配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line"><span class="comment"># vim  kube-flannel.yml   </span></span><br><span class="line">net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;10.244.0.0/16&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Backend&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;vxlan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Directrouting&quot;</span>: <span class="literal">true</span>  <span class="comment"># 添加字段</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># kubectl delete -f kube-flannel.yml</span></span><br><span class="line"><span class="comment"># kubectl apply -f kube-flannel.yml</span></span><br><span class="line"><span class="comment"># ip route show</span></span><br><span class="line">default via 10.1.87.1 dev eth0</span><br><span class="line">10.1.87.0/24 dev eth0 proto kernel scope link src 10.1.87.80</span><br><span class="line">10.244.0.0/24 dev cni0 proto kernel scope link src 10.244.0.1</span><br><span class="line">10.244.1.0/24 via 10.1.87.81 dev eth0</span><br><span class="line">10.244.2.0/24 via 10.1.87.82 dev eth0</span><br><span class="line">10.244.3.0/24 via 10.1.87.83 dev eth0</span><br></pre></td></tr></table></figure>
<p>注: 在生产环境中不可以这么做，会影响到Pod的网络环境。生产环境一般在使用前会考虑并初始化好网络环境，也就是说先修改 flannel 才开始使用创建Pod;</p>
<hr>
<h2 id="calico-安装使用"><a href="#calico-安装使用" class="headerlink" title="calico 安装使用"></a>calico 安装使用</h2><p><a href="https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/canal/">Canal/flannel Hosted Install 官方文档</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/canal/rbac.yaml</span></span><br><span class="line"><span class="comment"># kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/canal/canal.yaml</span></span><br></pre></td></tr></table></figure>
<p>创建名称空间<br>podSelector: {} 为空时，代表所有Pod<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create namespace dev</span></span><br><span class="line">namespace/dev created</span><br><span class="line"><span class="comment"># kubectl create namespace prod</span></span><br><span class="line">namespace/prod created</span><br><span class="line"><span class="comment"># vim ingress-def.yaml</span></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: deny-all-ingress</span><br><span class="line">spec:</span><br><span class="line">  podSelector: &#123;&#125;</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line"><span class="comment"># kubectl apply -f ingress-def.yaml  -n dev</span></span><br><span class="line"><span class="comment"># kubectl  get netpol -n dev</span></span><br><span class="line">NAME               POD-SELECTOR   AGE</span><br><span class="line">deny-all-ingress   &lt;none&gt;         93s</span><br></pre></td></tr></table></figure></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-a.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-a.yaml -n dev</span></span><br><span class="line"><span class="comment"># kubectl get pods -n dev -o wide</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">54s</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.2</span>   <span class="string">node03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是请求10.244.3.2  发现是请求不通的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl  10.244.3.2</span></span><br><span class="line">curl: (7) Failed connect to 10.244.3.2:80; Connection timed out</span><br></pre></td></tr></table></figure>
<p>而把  pod-a.yaml 创建在prod 名称空间，此时prod名称空间是没有定义的</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  apply -f pod-a.yaml -n prod</span></span><br><span class="line"><span class="string">pod/pod1</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl get pods -n prod -o wide</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">17s</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.3</span>   <span class="string">node03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;node</span></span><br></pre></td></tr></table></figure>
<p>请求10.244.3.3名称空间的可以请求通</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># curl 10.244.3.3</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href&#x3D;&quot;hostname.html&quot;&gt;Pod Name&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>
<p>当允许dev名称空间的Pod 都可以访问时，只需加   <code>ingress:   - &#123;&#125;</code> 就可以了</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"><span class="comment"># kubectl apply -f ingress-def.yaml  -n dev</span></span><br><span class="line"><span class="comment"># curl  10.244.3.2</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">MyApp</span> <span class="string">|</span> <span class="attr">Version:</span> <span class="string">v1</span> <span class="string">|</span> <span class="string">&lt;a</span> <span class="string">href=&quot;hostname.html&quot;&gt;Pod</span> <span class="string">Name&lt;/a&gt;</span></span><br></pre></td></tr></table></figure>
<p>定义允许访问一组Pod,使用标签来实现 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label pods pod1 app=myapp -n dev</span></span><br><span class="line"><span class="string">pod/pod1</span> <span class="string">labeled</span></span><br></pre></td></tr></table></figure>
<p>还原ingress-def 为默认，拒绝所有dev 名称空间所有Pod的访问 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-def.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line"><span class="comment"># kubectl apply -f ingress-def.yaml  -n dev</span></span><br><span class="line"><span class="comment"># curl  10.244.3.2</span></span><br><span class="line"><span class="attr">curl:</span> <span class="string">(7)</span> <span class="string">Failed</span> <span class="string">connect</span> <span class="string">to</span> <span class="number">10.244</span><span class="number">.3</span><span class="number">.2</span><span class="string">:80;</span> <span class="string">Connection</span> <span class="string">timed</span> <span class="string">out</span></span><br></pre></td></tr></table></figure>
<p>配置测略，允许某网段允许访问指定策略</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim allow-netpol-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-myapp-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ipBlock:</span></span><br><span class="line">        <span class="attr">cidr:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">        <span class="attr">except:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.244</span><span class="number">.1</span><span class="number">.2</span><span class="string">/32</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line"><span class="comment"># kubectl apply -f allow-netpol-demo.yaml -n dev</span></span><br><span class="line"><span class="comment"># kubectl get netpol -n dev</span></span><br><span class="line"><span class="string">NAME</span>                  <span class="string">POD-SELECTOR</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">allow-myapp-ingress</span>   <span class="string">app=myapp</span>      <span class="string">2m</span></span><br><span class="line"><span class="string">deny-all-ingress</span>      <span class="string">&lt;none&gt;</span>         <span class="string">34m</span></span><br><span class="line"><span class="comment"># curl  10.244.3.2:80</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">MyApp</span> <span class="string">|</span> <span class="attr">Version:</span> <span class="string">v1</span> <span class="string">|</span> <span class="string">&lt;a</span> <span class="string">href=&quot;hostname.html&quot;&gt;Pod</span> <span class="string">Name&lt;/a&gt;</span></span><br></pre></td></tr></table></figure>
<p>管控出站流量的方式</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim egress-def.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"><span class="comment"># kubectl  apply -f egress-def.yaml -n prod</span></span><br><span class="line"><span class="string">networkpolicy.networking.k8s.io/deny-all-egress</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-a.yaml -n prod # 将之前的pod-a.yaml 创建到prod名称空间</span></span><br><span class="line"><span class="string">pod/pod1</span> <span class="string">unchanged</span></span><br><span class="line"><span class="comment"># kubectl get pods -n prod -o wide</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">34m</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.3</span>   <span class="string">node03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;node</span></span><br><span class="line"><span class="comment"># kubectl exec pod1 -it -n prod -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># ping 10.1.87.81</span></span><br><span class="line"><span class="string">PING</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">(10.1.87.81):</span> <span class="number">56</span> <span class="string">data</span> <span class="string">bytes</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">---</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">ping</span> <span class="string">statistics</span> <span class="string">---</span></span><br><span class="line"><span class="number">4</span> <span class="string">packets</span> <span class="string">transmitted,</span> <span class="number">0</span> <span class="string">packets</span> <span class="string">received,</span> <span class="number">100</span><span class="string">%</span> <span class="string">packet</span> <span class="string">loss</span></span><br><span class="line"><span class="string">/</span> <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim egress-def.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all-egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br><span class="line"><span class="comment"># kubectl  apply -f egress-def.yaml -n prod</span></span><br><span class="line"><span class="comment"># kubectl exec pod1 -it -n prod -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># ping 10.1.87.81</span></span><br><span class="line"><span class="string">PING</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">(10.1.87.81):</span> <span class="number">56</span> <span class="string">data</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">64 bytes from 10.1.87.81:</span> <span class="string">seq=0</span> <span class="string">ttl=63</span> <span class="string">time=0.660</span> <span class="string">ms</span></span><br><span class="line"><span class="attr">64 bytes from 10.1.87.81:</span> <span class="string">seq=1</span> <span class="string">ttl=63</span> <span class="string">time=0.564</span> <span class="string">ms</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">---</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">ping</span> <span class="string">statistics</span> <span class="string">---</span></span><br><span class="line"><span class="number">2</span> <span class="string">packets</span> <span class="string">transmitted,</span> <span class="number">2</span> <span class="string">packets</span> <span class="string">received,</span> <span class="number">0</span><span class="string">%</span> <span class="string">packet</span> <span class="string">loss</span></span><br><span class="line"><span class="string">round-trip</span> <span class="string">min/avg/max</span> <span class="string">=</span> <span class="number">0.564</span><span class="string">/0.612/0.660</span> <span class="string">ms</span></span><br></pre></td></tr></table></figure>
<p>可以看到放行所有Pod出站规则,网络是通的;</p>
<p>网络策略:<br>    名称空间:<br>        拒绝所有出站，入站;<br>        放行所有出站目标本名称空间内的所有Pod;</p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(四)</title>
    <url>/2019/05/22/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%954/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录四"><a href="#kubernetes-操作记录四" class="headerlink" title="kubernetes 操作记录四"></a>kubernetes 操作记录四</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="kubernetes认证及Service-Account"><a href="#kubernetes认证及Service-Account" class="headerlink" title="kubernetes认证及Service Account"></a>kubernetes认证及Service Account</h2><p>在master服务器上启动 proxy 并监听至8080</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  proxy --port=8080 &amp;</span></span><br><span class="line"><span class="comment"># curl http://localhost:8080/api/v1/namespaces</span></span><br></pre></td></tr></table></figure>
<p>仅有权限获取当前Pod自身的相关信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get secret -n ingress-nginx</span></span><br><span class="line">NAME                                       TYPE                                  DATA   AGE</span><br><span class="line">default-token-t54dl                        kubernetes.io/service-account-token   3      5d23h</span><br><span class="line">nginx-ingress-serviceaccount-token-5dwv4   kubernetes.io/service-account-token   3      5d23h</span><br></pre></td></tr></table></figure>
<p>生成yaml框架，快速编写清单</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount mysa -o yaml --dry-run</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysa</span></span><br><span class="line"><span class="comment"># kubectl get pods myapp-deploy-675558bfc5-2rfrs -o  yaml --export</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl describe sa admin</span></span><br><span class="line">Name:                admin</span><br><span class="line">Namespace:           default</span><br><span class="line">Labels:              &lt;none&gt;</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   admin-token-hxqqf</span><br><span class="line">Tokens:              admin-token-hxqqf</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"><span class="comment"># kubectl get secret</span></span><br><span class="line">NAME                    TYPE                                  DATA   AGE</span><br><span class="line">admin-token-hxqqf       kubernetes.io/service-account-token   3      66s</span><br><span class="line">default-token-2sgn5     kubernetes.io/service-account-token   3      26d</span><br><span class="line">mysql-root-password     Opaque                                1      45h</span><br><span class="line">tomcat-ingress-secret   kubernetes.io/tls                     2      5d22h</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim  pod-sa-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-sa-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">admin</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-sa-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl describe pods  pod-sa-demo | grep &#x27;SecretName&#x27;</span></span><br><span class="line">    <span class="attr">SecretName:</span>  <span class="string">admin-token-hxqqf</span></span><br></pre></td></tr></table></figure>
<p>kubernetes 集群有两类认证时的用户账号<br>useraccount,我们称之为用户账号，通常定义的是人使用的账号<br>servicecacount,  服务账号，指pod中应用的应用程序运行在kubernetes ，想访问apiserver时用的认证信息，包括用户名密码等等;</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config view</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://10.1.87.80:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/etc/kubernetes/pki</span><br><span class="line"><span class="comment"># (umask 077; openssl genrsa -out  ssjinyao.key 2048)</span></span><br><span class="line"><span class="comment"># openssl req -new -key ssjinyao.key  -out ssjinyao.csr -subj &quot;/CN=ssjinyao&quot;</span></span><br><span class="line"><span class="comment"># openssl x509 -req -in ssjinyao.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out ssjinyao.crt -days 36500</span></span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=ssjinyao</span><br><span class="line">Getting CA Private Key</span><br><span class="line"><span class="comment"># openssl x509 -in ssjinyao.crt -text -noout</span></span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 1 (0x0)</span><br><span class="line">        Serial Number:</span><br><span class="line">            f3:fe:ff:e5:0e:0b:37:e2</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN=kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: May 22 07:57:01 2019 GMT</span><br><span class="line">            Not After : Apr 28 07:57:01 2119 GMT</span><br><span class="line">        Subject: CN=ssjinyao</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br></pre></td></tr></table></figure>
<p>接下来把用户账号信息添加到连接kubernetes 的配置信息</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-credentials ssjinyao  --client-certificate=./ssjinyao.crt --client-key=./ssjinyao.key --embed-certs=true</span></span><br><span class="line"><span class="string">User</span> <span class="string">&quot;ssjinyao&quot;</span> <span class="string">set.</span></span><br><span class="line"><span class="comment"># kubectl config view</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://10.1.87.80:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssjinyao</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.crt</span></span><br><span class="line">    <span class="attr">client-key:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.key</span></span><br><span class="line"><span class="comment"># kubectl config set-context ssjinyao@kubernetes --cluster=kueberntes --user=ssjinyao</span></span><br><span class="line"><span class="string">Context</span> <span class="string">&quot;ssjinyao@kubernetes&quot;</span> <span class="string">created.</span></span><br><span class="line"><span class="comment"># kubectl config view</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://10.1.87.80:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kueberntes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">ssjinyao</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ssjinyao@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssjinyao</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.crt</span></span><br><span class="line">    <span class="attr">client-key:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.key</span></span><br></pre></td></tr></table></figure>
<p>这时候多了一个context, 可切换用户</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># kubectl config use-context ssjinyao@kubernetes</span><br><span class="line">Switched to context &quot;ssjinyao@kubernetes&quot;.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># kubectl config set-cluster mycluster --kubeconfig&#x3D;&#x2F;tmp&#x2F;test.conf --server&#x3D;&quot;https:&#x2F;&#x2F;10.1.87.80:6443&quot; --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt  --embed-certs&#x3D;true</span><br><span class="line">Cluster &quot;mycluster&quot; set.</span><br><span class="line"># kubectl config view --kubeconfig&#x3D;&#x2F;tmp&#x2F;test.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https:&#x2F;&#x2F;10.1.87.80:6443</span><br><span class="line">  name: mycluster</span><br><span class="line">contexts: []</span><br><span class="line">current-context: &quot;&quot;</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users: []</span><br></pre></td></tr></table></figure>
<h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><p>授权插件: Node, ABAC,RBAC,Webhook(基于http的回调来实现)<br>RBAC: Role-based AC</p>
<p>角色  (role)<br>许可 (permission)</p>
<p>role: operations,objects<br>rolebinding: user account OR service account  , role<br>clusterrole: clusterrolebinding</p>
<p>操作: GET HEAD PUT PUST PATCH DELETE</p>
<p>role binding定义</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml  &gt; role-demo.yaml</span></span><br><span class="line"><span class="comment"># vim role-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="comment"># kubectl apply -f role-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl describe role pods-reader</span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">pods-reader</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:  kubectl.kubernetes.io/last-applied-configuration:</span></span><br><span class="line">                &#123;<span class="string">&quot;apiVersion&quot;</span><span class="string">:&quot;rbac.authorization.k8s.io/v1&quot;</span>,<span class="string">&quot;kind&quot;</span><span class="string">:&quot;Role&quot;</span>,<span class="string">&quot;metadata&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;annotations&quot;</span><span class="string">:</span>&#123;&#125;,<span class="string">&quot;creationTimestamp&quot;</span><span class="string">:null</span>,<span class="string">&quot;name&quot;</span><span class="string">:&quot;pods-reader&quot;</span>,<span class="string">&quot;nam...</span></span><br><span class="line"><span class="string">PolicyRule:</span></span><br><span class="line"><span class="string">  Resources  Non-Resource URLs  Resource Names  Verbs</span></span><br><span class="line"><span class="string">  ---------  -----------------  --------------  -----</span></span><br><span class="line"><span class="string">  pods       []                 []              [get list watch]</span></span><br><span class="line"><span class="string"># kubectl create rolebinding ssjinyao-read-pods --role=pods-reader --user=ssjinyao --dry-run -o yaml &gt; rolebinding-demo.yaml</span></span><br><span class="line"><span class="string"># vim rolebinding-demo.yaml</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: RoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  creationTimestamp: null</span></span><br><span class="line"><span class="string">  name: ssjinyao-read-pods</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: Role</span></span><br><span class="line"><span class="string">  name: pods-reader</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: User</span></span><br><span class="line"><span class="string">  name: ssjinyao</span></span><br></pre></td></tr></table></figure>
<p>clusterrole  binding 定义</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># useradd ik8s</span></span><br><span class="line"><span class="comment"># cp -a  .kube/  /home/ik8s/</span></span><br><span class="line"><span class="comment"># chown -R ik8s.ik8s /home/ik8s/</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config use-context kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="comment"># kubectl  create clusterrole cluster-reader  --verb=get,list,watch --resource=pods -o yaml --dry-run  &gt; clusterrole-demo.yaml</span></span><br><span class="line"><span class="comment"># vim clusterrole-demo.yaml </span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="comment"># kubectl apply -f clusterrole-demo.yaml</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/cluster-reader</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl create clusterrolebinding ssjinyao-read-all-pods --clusterrole=cluster-reader --user=ssjinyao --dry-run -o yaml  &gt; clusterrolebind-demo.yaml</span></span><br></pre></td></tr></table></figure>
<p>cluster-role 被  rolebinding 会使的cluster 被降级</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create rolebinding ssjinyao-read-pods --clusterrole=cluster-reader --user=ssjinayo --dry-run -o yaml  &gt; rolebinding-clusterrole-demo.yaml</span></span><br></pre></td></tr></table></figure>
<p>查看系统默认的授权<br>引用授权</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get clusterrole admin -o yaml</span></span><br><span class="line"><span class="comment"># kubectl create rolebinding default-ns-admin --clusterrole=admin --user=ssjinyao</span></span><br><span class="line"><span class="string">rolebinding.rbac.authorization.k8s.io/default-ns-admin</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>
<h2 id="dashboard-及认证分级授权"><a href="#dashboard-及认证分级授权" class="headerlink" title="dashboard 及认证分级授权"></a>dashboard 及认证分级授权</h2><p>部署 dashboard</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure>
<p>部署时下载镜像出错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  kubectl describe pods -n kube-system kubernetes-dashboard-5f7b999d65-jpmhs</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From                           Message</span><br><span class="line">  ----     ------     ----                ----                           -------</span><br><span class="line">  Normal   Scheduled  113s                default-scheduler              Successfully assigned kube-system/kubernetes-dashboard-5f7b999d65-jpmhs to node01</span><br><span class="line">  Warning  Failed     53s (x3 over 105s)  kubelet, node01  Failed to pull image <span class="string">&quot;k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1&quot;</span>: rpc error: code = Unknown desc = Error response from daemon: Get https://k8s.gcr.io/v2/: dial tcp 74.125.203.82:443: connect: connection timed out</span><br><span class="line">  Warning  Failed     53s (x3 over 105s)  kubelet, node01  Error: ErrImagePull</span><br><span class="line">  Normal   BackOff    15s (x5 over 105s)  kubelet, node01  Back-off pulling image <span class="string">&quot;k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1&quot;</span></span><br><span class="line">  Warning  Failed     15s (x5 over 105s)  kubelet, node01  Error: ImagePullBackOff</span><br><span class="line">  Normal   Pulling    2s (x4 over 112s)   kubelet, 01  Pulling image <span class="string">&quot;k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1&quot;</span></span><br></pre></td></tr></table></figure>
<p>用手动下载的方法进行解决</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim docker_install_dashboard.sh</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">docker rmi mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line"><span class="comment"># sh docker_install_dashboard.sh </span></span><br></pre></td></tr></table></figure>
<p>然后再执行以下部署清单</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br><span class="line"> <span class="comment"># kubectl  get pods -n kube-system  | grep dash</span></span><br><span class="line">kubernetes-dashboard-5f7b999d65-fcb28        1/1     Running   0          71s</span><br></pre></td></tr></table></figure>
<p>可以看到kubernetes-dashbroad 已经运行 </p>
<p>默认服务暴露为ClusterIP类型的，我们需要将其改为NodePort 类型<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch svc kubernetes-dashboard -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27; -n kube-system</span></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line">\NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   27d</span><br><span class="line">kubernetes-dashboard   NodePort    10.109.190.204   &lt;none&gt;        443:31984/TCP            3m41s</span><br></pre></td></tr></table></figure><br>这个时候可以看到登录界面<br><img src="/images/kubernetes-dashboard-login.png" class="lazyload" data-srcset="/images/kubernetes-dashboard-login.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="使用用token实现认证登录"><a href="#使用用token实现认证登录" class="headerlink" title="使用用token实现认证登录"></a>使用用token实现认证登录</h3><p>这里登录需要的是serviceaccount用户， 所以这里创建 serviceaccount</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount dashboard-admin -n kube-system</span></span><br><span class="line">serviceaccount/dashboard-admin created </span><br><span class="line"><span class="comment"># kubectl  get sa -n kube-system  |  grep dash</span></span><br><span class="line">dashboard-admin                      1         6m33s</span><br></pre></td></tr></table></figure>
<p>serviceaccount 创建好后， 需要将serviceaccount绑定cluster这个角色上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/dashboard-cluster-admin created</span><br><span class="line"><span class="comment"># kubectl get secret -n kube-system | grep dash</span></span><br><span class="line">dashboard-admin-token-grj84                      kubernetes.io/service-account-token   3      5m46s</span><br></pre></td></tr></table></figure>
<p>绑定好 cluster 后， 查看token信息，并拿token进行登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe secret -n kube-system dashboard-admin-token-grj84</span></span><br></pre></td></tr></table></figure>
<p>登录后，可以看到整个kubernetes集群的概况</p>
<p><img src="/images/kubernetes-dashboard-loging-token.png" class="lazyload" data-srcset="/images/kubernetes-dashboard-loging-token.png" srcset="data:image/png;base64,666" alt=""></p>
<p>建立专用dashborad用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /etc/kubernetes/pki/</span></span><br><span class="line"><span class="comment"># (umask 077; openssl genrsa -out dashboard.key 2048)</span></span><br><span class="line"><span class="comment"># openssl req -new -key dashboard.key -out dashboard.csr -subj &quot;/O=ssjinyao/CN=dashboard&quot;</span></span><br><span class="line"><span class="comment"># openssl x509 -req -in dashboard.csr  -CA ca.crt -CAkey ca.key  -CAcreateserial -out dashboard.crt -days 3650</span></span><br><span class="line">Signature ok</span><br><span class="line">subject=/O=ssjinyao/CN=dashboard</span><br><span class="line">Getting CA Private Key</span><br><span class="line"><span class="comment"># kubectl create secret generic dashboard-cert  -n kube-system --from-file=dashboard.crt=./dashboard.crt --from-file=dashboard.key=./dashboard.key</span></span><br><span class="line">secret/dashboard-cert created</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create serviceaccount def-ns-admin -n default</span></span><br><span class="line">serviceaccount/def-ns-admin created</span><br></pre></td></tr></table></figure>
<p>role binding 到 default  名称空间，只允许访问default 名称空间</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin</span></span><br><span class="line">rolebinding.rbac.authorization.k8s.io/def-ns-admin created</span><br><span class="line"><span class="comment"># kubectl describe secret admin-token-hxqqf # 查看 token信息登录</span></span><br></pre></td></tr></table></figure>
<p>接下来配置kube config 文件认证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=./ca.crt  --server=&quot;https://10.1.87.80:6443&quot; --embed-certs=true --kubeconfig=/root/def-ns-admin.conf</span></span><br><span class="line">Cluster <span class="string">&quot;kubernetes&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"><span class="comment"># kubectl config view --kubeconfig=/root/def-ns-admin.conf</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://10.1.87.80:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts: []</span><br><span class="line">current-context: <span class="string">&quot;&quot;</span></span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users: []</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CLUSTER_ADMIN_TOKEN=$(kubectl get secret -n kube-system dashboard-admin-token-grj84   -o jsonpath=&#123;.data.token&#125; | base64 -d )</span></span><br><span class="line"><span class="comment"># kubectl config  set-credentials  dashboard-cluster-admin --token=$CLUSTER_ADMIN_TOKEN --kubeconfig=/root/def-ns-admin.conf</span></span><br><span class="line">User <span class="string">&quot;dashboard-cluster-admin&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"><span class="comment"># kubectl config set-context dashboard-cluster-admin@kubernetes --cluster=kubernetes --user=dashboard-cluster-admin --kubeconfig=/root/def-ns-admin.conf</span></span><br><span class="line"><span class="comment"># kubectl config use-context dashboard-cluster-admin@kubernetes --kubeconfig=/root/def-ns-admin.conf</span></span><br></pre></td></tr></table></figure>
<p>将生成的conf文件远程复制到桌面上 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssjinyao ➤ scp root@10.1.87.80:/root/def-ns-admin.conf ~/Desktop</span><br></pre></td></tr></table></figure>
<p>此时使用可以用 kubeconfig 来登录dashboard 了</p>
<p><img src="/images/kubernetes-dashborad-loging-kubeconfig.png" class="lazyload" data-srcset="/images/kubernetes-dashborad-loging-kubeconfig.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(三)</title>
    <url>/2019/05/17/kubernets%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%953/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录三"><a href="#kubernetes-操作记录三" class="headerlink" title="kubernetes 操作记录三"></a>kubernetes 操作记录三</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="存储卷"><a href="#存储卷" class="headerlink" title="存储卷"></a>存储卷</h2><h3 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-vol-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data/www/html</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span> ,  <span class="string">&quot;httpd -h /data/www/html &amp;&amp; sleep 300000&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data/</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [ <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while sleep 2 ; do echo $(date) &gt;&gt; /data/index.html; done&quot;</span>]</span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line"><span class="comment"># kubectl exec -it pod-demo -c busybox -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># echo $(date) &gt;&gt; /data/index.html</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cat /data/index.html</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">06</span><span class="string">:59:59</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="comment"># kubectl exec -it pod-demo -c myapp  -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># ls /data/web/html/index.html</span></span><br><span class="line"><span class="string">/data/web/html/index.html</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cat /data/web/html/index.html</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">06</span><span class="string">:59:59</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="comment"># curl  10.244.2.183</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:24</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:26</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:28</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:30</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:32</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:34</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:36</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:38</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:40</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:42</span> <span class="string">UTC</span> <span class="number">2019</span></span><br><span class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:44</span> <span class="string">UTC</span> <span class="number">2019</span></span><br></pre></td></tr></table></figure>
<h3 id="hostPath挂载使用"><a href="#hostPath挂载使用" class="headerlink" title="hostPath挂载使用"></a>hostPath挂载使用</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-hostpath-vol.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-vol-hostpath</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernets/myapp:v1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/pod/volume1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-hostpath-vol.yaml</span></span><br></pre></td></tr></table></figure>
<p>node1,node2,node3 分别创建以下目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /data/pod/volume1/ #注三个节点都要执行</span></span><br><span class="line"><span class="comment"># echo &quot;node1.ssjinyao.com&quot; &gt;&gt; /data/pod/volume1/index.html</span></span><br><span class="line"><span class="comment"># echo &quot;node2.ssjinyao.com&quot; &gt;&gt; /data/pod/volume1/index.html</span></span><br><span class="line"><span class="comment"># echo &quot;node3.ssjinyao.com&quot; &gt;&gt; /data/pod/volume1/index.html</span></span><br><span class="line"><span class="comment"># curl 10.244.1.155</span></span><br><span class="line">node1.ssjinyao.com</span><br></pre></td></tr></table></figure>
<p>可以看出当前运行在node1节点上</p>
<h3 id="nfs-卷挂载使用"><a href="#nfs-卷挂载使用" class="headerlink" title="nfs 卷挂载使用"></a>nfs 卷挂载使用</h3><p>选择一台服务器，安装并开启nfs 服务 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -pv /data/volumes</span></span><br><span class="line"><span class="comment"># yum -y install nfs nfs-utils </span></span><br><span class="line"><span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/volumes  10.1.87.83/24(rw,no_root_squash)</span><br><span class="line"><span class="comment"># systemctl start nfs</span></span><br></pre></td></tr></table></figure>
<p>注: 其它节点也需要安装 nfs-utils  不然pod驱动不了</p>
<p>在node02上手动测试挂载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mount -t nfs node03:/data/volumes/ /mnt</span></span><br></pre></td></tr></table></figure>
<p>在kubernetes 集群中使用nfs volumes</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-vol-nfs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/volumes</span></span><br><span class="line">      <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-vol-nfs.yaml</span></span><br></pre></td></tr></table></figure>
<p>在nfs服务器上写入数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo &quot;&lt;h1&gt;nfs.ssjinyao.com&lt;/h1&gt;&quot; &gt;&gt; /data/volumes/index.html</span></span><br></pre></td></tr></table></figure>
<p>尝试访问</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl  10.244.2.185</span></span><br><span class="line">&lt;h1&gt;nfs.ssjinyao.com&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<h2 id="pv-pvc-的使用"><a href="#pv-pvc-的使用" class="headerlink" title="pv, pvc 的使用"></a>pv, pvc 的使用</h2><p>nfs 服务器上创建多个目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir /data/volumes/v&#123;1,2,3,4,5&#125;</span></span><br><span class="line"><span class="comment"># vim /etc/exports</span></span><br><span class="line">/data/volumes/v1 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v2 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v3 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v4 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v5 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line"><span class="comment"># exportfs -arv</span></span><br><span class="line">exporting 10.1.87.83/24:/data/volumes/v5</span><br><span class="line">exporting 10.1.87.83/24:/data/volumes/v4</span><br><span class="line">exporting 10.1.87.83/24:/data/volumes/v3</span><br><span class="line">exporting 10.1.87.83/24:/data/volumes/v2</span><br><span class="line">exporting 10.1.87.83/24:/data/volumes/v1</span><br><span class="line"><span class="comment"># systemctl restart nfs</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pv-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv01</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv001</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv02</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv002</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv03</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv04</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv004</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v4</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv05</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv005</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v5</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pv01</span>   <span class="string">5Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">74s</span></span><br><span class="line"><span class="string">pv02</span>   <span class="string">10Gi</span>       <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">74s</span></span><br><span class="line"><span class="string">pv03</span>   <span class="string">20Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">74s</span></span><br><span class="line"><span class="string">pv04</span>   <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">74s</span></span><br><span class="line"><span class="string">pv05</span>   <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">74s</span></span><br></pre></td></tr></table></figure>
<p>pvc 绑定 pv </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat pod-vol-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">11Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-vol-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">mypvc</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-vol-pvc.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>           <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pv01</span>   <span class="string">5Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="string">40m</span></span><br><span class="line"><span class="string">pv02</span>   <span class="string">10Gi</span>       <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="string">40m</span></span><br><span class="line"><span class="string">pv03</span>   <span class="string">20Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/mypvc</span>                           <span class="string">40m</span></span><br><span class="line"><span class="string">pv04</span>   <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="string">40m</span></span><br><span class="line"><span class="string">pv05</span>   <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="string">40m</span></span><br><span class="line"><span class="comment">#  kubectl  get pvc</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">STATUS</span>   <span class="string">VOLUME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">mypvc</span>   <span class="string">Bound</span>    <span class="string">pv03</span>     <span class="string">20Gi</span>       <span class="string">RWO,RWX</span>                       <span class="string">8s</span></span><br></pre></td></tr></table></figure>
<h2 id="configmap-的使用"><a href="#configmap-的使用" class="headerlink" title="configmap 的使用"></a>configmap 的使用</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=myapp.ssjinyao.com</span></span><br><span class="line">configmap/nginx-config created</span><br><span class="line"><span class="comment"># kubectl  get cm</span></span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">nginx-config   2      25s</span><br><span class="line"><span class="comment"># kubectl describe cm nginx-config</span></span><br><span class="line">Name:         nginx-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">nginx_port:</span><br><span class="line">----</span><br><span class="line">80</span><br><span class="line">server_name:</span><br><span class="line">----</span><br><span class="line">myapp.ssjinyao.com</span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir configmap</span></span><br><span class="line"><span class="comment"># cd configmap/</span></span><br><span class="line"><span class="comment"># vim www.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">	server_name myapp.ssjinyao.com;</span><br><span class="line">        listen 80;</span><br><span class="line">        root /data/web/html/;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># kubectl create configmap nginx-www --from-file=./www.conf</span></span><br><span class="line"><span class="comment"># kubectl get cm</span></span><br><span class="line">NAME           DATA   AGE</span><br><span class="line">nginx-config   2      4m4s</span><br><span class="line">nginx-www      1      3s</span><br><span class="line"><span class="comment"># kubectl  get cm nginx-www -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  www.conf: <span class="string">&quot;server &#123;\n\tserver_name myapp.ssjinyao.com;\n        listen 80;\n        root</span></span><br><span class="line"><span class="string">    /data/web/html/;\n\n&#125;\n&quot;</span></span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2019-05-20T08:17:37Z&quot;</span></span><br><span class="line">  name: nginx-www</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;3462936&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/default/configmaps/nginx-www</span><br><span class="line">  uid: ba1625a7-7ad7-11e9-8902-525400c45563</span><br></pre></td></tr></table></figure>
<p>Pod 引用 configmap ，环境变量方式</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-cm-1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NGINX_SERVER_PORT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">nginx_port</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NGINX_SERVER_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">server_name</span></span><br><span class="line"><span class="comment"># kubectl  apply -f pod-configmap.yaml</span></span><br><span class="line"><span class="string">pod/pod-cm-1</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl  exec pod-cm-1 -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># printenv | grep NGINX_SERVER</span></span><br><span class="line"><span class="string">NGINX_SERVER_PORT=80</span></span><br><span class="line"><span class="string">NGINX_SERVER_NAME=myapp.ssjinyao.com</span></span><br></pre></td></tr></table></figure>
<p>当环境变量获取时，容器的变量不是实时更新的 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl edit cm nginx-config</span></span><br><span class="line"><span class="string">configmap/nginx-config</span> <span class="string">edited</span></span><br><span class="line"><span class="comment"># 将nginx_port: &quot;80&quot; 改变 nginx_port: &quot;8080&quot;</span></span><br><span class="line"><span class="comment"># 可以看到configmap 是实时生效的</span></span><br><span class="line"><span class="comment"># kubectl describe cm nginx-config</span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">nginx-config</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">nginx_port:</span></span><br><span class="line"><span class="string">----</span></span><br><span class="line"><span class="number">8080</span></span><br><span class="line"><span class="attr">server_name:</span></span><br><span class="line"><span class="string">----</span></span><br><span class="line"><span class="string">myapp.ssjinyao.com</span></span><br><span class="line"><span class="attr">Events:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment"># 而容器中则不会时实更新变量</span></span><br><span class="line"><span class="comment"># kubectl  exec pod-cm-1 -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># printenv | grep NGINX_SERVER</span></span><br><span class="line"><span class="string">NGINX_SERVER_PORT=80</span></span><br><span class="line"><span class="string">NGINX_SERVER_NAME=myapp.ssjinyao.com</span></span><br></pre></td></tr></table></figure>
<p>存储卷挂载方式</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-configmap2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-cm-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/config.d/</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-config</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-configmap2.yaml</span></span><br><span class="line"><span class="string">pod/pod-cm-2</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl exec pod-cm-2 -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/conf</span></span><br><span class="line"><span class="string">conf.d/</span>    <span class="string">config.d/</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/config.d/</span></span><br><span class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># ls</span></span><br><span class="line"><span class="string">nginx_port</span>   <span class="string">server_name</span></span><br><span class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># cat nginx_port</span></span><br><span class="line"><span class="number">8080</span><span class="string">/etc/nginx/config.d</span> <span class="comment">#</span></span><br><span class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># cat server_name</span></span><br><span class="line"><span class="string">myapp.ssjinyao.com/etc/nginx/config.d</span> <span class="comment">#</span></span><br><span class="line"><span class="comment"># kubectl edit cm nginx-config</span></span><br><span class="line"><span class="string">configmap/nginx-config</span> <span class="string">edited</span></span><br><span class="line"><span class="comment"># 将nginx_port: &quot;8080&quot; 改为 nginx_port: &quot;8088&quot; </span></span><br><span class="line"><span class="comment"># 稍等片刻后，接入容器发现nginx_port值实时更新</span></span><br><span class="line"><span class="comment"># kubectl edit cm nginx-config</span></span><br><span class="line"><span class="string">Edit</span> <span class="string">cancelled,</span> <span class="literal">no</span> <span class="string">changes</span> <span class="string">made.</span></span><br><span class="line">[<span class="string">root@bj-zb-vm-ops-test5</span> <span class="string">configmap</span>]<span class="comment"># kubectl exec pod-cm-2 -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/config.d/</span></span><br><span class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># cat nginx_port</span></span><br><span class="line"><span class="number">8088</span><span class="string">/etc/nginx/config.d</span> <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>案例,配置文件焙进镜像 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-configmap3.yaml</span></span><br><span class="line"><span class="comment"># kubectl apply -f pod-configmap3.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-cm-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d/</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-www</span></span><br><span class="line"><span class="comment"># kubectl exec pod-cm-3 -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line"><span class="string">/etc/nginx/conf.d</span> <span class="comment"># cat www.conf</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">	<span class="string">server_name</span> <span class="string">myapp.ssjinyao.com;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">root</span> <span class="string">/data/web/html/;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># kubectl edit cm nginx-www</span></span><br><span class="line"><span class="string">configmap/nginx-www</span> <span class="string">edited</span></span><br><span class="line"><span class="comment"># 将 listen 80 改为 listen 8080，稍等片刻后接入容器查看配置</span></span><br><span class="line"><span class="comment"># kubectl exec pod-cm-3 -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line"><span class="string">/etc/nginx/conf.d</span> <span class="comment"># cat www.conf</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">	<span class="string">server_name</span> <span class="string">myapp.ssjinyao.com;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">8080</span><span class="string">;</span></span><br><span class="line">        <span class="string">root</span> <span class="string">/data/web/html/;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># echo &quot;&lt;h1&gt; Nginx Server Configured by CM &lt;/h1&gt;&quot; &gt; /data/web/html/index.html</span></span><br><span class="line"><span class="comment"># 说明配置文件焙进镜像的方式是可以实时更新的;当然配置文件生效，需要nginx -s reload</span></span><br><span class="line"><span class="comment"># vim /etc/hosts  加入本地解析至Pod ip</span></span><br><span class="line"><span class="number">10.244</span><span class="number">.1</span><span class="number">.158</span> <span class="string">myapp.ssjinyao.com</span></span><br><span class="line"><span class="comment"># curl  http://myapp.ssjinyao.com:8080</span></span><br><span class="line"><span class="string">&lt;h1&gt;</span> <span class="string">Nginx</span> <span class="string">Server</span> <span class="string">Configured</span> <span class="string">by</span> <span class="string">CM</span> <span class="string">&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="secret-的使用"><a href="#secret-的使用" class="headerlink" title="secret 的使用"></a>secret 的使用</h2><p>configmap 都是明文存数据的，私钥和证书要放在secret中，密码要写成dns secret 而非configamp </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret generic mysql-root-password   --from-literal=passwod=H@ndih3</span></span><br><span class="line"><span class="string">secret/mysql-root-password</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># kubectl  get secret</span></span><br><span class="line"><span class="string">NAME</span>                    <span class="string">TYPE</span>                                  <span class="string">DATA</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">default-token-2sgn5</span>     <span class="string">kubernetes.io/service-account-token</span>   <span class="number">3</span>      <span class="string">24d</span></span><br><span class="line"><span class="string">mysql-root-password</span>     <span class="string">Opaque</span>                                <span class="number">1</span>      <span class="string">45s</span></span><br><span class="line"><span class="string">tomcat-ingress-secret</span>   <span class="string">kubernetes.io/tls</span>                     <span class="number">2</span>      <span class="string">4d</span></span><br><span class="line"><span class="comment"># kubectl describe secret mysql-root-password</span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">mysql-root-password</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type:</span>  <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">passwod:</span>  <span class="number">7</span> <span class="string">bytes</span></span><br><span class="line"><span class="comment"># 对比configmap  的Data数据，secret 值是不显示的</span></span><br><span class="line"><span class="comment"># kubectl describe configmap nginx-www</span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">nginx-www</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">www.conf:</span></span><br><span class="line"><span class="string">----</span></span><br><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">  <span class="string">server_name</span> <span class="string">myapp.ssjinyao.com;</span></span><br><span class="line">        <span class="string">listen</span> <span class="number">8080</span><span class="string">;</span></span><br><span class="line">        <span class="string">root</span> <span class="string">/data/web/html/;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">Events:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="comment"># 而 configmap  Data的值是显示的</span></span><br><span class="line"><span class="comment"># 我们也可以这样看</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl  get secret mysql-root-password -o yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">passwod:</span> <span class="string">SEBuZGloMw==</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2019-05-20T09:20:53Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-root-password</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;3469600&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/secrets/mysql-root-password</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">90cd9aaa-7ae0-11e9-8902-525400c45563</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque」</span></span><br></pre></td></tr></table></figure>
<p>可以看出数据还是有的，因此安全没有那好，也没有加密码的意义<br>可以直接用 base64 -d 进行解密</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo SEBuZGloMw&#x3D;&#x3D; | base64 -d</span><br><span class="line">H@ndih3</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim  pod-secret-1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-secret-1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-root-password</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">passwod</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec  pod-secret-1 -- printenv | grep MYSQL</span></span><br><span class="line">MYSQL_ROOT_PASSWORD=H@ndih3</span><br></pre></td></tr></table></figure>
<h2 id="statefulset-的使用"><a href="#statefulset-的使用" class="headerlink" title="statefulset 的使用"></a>statefulset 的使用</h2><p>nfs服务器还是在node3  上，配置信息如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/exports</span></span><br><span class="line">/data/volumes/v1 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v2 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v3 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v4 10.1.87.83/24(rw,no_root_squash)</span><br><span class="line">/data/volumes/v5 10.1.87.83/24(rw,no_root_squash)</span><br></pre></td></tr></table></figure>
<p>注：确保三台node服务器都安装了 nfs-utils</p>
<p>pv改动及创建 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat volumes/pv-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv01</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv001</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv02</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv002</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv03</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv04</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv004</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v4</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv05</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pv005</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volumes/v5</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">node03</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubectl apply -f volumes/pv-demo.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim stateful-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp-pod</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp-pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myappdata</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myappdata</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                             <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">client</span>                           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">23d</span></span><br><span class="line"><span class="string">myapp-0</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">7m10s</span></span><br><span class="line"><span class="string">myapp-1</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">7m5s</span></span><br><span class="line"><span class="string">myapp-2</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">7m1s</span></span><br><span class="line"><span class="comment"># kubectl get sts</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp</span>   <span class="number">3</span><span class="string">/3</span>     <span class="string">7m32s</span></span><br><span class="line"><span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>                       <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pv01</span>   <span class="string">5Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/myappdata-myapp-1</span>                           <span class="string">8m12s</span></span><br><span class="line"><span class="string">pv02</span>   <span class="string">5Gi</span>        <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/myappdata-myapp-0</span>                           <span class="string">8m12s</span></span><br><span class="line"><span class="string">pv03</span>   <span class="string">5Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/myappdata-myapp-2</span>                           <span class="string">8m12s</span></span><br><span class="line"><span class="string">pv04</span>   <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                                       <span class="string">8m12s</span></span><br><span class="line"><span class="string">pv05</span>   <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                                       <span class="string">8m12s</span></span><br><span class="line"><span class="comment"># kubectl exec -it myapp-0 -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># nslookup myapp-0.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">nslookup:</span> <span class="string">can&#x27;t</span> <span class="string">resolve</span> <span class="string">&#x27;(null)&#x27;</span><span class="string">:</span> <span class="string">Name</span> <span class="string">does</span> <span class="string">not</span> <span class="string">resolve</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Name:</span>      <span class="string">myapp-0.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">Address 1:</span> <span class="number">10.244</span><span class="number">.1</span><span class="number">.162</span> <span class="string">myapp-0.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># nslookup myapp-1.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">nslookup:</span> <span class="string">can&#x27;t</span> <span class="string">resolve</span> <span class="string">&#x27;(null)&#x27;</span><span class="string">:</span> <span class="string">Name</span> <span class="string">does</span> <span class="string">not</span> <span class="string">resolve</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Name:</span>      <span class="string">myapp-1.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">Address 1:</span> <span class="number">10.244</span><span class="number">.2</span><span class="number">.192</span> <span class="string">myapp-1.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># nslookup myapp-2.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">nslookup:</span> <span class="string">can&#x27;t</span> <span class="string">resolve</span> <span class="string">&#x27;(null)&#x27;</span><span class="string">:</span> <span class="string">Name</span> <span class="string">does</span> <span class="string">not</span> <span class="string">resolve</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Name:</span>      <span class="string">myapp-2.myapp.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">Address 1:</span> <span class="number">10.244</span><span class="number">.3</span><span class="number">.172</span> <span class="string">myapp-2.myapp.default.svc.cluster.local</span></span><br></pre></td></tr></table></figure>
<p>pod 数量扩展</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl scale sts myapp --replicas=5</span></span><br><span class="line">statefulset.apps/myapp scaled</span><br><span class="line"><span class="comment"># kubectl patch sts myapp -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;replicas&quot;:2&#125;&#125;&#x27;</span></span><br><span class="line">statefulset.apps/myapp patched</span><br><span class="line"><span class="comment"># kubectl patch sts myapp -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;updateStrategy&quot;:&#123;&quot;rollingUpdate&quot;:&#123;&quot;partition&quot;:4&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">statefulset.apps/myapp patched</span><br><span class="line"><span class="comment"># kubectl set image sts/myapp myapp=ikubernetes/myapp:v2</span></span><br><span class="line">statefulset.apps/myapp image updated</span><br><span class="line"><span class="comment"># kubectl get sts -o wide</span></span><br><span class="line">NAME    READY   AGE   CONTAINERS   IMAGES</span><br><span class="line">myapp   2/2     53m   myapp        ikubernetes/myapp:v2</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(二)</title>
    <url>/2019/05/10/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%952/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录二"><a href="#kubernetes-操作记录二" class="headerlink" title="kubernetes 操作记录二"></a>kubernetes 操作记录二</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Kubernetes-Pod-控制器"><a href="#Kubernetes-Pod-控制器" class="headerlink" title="Kubernetes Pod 控制器"></a>Kubernetes Pod 控制器</h2><h3 id="Replica-Set-RS-kubernetes-新一代的Pod-controller"><a href="#Replica-Set-RS-kubernetes-新一代的Pod-controller" class="headerlink" title="Replica Set(RS) kubernetes 新一代的Pod controller"></a>Replica Set(RS) kubernetes 新一代的Pod controller</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim rs-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">selector:</span></span><br><span class="line">        <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">            <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">            <span class="attr">labels:</span></span><br><span class="line">                <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">                <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">                <span class="attr">environment:</span> <span class="string">qa</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">              <span class="attr">ports:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">                <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="comment">#  kubectl get rs</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp</span>                    <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="string">6m51s</span></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-5xbwq</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">7m17s</span></span><br><span class="line"><span class="string">myapp-jdzph</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">7m17s</span></span><br><span class="line"><span class="comment"># curl 10.244.3.157</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">MyApp</span> <span class="string">|</span> <span class="attr">Version:</span> <span class="string">v1</span> <span class="string">|</span> <span class="string">&lt;a</span> <span class="string">href=&quot;hostname.html&quot;&gt;Pod</span> <span class="string">Name&lt;/a&gt;</span></span><br><span class="line"><span class="comment"># kubectl  delete pods myapp-5xbwq </span></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-jdzph</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">10m</span></span><br><span class="line"><span class="string">myapp-xg9mm</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">16s</span></span><br><span class="line"><span class="comment"># kubectl label pods pod-demo release=canary</span></span><br><span class="line"><span class="comment"># kubectl get pods --show-labels</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">LABELS</span></span><br><span class="line"><span class="string">myapp-jdzph</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">31m</span>   <span class="string">app=myapp,environment=qa,release=canary</span></span><br></pre></td></tr></table></figure>
<p>精确满足用户期望</p>
<h3 id="apply-f-声明式更新，即可以创建，也可以更新"><a href="#apply-f-声明式更新，即可以创建，也可以更新" class="headerlink" title="apply -f 声明式更新，即可以创建，也可以更新"></a>apply -f 声明式更新，即可以创建，也可以更新</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim deploy-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># kubectl apply -f deploy-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl get deploy</span></span><br><span class="line"><span class="string">NAME</span>           <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-deploy</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">115s</span></span><br><span class="line"><span class="comment"># kubectl  get pods</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-deploy-67b6dfcd8-6q725</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m39s</span></span><br><span class="line"><span class="string">myapp-deploy-67b6dfcd8-mshw8</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m39s</span></span><br><span class="line"><span class="comment"># vim deploy-demo.yaml</span></span><br><span class="line"><span class="string">将</span> <span class="attr">replicas:</span> <span class="number">2</span> <span class="string">改为</span> <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># kubectl apply -f deploy-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl  get pods</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-deploy-67b6dfcd8-6q725</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m34s</span></span><br><span class="line"><span class="string">myapp-deploy-67b6dfcd8-gltjz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">58s</span></span><br><span class="line"><span class="string">myapp-deploy-67b6dfcd8-mshw8</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6m34s</span></span><br></pre></td></tr></table></figure>
<h3 id="实现流动更新"><a href="#实现流动更新" class="headerlink" title="实现流动更新"></a>实现流动更新</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim deploy-demo.yaml</span></span><br><span class="line">image: ikubernetes/myapp:v1  改为 image: ikubernetes/myapp:v2</span><br><span class="line"><span class="comment"># kubcetl  apply -f deploy-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl  get pods -l app=myapp -w</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-deploy-67b6dfcd8-6q725   1/1     Running   0          3h23m</span><br><span class="line">myapp-deploy-67b6dfcd8-gltjz   1/1     Running   0          3h18m</span><br><span class="line">myapp-deploy-67b6dfcd8-mshw8   1/1     Running   0          3h23m</span><br><span class="line">myapp-deploy-675558bfc5-89nc7   0/1     Pending   0          0s</span><br><span class="line">myapp-deploy-675558bfc5-89nc7   0/1     Pending   0          0s</span><br><span class="line">myapp-deploy-675558bfc5-89nc7   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-deploy-675558bfc5-89nc7   1/1     Running             0          2s</span><br><span class="line">myapp-deploy-67b6dfcd8-gltjz    1/1     Terminating         0          3h18m</span><br><span class="line">myapp-deploy-675558bfc5-7zht2   0/1     Pending             0          0s</span><br><span class="line">myapp-deploy-675558bfc5-7zht2   0/1     Pending             0          0s</span><br><span class="line">myapp-deploy-675558bfc5-7zht2   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-deploy-67b6dfcd8-gltjz    0/1     Terminating         0          3h18m</span><br><span class="line">myapp-deploy-675558bfc5-7zht2   1/1     Running             0          3s</span><br><span class="line">myapp-deploy-67b6dfcd8-6q725    1/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-675558bfc5-xjq9z   0/1     Pending             0          0s</span><br><span class="line">myapp-deploy-675558bfc5-xjq9z   0/1     Pending             0          0s</span><br><span class="line">myapp-deploy-675558bfc5-xjq9z   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-deploy-67b6dfcd8-gltjz    0/1     Terminating         0          3h18m</span><br><span class="line">myapp-deploy-67b6dfcd8-gltjz    0/1     Terminating         0          3h18m</span><br><span class="line">myapp-deploy-67b6dfcd8-6q725    0/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-675558bfc5-xjq9z   1/1     Running             0          2s</span><br><span class="line">myapp-deploy-67b6dfcd8-mshw8    1/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-67b6dfcd8-6q725    0/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-67b6dfcd8-6q725    0/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-67b6dfcd8-mshw8    0/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-67b6dfcd8-mshw8    0/1     Terminating         0          3h24m</span><br><span class="line">myapp-deploy-67b6dfcd8-mshw8    0/1     Terminating         0          3h24m</span><br></pre></td></tr></table></figure>
<h3 id="查看目前所有的replica-set"><a href="#查看目前所有的replica-set" class="headerlink" title="查看目前所有的replica set"></a>查看目前所有的replica set</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get rs -o wide</span></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE     CONTAINERS     IMAGES                 SELECTOR</span><br><span class="line">myapp-deploy-675558bfc5   3         3         3       3m19s   myapp          ikubernetes/myapp:v2   app=myapp,pod-template-hash=675558bfc5,release=canary</span><br><span class="line">myapp-deploy-67b6dfcd8    0         0         0       3h27m   myapp          ikubernetes/myapp:v1   app=myapp,pod-template-hash=67b6dfcd8,release=canary</span><br></pre></td></tr></table></figure>
<h3 id="查看历史滚动信息"><a href="#查看历史滚动信息" class="headerlink" title="查看历史滚动信息"></a>查看历史滚动信息</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout history deployment myapp-deploy</span></span><br><span class="line">deployment.extensions/myapp-deploy</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h3 id="定义一个补丁"><a href="#定义一个补丁" class="headerlink" title="定义一个补丁"></a>定义一个补丁</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch deployment myapp-deploy -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;replicas&quot;:5&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># kubectl  get pods</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-deploy-675558bfc5-7zht2   1/1     Running   0          11m</span><br><span class="line">myapp-deploy-675558bfc5-89nc7   1/1     Running   0          11m</span><br><span class="line">myapp-deploy-675558bfc5-9nkk4   1/1     Running   0          33s</span><br><span class="line">myapp-deploy-675558bfc5-rbs4d   1/1     Running   0          33s</span><br><span class="line">myapp-deploy-675558bfc5-xjq9z   1/1     Running   0          11m</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl patch deployment myapp-deploy -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;strategy&quot;:&#123;&quot;rollingUpdate&quot;:&#123;&quot;maxSurge&quot;:1,&quot;maxUnavailable&quot;:0&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">deployment.extensions/myapp-deploy patched</span><br><span class="line"><span class="comment"># kubectl  describe deployment myapp-deploy</span></span><br><span class="line">RollingUpdateStrategy:  0 max unavailable, 1 max surge</span><br></pre></td></tr></table></figure>
<h3 id="金丝雀更新发布"><a href="#金丝雀更新发布" class="headerlink" title="金丝雀更新发布"></a>金丝雀更新发布</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl set image deployment myapp-deploy myapp=ikubernetes/myapp:v3 &amp;&amp; kubectl rollout pause deployment myapp-deploy  # 更新并且暂停更新</span></span><br><span class="line">deployment.extensions/myapp-deploy image updated</span><br><span class="line">deployment.extensions/myapp-deploy paused</span><br><span class="line"><span class="comment"># kubectl  get pods -l app=myapp -w</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-deploy-675558bfc5-7zht2   1/1     Running   0          27m</span><br><span class="line">myapp-deploy-675558bfc5-89nc7   1/1     Running   0          27m</span><br><span class="line">myapp-deploy-675558bfc5-9nkk4   1/1     Running   0          17m</span><br><span class="line">myapp-deploy-675558bfc5-rbs4d   1/1     Running   0          17m</span><br><span class="line">myapp-deploy-675558bfc5-xjq9z   1/1     Running   0          27m</span><br><span class="line">myapp-deploy-7f577979c8-92tj8   0/1     Pending   0          0s</span><br><span class="line">myapp-deploy-7f577979c8-92tj8   0/1     Pending   0          0s</span><br><span class="line">myapp-deploy-7f577979c8-92tj8   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-deploy-7f577979c8-92tj8   1/1     Running             0          14s</span><br></pre></td></tr></table></figure>
<h3 id="使用以下命令进行监控更新"><a href="#使用以下命令进行监控更新" class="headerlink" title="使用以下命令进行监控更新"></a>使用以下命令进行监控更新</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  rollout status deployment myapp-deploy</span></span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 1 out of 5 new replicas have been updated...</span><br></pre></td></tr></table></figure>
<p>若发现没有问题后继续更新</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout resume deployment myapp-deploy</span></span><br><span class="line">deployment.extensions/myapp-deploy resumed</span><br><span class="line"><span class="comment"># kubectl  rollout status deployment myapp-deploy</span></span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 1 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment spec update to be observed...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment spec update to be observed...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 1 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 1 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 2 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 2 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 2 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 3 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 4 out of 5 new replicas have been updated...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting <span class="keyword">for</span> deployment <span class="string">&quot;myapp-deploy&quot;</span> rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment <span class="string">&quot;myapp-deploy&quot;</span> successfully rolled out</span><br></pre></td></tr></table></figure>
<h3 id="若更新时发现问题，我们可以执行回滚"><a href="#若更新时发现问题，我们可以执行回滚" class="headerlink" title="若更新时发现问题，我们可以执行回滚"></a>若更新时发现问题，我们可以执行回滚</h3><p>查看可以回滚的版本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout history deployment myapp-deploy</span></span><br><span class="line">deployment.extensions/myapp-deploy</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  rollout undo deployment myapp-deploy --to-revision=1</span></span><br><span class="line">deployment.extensions/myapp-deploy rolled back</span><br><span class="line"><span class="comment"># kubectl rollout history deployment myapp-deploy</span></span><br><span class="line">deployment.extensions/myapp-deploy</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">4         &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>这时第一版已经回滚成第一版了 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get rs -o wide</span></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE    CONTAINERS     IMAGES                 SELECTOR</span><br><span class="line">myapp-deploy-675558bfc5   0         0         0       42m    myapp          ikubernetes/myapp:v2   app=myapp,pod-template-hash=675558bfc5,release=canary</span><br><span class="line">myapp-deploy-67b6dfcd8    5         5         5       4h6m   myapp          ikubernetes/myapp:v1   app=myapp,pod-template-hash=67b6dfcd8,release=canary</span><br></pre></td></tr></table></figure>
<h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><p>DaemonSet 在整个集群的每个节点上只运行指定Pod的一个副本，用于系统级的管理功能<br>比如filebeat，收集日志的服务</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ds-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">logstor</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">logstor</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:4.0-alpine</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-ds</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">stable</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">filebeat</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">stable</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ikubernetes/filebeat:5.6.5-alpine</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">redis.default.svc.cluster.local</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_LOG_LEVEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">info</span></span><br><span class="line"><span class="comment"># kubectl apply -f ds-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl expose deployment redis --port=6379</span></span><br><span class="line"><span class="string">service/redis</span> <span class="string">exposed</span></span><br><span class="line"><span class="comment"># kubectl set image daemonsets filebeat-ds filebeat=ikubernetes/filebeat:5.6.6-alpine</span></span><br><span class="line"><span class="string">daemonset.extensions/filebeat-ds</span> <span class="string">image</span> <span class="string">updated</span></span><br></pre></td></tr></table></figure>
<h2 id="Kubernetes-Service"><a href="#Kubernetes-Service" class="headerlink" title="Kubernetes Service"></a>Kubernetes Service</h2><p>ExternalName, ClusterIP, NodePort, and LoadBalancer</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim redis-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">logstor</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.96</span><span class="number">.88</span><span class="number">.88</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6339</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>
<p>资源记录<br>SVC_NAME.NS_NAME.DOMAIN.LTD.<br>svc.cluster.local<br>redis.default.svc.cluster.local</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim myapp-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.99</span><span class="number">.99</span><span class="number">.99</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30080</span></span><br><span class="line"><span class="comment"># kubectl get svc myapp</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>    <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp</span>   <span class="string">NodePort</span>   <span class="number">10.99</span><span class="number">.99</span><span class="number">.99</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30080/TCP</span>   <span class="string">4m50s</span></span><br><span class="line"><span class="string">ssjinyao</span> <span class="string">➤</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span>  <span class="string">curl</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.82</span><span class="string">:30080/hostname.html</span> <span class="string">;</span> <span class="string">sleep</span> <span class="number">1</span> <span class="string">;</span> <span class="string">done</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span></span><br><span class="line"><span class="comment"># 来自同上客户端的请求发往同一Pod</span></span><br><span class="line"><span class="comment"># kubectl patch svc myapp -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;sessionAffinity&quot;:&quot;ClientIP&quot;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="string">service/myapp</span> <span class="string">patched</span></span><br><span class="line"><span class="comment"># kubectl  describe svc myapp</span></span><br><span class="line"><span class="attr">Name:</span>                     <span class="string">myapp</span></span><br><span class="line"><span class="attr">Namespace:</span>                <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>                   <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:              kubectl.kubernetes.io/last-applied-configuration:</span></span><br><span class="line">                            &#123;<span class="string">&quot;apiVersion&quot;</span><span class="string">:&quot;v1&quot;</span>,<span class="string">&quot;kind&quot;</span><span class="string">:&quot;Service&quot;</span>,<span class="string">&quot;metadata&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;annotations&quot;</span><span class="string">:</span>&#123;&#125;,<span class="string">&quot;name&quot;</span><span class="string">:&quot;myapp&quot;</span>,<span class="string">&quot;namespace&quot;</span><span class="string">:&quot;default&quot;</span>&#125;,<span class="string">&quot;spec&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;clusterIP&quot;</span><span class="string">:&quot;10.99.99.99&quot;</span>,<span class="string">&quot;...</span></span><br><span class="line"><span class="string">Selector:                 app=myapp,release=canary</span></span><br><span class="line"><span class="string">Type:                     NodePort</span></span><br><span class="line"><span class="string">IP:                       10.99.99.99</span></span><br><span class="line"><span class="string">Port:                     &lt;unset&gt;  80/TCP</span></span><br><span class="line"><span class="string">TargetPort:               80/TCP</span></span><br><span class="line"><span class="string">NodePort:                 &lt;unset&gt;  30080/TCP</span></span><br><span class="line"><span class="string">Endpoints:                10.244.1.150:80,10.244.2.166:80,10.244.3.167:80</span></span><br><span class="line"><span class="string">Session Affinity:         ClientIP</span></span><br><span class="line"><span class="string">External Traffic Policy:  Cluster</span></span><br><span class="line"><span class="string">Events:                   &lt;none&gt;</span></span><br><span class="line"><span class="string">ssjinyao ➤ while true; do  curl 10.1.87.82:30080/hostname.html ; sleep 1 ; done</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></span><br></pre></td></tr></table></figure>
<p>无头服务</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim myapp-svc-headless.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl apply -f myapp-svc-headless.yaml</span></span><br><span class="line"><span class="string">service/myapp-svc</span> <span class="string">created</span></span><br><span class="line"><span class="comment"># dig -t A myapp-svc.default.svc.cluster.local. @10.96.0.10</span></span><br><span class="line"></span><br><span class="line"><span class="string">;</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">DiG</span> <span class="number">9.9</span><span class="number">.4</span><span class="string">-RedHat-9.9.4-73.el7_6</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">-t</span> <span class="string">A</span> <span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="string">@10.96.0.10</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">global options:</span> <span class="string">+cmd</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">Got answer:</span></span><br><span class="line"><span class="string">;;</span> <span class="string">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="attr">opcode:</span> <span class="string">QUERY,</span> <span class="attr">status:</span> <span class="string">NOERROR,</span> <span class="attr">id:</span> <span class="number">38590</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">flags:</span> <span class="string">qr</span> <span class="string">aa</span> <span class="string">rd;</span> <span class="attr">QUERY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ANSWER:</span> <span class="number">3</span><span class="string">,</span> <span class="attr">AUTHORITY:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">ADDITIONAL:</span> <span class="number">1</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">WARNING:</span> <span class="string">recursion</span> <span class="string">requested</span> <span class="string">but</span> <span class="string">not</span> <span class="string">available</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">;</span> <span class="attr">EDNS: version:</span> <span class="number">0</span><span class="string">,</span> <span class="string">flags:;</span> <span class="attr">udp:</span> <span class="number">4096</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">QUESTION SECTION:</span></span><br><span class="line"><span class="string">;myapp-svc.default.svc.cluster.local.</span> <span class="string">IN</span>	<span class="string">A</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">ANSWER SECTION:</span></span><br><span class="line"><span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="number">5</span> <span class="string">IN</span> <span class="string">A</span>	<span class="number">10.244</span><span class="number">.3</span><span class="number">.167</span></span><br><span class="line"><span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="number">5</span> <span class="string">IN</span> <span class="string">A</span>	<span class="number">10.244</span><span class="number">.1</span><span class="number">.150</span></span><br><span class="line"><span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="number">5</span> <span class="string">IN</span> <span class="string">A</span>	<span class="number">10.244</span><span class="number">.2</span><span class="number">.166</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">Query time:</span> <span class="number">0</span> <span class="string">msec</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">SERVER:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span><span class="comment">#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">WHEN:</span> <span class="string">Thu</span> <span class="string">May</span> <span class="number">16</span> <span class="number">10</span><span class="string">:59:03</span> <span class="string">CST</span> <span class="number">2019</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">MSG SIZE  rcvd:</span> <span class="number">217</span></span><br><span class="line"><span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>   <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                  <span class="string">AGE</span></span><br><span class="line"><span class="string">kube-dns</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span>   <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>   <span class="string">20d</span></span><br><span class="line"><span class="comment"># kubectl get pods -o wide -l app=myapp</span></span><br><span class="line"><span class="string">NAME</span>                            <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">42h</span>   <span class="number">10.244</span><span class="number">.1</span><span class="number">.150</span>   <span class="string">bj-gzf-vm-ops-test01</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">42h</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.166</span>   <span class="string">bj-gzf-vm-ops-test02</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">42h</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.167</span>   <span class="string">bj-gzf-vm-ops-test03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="ingress-及-ingress-controller"><a href="#ingress-及-ingress-controller" class="headerlink" title="ingress 及 ingress controller"></a>ingress 及 ingress controller</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir ingress-nginx</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> configmap.yaml mandatory.yaml namespace.yaml rbac.yaml  with-rbac.yaml  ; <span class="keyword">do</span> wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/<span class="variable">$file</span> ; <span class="keyword">done</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat deploy-demo.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: myapp</span><br><span class="line">    release: canary</span><br><span class="line">  ports:</span><br><span class="line">  - name: httpd</span><br><span class="line">    targetPort: 80</span><br><span class="line">    port: 80</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">      release: canary</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">        release: canary</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: ikubernetes/myapp:v2</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml</span></span><br><span class="line"><span class="comment"># pwd</span></span><br><span class="line">/root/ingress-nginx</span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line">configmap.yaml  mandatory.yaml  namespace.yaml  rbac.yaml  service-nodeport.yaml  with-rbac.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim service-nodeport.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubectl apply -f ./</span></span><br><span class="line"><span class="comment"># kubectl get svc -n ingress-nginx</span></span><br><span class="line"><span class="string">NAME</span>            <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                      <span class="string">AGE</span></span><br><span class="line"><span class="string">ingress-nginx</span>   <span class="string">NodePort</span>   <span class="number">10.96</span><span class="number">.59</span><span class="number">.169</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30080/TCP,443:30443/TCP</span>   <span class="string">2m35s</span></span><br></pre></td></tr></table></figure>
<p>现在可以尝试访问</p>
<p><img src="/images/ingress-nginx-404.png" class="lazyload" data-srcset="/images/ingress-nginx-404.png" srcset="data:image/png;base64,666" alt=""></p>
<p>查看访问apiVersion </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl explain ingress</span></span><br><span class="line">KIND:     Ingress</span><br><span class="line">VERSION:  extensions/v1beta1</span><br><span class="line"><span class="comment"># kubectl explain ingress.spec.rules.http.paths</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-myapp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-myapp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myapp.ssjinyao.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myapp</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe ingress ingress-myapp</span></span><br><span class="line">Name:             ingress-myapp</span><br><span class="line">Namespace:        default</span><br><span class="line">Address:</span><br><span class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</span><br><span class="line">Rules:</span><br><span class="line">  Host                Path  Backends</span><br><span class="line">  ----                ----  --------</span><br><span class="line">  myapp.ssjinyao.com</span><br><span class="line">                         myapp:80 (10.244.1.150:80,10.244.2.166:80,10.244.3.167:80)</span><br><span class="line">Annotations:</span><br><span class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;<span class="string">&quot;apiVersion&quot;</span>:<span class="string">&quot;extensions/v1beta1&quot;</span>,<span class="string">&quot;kind&quot;</span>:<span class="string">&quot;Ingress&quot;</span>,<span class="string">&quot;metadata&quot;</span>:&#123;<span class="string">&quot;annotations&quot;</span>:&#123;<span class="string">&quot;kubernetes.io/ingress.class&quot;</span>:<span class="string">&quot;nginx&quot;</span>&#125;,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ingress-myapp&quot;</span>,<span class="string">&quot;namespace&quot;</span>:<span class="string">&quot;default&quot;</span>&#125;,<span class="string">&quot;spec&quot;</span>:&#123;<span class="string">&quot;rules&quot;</span>:[&#123;<span class="string">&quot;host&quot;</span>:<span class="string">&quot;myapp.ssjinyao.com&quot;</span>,<span class="string">&quot;http&quot;</span>:&#123;<span class="string">&quot;paths&quot;</span>:[&#123;<span class="string">&quot;backend&quot;</span>:&#123;<span class="string">&quot;serviceName&quot;</span>:<span class="string">&quot;myapp&quot;</span>,<span class="string">&quot;servicePort&quot;</span>:80&#125;,<span class="string">&quot;path&quot;</span>:null&#125;]&#125;&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">  kubernetes.io/ingress.class:  nginx</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason  Age   From                      Message</span><br><span class="line">  ----    ------  ----  ----                      -------</span><br><span class="line">  Normal  CREATE  18s   nginx-ingress-controller  Ingress default/ingress-myapp</span><br><span class="line"><span class="comment"># kubectl exec -n ingress-nginx  nginx-ingress-controller-5694ccb578-xkgkx  -it -- /bin/sh</span></span><br></pre></td></tr></table></figure>
<p>这时再访问 </p>
<p><img src="/images/ingress-nginx-pod.png" class="lazyload" data-srcset="/images/ingress-nginx-pod.png" srcset="data:image/png;base64,666" alt=""></p>
<p>tomcat 七层负载创建</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim tomcat-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ajp</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8009</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8009</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">canary</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">tomcat:8.5.32-jre8-alpine</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ajp</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8009</span></span><br><span class="line"><span class="comment"># kubectl apply -f tomcat-deploy.yaml</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-tomcat.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-tomcat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.ssjinyao.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">tomcat</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># kubectl apply -f ingress-tomcat.yaml</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/ingress-nginx-tomcat.png" class="lazyload" data-srcset="/images/ingress-nginx-tomcat.png" srcset="data:image/png;base64,666" alt=""></p>
<p>secret 创建与使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create secret tls tomcat-ingress-secret --cert=2214184_tomcat.ssjinyao.com.pem --key=2214184_tomcat.ssjinyao.com.key</span></span><br><span class="line">secret/tomcat-ingress-secret created</span><br><span class="line"><span class="comment"># kubectl describe secret tomcat-ingress-secret</span></span><br><span class="line">Name:         tomcat-ingress-secret</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/tls</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">tls.crt:  3659 bytes</span><br><span class="line">tls.key:  1675 bytes</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ingress-tomcat-tls.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-tomcat-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tomcat.ssjinyao.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tomcat-ingress-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.ssjinyao.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">tomcat</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># kubectl apply -f ingress-tomcat-tls.yaml</span></span><br><span class="line"><span class="comment">#  kubectl get ingress</span></span><br><span class="line"><span class="string">NAME</span>                 <span class="string">HOSTS</span>                 <span class="string">ADDRESS</span>   <span class="string">PORTS</span>     <span class="string">AGE</span></span><br><span class="line"><span class="string">ingress-tomcat</span>       <span class="string">tomcat.ssjinyao.com</span>             <span class="number">80</span>        <span class="string">39m</span></span><br><span class="line"><span class="string">ingress-tomcat-tls</span>   <span class="string">tomcat.ssjinyao.com</span>             <span class="number">80</span><span class="string">,</span> <span class="number">443</span>   <span class="string">93s</span></span><br><span class="line"><span class="comment"># kubectl describe ingress ingress-tomcat-tls</span></span><br><span class="line"><span class="attr">Name:</span>             <span class="string">ingress-tomcat-tls</span></span><br><span class="line"><span class="attr">Namespace:</span>        <span class="string">default</span></span><br><span class="line"><span class="attr">Address:</span></span><br><span class="line"><span class="attr">Default backend:</span>  <span class="string">default-http-backend:80</span> <span class="string">(&lt;none&gt;)</span></span><br><span class="line"><span class="attr">TLS:</span></span><br><span class="line">  <span class="string">tomcat-ingress-secret</span> <span class="string">terminates</span> <span class="string">tomcat.ssjinyao.com</span></span><br><span class="line"><span class="attr">Rules:</span></span><br><span class="line">  <span class="string">Host</span>                 <span class="string">Path</span>  <span class="string">Backends</span></span><br><span class="line">  <span class="string">----</span>                 <span class="string">----</span>  <span class="string">--------</span></span><br><span class="line">  <span class="string">tomcat.ssjinyao.com</span></span><br><span class="line">                          <span class="string">tomcat:8080</span> <span class="string">(10.244.1.153:8080,10.244.2.171:8080,10.244.3.170:8080)</span></span><br><span class="line"><span class="attr">Annotations:</span></span><br><span class="line">  <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span>  &#123;<span class="string">&quot;apiVersion&quot;</span><span class="string">:&quot;extensions/v1beta1&quot;</span>,<span class="string">&quot;kind&quot;</span><span class="string">:&quot;Ingress&quot;</span>,<span class="string">&quot;metadata&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;annotations&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;kubernetes.io/ingress.class&quot;</span><span class="string">:&quot;nginx&quot;</span>&#125;,<span class="string">&quot;name&quot;</span><span class="string">:&quot;ingress-tomcat-tls&quot;</span>,<span class="string">&quot;namespace&quot;</span><span class="string">:&quot;default&quot;</span>&#125;,<span class="string">&quot;spec&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;rules&quot;</span><span class="string">:</span>[&#123;<span class="string">&quot;host&quot;</span><span class="string">:&quot;tomcat.ssjinyao.com&quot;</span>,<span class="string">&quot;http&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;paths&quot;</span><span class="string">:</span>[&#123;<span class="string">&quot;backend&quot;</span><span class="string">:</span>&#123;<span class="string">&quot;serviceName&quot;</span><span class="string">:&quot;tomcat&quot;</span>,<span class="string">&quot;servicePort&quot;</span><span class="string">:8080</span>&#125;,<span class="string">&quot;path&quot;</span><span class="string">:null</span>&#125;]&#125;&#125;],<span class="string">&quot;tls&quot;</span><span class="string">:</span>[&#123;<span class="string">&quot;hosts&quot;</span><span class="string">:</span>[<span class="string">&quot;tomcat.ssjinyao.com&quot;</span>],<span class="string">&quot;secretName&quot;</span><span class="string">:&quot;tomcat-ingress-secret&quot;</span>&#125;]&#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetes.io/ingress.class:</span>  <span class="string">nginx</span></span><br><span class="line"><span class="attr">Events:</span></span><br><span class="line">  <span class="string">Type</span>    <span class="string">Reason</span>  <span class="string">Age</span>    <span class="string">From</span>                      <span class="string">Message</span></span><br><span class="line">  <span class="string">----</span>    <span class="string">------</span>  <span class="string">----</span>   <span class="string">----</span>                      <span class="string">-------</span></span><br><span class="line">  <span class="string">Normal</span>  <span class="string">CREATE</span>  <span class="string">2m29s</span>  <span class="string">nginx-ingress-controller</span>  <span class="string">Ingress</span> <span class="string">default/ingress-tomcat-tls</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/ingress-nginx-tomcat-https.png" class="lazyload" data-srcset="/images/ingress-nginx-tomcat-https.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes操作记录(一)</title>
    <url>/2019/04/25/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%951/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-操作记录-一"><a href="#kubernetes-操作记录-一" class="headerlink" title="kubernetes 操作记录(一)"></a>kubernetes 操作记录(一)</h1><p><img src="/images/docker_kubernetes.png" class="lazyload" data-srcset="/images/docker_kubernetes.png" srcset="data:image/png;base64,666" alt=""><br>kubernetes 有两种部署方式，其中一种方式是将kubernetes 每个组件都以系统进程的方式运行成系统层面的服务;这样的部署繁琐而复杂，当然也可用别人写的ansible自动化工具推送一次;<br>另外一部署部署方式是就是用 kubeadm 将 Kuberntes 每个组件都Pod形势进行部署;</p>
<h2 id="使用-kubeadm-集群部署-kubernetes"><a href="#使用-kubeadm-集群部署-kubernetes" class="headerlink" title="使用 kubeadm 集群部署  kubernetes"></a>使用 kubeadm 集群部署  kubernetes</h2><ol>
<li>节点网络 10.1.87.0/24</li>
<li>Pod网络 10.244.0.0/16</li>
<li>Service网络 10.96.0.0/12</li>
</ol>
<h3 id="部署准备"><a href="#部署准备" class="headerlink" title="部署准备"></a>部署准备</h3><p>kubeadm 需要每个节点都安装  kubelte,docker  而把其中一个节点初始化为master;<br>其kuberntes 自己的各个组件都运行为Pod，其中的这些Pod都是静态Pod;</p>
<p>kubeadm<br>1、 master,nodes: 安装kubelet,kubeadm,docker<br>2、 master: kubeadm init<br>3、 nodes: kubeadm join<br>        <a href="https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.10.md">https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.10.md</a></p>
<p>节点服务器共四台，/etc/hosts配置信息如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">10.1.87.80  master</span><br><span class="line">10.1.87.81  node01</span><br><span class="line">10.1.87.82  node02</span><br><span class="line">10.1.87.83  node03</span><br></pre></td></tr></table></figure>
<p>注: 四台节点服务器时间需要同步</p>
<h3 id="配置-kubernetes-及-docker-的Yum源"><a href="#配置-kubernetes-及-docker-的Yum源" class="headerlink" title="配置 kubernetes 及 docker 的Yum源"></a>配置 kubernetes 及 docker 的Yum源</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Master:配置</span><br><span class="line"><span class="comment"># vim /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=kebernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line"><span class="comment"># cd /etc/yum.repos.d/ &amp;&amp; wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line"><span class="comment"># yum clean all &amp;&amp; yum makecache</span></span><br><span class="line">同步Yum配置到其它节点 </span><br><span class="line"><span class="comment"># for i in &#123;1..3&#125; ;do  scp docker-ce.repo kubernetes.repo node0$i:/etc/yum.repos.d/ ; done</span></span><br></pre></td></tr></table></figure>
<p>四台服务器安装以下软件包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install docker-ce kubelet kubeadm kubectl</span></span><br><span class="line">出现gpgkey问题，通过以下方式解决</span><br><span class="line"><span class="comment"># wget https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg </span></span><br><span class="line"><span class="comment"># rpm --import rpm-package-key.gpg  </span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">master</span><br><span class="line"><span class="comment"># vim /usr/lib/systemd/system/docker.service</span></span><br><span class="line">在[service]下添加以下内容</span><br><span class="line">Environment=<span class="string">&quot;HTTPS_PROXY=http://www.ik8s.io:10080&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;NO_PROXY=127.0.0.0/8, 10.1.87.0/24&quot;</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl restart docker</span></span><br><span class="line"><span class="comment"># docker info</span></span><br></pre></td></tr></table></figure>
<p>确保以下两个内核参数都是开启状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /proc/sys/net/bridge/bridge-nf-call-ip6tables</span></span><br><span class="line">1</span><br><span class="line"><span class="comment"># cat /proc/sys/net/bridge/bridge-nf-call-iptables</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>查看kubelet 所生成的文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -ql kubelet</span></span><br><span class="line">/etc/kubernetes/manifests</span><br><span class="line">/etc/sysconfig/kubelet</span><br><span class="line">/usr/bin/kubelet</span><br><span class="line">/usr/lib/systemd/system/kubelet.service</span><br><span class="line"><span class="comment"># systemctl enable kubelet</span></span><br><span class="line"><span class="comment"># systemctl enable docker</span></span><br></pre></td></tr></table></figure>
<p>或者用脚本下载，并修改标签</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim docker_install_kubelet_image.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0 k8s.gcr.io/kube-apiserver:v1.14.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0 k8s.gcr.io/kube-controller-manager:v1.14.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1</span><br></pre></td></tr></table></figure>
<p>查看 kubeadm init 初始化集群的帮助信息 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --help</span></span><br></pre></td></tr></table></figure>
<h3 id="kubernetes-初始化"><a href="#kubernetes-初始化" class="headerlink" title="kubernetes 初始化"></a>kubernetes 初始化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim  /etc/sysconfig/kubelet</span></span><br><span class="line">KUBELET_EXTRA_ARGS=<span class="string">&quot;--fail-swap-on=false&quot;</span></span><br><span class="line"><span class="comment"># kubeadm  init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=swap</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p $HOME/.kube</span></span><br><span class="line"><span class="comment"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class="line"><span class="comment"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br><span class="line">kubeadm join 10.1.87.80:6443 --token 7pr4nt.q2vfoir7qia0vrcd \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:7e38f83642e4633a48efa1bd2bdc3cd2523e83736091b38ead58c88530758bdc</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get cs (componentstatus)</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                 STATUS     ROLES    AGE   VERSION</span><br><span class="line">master   NotReady   master   23m   v1.14.1</span><br></pre></td></tr></table></figure>
<p>部署flannel</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br></pre></td></tr></table></figure>
<p>这时再看kubernetes集群已经运行起来了 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                 STATUS   ROLES    AGE   VERSION</span><br><span class="line">master   Ready    master   27m   v1.14.1</span><br></pre></td></tr></table></figure>
<p>查看Kubernetes的名称空间 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get ns</span></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   28m</span><br><span class="line">kube-node-lease   Active   28m</span><br><span class="line">kube-public       Active   28m</span><br><span class="line">kube-system       Active   28m</span><br></pre></td></tr></table></figure>
<h3 id="其它node-1-3-节点加入kubernetes-集群"><a href="#其它node-1-3-节点加入kubernetes-集群" class="headerlink" title="其它node{1..3}节点加入kubernetes 集群"></a>其它node{1..3}节点加入kubernetes 集群</h3><p>在node{1..3} 分别执行以下命令 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start docker  &amp;&amp; systemctl enable docker &amp;&amp; systemctl enable kubelet</span></span><br><span class="line"><span class="comment"># kubeadm join 10.1.87.80:6443 --token 7pr4nt.q2vfoir7qia0vrcd     --discovery-token-ca-cert-hash sha256:7e38f83642e4633a48efa1bd2bdc3cd2523e83736091b38ead58c88530758bdc --ignore-preflight-errors=swap</span></span><br></pre></td></tr></table></figure>
<p>注: 这里需要手动去下载指定的镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim  docker_install_join_kublet_image.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0</span><br></pre></td></tr></table></figure>
<p>将这个脚本同步到其它所有从服务器并执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># scp docker_install_join_kublet_image.sh  node02:/root/</span></span><br><span class="line"><span class="comment"># scp docker_install_join_kublet_image.sh  node03:/root/</span></span><br><span class="line"><span class="comment"># 其余节点执行</span></span><br><span class="line"><span class="comment"># sh docker_install_join_kublet_image.sh</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME                   STATUS   ROLES    AGE   VERSION</span><br><span class="line">node01   Ready    &lt;none&gt;   74m   v1.14.1</span><br><span class="line">node02   Ready    &lt;none&gt;   74m   v1.14.1</span><br><span class="line">node03   Ready    &lt;none&gt;   71m   v1.14.1</span><br><span class="line">master   Ready    master   16h   v1.14.</span><br></pre></td></tr></table></figure>
<p>至此kubernetes 集群已经初始化完成</p>
<h2 id="kubernetes-应用快速入门"><a href="#kubernetes-应用快速入门" class="headerlink" title="kubernetes 应用快速入门"></a>kubernetes 应用快速入门</h2><p>描述一个节点 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe node node01</span></span><br></pre></td></tr></table></figure>
<p>查看kubernetes 集群信息 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl version</span></span><br><span class="line"><span class="comment"># kubectl cluster-info</span></span><br></pre></td></tr></table></figure>
<p>创建一个nginx Pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"># curl 10.244.3.2</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">Commercial support is available at</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当把pod 手动删除时，会重新创建，因为首次创建pod 时指定了 replicas=1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl delete pod nginx-deploy-55d8d67cf-qwlc2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods  -o wide</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE     IP           NODE                   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-deploy-55d8d67cf-qj9z8   1/1     Running   0          5m44s   10.244.1.2   node01                 &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>暴露服务端口 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl expose deployment nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP</span></span><br><span class="line">service/nginx exposed</span><br><span class="line"><span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   2d16h</span><br><span class="line">nginx        ClusterIP   10.96.181.70   &lt;none&gt;        80/TCP    52s</span><br></pre></td></tr></table></figure>
<p>在集群内部访问 10.96.181.70 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"># curl 10.96.181.70</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">Commercial support is available at</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">You have new mail in /var/spool/mail/root</span><br></pre></td></tr></table></figure>
<p>查看 kube-system (kube-dns) 的CLUSTER-IP</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   2d16h</span><br></pre></td></tr></table></figure>
<p>创建客户端 Pod </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"># kubectl run client --image=busybox --replicas=1 -it --restart=Never</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local localdomain</span><br><span class="line">options ndots:5</span><br><span class="line"># dig -t A  nginx.default.svc.cluster.local @10.96.0.10</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-73.el7_6 &lt;&lt;&gt;&gt; -t A nginx.default.svc.cluster.local @10.96.0.10</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 19937</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;nginx.default.svc.cluster.local. IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">nginx.default.svc.cluster.local. 5 IN	A	10.96.181.70</span><br><span class="line"></span><br><span class="line">;; Query time: 1 msec</span><br><span class="line">;; SERVER: 10.96.0.10#53(10.96.0.10)</span><br><span class="line">;; WHEN: Sun Apr 28 10:41:56 CST 2019</span><br><span class="line">;; MSG SIZE  rcvd: 107</span><br><span class="line"></span><br><span class="line">/ # wget -O - -q nginx</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">Commercial support is available at</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get deployment -w</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">myapp          1/2     2            1           70s</span><br><span class="line">nginx-deploy   1/1     1            1           60m</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl expose deployment myapp --name=myapp --port=80</span></span><br></pre></td></tr></table></figure>
<p>两个pod 之间随机调度</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># wget -O - -q myapp</span></span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-xnslk</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-xnslk</span><br><span class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br></pre></td></tr></table></figure>
<p>修改pod数量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl scale --replicas=5 deployment myapp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">client                         1/1     Running   0          35m</span><br><span class="line">myapp-5bc569c47d-fhf7w         1/1     Running   0          22m</span><br><span class="line">myapp-5bc569c47d-mqzdc         1/1     Running   0          112s</span><br><span class="line">myapp-5bc569c47d-w55fb         1/1     Running   0          13m</span><br><span class="line">myapp-5bc569c47d-xkk2x         1/1     Running   0          112s</span><br><span class="line">myapp-5bc569c47d-xnslk         1/1     Running   0          22m</span><br><span class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          32m</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># while sleep 1 ; do wget -O - -q myapp/hostname.html ;done</span></span><br><span class="line">myapp-5bc569c47d-mqzdc</span><br><span class="line">myapp-5bc569c47d-mqzdc</span><br><span class="line">myapp-5bc569c47d-xkk2x</span><br><span class="line">myapp-5bc569c47d-xnslk</span><br><span class="line">myapp-5bc569c47d-w55fb</span><br><span class="line">myapp-5bc569c47d-mqzdc</span><br><span class="line">myapp-5bc569c47d-w55fb</span><br><span class="line">myapp-5bc569c47d-fhf7w</span><br><span class="line">myapp-5bc569c47d-xnslk</span><br><span class="line">myapp-5bc569c47d-xkk2x</span><br><span class="line">myapp-5bc569c47d-xnslk</span><br></pre></td></tr></table></figure>
<p>滚动更新 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl set image deployment myapp myapp=ikubernetes/myapp:v2</span></span><br><span class="line">deployment.extensions/myapp image updated</span><br></pre></td></tr></table></figure>
<p>实时监控滚动更新</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout status deployment myapp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># while sleep 1 ; do wget -O - -q myapp ;done</span></span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>回滚操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout undo deployment myapp</span></span><br><span class="line">deployment.extensions/myapp rolled back</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># while sleep 1 ; do wget -O - -q myapp ;done</span></span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">&quot;hostname.html&quot;</span>&gt;Pod Name&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>以myapp 为例，在集群外部进行访问</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl edit svc myapp</span></span><br><span class="line"><span class="built_in">type</span>: ClusterIp 改为以下</span><br><span class="line"><span class="built_in">type</span>: NodePort</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        2d17h</span><br><span class="line">myapp        NodePort    10.100.210.54   &lt;none&gt;        80:32672/TCP   46m</span><br><span class="line">nginx        ClusterIP   10.96.181.70    &lt;none&gt;        80/TCP         77m</span><br></pre></td></tr></table></figure>
<p>客户端外部访问</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~ ➤ <span class="keyword">while</span> sleep 1 ; <span class="keyword">do</span> curl http://10.1.87.80:32672/hostname.html ; <span class="keyword">done</span></span><br><span class="line">myapp-86984b4c7c-2vpjq</span><br><span class="line">myapp-86984b4c7c-2vpjq</span><br><span class="line">myapp-86984b4c7c-vw5md</span><br><span class="line">myapp-86984b4c7c-vj7qm</span><br><span class="line">myapp-86984b4c7c-vj7qm</span><br><span class="line">myapp-86984b4c7c-2vpjq</span><br></pre></td></tr></table></figure>
<p>此时便可以使用keepalived + nginx(或haproxy)等实现负载均衡</p>
<h2 id="资源定义清单入门"><a href="#资源定义清单入门" class="headerlink" title="资源定义清单入门"></a>资源定义清单入门</h2><p>定义一个简单的资源清单 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim pod-demo.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-demo</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    tier: frontend</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp</span><br><span class="line">    image: ikubernetes/myapp:v1</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:latest</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    - <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    - <span class="string">&quot;-c&quot;</span></span><br><span class="line">    - <span class="string">&quot;sleep 5000&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f pod-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE     IP             NODE                   NOMINATED NODE   READINESS GATE</span><br><span class="line">pod-demo                       1/2     Running   5          4m19s   10.244.3.124   node03                 &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>查看相关Pod相关信息 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe pod-demo</span></span><br></pre></td></tr></table></figure>
<h2 id="Pod控制器应用进阶"><a href="#Pod控制器应用进阶" class="headerlink" title="Pod控制器应用进阶"></a>Pod控制器应用进阶</h2><p>-L 选项 用于指定显示指定资源对象类别所有资源对应标签的值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -L app</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE    APP</span><br><span class="line">client                         1/1     Running   0          8d</span><br><span class="line">myapp-86984b4c7c-rf4lz         1/1     Running   0          27h</span><br><span class="line">myapp-86984b4c7c-wss2h         1/1     Running   0          28h</span><br><span class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</span><br><span class="line">pod-demo                       2/2     Running   121        7d2h   myapp</span><br></pre></td></tr></table></figure>
<p>-l 获取标签，做标签过滤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -l app --show-labels</span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE    LABELS</span><br><span class="line">pod-demo   2/2     Running   121        7d2h   app=myapp,tier=frontend</span><br></pre></td></tr></table></figure>
<p>显示多个标签的标签值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -L app,run</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE    APP     RUN</span><br><span class="line">client                         1/1     Running   0          8d             client</span><br><span class="line">myapp-86984b4c7c-rf4lz         1/1     Running   0          27h            myapp</span><br><span class="line">myapp-86984b4c7c-wss2h         1/1     Running   0          28h            myapp</span><br><span class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d             nginx-deploy</span><br><span class="line">pod-demo                       2/2     Running   121        7d2h   myapp</span><br></pre></td></tr></table></figure>
<p>pod-demo 再次打标签</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label pods pod-demo release=canary</span></span><br><span class="line">pod/pod-demo labeled</span><br><span class="line"><span class="comment"># kubectl  get  pods -l app --show-labels;</span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE    LABELS</span><br><span class="line">pod-demo   2/2     Running   121        7d2h   app=myapp,release=canary,tier=frontend</span><br></pre></td></tr></table></figure>
<p>如果已有标签强行打标的话会报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label pods pod-demo release=stable</span></span><br><span class="line">error: <span class="string">&#x27;release&#x27;</span> already has a value (canary), and --overwrite is <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>这个时候需要加上 –overwrite </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label pods pod-demo release=stable --overwrite</span></span><br><span class="line">pod/pod-demo labeled</span><br></pre></td></tr></table></figure>
<p>查看既有release标签的又有app标签的Pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -l release,app</span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-demo   2/2     Running   121        7d2h</span><br></pre></td></tr></table></figure>
<p>给nginx-deploy Pod打标签 release=canary</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label pods nginx-deploy-55d8d67cf-v85hb release=canary</span></span><br><span class="line">pod/nginx-deploy-55d8d67cf-v85hb labeled</span><br></pre></td></tr></table></figure>
<p>查看 标签release=canary的Pod</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get pods -l release</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</span><br><span class="line">pod-demo                       2/2     Running   121        7d3h</span><br><span class="line"><span class="comment"># kubectl  get pods -l release=canary</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br></pre></td></tr></table></figure>
<p>标签选择器多条件选择</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -l release=stable,app=myapp</span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-demo   2/2     Running   121        7d3h</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -l release!=stable</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">client                         1/1     Running   0          8d</span><br><span class="line">myapp-86984b4c7c-rf4lz         1/1     Running   0          27h</span><br><span class="line">myapp-86984b4c7c-wss2h         1/1     Running   0          28h</span><br><span class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods -l &quot;release in (canary,beta,alpha)&quot;</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</span><br><span class="line"><span class="comment"># kubectl get pods -l &quot;release notin (canary,beta,alpha)&quot;</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">client                   1/1     Running   0          8d</span><br><span class="line">myapp-86984b4c7c-rf4lz   1/1     Running   0          27h</span><br><span class="line">myapp-86984b4c7c-wss2h   1/1     Running   0          28h</span><br><span class="line">pod-demo                 2/2     Running   121        7d3h</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl  get nodes --show-labels</span></span><br><span class="line">NAME                   STATUS   ROLES    AGE   VERSION   LABELS</span><br><span class="line">node01                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node01,kubernetes.io/os=linux</span><br><span class="line">node02                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node02,kubernetes.io/os=linux</span><br><span class="line">node03                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node03,kubernetes.io/os=linux</span><br><span class="line">master                 Ready    master   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master,kubernetes.io/os=linux,node-role.kubernetes.io/master=</span><br></pre></td></tr></table></figure>
<p>给node01 打额外标签，磁盘类型有固态硬盘</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl label nodes node01  disktype=ssd</span></span><br><span class="line"><span class="comment"># kubectl get nodes node01  --show-labels</span></span><br><span class="line">NAME                   STATUS   ROLES    AGE   VERSION   LABELS</span><br><span class="line">node01                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=node01,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>
<p>这样做的好处: 当节点有标签后，随后添加资源时就可以对节点有倾向性</p>
<p>如下，创建Pod时指定nodeSelector</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;sleep 5000&quot;</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>
<p>nodeSelector disktype: ssd<br>nodeName 指定直接运行在哪个节点上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl describe pods pod-demo</span></span><br><span class="line">可以查看以下信息，确定pod-demo 运行在node01上面 </span><br><span class="line">  Type    Reason     Age    From                           Message</span><br><span class="line">  ----    ------     ----   ----                           -------</span><br><span class="line">  Normal  Scheduled  2m46s  default-scheduler              Successfully assigned default/pod-demo to node01</span><br></pre></td></tr></table></figure>
<p>annotations 添加注解</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ssjinyao.com/create-by:</span> <span class="string">&quot;cluster admin&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;sleep 5000&quot;</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f pod-demo.yaml</span></span><br><span class="line"><span class="comment"># kubectl describe  pods pod-demo</span></span><br><span class="line">Annotations:        ssjinyao.com/create-by: cluster admin</span><br></pre></td></tr></table></figure>
<p>ExecAction 用自定义的命令存活性探测</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim liveness-exec.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-exec-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span> , <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;test&quot;</span>,<span class="string">&quot;-e&quot;</span>,<span class="string">&quot;/tmp/healthy&quot;</span>]</span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># kubectl create -f liveness-exec.yaml</span></span><br><span class="line"><span class="comment"># kubectl get pods -w</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">client</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">10d</span></span><br><span class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">47s</span></span><br><span class="line"><span class="string">myapp-86984b4c7c-rf4lz</span>         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3d4h</span></span><br><span class="line"><span class="string">myapp-86984b4c7c-wss2h</span>         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3d5h</span></span><br><span class="line"><span class="string">nginx-deploy-55d8d67cf-v85hb</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">10d</span></span><br><span class="line"><span class="string">pod-demo</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">34</span>         <span class="string">2d</span></span><br><span class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="string">69s</span></span><br><span class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span>          <span class="string">2m19s</span></span><br><span class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">3</span>          <span class="string">3m28s</span></span><br></pre></td></tr></table></figure>
<p>这个时候liveness-exec-pod 会不断因存活性探测而重启</p>
<p>基于HTTPGetAction探测</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim liveness-httpget.yaml</span></span><br><span class="line"><span class="comment"># cat liveness-httpget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-httpget-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># kubectl create -f liveness-httpget.yaml</span></span><br><span class="line"><span class="comment"># kubectl  exec liveness-httpget-pod -it -- /bin/sh</span></span><br><span class="line"><span class="comment"># rm -f /usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="comment"># kubectl  get pods</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">client</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">10d</span></span><br><span class="line"><span class="string">liveness-httpget-pod</span>           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span>          <span class="string">6m31s</span></span><br></pre></td></tr></table></figure>
<p>就续状态检查，如果pod不就续则不向外提供服务</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim readiness-httpget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">readiness-httpget-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness-httpget-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br><span class="line"><span class="comment"># kubectl exec readiness-httpget-pod -it -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># rm -f /usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="comment"># kubectl  get pods</span></span><br><span class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">readiness-httpget-pod</span>          <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m52s</span></span><br></pre></td></tr></table></figure>
<p>可以看到readinss-httpget-pod 是不就续的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl exec readiness-httpget-pod -it -- /bin/sh</span></span><br><span class="line">/ <span class="comment"># echo &quot;test html&quot; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="comment"># kubectl  get pods</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">readiness-httpget-pod          1/1     Running   0          4m30s</span><br></pre></td></tr></table></figure>
<p>当创建就绪探测HTTPGet页面文件时， pod 就绪状态立马恢复; </p>
<p>Pod生命周期行为，启动前钩子，终止前钩子 lifecycle postStart postStop;</p>
<p><code>注: 启动容器时先执行command 再执行postStart因此 command命令不能强依赖于postStart执行结果;</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim poststart-pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">poststart-pod</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox-httpd</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:latest</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">lifecycle:</span></span><br><span class="line">        <span class="attr">postStart:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo &#x27;welcome www.ssjinyao.com&#x27; &gt;  /tmp/index.html&quot;</span>]</span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;httpd -h /tmp  &amp;&amp; sleep 300000&quot;</span> ]</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes笔记</title>
    <url>/2018/10/04/kubernetes%20%E7%AC%94%E8%AE%B0%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kubernetes-笔记"><a href="#kubernetes-笔记" class="headerlink" title="kubernetes 笔记"></a>kubernetes 笔记</h1><p><img src="/images/kubernetes.png" class="lazyload" data-srcset="/images/kubernetes.png" srcset="data:image/png;base64,666" alt=""><br>CI: 持续集成<br>CD: 持续交付，Delivery<br>CD: 持续部署，Deployment</p>
<p><a href="https://github.com/kubernetes/kubernetes/releases">kubernetes的releases版本</a></p>
<p>kubernetes  自动装箱、自我修复、自动实现水平扩展<br>自动实现服务发现和负载均衡，自动发布和回滚<br>密钥和配置集中化管理、存储编排(动态供给)<br>任务批处理</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">master&#x2F;node </span><br><span class="line">    master: API Sserver,Scheduler, Controller-Manager</span><br><span class="line">    node: kubelet, docker(容器引擎), kube-proxy</span><br><span class="line">Pod， Label, Label Selector </span><br><span class="line">    Label: key&#x3D;value</span><br><span class="line">    Label: Selector:</span><br><span class="line">Pod:</span><br><span class="line">    自主式Pod</span><br><span class="line">    控制器管理的Pod</span><br><span class="line">    ReplicationController</span><br><span class="line">    ReplicaSet</span><br><span class="line">    Deployment</span><br><span class="line">    StateFulSet(有状态副本集)</span><br><span class="line">    DaemonSet</span><br><span class="line">    Job,Ctonjob</span><br><span class="line">    AddOns: 附加组件</span><br><span class="line">HPA</span><br><span class="line">    HorizontalPodAutoscaler</span><br></pre></td></tr></table></figure>
<p>Master 节点: 整个k8s集群的司令部<br>核心组件: api_server 负责接收并处理请求<br>         schechuler 调度容器的创建请求<br>         控制器管理器: 确保控制器是健康状态的<br>k8s 并不直接调度容器，而调度的是pod。pod对容器做为封装;</p>
<p>服务的自动发现功能，就是把自己信息注册上去;<br>NMT: 一般开放给外部访问的只有N，而N 在集群内其实是也是客户端;<br>在一个大的集群中，只把有特殊需求的，开放给客户端;<br>LBaaS: 负载均衡及服务;</p>
<p>多种通信<br>同一个Pod内的多个容器间通信:lo<br>各Pod之间的通信 Overlay Network,叠加网络通信(二层叠加，三层叠加)<br>Pod与Service之间的通信</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CNI插件体系:容器网络接口</span><br><span class="line">    flannel: 网络配置</span><br><span class="line">    calico: 网络配置，网络策略</span><br><span class="line">    canel: 网络配置，网络策略</span><br></pre></td></tr></table></figure>
<p>客户端–&gt; API server<br>    user: username, uid<br>    group:<br>    extra:</p>
<p><img src="/images/kubernetes-network.png" class="lazyload" data-srcset="/images/kubernetes-network.png" srcset="data:image/png;base64,666" alt=""></p>
<p>环境:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">master: etcd: 10.180.66.11</span><br><span class="line">node1: 10.180.66.12</span><br><span class="line">node2: 10.180.66.13</span><br><span class="line">注意这三台服务器需要时间同步</span><br></pre></td></tr></table></figure>
<p>前提:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、基于主机名通信: &#x2F;etc&#x2F;hosts;</span><br><span class="line">2、时间同步;</span><br><span class="line">3、关闭firewalld和iptables.service;</span><br><span class="line"></span><br><span class="line">OS: CentOS 7.3.1611， Extras仓库中;</span><br></pre></td></tr></table></figure>
<p>安装配置步骤:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、etcd cluster，仅Master节点;</span><br><span class="line">2、flannel,集群的所有节点;</span><br><span class="line">3、配置k8s的master:仅master节点;</span><br><span class="line">    kubernetes-master</span><br><span class="line">    启动的服务:</span><br><span class="line">        kube-apiserver,kub-scheduler,kube-controller-manager</span><br><span class="line">4、配置k8s的各Node节点;</span><br><span class="line">    kubernetes-node</span><br><span class="line">    先设定启动docker服务;</span><br><span class="line">    启动的k8s的服务:</span><br><span class="line">        kube-proxy,kubelet</span><br></pre></td></tr></table></figure>
<p>kubeadm</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、master, nodes:安装kubelet,kubeadm,docker</span><br><span class="line">2、master: kubeadm init</span><br><span class="line">3、nodes: kubeadm join</span><br><span class="line">    https:&#x2F;&#x2F;github.com&#x2F;kubernetes&#x2F;kubeadm&#x2F;blob&#x2F;master&#x2F;docs&#x2F;design&#x2F;design_v1.10.md</span><br><span class="line">无论server 还是node  一般服务 </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">master:</span><br><span class="line"># cd &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line"># wget https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos-ce.repo</span><br><span class="line"># vim kubernetes.repo  </span><br><span class="line">[kubernetes]</span><br><span class="line">name&#x3D;Kubernetes Repo </span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;repos&#x2F;kuberentes-el7-x86_64&#x2F;</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">pgkey&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;yum-key.gpg</span><br><span class="line">enabled&#x3D;1</span><br><span class="line"># yum -y install docker-ce kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<p>补充:<br><a href="https://mirrors.tuna.tsinghua.edu.cn">清华大学mirrors地址</a><br><a href="https://mirrors.aliyun.com/kubernetes/yum">阿里云k8s地址</a></p>
<hr>
<p>提供网络功能<br>RESTful<br>    GET, PUT, DELETE, POST, …<br>    kubectl run, get, edit, …<br>资源:对象<br>    工作负载性资源对象 workload: Pod,ReplicaSet, Deployment, StatefulSet, DaemonSet, Job, Cronjob, …<br>    服务发现及服务均衡: Service, Ingerss, …<br>    配置与存储: Volume,CSI<br>        ConfigMap,Secret,<br>        DownwardAPI,<br>    集群级资源:<br>        Namespace,Node,Role,ClusterRole,RoleBinding, ClusterRoleBinding<br>    无数据型资源:<br>        HPA,PodTemplate,LimitRange<br>创建资源的方法:<br>    apiserver仅接收JSON格式的资源定义;<br>    yaml格式提供配置清单，apiserver可自动将其转为json格式，而后再提交;</p>
<p>大部分资源的配置清单:<br>    apiversion:group/version;<br>        $ kubectl api-versions<br>    kind:资源类别<br>    metadata:元数据<br>        name必需是唯一的<br>        namespace<br>        labels<br>        annotations<br>        每个资源的引用PATH<br>        /api/GROUP/VERSION/namspace/NAMESAPCE/TYPE/NAME<br>    spec:期望的状态，disired state<br>    status: 当前状态，current state,本字段由kubernetes集群维护;<br>资源配置清单:<br>    自主式Pod资源<br>    资源的清单格式:<br>        一级字段: apiVersion(group/version),kind,metadata(name,namespace,lables,annotations,…)spec,status(只读)<br>    Pod资源:<br>        spec.container&lt;[]object&gt;</p>
<pre><code>- name &lt;string&gt;
- image &lt;string&gt;
  imagePullPloicy &lt;string&gt;
    Always(下载), Never(不下载), IfNotPresent(本地不存在镜像则下载)
</code></pre><p> 修改镜像中的默认应用:<br>    command,args<br>    <a href="https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/">https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/</a></p>
<p>liveness probe:存活状态检测</p>
<hr>
<table>
<thead>
<tr>
<th>Image Entrypoint</th>
<th>Image Cmd</th>
<th>Container command</th>
<th>Container args</th>
<th>Command run</th>
</tr>
</thead>
<tbody>
<tr>
<td>[/ep-1]</td>
<td>[foo bar]</td>
<td>\<not set></td>
<td>\<not set></td>
<td>[ep-1 foo bar]</td>
</tr>
<tr>
<td>[/ep-1]</td>
<td>[foo bar]</td>
<td>[/ep-2]</td>
<td>\<not set></td>
<td>[ep-2]</td>
</tr>
<tr>
<td>[/ep-1]</td>
<td>[foo bar]</td>
<td>\<not set></td>
<td>[zoo boo]</td>
<td>[ep-1 zoo boo]</td>
</tr>
<tr>
<td>[/ep-1]</td>
<td>[foo bar]</td>
<td>[/ep-2]</td>
<td>[zoo boo]</td>
<td>[ep-2 zoo boo]</td>
</tr>
</tbody>
</table>
<hr>
<p>标签:<br>    key=value<br>    key: 字母、数字、_、-、.<br>    value: 可以为空,只能字母或数字开头及结尾，中间可使用<br>标签选择器:<br>    等值关系:=，==，!=<br>    集合关系:<br>        KEY in (VALUE1,VALUE2,…)<br>        KEY notin (VALUE1,VALUE2,…)<br>        KEY 存在这个键就可以<br>        !KEY 不存在这个键的资源<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># kubectl get pods -l &quot;release notin (canary,beta,alpha)&quot;</span><br></pre></td></tr></table></figure><br>许多资源支持内嵌字段定义其使用的标签选择器:<br>matchLables: 直接给定键值<br>matchLables: 基于给定的表达式来定义使用的标签选择器,{key:”KEY”,operator:”OPERATOR”, value:[VAL1,VAL2,…]}<br>    操作符:<br>        IN, NotIN:vlaues字段的值必须为空列表;<br>         Exists, NotExists:values字段的值必须为空列表;</p>
<hr>
<p>nodeSelector &lt;map[string]string&gt;<br>    节点标签选择器,<br>nodeName <string><br>annotations:<br>    与label不同的地方在于， 它不能用于挑选资源对象，仅用于为对象提供”元数据”。<br>Pod的生命周期<br>    状态:Pending(挂起)，已经创建，但未找到运行它的节点;<br>        Running;<br>        Failed;<br>        Succeede;<br>        Unknown<br>        Pod生命周期中的重要行为：<br>            实始化容器<br>            容器探测：<br>                liveness<br>                readliness<br>        restartPolicy:<br>            Always, OnFailure, Never. Default to Always.</p>
<p>探针类型有三种:<br>    ExecAction、 TCPSocketAction、 HTTPGetAction</p>
<p>Pod控制器:<br>    ReplicationController:<br>    ReplicaSet: 代用户创建指定数量的Pod副本，多退少补，滚动更新;新一代的ReplicationController<br>    Deployment: 建构在ReplicaSet之上的，流动更新，回滚，声明式配置;<br>    DemonSet:<br>    Job:<br>    CronJob:<br>    StatefulSet<br>    TRR: Third Party Resources, 1.2+, 1.7<br>    CDR: Custom Defined Resources, 1.8+<br>    Operator:<br>一个坏的脚本在k8s集群中，很有可能导致整个k8s集群岩掉; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">    name: myapp</span><br><span class="line">    namespace: default </span><br><span class="line">spec:</span><br><span class="line">    replicas: 2 </span><br><span class="line">    relector:</span><br><span class="line">        matchLabels:</span><br><span class="line">            app: myapp</span><br><span class="line">            replease: canary</span><br><span class="line">    template:</span><br><span class="line">        metadata:</span><br><span class="line">            name: myapp-pod</span><br><span class="line">            labels:</span><br><span class="line">                app: myapp</span><br><span class="line">                replease: canary</span><br><span class="line">                environment:qa</span><br><span class="line">        spec:</span><br><span class="line">            contrainers:</span><br><span class="line">            - name: myapp-container</span><br><span class="line">              image: ikuberentes&#x2F;myapp:v1</span><br><span class="line">              ports:</span><br><span class="line">              - name: http</span><br><span class="line">                containerPort: 80</span><br><span class="line"># kubectl create -f rs-demo.yaml</span><br></pre></td></tr></table></figure>
<p>Helm: 外壳 类似于redhat系统上的yum管理器一样</p>
<p>Service<br>    工作模式:userspace, iptables, ipvs<br>        userspace: 1.1-<br>        iptables: 1.10-<br>        ipvs: 1.11+<br>    类型:<br>        ExternalName, CluseterIP, NodePort, and LoadBalancer<br>    资源记录:<br>        SVC_NAME.NS_NAME.DOMAIN.LTD.<br>        svc.cluster.local.<br>        redis.default.svc.custer.local.</p>
<p>NodePort:client –&gt; NodeIP:NodePort –&gt;ClusterIP:ServciePort –&gt; PodIP:containerPort<br>LoadBalancer<br>ExternelName<br>    FQDN<br>        CNAME –&gt; FQDN<br>No ClusterIP: Headless Service<br>    ServiceName –&gt; PodIP</p>
<p>解决方案<br>多组nginx server 对应多个pod;<br>多个url 映射多个pod;</p>
<p>配置容器化应用的方式:</p>
<p>1、 自定义命令行参数;<br>    args: []</p>
<p>2、 把配置文件直接焙进镜像;</p>
<p>3、 环境变量<br>    (1) Cloud Native的应用程序一般可以直接 通过环境变量加载配置;<br>    (2) 通过entrypoint脚本来预处理变量为配置文件中的配置信息;</p>
<p>4、 存储卷</p>
<p>CoreOS: operator<br>StatefulSet:</p>
<p>1、稳定且惟一的网络标识符;<br>2、稳定且持久的存储;<br>3、有序、平滑地部署和扩展;<br>4、有序、平滑地删除和终止;<br>5、有序的滚动更新;</p>
<p>三个组件: headless service、 StatefulSet 、 volumeClaimTemplate<br>pod_name.service_name.ns_name.svc.cluster.local<br>    myapp-0.myapp.default.svc.cluster.local</p>
<p>API<br>Request path<br>    <a href="http://172.20.0.70:6443/apls/apps/v1/namespaces/default/deployment/myapp-deploy/">http://172.20.0.70:6443/apls/apps/v1/namespaces/default/deployment/myapp-deploy/</a></p>
<p>HTTP request verb:<br>    get, post, pub, delete<br>API request verb:<br>    get, list, create, update, patch, watch, redirect, delete, deletecollection </p>
<p>Resource:<br>Subresource:<br>Namespace<br>API group</p>
<p>Object URL:<br>    /apis/<GROUP>/<VERSION>/namespaces/&lt;NAMESPACE_NAME&gt;/&lt;KIND/[OBJECT_ID]&gt; </p>
<p>role:<br>    operation<br>    objects<br>rolebinding:<br>    user account OR service account<br>    role</p>
<p>clusterrole, clusterrolebinding</p>
<p>role 授权: get * ; get pod ; get deployment;</p>
<p>授权插件: Node, ABAC, RBAC, Webhook(基于httpd的回调机制)<br>    RBAC: Role-based AC ‘<br>    角色(role)<br>    许可(permission)</p>
<p>当用户权限 rolebinding  绑定到 clusterrolebinding 时，clusterrolebinding 会被降权为rolebinding;</p>
<p>spec.serviceAccountName<br>    rolebinding<br>    serviceaccount<br>    role</p>
<p>Kubernetes:认证、授权<br>    API server:<br>        subject –&gt; action –&gt; object<br>      认证: token,tls,user/password<br>        账号:UserAccount, ServiceAccount<br>    授权:RBAC<br>        role,rolebinding<br>        clusterrole,clusterrolebinding<br>        subject:<br>            user<br>            group<br>            serviceaccount<br>        object:<br>            resource group<br>            resource<br>            non-resource url<br>        action:get,list,watch,patch,delete,deletecollection…</p>
<p>Dashboard<br>1、部署</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;flannel&#x2F;blob&#x2F;master&#x2F;Documentation&#x2F;kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>2、将Service 改为NodePort</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl patch svc kubernetes-dashboard -p &#39;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#39; -n kube-system</span><br></pre></td></tr></table></figure>
<p>3、 认证:<br>    认证时的账号必须为ServiceAccount: 被dashboard pod拿来由kubernetes进行认证的;<br>    token:<br>    (1) 创建ServiceAccount，根据其管理目标，使用rolebinding或clusterrolebinding 绑定至合理role或clusterrole;<br>    (2) 获取到此ServiceAccount的secret，查看secret的详细信息，其中就有token;</p>
<p>kubeconfig:把ServiceAccount的token封装为kubeconfig文件<br>    (1) 创建ServiceAccount，根据其管理目标，使用rolebinding或clusterrolebinding 绑定至合理role或clusterrole;<br>    (2) </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get secret | awk &#39;&#x2F;^ServiceAccount&#x2F;&#123;print $1&#125;&#39;</span><br><span class="line">DEF_NS_ADMIN_TOKEN&#x3D;$(kubectl get secret SERVCIEACCOUNT_SERRET_NAME -o jsonpath&#x3D;&#123;.data.token&#125; | base64 -d )</span><br></pre></td></tr></table></figure>
<p>(3)生成kubeconfig 文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl config set-cluster --kuberconfig&#x3D;&#x2F;PATH&#x2F;TO&#x2F;SOMEFILE</span><br><span class="line">kubectl config set-credentials NAME --token&#x3D;$KUBE_TOKEN --kubeconfig&#x3D;&#x2F;PATH&#x2F;TO&#x2F;SOMEFILE</span><br><span class="line">kubectl config set-context</span><br><span class="line">kubectl config use-context</span><br></pre></td></tr></table></figure>
<p>kubernetes集群的管理方式<br>1、命令式: create, run, expose, delete, edit, …<br>2、命令式配置文件:create -f /PATH/TO/RESOURCE_CONFIGURATION_FILE, delete -f , replace -f<br>3、声明式配置文件: apply -f,path,</p>
<p>docker 常用的四种网络模型 <code>bridge/joined/open/none</code></p>
<p>Kubernetes网络通信:<br>    （1）容器间通信: 同一个Pod内的多个容器间的通信，lo<br>    （2）Pod通信: Pod IP <--> Pod IP<br>    （3）Pod与Service通信:PodIP <--> ClusterIP<br>    （4）Service与集群外部客户端的通信<br>CNI: Container Network Interface<br>    flanner<br>    calico<br>    canel<br>    kube-router<br>    …<br>解决方案:<br>    虚拟网桥<br>    多路复用: MacVLAN<br>    硬件交换: SR-IOV<br>kubelet, /etc/cni/net.d/<br>flannel:<br>    支持多种后端:<br>        VxLAN<br>            （1）vxlan<br>            （2）Directrouting<br>        host-gw: Host Gateway<br>        UDP<br>flannel的配置参数<br>    Network: flannel使用的CIDR格式的网络地址，用于为Pod的配置网络功能;<br>        master:10.244.0.0/24<br>        node01:10.244.1.0/24<br>        …<br>        node255:10.244.255.0/24<br>    SubneteLen:把Network切分子网供各节点使用时，使用多长的掩码进行切分，默认为28位;<br>    SubnetMin:10.244.10.0/24 开始<br>    SubnetMax:10.244.100.0/24 结束<br>    Backend:vxlan, host-gw, udp<br>        vxlan:<br>网络策略:<br>    名称空间:<br>        拒绝所有出站，入站;<br>        放行所有出站目标本名称空间内的所有Pod;</p>
<p>调度器:<br>    预选策略:<br>        CheckNodeCondition<br>        GeneralPredicates:<br>            HostName: 检查Pod对象是否定义了pod.spec.hostname<br>            PodFitsHostPorts:pods.spec.containers.ports.hostPort<br>            MatchNodeSelector:pod.spec.nodeSelector<br>            PodFitsResources:检查Pod的资源需求是否能被节点所满足;<br>        NoDiskConflict:检查Pod依赖的存储卷是否能满足需求;<br>        PodToleratesNodeTaints:检查Pod的specl.tolerations可容容忍的污点是否完全包含节点上的污点;<br>        PodToleratesNodeNoExecuteTaints: 对应的行为是默认不检查的;<br>        CheckNodeLabelPresence: 检查节点指定标签的存在性;<br>        CheckServiceAffinity: 亲和性，将同一Service的Pod尽可能放在一块;<br>        MaxEBSVolumeCount<br>        MaxGCEPDVolumeCount<br>        MaxAzureDiskVolumeCount<br>        CheckVolumeBinding<br>        NoVolumeZoneConflict<br>        CheckNodeMemoryPressure: 检查内存节点是否存在压力;<br>        CheckNodePIDPressure: 检查PID数量是否过多;<br>        CheckNodeDiskPressure: 检查磁盘压力是否过大;<br>        MatchInterPodAffity: 检查节点是否满pod足亲和性与反亲和性<br>优选函数<br>    LeastRequested:(cpu((capacity-sum(requested))<em>10/capacity)+memory((capacity-sum(requested))</em>10/capacity))<br>    BalancedResourceAllocation: CPU和内存资源被占用率相近的胜出;<br>    NodePreferAvoidPods:节点注解信息”scheduler.alpha.kubernetes.io/perferAvoidPods”<br>    TaintToleration: 将Pod对象的spec.tolerations列表项与节点的 taints列表项进行匹配度检查，匹配条目越多，得分越低;<br>    SeletorSpreading:与当前Pod对象同属的标签选择器选择适配的其它选择其Pod对象所在的节点，越多的表示越低，否则越高;<br>    NodeAffinity:基于节点亲和性的;<br>    InterPodAffinity:遍历Pod对象的亲和性条目，并将能匹配到给定节点的条目的权重相加，结果值越大的，表示越高;</p>
<p>MostRequested:跟LeastRequested正好相反;<br>NodeLabel:标签越多，得分越高;<br>ImageLocality: 镜像越多，得分越高，根据满足当前Pod对象需求的已有镜像体积大小之和;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl describe nodes node node01.ssjinyao.com</span><br></pre></td></tr></table></figure>
<p>节点选择器:nodeSelector, nodeName<br>节点亲和调度: nodeAffinity </p>
<p>taint的effect定义对Pod排斥效果:<br>    NoSchedule: 仅影响调度过程，对现存的Pod对象不产生影响;<br>    NoExecute: 即影响调度过程，也影响现存的Pod对象;不容忍的Pod对象将被驱逐;<br>    PreferNoSchedule:不能容忍被调度过来，但是实在没有别的节点运行，也可被调度，是NoSchedule的柔性版;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">      release: canary</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app:myapp</span><br><span class="line">        release:canary</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: ikubernetes&#x2F;myapp:v2</span><br><span class="line">        ports:</span><br><span class="line">        - name: myapp</span><br><span class="line">          image: ikubernetes&#x2F;myapp: v2</span><br><span class="line">          ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 80</span><br><span class="line">        tolerations:</span><br><span class="line">        - key: &quot;node-type&quot;</span><br><span class="line">          operator: &quot;Equal&quot;</span><br><span class="line">          value: &quot;production&quot;</span><br><span class="line">          effect: &quot;NoSchedule&quot;</span><br></pre></td></tr></table></figure>
<p>容器的资源需求，资源限制<br>    requests: 需求，最低保障;<br>    limits: 限制，最高消耗区间，硬限制;<br>    CPU:<br>        1颗逻辑CPU<br>        1=1000微核心,millicores<br>            500m=0.5CPU<br>    内存:<br>        E、P、T、G、M、K<br>        Ei、Pi、Ti、Gi、Mi、Ki<br>    QoS:<br>        Guranteed: 每个容器同时设置CPU和内存的requests和limits;<br>            cpu.limits=cpu.requests<br>            memory.limits=memory.request<br>        Burstable:至少一个容器设置CPU或者内存资源的requests属性;<br>        BestEffort:没有任何一个容器设置了requests或limits属性;最低优先级别;<br>资源指标:metrics-server<br>自定义指标:prometheus，k8s-prometheus-adapter<br>新一代架架构:<br>    核心指标流水线: 由kubelet、metrics-server以及由API server 提供的api组成;CPU累积使用率、内存实时使用率、Pod的资源占用率及容器的磁盘占用率;<br>    监控流水线:用于从系统收集各种指标数据并提供终端用户、存储系统以及HPA，它们包含核心指标及许多非核心指标。非核心指标本身不能被k8s所解析,<br>   metrics-server:API-server<br>Helm:<br>    核心术语:<br>        Chart: 一个helm程序包的;<br>        Repository: Charts仓库，https/http服务器;<br>        Release: 特定的Chart部署于目标集群上的一个实例;<br>        Chart –&gt; Config –&gt; Release<br>    程序架构:<br>        helm:客户端，管理本地的Chart仓库，管理Chart，与Tiller服务器交互，发送Chart，实例安装、查询、卸载等操作;<br>        Tiller: 服务端，可以运行在kubernetes之上，也可以运行在kubernetes之外、接收helm发来的Charts与Config，合并生成release;<br>        RBAC配置文件示例:<br>            <a href="https://github.com/helm/helm/blob/master/docs/rbac.md">https://github.com/helm/helm/blob/master/docs/rbac.md</a><br>        官方可用的Chart列表:<br>            <a href="https://hub.kubeapps.com">https://hub.kubeapps.com</a><br>    helm常用命令:<br>        release管理 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># helm search jenkins</span><br><span class="line"># helm inspect jenkins</span><br><span class="line"># helm list </span><br><span class="line"># helm install</span><br><span class="line"># helm delete</span><br><span class="line"># helm upgrade</span><br><span class="line"># helm rollback</span><br><span class="line"># helm history # release的部署历史;</span><br><span class="line"># helm status # 获取release状态信息;</span><br><span class="line"># helm install --name redis -f .&#x2F;values.yaml stable&#x2F;redis </span><br></pre></td></tr></table></figure>
<p>chart管理 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># helm create</span><br><span class="line"># helm fetch</span><br><span class="line"># helm get </span><br><span class="line"># helm inspect</span><br><span class="line"># helm package 打包chart 文件</span><br><span class="line"># helm verify </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># helm lint ..&#x2F;myapp  # 检查语法错语</span><br><span class="line"># helm package myapp&#x2F;</span><br><span class="line"># helm delete --purge mapp3 </span><br><span class="line"># helm delete --purge mapp2</span><br><span class="line"># helm delete --purge mapp1</span><br><span class="line"># helm repo add --help </span><br><span class="line"># helm repo list </span><br></pre></td></tr></table></figure>
<p>Chart –&gt; helm,tiller service<br>Chart –&gt; Config –&gt;Release<br>Config:values.yaml</p>
<p>ELK: E:elasticsearch L:logstash K: kibana<br>日志收集的组件（Logstash、Filebeat、Fluentd）</p>
<p>当pod出现挂了的情况，查看pod日志时不方便查看。因此，应该将日志提前放到一个存储中。kubernetes集群应提供一个日志收集器。<br>完整的kubernetes 集群 (kubdns| kubcurl ,ingress controller,heapster| metrics-server prometheus, dashboard)<br>四大组件组成部分，另外附加附件efk;</p>
<p>/var/log  –&gt; /var/log/containers/<br>k8s系统关键组件:<br>Core Infrastructure –&gt; Network(SDN) Storage (Provisioning Congfiguration ) –&gt; Kubernetes Cluster –&gt; Containerzed Worload (image registry)<br>额外的系统:Logging Monitoring<br>硬件及负载、软件及负载:LoadBalancer<br>存储位置:Artifact factory<br>构建自动化:Build Automation (CI,CD)<br>自动化发布:Rlease Automation</p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>docker笔记(二)</title>
    <url>/2018/10/02/docker%E7%AC%94%E8%AE%B0%E4%BA%8C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="docker-笔记-二"><a href="#docker-笔记-二" class="headerlink" title="docker 笔记(二)"></a>docker 笔记(二)</h1><p><img src="/images/docker-image-2.png" class="lazyload" data-srcset="/images/docker-image-2.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Docker-Data-Volume"><a href="#Docker-Data-Volume" class="headerlink" title="Docker Data Volume"></a>Docker Data Volume</h2><p>关闭并重启容器，其数据不受影响; 但删除Docker容器，则其更将会全部丢失;<br>存在的问题<br>存储于联合文件系统中，不易于宿主机访问;<br>容器间数据共享不便;<br>删除容其数据会全部丢失;<br>解决方案:”卷(volume)”</p>
<p>“卷”是容器上的一个或多个”目录”，此类目录可绕过联合文件系统，与宿主机上的某目录”绑定(关联)”<br>Volume 于容器初始化之时即会创建，由base image提供的卷中的数据会于此期间完成复制<br>Volume 的初衷是独立于容器的生命周期实现数据持久化，因此删除容器时即不会删除卷，也<br>不会对哪怕未被引用的卷做垃圾回收操作;</p>
<p>Docker有两种类型的卷，每种类型都在容器中存在一个挂载点，但其在宿主机上的位置有所不同;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name b2 -it -v &#x2F;data busybox</span><br></pre></td></tr></table></figure>
<p>打开另一个终端查看Mount信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker inspect b2 </span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">                &quot;Name&quot;: &quot;5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d&#x2F;_data&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;&#x2F;data&quot;,</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line"># echo &quot;hello container&quot; &gt;&gt; &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d&#x2F;_data&#x2F;test.html</span><br></pre></td></tr></table></figure>
<p>在容器中查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F; # cat data&#x2F;test.html</span><br><span class="line">hello container</span><br><span class="line">&#x2F; # echo &quot;test rj&quot; &gt;&gt; data&#x2F;test.html</span><br></pre></td></tr></table></figure>
<p>在宿主机上查看 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d&#x2F;_data&#x2F;test.html</span><br><span class="line">hello container</span><br><span class="line">test rj</span><br></pre></td></tr></table></figure>
<p>当容器退出并删除后，数据依然存在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name b2 -it --rm -v &#x2F;data&#x2F;volumes&#x2F;b2:&#x2F;data busybox</span><br><span class="line"># docker inspect b2 | grep volume</span><br><span class="line">                &quot;&#x2F;data&#x2F;volumes&#x2F;b2:&#x2F;data&quot;</span><br><span class="line">                &quot;Source&quot;: &quot;&#x2F;data&#x2F;volumes&#x2F;b2&quot;,</span><br></pre></td></tr></table></figure>
<p>查看inspect元素 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker inspect -f &#123;&#123;.Mounts&#125;&#125; b2</span><br><span class="line">[&#123;bind  &#x2F;data&#x2F;volumes&#x2F;b2 &#x2F;data   true rprivate&#125;]</span><br></pre></td></tr></table></figure>
<p>注: 两个容器可以共享同一个存储卷</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run -it --name c1 -v &#x2F;docker&#x2F;volumes&#x2F;v1:&#x2F;data busybox</span><br><span class="line"># docker run -it --name c2 -v &#x2F;docker&#x2F;volumes&#x2F;v1:&#x2F;data busybox</span><br></pre></td></tr></table></figure>
<p>复制使用其它容器的卷，为docker run 命令使用 –volumes-from选项</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run -it --name bbox1 -v &#x2F;docker&#x2F;volumes&#x2F;v1:&#x2F;data busybox </span><br><span class="line"># docker run -it --name bbox2 --volumes-from bbox1 busybox</span><br></pre></td></tr></table></figure>
<h2 id="docker-file"><a href="#docker-file" class="headerlink" title="docker file"></a>docker file</h2><p>FROM<br>FROM的指令是最重的一个且必须为Dockefile文件开篇的第一个非注释行，<br>用于为映像文件构建过程指定基准镜像，后续的指令运行于此基准镜像所提供的<br>运行环境。<br>实践中，基准镜像可以是任何可用镜像文件，默认情况下，docker build会在<br>docker 主机上查找指定的镜像文件，在其不存在时，则会从Docker Hub<br>Registry上拉取所需要的镜像文件<br>如果找不到指定的镜像文件，docker build会返回一个错误信息。</p>
<p>Syntax</p>
<p>FROM <repository>[:<tag>]或<br>FROM <resository>@<digest></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim Dockerfile</span><br><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">COPY index.html &#x2F;data&#x2F;web&#x2F;html</span><br><span class="line"># vim index.html </span><br><span class="line">&lt;h1&gt; ssjinyao httpd server.&lt;&#x2F;h1&gt;</span><br><span class="line"># docker build -t ssjinyaohttpd-img:v0.1-1 .&#x2F;</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1&#x2F;3 : FROM busybox:latest</span><br><span class="line"> ---&gt; e1ddd7948a1c</span><br><span class="line">Step 2&#x2F;3 : MAINTAINER &quot;Jinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"> ---&gt; Running in aa9838facca1</span><br><span class="line">Removing intermediate container aa9838facca1</span><br><span class="line"> ---&gt; 71258688ebeb</span><br><span class="line">Step 3&#x2F;3 : COPY index.html &#x2F;data&#x2F;web&#x2F;html</span><br><span class="line"> ---&gt; b23d8149125a</span><br><span class="line">Successfully built b23d8149125a</span><br><span class="line">Successfully tagged ssjinyaohttpd-img:v0.1-1</span><br></pre></td></tr></table></figure>
<p>验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name ssjinyao-web1 --rm ssjinyaohttpd-img:v0.1-1 cat &#x2F;data&#x2F;web&#x2F;html&#x2F;index.html</span><br><span class="line">&lt;h1&gt; ssjinyao httpd server.&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<p>复制目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line"># ls</span><br><span class="line">Dockerfile  index.html  yum.repos.d</span><br><span class="line"># docker build -t tinyhttpd:v0.1-2 .&#x2F;</span><br><span class="line"># docker build -t tinyhttpd:v0.1-2 .&#x2F;</span><br><span class="line">Sending build context to Docker daemon  26.11kB</span><br><span class="line">Step 1&#x2F;4 : FROM busybox:latest</span><br><span class="line"> ---&gt; e1ddd7948a1c</span><br><span class="line">Step 2&#x2F;4 : MAINTAINER &quot;ssjinayo &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 708bad816b72</span><br><span class="line">Step 3&#x2F;4 : COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 758051947b4d</span><br><span class="line">Step 4&#x2F;4 : COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line"> ---&gt; a4c01bf4fe8d</span><br><span class="line">Successfully built a4c01bf4fe8d</span><br><span class="line">Successfully tagged tinyhttpd:v0.1-2</span><br><span class="line"># docker run --name tinyweb1 --rm tinyhttpd:v0.1-2 ls &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">CentOS-Base.repo</span><br><span class="line">CentOS-CR.repo</span><br><span class="line">CentOS-Debuginfo.repo</span><br><span class="line">CentOS-Media.repo</span><br><span class="line">CentOS-Sources.repo</span><br><span class="line">CentOS-Vault.repo</span><br><span class="line">CentOS-fasttrack.repo</span><br><span class="line">docker-ce.repo</span><br><span class="line">epel-testing.repo</span><br><span class="line">epel.repo</span><br></pre></td></tr></table></figure>
<p>ADD 指令的使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim Dockerfile</span><br><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line"># docker build -t tinyhttpd:v0.1-3 .&#x2F;</span><br><span class="line">Sending build context to Docker daemon  26.11kB</span><br><span class="line">Step 1&#x2F;5 : FROM busybox:latest</span><br><span class="line"> ---&gt; e1ddd7948a1c</span><br><span class="line">Step 2&#x2F;5 : MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 708bad816b72</span><br><span class="line">Step 3&#x2F;5 : COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 758051947b4d</span><br><span class="line">Step 4&#x2F;5 : COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; a4c01bf4fe8d</span><br><span class="line">Step 5&#x2F;5 : ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">Downloading  1.025MB&#x2F;1.025MB</span><br><span class="line"> ---&gt; 884e8bf3725f</span><br><span class="line">Successfully built 884e8bf3725f</span><br><span class="line">Successfully tagged tinyhttpd:v0.1-3</span><br><span class="line"># docker run --name tinyweb1 --rm tinyhttpd:v0.1-3 ls &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">nginx-1.15.5.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">#ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">ADD nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line"># ls</span><br><span class="line">Dockerfile  index.html  nginx-1.15.5.tar.gz  yum.repos.d</span><br><span class="line"># docker build -t tinyhttpd:v0.1-4 .&#x2F;</span><br><span class="line"># docker run --name tinyweb --rm tinyhttpd:v0.1-4 ls &#x2F;usr&#x2F;local&#x2F;src</span><br><span class="line">nginx-1.15.5</span><br></pre></td></tr></table></figure>
<p>另外一种写法 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim Dockerfile</span><br><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">#ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">WORKDIR &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">ADD nginx-1.15.5.tar.gz .&#x2F; #这里的.&#x2F;相当于WORKDIR指定的目录</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">#ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">WORKDIR &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">ADD nginx-1.15.5.tar.gz .&#x2F;src&#x2F;</span><br><span class="line"></span><br><span class="line">VOLUME &#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line"># docker build -t tinyhttpd:v0.1-5 .&#x2F;</span><br><span class="line">Sending build context to Docker daemon  1.052MB</span><br><span class="line">Step 1&#x2F;7 : FROM busybox:latest</span><br><span class="line"> ---&gt; e1ddd7948a1c</span><br><span class="line">Step 2&#x2F;7 : MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"> ---&gt; Running in 206968a461e1</span><br><span class="line">Removing intermediate container 206968a461e1</span><br><span class="line"> ---&gt; acce38db09a6</span><br><span class="line">Step 3&#x2F;7 : COPY index.html &#x2F;data&#x2F;web&#x2F;html&#x2F;</span><br><span class="line"> ---&gt; cfac93db1094</span><br><span class="line">Step 4&#x2F;7 : COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line"> ---&gt; ccbddff1520b</span><br><span class="line">Step 5&#x2F;7 : WORKDIR &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line"> ---&gt; Running in 8bbda4faa5a4</span><br><span class="line">Removing intermediate container 8bbda4faa5a4</span><br><span class="line"> ---&gt; 1660db5c8614</span><br><span class="line">Step 6&#x2F;7 : ADD nginx-1.15.5.tar.gz .&#x2F;src&#x2F;</span><br><span class="line"> ---&gt; cfd686660ff8</span><br><span class="line">Step 7&#x2F;7 : VOLUME &#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line"> ---&gt; Running in e85008cba000</span><br><span class="line">Removing intermediate container e85008cba000</span><br><span class="line"> ---&gt; 529be777da05</span><br><span class="line">Successfully built 529be777da05</span><br><span class="line">Successfully tagged tinyhttpd:v0.1-5</span><br><span class="line"># docker run --name tinweb1 --rm tinyhttpd:v0.1-5 mount | grep data</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root on &#x2F;data&#x2F;mysql type xfs (rw,seclabel,relatime,attr2,inode64,noquota)</span><br></pre></td></tr></table></figure>
<p>EXPOSE 指令使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPOSE 1211&#x2F;udp 11211&#x2F;tcp # 启动镜像是要使用-P选项</span><br></pre></td></tr></table></figure>
<p>ENV </p>
<p>用于为镜像定义所需要的环境变量，并可被Dockerfile文件中位于其后其它指令<br>(ENV,ADD,COPY等)所调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">ENV DOC_ROOT &#x2F;data&#x2F;web&#x2F;html</span><br><span class="line"></span><br><span class="line">COPY index.html $DOC_ROOT</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">#ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.15.5.tar.gz &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">WORKDIR &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">ADD nginx-1.15.5.tar.gz .&#x2F;src&#x2F;</span><br><span class="line"></span><br><span class="line">VOLUME &#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line"></span><br><span class="line">EXPOSE 80&#x2F;tcp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name tinyweb1 --rm -P tinyhttpd:v0.1-7 printenv # 打印输出环境变量</span><br><span class="line"># docker run --name tinyweb --rm -P -e WEB_SERVER_PACKAGE&#x3D;&quot;nginx-1.15.1&quot; tinyhttpd:v0.1-7 printenv # -e 可以外部更改或指定环境变量的</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Deskription: test image</span><br><span class="line">FROM busybox:latest</span><br><span class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</span><br><span class="line"># LABEL maintainer&#x3D;&quot;ssjinyao&quot;</span><br><span class="line">ENV DOC_ROOT&#x3D;&#x2F;data&#x2F;web&#x2F;html&#x2F; \</span><br><span class="line">    WEB_SERVER_PACKAGE&#x3D;&quot;nginx-1.15.5.gz&quot;</span><br><span class="line"></span><br><span class="line">#当没有</span><br><span class="line">COPY index.html $&#123;DOC_ROOT: -&#x2F;data&#x2F;web&#x2F;html&#x2F;&#125;</span><br><span class="line">COPY yum.repos.d &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">ADD http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;$&#123;WEB_SERVER_PACKAGE&#125; &#x2F;usr&#x2F;local&#x2F;src&#x2F;</span><br><span class="line">WORKDIR &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">#ADD $&#123;WEB_SERVER_PACKAGE&#125;.tar.gz .&#x2F;src&#x2F;</span><br><span class="line"></span><br><span class="line">VOLUME &#x2F;data&#x2F;mysql&#x2F;</span><br><span class="line"></span><br><span class="line">EXPOSE 80&#x2F;tcp</span><br><span class="line"></span><br><span class="line">RUN cd &#x2F;usr&#x2F;local&#x2F;src &amp;&amp; \</span><br><span class="line">    tar xvf $&#123;WEB_SERVER_PACKAGE&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM busybox</span><br><span class="line">LABEL maintainer&#x3D;&quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot; app&#x3D;&quot;httpd&quot;</span><br><span class="line"></span><br><span class="line">ENV WEB_DOC_ROOT&#x3D;&quot;&#x2F;data&#x2F;web&#x2F;html&quot;</span><br><span class="line"></span><br><span class="line">RUN mkdir -p $WEB_DOC_ROOT &amp;&amp; \</span><br><span class="line">	echo &#39;&lt;h1&gt;Busybox httpd server.&lt;&#x2F;h1&gt;&#39; &gt; $&#123;WEB_DOC_ROOT&#125;&#x2F;index.html</span><br><span class="line"></span><br><span class="line"># COM &#x2F;bin&#x2F;httpd  -f -h $&#123;WEB_DOC_ROOT&#125;</span><br><span class="line">CMD [&quot;&#x2F;bin&#x2F;httpd&quot;, &quot;-f&quot;, &quot;-h $&#123;EWB_DOC_ROOT&#125;&quot;]</span><br><span class="line">ENTRYPOINT &#x2F;bin&#x2F;sh -c</span><br></pre></td></tr></table></figure>
<p>Dockerfile Nginx镜像 示例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir img_nginx</span><br><span class="line"># cd img_nginx</span><br><span class="line"># vim Dockerfile</span><br><span class="line">FROM nginx:1.14-alpine</span><br><span class="line"></span><br><span class="line">ARG author&#x3D;&quot;ssjinyao &lt;rejin@ssjinyao.com&gt;&quot;</span><br><span class="line"></span><br><span class="line">LABEL maintainer&#x3D;&quot;$&#123;author&#125;&quot;</span><br><span class="line"></span><br><span class="line">ENV NGX_DOC_ROOT&#x3D;&quot;&#x2F;data&#x2F;web&#x2F;html&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">ADD index.html $&#123;NGX_DOC_ROOT&#125;</span><br><span class="line">ADD entrypoint.sh &#x2F;bin&#x2F;</span><br><span class="line"></span><br><span class="line">EXPOSE 80&#x2F;tcp</span><br><span class="line"></span><br><span class="line">HEALTHCHECK --start-period&#x3D;3s CMD wget -O - -q http:&#x2F;&#x2F;$&#123;IP:-0.0.0.0&#125;:$&#123;PORT:-80&#125;&#x2F;</span><br><span class="line"></span><br><span class="line">CMD [&quot;&#x2F;usr&#x2F;sbin&#x2F;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;&#x2F;bin&#x2F;entrypoint.sh&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># vim index.html</span><br><span class="line">&lt;h1&gt; Dockerfile Nginx Test Page.&lt;&#x2F;h1&gt;</span><br><span class="line"></span><br><span class="line"># vim entrypoint.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">#</span><br><span class="line">cat &gt; &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;www.conf &lt;&lt;EOF</span><br><span class="line">server &#123;</span><br><span class="line">        server_name $&#123;HOSTNAME&#125;;</span><br><span class="line">        listen $&#123;IP:-0.0.0.0&#125;:$&#123;PORT:-80&#125;;</span><br><span class="line">        root $&#123;NGINX_DOC_ROOT:-&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#125;;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">exec &quot;$@&quot;</span><br><span class="line"># docker run --name myweb1 --rm -P  -e &quot;PORT&#x3D;8080&quot; nginx_web:v0.0-1</span><br><span class="line">127.0.0.1 - - [03&#x2F;Oct&#x2F;2018:07:43:31 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;Wget&quot; &quot;-&quot;</span><br><span class="line">127.0.0.1 - - [03&#x2F;Oct&#x2F;2018:07:44:01 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 612 &quot;-&quot; &quot;Wget&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>
<h2 id="自建docker-registry"><a href="#自建docker-registry" class="headerlink" title="自建docker-registry"></a>自建docker-registry</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install docker-registry</span><br><span class="line"># rpm -ql docker-distribution</span><br><span class="line">&#x2F;etc&#x2F;docker-distribution&#x2F;registry&#x2F;config.yml</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;registry</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker-distribution.service</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;registry</span><br></pre></td></tr></table></figure>
<p>注: docker push  客户端默认是https工作的，因此在客户端配置不加密传输</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;],</span><br><span class="line">    &quot;bip&quot;: &quot;10.0.0.1&#x2F;16&quot;,</span><br><span class="line">    &quot;hosts&quot;: [&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;,&quot;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock&quot;],</span><br><span class="line">    &quot;insecure-registries&quot;: [&quot;node2:5000&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># docker tag ssjinyao&#x2F;httpd:v0.1.1.1-2 node2:5000&#x2F;ssjinayo-web:v0.1.1.1-2</span><br><span class="line"># docker push node2:5000&#x2F;ssjinayo-web</span><br><span class="line">The push refers to repository [node2:5000&#x2F;ssjinayo-web]</span><br><span class="line">e6baf59e35e7: Pushed</span><br><span class="line">f9d9e4e6e2f0: Pushed</span><br><span class="line">v0.1.1.1-2: digest: sha256:2f3d6d2f468ee189b4b43ff2b9f99a6e3895d9832b606522176f804cba738037 size: 734</span><br></pre></td></tr></table></figure>
<p>服务端镜像默认保存的路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ls &#x2F;var&#x2F;lib&#x2F;registry&#x2F;docker&#x2F;registry&#x2F;v2&#x2F;repositories&#x2F;ssjinayo-web</span><br><span class="line">_layers  _manifests  _uploads</span><br></pre></td></tr></table></figure>
<p>私有docker 源pull 使用, 前提也要配置不加密传输</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker pull node2:5000&#x2F;ssjinayo-web:v0.1.1.1-2</span><br><span class="line">v0.1.1.1-2: Pulling from ssjinayo-web</span><br><span class="line">Digest: sha256:2f3d6d2f468ee189b4b43ff2b9f99a6e3895d9832b606522176f804cba738037</span><br><span class="line">Status: Downloaded newer image for node2:5000&#x2F;ssjinayo-web:v0.1.1.1-2</span><br></pre></td></tr></table></figure>
<h2 id="vmware-harbor私有源的安装与使用"><a href="#vmware-harbor私有源的安装与使用" class="headerlink" title="vmware-harbor私有源的安装与使用"></a>vmware-harbor私有源的安装与使用</h2><p><a href="https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md">vmware/harbor安装</a><br><a href="https://github.com/goharbor/harbor/releases">vmware/harbor下载</a></p>
<table>
<thead>
<tr>
<th style="text-align:right">Resource</th>
<th style="text-align:right">Capacity</th>
<th style="text-align:right">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">CPU</td>
<td style="text-align:right">minimal 2 CPU</td>
<td style="text-align:right">4 CPU is prefered</td>
</tr>
<tr>
<td style="text-align:right">Mem</td>
<td style="text-align:right">minimal 4GB</td>
<td style="text-align:right">8GB is prefered</td>
</tr>
<tr>
<td style="text-align:right">Disk</td>
<td style="text-align:right">minimal 40GB</td>
<td style="text-align:right">160GB is prefered</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install docker-compose</span><br><span class="line"># vim harbor.cfg # 这里根据自己的需求更改配置文件</span><br><span class="line"># vim docker-compose.yml # </span><br><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;harbor</span><br><span class="line"># .&#x2F;install </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                                    COMMAND                  CREATED             STATUS                   PORTS                                                              NAMES</span><br><span class="line">f01090bf5ba1        goharbor&#x2F;nginx-photon:v1.6.0             &quot;nginx -g &#39;daemon of…&quot;   3 minutes ago       Up 3 minutes (healthy)   0.0.0.0:80-&gt;80&#x2F;tcp, 0.0.0.0:443-&gt;443&#x2F;tcp, 0.0.0.0:4443-&gt;4443&#x2F;tcp   nginx</span><br><span class="line">7e4849fcb12a        goharbor&#x2F;harbor-jobservice:v1.6.0        &quot;&#x2F;harbor&#x2F;start.sh&quot;       3 minutes ago       Up 3 minutes                                                                                harbor-jobservice</span><br><span class="line">0d8ceb3ec5c0        goharbor&#x2F;harbor-ui:v1.6.0                &quot;&#x2F;harbor&#x2F;start.sh&quot;       3 minutes ago       Up 3 minutes (healthy)                                                                      harbor-ui</span><br><span class="line">c5780037bc8f        goharbor&#x2F;harbor-adminserver:v1.6.0       &quot;&#x2F;harbor&#x2F;start.sh&quot;       3 minutes ago       Up 3 minutes (healthy)                                                                      harbor-adminserver</span><br><span class="line">b184110cfac2        goharbor&#x2F;registry-photon:v2.6.2-v1.6.0   &quot;&#x2F;entrypoint.sh &#x2F;etc…&quot;   3 minutes ago       Up 3 minutes (healthy)   5000&#x2F;tcp                                                           registry</span><br><span class="line">83b4b2ea3b2e        goharbor&#x2F;redis-photon:v1.6.0             &quot;docker-entrypoint.s…&quot;   3 minutes ago       Up 3 minutes             6379&#x2F;tcp                                                           redis</span><br><span class="line">9055f4dcdaeb        goharbor&#x2F;harbor-db:v1.6.0                &quot;&#x2F;entrypoint.sh post…&quot;   3 minutes ago       Up 3 minutes (healthy)   5432&#x2F;tcp                                                           harbor-db</span><br><span class="line">583dd6d3dc30        goharbor&#x2F;harbor-log:v1.6.0               &quot;&#x2F;bin&#x2F;sh -c &#x2F;usr&#x2F;loc…&quot;   3 minutes ago       Up 3 minutes (healthy)   127.0.0.1:1514-&gt;10514&#x2F;tcp                                          harbor-log</span><br></pre></td></tr></table></figure>
<p><img src="/images/docker-vmware-harbor.png" class="lazyload" data-srcset="/images/docker-vmware-harbor.png" srcset="data:image/png;base64,666" alt=""></p>
<p>登录管理员后台<br><img src="/images/docker-vmware-harbor-loggin.png" class="lazyload" data-srcset="/images/docker-vmware-harbor-loggin.png" srcset="data:image/png;base64,666" alt=""></p>
<p>在 docker-vmware-harbor中创建普通用户，在普通用户中创建项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;insecure-registries&quot;: [&quot;blog.ssjinyao.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># docker login blog.ssjinyao.com</span><br><span class="line">Username: ssjinyao</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted in &#x2F;root&#x2F;.docker&#x2F;config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https:&#x2F;&#x2F;docs.docker.com&#x2F;engine&#x2F;reference&#x2F;commandline&#x2F;login&#x2F;#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">[root@ssjinyao-node2:~]# docker push blog.ssjinyao.com&#x2F;devel&#x2F;ssjinyao-httpd</span><br><span class="line">The push refers to repository [blog.ssjinyao.com&#x2F;devel&#x2F;ssjinyao-httpd]</span><br><span class="line">e6baf59e35e7: Pushed</span><br><span class="line">f9d9e4e6e2f0: Pushed</span><br><span class="line">v0.1.1.1-1: digest: sha256:7248231aa495c62947519646d25acb453fd2caf3ed6bf778b41e6201bd3e31fc size: 734</span><br><span class="line">e6baf59e35e7: Layer already exists</span><br><span class="line">f9d9e4e6e2f0: Layer already exists</span><br><span class="line">v0.1.1.1-2: digest: sha256:2f3d6d2f468ee189b4b43ff2b9f99a6e3895d9832b606522176f804cba738037 size: 734</span><br></pre></td></tr></table></figure>
<p><img src="/images/docker-vmware-harbor-ssjinyao.png" class="lazyload" data-srcset="/images/docker-vmware-harbor-ssjinyao.png" srcset="data:image/png;base64,666" alt=""></p>
<p>push 镜像前可以查看vmware-harbor的打标签提示</p>
<p><img src="/images/docker-vmware-harbor-ssjinyao-devel.png" class="lazyload" data-srcset="/images/docker-vmware-harbor-ssjinyao-devel.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker-compose pause 暂停</span><br><span class="line"># docker-compose unpause 运行</span><br><span class="line"># docker-compose stop 停止</span><br><span class="line"># docker-compose start 启动</span><br></pre></td></tr></table></figure>
<h2 id="docker-资源限制"><a href="#docker-资源限制" class="headerlink" title="docker 资源限制"></a>docker 资源限制</h2><p>OOME<br>一旦发生OOME，任何进程都有可能被杀死，包括docker daemon在内<br>为此，Dokcer特地调整了docker daemon的OOM优先级，以名它被内核”正法”<br>但容器的优先级并未被调整</p>
<table>
<thead>
<tr>
<th style="text-align:center">–memory-swap</th>
<th style="text-align:center">–memory</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">正数S</td>
<td style="text-align:center">正数M</td>
<td style="text-align:center">容器可用总空间为S,其中ram为M,swap为(S-M)若S=M,则无可用swap资源</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">正数M</td>
<td style="text-align:center">相当于未设置 swap(unset)</td>
</tr>
<tr>
<td style="text-align:center">unset</td>
<td style="text-align:center">正数M</td>
<td style="text-align:center">若主机(Docker Host)启用了swap,则容器的可用swap为2*M</td>
</tr>
<tr>
<td style="text-align:center">-1</td>
<td style="text-align:center">正数M</td>
<td style="text-align:center">若主机(Docker Host)启用了swap,则容器可使用最大至主机上所的所有swap空间的资源</td>
</tr>
<tr>
<td style="text-align:center">注意: 在容器使用free命令可以看到的swap空间并不是具有其所展现出的空间指示意义</td>
</tr>
</tbody>
</table>
<p>pull 一个压测镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker pull lorel&#x2F;docker-stress-ng</span><br><span class="line"># docker run --name stress -it --rm lorel&#x2F;docker-stress-ng:latest stress --help</span><br><span class="line"># docker run --name stree -it --rm -m 256m lorel&#x2F;docker-stress-ng:latest stress --vm 2</span><br></pre></td></tr></table></figure>
<p>查看启用的docker进程</p>
<p><img src="/images/docker-top-stress.png" class="lazyload" data-srcset="/images/docker-top-stress.png" srcset="data:image/png;base64,666" alt=""></p>
<p>查看stress 容器的分配内存状态 </p>
<p><img src="/images/docker-status-stee.png" class="lazyload" data-srcset="/images/docker-status-stee.png" srcset="data:image/png;base64,666" alt=""></p>
<p>同样的，当对cpu做压测时，指定上限为两个cpu，也就是使用率为200%，当压测为8个cpu时，cpu最高占用为200%  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name stress -it --rm --cpus 2 lorel&#x2F;docker-stress-ng:latest stress --cpu 8</span><br><span class="line"># docker run --name stress -it --cpuset-cpus 0,2 --rm lorel&#x2F;docker-stress-ng:latest stress --cpu 8  #设定只运行在第0和2个cpu上</span><br><span class="line"># docker run --name stress -it --cpus 2 --rm lorel&#x2F;docker-stress-ng:latest stresss --cpu8 #设定cpus 2 ，说明所有核心都能用到，但是最多只能使用200%</span><br><span class="line"># docker run --name stress -it --cpu-shares 1024 --rm lorel&#x2F;docker-stress-ng:latest stress --cpu 8 </span><br><span class="line"># 设定限制为尽可能多的分配cpu资源,最后这种模式，当再启一个容器时，会实时按比例分配cpu资源分到另一个容器，</span><br><span class="line"># docker run --name stress2 -it --cpu-shares 512 --rm lorel&#x2F;docker-stress-ng:latest stress --cpu 8 </span><br></pre></td></tr></table></figure>
<p><img src="/images/docker-strees-two-shares.png" class="lazyload" data-srcset="/images/docker-strees-two-shares.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>docker笔记(一)</title>
    <url>/2018/09/28/docker%E7%AC%94%E8%AE%B0%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="docker笔记-一"><a href="#docker笔记-一" class="headerlink" title="docker笔记(一)"></a>docker笔记(一)</h1><p><img src="/images/docker-images.png" class="lazyload" data-srcset="/images/docker-images.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Virtualization-And-Container"><a href="#Virtualization-And-Container" class="headerlink" title="Virtualization And Container"></a>Virtualization And Container</h2><h3 id="主机级虚拟化"><a href="#主机级虚拟化" class="headerlink" title="主机级虚拟化"></a>主机级虚拟化</h3><ol>
<li>Type-I 直接在硬件上做虚拟化;</li>
<li>Type-II 启动系统后，再做虚拟化;</li>
<li>真正能产生生产力的，是应用层面;</li>
<li>系统运行两颗树:进程树和文件系统树;</li>
<li>基于用户层面的隔离(UTS,Mount,IPC,PID,User,Net);</li>
<li>namespaces:名称空间，系统调用，向外输出(clone(),setns());</li>
</ol>
<h3 id="Linux-Namespaces"><a href="#Linux-Namespaces" class="headerlink" title="Linux Namespaces"></a>Linux Namespaces</h3><table>
<thead>
<tr>
<th>namespace</th>
<th>系统调用参数</th>
<th>隔离内容</th>
<th>内核版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTS</td>
<td>CLONE_NEWUTS</td>
<td>主机名和域名</td>
<td>2.6.19</td>
</tr>
<tr>
<td>IPC</td>
<td>CLONE_NEWIPC</td>
<td>信号量、消息队列和共享内存</td>
<td>2.6.19</td>
</tr>
<tr>
<td>PID</td>
<td>CLONE_NEWPID</td>
<td>进程编号</td>
<td>2.6.24</td>
</tr>
<tr>
<td>Network</td>
<td>CLONE_NEWNET</td>
<td>网络设备、网络栈、端口号等</td>
<td>2.6.29</td>
</tr>
<tr>
<td>Mount</td>
<td>CLONE_NEWNS</td>
<td>挂载点(文件系统)</td>
<td>2.4.19</td>
</tr>
<tr>
<td>User</td>
<td>CLONE_NEWUSER</td>
<td>用户和用户组</td>
<td>3.8</td>
</tr>
</tbody>
</table>
<h3 id="Control-Groups-cGroups"><a href="#Control-Groups-cGroups" class="headerlink" title="Control Groups(cGroups)"></a>Control Groups(cGroups)</h3><p>把系统级的资源分成多个组 </p>
<hr>
<ul>
<li>lxc-create,template</li>
<li>nmp</li>
<li>machine+swarm+compose </li>
<li>mesos+marathon</li>
<li>kubernetes -&gt; k8s</li>
<li>libcontainer -&gt; runC</li>
<li>Moby, CNCF</li>
<li>docker中的容器<br>  lxc -&gt; libcontainer -&gt; runC  </li>
<li>OCI Open Container Initiative<br>  旨在围绕容器式和运行时制定一个开放的式业化标准<br>  the Runtime Specification(runtime-spec)<br>  the Image Specification(image-spec)  </li>
<li>runC Open Container Format  </li>
</ul>
<p><code>https:hub.docker.com</code></p>
<ul>
<li>docker 的两个版本<br>docker-ee<br>docker-ce</li>
<li>docker architecture<br>  The Docker daemon<br>  The Docker client<br>  Docker registries</li>
<li>yum 中的仓库 repository,repo </li>
<li><p>docker 中的仓库 repository, repo<br>镜像名称  nginx:1.10  以此来命令镜像，nginx:1.15 nginx:latest 而镜像的默认版是最新版的<br>nginx:1.14 nginx:stable  最新稳定版<br>镜像：静态;<br>容器：动态，有生命周期，特别类似于程序;<br>容器常用资源: images, containers, networks, volumes, plugins,</p>
<h2 id="安装及使用docker"><a href="#安装及使用docker" class="headerlink" title="安装及使用docker"></a>安装及使用docker</h2></li>
<li><p>依赖的环境<br>  64 bits CPU<br>  Linux Kernel 3.10+<br>  Linux Kernel cgrups and namespace </p>
</li>
<li><p>CentOS 7<br>  “Extras” repository </p>
</li>
<li><p>Docker Daemon<br>  systemctl start docker.service</p>
</li>
<li><p>Docker Client<br>  docker[OPTIONS] COMMAND [arg …]</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  cd &#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line"># wget https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line"># yum makecache</span><br><span class="line"># yum repolist</span><br><span class="line"># yum remove docker docker-common container-selinux docker-selinux docker-engine</span><br><span class="line"># yum install docker-ce</span><br></pre></td></tr></table></figure>
<p>仓库配置文件: <a href="https://dowland.docker.com/linux/centos/docker-ce.repo">https://dowland.docker.com/linux/centos/docker-ce.repo</a></p>
<p>Docker组件:</p>
<p>docker程序环境:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">环境配置文件:</span><br><span class="line">    &#x2F;etc&#x2F;sysconfig&#x2F;docker-network</span><br><span class="line">    &#x2F;etc&#x2F;sysconfig&#x2F;docker-storage</span><br><span class="line">    &#x2F;etc&#x2F;sysconfig&#x2F;docker</span><br><span class="line">Unit FIle:</span><br><span class="line">    &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.serivce</span><br><span class="line">Docker Registry配置文件</span><br><span class="line">    &#x2F;etc&#x2F;contalners&#x2F;registries.conf </span><br><span class="line">docker-ce:</span><br><span class="line">    配置文件:&#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br></pre></td></tr></table></figure>
<p>注册阿里云账号，专用加速器地址获得路径:<br>    <a href="https://cr.console.aliyun.com/#/accelerator">https://cr.console.aliyun.com/#/accelerator</a></p>
<p>Docker镜像加速</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    docker cn </span><br><span class="line">    阿里云加速器 </span><br><span class="line">    中国科技大学</span><br><span class="line">&#123; </span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir &#x2F;etc&#x2F;docker</span><br><span class="line"># vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># systemctl start docker</span><br></pre></td></tr></table></figure>
<p>查看docker 版本信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker version</span><br><span class="line">Client:</span><br><span class="line"> Version:           18.06.1-ce</span><br><span class="line"> API version:       1.38</span><br><span class="line"> Go version:        go1.10.3</span><br><span class="line"> Git commit:        e68fc7a</span><br><span class="line"> Built:             Tue Aug 21 17:23:03 2018</span><br><span class="line"> OS&#x2F;Arch:           linux&#x2F;amd64</span><br><span class="line"> Experimental:      false</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.06.1-ce</span><br><span class="line">  API version:      1.38 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.3</span><br><span class="line">  Git commit:       e68fc7a</span><br><span class="line">  Built:            Tue Aug 21 17:25:29 2018</span><br><span class="line">  OS&#x2F;Arch:          linux&#x2F;amd64</span><br><span class="line">  Experimental:     false</span><br><span class="line"># docker info</span><br></pre></td></tr></table></figure>
<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker search : 搜索镜像</span><br><span class="line"># docker search nginx</span><br><span class="line">docker pull: 下载镜像到本地</span><br><span class="line"># docker pull nginx:1.14-alpine-perl</span><br><span class="line"># docker pull busybox:latest</span><br><span class="line"># docker image pull nginx:1.14-alpine-perl</span><br><span class="line"># docker </span><br><span class="line">docker images: 列出本地镜像 </span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx               1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</span><br><span class="line">busybox             latest              e1ddd7948a1c        8 weeks ago         1.16MB</span><br><span class="line"># docker image rm a47b6006585d  # 删除镜像</span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">busybox             latest              e1ddd7948a1c        8 weeks ago         1.16MB</span><br><span class="line"># docker image ls --no-trunc # 列出完整image id信息</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID                                                                  CREATED             SIZE</span><br><span class="line">nginx               1.14-alpine-perl    sha256:a47b6006585d03b999ee55c6eec4331430fb2bcddb5ce8f76f294cc997482ca2   2 weeks ago         51.6MB</span><br><span class="line">busybox             latest              sha256:e1ddd7948a1c31709a23cc5b7dfe96e55fc364f90e1cebcde0773a1b5a30dcda   8 weeks ago         1.16MB</span><br><span class="line"># docker container ls # 列出所有容器</span><br><span class="line"># docker ps: 列出所有容器</span><br><span class="line"># docker images: 列出所有镜像</span><br><span class="line"># docker create: 创建新的container</span><br><span class="line"># docker start: Start one or more stopped contaners</span><br><span class="line"># docker run: Run a command in a new container</span><br><span class="line"># docker attacth: Attach to a running container</span><br><span class="line"># docker ps: List containers</span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>apline: 能够能程序提供基础环境，但是体积非常小，所以在生产环境中不建议使用apline版;<br>busybox: 能够用一个busybox实现linux系统的多个命令，当链接busybox为ls 时，它可以执行ls命令;<br>        链接成pwd时，可以实现pwd命令。kernel+busybox可以实现一个微linux系统;<br>        所畏的android系统也是linux+busybox+jvm所运行的系统;</p>
<h2 id="容器使用"><a href="#容器使用" class="headerlink" title="容器使用"></a>容器使用</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name b2 -it busybox:latest</span><br><span class="line">&#x2F; #</span><br><span class="line"># docker run --name b1 -it busybox:latest</span><br><span class="line">&#x2F; # mkdir &#x2F;data&#x2F;www -p</span><br><span class="line">&#x2F; # vi &#x2F;data&#x2F;www&#x2F;index.html</span><br><span class="line">&lt;h1&gt;www.ssjinyao.com&lt;&#x2F;h1&gt;</span><br><span class="line">&#x2F; # httpd -f -h &#x2F;data&#x2F;www&#x2F;</span><br><span class="line"># docker inspect b1 # 查看 docker 容器的启动信息 </span><br><span class="line"># 在另一个终端中访问  curl 172.17.0.2</span><br><span class="line">&lt;h1&gt;www.ssjinyao.com&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<p>docker 再启动 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES</span><br><span class="line">57c80d23f0e5        busybox:latest      &quot;sh&quot;                6 minutes ago       Exited (130) 4 minutes ago                       b1</span><br><span class="line"># docker container start -i -a b1</span><br></pre></td></tr></table></figure>
<p>docker 容器终止</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker kill b1</span><br><span class="line"># docker stop b1</span><br></pre></td></tr></table></figure>
<p>docker 启动nginx镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name web1 -d nginx:1.14-alpine-perl </span><br><span class="line"># docker inspect web1</span><br><span class="line"># [root@ssjinyao-node1:~]# curl 172.17.0.2</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;&#x2F;title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.org&#x2F;&quot;&gt;nginx.org&lt;&#x2F;a&gt;.&lt;br&#x2F;&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href&#x3D;&quot;http:&#x2F;&#x2F;nginx.com&#x2F;&quot;&gt;nginx.com&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<p>注: 一个容器就是为了运行一个程序，如果程序跑后台运行，那么容器认为程序终止了。<br>因为，如果程序在容器运行在后台，那么程序一启动，容器就会终止。<br>直接搜索下载镜像并运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name kvstor1 -d redis:4-alpine</span><br></pre></td></tr></table></figure>
<p>绕过容器的边界，交互式接入进去 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker exec -it  kvstor1 &#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F;data # ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 redis     0:00 redis-server</span><br><span class="line">   12 root      0:00 &#x2F;bin&#x2F;sh</span><br><span class="line">   16 root      0:00 ps</span><br></pre></td></tr></table></figure>
<p>查看docker启动容器后的日志信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker logs web1</span><br></pre></td></tr></table></figure>
<p>docker event state<br><img src="/images/docker-event-state.png" class="lazyload" data-srcset="/images/docker-event-state.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Docker-镜像的使用与管理"><a href="#Docker-镜像的使用与管理" class="headerlink" title="Docker 镜像的使用与管理"></a>Docker 镜像的使用与管理</h2><p>Docker:码头工人<br>一般我们部署应用程序时，我们都是散装的。而docker可以进行集装的;</p>
<p>Docker 镜像含有启动容器所需要的文件系统及其内容，因此，其用于创建并启动docker容器  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">采用分层构建机制，最底层为bootfs,其之为rootfs  </span><br><span class="line">    bootfs: 用于系统引导的文件系统，包括bootloader和kernel，</span><br><span class="line">        容器启动完成后会被卸载以节约内在资源 </span><br><span class="line">    rootfs: 位于bootfs之上，表现为docker容器的根文件系统:</span><br><span class="line">        传统模式中，系统启动之时，内核挂载rootfs时会首先将其挂载为&quot;只读&quot;模式,</span><br><span class="line">        完整性自检后将其重新挂载为读写模式;</span><br><span class="line">        docker中,rootfs由内核挂载为&quot;只读&quot;模式，而后通过&quot;联合挂载&quot;技术额外提供一个可写层;     </span><br></pre></td></tr></table></figure>
<p>Aufs: advnaced multi-layered unification filesystem: 高级多层统一文件系统<br>CentOS 为求稳定，不整合此文件系统<br>overlayfs 从3.18版本开始被合并到Linux内核;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker info # 可以看出前端用的文件系统是overlay2，而后端用的是xfs </span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line"> Backing Filesystem: xfs</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Registry"><a href="#Docker-Registry" class="headerlink" title="Docker Registry"></a>Docker Registry</h2><p>启动容器时，docker daemon 会试图从本地获取镜像; 本地镜像不存在时 将Registry 中的镜像下载保存到本地;</p>
<p>Docker Registry 分类<br>Registry用于保存docker镜像，包括镜像的层次结构和元数据;<br>用户可自建Registry，也可以用官方的Docker Hub</p>
<p>分类<br>Sponsor Registry: 第三方的registry, 供客户和Docker社区使用<br>Mirror Registry: 第三方的registry,只让客户使用<br>Vendor Registry: 由发布Docker镜像的供应商提供的registry<br>Private Rgeistry: 通过设有防火墙和客外的安全层的私有实体提供的registry</p>
<p>Repository</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">由某特定的docker镜像的所有迭代版本组成的镜像仓库</span><br><span class="line">一个Registry中可能存在多个Repository</span><br><span class="line">    Repository 可分为&quot;顶层仓库&quot; 和 &quot;用户仓库&quot;</span><br><span class="line">    用户仓库名称格式为&quot;用户名&#x2F;仓库名&quot;</span><br><span class="line">每个仓库可以包含多个Tag(标签)，每个标签对应一个镜像</span><br></pre></td></tr></table></figure>
<p>Index</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">维护用户帐户、镜像的校验以及公共命名空间的信息; </span><br><span class="line">相当于为Registry提    相当于为Registry提供了一个完成用户认证等功能</span><br></pre></td></tr></table></figure>
<p>Docker Registry中的镜像通常由开发人员制作，而后推送至”公共”或”私有”Registry上保存;<br>供其他人员使用，例如”部署”到生产环境;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker pull registry&gt;[:&lt;prot&gt;]&#x2F;[&lt;namespace&gt;&#x2F;]&lt;name&gt;:&lt;tag&gt;</span><br></pre></td></tr></table></figure>
<p><a href="https://quay.io/repository/coreos/flannel">quay.io</a> 也可以下载多种镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker pull quay.io&#x2F;coreos&#x2F;flannel:v0.10.0-amd64 #指定站点pull镜像</span><br></pre></td></tr></table></figure>
<h2 id="镜像制作"><a href="#镜像制作" class="headerlink" title="镜像制作"></a>镜像制作</h2><p>镜像的生成途径<br>Dockerfile<br>基于容器制作<br>Docker Hub automated builds</p>
<table>
<thead>
<tr>
<th style="text-align:center">Namespace</th>
<th style="text-align:center">Example(<namespace>/<name>)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">organization</td>
<td style="text-align:center">redhat/kubernets</td>
</tr>
<tr>
<td style="text-align:center">login(user name)</td>
<td style="text-align:center">alice/application, bob/application</td>
</tr>
<tr>
<td style="text-align:center">role</td>
<td style="text-align:center">devel/database, test/database, prod/database</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker container run --name busybox1 -it busybox</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">&#x2F; #</span><br><span class="line">&#x2F; #</span><br><span class="line">&#x2F; # mkdir  -p &#x2F;data&#x2F;html</span><br><span class="line">&#x2F; # echo &quot;&lt;h1&gt;www.ssjinyao.com&lt;&#x2F;h1&gt;&quot; &gt; &#x2F;data&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>
<p>暂时不关闭容器，再打开一个终端来制作镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker commit -p busybox1</span><br><span class="line"># docker image ls</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">&lt;none&gt;                   &lt;none&gt;              d5ab408117c0        8 seconds ago       1.16MB</span><br><span class="line">redis                    4-alpine            db23f46600bc        2 weeks ago         30MB</span><br><span class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</span><br><span class="line">busybox                  latest              e1ddd7948a1c        2 months ago        1.16MB</span><br><span class="line">quay.io&#x2F;coreos&#x2F;flannel   v0.10.0-amd64       f0fad859c909        8 months ago        44.6MB</span><br><span class="line"># 再给标签打标签</span><br><span class="line"># docker tag d5ab408117c0 ssjinyao&#x2F;httpd:v0.1.1-1</span><br><span class="line"># docker image ls</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">ssjinyao&#x2F;httpd           v0.1.1-1            d5ab408117c0        About a minute ago   1.16MB</span><br><span class="line">redis                    4-alpine            db23f46600bc        2 weeks ago          30MB</span><br><span class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago          51.6MB</span><br><span class="line">busybox                  latest              e1ddd7948a1c        2 months ago         1.16MB</span><br><span class="line">quay.io&#x2F;coreos&#x2F;flannel   v0.10.0-amd64       f0fad859c909        8 months ago         44.6MB</span><br><span class="line"># docker tag ssjinyao&#x2F;httpd:v0.1.1-1 ssjinyao&#x2F;httpd:latest</span><br><span class="line"># docker image ls</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ssjinyao&#x2F;httpd           latest              d5ab408117c0        3 minutes ago       1.16MB</span><br><span class="line">ssjinyao&#x2F;httpd           v0.1.1-1            d5ab408117c0        3 minutes ago       1.16MB</span><br></pre></td></tr></table></figure>
<p>一个IMAGE ID 对应多个Tag时，删除 Tag 不会删除镜像，而像软链一下，删除链接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker image rm ssjinyao&#x2F;httpd:latest</span><br><span class="line">Untagged: ssjinyao&#x2F;httpd:latest</span><br><span class="line"># docker image ls</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ssjinyao&#x2F;httpd           v0.1.1-1            d5ab408117c0        5 minutes ago       1.16MB</span><br><span class="line">redis                    4-alpine            db23f46600bc        2 weeks ago         30MB</span><br><span class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</span><br><span class="line">busybox                  latest              e1ddd7948a1c        2 months ago        1.16MB</span><br><span class="line">quay.io&#x2F;coreos&#x2F;flannel   v0.10.0-amd64       f0fad859c909        8 months ago        44.6MB</span><br><span class="line"># docker tag ssjinyao&#x2F;httpd:v0.1.1-1 ssjinyao&#x2F;httpd:latest</span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ssjinyao&#x2F;httpd           latest              d5ab408117c0        6 minutes ago       1.16MB</span><br><span class="line">ssjinyao&#x2F;httpd           v0.1.1-1            d5ab408117c0        6 minutes ago       1.16MB</span><br><span class="line">redis                    4-alpine            db23f46600bc        2 weeks ago         30MB</span><br><span class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</span><br><span class="line">busybox                  latest              e1ddd7948a1c        2 months ago        1.16MB</span><br><span class="line">quay.io&#x2F;coreos&#x2F;flannel   v0.10.0-amd64       f0fad859c909        8 months ago        44.6MB</span><br></pre></td></tr></table></figure>
<p>制作镜像加入Command指令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker commit -a &quot;ssjinyao&quot; -c &#39;CMD [&quot;&#x2F;bin&#x2F;httpd&quot;, &quot;-f&quot;, &quot;-h&quot;,&quot;&#x2F;data&#x2F;html&quot;]&#39; -p busybox1 ssjinyao&#x2F;httpd:v0.1.1.1-2</span><br><span class="line"># docker image ls</span><br><span class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ssjinyao&#x2F;httpd           v0.1.1.1-2          0ec8103a1bb2        53 seconds ago      1.16MB</span><br><span class="line"># docker run --name busybox2 ssjinyao&#x2F;httpd:v0.1.1.1-2 # 肯据创建的镜像启动容器</span><br><span class="line"></span><br><span class="line"># docker container ls</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">27403687efa0        ssjinyao&#x2F;httpd:v0.1.1.1-2   &quot;&#x2F;bin&#x2F;httpd -f -h &#x2F;d…&quot;   30 seconds ago      Up 29 seconds                           busybox2</span><br><span class="line">6373ae374a7a        redis:4-alpine              &quot;docker-entrypoint.s…&quot;   4 days ago          Up 4 days           6379&#x2F;tcp            kvstor1</span><br><span class="line">a5ffdd373b90        nginx:1.14-alpine-perl      &quot;nginx -g &#39;daemon of…&quot;   4 days ago          Up 4 days           80&#x2F;tcp              web1</span><br><span class="line"># docker inspect # 查看容器信息</span><br><span class="line"># curl  172.17.0.4</span><br><span class="line">&lt;h1&gt;www.ssjinyao.com&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<p>在 <a href="https://hub.docker.com/">docker hub</a> 建立帐号，并创建REPOSITORY</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker login -u ssjinyao</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted in &#x2F;root&#x2F;.docker&#x2F;config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https:&#x2F;&#x2F;docs.docker.com&#x2F;engine&#x2F;reference&#x2F;commandline&#x2F;login&#x2F;#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>
<p>往 hub.docker.com 上面推镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker push ssjinyao&#x2F;httpd</span><br></pre></td></tr></table></figure>
<p>可以看到，上传的镜像</p>
<p><img src="/images/docker-push.png" class="lazyload" data-srcset="/images/docker-push.png" srcset="data:image/png;base64,666" alt=""></p>
<p><a href="https://dev.aliyun.com">国内比较常用的镜像地址</a><br>在阿里云docker 镜像站点中创建REPOSITORY<br>上传本地的镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker tag ssjinyao&#x2F;httpd:v0.1.1.1-2 registry.cn-qingdao.aliyuncs.com&#x2F;ssjinyao&#x2F;httpd</span><br><span class="line"># docker logout</span><br><span class="line">Removing login credentials for https:&#x2F;&#x2F;index.docker.io&#x2F;v1&#x2F;</span><br><span class="line"></span><br><span class="line"># docker login --username&#x3D;ssjinyao registry.cn-qingdao.aliyuncs.com</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted in &#x2F;root&#x2F;.docker&#x2F;config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https:&#x2F;&#x2F;docs.docker.com&#x2F;engine&#x2F;reference&#x2F;commandline&#x2F;login&#x2F;#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"># docker push registry.cn-qingdao.aliyuncs.com&#x2F;ssjinyao&#x2F;httpd</span><br></pre></td></tr></table></figure>
<p><img src="/images/docker-image-pull-aliyun.png" class="lazyload" data-srcset="/images/docker-image-pull-aliyun.png" srcset="data:image/png;base64,666" alt=""></p>
<p>docker 镜像的导入和导出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker save -o ssjinyao-busybox-image.gz ssjinyao&#x2F;httpd:v0.1.1.1-3 ssjinyao&#x2F;httpd:v0.1.1.1-2</span><br><span class="line"># 将镜像复制到另一台服务器</span><br><span class="line"># scp ssjinyao-busybox-image.gz root@node2:&#x2F;root&#x2F;</span><br><span class="line">ssjinyao-busybox-image.gz                                                  100% 1370KB  23.8MB&#x2F;s   00:00</span><br></pre></td></tr></table></figure>
<p>在另一台服务器上导入镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker load -i ssjinyao-busybox-image.gz</span><br><span class="line">f9d9e4e6e2f0: Loading layer  1.378MB&#x2F;1.378MB</span><br><span class="line">e6baf59e35e7: Loading layer  4.608kB&#x2F;4.608kB</span><br><span class="line"># docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ssjinyao&#x2F;httpd      v0.1.1.1-3          cfa66f44c384        About an hour ago   1.16MB</span><br><span class="line">ssjinyao&#x2F;httpd      v0.1.1.1-2          3dc1b07020fd        About an hour ago   1.16MB</span><br><span class="line"># docker run --name busybox  ssjinyao&#x2F;httpd:v0.1.1.1-2</span><br><span class="line"># 再开启一个终端</span><br><span class="line"># # docker inspect busybox | grep &quot;IPAddress&quot;</span><br><span class="line">            &quot;SecondaryIPAddresses&quot;: null,</span><br><span class="line">            &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line"># curl  172.17.0.2</span><br><span class="line">&lt;h1&gt;www.ssjinyao.com&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<h2 id="虚拟化网络管理"><a href="#虚拟化网络管理" class="headerlink" title="虚拟化网络管理"></a>虚拟化网络管理</h2><p>6种名称空间: UTS, User, Mount, IPC, Pid, Net;<br>Linux 内核支持二层和三层设备的模拟;<br>OVS: Open VSwitch; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install bridge-utils</span><br><span class="line"># brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">docker0		8000.024288c640ef	no		veth5097b16</span><br><span class="line"># ip link show #可以看到docker虚拟网卡信</span><br></pre></td></tr></table></figure>
<p>在同一台服务器上启动两个容器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker start 27403687efa0</span><br><span class="line"># docker container run --name busybox3 -it ssjinyao&#x2F;httpd:v0.1.1.1-3</span><br><span class="line"># 查看两个容器间基于nat的通信 </span><br><span class="line"># docker exec -it busybox2 &#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F; # wget -O - -q http:&#x2F;&#x2F;172.17.0.5</span><br><span class="line">&lt;h1&gt;www.ssjinyao.com&lt;&#x2F;h1&gt;</span><br></pre></td></tr></table></figure>
<p>{User,Mount,Pid}, {User,Mount,Pid} –&gt; 共享{UTS,Net,IPC}</p>
<p>让容器使用管理宿主机的网络名称空间</p>
<p><img src="/images/docker-network.png" class="lazyload" data-srcset="/images/docker-network.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker network inspect bridge</span><br></pre></td></tr></table></figure>
<p>ip 名称空间管理</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install iproute</span><br><span class="line"># ip netns help</span><br><span class="line">Usage: ip netns list</span><br><span class="line">       ip netns add NAME</span><br><span class="line">       ip netns set NAME NETNSID</span><br><span class="line">       ip [-all] netns delete [NAME]</span><br><span class="line">       ip netns identify [PID]</span><br><span class="line">       ip netns pids NAME</span><br><span class="line">       ip [-all] netns exec [NAME] cmd ...</span><br><span class="line">       ip netns monitor</span><br><span class="line">       ip netns list-id</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ip netns add r1</span><br><span class="line"># ip netns add r2</span><br><span class="line"># ip netns exec r1 ifconfig -a</span><br><span class="line"># ip link add name veth1.1 type veth peer name veth1.2</span><br><span class="line"># ip link show | grep veth1</span><br><span class="line">34: veth1.2@veth1.1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</span><br><span class="line">35: veth1.1@veth1.2: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</span><br><span class="line"># ip link set dev veth1.2 netns r1 # 将设veth1.2 称到名称空间r1 中</span><br><span class="line"># ip netns exec  r1 ifconfig -a</span><br><span class="line">lo: flags&#x3D;8&lt;LOOPBACK&gt;  mtu 65536</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">veth1.2: flags&#x3D;4098&lt;BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether da:2a:32:c9:1e:e2  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"># ip netns exec r1 ip link set dev veth1.2 name eth0 # 将名称空间中的veth1.2更名为eth0</span><br><span class="line"># ip netns exec  r1 ifconfig -a</span><br><span class="line">eth0: flags&#x3D;4098&lt;BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether da:2a:32:c9:1e:e2  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags&#x3D;8&lt;LOOPBACK&gt;  mtu 65536</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"># ifconfig veth1.1 10.1.0.1&#x2F;24 up # 激活网卡veth1.1</span><br><span class="line"># ip netns exec r1 ifconfig eth0 10.1.0.2&#x2F;24 up # 激活r1名称空间中的 eth0</span><br><span class="line"># ip netns exec r1 ifconfig</span><br><span class="line">eth0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.1.0.2  netmask 255.255.255.0  broadcast 10.1.0.255</span><br><span class="line">        inet6 fe80::d82a:32ff:fec9:1ee2  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether da:2a:32:c9:1e:e2  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 8  bytes 648 (648.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 8  bytes 648 (648.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line"># ping 10.1.0.2</span><br><span class="line">PING 10.1.0.2 (10.1.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.1.0.2: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.945 ms</span><br><span class="line">64 bytes from 10.1.0.2: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.061 ms</span><br><span class="line"># ip link set dev veth1.1 netns r2 # 将 veth1.1 移到名称空间r2中</span><br><span class="line"># ip netns exec r2 ifconfig veth1.1 10.1.0.3&#x2F;24 up # 启用r2名称空间中的veth1.1</span><br><span class="line"># ip netns exec r2 ping 10.1.0.2 # 在名称空间r2中ping 名称空间r1的eth0绑定的ip地址</span><br><span class="line">PING 10.1.0.2 (10.1.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.1.0.2: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.214 ms</span><br><span class="line">64 bytes from 10.1.0.2: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.080 ms</span><br><span class="line"></span><br><span class="line">--rm  容器停止后，将容器删除</span><br><span class="line"># docker run --name t1 -it --network bridge -h www.ssjinyao.com --rm busybox:latest</span><br><span class="line">&#x2F; # hostname</span><br><span class="line">www.ssjinyao.com</span><br><span class="line">&#x2F; # ping www.ssjinyao.com</span><br><span class="line">PING www.ssjinyao.com (172.17.0.6): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.6: seq&#x3D;0 ttl&#x3D;64 time&#x3D;0.094 ms</span><br><span class="line">--- www.ssjinyao.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min&#x2F;avg&#x2F;max &#x3D; 0.094&#x2F;0.094&#x2F;0.094 ms</span><br><span class="line">&#x2F; # cat &#x2F;etc&#x2F;hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.6	www.ssjinyao.com www</span><br><span class="line">&#x2F; # cat &#x2F;etc&#x2F;resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">search localdomain</span><br><span class="line">nameserver 10.180.66.2</span><br></pre></td></tr></table></figure>
<p>只要配置了正确的域名服务器，可以正解的解析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F; # nslookup -type&#x3D;A nas.ssjinyao.com</span><br><span class="line">Server:		10.180.66.2</span><br><span class="line">Address:	10.180.66.2:53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:	nas.ssjinyao.com</span><br><span class="line">Address: 47.104.201.165</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name t1 -it --network bridge -h www.ssjinyao.com --dns 114.114.114.114 --dns 8.8.8.8 --rm busybox:latest</span><br><span class="line">&#x2F; # cat &#x2F;etc&#x2F;resolv.conf</span><br><span class="line">search localdomain</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">&#x2F; # hostname</span><br><span class="line">www.ssjinyao.com</span><br><span class="line"># docker run --name t1 -it --network bridge -h t1.ssjinyao.com --dns 114.114.114.114 --dns-search ssjinyao.com --add-host www.ssjinyao.com:1.1.1.1 --rm busybox:latest</span><br><span class="line">&#x2F; # cat &#x2F;etc&#x2F;hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">1.1.1.1	www.ssjinyao.com</span><br><span class="line">172.17.0.6	t1.ssjinyao.com t1</span><br></pre></td></tr></table></figure>
<p>将容器的端口进行暴露 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name myweb --rm -p 80 ssjinyao&#x2F;httpd:v0.1.1.1-2</span><br><span class="line"># docker container ps</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                   NAMES</span><br><span class="line">97212485437e        ssjinyao&#x2F;httpd:v0.1.1.1-3   &quot;&#x2F;bin&#x2F;httpd -f -h &#x2F;d…&quot;   4 minutes ago       Up 4 minutes        0.0.0.0:32773-&gt;80&#x2F;tcp   myweb</span><br></pre></td></tr></table></figure>
<p><img src="/images/docker-32773.png" class="lazyload" data-srcset="/images/docker-32773.png" srcset="data:image/png;base64,666" alt=""></p>
<p>Opening inbound communication</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-p 选项的使用格式</span><br><span class="line">    -p &lt;containerPort&gt;</span><br><span class="line">    将指定的容器端口映射至主机所有地址的一个动态端口;</span><br><span class="line">    -p &lt;hostPort&gt;:&lt;containerPort&gt;</span><br><span class="line">    将容器端口&lt;containerPort&gt;映射至指定的主机端口&lt;hostPort&gt;</span><br><span class="line">    -p &lt;ip&gt;::&lt;containerPort&gt;</span><br><span class="line">    将指定的容器端口&lt;containerPort&gt;映射至主机指定&lt;ip&gt;的端口&lt;hostPort&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name myweb --rm -p 10.180.66.11:8080:80 ssjinyao&#x2F;httpd:v0.1.1.1-3</span><br><span class="line"># docker port myweb</span><br><span class="line">80&#x2F;tcp -&gt; 10.180.66.11:8080</span><br></pre></td></tr></table></figure>
<p><img src="/images/docker-port-8080.png" class="lazyload" data-srcset="/images/docker-port-8080.png" srcset="data:image/png;base64,666" alt=""></p>
<p>Joined container(联盟式容器)</p>
<p>共享b1容器的网络</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name b1 -it --rm busybox</span><br><span class="line"># docker run --name b2 --network container:b1 -it --rm busybox</span><br><span class="line">&#x2F; # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02</span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:648 (648.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">&#x2F; # echo &quot;Joined container&quot; &gt; &#x2F;tmp&#x2F;index.html</span><br><span class="line">&#x2F; # httpd -h &#x2F;tmp&#x2F;</span><br><span class="line">&#x2F; # netstat  -tnl</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State</span><br><span class="line">tcp        0      0 :::80                   :::*                    LISTEN</span><br><span class="line">&#x2F; # wget -O - -q 127.0.0.1</span><br><span class="line">Joined container</span><br></pre></td></tr></table></figure>
<p>共享宿主机网络</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run --name b2 --network host -it --rm busybox</span><br><span class="line">&#x2F; #</span><br><span class="line">&#x2F; # ifconfig</span><br><span class="line">docker0   Link encap:Ethernet  HWaddr 02:42:88:C6:40:EF</span><br><span class="line">          inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::42:88ff:fec6:40ef&#x2F;64 Scope:Link</span><br><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:347 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:371 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:35796 (34.9 KiB)  TX bytes:40247 (39.3 KiB)</span><br><span class="line"></span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0C:29:F8:70:D5</span><br><span class="line">          inet addr:10.180.66.11  Bcast:10.180.66.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fef8:70d5&#x2F;64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:123421 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:39524 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:81346864 (77.5 MiB)  TX bytes:8253033 (7.8 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1&#x2F;128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:80 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:80 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:6944 (6.7 KiB)  TX bytes:6944 (6.7 KiB)</span><br></pre></td></tr></table></figure>
<p>更改docker0 桥的ip地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;],</span><br><span class="line">    &quot;bip&quot;: &quot;10.0.0.1&#x2F;16&quot;,</span><br><span class="line">    &quot;hosts&quot;: [&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;,&quot;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># ifconfig</span><br><span class="line">docker0: flags&#x3D;4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.0.0.1  netmask 255.255.0.0  broadcast 10.0.255.255</span><br><span class="line">        inet6 fe80::42:88ff:fec6:40ef  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:42:88:c6:40:ef  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 347  bytes 35796 (34.9 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 371  bytes 40247 (39.3 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"># docker -H 10.180.66.11:2375 image ls</span><br></pre></td></tr></table></figure>
<p>创建网桥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker network create -d bridge --subnet &quot;172.26.0.0&#x2F;16&quot; --gateway &quot;172.26.0.1&quot; mbr0</span><br><span class="line"># ifconfig</span><br><span class="line">br-76b59a5dfce3: flags&#x3D;4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.26.0.1  netmask 255.255.0.0  broadcast 172.26.255.255</span><br><span class="line">        ether 02:42:ea:15:d6:9e  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"># ip link set dev br-76b59a5dfce3 name docker1</span><br><span class="line">RTNETLINK answers: Device or resource busy</span><br><span class="line"># ifconfig br-76b59a5dfce3 down</span><br><span class="line"># ifconfig docker1 up </span><br><span class="line"># ifconfig docker1 down  # 更改名称后默认docker 调用时会找不到docker1这个虚拟网卡</span><br><span class="line"># ip link set dev docker1 name br-76b59a5dfce3</span><br><span class="line"># docker run --name t1 -it --net mbr0 busybox:latest</span><br><span class="line">&#x2F; # ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:1A:00:02</span><br><span class="line">          inet addr:172.26.0.2  Bcast:172.26.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:3 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:258 (258.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p>自定义docker0桥的网络属性信息: /etc/docker/daemon.json文件 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;bip&quot;: &quot;192.168.1.5&#x2F;24&quot;,</span><br><span class="line">    &quot;fixed-cidr&quot;: &quot;10.20.0.0&#x2F;16&quot;,</span><br><span class="line">    &quot;fixed-cidr-v6&quot;: &quot;2001:db8::&#x2F;64&quot;,</span><br><span class="line">    &quot;mtu&quot;: 1500,</span><br><span class="line">    &quot;default-gateway&quot;: &quot;10.20.1.1&quot;,</span><br><span class="line">    &quot;default-gateway-v6&quot;: &quot;2001:db8:abcd::89&quot;,</span><br><span class="line">    &quot;dns&quot;: [&quot;10.20.1.2&quot;, &quot;10.20.1.3&quot;]</span><br></pre></td></tr></table></figure>
<p>docker守护进程的C/S，其默认监听Unix SOcket格式的地址，/var/run/docker.sock;如果使用TCP套接字， /etc/docker/daemon.json:<br>“hosts”: [“tcp://0.0.0.0:2375”, “unix:///var/run/docker.sock”]</p>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>python日常练习</title>
    <url>/2018/08/23/python%E6%97%A5%E5%B8%B8%E7%BB%83%E4%B9%A0%E4%BA%8C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-日常练习"><a href="#python-日常练习" class="headerlink" title="python 日常练习"></a>python 日常练习</h1><p><img src="/images/python.jpg" class="lazyload" data-srcset="/images/python.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="和并两个有序列表，并且保持合并后的两个列表有序"><a href="#和并两个有序列表，并且保持合并后的两个列表有序" class="headerlink" title="和并两个有序列表，并且保持合并后的两个列表有序"></a>和并两个有序列表，并且保持合并后的两个列表有序</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">In [11]: l1 = [1,2,3,4]</span><br><span class="line">In [12]: l2 = [2,3,7,9]</span><br><span class="line">In [13]: l3 = []</span><br><span class="line">In [14]: <span class="keyword">for</span> x <span class="keyword">in</span> l1:</span><br><span class="line">    ...:     <span class="keyword">while</span> len(l2) &gt; 0 :</span><br><span class="line">    ...:         <span class="keyword">if</span> x &gt; l2[0]:</span><br><span class="line">    ...:             l3.append(l2.pop(0))</span><br><span class="line">    ...:         <span class="keyword">else</span>:</span><br><span class="line">    ...:             l3.append(x)</span><br><span class="line">    ...:             <span class="built_in">break</span></span><br><span class="line">    ...:     <span class="keyword">if</span> len(l2)  &lt;= 0:</span><br><span class="line">    ...:         l3.append(x)</span><br><span class="line">    ...: l3.append(l2)</span><br><span class="line">    ...:</span><br><span class="line">    ...:</span><br><span class="line">In [15]:</span><br><span class="line">In [15]: l3</span><br><span class="line">Out[15]: [1, 2, 2, 3, 3, 4, [7, 9]]</span><br></pre></td></tr></table></figure>
<h2 id="按单词反转字符串，-如’I-love-Linux’-反转为-‘Linux-love-I’"><a href="#按单词反转字符串，-如’I-love-Linux’-反转为-‘Linux-love-I’" class="headerlink" title="按单词反转字符串， 如’I love Linux’ 反转为 ‘Linux love I’"></a>按单词反转字符串， 如’I love Linux’ 反转为 ‘Linux love I’</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">30</span>]: <span class="string">&#x27; &#x27;</span>.join(s.split()[::<span class="number">-1</span>])</span><br><span class="line">Out[<span class="number">30</span>]: <span class="string">&#x27;Linux love I&#x27;</span></span><br><span class="line">In [<span class="number">31</span>]: s = <span class="string">&quot;I love Linux&quot;</span></span><br><span class="line">In [<span class="number">32</span>]: <span class="string">&#x27; &#x27;</span>.join(s.split()[::<span class="number">-1</span>])</span><br><span class="line">Out[<span class="number">32</span>]: <span class="string">&#x27;Linux love I&#x27;</span></span><br><span class="line">In [<span class="number">33</span>]: s.split()[::<span class="number">-1</span>]</span><br><span class="line">Out[<span class="number">33</span>]: [<span class="string">&#x27;Linux&#x27;</span>, <span class="string">&#x27;love&#x27;</span>, <span class="string">&#x27;I&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h2 id="找出一个列表中只出现了一次的数字，并且保持原来的次序，例如-1-2-1-3-2-5-，结果为-3-5"><a href="#找出一个列表中只出现了一次的数字，并且保持原来的次序，例如-1-2-1-3-2-5-，结果为-3-5" class="headerlink" title="找出一个列表中只出现了一次的数字，并且保持原来的次序，例如[1,2,1,3,2,5]，结果为[3,5]"></a>找出一个列表中只出现了一次的数字，并且保持原来的次序，例如[1,2,1,3,2,5]，结果为[3,5]</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Number（数字）</span><br><span class="line">String（字符串）</span><br><span class="line">List（列表）</span><br><span class="line">Tuple（元组）</span><br><span class="line">Set（集合）</span><br><span class="line">Dictionary（字典）</span><br></pre></td></tr></table></figure>
<p>有bug的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 例如，当1 出现三次时，会把1也记录下来</span></span><br><span class="line">In [<span class="number">59</span>]: lst_set</span><br><span class="line">Out[<span class="number">59</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">60</span>]: lst =  [<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>]</span><br><span class="line">In [<span class="number">61</span>]: ret = []</span><br><span class="line">In [<span class="number">62</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst:</span><br><span class="line">    ...:     <span class="keyword">if</span> x <span class="keyword">in</span> ret:</span><br><span class="line">    ...:         ret.remove(x)</span><br><span class="line">    ...:     <span class="keyword">else</span>:</span><br><span class="line">    ...:         ret.append(x)</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">63</span>]: ret</span><br><span class="line">Out[<span class="number">63</span>]: [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 去除bug后</span></span><br><span class="line">In [<span class="number">51</span>]: lst =  [<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>]</span><br><span class="line">In [<span class="number">52</span>]: ret = []</span><br><span class="line">In [<span class="number">53</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst:</span><br><span class="line">    ...:     <span class="keyword">if</span> lst.count(x) == <span class="number">1</span>:</span><br><span class="line">    ...:         ret.append(x)</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">54</span>]: ret</span><br><span class="line">Out[<span class="number">54</span>]: [<span class="number">3</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当重复的数过大的时，不便重复的元素每个都遍历，如10w个1重复</span></span><br><span class="line">In [<span class="number">77</span>]: lst =  [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>]</span><br><span class="line">In [<span class="number">78</span>]: lst_set = <span class="built_in">list</span>(<span class="built_in">set</span>(lst))</span><br><span class="line">In [<span class="number">79</span>]: lst_set</span><br><span class="line">Out[<span class="number">79</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line">In [<span class="number">80</span>]: ret = []</span><br><span class="line">In [<span class="number">81</span>]: ret</span><br><span class="line">Out[<span class="number">81</span>]: []</span><br><span class="line">In [<span class="number">84</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst_set:</span><br><span class="line">    ...:     <span class="keyword">if</span> lst.count(x) == <span class="number">1</span>:</span><br><span class="line">    ...:         ret.append(x)</span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">85</span>]: ret</span><br><span class="line">Out[<span class="number">85</span>]: [<span class="number">3</span>, <span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<h2 id="取出一个列表中的最大值"><a href="#取出一个列表中的最大值" class="headerlink" title="取出一个列表中的最大值"></a>取出一个列表中的最大值</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [86]: lst &#x3D; [1,3,5,8,10,101,301]</span><br><span class="line">In [87]: max(lst)</span><br><span class="line">Out[87]: 301</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [93]: lst &#x3D; [1,3,5,8,10,101,301]</span><br><span class="line">In [94]: m &#x3D; lst[0]</span><br><span class="line">In [96]: for x in lst:</span><br><span class="line">    ...:     if x &gt; m:</span><br><span class="line">    ...:         m &#x3D; x</span><br><span class="line">    ...:</span><br><span class="line">In [97]: m</span><br><span class="line">Out[97]: 301</span><br></pre></td></tr></table></figure>
<h2 id="写一个程序，把字符串转化为数字，不允许使用函数和模块"><a href="#写一个程序，把字符串转化为数字，不允许使用函数和模块" class="headerlink" title="写一个程序，把字符串转化为数字，不允许使用函数和模块"></a>写一个程序，把字符串转化为数字，不允许使用函数和模块</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">138</span>]: s = <span class="string">&#x27;123.456&#x27;</span></span><br><span class="line">In [<span class="number">139</span>]: integer, decimals=s.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">In [<span class="number">140</span>]: <span class="built_in">list</span>(<span class="built_in">enumerate</span>(integer))</span><br><span class="line">Out[<span class="number">140</span>]: [(<span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>), (<span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;3&#x27;</span>)]</span><br><span class="line">In [<span class="number">141</span>]: integer_length = <span class="built_in">len</span>(integer)</span><br><span class="line">In [<span class="number">142</span>]: result = <span class="number">0</span></span><br><span class="line">     ...: <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(integer):</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">0</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">1</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">2</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">3</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">4</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">5</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">6</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">7</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;8&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">8</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">9</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</span><br><span class="line">     ...:</span><br><span class="line">In [<span class="number">143</span>]: <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(decimals):</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">0</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">1</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">2</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">3</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">4</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">5</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">6</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">7</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;8&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">8</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:     <span class="keyword">if</span> x == <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">     ...:         result += <span class="number">9</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</span><br><span class="line">     ...:</span><br><span class="line">In [<span class="number">144</span>]: result</span><br><span class="line">Out[<span class="number">144</span>]: <span class="number">123.456</span></span><br><span class="line">In [<span class="number">145</span>]: <span class="built_in">type</span>(result)</span><br><span class="line">Out[<span class="number">145</span>]: <span class="built_in">float</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python输出格式</title>
    <url>/2018/08/20/python%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F/</url>
    <content><![CDATA[<p><img src="/images/python.jpg" class="lazyload" data-srcset="/images/python.jpg" srcset="data:image/png;base64,666" alt=""></p>
<p>[toc]</p>
<h2 id="列表的封装与解压"><a href="#列表的封装与解压" class="headerlink" title="列表的封装与解压"></a>列表的封装与解压</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: lst = [<span class="number">1</span>,[<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>],<span class="number">4</span>]</span><br><span class="line">In [<span class="number">11</span>]: a, (b, *_, c),d = lst</span><br><span class="line">In [<span class="number">12</span>]: a</span><br><span class="line">Out[<span class="number">12</span>]: <span class="number">1</span></span><br><span class="line">In [<span class="number">13</span>]: b</span><br><span class="line">Out[<span class="number">13</span>]: <span class="number">2</span></span><br><span class="line">In [<span class="number">14</span>]: c</span><br><span class="line">Out[<span class="number">14</span>]: <span class="number">10</span></span><br><span class="line">In [<span class="number">15</span>]: d</span><br><span class="line">Out[<span class="number">15</span>]: <span class="number">4</span></span><br></pre></td></tr></table></figure>
<h2 id="输出格式练习"><a href="#输出格式练习" class="headerlink" title="输出格式练习"></a>输出格式练习</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">18</span>]: <span class="string">&#x27;i am %s&#x27;</span> %(<span class="string">&#x27;renjin&#x27;</span>)</span><br><span class="line">Out[<span class="number">18</span>]: <span class="string">&#x27;i am renjin&#x27;</span></span><br><span class="line">In [<span class="number">24</span>]: <span class="string">&#x27;i am %(name)s&#x27;</span> %&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;renjin&#x27;</span>&#125;</span><br><span class="line">Out[<span class="number">24</span>]: <span class="string">&#x27;i am renjin&#x27;</span></span><br><span class="line">In [<span class="number">29</span>]: <span class="string">&#x27;i am %s my name is %s&#x27;</span> %(<span class="string">&#x27;ssjinyao&#x27;</span>,<span class="string">&#x27;renjin&#x27;</span>)</span><br><span class="line">Out[<span class="number">29</span>]: <span class="string">&#x27;i am ssjinyao my name is renjin&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="format-输出格式"><a href="#format-输出格式" class="headerlink" title="format 输出格式"></a>format 输出格式</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">3</span>]: <span class="string">&#x27;I am &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;ssjinyao&#x27;</span>)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="string">&#x27;I am ssjinyao&#x27;</span></span><br><span class="line">In [<span class="number">4</span>]: <span class="string">&#x27;I am &#123;&#125; my age is &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;ssjinyao&#x27;</span>,<span class="number">23</span>)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="string">&#x27;I am ssjinyao my age is 23&#x27;</span></span><br><span class="line">In [<span class="number">5</span>]: <span class="string">&#x27;I am &#123;1&#125; my age is &#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">23</span>,<span class="string">&#x27;ssjinyao&#x27;</span>)</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">&#x27;I am ssjinyao my age is 23&#x27;</span></span><br><span class="line">In [<span class="number">6</span>]: <span class="string">&#x27;I am &#123;name&#125; my age is &#123;age&#125;&#x27;</span>.<span class="built_in">format</span>(age=<span class="string">&#x27;23&#x27;</span>,name=<span class="string">&#x27;ssjinyao&#x27;</span>)</span><br><span class="line">Out[<span class="number">6</span>]: <span class="string">&#x27;I am ssjinyao my age is 23&#x27;</span></span><br><span class="line">In [<span class="number">8</span>]: <span class="string">&#x27;I am &#123;0&#125; my name is &#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;ssjinyao&#x27;</span>)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="string">&#x27;I am ssjinyao my name is ssjinyao&#x27;</span></span><br><span class="line">In [<span class="number">15</span>]: <span class="string">&#x27;&#123;&#125; name &#123;&#125; and age is &#123;age&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;renjin&#x27;</span>,<span class="string">&#x27;ssjinyao&#x27;</span>,age=<span class="string">&#x27;23&#x27;</span>)</span><br><span class="line">Out[<span class="number">15</span>]: <span class="string">&#x27;renjin name ssjinyao and age is 23&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">16</span>]: <span class="class"><span class="keyword">class</span> <span class="title">A</span>():</span></span><br><span class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    ...:         self.x=<span class="number">1</span></span><br><span class="line">    ...:         self.y=<span class="number">2</span></span><br><span class="line">    ...:</span><br><span class="line">In [<span class="number">17</span>]: a = A()</span><br><span class="line">In [<span class="number">18</span>]: a.x</span><br><span class="line">Out[<span class="number">18</span>]: <span class="number">1</span></span><br><span class="line">In [<span class="number">19</span>]: a.y</span><br><span class="line">Out[<span class="number">19</span>]: <span class="number">2</span></span><br><span class="line">In [<span class="number">24</span>]: <span class="string">&#x27;&#123;inst.x&#125;&#x27;</span>.<span class="built_in">format</span>(inst=a)</span><br><span class="line">Out[<span class="number">24</span>]: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">In [<span class="number">20</span>]: <span class="string">&#x27;&#123;0.x&#125; &#123;0.y&#125;&#x27;</span>.<span class="built_in">format</span>(a)</span><br><span class="line">Out[<span class="number">20</span>]: <span class="string">&#x27;1 2&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">26</span>]: <span class="string">&#x27;&#123;0!a&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;逝水锦遥&#x27;</span>)</span><br><span class="line">Out[<span class="number">26</span>]: <span class="string">&quot;&#x27;\\u901d\\u6c34\\u9526\\u9065&#x27;&quot;</span></span><br><span class="line">In [<span class="number">27</span>]: <span class="string">&#x27;&#123;0:^80&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;逝水锦遥&#x27;</span>)</span><br><span class="line">Out[<span class="number">27</span>]: <span class="string">&#x27;                                      逝水锦遥                                      &#x27;</span></span><br><span class="line">In [<span class="number">29</span>]: <span class="string">&#x27;&#123;0:&lt;80&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;逝水锦遥&#x27;</span>)</span><br><span class="line">Out[<span class="number">29</span>]: <span class="string">&#x27;逝水锦遥                                                                            &#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">30</span>]: <span class="string">&#x27;&#123;0:&gt;80&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;逝水锦遥&#x27;</span>)</span><br><span class="line">Out[<span class="number">30</span>]: <span class="string">&#x27;                                                                            逝水锦遥&#x27;</span></span><br><span class="line">In [<span class="number">34</span>]: <span class="string">&#x27;&#123;0:&#123;fill&#125;^&#123;width&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;逝水锦遥&#x27;</span>,width=<span class="string">&#x27;80&#x27;</span>,fill=<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">Out[<span class="number">34</span>]: <span class="string">&#x27;**************************************逝水锦遥**************************************&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">35</span>]: <span class="string">&#x27;&#123;message:&#123;fill&#125;^&#123;width&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(message=<span class="string">&#x27;逝水锦遥&#x27;</span>,width=<span class="string">&#x27;80&#x27;</span>,fill=<span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">Out[<span class="number">35</span>]: <span class="string">&#x27;**************************************逝水锦遥**************************************&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">41</span>]: s = <span class="string">&#x27;逝水锦遥&#x27;</span></span><br><span class="line">In [<span class="number">42</span>]: b = s.encode()</span><br><span class="line">In [<span class="number">43</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> s:</span><br><span class="line">    ...:     <span class="built_in">print</span> (x)</span><br><span class="line">    ...:</span><br><span class="line">逝</span><br><span class="line">水</span><br><span class="line">锦</span><br><span class="line">遥</span><br><span class="line"></span><br><span class="line">In [<span class="number">44</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> b:</span><br><span class="line">    ...:     <span class="built_in">print</span> (x)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">128</span></span><br><span class="line"><span class="number">157</span></span><br><span class="line"><span class="number">230</span></span><br><span class="line"><span class="number">176</span></span><br><span class="line"><span class="number">180</span></span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">148</span></span><br><span class="line"><span class="number">166</span></span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">129</span></span><br><span class="line"><span class="number">165</span></span><br><span class="line">In [<span class="number">44</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> b:</span><br><span class="line">    ...:     <span class="built_in">print</span> (x)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">128</span></span><br><span class="line"><span class="number">157</span></span><br><span class="line"><span class="number">230</span></span><br><span class="line"><span class="number">176</span></span><br><span class="line"><span class="number">180</span></span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">148</span></span><br><span class="line"><span class="number">166</span></span><br><span class="line"><span class="number">233</span></span><br><span class="line"><span class="number">129</span></span><br><span class="line"><span class="number">165</span></span><br><span class="line">In [<span class="number">45</span>]: b.decode()</span><br><span class="line">Out[<span class="number">45</span>]: <span class="string">&#x27;逝水锦遥&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="python3-格式转换"><a href="#python3-格式转换" class="headerlink" title="python3 格式转换"></a>python3 格式转换</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># cat &lt;&lt;EOF &gt;&gt; utf-8.txt</span></span><br><span class="line">逝水锦遥</span><br><span class="line">EOF</span><br><span class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># iconv -f UTF-8 -f UTF-8 -t GBK utf-8.txt</span></span><br><span class="line">��ˮ��ң</span><br><span class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># iconv -f UTF-8 -f UTF-8 -t GBK utf-8.txt &gt; gbk.txt</span></span><br><span class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># cat gbk.txt</span></span><br><span class="line">��ˮ��ң</span><br><span class="line">In [<span class="number">6</span>]: f = <span class="built_in">open</span>(<span class="string">&#x27;/root/mypython/python3/gbk.txt&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">In [<span class="number">7</span>]: buf = f.read()</span><br><span class="line">In [<span class="number">8</span>]: buf.decode(<span class="string">&#x27;GBK&#x27;</span>)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="string">&#x27;逝水锦遥\n&#x27;</span></span><br><span class="line">In [<span class="number">9</span>]: name = buf.decode(<span class="string">&#x27;GBK&#x27;</span>)</span><br><span class="line">In [<span class="number">10</span>]: <span class="built_in">print</span> (name)</span><br><span class="line">逝水锦遥</span><br></pre></td></tr></table></figure>
<h2 id="基于socket-之间的编码格式转换"><a href="#基于socket-之间的编码格式转换" class="headerlink" title="基于socket 之间的编码格式转换"></a>基于socket 之间的编码格式转换</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">In [<span class="number">14</span>]: <span class="keyword">import</span> socket</span><br><span class="line">In [<span class="number">15</span>]: s = socket.socket(family=socket.AF_INET, <span class="built_in">type</span>=socket.SOCK_STREAM)</span><br><span class="line">In [<span class="number">16</span>]: s.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>,<span class="number">3000</span>))</span><br><span class="line">In [<span class="number">17</span>]: s.listen()</span><br><span class="line">In [<span class="number">18</span>]: fd, addr = s.accept()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> socket</span><br><span class="line">In [<span class="number">2</span>]: s = socket.socket(family=socket.AF_INET, <span class="built_in">type</span>=socket.SOCK_STREAM)</span><br><span class="line">In [<span class="number">4</span>]: so = s.connect((<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">3000</span>))</span><br><span class="line">In [<span class="number">5</span>]: s.send(<span class="string">&#x27;逝水锦遥&#x27;</span>.encode())</span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">12</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">In [<span class="number">33</span>]: fd.recv(<span class="number">1024</span>)</span><br><span class="line">Out[<span class="number">33</span>]: <span class="string">b&#x27;\xe9\x80\x9d\xe6\xb0\xb4\xe9\x94\xa6\xe9\x81\xa5&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line">In [<span class="number">22</span>]: s.send(<span class="string">&#x27;逝水锦遥&#x27;</span>.encode())</span><br><span class="line">Out[<span class="number">22</span>]: <span class="number">12</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">In [<span class="number">40</span>]: buf = fd.recv(<span class="number">1024</span>)</span><br><span class="line">In [<span class="number">41</span>]: buf.decode()</span><br><span class="line">Out[<span class="number">41</span>]: <span class="string">&#x27;逝水锦遥&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line">In [<span class="number">23</span>]: s.send(<span class="string">&#x27;乐乐在线&#x27;</span>.encode())</span><br><span class="line">Out[<span class="number">23</span>]: <span class="number">12</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">In [<span class="number">42</span>]: buf = fd.recv(<span class="number">1024</span>)</span><br><span class="line">In [<span class="number">43</span>]: buf.decode()</span><br><span class="line">Out[<span class="number">43</span>]: <span class="string">&#x27;乐乐在线&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 客户端</span></span><br><span class="line">In [<span class="number">24</span>]: s.send(<span class="string">&#x27;逝水锦遥，乐乐在线&#x27;</span>.encode())</span><br><span class="line">Out[<span class="number">24</span>]: <span class="number">27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">In [<span class="number">45</span>]: buf = fd.recv(<span class="number">1024</span>)</span><br><span class="line">In [<span class="number">46</span>]: buf.decode()</span><br><span class="line">Out[<span class="number">46</span>]: <span class="string">&#x27;逝水锦遥，乐乐在线&#x27;</span></span><br></pre></td></tr></table></figure>
<p>基于 socket 之间的json格式传输</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 客户端生成json格式的数据并发送</span></span><br><span class="line">In [<span class="number">26</span>]: <span class="keyword">import</span> json</span><br><span class="line">In [<span class="number">27</span>]: data = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;ssjinyao&#x27;</span>,&#125;</span><br><span class="line">In [<span class="number">28</span>]: data = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;ssjinyao&#x27;</span>,<span class="string">&#x27;owner&#x27;</span>:<span class="string">&#x27;renjin&#x27;</span>&#125;</span><br><span class="line">In [<span class="number">30</span>]: json.dumps(data)</span><br><span class="line">Out[<span class="number">30</span>]: <span class="string">&#x27;&#123;&quot;name&quot;: &quot;ssjinyao&quot;, &quot;owner&quot;: &quot;renjin&quot;&#125;&#x27;</span></span><br><span class="line">In [<span class="number">31</span>]: js = json.dumps(data)</span><br><span class="line">In [<span class="number">32</span>]: s.send(js.encode())</span><br><span class="line">Out[<span class="number">32</span>]: <span class="number">39</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 服务端接收发送过来的json数据</span></span><br><span class="line">In [<span class="number">47</span>]: buf = fd.recv(<span class="number">1024</span>)</span><br><span class="line">In [<span class="number">48</span>]: buf.decode()</span><br><span class="line">Out[<span class="number">48</span>]: <span class="string">&#x27;&#123;&quot;name&quot;: &quot;ssjinyao&quot;, &quot;owner&quot;: &quot;renjin&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 一般发送端会指定编码</span></span><br><span class="line">In [<span class="number">34</span>]: s.send(js.encode(<span class="string">&#x27;UTF-8&#x27;</span>))</span><br><span class="line">Out[<span class="number">34</span>]: <span class="number">39</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 接收端也会指定编码，这样不会出现乱码、</span></span><br><span class="line">In [<span class="number">50</span>]: buf.decode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">Out[<span class="number">50</span>]: <span class="string">&#x27;&#123;&quot;name&quot;: &quot;ssjinyao&quot;, &quot;owner&quot;: &quot;renjin&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop学习笔记</title>
    <url>/2018/07/29/hadoop/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="hadoop学习笔记"><a href="#hadoop学习笔记" class="headerlink" title="hadoop学习笔记"></a>hadoop学习笔记</h2><p><img src="/images/hadoop.png" class="lazyload" data-srcset="/images/hadoop.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Bigdata"><a href="#Bigdata" class="headerlink" title="Bigdata"></a>Bigdata</h2><hr>
<pre><code>结构化数据: 约束
半结构化数据:
非结构化数据: 没有元数据；
搜索引擎：搜索组件、索引组件共同组成
        蜘蛛程序:
        存储：
        分析处理：
2003年: The Google File System
2004年:  MapReduce:  Simplified Data Processing On large Cluster
2006年: BigTable: A Distributed Strorage System for Structure Data
HDFS + MapReduce  = Hadoop
HBase
Nutch
MapRduce 是批处理程序:
DN: Data Node   NN: Name Node SNN: Secondary Name Node
函数式编程:
    Lisp, ML函数式编程语言；高阶函数；
        map, fold
        map: 一个任务映射为多个map(f())
        map: 接受一个函数为参数，并将其应用于列表中的所有元素，从而生成一个结果列表;
        fold: 接受两个能数：函数，初始值fold(g(), init)
    mapreduce:  mapper, reducer
    mapper:统计、排序 k-v(键值数据)
统计一本书每个单词出现的次数:
    mapper:每100页一个单位， 5 mappers
        用于拆分成为单词:10000000
    reducer:
        reducer1, reducer2
    mapper: this 1, is 1 ,this1 ,how1
    同一个键的数据只能发往同一个reducer
    reducer: this 500 is
    MRv1(Hadoop2) --&gt; MRv2(Hadoop2)
        MRv1: Cluster resource manager,Data processing
        MRv2: 
            YARN: Cluster resource manager
            MRv2: Data processing
                MR: batch
                Tez: execution engine 
                RM: Resource Manager
                NM: Node Manager
                AM: Application Master
                container: mr任务
                Ambari 
            Hadoop Distribution:
            Cloudera: CDH
            Hortonworks: HDP
            Intel: IDH
            MapR:
</code></pre><hr>
<h2 id="安装使用Hadoop"><a href="#安装使用Hadoop" class="headerlink" title="安装使用Hadoop"></a>安装使用Hadoop</h2><p>单机模型: 测试使用;<br>伪分布式模型: 运行于单机;<br>分布式模型: 集群模型;<br>Hadoop，基于Java语言;<br>需要配置jvm和jvm home环境;<br>    jdk: 1.6, 1.7, 1.8<br>        hadoop-2.6.2  jdk 1.6+</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install java-1.7.0-openjdk.x86_64</span><br><span class="line"># vim &#x2F;etc&#x2F;profile.d&#x2F;java.sh</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;usr</span><br><span class="line"># chmod +x &#x2F;etc&#x2F;profile.d&#x2F;java.sh</span><br><span class="line"># source &#x2F;etc&#x2F;profile.d&#x2F;java.sh</span><br><span class="line"># yum -y install java-1.7.0-openjdk-devel</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;local&#x2F;src &amp;&amp; # wget https:&#x2F;&#x2F;archive.apache.org&#x2F;dist&#x2F;hadoop&#x2F;core&#x2F;hadoop-2.6.1&#x2F;hadoop-2.6.1.tar.gz</span><br><span class="line">#</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>Hyperledger Fabric 1.0部署与使用</title>
    <url>/2018/07/19/Hyperledger%E7%9A%84%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="Hyperledger-Fabric-1-0部署与使用"><a href="#Hyperledger-Fabric-1-0部署与使用" class="headerlink" title="Hyperledger Fabric 1.0部署与使用"></a>Hyperledger Fabric 1.0部署与使用</h1><p><img src="/images/hyperledger_chatu.png" class="lazyload" data-srcset="/images/hyperledger_chatu.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="1-环境构建与测试"><a href="#1-环境构建与测试" class="headerlink" title="1.环境构建与测试"></a>1.环境构建与测试</h2><p>本文中用到的宿主环境是CentOS，版本为CentOS.x86_64(7.4);<br>通过Dcoker容器来运行Fabric的节点，版本为v1.0;<br>因此，启动Fabric网络的节点需要先安装 Docker、Docker-compose和Go语言环境;<br>然后在网上摘取相关的Docker镜像，再能过配置compose文件来启动各个节点;</p>
<h3 id="1-1-CentOS-yum源的配置"><a href="#1-1-CentOS-yum源的配置" class="headerlink" title="1.1: CentOS yum源的配置"></a>1.1: CentOS yum源的配置</h3><p>公司内网，可以让服务器以桥接方式接入网络;</p>
<p>a、备份原有的yum源配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 注:若系统环境是初始化安装的，最好先安装以下软件包</span><br><span class="line"># yum -y install wget screen vim</span><br><span class="line"># cd &#x2F;etc&#x2F;yum.repos.d&#x2F; &amp;&amp; mkdir bak</span><br><span class="line"># mv *repo bak</span><br></pre></td></tr></table></figure>
<p>b、设置阿里yum源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo</span><br></pre></td></tr></table></figure>
<p>c、清理缓存并生成新的缓存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum clean all </span><br><span class="line"># yum makecache</span><br></pre></td></tr></table></figure>
<p>d、更新yum库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum update </span><br></pre></td></tr></table></figure>
<blockquote>
<p>此操作的目的是为更新所有的内置库到最新版;<br>因为docker最新版的安装需要所对应的依赖都是最新版;<br>为了避免安装时软件包依赖的坑，故如此操作;  </p>
</blockquote>
<h3 id="1-2-Docker安装"><a href="#1-2-Docker安装" class="headerlink" title="1.2: Docker安装"></a>1.2: Docker安装</h3><p><a href="https://www.docker.com/">进入docker官网</a></p>
<p>a、GetDocker–&gt; CentOS –&gt; Get CE 社区版  –&gt; Get Docker CE on CentOS –&gt; Install Docker CE on CentOS.  </p>
<p>b、若服务器上存在旧的docker版本，需要先执行以下操作: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y remove docker docker-common docker-selinux docker-engine</span><br></pre></td></tr></table></figure>
<p>c、随后开始安装Docker CE<br>目前Docker官方最新版为<code>docker-ce-17.12.1.ce-1.el7.centos.x86_64.rpm</code>;<br>可以在<a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/">docker rpm包中下载并安装</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir -p &#x2F;tmp&#x2F;rpm&#x2F;docker</span><br><span class="line"># cd &#x2F;tmp&#x2F;rpm&#x2F;docker </span><br><span class="line"># wget https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;7&#x2F;x86_64&#x2F;stable&#x2F;Packages&#x2F;docker-ce-17.12.1.ce-1.el7.centos.x86_64.rpm</span><br><span class="line"># yum -y install *docker*rpm</span><br></pre></td></tr></table></figure>
<p>d、检查docker是否安装成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker --version</span><br><span class="line">Docker version 17.12.1-ce, build 7390fc6</span><br></pre></td></tr></table></figure>
<p>e、启动docker服务  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># systemctl start docker </span><br></pre></td></tr></table></figure>
<p>f、设置docker为开机自启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># systemctl enable docker</span><br></pre></td></tr></table></figure>
<h3 id="1-3-Docker-Compose安装"><a href="#1-3-Docker-Compose安装" class="headerlink" title="1.3: Docker-Compose安装"></a>1.3: Docker-Compose安装</h3><blockquote>
<p>Docker-Compose的离线安装相对于curl安装比较麻烦；<br>需要在官网提供的<a href="https://github.com/docker/compose/releases">github</a>中下载最新的docker-compose;<br>将其clone /tmp/rpm/docker/下；  </p>
</blockquote>
<p>a、执行以下命令后完成安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># curl -L https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.20.0-rc1&#x2F;docker-compose-&#96;uname -s&#96;-&#96;uname -m&#96; -o &#x2F;tmp&#x2F;rpm&#x2F;docker&#x2F;docker-compose</span><br></pre></td></tr></table></figure>
<p>b、移植docker-compose到PATH变量环境中 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># chmod +x docker-compose </span><br><span class="line"># cp -a docker-compose &#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>
<p>c、移植后查看安装的版本信息 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker-compose  --version</span><br><span class="line">docker-compose version 1.20.0-rc1, build 86428af</span><br></pre></td></tr></table></figure>
<p>到此docker环境已准备完毕</p>
<h3 id="1-4-Go环境准备"><a href="#1-4-Go环境准备" class="headerlink" title="1.4 Go环境准备"></a>1.4 Go环境准备</h3><p>a、参照<a href="https://golang.org/">go官网</a>，下载最新的Go语言包;<br>b、直接通过链接下载 <a href="http://www.cnblogs.com/aberic/p/7531276.html">Go官网连接</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir -p &#x2F;tmp&#x2F;rpm&#x2F;go &amp;&amp; cd &#x2F;tmp&#x2F;rpm&#x2F;go</span><br><span class="line"># wget https:&#x2F;&#x2F;test-inner.transfereasy.com&#x2F;go1.8.3.linux-amd64.tar.gz</span><br><span class="line"># 注: 目前这个包已经置于内网环境中</span><br><span class="line"># 注: 可以通过ssjinyao网站下载</span><br><span class="line"># wget https:&#x2F;&#x2F;rjyy.ssjinyao.com&#x2F;go1.8.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p>c、解压二进制程序到/usr/local目录下;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># tar -xvf go1.8.3.linux-amd64.tar.gz -C &#x2F;usr&#x2F;local&#x2F; </span><br><span class="line"># ll &#x2F;usr&#x2F;local&#x2F;go&#x2F;</span><br><span class="line">总用量 136</span><br><span class="line">drwxr-xr-x.  2 root root   205 5月  25 2017 api</span><br><span class="line">-rw-r--r--.  1 root root 33243 5月  25 2017 AUTHORS</span><br><span class="line">drwxr-xr-x.  2 root root    42 5月  25 2017 bin</span><br><span class="line">drwxr-xr-x.  4 root root    37 5月  25 2017 blog</span><br><span class="line">-rw-r--r--.  1 root root  1366 5月  25 2017 CONTRIBUTING.md</span><br><span class="line">-rw-r--r--.  1 root root 45710 5月  25 2017 CONTRIBUTORS</span><br><span class="line">drwxr-xr-x.  8 root root  4096 5月  25 2017 doc</span><br><span class="line">-rw-r--r--.  1 root root  5686 5月  25 2017 favicon.ico</span><br><span class="line">drwxr-xr-x.  3 root root    18 5月  25 2017 lib</span><br><span class="line">-rw-r--r--.  1 root root  1479 5月  25 2017 LICENSE</span><br><span class="line">drwxr-xr-x. 14 root root   190 5月  25 2017 misc</span><br><span class="line">-rw-r--r--.  1 root root  1303 5月  25 2017 PATENTS</span><br><span class="line">drwxr-xr-x.  7 root root    87 5月  25 2017 pkg</span><br><span class="line">-rw-r--r--.  1 root root  1399 5月  25 2017 README.md</span><br><span class="line">-rw-r--r--.  1 root root    26 5月  25 2017 robots.txt</span><br><span class="line">drwxr-xr-x. 46 root root  4096 5月  25 2017 src</span><br><span class="line">drwxr-xr-x. 17 root root  8192 5月  25 2017 test</span><br><span class="line">-rw-r--r--.  1 root root     7 5月  25 2017 VERSION</span><br></pre></td></tr></table></figure>
<p>d、配置go环境变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo &quot;export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;go&#x2F;bin&quot; &gt; &#x2F;etc&#x2F;profile.d&#x2F;go.sh</span><br><span class="line"># echo &quot;export GOPATH&#x3D;&#x2F;opt&#x2F;gopath&quot; &gt;&gt; &#x2F;etc&#x2F;profile.d&#x2F;go.sh</span><br><span class="line"># chmod +x &#x2F;etc&#x2F;profile.d&#x2F;go.sh</span><br><span class="line"># source &#x2F;etc&#x2F;profile.d&#x2F;go.sh</span><br><span class="line"># echo $PATH</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;srv&#x2F;jdk1.8.0_66&#x2F;bin:&#x2F;root&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;go&#x2F;bin</span><br><span class="line"># go version</span><br><span class="line">go version go1.8.3 linux&#x2F;amd64</span><br></pre></td></tr></table></figure>
<p>至此go环境变量已经配置完毕  </p>
<h2 id="2-Fabric源码及镜像文件处理"><a href="#2-Fabric源码及镜像文件处理" class="headerlink" title="2.Fabric源码及镜像文件处理"></a>2.Fabric源码及镜像文件处理</h2><h3 id="2-1下载Fabric源码"><a href="#2-1下载Fabric源码" class="headerlink" title="2.1下载Fabric源码"></a>2.1下载Fabric源码</h3><blockquote>
<p>下载Fabric源是因为要用到源码中提到的例子和工具;<br>工具编译需要用到go语言环境;<br>因此需要把源码目录放到$GOPATH环境变量下;<br>通过1.4中的安装配置 $GOPATH设置为/opt/gopath;  </p>
</blockquote>
<p><code>这里，我们可以使用git clone源码</code><br><code>也可以使用go get 命令</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># go get github.com&#x2F;hyperledger&#x2F;fabric</span><br><span class="line">或者是</span><br><span class="line"># mkdir -p &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F; </span><br><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F; &amp;&amp; git clone https:&#x2F;&#x2F;github.com&#x2F;hyperledger&#x2F;fabric.git</span><br><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric &amp;&amp; git checkout -b v1.0.0 </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 最后的工程结构如下</span><br><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger</span><br><span class="line"># tree  -L 1 fabric&#x2F;</span><br><span class="line">fabric&#x2F;</span><br><span class="line">├── bccsp</span><br><span class="line">├── bddtests</span><br><span class="line">├── CHANGELOG.md</span><br><span class="line">├── ci.properties</span><br><span class="line">├── common</span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── core</span><br><span class="line">├── devenv</span><br><span class="line">├── docker-env.mk</span><br><span class="line">├── docs</span><br><span class="line">├── events</span><br><span class="line">├── examples</span><br><span class="line">├── gossip</span><br><span class="line">├── gotools</span><br><span class="line">├── images</span><br><span class="line">├── LICENSE</span><br><span class="line">├── Makefile</span><br><span class="line">├── mkdocs.yml</span><br><span class="line">├── msp</span><br><span class="line">├── orderer</span><br><span class="line">├── peer</span><br><span class="line">├── proposals</span><br><span class="line">├── protos</span><br><span class="line">├── README.md</span><br><span class="line">├── release</span><br><span class="line">├── release_notes</span><br><span class="line">├── sampleconfig</span><br><span class="line">├── scripts</span><br><span class="line">├── settings.gradle</span><br><span class="line">├── test</span><br><span class="line">├── unit-test</span><br><span class="line">└── vendor</span><br><span class="line"></span><br><span class="line">23 directories, 9 files</span><br></pre></td></tr></table></figure>
<h3 id="2-2下载Fabric相关镜像文件"><a href="#2-2下载Fabric相关镜像文件" class="headerlink" title="2.2下载Fabric相关镜像文件"></a>2.2下载Fabric相关镜像文件</h3><blockquote>
<p>该操作有多种方式进行，如果是测试Fabric集群方案;<br>直接进入fabric/examples/e2e_cli目录下，运行./dowload-dockerimages.sh;<br>即可下载该工程必要的镜像文件;<br>一般情况下，为了保证镜像与下载到hyperledger中的源码demo版本号相对应;<br>该处方法属于较为妥当的方案; </p>
</blockquote>
<p>检索 <a href="https://hub.docker.com/u/hyperledger/?page=1">HyperLedger</a>,以hyperledger/fabric-peer为例，进入下载页面;<br>官方给出的下载方式如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker pull hyperledger&#x2F;fabric-peer</span><br></pre></td></tr></table></figure>
<p>但由于docker镜像下载在没有给出tag的情况下会默认使用latest;<br>所以该方案最终可能会下载失败,因此需在fabric-peer下载页选中其tags标签;<br>查看当前fabric-peer最新版本号，根据我们所使用的操作系统情况，选择x86_64-1.0.0版本；<br>故最终执行的docker下载命令如下:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker pull hyperledger&#x2F;fabric-peer:x86_64-1.0.0</span><br><span class="line">x86_64-1.0.0: Pulling from hyperledger&#x2F;fabric-peer</span><br><span class="line">aafe6b5e13de: Pull complete </span><br><span class="line">0a2b43a72660: Pull complete </span><br><span class="line">18bdd1e546d2: Pull complete </span><br><span class="line">8198342c3e05: Pull complete </span><br><span class="line">f56970a44fd4: Pull complete </span><br><span class="line">e32b597e7839: Pull complete </span><br><span class="line">a6e362fc71c4: Pull complete </span><br><span class="line">f107ea6d90f4: Pull complete </span><br><span class="line">72c8e84de237: Pull complete </span><br><span class="line">776cc74c9f73: Pull complete </span><br><span class="line">Digest: sha256:b7c1c2a6b356996c3dbe2b9554055cd2b63194cd7a492a83de2dbabf7f7e3c65</span><br><span class="line">Status: Downloaded newer image for hyperledger&#x2F;fabric-peer:x86_64-1.0.0</span><br></pre></td></tr></table></figure>
<p>根据上述方案，可以将这些必要的镜像由docker服务全部下载至本地;<br>并最终使用docker-compose来启动对应的镜像服务;<br>为了方便docker-compose的配置，将甩的镜像tag都改为latest，执行如下格式;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker tag IMAGEID(镜像id) REPOSITORY:TAG(仓库:标签)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli&#x2F;</span><br><span class="line"># bash download-dockerimages.sh  注:也可以用后面所提到shell建立</span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hyperledger&#x2F;fabric-peer        x86_64-1.0.0        6830dcd7b9b5        8 months ago        182MB</span><br><span class="line">hyperledger&#x2F;fabric-tools       latest              ae6b0f53cb70        9 months ago        1.32GB</span><br><span class="line">hyperledger&#x2F;fabric-tools       x86_64-1.0.0-beta   ae6b0f53cb70        9 months ago        1.32GB</span><br><span class="line">hyperledger&#x2F;fabric-couchdb     latest              31bbbec3d853        9 months ago        1.48GB</span><br><span class="line">hyperledger&#x2F;fabric-couchdb     x86_64-1.0.0-beta   31bbbec3d853        9 months ago        1.48GB</span><br><span class="line">hyperledger&#x2F;fabric-kafka       latest              c4ac1c9a4797        9 months ago        1.3GB</span><br><span class="line">hyperledger&#x2F;fabric-kafka       x86_64-1.0.0-beta   c4ac1c9a4797        9 months ago        1.3GB</span><br><span class="line">hyperledger&#x2F;fabric-zookeeper   latest              2c4ebacb6f00        9 months ago        1.31GB</span><br><span class="line">hyperledger&#x2F;fabric-zookeeper   x86_64-1.0.0-beta   2c4ebacb6f00        9 months ago        1.31GB</span><br><span class="line">hyperledger&#x2F;fabric-orderer     latest              11ff350dd297        9 months ago        179MB</span><br><span class="line">hyperledger&#x2F;fabric-orderer     x86_64-1.0.0-beta   11ff350dd297        9 months ago        179MB</span><br><span class="line">hyperledger&#x2F;fabric-peer        latest              e01c2b645f11        9 months ago        182MB</span><br><span class="line">hyperledger&#x2F;fabric-peer        x86_64-1.0.0-beta   e01c2b645f11        9 months ago        182MB</span><br><span class="line">hyperledger&#x2F;fabric-javaenv     latest              61c188dca542        9 months ago        1.42GB</span><br><span class="line">hyperledger&#x2F;fabric-javaenv     x86_64-1.0.0-beta   61c188dca542        9 months ago        1.42GB</span><br><span class="line">hyperledger&#x2F;fabric-ccenv       latest              7034cca1918d        9 months ago        1.29GB</span><br><span class="line">hyperledger&#x2F;fabric-ccenv       x86_64-1.0.0-beta   7034cca1918d        9 months ago        1.29GB</span><br><span class="line">hyperledger&#x2F;fabric-ca          latest              e549e8c53c2e        9 months ago        238MB</span><br><span class="line">hyperledger&#x2F;fabric-ca          x86_64-1.0.0-beta   e549e8c53c2e        9 months ago        238MB</span><br></pre></td></tr></table></figure>
<h3 id="2-3补充镜像备份和迁移"><a href="#2-3补充镜像备份和迁移" class="headerlink" title="2.3补充镜像备份和迁移"></a>2.3补充镜像备份和迁移</h3><p>上述HperLedger/Fabric 镜像数量较多且容量需求大，一套基本的服务镜像可达10G左右;<br>如果在多台服务器上部署，会耽误很多时间。因此，对于上述已下载的镜像;<br>我们需要使用docker save命令来备份，并通过scp命令来把这些文件拷贝至其它服务器；  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat dk_image_bak.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">##  开始自动备份镜像</span></span><br><span class="line">im=`docker images  | grep latest | wc -l`</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="variable">$im</span>` ;<span class="keyword">do</span> </span><br><span class="line">       id=` docker images | grep latest | grep fabric | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | sed -n <span class="variable">$i</span>\p`</span><br><span class="line">       fn=` docker images | grep latest | grep fabric | awk -F <span class="string">&quot;/&quot;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | sed -n <span class="variable">$i</span>\p `</span><br><span class="line">       dir=` docker images | grep latest  | grep fabric  | awk -F <span class="string">&quot;/&quot;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">       mkdir -p /tmp/images/docker/<span class="variable">$dir</span>/</span><br><span class="line">       docker save <span class="variable">$id</span> &gt; /tmp/images/docker/<span class="variable">$dir</span>/<span class="variable">$fn</span>.gz</span><br><span class="line">     <span class="keyword">done</span> </span><br><span class="line"><span class="comment">## 至此id已经保存镜像完毕</span></span><br><span class="line"><span class="comment">## 开始远程同步与迁移 </span></span><br><span class="line">ssh root@10.180.55.126  <span class="string">&quot;mkdir -p /tmp/images/docker/<span class="variable">$dir</span>/&quot;</span></span><br><span class="line">scp /tmp/images/docker/<span class="variable">$fn</span>/*gz root@10.180.55.126:/tmp/images/docker/<span class="variable">$dir</span>/</span><br></pre></td></tr></table></figure>
<p>当远端服务器接收到所有的镜像之后，可以执行如下命令来加载这些镜像文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker load &lt; &#x2F;tmp&#x2F;images&#x2F;docker&#x2F;hyperledger&#x2F;fabric-ccenv.gz </span><br></pre></td></tr></table></figure>
<p>以上2.3镜像的备份和迁移是可选方案;</p>
<h2 id="3-运行测试e2e"><a href="#3-运行测试e2e" class="headerlink" title="3.运行测试e2e"></a>3.运行测试e2e</h2><h3 id="3-1-运行fabric-sample的问题"><a href="#3-1-运行fabric-sample的问题" class="headerlink" title="3.1 运行fabric-sample的问题"></a>3.1 运行fabric-sample的问题</h3><blockquote>
<p>一般情况下，我们会参照官网来完成第一个网络测试;<br>在该在线文档中会让我们去下载一个<a href="http://hyperledger-fabric.readthedocs.io/en/latest/samples.html">fabric-sample</a>;<br>下载地址在<a href="https://github.com/hyperledger/fabric-samples">github</a>上;<br>我们需要将其下载至本地是一个fabric-sample-release的文件,将其更名为fabric-samples<br>随后将其移到opt/gopath/src目录下;  </p>
</blockquote>
<p>按照官网提示执行的命令是无法运行起first-network这个项目;<br>该demo需要先下载Platform-specific Binaries(特定的二进制文件);<br>按照官文档中的描述，需要执行如下命令; </p>
<p>官方提供bash脚本如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /root/ &amp;&amp; vim dk_bin.sh</span></span><br><span class="line">加入以下执行程序</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># current version of fabric released</span></span><br><span class="line"><span class="built_in">export</span> VERSION=<span class="variable">$&#123;1:-1.0.4&#125;</span></span><br><span class="line"><span class="comment"># current version of fabric-ca released</span></span><br><span class="line"><span class="built_in">export</span> CA_VERSION=<span class="variable">$&#123;2:-<span class="variable">$VERSION</span>&#125;</span></span><br><span class="line"><span class="comment"># current version of thirdparty images (couchdb, kafka and zookeeper) released</span></span><br><span class="line"><span class="built_in">export</span> THIRDPARTY_IMAGE_VERSION=0.4.6</span><br><span class="line"><span class="built_in">export</span> ARCH=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(uname -s|tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;|sed &#x27;s/mingw64_nt.*/windows/&#x27;)</span>-<span class="subst">$(uname -m | sed &#x27;s/x86_64/amd64/g&#x27;)</span>&quot;</span> | awk <span class="string">&#x27;&#123;print tolower($0)&#125;&#x27;</span>)</span><br><span class="line"><span class="comment">#Set MARCH variable i.e ppc64le,s390x,x86_64,i386</span></span><br><span class="line">MARCH=`uname -m`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">dockerFabricPull</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> FABRIC_TAG=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">for</span> IMAGES <span class="keyword">in</span> peer orderer ccenv javaenv tools; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;==&gt; FABRIC IMAGE: <span class="variable">$IMAGES</span>&quot;</span></span><br><span class="line">      <span class="built_in">echo</span></span><br><span class="line">      docker pull hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$FABRIC_TAG</span></span><br><span class="line">      docker tag hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$FABRIC_TAG</span> hyperledger/fabric-<span class="variable">$IMAGES</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">dockerThirdPartyImagesPull</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> THIRDPARTY_TAG=<span class="variable">$1</span></span><br><span class="line">  <span class="keyword">for</span> IMAGES <span class="keyword">in</span> couchdb kafka zookeeper; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;==&gt; THIRDPARTY DOCKER IMAGE: <span class="variable">$IMAGES</span>&quot;</span></span><br><span class="line">      <span class="built_in">echo</span></span><br><span class="line">      docker pull hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$THIRDPARTY_TAG</span></span><br><span class="line">      docker tag hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$THIRDPARTY_TAG</span> hyperledger/fabric-<span class="variable">$IMAGES</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">dockerCaPull</span></span>() &#123;</span><br><span class="line">      <span class="built_in">local</span> CA_TAG=<span class="variable">$1</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;==&gt; FABRIC CA IMAGE&quot;</span></span><br><span class="line">      <span class="built_in">echo</span></span><br><span class="line">      docker pull hyperledger/fabric-ca:<span class="variable">$CA_TAG</span></span><br><span class="line">      docker tag hyperledger/fabric-ca:<span class="variable">$CA_TAG</span> hyperledger/fabric-ca</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;CA_TAG:=&quot;$MARCH-$CA_VERSION&quot;&#125;</span></span><br><span class="line">: <span class="variable">$&#123;FABRIC_TAG:=&quot;$MARCH-$VERSION&quot;&#125;</span></span><br><span class="line">: <span class="variable">$&#123;THIRDPARTY_TAG:=&quot;$MARCH-$THIRDPARTY_IMAGE_VERSION&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;===&gt; Downloading platform specific fabric binaries&quot;</span></span><br><span class="line">curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>/hyperledger-fabric-<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>.tar.gz | tar xz</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;===&gt; Downloading platform specific fabric-ca-client binary&quot;</span></span><br><span class="line">curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric-ca/hyperledger-fabric-ca/<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>/hyperledger-fabric-ca-<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>.tar.gz | tar xz</span><br><span class="line"><span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;------&gt; <span class="variable">$VERSION</span> fabric-ca-client binary is not available to download  (Avaialble from 1.1.0-rc1) &lt;----&quot;</span></span><br><span class="line">     <span class="built_in">echo</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;===&gt; Pulling fabric Images&quot;</span></span><br><span class="line">dockerFabricPull <span class="variable">$&#123;FABRIC_TAG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;===&gt; Pulling fabric ca Image&quot;</span></span><br><span class="line">dockerCaPull <span class="variable">$&#123;CA_TAG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;===&gt; Pulling thirdparty docker images&quot;</span></span><br><span class="line">dockerThirdPartyImagesPull <span class="variable">$&#123;THIRDPARTY_TAG&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;===&gt; List out hyperledger docker images&quot;</span></span><br><span class="line">docker images | grep hyperledger*</span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod + x /root/dk_bin.sh</span></span><br><span class="line"><span class="comment"># bash /root/dk_bin.sh</span></span><br></pre></td></tr></table></figure>
<p>运行时效果如下; 注:若是内网环境，则可能执行时间较长;<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># bash &#x2F;root&#x2F;dk_bin.sh </span><br><span class="line">&#x3D;&#x3D;&#x3D;&gt; Downloading platform specific fabric binaries</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line"> 18 22.6M   18 4312k    0     0   6860      0  0:57:45  0:10:43  0:47:02  5364</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2运行e2e-cli项目"><a href="#3-2运行e2e-cli项目" class="headerlink" title="3.2运行e2e_cli项目"></a>3.2运行e2e_cli项目</h3><p>进入到/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/目录;</p>
<p>a、目录结构如下图;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># tree ..&#x2F;e2e_cli&#x2F;</span><br><span class="line">..&#x2F;e2e_cli&#x2F;</span><br><span class="line">├── base</span><br><span class="line">│   ├── docker-compose-base.yaml</span><br><span class="line">│   └── peer-base.yaml</span><br><span class="line">├── channel-artifacts</span><br><span class="line">├── configtx.yaml</span><br><span class="line">├── crypto-config.yaml</span><br><span class="line">├── docker-compose-cli.yaml</span><br><span class="line">├── docker-compose-couch.yaml</span><br><span class="line">├── docker-compose-e2e-template.yaml</span><br><span class="line">├── docker-compose-e2e.yaml</span><br><span class="line">├── download-dockerimages.sh</span><br><span class="line">├── end-to-end.rst</span><br><span class="line">├── examples</span><br><span class="line">│   └── chaincode</span><br><span class="line">│       └── go</span><br><span class="line">│           └── chaincode_example02</span><br><span class="line">│               └── chaincode_example02.go</span><br><span class="line">├── generateArtifacts.sh</span><br><span class="line">├── network_setup.sh</span><br><span class="line">└── scripts</span><br><span class="line">    └── script.sh</span><br><span class="line"></span><br><span class="line">7 directories, 14 files</span><br></pre></td></tr></table></figure>
<p>network_setup.sh是一个测试脚本，该脚本启动5个docker容器;<br>其中4个容器运行peer节点和1个容器运行orderer节点，它组成一个fabric集群;<br>另外还有一个cli容器用于创建channle、加入channel、安装和执行chaincode等操作;<br>测试用的chaincode定义了两个变量，在实例化的时候会给这两个变量赋予了初始值;<br>并能过invoke操作可以使用两个变量的值发生变化;  </p>
<p>b、通过以下命令进行测试;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli&#x2F;</span><br><span class="line"># bash network_setup.sh up</span><br></pre></td></tr></table></figure>
<p>c、当出现以下界面时，说明已经测试通了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2018-03-13 09:38:21.185 UTC [main] main -&gt; INFO 008 Exiting.....</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Query on PEER3 on channel &#39;mychannel&#39; is successful &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; </span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; All GOOD, End-2-End execution completed &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> _____   _   _   ____            _____   ____    _____ </span><br><span class="line">| ____| | \ | | |  _ \          | ____| |___ \  | ____|</span><br><span class="line">|  _|   |  \| | | | | |  _____  |  _|     __) | |  _|  </span><br><span class="line">| |___  | |\  | | |_| | |_____| | |___   &#x2F; __&#x2F;  | |___ </span><br><span class="line">|_____| |_| \_| |____&#x2F;          |_____| |_____| |_____|</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>d、如果上一步有报错，若没有部署其它应用，可以考虑将内核升级;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rpm --import https:&#x2F;&#x2F;www.elrepo.org&#x2F;RPM-GPG-KEY-elrepo.org</span><br><span class="line"># rpm -Uvh http:&#x2F;&#x2F;www.elrepo.org&#x2F;elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span><br><span class="line"># yum --disablerepo&#x3D;&quot;*&quot; --enablerepo&#x3D;&quot;elrepo-kernel&quot; list available</span><br><span class="line"># yum --enablerepo&#x3D;elrepo-kernel install kernel-ml</span><br><span class="line"># vim &#x2F;etc&#x2F;default&#x2F;grub</span><br><span class="line">GRUB_TIMEOUT&#x3D;5</span><br><span class="line">GRUB_DISTRIBUTOR&#x3D;&quot;$(sed &#39;s, release .*$,,g&#39; &#x2F;etc&#x2F;system-release)&quot;</span><br><span class="line">GRUB_DEFAULT&#x3D;0</span><br><span class="line">GRUB_DISABLE_SUBMENU&#x3D;true</span><br><span class="line">GRUB_TERMINAL_OUTPUT&#x3D;&quot;console&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX&#x3D;&quot;crashkernel&#x3D;auto rd.lvm.lv&#x3D;centos&#x2F;root rd.lvm.lv&#x3D;centos&#x2F;swap rhgb quiet&quot;</span><br><span class="line">GRUB_DISABLE_RECOVERY&#x3D;&quot;true&quot;</span><br><span class="line"># grub2-mkconfig -o &#x2F;boot&#x2F;grub2&#x2F;grub.cfg</span><br></pre></td></tr></table></figure>
<h2 id="4-创建Fabric多节点集群"><a href="#4-创建Fabric多节点集群" class="headerlink" title="4.创建Fabric多节点集群"></a>4.创建Fabric多节点集群</h2><h3 id="4-1配置说明"><a href="#4-1配置说明" class="headerlink" title="4.1配置说明"></a>4.1配置说明</h3><blockquote>
<p>首先可以根据官方Fabric自带的e2e_cli例子中的集群方案来生成集群;<br>与案例不同的是我们需要把容器分配到不同的服务器上；<br>各容器之间通过网络来进行通信，网络构建完成后进行相关的channel和chanincode操作;<br>目前用有五台服务器， 所有的服务器均是按照上述e2e_cli环境与测试步骤配置;<br>计划其中的四台服务器运行peer节点，另外一台服务器运行orderer节点;<br>为其它四个节点提供order服务; </p>
</blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>ip</th>
<th>节点标识</th>
<th>节点Hostname</th>
<th>Organization</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hyperledger</td>
<td>10.180.55.123</td>
<td>orderer</td>
<td>orderer.example.com</td>
<td>Orderer</td>
</tr>
<tr>
<td>Fabric1</td>
<td>10.180.55.124</td>
<td>sp0</td>
<td>peer0.org1.example.com</td>
<td>Org1</td>
</tr>
<tr>
<td>Fabric2</td>
<td>10.180.55.125</td>
<td>sp1</td>
<td>peer1.org1.example.com</td>
<td>Org1</td>
</tr>
<tr>
<td>Fabric3</td>
<td>10.180.55.126</td>
<td>sp2</td>
<td>peer0.org2.example.com</td>
<td>Org2</td>
</tr>
<tr>
<td>Fabric4</td>
<td>10.180.55.128</td>
<td>sp3</td>
<td>peer0.org3.example.com</td>
<td>Org2</td>
</tr>
</tbody>
</table>
<p>环境如下<br><img src="/images/hyperledger.png" class="lazyload" data-srcset="/images/hyperledger.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="4-2-生成公私钥、证书、创巨区块"><a href="#4-2-生成公私钥、证书、创巨区块" class="headerlink" title="4.2 生成公私钥、证书、创巨区块"></a>4.2 生成公私钥、证书、创巨区块</h3><p>公/私钥和证书是用于Server与Server之间的安全通信;<br>另外要创建channel并让其它节点加入channle就需要创世区块;<br>这些必要文件都可以通过一条命令生,并且官方已经给出脚本;</p>
<p>脚本在以下目录中; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli&#x2F;</span><br><span class="line"># ls generateArtifacts.sh</span><br></pre></td></tr></table></figure>
<p>使generateArtifacts.sh生成证书和config.tx，具体执行命令如下; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># bash generateArtifacts.sh  mychannel</span><br></pre></td></tr></table></figure>
<p>这里创建了3台服务器，在任意一台服务器的该目录下执行此项命令即可；<br>将会生成两个目录，分别为channel-artifacs、crypto-config</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">channel-artifacts&#x2F;</span><br><span class="line">├── channel.tx</span><br><span class="line">├── genesis.block</span><br><span class="line">├── Org1MSPanchors.tx</span><br><span class="line">└── Org2MSPanchors.tx</span><br><span class="line"></span><br><span class="line">0 directories, 4 files</span><br></pre></td></tr></table></figure>
<p>在上述目录里的文件用于orderer创建channle，它们根据configex.yaml的配置生成;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crypto-config</span><br><span class="line">├── ordererOrganizations</span><br><span class="line">└── peerOrganizations</span><br><span class="line"></span><br><span class="line">2 directories, 0 files</span><br></pre></td></tr></table></figure>
<p>在上述目录里有orderer和peer的证书、私钥和用于通信的加密的tls证书文件;<br>它通过configex.yaml配置文件生成;  </p>
<h3 id="4-3-配置多服务器"><a href="#4-3-配置多服务器" class="headerlink" title="4.3 配置多服务器"></a>4.3 配置多服务器</h3><p>根据4.2的方案，以及之前所述的gopath目录等配置方案;<br>我们假定所有的服务器都按照该文档的配置来操作;<br>所有服务器都有Fabric源码,且目录为 </p>
<p>如4.2所述,该命令只需要在某一台服务器上运行一次即可，其它服务器无需再次运行;  </p>
<p>在运行该命令的服务器/opt/gopath/src/github.com/hyperledger/fabric/example/e2e_cli;<br>该目录下会生成channel-artifacts和crypto-config目录;<br>需要把它们拷贝至其它服务器相同的e2e_cli目录下，如果在其它服务器中已经在该目录,则需要先把它删除;   </p>
<p>当所有服务器都有同一个channel-artifacts和crypto-config目录后;<br>开始配置compose文件;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">开始向其它两个服务器同步以上两个目录;</span><br><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli&#x2F;</span><br><span class="line"># tar -cvf  ctfile.tar.gz channel-artifacts crypto-config</span><br><span class="line"># scp ctfile.tar.gz root@10.180.55.124:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli</span><br><span class="line"># scp ctfile.tar.gz root@10.180.55.125:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli</span><br><span class="line"># ssh root@10.180.55.124 &quot;cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli &amp;&amp; tar -xvf ctfile.tar.gz&quot;</span><br><span class="line"># ssh root@10.180.55.125 &quot;cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli &amp;&amp; tar -xvf ctfile.tar.gz&quot;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-设置peer0-arg1-example-com节点的docker-compose文件"><a href="#4-4-设置peer0-arg1-example-com节点的docker-compose文件" class="headerlink" title="4.4 设置peer0.arg1.example.com节点的docker-compose文件"></a>4.4 设置peer0.arg1.example.com节点的docker-compose文件</h3><blockquote>
<p>e2e_cli中提供了多个yaml文件，我们可以基于docker-compose-cli.yaml文件创建;  </p>
</blockquote>
<p>修改docker-compose-peer.yaml，去掉orderer的配置；<br>只保留一个peer和cli，因为需要多级部署，节点与节点之间又是通过主机名通讯;<br>所以需要修改容器中的host文件,也就是xtra_hosts设置;<br>修改后的peer配置如下；   </p>
<p>同样的,cli也需要能够和各个节点通讯，所以cli下面也需要添加extra_hosts设置;<br>去掉无效的依赖，并且去掉command这一行，因为每个peer都会有个对应的客户端;<br>也是就是cli； 所以只需要去手动执行一次命令，而不是自动执行;   </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd base/</span></span><br><span class="line"><span class="comment"># cp docker-compose-base.yaml&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># vim base/docker-compose-base.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">peer0.org1.example.com:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">peer0.org1.example.com</span></span><br><span class="line">    <span class="attr">extends:</span></span><br><span class="line">      <span class="attr">file:</span>  <span class="string">base/docker-compose-base.yaml</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">peer0.org1.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cli:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cli</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hyperledger/fabric-tools</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GOPATH=/opt/gopath</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ID=cli</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/run/:/host/var/run/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">peer0.org1.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org1.example.com:10.180.55.125&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org2.example.com:10.180.55.126&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org2.example.com:10.180.55.128&quot;</span></span><br></pre></td></tr></table></figure>
<p>在3.2示例单机模式下，4个peer支映射主机不同的端口;<br>但是在多机部署的时候不需要映射不同端口的;<br>所以需要修改base/docker-compose-base.yaml文件，将所有peer的端口映射都改为相同的;  </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd base/</span></span><br><span class="line"><span class="comment"># cp docker-compose-base.yaml&#123;,.bak&#125;</span></span><br><span class="line"><span class="comment"># vim base/docker-compose-base.yaml</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7051</span><span class="string">:7051</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7052</span><span class="string">:7052</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7053</span><span class="string">:7053</span></span><br></pre></td></tr></table></figure>
<h3 id="4-5、-设置peer1-org1-example-com节点的docker-compose文件"><a href="#4-5、-设置peer1-org1-example-com节点的docker-compose文件" class="headerlink" title="4.5、 设置peer1.org1.example.com节点的docker-compose文件"></a>4.5、 设置peer1.org1.example.com节点的docker-compose文件</h3><p>与peer0.org1.example.com节点compose文件配置一样;<br>不过压岁要将启动的容器改为peer1.org1.example.com;<br>并且添加peer0.org1.example.com的IP映射;<br>对应的cli中改成对peer1.org1.example.com的依赖;<br>修改如下</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/</span></span><br><span class="line"><span class="comment">#  cp docker-compose-cli.yaml  docker-compose-peer.yaml</span></span><br><span class="line"><span class="comment">#  vim docker-compose-peer.yaml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">peer1.org1.example.com:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">peer1.org1.example.com</span></span><br><span class="line">    <span class="attr">extends:</span></span><br><span class="line">      <span class="attr">file:</span>  <span class="string">base/docker-compose-base.yaml</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">peer1.org1.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cli:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cli</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hyperledger/fabric-tools</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GOPATH=/opt/gopath</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ID=cli</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/run/:/host/var/run/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">peer1.org1.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org1.example.com:10.180.55.125&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org2.example.com:10.180.55.126&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org2.example.com:10.180.55.128&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd base&#x2F;</span><br><span class="line"># cp docker-compose-base.yaml&#123;,.bak&#125;</span><br><span class="line"># vim base&#x2F;docker-compose-base.yaml</span><br><span class="line"> ports:</span><br><span class="line">      - 7051:7051</span><br><span class="line">      - 7052:7052</span><br><span class="line">      - 7053:7053</span><br></pre></td></tr></table></figure>
<p>org2的两个结点配置文件 </p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat docker-compose-peer.yaml </span></span><br><span class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">peer0.org2.example.com:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">peer0.org2.example.com</span></span><br><span class="line">    <span class="attr">extends:</span></span><br><span class="line">      <span class="attr">file:</span>  <span class="string">base/docker-compose-base.yaml</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">peer0.org2.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cli:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cli</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hyperledger/fabric-tools</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GOPATH=/opt/gopath</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ID=cli</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/run/:/host/var/run/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">peer0.org2.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org1.example.com:10.180.55.125&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org2.example.com:10.180.55.126&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org2.example.com:10.180.55.128&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat docker-compose-peer.yaml </span></span><br><span class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">peer1.org2.example.com:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">peer1.org2.example.com</span></span><br><span class="line">    <span class="attr">extends:</span></span><br><span class="line">      <span class="attr">file:</span>  <span class="string">base/docker-compose-base.yaml</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">peer1.org2.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cli:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cli</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">hyperledger/fabric-tools</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GOPATH=/opt/gopath</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ID=cli</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/run/:/host/var/run/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">peer1.org2.example.com</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;orderer.example.com:10.180.55.123&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org1.example.com:10.180.55.124&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org1.example.com:10.180.55.125&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer0.org2.example.com:10.180.55.126&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;peer1.org2.example.com:10.180.55.128&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-6-设置order节点的docker-compose文件"><a href="#4-6-设置order节点的docker-compose文件" class="headerlink" title="4.6 设置order节点的docker-compose文件"></a>4.6 设置order节点的docker-compose文件</h3><p>与创建peer的配置文件类似，需要复制一个yaml文件出来修改; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli</span><br><span class="line"># cp docker-compose-cli.yaml docker-compose-orderer.yaml</span><br></pre></td></tr></table></figure>
<p>orderer服务器上我们只需要保留order设置;<br>其他peer和cli设置都可以删除。order可以不设置extra_hosts;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">orderer.example.com:</span><br><span class="line">  extends:</span><br><span class="line">    file:   base&#x2F;docker-compose-base.yaml</span><br><span class="line">    service: orderer.example.com</span><br><span class="line">  container_name: orderer.example.com</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#启动报错，单纯的报命令调用用法错误</span><br><span class="line">docker rm -f $(docker ps -aq)</span><br></pre></td></tr></table></figure>
<p>若部署环境在内网，则需要修改5台服务器的/etc/hosts文件;<br>确保服务器之间可以基于主机名互相通信； </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;hosts </span><br><span class="line">10.180.55.123 orderer.example.com</span><br><span class="line">10.180.55.124 peer0.org1.example.com</span><br><span class="line">10.180.55.125 peer1.org1.example.com</span><br><span class="line">10.180.55.126 peer0.org2.example.com</span><br><span class="line">10.180.55.128 peer1.org2.example.com</span><br></pre></td></tr></table></figure>
<h2 id="5-启动Fabric多节点集群"><a href="#5-启动Fabric多节点集群" class="headerlink" title="5.启动Fabric多节点集群"></a>5.启动Fabric多节点集群</h2><h3 id="5-1启动orderere节点服务"><a href="#5-1启动orderere节点服务" class="headerlink" title="5.1启动orderere节点服务"></a>5.1启动orderere节点服务</h3><p>操作完成后，此时节点的compose配置文件及证书难目录都已经准备完成;<br>可以开始尝试启动多机Fabric集群;<br>首先要启orderer节点，切换至orderer.example.com服务器;<br>即前文指定的10.180.55.123的服务器，执行如下命令进入启docker进程;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker-compose -f docker-compose-orderer.yaml up -d</span><br></pre></td></tr></table></figure>
<p>运行完毕后我们可以使用docker ps看到运行了一个名字为orderer.example.com的节点; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker ps</span><br><span class="line">CONTAINER ID        IMAGE                        COMMAND             CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">f188590553b7        hyperledger&#x2F;fabric-orderer   &quot;orderer&quot;           25 seconds ago      Up 22 seconds       0.0.0.0:7050-&gt;7050&#x2F;tcp   orderer.example.com</span><br></pre></td></tr></table></figure>
<h3 id="5-2启动peer节点服务"><a href="#5-2启动peer节点服务" class="headerlink" title="5.2启动peer节点服务"></a>5.2启动peer节点服务</h3><p>切换到peer0.org1.example.com服务器，即前文指定的10.180.55.124服务器;<br>启动本服务器的peer节点和cli;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker-compose  -f docker-compose-peer.yaml  up -d</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker ps</span><br><span class="line">CONTAINER ID        IMAGE                      COMMAND             CREATED             STATUS              PORTS                              NAMES</span><br><span class="line">2f49281a48c9        hyperledger&#x2F;fabric-tools   &quot;&#x2F;bin&#x2F;bash&quot;         38 minutes ago      Up 38 minutes                                          cli</span><br><span class="line">8ef009a57457        hyperledger&#x2F;fabric-peer    &quot;peer node start&quot;   38 minutes ago      Up 38 minutes       0.0.0.0:7051-7053-&gt;7051-7053&#x2F;tcp   peer0.org1.example.com</span><br></pre></td></tr></table></figure>
<p><code>注: 其它三个peer结点与以上结点的启动/验证方式相同</code><br><code>遇到的坑:在CentOS中要把iptables关闭;selinux为开机关闭</code><br><code>确保5个结点间域名和端口都能telnet 通;
例telnet peer1.org2.example.com 7051;</code></p>
<p>现在整个Fabric4+1服务器网络已经成型;</p>
<h3 id="5-3创建channle和运行chaincode"><a href="#5-3创建channle和运行chaincode" class="headerlink" title="5.3创建channle和运行chaincode"></a>5.3创建channle和运行chaincode</h3><p>切换到peer0.org1.example.com服务器上;<br>使用该服务器的cli来运行创建Channel和运行ChainCode的操作; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker exec -it cli bash </span><br></pre></td></tr></table></figure>
<p>进入容器后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@078471f17d9a:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer# .&#x2F;scripts&#x2F;script.sh mychannel</span><br></pre></td></tr></table></figure>
<p>该脚本会一步步的完成创建通道,将其他节点加入通道，更新锚节点;<br>创建ChainCode，初始化帐户，查询，转帐，再次查询等链上操作的自动化;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2018-03-19 03:00:03.146 UTC [main] main -&gt; INFO 007 Exiting.....</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Query on PEER3 on channel &#39;mychannel&#39; is successful &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; </span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; All GOOD, End-2-End execution completed &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> _____   _   _   ____            _____   ____    _____ </span><br><span class="line">| ____| | \ | | |  _ \          | ____| |___ \  | ____|</span><br><span class="line">|  _|   |  \| | | | | |  _____  |  _|     __) | |  _|  </span><br><span class="line">| |___  | |\  | | |_| | |_____| | |___   &#x2F; __&#x2F;  | |___ </span><br><span class="line">|_____| |_| \_| |____&#x2F;          |_____| |_____| |_____|</span><br></pre></td></tr></table></figure>
<p>出现以上结果出明4+1的Fabric多级部署已经成功;<br>在peer0.org1.example.com的cli容器内;<br>之前的2个容器，已经因ChainCode创建了3个容器; </p>
<p><img src="/images/hyperledger2.png" class="lazyload" data-srcset="/images/hyperledger2.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="E2E-运行后查询与转帐测试"><a href="#E2E-运行后查询与转帐测试" class="headerlink" title="E2E 运行后查询与转帐测试"></a>E2E 运行后查询与转帐测试</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查询</span><br><span class="line"># docker exec -it cli bash</span><br><span class="line">root@078471f17d9a:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer# peer chaincode query -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p><img src="/images/hyperledger-test1.png" class="lazyload" data-srcset="/images/hyperledger-test1.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 转帐20到b</span><br><span class="line"># peer chaincode invoke -o orderer.example.com:7050  --tls true --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;ordererOrganizations&#x2F;example.com&#x2F;orderers&#x2F;orderer.example.com&#x2F;msp&#x2F;tlscacerts&#x2F;tlsca.example.com-cert.pem  -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;20&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p><img src="/images/hyperledger-test2.png" class="lazyload" data-srcset="/images/hyperledger-test2.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>python日常练习</title>
    <url>/2018/07/19/python%E6%97%A5%E5%B8%B8%E7%BB%83%E4%B9%A0%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="python-日常练习"><a href="#python-日常练习" class="headerlink" title="python 日常练习"></a>python 日常练习</h1><p><img src="/images/python.jpg" class="lazyload" data-srcset="/images/python.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="解压序赋值给多个变量"><a href="#解压序赋值给多个变量" class="headerlink" title="解压序赋值给多个变量"></a>解压序赋值给多个变量</h2><p>现有一个包含N个元素的元组或者是序列，将它里面的值解压后同时赋值给N个变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">In [22]: p &#x3D; (1,2)</span><br><span class="line">In [23]: a,b &#x3D; p</span><br><span class="line">In [24]: a</span><br><span class="line">Out[24]: 1</span><br><span class="line">In [25]: b</span><br><span class="line">Out[25]: 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">In [26]: date &#x3D; [&#39;test&#39;,&#39;frum&#39;,&#39;bind&#39;,&#39;lance&#39;,(201,202,203)]</span><br><span class="line">In [27]: te,fr,bi,la,data &#x3D; date</span><br><span class="line">In [28]: te</span><br><span class="line">Out[28]: &#39;test&#39;</span><br><span class="line">In [29]: fr</span><br><span class="line">Out[29]: &#39;frum&#39;</span><br><span class="line">In [30]: bi</span><br><span class="line">Out[30]: &#39;bind&#39;</span><br><span class="line">In [31]: date</span><br><span class="line">Out[31]: [&#39;test&#39;, &#39;frum&#39;, &#39;bind&#39;, &#39;lance&#39;, (201, 202, 203)]</span><br><span class="line">In [32]: data</span><br><span class="line">Out[32]: (201, 202, 203)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">In [41]: a &#x3D; &#39;Hello&#39;</span><br><span class="line">In [42]: b,c,d,e,f &#x3D; a</span><br><span class="line">In [43]: b</span><br><span class="line">Out[43]: &#39;H&#39;</span><br><span class="line">In [44]: c</span><br><span class="line">Out[44]: &#39;e&#39;</span><br><span class="line">In [45]: d</span><br><span class="line">Out[45]: &#39;l&#39;</span><br><span class="line">In [46]: f</span><br><span class="line">Out[46]: &#39;o&#39;</span><br></pre></td></tr></table></figure>
<h2 id="初级练习题"><a href="#初级练习题" class="headerlink" title="初级练习题"></a>初级练习题</h2><h3 id="给一个半径，求圆的面积和周长。圆周率3-14"><a href="#给一个半径，求圆的面积和周长。圆周率3-14" class="headerlink" title="给一个半径，求圆的面积和周长。圆周率3.14"></a>给一个半径，求圆的面积和周长。圆周率3.14</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from math import pi</span><br><span class="line">r&#x3D;int(input(&#39;r&#x3D;&#39;))</span><br><span class="line">print(&#39;area&#x3D;&#39;+str(pi*r*r))</span><br><span class="line">print(&#39;circumference&#x3D;&#39;+str(2*pi*r))</span><br><span class="line"></span><br><span class="line">(py3_env) kernel ➤ python test.py                                                                                                                                                               </span><br><span class="line">r&#x3D;10</span><br><span class="line">area&#x3D;314.1592653589793</span><br><span class="line">circumference&#x3D;62.83185307179586</span><br></pre></td></tr></table></figure>
<h3 id="输入两个数，比较大小后，从小到大升序打印"><a href="#输入两个数，比较大小后，从小到大升序打印" class="headerlink" title="输入两个数，比较大小后，从小到大升序打印"></a>输入两个数，比较大小后，从小到大升序打印</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a &#x3D; input(&#39;first: &#39;)</span><br><span class="line">b &#x3D; input(&#39;second: &#39;)</span><br><span class="line"></span><br><span class="line">if a &gt; b:</span><br><span class="line">    print(b,a)</span><br><span class="line">else:</span><br><span class="line">    print(a,b)</span><br><span class="line"></span><br><span class="line">(py3_env) kernel ➤ python test.py                                                                                                                                                               </span><br><span class="line">first: 10</span><br><span class="line">second: 11</span><br><span class="line">10 11</span><br></pre></td></tr></table></figure>
<h3 id="输入n个数，求每次输入后的算数平均数"><a href="#输入n个数，求每次输入后的算数平均数" class="headerlink" title="输入n个数，求每次输入后的算数平均数"></a>输入n个数，求每次输入后的算数平均数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">n &#x3D; 0</span><br><span class="line">sum &#x3D; 0</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    i &#x3D; input(&quot;&gt;&gt;&gt;&quot;)</span><br><span class="line">    if i &#x3D;&#x3D; &#39;quit&#39;:</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line">    n +&#x3D; 1</span><br><span class="line">    sum +&#x3D; int(i)</span><br><span class="line">    avg &#x3D; sum&#x2F;n</span><br><span class="line">    print(avg)</span><br></pre></td></tr></table></figure>
<h3 id="打印九九乘法表"><a href="#打印九九乘法表" class="headerlink" title="打印九九乘法表"></a>打印九九乘法表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for i in range(1,10):</span><br><span class="line">    for j in range(1,i+1):</span><br><span class="line">        print(str(j)+&#39;x&#39;+ str(i) +&quot;&#x3D;&quot; +str(i*j),end&#x3D;&#39; &#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(1,10):</span><br><span class="line">    for j in range(1,i+1):</span><br><span class="line">        product &#x3D; i*j</span><br><span class="line"></span><br><span class="line">        if j &gt; 1 and product &lt;10:</span><br><span class="line">            product &#x3D; str(product) + &#39; &#39;</span><br><span class="line">        else:</span><br><span class="line">            product &#x3D; str(product)</span><br><span class="line">        print(str(j)+&#39;x&#39;+str(i)+&quot;&#x3D;&quot;+str(product),end&#x3D;&#39; &#39;)</span><br><span class="line">    print()</span><br></pre></td></tr></table></figure>
<h3 id="打印菱形"><a href="#打印菱形" class="headerlink" title="打印菱形"></a>打印菱形</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for i in range(-3,4):</span><br><span class="line">    if i&lt;0:</span><br><span class="line">        prespace &#x3D; -i</span><br><span class="line">    else:</span><br><span class="line">        prespace &#x3D; i</span><br><span class="line"></span><br><span class="line">    print(&#39; &#39;*prespace + &#39;*&#39;*(7-prespace*2))</span><br></pre></td></tr></table></figure>
<h3 id="斐波那契数列，100以内"><a href="#斐波那契数列，100以内" class="headerlink" title="斐波那契数列，100以内"></a>斐波那契数列，100以内</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">斐波那契数列:1,1,2,3,5,8,13,21,34,55,89,144,...</span><br><span class="line">a &#x3D; 0</span><br><span class="line">b &#x3D; 1</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    c &#x3D; a+b</span><br><span class="line">    if c &gt; 100: break</span><br><span class="line">    a&#x3D;b</span><br><span class="line">    b&#x3D;c</span><br><span class="line">    print(c)</span><br><span class="line"></span><br><span class="line">a &#x3D; 1</span><br><span class="line">b &#x3D; 1</span><br><span class="line">index &#x3D; 2</span><br><span class="line">print(&#39;&#123;0&#125;,&#123;1&#125;&#39;.format(0,0))</span><br><span class="line">print(&#39;&#123;0&#125;,&#123;1&#125;&#39;.format(1,1))</span><br><span class="line">print(&#39;&#123;0&#125;,&#123;1&#125;&#39;.format(2,1))</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    c &#x3D; a + b</span><br><span class="line">    a &#x3D; b</span><br><span class="line">    b &#x3D; c</span><br><span class="line">    index +&#x3D;1</span><br><span class="line">    print(&#39;&#123;0&#125;,&#123;1&#125;&#39;.format(index,c))</span><br><span class="line"></span><br><span class="line">    if index &#x3D;&#x3D; 101:</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>
<h3 id="pip-简单使用"><a href="#pip-简单使用" class="headerlink" title="pip 简单使用"></a>pip 简单使用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置国内的源</span><br><span class="line">~ ➤ cat ~&#x2F;.pip&#x2F;pip.conf</span><br><span class="line">[global]</span><br><span class="line">index-url&#x3D;http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple</span><br><span class="line">trusted-host&#x3D;mirrors.aliyun.com</span><br><span class="line"># pip 常用命令</span><br><span class="line"># pip install xxx yyy</span><br><span class="line"># pip list </span><br><span class="line"># pip search keyword 或者 pypi</span><br><span class="line"># pip help install </span><br><span class="line"># pip install jupyter </span><br><span class="line"># pip -V </span><br><span class="line"># pip freeze &gt; requirement</span><br><span class="line"># pip install -r requirement</span><br><span class="line"># virtualenv  ~&#x2F;Desktop&#x2F;MyPython&#x2F;py3_env --python&#x3D;python3</span><br></pre></td></tr></table></figure>
<h3 id="猜数字的游戏"><a href="#猜数字的游戏" class="headerlink" title="猜数字的游戏"></a>猜数字的游戏</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NUM &#x3D; 35</span><br><span class="line"></span><br><span class="line">count &#x3D; 0</span><br><span class="line"></span><br><span class="line">while count &lt; 3:</span><br><span class="line">    user_input &#x3D; int(input(&#39;请你输入一个数字: &#39;))</span><br><span class="line">    if user_input &#x3D;&#x3D; NUM :</span><br><span class="line">        print(&#39;你猜对了&#39;)</span><br><span class="line">        break</span><br><span class="line">    elif user_input &lt; NUM:</span><br><span class="line">        print(&#39;你输入的数比这个数要小&#39;)</span><br><span class="line">    else:</span><br><span class="line">        print(&#39;你输入的数比这个要大&#39;)</span><br><span class="line">    count +&#x3D;1</span><br><span class="line">else:</span><br><span class="line">    print(&#39;你已经超过了三次机会&#39;)</span><br></pre></td></tr></table></figure>
<p>不用变量时，把变量放空</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for _ in range(0,3):</span><br><span class="line">    user_input &#x3D; int(input(&#39;请你输入一个数字: &#39;))</span><br><span class="line">    if user_input &#x3D;&#x3D; NUM :</span><br><span class="line">        print(&#39;你猜对了&#39;)</span><br><span class="line">        break</span><br><span class="line">    elif user_input &lt; NUM:</span><br><span class="line">        print(&#39;你输入的数比这个数要小&#39;)</span><br><span class="line">    else:</span><br><span class="line">        print(&#39;你输入的数比这个要大&#39;)</span><br><span class="line">    count +&#x3D;1</span><br><span class="line">else:</span><br><span class="line">    print(&#39;你已经超过了三次机会&#39;)</span><br></pre></td></tr></table></figure>
<h3 id="打印扬辉三角"><a href="#打印扬辉三角" class="headerlink" title="打印扬辉三角"></a>打印扬辉三角</h3><p>python 中求阶乘的方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import math </span><br><span class="line">math.factorial(5) # 5 的阶乘 </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import math</span><br><span class="line"></span><br><span class="line">lines &#x3D; 10</span><br><span class="line"></span><br><span class="line">for n in range(0,lines):</span><br><span class="line">    if n &#x3D;&#x3D; 0:</span><br><span class="line">        for _ in range(0, lines &#x2F;&#x2F; 2):</span><br><span class="line">            print(&#39; &#39;,end&#x3D;&#39; &#39;)</span><br><span class="line">        print(1)</span><br><span class="line">    else:</span><br><span class="line">        for _ in range(0,lines &#x2F;&#x2F;2):</span><br><span class="line">            print(&#39; &#39;,end&#x3D;&#39; &#39;)</span><br><span class="line"></span><br><span class="line">        for m in range(0, n+1):</span><br><span class="line">            num &#x3D; math.factorial(n) &#x2F;&#x2F;(math.factorial(m) * math.factorial(n-m))</span><br><span class="line">            print(num, end&#x3D;&#39; &#39;)</span><br><span class="line">        print()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">host &#x3D; &#123;&quot;host%d&quot;%i: &quot;192.168.1.%d&quot;%i for i in range(2,11)&#125;</span><br><span class="line">for i in host.values():</span><br><span class="line">    print (i)</span><br><span class="line">    </span><br><span class="line">lst &#x3D; list(range(1,101))</span><br><span class="line">lst[0::2] [::-1]</span><br><span class="line">lst[1::2] [::-1]</span><br></pre></td></tr></table></figure>
<h3 id="python-与用户交互输入位数生成若干随机数，求若干随机数的最大值，最小值"><a href="#python-与用户交互输入位数生成若干随机数，求若干随机数的最大值，最小值" class="headerlink" title="python 与用户交互输入位数生成若干随机数，求若干随机数的最大值，最小值"></a>python 与用户交互输入位数生成若干随机数，求若干随机数的最大值，最小值</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line">from fabric.colors import red,blue,green,cyan</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a&#x3D;int(input(red(&#39;您要获取多少个随机数: &#39;)))</span><br><span class="line">b&#x3D;int(input(red(&#39;您要获取的随机数位数: &#39;))) + 1</span><br><span class="line"></span><br><span class="line">num_two &#x3D; []</span><br><span class="line">for i in range(int(a)):</span><br><span class="line">    num &#x3D; random.randrange(0,b)</span><br><span class="line">    print(cyan(&#39;第&#39;) + blue(i + 1) + cyan(&#39;个随机数为&#39;),blue(num))</span><br><span class="line">    num_two.append(num)</span><br><span class="line">print(cyan(&#39;您获取了&#39;) + blue(i + 1) + cyan(&#39;个随机数&#39;))</span><br><span class="line">print(cyan(&#39;您的第&#39;) + blue(num_two.index(max(num_two)) +1 ) + cyan(&#39;个随机数为最大值:&#39;), green(max(num_two)))</span><br><span class="line">print(cyan(&#39;您的第&#39;) + blue(num_two.index(min(num_two)) +1 ) + cyan(&#39;个随机数为最小值:&#39;), green(min(num_two)))</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from fabric.colors import red,blue,green,cyan</span><br><span class="line">import random</span><br><span class="line">a&#x3D;int(input(red(&#39;您要获取多少个随机数: &#39;)))</span><br><span class="line">b&#x3D;int(input(red(&#39;您要獲取的隨機數範圍: &#39;))) + 1</span><br><span class="line">range_init &#x3D; list(range(1,int(a)+1))</span><br><span class="line">print (range_init)</span><br><span class="line">num_two &#x3D; []</span><br><span class="line">for i in range_init:</span><br><span class="line">    num &#x3D; random.randrange(0,b)</span><br><span class="line">    num &#x3D; random.randrange(0,b)</span><br><span class="line"></span><br><span class="line">    print(cyan(&#39;第&#39;) + blue(i) + cyan(&#39;个随机数为&#39;),blue(num))</span><br><span class="line">    num_two.append(num)</span><br><span class="line">print(cyan(&#39;您获取了&#39;) + blue(i) + cyan(&#39;个随机数&#39;))</span><br><span class="line">print(cyan(&#39;您的第&#39;) + blue(num_two.index(max(num_two))+1) + cyan(&#39;个随机数为最大值:&#39;), green(max(num_two)))</span><br><span class="line">print(cyan(&#39;您的第&#39;) + blue(num_two.index(min(num_two))+1) + cyan(&#39;个随机数为最小值:&#39;), green(min(num_two)))</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>awk 的练习</title>
    <url>/2018/06/18/awk%E7%9A%84%E7%BB%83%E4%B9%A0/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="awk每日练"><a href="#awk每日练" class="headerlink" title="awk每日练"></a>awk每日练</h1><p><img src="/images/awk.jpg" class="lazyload" data-srcset="/images/awk.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="先熟练一些操作"><a href="#先熟练一些操作" class="headerlink" title="先熟练一些操作"></a>先熟练一些操作</h2><h3 id="1、-以空格做为分格符，打印passwd-文件的第一列"><a href="#1、-以空格做为分格符，打印passwd-文件的第一列" class="headerlink" title="1、 以空格做为分格符，打印passwd 文件的第一列"></a>1、 以空格做为分格符，打印passwd 文件的第一列</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk &#39;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="2、-以冒号做分格符，打印passwd-文件的第一列-即获取当前系统中存在的所有用户"><a href="#2、-以冒号做分格符，打印passwd-文件的第一列-即获取当前系统中存在的所有用户" class="headerlink" title="2、 以冒号做分格符，打印passwd 文件的第一列,即获取当前系统中存在的所有用户"></a>2、 以冒号做分格符，打印passwd 文件的第一列,即获取当前系统中存在的所有用户</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="3、-以管道方式，打印passwd-文件的第三列，即共获取当前系统中所有用户的id号"><a href="#3、-以管道方式，打印passwd-文件的第三列，即共获取当前系统中所有用户的id号" class="headerlink" title="3、 以管道方式，打印passwd 文件的第三列，即共获取当前系统中所有用户的id号"></a>3、 以管道方式，打印passwd 文件的第三列，即共获取当前系统中所有用户的id号</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  cat &#x2F;etc&#x2F;passwd | awk -F : &#39;&#123;print $3&#125;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="4、-以输入重定向方式，打印-passwd-文件的第1列，即获取当前系统中存在的所有用户"><a href="#4、-以输入重定向方式，打印-passwd-文件的第1列，即获取当前系统中存在的所有用户" class="headerlink" title="4、 以输入重定向方式，打印 passwd 文件的第1列，即获取当前系统中存在的所有用户"></a>4、 以输入重定向方式，打印 passwd 文件的第1列，即获取当前系统中存在的所有用户</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;print $1&#125;&#39; &lt; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="5、用awk-自带BEGIN打印-hello-awk-字符串"><a href="#5、用awk-自带BEGIN打印-hello-awk-字符串" class="headerlink" title="5、用awk 自带BEGIN打印  hello awk 字符串"></a>5、用awk 自带BEGIN打印  hello awk 字符串</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk &#39;BEGIN&#123;print &quot;hello awk&quot;&#125;&#39; 执行只办输出hello awk </span><br></pre></td></tr></table></figure>
<h3 id="6、-用awk-获取df-命令的filesystem-与userd"><a href="#6、-用awk-获取df-命令的filesystem-与userd" class="headerlink" title="6、 用awk  获取df 命令的filesystem 与userd %"></a>6、 用awk  获取df 命令的filesystem 与userd %</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># df | awk &#39;&#123;print $1,$5&#125;&#39;  </span><br><span class="line"># df | awk &#39;&#123;print $1 $5&#125;&#39;  # 注意这样输出信息就连接到一块了</span><br><span class="line">    FilesystemUse%</span><br><span class="line">    &#x2F;dev&#x2F;vda113%</span><br><span class="line">    devtmpfs0%</span><br><span class="line">    tmpfs0%</span><br><span class="line">    tmpfs1%</span><br><span class="line">    tmpfs0%</span><br><span class="line">    tmpfs0%</span><br><span class="line"># df | awk &#39;&#123;print $1&quot;&#x3D;&#x3D;&#x3D;&quot;$5&#125;&#39; #  在两个位置变量的中间加入三个&#x3D;&#x3D;&#x3D; 号</span><br><span class="line">    Filesystem&#x3D;&#x3D;&#x3D;Use%</span><br><span class="line">    &#x2F;dev&#x2F;vda1&#x3D;&#x3D;&#x3D;13%</span><br><span class="line">    devtmpfs&#x3D;&#x3D;&#x3D;0%</span><br><span class="line">    tmpfs&#x3D;&#x3D;&#x3D;0%</span><br><span class="line">    tmpfs&#x3D;&#x3D;&#x3D;1%</span><br><span class="line">    tmpfs&#x3D;&#x3D;&#x3D;0%</span><br><span class="line">    tmpfs&#x3D;&#x3D;&#x3D;0%</span><br><span class="line"> # df | awk &#39;&#123;print $1&quot;\t&quot;$5&#125;&#39;  # 在两个位置变量的中间加入一个tab 键</span><br><span class="line">    Filesystem      Use%</span><br><span class="line">    &#x2F;dev&#x2F;vda1       13%</span><br><span class="line">    devtmpfs        0%</span><br><span class="line">    tmpfs   0%</span><br><span class="line">    tmpfs   1%</span><br><span class="line">    tmpfs   0%</span><br><span class="line">    tmpfs   0%</span><br></pre></td></tr></table></figure>
<h3 id="7、-结合tail-命令来进行字符串切割"><a href="#7、-结合tail-命令来进行字符串切割" class="headerlink" title="7、 结合tail 命令来进行字符串切割"></a>7、 结合tail 命令来进行字符串切割</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  tail -4 &#x2F;etc&#x2F;fstab | awk &#39;&#123;print $3,$4&#125;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="8、-手动指定分隔符为-，打印第一列-第三列，FS-即指定分隔符"><a href="#8、-手动指定分隔符为-，打印第一列-第三列，FS-即指定分隔符" class="headerlink" title="8、 手动指定分隔符为: ，打印第一列:第三列，FS 即指定分隔符"></a>8、 手动指定分隔符为: ，打印第一列:第三列，FS 即指定分隔符</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v FS&#x3D;&quot;:&quot; &#39;&#123;print $1,FS,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="9、将列出分符，改为其它的字符"><a href="#9、将列出分符，改为其它的字符" class="headerlink" title="9、将列出分符，改为其它的字符"></a>9、将列出分符，改为其它的字符</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk -v FS&#x3D;&quot;:&quot; -v OFS&#x3D;&quot;uid is &quot; &#39;&#123;print $1,FS,$3&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="10-、以空格做为换行符，取其第一个字段"><a href="#10-、以空格做为换行符，取其第一个字段" class="headerlink" title="10 、以空格做为换行符，取其第一个字段"></a>10 、以空格做为换行符，取其第一个字段</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v RS&#x3D;&quot; &quot; &#39;&#123;print $1&#125;&#39; text.txt</span><br></pre></td></tr></table></figure>
<h3 id="11、-将记录输出分隔符默认值”-n”，换成”-”"><a href="#11、-将记录输出分隔符默认值”-n”，换成”-”" class="headerlink" title="11、 将记录输出分隔符默认值”\n”，换成”===”"></a>11、 将记录输出分隔符默认值”\n”，换成”===”</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk -v FS&#x3D;&quot;:&quot; -v ORS&quot;&#x3D;&#x3D;&#x3D;&quot; &#39;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="12、-截取-etc-passwd-的登录shell"><a href="#12、-截取-etc-passwd-的登录shell" class="headerlink" title="12、 截取/etc/passwd 的登录shell"></a>12、 截取/etc/passwd 的登录shell</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v FS&#x3D;&quot;:&quot; &#39;&#123;print $NF-1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="13、-截取-etc-passwd-的家目录"><a href="#13、-截取-etc-passwd-的家目录" class="headerlink" title="13、 截取 /etc/passwd 的家目录"></a>13、 截取 /etc/passwd 的家目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk -v FS&#x3D;&quot;:&quot; &#39;&#123;print $(NF-1)&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="14、截取指定字段并打印awk-内置变量"><a href="#14、截取指定字段并打印awk-内置变量" class="headerlink" title="14、截取指定字段并打印awk 内置变量"></a>14、截取指定字段并打印awk 内置变量</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v RS&#x3D;&quot;:&quot; &#39;&#123;print RS,NR,$0&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="15、-以冒号分隔记录当前字段个数并进行计算"><a href="#15、-以冒号分隔记录当前字段个数并进行计算" class="headerlink" title="15、 以冒号分隔记录当前字段个数并进行计算"></a>15、 以冒号分隔记录当前字段个数并进行计算</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v FS&#x3D;&quot;:&quot; &#39;&#123;print NF*5&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="16、统计当前输入文件的个数"><a href="#16、统计当前输入文件的个数" class="headerlink" title="16、统计当前输入文件的个数"></a>16、统计当前输入文件的个数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;print FNR&#125;&#39; &#x2F;etc&#x2F;passwd &#x2F;etc&#x2F;shadow</span><br></pre></td></tr></table></figure>
<h3 id="17、-打印两文件输出的行数"><a href="#17、-打印两文件输出的行数" class="headerlink" title="17、 打印两文件输出的行数"></a>17、 打印两文件输出的行数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;print FNR,$1&#125;&#39; &#x2F;etc&#x2F;passwd &#x2F;etc&#x2F;shadow</span><br></pre></td></tr></table></figure>
<h3 id="18、输出两文件的文件名行号及对应用的用户名"><a href="#18、输出两文件的文件名行号及对应用的用户名" class="headerlink" title="18、输出两文件的文件名行号及对应用的用户名"></a>18、输出两文件的文件名行号及对应用的用户名</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk -F: &#39;&#123;print FILENAME,FNR,$1&#125;&#39; &#x2F;etc&#x2F;passwd &#x2F;etc&#x2F;shadow</span><br></pre></td></tr></table></figure>
<h3 id="19、-统计命令行参数的个数"><a href="#19、-统计命令行参数的个数" class="headerlink" title="19、 统计命令行参数的个数"></a>19、 统计命令行参数的个数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;BEGIN&#123;print ARGC&#125;&#39; &#x2F;etc&#x2F;passwd &#x2F;etc&#x2F;group </span><br><span class="line">    3</span><br></pre></td></tr></table></figure>
<h3 id="20、-打印命令行参数的内容"><a href="#20、-打印命令行参数的内容" class="headerlink" title="20、 打印命令行参数的内容"></a>20、 打印命令行参数的内容</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;BEGIN&#123;print ARGV[2]&#125;&#39; &#x2F;etc&#x2F;passwd &#x2F;etc&#x2F;group </span><br><span class="line">   &#x2F;etc&#x2F;group</span><br></pre></td></tr></table></figure>
<p>awk变量 自定义变量区分大小写</p>
<h3 id="21、-指定变量调用打印"><a href="#21、-指定变量调用打印" class="headerlink" title="21、 指定变量调用打印"></a>21、 指定变量调用打印</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: -v name&#x3D;&quot;username&quot; &#39;&#123;print name&quot;:&quot;$1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="22-、-指定多个变量调用打印，并加入制表符"><a href="#22-、-指定多个变量调用打印，并加入制表符" class="headerlink" title="22 、 指定多个变量调用打印，并加入制表符"></a>22 、 指定多个变量调用打印，并加入制表符</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: -v name&#x3D;&quot;username&quot; -v uid&#x3D;&quot;uid &quot; &#39;&#123;print name&quot;:&quot;$1&quot;\t&quot;uid&quot;:&quot;$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;n&#x3D;&quot;username&quot;;uid&#x3D;&quot;userid&quot;; print n &quot;:&quot;$1&quot;\t&quot;uid&quot;:&quot;$3&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<p>了解一下以下的练习<br>awk -F: ‘{n=”haha”; print n,m;m=”xixi”}’ /etc/passwd 变量后定义也行（表面上可用，但实际上有问题：第一次循环）<br>awk -F: ‘BEGIN{n=”haha”;hehe=100;m=200;print n,m}’ /etc/passwd </p>
<h3 id="23、-printf-指定输出格式"><a href="#23、-printf-指定输出格式" class="headerlink" title="23、 printf  指定输出格式"></a>23、 printf  指定输出格式</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;printf &quot;%s &#x3D;&#x3D; %d\n&quot;,$1,$3&#125;&#39; &#x2F;etc&#x2F;passwd %格式与$字符必须一一对应</span><br><span class="line"># awk -F: &#39;&#123;printf &quot;%s20s &#x3D;&#x3D; %d\n&quot;,$1,$3&#125;&#39; &#x2F;etc&#x2F;passwd 右对齐</span><br><span class="line"># awk -F: &#39;&#123;printf &quot;%s-20s &#x3D;&#x3D; %d\n&quot;,$1,$3&#125;&#39; &#x2F;etc&#x2F;passwd 左对齐</span><br><span class="line"># awk -F: &#39;&#123;printf &quot;%s-20s &#x3D;&#x3D; %10.3f\n&quot;,$1,$3&#125;&#39; &#x2F;etc&#x2F;passwd 小数位的宽度</span><br><span class="line"># awk -F: &#39;&#123;printf &quot;%s-20s &#x3D;&#x3D; %+df\n&quot;,$1,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F : &#39;&#123;printf &quot;%s\n&quot;,$1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F : &#39;&#123;printf &quot;Username: %s\n&quot;,$1&#125;&#39; &#x2F;etc&#x2F;passwd  </span><br></pre></td></tr></table></figure>
<h3 id="24、awk-数术运算操作"><a href="#24、awk-数术运算操作" class="headerlink" title="24、awk 数术运算操作"></a>24、awk 数术运算操作</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;BEGIN&#123;print 2^10&#125;&#39;</span><br><span class="line"># awk &#39;BEGIN&#123;n&#x3D;1;m&#x3D;2;print m+&#x3D;n&#125;&#39; </span><br><span class="line"># awk &#39;BEGIN&#123;n&#x3D;1;m&#x3D;2;print m++;print m&#125;&#39; </span><br><span class="line"># awk &#39;BEGIN&#123;n&#x3D;1;m&#x3D;2;print ++m;print m&#125;&#39; </span><br><span class="line"># awk -F: &#39;$3 &gt; 1000&#123;print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;$3&#x3D;&#x3D;0&#123;print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;$0~&quot;root&quot;&#123;print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd ~包涵</span><br><span class="line"># awk -F: &#39;$0~&#x2F;root&#x2F;&#123;print $0&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;$0~&#x2F;^root&#x2F;&#123;print $0&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;$0 !~&#x2F;^root&#x2F;&#123;print $0&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F : &#39;$0 ~ &#x2F;root&#x2F;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="25、操作符-amp-amp-两都执行"><a href="#25、操作符-amp-amp-两都执行" class="headerlink" title="25、操作符  &amp;&amp; 两都执行  ||"></a>25、操作符  &amp;&amp; 两都执行  ||</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;$3&#x3D;&#x3D;0 || $3 &gt;&#x3D;1000 &#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: !(&#39;$3&#x3D;&#x3D;0 || $3 &gt;&#x3D;1000) &#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd  or </span><br><span class="line"># awk -F : &#39;$3&gt;1 &amp;&amp; $3 &lt;1000 &#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="26、条件表达式三目"><a href="#26、条件表达式三目" class="headerlink" title="26、条件表达式三目"></a>26、条件表达式三目</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;$3&lt;1000?var&#x3D;&quot;sysuser&quot;: var&#x3D;&quot;commonuser&quot;&#123;print var&quot;:&quot;$1,$3&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<h3 id="27、常用语法练习"><a href="#27、常用语法练习" class="headerlink" title="27、常用语法练习"></a>27、常用语法练习</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;&#x2F;^root&#x2F;&#123;print $0&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk &#39;&#x2F;^U&#x2F;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk &#39;!&#x2F;^U&#x2F;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk &#39;&quot; &quot;&#123;print $0&#125;&#39; &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk &#39;i&#x3D;1;j&#x3D;1&#123;print i,j&#125;&#39; &#x2F;etc&#x2F;fstab 把文件打印两次</span><br><span class="line"># awk ‘i&#x3D;1;j&#x3D;0&#123;print i,j&#125;’ &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk &#39;i&#x3D;1;j&#x3D;1&#123;print i,j&#125;&#39; &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk &#39;!2&#39; &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk &#39;&quot;abc&quot;&#39; &#x2F;etc&#x2F;fstab </span><br><span class="line"># awk -F: &#39;$NF&#x3D;&#x3D;&quot;&#x2F;bin&#x2F;bash&quot;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;$NF~&quot;&#x2F;bin&#x2F;bash&quot;  &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;$NF!~&quot;&#x2F;bin&#x2F;bash&quot;  &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;&#x2F;^root&#x2F;,&#x2F;^ftp&#x2F;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;&#x2F;^root\&gt;&#x2F;,&#x2F;^ftp&#x2F;&#39; &#x2F;etc&#x2F;passwd  注：\b 不行</span><br><span class="line"># awk -F: &#39;NR&gt;&#x3D;10&amp;&amp;NR&lt;&#x3D;30&#123;print NR&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="28、比较绕的练习"><a href="#28、比较绕的练习" class="headerlink" title="28、比较绕的练习"></a>28、比较绕的练习</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;NR&gt;&#x3D;10&amp;&amp;NR&lt;&#x3D;30&#123;print NR,$0&#125;&#39; &#x2F;etc&#x2F;passswd </span><br><span class="line"># awk -F: &#39;BEGIN&#123;print &quot;linenumber usernmae&quot;&#125;NR&gt;&#x3D;10&amp;&amp;NR&lt;&#x3D;30&#123;print NR,$1&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;BEGIN&#123;print &quot;linenumber username&quot;&#125;NR&gt;&#x3D;10&amp;&amp;NR&lt;&#x3D;30&#123;print NR,$1&#125; END print &quot;end&quot;&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># awk -F: &#39;&#123;print &quot;linenumber username&quot;;print NR,$1&#125;END&#123;print &quot;end&quot;&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;print &quot;linenumber username\n-------------&quot;;print $1&#125;END&#123;print &quot;end&quot;&#125;&#39; &#x2F;etc&#x2F;passwd </span><br><span class="line"># seq 10 | awk &#39;&#123;i&#x3D;!i;print i&#125;&#39;</span><br><span class="line"># seq 10 | awk &#39;i&#x3D;!i&#39;</span><br><span class="line"># seq 10 | awk &#39;!(i&#x3D;!i)&#39;</span><br><span class="line"># seq 10 | awk -v -i&#x3D;1 &#39;i&#x3D;!i&#39;</span><br></pre></td></tr></table></figure>
<h3 id="29、常见循环与用法"><a href="#29、常见循环与用法" class="headerlink" title="29、常见循环与用法"></a>29、常见循环与用法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;BEGIN&#123;for(i&#x3D;1;i&lt;&#x3D;100;i++)sum+&#x3D;i;print sum&#125;&#39;</span><br><span class="line"># echo &#123;1..100&#125;|sed &#39;s&#x2F; &#x2F;+&#x2F;g&#39;|bc</span><br><span class="line"># echo &#123;1..100&#125;| tr &quot; &quot; &quot;+&quot; |bc </span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">num&#x3D;0</span><br><span class="line">for i in &#96;seq 100&#96;; do </span><br><span class="line">    num&#x3D;$[$num+$i]</span><br><span class="line">    echo $i</span><br><span class="line">done</span><br><span class="line">echo $num</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python2.7</span><br><span class="line">num&#x3D;0</span><br><span class="line">for i in range(1,101):</span><br><span class="line">    print i</span><br><span class="line">    num &#x3D; num + i</span><br><span class="line">print num</span><br></pre></td></tr></table></figure>
<h2 id="AWK-基础"><a href="#AWK-基础" class="headerlink" title="AWK 基础"></a>AWK 基础</h2><ul>
<li>awk：Aho, Weinberger, Kernighan，报告生成器，格式化文本输出</li>
<li>有多种版本：New awk（nawk）,GNU awk（gawk）</li>
<li>gawk：模式扫描和处理语言</li>
</ul>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk [options] &#39;program&#39; var&#x3D;value file…</span><br><span class="line"># awk [options] -f programfile var&#x3D;value file…</span><br><span class="line"># awk [options] &#39;BEGIN&#123; action;… &#125; pattern&#123; action;… &#125; END&#123; action;… &#125;&#39; file ...</span><br></pre></td></tr></table></figure>
<p>awk程序通常由：BEGIN语句块、能够使用模式匹配的通用语句块、END语句块，共3部分组成<br>  program通常是被单引号或双引号中<br>    选项：<br>        -F:指明输入时用到的字段分隔符<br>        -v var=value:自定义变量</p>
<h3 id="awk语言"><a href="#awk语言" class="headerlink" title="awk语言"></a>awk语言</h3><ul>
<li>基本格式：awk [options] ‘program’ file…</li>
<li>program:pattern{action statements;..}</li>
<li>pattern和action：<br>pattern部分决定动作语句何时触发及触发事件<pre><code>BEGIN,END
</code></pre>  action statements 对数据进行处理，放在{}内指明<br>print, printf</li>
</ul>
<p>分割符、域和记录<br>    awk执行时，由分隔符分隔的字段（域）标记$1,$2..$n称为域标识。$0为所有域，注意：和shell中变量$符含义不同<br>    文件的每一行称为记录<br>    省略action行，则默认执行print $0的操作</p>
<h3 id="awk工作原理"><a href="#awk工作原理" class="headerlink" title="awk工作原理"></a>awk工作原理</h3><p>第一步：执行BEGIN{action;… } 语句块中的语句<br>第二步：从文件或标准输入(stdin)读取一行，然后执行pattern{ action;<br>… } 语句块，它逐行扫描文件，从第一行到最后一行重复这个过程，直到文件全部被读取完毕。<br>    第三步：当读至输入流末尾时，执行END{action;…}语句块<br>        BEGIN语句块在awk开始从输入流中读取行之前被执行，这是一个可选的语句块，比如变量初始化、打印输出表格的表头等语句通常可以写在BEGIN语句块中<br>        END语句块在awk从输入流中读取完所有的行之后即被执行，比如打印所有行的分析结果这类信息汇总都是在END语句块中完成，它也是一个可选语句块<br>        pattern语句块中的通用命令是最重要的部分，也是可选的。如果没有提供pattern语句块，则默认执行{ print }，即打印每一个读取到的行，awk读取的每一行都会执行该语句块</p>
<h3 id="awk-格式"><a href="#awk-格式" class="headerlink" title="awk 格式"></a>awk 格式</h3><p> 要点：<br>        (1)逗号分隔符<br>        (2)输出的各item可以字符串，也可以是数值；当前记录的字段、变量或awk的表达式<br>        (3)如省略item，相当于print $0</p>
<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;&#123;print &quot;hello,awk&quot;&#125;&#39;</span><br><span class="line"># awk -F: &#39;&#123;print&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;print &quot;wang&quot;&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;print $0&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;print $1&quot;\t&quot;$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># tail -3 &#x2F;etc&#x2F;fstab |awk  &#39;&#123;print $2,$4&#125;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="awk-变量"><a href="#awk-变量" class="headerlink" title="awk 变量"></a>awk 变量</h3><ul>
<li>变量：内置和自定义变量</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">模式</th>
<th style="text-align:center">例子</th>
<th style="text-align:center">匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">BEGIN</td>
<td style="text-align:center">BEGIN</td>
<td style="text-align:center">输入被读取之前</td>
</tr>
<tr>
<td style="text-align:center">END</td>
<td style="text-align:center">END</td>
<td style="text-align:center">所有输入被读取之后</td>
</tr>
<tr>
<td style="text-align:center">expression</td>
<td style="text-align:center">$3&gt;100</td>
<td style="text-align:center">第三个字段大于100</td>
</tr>
<tr>
<td style="text-align:center">string-matching</td>
<td style="text-align:center">/Asia/</td>
<td style="text-align:center">含有Asia的行</td>
</tr>
<tr>
<td style="text-align:center">compound</td>
<td style="text-align:center">\$3&lt;100 &amp;&amp; $4 ==”Asia”</td>
<td style="text-align:center">第三个字段小于100且第四个字段含有Asia的行</td>
</tr>
<tr>
<td style="text-align:center">range</td>
<td style="text-align:center">NR == 10,NR==20</td>
<td style="text-align:center">输入的第10行到20行</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">变量</th>
<th style="text-align:center">意义</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">FS</td>
<td style="text-align:center">控制输入行的字段分隔符</td>
<td style="text-align:center">“ “</td>
</tr>
<tr>
<td style="text-align:center">OFS</td>
<td style="text-align:center">输出字段分隔符</td>
<td style="text-align:center">“ “</td>
</tr>
<tr>
<td style="text-align:center">RS</td>
<td style="text-align:center">控制着输入行的记录分隔符</td>
<td style="text-align:center">“\n”</td>
</tr>
<tr>
<td style="text-align:center">NF</td>
<td style="text-align:center">当前记录的字段个数</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">NR</td>
<td style="text-align:center">到目前为止读的记录数量</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">FNR</td>
<td style="text-align:center">当前输入文件的记录个数</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">ARGC</td>
<td style="text-align:center">命令行参数的个数</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">ARGV</td>
<td style="text-align:center">命令行参数数组</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">FILENAME</td>
<td style="text-align:center">当前输入文件名</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">OFMT</td>
<td style="text-align:center">数值的输出格式</td>
<td style="text-align:center">“%.6g”</td>
</tr>
<tr>
<td style="text-align:center">RLENGTE</td>
<td style="text-align:center">被函数match匹配的字符串的长度</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">RSTART</td>
<td style="text-align:center">被函数match匹配的字符串的开始</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">SUBSEP</td>
<td style="text-align:center">下标分隔符</td>
<td style="text-align:center">“\034”</td>
</tr>
</tbody>
</table>
<p>FS：输入字段分隔符，默认为空白字符   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v FS&#x3D;&#39;:&#39; &#39;&#123;print $1,FS,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;&#123;print $1,$3,$7&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># s&#x3D;:;awk -v FS&#x3D;$s &#39;&#123;print $1 FS $3&#125;&#39; &#x2F;etc&#x2F;passwd </span><br></pre></td></tr></table></figure>
<p>OFS：输出字段分隔符，默认为空白字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v FS&#x3D;&#39;:&#39; -v OFS&#x3D;&#39;:&#39; &#39;&#123;print $1,$3,$7&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>RS：输入记录分隔符，指定输入时的换行符，原换行符仍有效</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  awk -v RS&#x3D;&#39; &#39; &#39;&#123;print &#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>ORS：输出记录分隔符，输出时用指定符号代替换行符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v RS&#x3D;&#39; &#39; -v ORS&#x3D;&#39;###&#39;‘&#123;print&#125;’ &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>NF：字段数量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F:&#39;&#123;print NF&#125;&#39; &#x2F;etc&#x2F;fstab, 引用内置变量不用$</span><br><span class="line"># awk -F: &#39;&#123;print $(NF-1)&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>NR：行号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;&#123;print NR&#125;&#39; &#x2F;etc&#x2F;fstab; awk END&#39;&#123;print NR&#125;&#39; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></figure>
<p>FNR：各文件分别计数, 行号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;&#123;print FNR&#125;&#39; &#x2F;etc&#x2F;fstab &#x2F;etc&#x2F;inittab</span><br></pre></td></tr></table></figure>
<p>FILENAME：当前文件名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;&#123;print FILENAME&#125;&#39; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></figure>
<p>ARGC：命令行参数的个数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;&#123;print ARGC&#125;&#39; &#x2F;etc&#x2F;fstab &#x2F;etc&#x2F;inittab</span><br><span class="line"># awk &#39;BEGIN &#123;print ARGC&#125;&#39; &#x2F;etc&#x2F;fstab &#x2F;etc&#x2F;inittab</span><br></pre></td></tr></table></figure>
<p>ARGV：数组，保存的是命令行所给定的各参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;BEGIN &#123;print ARGV[0]&#125;&#39; &#x2F;etc&#x2F;fstab &#x2F;etc&#x2F;inittab</span><br><span class="line"># awk &#39;BEGIN &#123;print ARGV[1]&#125;&#39; &#x2F;etc&#x2F;fstab &#x2F;etc&#x2F;inittab</span><br></pre></td></tr></table></figure>
<p>自定义变量(区分字符大小写)<br>        (1) -v var=value<br>        (2) 在program中直接定义</p>
<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -v test&#x3D;&#39;hello gawk&#39; &#39;&#123;print test&#125;&#39; &#x2F;etc&#x2F;fstab</span><br><span class="line"># awk -v test&#x3D;&#39;hello gawk&#39; &#39;BEGIN&#123;print test&#125;&#39;</span><br><span class="line"># awk &#39;BEGIN&#123;test&#x3D;&quot;hello,gawk&quot;;print test&#125;&#39;</span><br><span class="line"># awk -F:‘&#123;sex&#x3D;“male”;print $1,sex,age;age&#x3D;18&#125;’ &#x2F;etc&#x2F;passwd</span><br><span class="line"># cat awkscript </span><br><span class="line">      &#123;print script,$1,$2&#125;</span><br><span class="line">        awk -F: -f awkscript script&#x3D;“awk” &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="printf-参数"><a href="#printf-参数" class="headerlink" title="printf 参数"></a>printf 参数</h3><ul>
<li><p>格式化输出：printf “FORMAT”, item1, item2, …<br>  (1)必须指定FORMAT<br>  (2)不会自动换行，需要显式给出换行控制符，\n<br>  (3)FORMAT中需要分别为后面每个item指定格式符</p>
</li>
<li><p>格式符：与item一一对应</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">格式符</th>
<th style="text-align:left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">%c</td>
<td style="text-align:left">显示字符的ASCII码</td>
</tr>
<tr>
<td style="text-align:left">%d,%i</td>
<td style="text-align:left">显示十进制整数</td>
</tr>
<tr>
<td style="text-align:left">%e,%E</td>
<td style="text-align:left">显示科学计数法数值</td>
</tr>
<tr>
<td style="text-align:left">%f</td>
<td style="text-align:left">显示为浮点数</td>
</tr>
<tr>
<td style="text-align:left">%g,%G</td>
<td style="text-align:left">以科学计数法或浮点形式显示数值</td>
</tr>
<tr>
<td style="text-align:left">%s</td>
<td style="text-align:left">显示字符串</td>
</tr>
<tr>
<td style="text-align:left">%u</td>
<td style="text-align:left">无符号整数</td>
</tr>
<tr>
<td style="text-align:left">%%</td>
<td style="text-align:left">显示%自身</td>
</tr>
</tbody>
</table>
<h3 id="修饰符："><a href="#修饰符：" class="headerlink" title="修饰符："></a>修饰符：</h3><p>[.#]：第一个数字控制显示的宽度；第二个#表示小数点后精度，%3.1f<br>-: 左对齐（默认右对齐） %-15s<br>+：显示数值的正负符号 %+d</p>
<h3 id="printf示例"><a href="#printf示例" class="headerlink" title="printf示例"></a>printf示例</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf &quot;%s&quot;,$1&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf &quot;%s\n&quot;,$1&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf &quot;%-20s %10d\n&quot;,$1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf &quot;Username: %s\n&quot;,$1&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf “Username: %s,UID:%d\n&quot;,$1,$3&#125;’ /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf &quot;Username: %15s,UID:%d\n&quot;,$1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;printf &quot;Username: %-15s,UID:%d\n&quot;,$1,$3&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>
<h3 id="操作符表达式"><a href="#操作符表达式" class="headerlink" title="操作符表达式"></a>操作符表达式</h3><ol>
<li>初等表达式包括<br> 数值与字符串常量, 变量, 字段, 函数调用, 数组元素.</li>
<li>可以把表达式组合起来的运算符包括<br> 赋值运算符 = += -= <em>= /= %= ^= 条件表达式 ?:<br> 逻辑运算符 || (OR), &amp;&amp; (AND), ! (NOT)<br> 匹配运算符 ~ 和!~<br> 关系运算符 &lt; &lt;= == != &gt; &gt;=<br> 拼接运算符 (没有显式的拼接运算符)<br> 算术运算符 + - </em> / % ^<br> 单目运算符 +和-<br> 自增与自减运算符++和–(包括前缀与后缀)<br>括号 (用于分组)  </li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">操作</th>
<th style="text-align:center">运算符</th>
<th style="text-align:center">例子</th>
<th style="text-align:center">例子的含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">赋值</td>
<td style="text-align:center">= += -= *= /= %= ^=</td>
<td style="text-align:center">x *= 2</td>
<td style="text-align:center">x = x * 2</td>
</tr>
<tr>
<td style="text-align:center">条件表达式</td>
<td style="text-align:center">?:</td>
<td style="text-align:center">x ? y : z</td>
<td style="text-align:center">若x为真,则 y,否则z</td>
</tr>
<tr>
<td style="text-align:center">逻辑与</td>
<td style="text-align:center">&amp;&amp;</td>
<td style="text-align:center">x &amp;&amp; y</td>
<td style="text-align:center">若x与y都为真, 则为1,否则为0</td>
</tr>
<tr>
<td style="text-align:center">数组成员</td>
<td style="text-align:center">in</td>
<td style="text-align:center">i in a</td>
<td style="text-align:center">如果a[i]存在, 则为1,否则为0</td>
</tr>
<tr>
<td style="text-align:center">匹配</td>
<td style="text-align:center">~ !~</td>
<td style="text-align:center">$1 ~ /x/</td>
<td style="text-align:center">如果第一个字段包含x,则为1,否则为0</td>
</tr>
<tr>
<td style="text-align:center">关系运算</td>
<td style="text-align:center">&lt; &lt;= == != &gt;= &gt;</td>
<td style="text-align:center">x == y</td>
<td style="text-align:center">如果x等于y,则为1, 否则为0</td>
</tr>
<tr>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">拼接</td>
<td style="text-align:center">“a” “bc”</td>
<td style="text-align:center">“abc”</td>
<td style="text-align:center">不存在显式的拼接运算符</td>
</tr>
<tr>
<td style="text-align:center">减法, 加法</td>
<td style="text-align:center">+ -</td>
<td style="text-align:center">x + y</td>
<td style="text-align:center">x与y的和</td>
</tr>
<tr>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">乘法, 除法, 取模</td>
<td style="text-align:center">* / %</td>
<td style="text-align:center">x % y</td>
<td style="text-align:center">x除以y的余数</td>
</tr>
<tr>
<td style="text-align:center">单目加, 单目减</td>
<td style="text-align:center">+ -</td>
<td style="text-align:center">-x</td>
<td style="text-align:center">x的相反数</td>
</tr>
<tr>
<td style="text-align:center">逻辑非</td>
<td style="text-align:center">!</td>
<td style="text-align:center">!$1</td>
<td style="text-align:center">若$1为空或为0, 则为1,否则为0</td>
</tr>
<tr>
<td style="text-align:center">指数运算</td>
<td style="text-align:center">^</td>
<td style="text-align:center">x ^ y</td>
<td style="text-align:center">x的y次方</td>
</tr>
<tr>
<td style="text-align:center">自增, 自减</td>
<td style="text-align:center">++ –</td>
<td style="text-align:center">++x, x++</td>
<td style="text-align:center">为x加1</td>
</tr>
<tr>
<td style="text-align:center">字段</td>
<td style="text-align:center">$</td>
<td style="text-align:center">$i+1</td>
<td style="text-align:center">1加上第i个字段的值</td>
</tr>
<tr>
<td style="text-align:center">组</td>
<td style="text-align:center">( )</td>
<td style="text-align:center">($i)++</td>
<td style="text-align:center">给第i个字段的值加1</td>
</tr>
</tbody>
</table>
<p>算术操作符：<br>    x+y, x-y, x*y, x/y, x^y, x%y<br>    -x:转换为负数<br>    +x:转换为数值</p>
<p>字符串操作符：没有符号的操作符，字符串连接</p>
<p>赋值操作符：<br>    =, +=, -=, *=, /=, %=, ^=<br>    ++, –</p>
<p>比较操作符：<br>    ==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p>模式匹配符<br>    ~：左边是否和右边匹配包含<br>    !~ ：是否不匹配</p>
<p>  示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk –F: &#39;$0 ~ &#x2F;root&#x2F;&#123;print $1&#125;‘ &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk &#39;$0~&quot;^root&quot;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk &#39;$0 !~ &#x2F;root&#x2F;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;$3&#x3D;&#x3D;0&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>逻辑操作符：<br>    &amp;&amp; 与<br>    || 或<br>    ！ 非</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;$3&gt;&#x3D;0 &amp;&amp; $3&lt;&#x3D;1000 &#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;$3&#x3D;&#x3D;0 || $3&gt;&#x3D;1000 &#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: ‘!($3&#x3D;&#x3D;0) &#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: ‘!($3&gt;&#x3D;500) &#123;print $3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;$3 &gt; 100 &amp;&amp; $3&lt;1000 &#123;print $1,$3&#125;&#39; passwd</span><br></pre></td></tr></table></figure>
<h3 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function_name(argu1, argu2, ...)</span><br><span class="line">条件表达式（三目表达式）   </span><br><span class="line">    selector?if-true-expression:if-false-expression</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">awk -F: &#39;&#123;$3&gt;&#x3D;1000?usertype&#x3D;&quot;Common User&quot;:usertype&#x3D;&quot;Sysadmin or SysUser&quot;;printf &quot;%15s:%-s\n&quot;,$1,usertype&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">awk -F: &#39;&#123;$3&gt;1000?username&#x3D;&quot;common user:&quot;:username&#x3D;&quot;sysuser:&quot;;</span><br><span class="line">printf &quot;%s %-30s %d\n&quot;,username,$1,$3&#125;&#39; passwd</span><br></pre></td></tr></table></figure>
<p>正则表达式</p>
<ol>
<li>正则表达式的元字符包括：<br> <code>\ ^ $ . [] | ()  * + ?</code></li>
<li>一个基本的正则表达式包括以下几种：<br> 一个不是元字符的字符，例如A，这个正则表达式匹配的就是它本身；<br> 一个匹配特殊字符的转义字符：\t匹配一个制表符<br> 一个被引用的元字符，例如*，按字面意义匹配元字符<br> ^ 匹配一行的开始<br> $ 匹配一行的结束<br> . 匹配任意一个字符<br> 一个字符类:[ABC]匹配字符A、B或C<br> 字符类可能包能包含缩写格式：[A-Za-z]匹配单个字母<br> 一个互补的字符类:[^0-9] 匹配任意一个字符，但除了数字</li>
<li><p>运算符组合起来使用<br> 选择：A|B 匹配A或B<br> 拼接：AB匹配后面紧跟着B的A<br> 闭包：A*匹配0个或多个A<br> 正必包：A+匹配一个或多个A<br> 零或一：A？匹配空字符串或A<br> 括号：被(r)匹配的字符串，与r所匹配的字符串相同</p>
</li>
<li><p>优先级<br> 选择运算符|优先级最低，然后是拼接运算，最后是重复运算+，*与？；</p>
</li>
<li>转义序列    </li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">序列</th>
<th style="text-align:center">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">\b</td>
<td style="text-align:center">退格</td>
</tr>
<tr>
<td style="text-align:center">\f</td>
<td style="text-align:center">换页</td>
</tr>
<tr>
<td style="text-align:center">\n</td>
<td style="text-align:center">换行</td>
</tr>
<tr>
<td style="text-align:center">\r</td>
<td style="text-align:center">回车</td>
</tr>
<tr>
<td style="text-align:center">\t</td>
<td style="text-align:center">制表符</td>
</tr>
<tr>
<td style="text-align:center">\ddd</td>
<td style="text-align:center">八进制数ddd.ddd含有1到3个数字，每个数字的值在0-7之间</td>
</tr>
<tr>
<td style="text-align:center">\c</td>
<td style="text-align:center">其他字面意义上的c（如\表示,”表示双引号）</td>
</tr>
</tbody>
</table>
<p>###示例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">^[^^] 匹配不以脱字符开始的字符串</span><br><span class="line">&#x2F;^[0-9]+$&#x2F; 匹配含有且只含有数字的输入行</span><br><span class="line">&#x2F;^[0-9][0-9][0-9]$&#x2F; 输入行有且仅有 3 个数字.</span><br><span class="line">&#x2F;^(\+|-)?[0-9]+\.?[0-9]*$&#x2F; 十进制小数, 符号与小数部分是可选的.</span><br><span class="line">&#x2F;^[+-]?[0-9]+[.]?[0-9]*$&#x2F; 也是匹配十进制小数, 带有可选的符号与小数部分.</span><br><span class="line">&#x2F;^[+-]?([0-9]+[.]?[0-9]*|[.][0-9]+)([eE][+-]?[0-9]+)?$&#x2F; 浮点数, 符号与指数部分是可选的.</span><br><span class="line">&#x2F;^[A-Za-z][A-Za-z0-9]*$&#x2F; 一个字母, 后面再跟着任意多个字母或数字 (比如awk的变量名).</span><br><span class="line">&#x2F;^[A-Za-z]$|^[A-Za-z][0-9]$&#x2F; 一个字母, 又或者是一个后面跟着一个数字的字母 (比如 Basic 的变量名).</span><br><span class="line">&#x2F;^[A-Za-z][0-9]?$&#x2F; 同样是一个字母, 又或者是一个后面跟着一个数字的字母</span><br></pre></td></tr></table></figure>
<h3 id="awk-PATTERN"><a href="#awk-PATTERN" class="headerlink" title="awk PATTERN"></a>awk PATTERN</h3><ul>
<li>PATTERN: 根据pattern条件，过滤匹配的行，再做处理<br>  (1) 如果未指定：空模式，匹配每一行<br>  (2) /regular expression/ ：仅处理能够模式匹配到的行，需要用/ / 括起来<pre><code>awk &apos;/^UUID/&#123;print $1&#125;&apos; /etc/fstab
awk &apos;!/^UUID/&#123;print $1&#125;&apos; /etc/fstab
</code></pre>  (3) relational expression: 关系表达式，结果为“真”才会被处理<pre><code>真：结果为非0值，非空字符串
假：结果为空字符串或0值
</code></pre></li>
</ul>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;i&#x3D;1;j&#x3D;1&#123;print i,j&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk ‘!0’ &#x2F;etc&#x2F;passwd ; awk ‘!1’ &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk –F: &#39;$3&gt;&#x3D;1000&#123;print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;$3&lt;1000&#123;print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;$NF&#x3D;&#x3D;&quot;&#x2F;bin&#x2F;bash&quot;&#123;print $1,$NF&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;$NF ~ &#x2F;bash$&#x2F;&#123;print $1,$NF&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>(4) line ranges：行范围</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">startline,endline</span><br><span class="line">        &#x2F;pat1&#x2F;,&#x2F;pat2&#x2F;</span><br><span class="line"># awk -F: &#39;&#x2F;^root\&gt;&#x2F;,&#x2F;^nobody\&gt;&#x2F;&#123;print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">注意：不支持直接给出数字格式</span><br><span class="line"># awk -F: &#39;(NR&gt;&#x3D;10&amp;&amp;NR&lt;&#x3D;20)&#123;print NR,$1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p>(5) BEGIN/END 模式<br>        BEGIN{}:     仅在开始处理文件中的文本之前执行一次<br>        END{}：    仅在文本处理完成之后执行一次</p>
<p>示例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F : &#39;BEGIN &#123;print &quot;USER USERID&quot;&#125; &#123;print $1&quot;:&quot;$3&#125; END&#123;print &quot;end file&quot;&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F : &#39;&#123;print &quot;USER USERID“;print $1&quot;:&quot;$3&#125; END&#123;print &quot;end file&quot;&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;BEGIN&#123;print &quot; USER UID \n--------------- &quot;&#125;&#123;print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line"># awk -F: &#39;BEGIN&#123;print &quot; USER UID \n--------------- &quot;&#125;&#123;print $1,$3&#125;&#39;END&#123;print &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;&#125; &#x2F;etc&#x2F;passwd </span><br><span class="line">#  seq 10 |awk ‘i&#x3D;0’</span><br><span class="line"># seq 10 |awk ‘i&#x3D;1’</span><br><span class="line"># seq 10 | awk &#39;i&#x3D;!i‘</span><br><span class="line"># seq 10 | awk &#39;&#123;i&#x3D;!i;print i&#125;‘</span><br><span class="line"># seq 10 | awk ‘!(i&#x3D;!i)’</span><br><span class="line"># seq 10 |awk -v i&#x3D;1 &#39;i&#x3D;!i&#39;</span><br></pre></td></tr></table></figure>
<h3 id="模式总结"><a href="#模式总结" class="headerlink" title="模式总结"></a>模式总结</h3><table>
<thead>
<tr>
<th style="text-align:center">模式</th>
<th style="text-align:center">例子</th>
<th style="text-align:center">匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">BEGIN</td>
<td style="text-align:center">BEGIN</td>
<td style="text-align:center">输入被读取之前</td>
</tr>
<tr>
<td style="text-align:center">END</td>
<td style="text-align:center">END</td>
<td style="text-align:center">所有输入被读取之后</td>
</tr>
<tr>
<td style="text-align:center">expression</td>
<td style="text-align:center">$3&gt;100</td>
<td style="text-align:center">第三个字段大于100</td>
</tr>
<tr>
<td style="text-align:center">string-matching</td>
<td style="text-align:center">/Asia/</td>
<td style="text-align:center">含有Asia的行</td>
</tr>
<tr>
<td style="text-align:center">compound</td>
<td style="text-align:center">$3&lt;100 &amp;&amp; $4 ==”Asia”</td>
<td style="text-align:center">第三个字段小于100且第四个字段含有Asia的行</td>
</tr>
<tr>
<td style="text-align:center">range</td>
<td style="text-align:center">NR == 10,NR==20</td>
<td style="text-align:center">输入的第10行到20行</td>
</tr>
</tbody>
</table>
<h3 id="awk-action"><a href="#awk-action" class="headerlink" title="awk action"></a>awk action</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">常用的action分类</span><br><span class="line">    (1) Expressions: 算术，比较表达式等</span><br><span class="line">    (2) Control statements：if,while等</span><br><span class="line">    (3) Compound statements：组合语句</span><br><span class="line">    (4) input statements</span><br><span class="line">    (5) output statements：print等</span><br></pre></td></tr></table></figure>
<h3 id="awk控制语句"><a href="#awk控制语句" class="headerlink" title="awk控制语句"></a>awk控制语句</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123; statements;… &#125;  组合语句</span><br><span class="line">    if(condition) &#123;statements;…&#125;</span><br><span class="line">    if(condition) &#123;statements;…&#125; else &#123;statements;…&#125;</span><br><span class="line">    while(conditon) &#123;statments;…&#125;</span><br><span class="line">    do &#123;statements;…&#125; while(condition)</span><br><span class="line">    for(expr1;expr2;expr3) &#123;statements;…&#125;</span><br><span class="line">    break</span><br><span class="line">    continue</span><br><span class="line">    next 开始输入主循环的下一次迭代</span><br><span class="line">    delete array[index]</span><br><span class="line">    delete array</span><br><span class="line">        exit</span><br><span class="line">    exit expression 马上执行END 动作; 如果已经在END动作内, 那就退出程序. 将expression作为程序的退出状态返回.</span><br></pre></td></tr></table></figure>
<h3 id="if-else"><a href="#if-else" class="headerlink" title="if-else"></a>if-else</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">语法：</span><br><span class="line">       if(condition)&#123;statement;…&#125;[else statement]</span><br><span class="line">       if(condition1)&#123;statement1&#125;else if(condition2)&#123;statement2&#125;</span><br><span class="line">           else&#123;statement3&#125;</span><br><span class="line">   使用场景：对awk取得的整行或某个字段做条件判断</span><br><span class="line">   示例：</span><br><span class="line">   # awk -F: &#39;&#123;if($3&gt;&#x3D;1000)print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">   # awk -F: &#39;&#123;if($NF&#x3D;&#x3D;&quot;&#x2F;bin&#x2F;bash&quot;) print $1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">   # awk &#39;&#123;if(NF&gt;5) print $0&#125;&#39; &#x2F;etc&#x2F;fstab</span><br><span class="line">   # awk -F: &#39;&#123;if($3&gt;&#x3D;1000) &#123;printf &quot;Common user: %s\n&quot;,$1&#125; else &#123;printf &quot;root or Sysuser: %s\n&quot;,$1&#125;&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">   # awk -F: &#39;&#123;if($3&gt;&#x3D;1000) printf &quot;Common user: %s\n&quot;,$1;</span><br><span class="line">           else printf &quot;root or Sysuser: %s\n&quot;,$1&#125;&#39; &#x2F;etc&#x2F;passwd</span><br><span class="line">       df -h|awk -F% &#39;&#x2F;^\&#x2F;dev&#x2F;&#123;print $1&#125;&#39;|awk &#39;$NF&gt;&#x3D;80&#123;print $1,$5&#125;‘</span><br><span class="line">   # awk &#39;BEGIN&#123; test&#x3D;100;if(test&gt;90)&#123;print &quot;very good&quot;&#125;</span><br><span class="line">           else if(test&gt;60)&#123; print &quot;good&quot;&#125;else&#123;print &quot;no pass&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">语法：</span><br><span class="line">        while(condition)&#123;statement;…&#125;</span><br><span class="line">    条件“真”，进入循环；条件“假”， 退出循环</span><br><span class="line">    使用场景：</span><br><span class="line">        对一行内的多个字段逐一类似处理时使用</span><br><span class="line">        对数组中的各元素逐一处理时使用</span><br><span class="line">    示例：</span><br><span class="line">        awk &#39;&#x2F;^[[:space:]]*linux16&#x2F;&#123;i&#x3D;1;while(i&lt;&#x3D;NF) &#123;print $i,length($i); i++&#125;&#125;&#39; &#x2F;etc&#x2F;grub2.cfg</span><br></pre></td></tr></table></figure>
<h3 id="do-while循环"><a href="#do-while循环" class="headerlink" title="do-while循环"></a>do-while循环</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">语法：</span><br><span class="line">        do &#123;statement;…&#125;while(condition)</span><br><span class="line">        意义：无论真假，至少执行一次循环体</span><br><span class="line">    示例：</span><br><span class="line">    # awk &#39;BEGIN&#123; total&#x3D;0;i&#x3D;0;do&#123; total+&#x3D;i;i++;&#125;while(i&lt;&#x3D;100);print total&#125;&#39;</span><br><span class="line">    思考：下面两语句有何不同？</span><br><span class="line">    # awk &#39;BEGIN&#123;i&#x3D;0;print ++i,i&#125;&#39;</span><br><span class="line">   # awk &#39;BEGIN&#123;i&#x3D;0;print i++,i&#125;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">语法：</span><br><span class="line">        for(expr1;expr2;expr3) &#123;statement;…&#125;</span><br><span class="line">    常见用法：</span><br><span class="line">        for(variable assignment;condition;iteration process) </span><br><span class="line">            &#123;for-body&#125;</span><br><span class="line">    特殊用法：能够遍历数组中的元素</span><br><span class="line">        语法：for(var in array) &#123;for-body&#125;</span><br><span class="line">    示例：</span><br><span class="line">        awk &#39;&#x2F;^[[:space:]]*linux16&#x2F;&#123;for(i&#x3D;1;i&lt;&#x3D;NF;i++) &#123;print $i,length($i)&#125;&#125;&#39; &#x2F;etc&#x2F;grub2.cfg</span><br><span class="line">空语句     </span><br><span class="line">单独一个分号表示一个空语句</span><br><span class="line">  </span><br><span class="line">    在下面这个程序里, for的循环体是一个空语句.</span><br><span class="line">        BEGIN &#123; FS &#x3D; &quot;\t&quot; &#125;</span><br><span class="line">            &#123; for (i &#x3D; 1; i &lt;&#x3D; NF &amp;&amp; $i !&#x3D; &quot;&quot;; i++);</span><br><span class="line">                if (i &lt;&#x3D; NF)</span><br><span class="line">                    print</span><br><span class="line">            &#125;</span><br><span class="line">    这个程序打印所有的, 包含空字段的行.</span><br></pre></td></tr></table></figure>
<h3 id="循环性能比较"><a href="#循环性能比较" class="headerlink" title="循环性能比较"></a>循环性能比较</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">time (awk &#39;BEGIN&#123;total&#x3D;0;for(i&#x3D;0;i&lt;&#x3D;10000;i++)&#123;total+&#x3D;i;&#125;;print total;&#125;&#39;)</span><br><span class="line">time(total&#x3D;0;for i in &#123;1..10000&#125;;do total&#x3D;$(($total+i));done;echo $total)</span><br><span class="line">time(for ((i&#x3D;0;i&lt;&#x3D;10000;i++));do let total+&#x3D;i;done;echo $total)</span><br><span class="line">time(seq -s ”+” 10000|bc)</span><br></pre></td></tr></table></figure>
<h3 id="switch语句"><a href="#switch语句" class="headerlink" title="switch语句"></a>switch语句</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">语法：</span><br><span class="line">        switch(expression) &#123;case VALUE1 or &#x2F;REGEXP&#x2F;: statement1; case VALUE2 or &#x2F;REGEXP2&#x2F;: statement2; ...; default: statementn&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>break 和continue </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk ‘BEGIN&#123;sum&#x3D;0;for(i&#x3D;1;i&lt;&#x3D;100;i++) &#123;if(i%2&#x3D;&#x3D;0)continue;sum+&#x3D;i&#125;print sum&#125;‘</span><br><span class="line"># awk ‘BEGIN&#123;sum&#x3D;0;for(i&#x3D;1;i&lt;&#x3D;100;i++) &#123;if(i&#x3D;&#x3D;66)break;sum+&#x3D;i&#125;print sum&#125;‘</span><br></pre></td></tr></table></figure>
<ul>
<li>break [n]</li>
<li>continue [n]</li>
<li>next:提前结束对本行处理而直接进入下一行处理（awk自身循环）      </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk -F: &#39;&#123;if($3%2!&#x3D;0) next; print $1,$3&#125;&#39; &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="awk数组"><a href="#awk数组" class="headerlink" title="awk数组"></a>awk数组</h3><ul>
<li>关联数组：array[index-expression]<pre><code>index-expression:
(1)可使用任意字符串；字符串要使用双引号括起来
(2)如果某数组元素事先不存在，在引用时，awk会自动创建此元素，并将其值初始化为“空串”
若要判断数组中是否存在某元素，要使用“index in array”格式进行遍历
</code></pre>示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">weekdays[“mon”]&#x3D;&quot;Monday“</span><br><span class="line"># awk &#39;BEGIN&#123;weekdays[&quot;mon&quot;]&#x3D;&quot;Monday&quot;;weekdays[&quot;tue&quot;]&#x3D;&quot;Tuesday&quot;;print weekdays[&quot;mon&quot;]&#125;&#39;&#39;</span><br><span class="line"># awk &#39;BEGIN&#123;weekdays[&quot;mon&quot;]&#x3D;&quot;Monday&quot;;weekdays[&quot;tue&quot;]&#x3D;&quot;tuesday&quot;;for(i in weekdays) print weekdays[i]&#125;&#39;    </span><br><span class="line"># awk ‘!arr[$0]++’ dupfile   重复的行只显示一次</span><br><span class="line"># awk &#39;&#123;!arr[$0]++;print $0, arr[$0]&#125;&#39; dupfile   </span><br></pre></td></tr></table></figure>
<ul>
<li>若要遍历数组中的每个元素，要使用for循环<br>  for(var in array) {for-body}<br>  注意：var会遍历array的每个索引<br>示例：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># awk &#39;BEGIN&#123;weekdays[&quot;mon&quot;]&#x3D;&quot;Monday&quot;;weekdays[&quot;tue&quot;] &#x3D;&quot;Tuesday&quot;;for(i in weekdays) &#123;print weekdays[i]&#125;&#125;&#39;</span><br><span class="line">#  netstat -tan | awk &#39;&#x2F;^tcp&#x2F;&#123;state[$NF]++&#125;END &#123;for(i in state) &#123; print i,state[i]&#125;&#125;&#39;</span><br><span class="line"># awk &#39;&#123;ip[$1]++&#125;END&#123;for(i in ip) &#123;print i,ip[i]&#125;&#125;&#39; &#x2F;var&#x2F;log&#x2F;httpd</span><br><span class="line">&#x2F;access_log</span><br></pre></td></tr></table></figure>
<h3 id="awk函数"><a href="#awk函数" class="headerlink" title="awk函数"></a>awk函数</h3><p>数值处理:<br>rand()：返回0和1之间一个随机数<br>        awk ‘BEGIN{rand(); for (i=1;i&lt;=10;i++)print int(rand()*100) }’</p>
<h3 id="内建算术函数"><a href="#内建算术函数" class="headerlink" title="内建算术函数"></a>内建算术函数</h3><table>
<thead>
<tr>
<th style="text-align:center">函数</th>
<th style="text-align:center">返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">atan2(y,x)</td>
<td style="text-align:center">y/x的反正切值, 定义域在 −π到π之间</td>
</tr>
<tr>
<td style="text-align:center">cos(x)</td>
<td style="text-align:center">x的余弦值, x以弧度为单位</td>
</tr>
<tr>
<td style="text-align:center">exp(x)</td>
<td style="text-align:center">x的指数函数,e x</td>
</tr>
<tr>
<td style="text-align:center">int(x)</td>
<td style="text-align:center">x的整数部分; 当x大于0时, 向 0取整</td>
</tr>
<tr>
<td style="text-align:center">log(x)</td>
<td style="text-align:center">x的自然对数(以e为底)</td>
</tr>
<tr>
<td style="text-align:center">rand()</td>
<td style="text-align:center">返回一个随机数r, 0 ≤ r &lt; 1</td>
</tr>
<tr>
<td style="text-align:center">sin(x)</td>
<td style="text-align:center">x的正弦值, x以弧度为单位.</td>
</tr>
<tr>
<td style="text-align:center">sqrt(x)</td>
<td style="text-align:center">x的方根</td>
</tr>
<tr>
<td style="text-align:center">srand(x)</td>
<td style="text-align:center">x是rand() 的新的随机数种子</td>
</tr>
</tbody>
</table>
<h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">格式：</span><br><span class="line">        function name ( parameter, parameter, ... ) &#123;</span><br><span class="line">            statements</span><br><span class="line">            return expression</span><br><span class="line">        &#125;</span><br><span class="line">    示例：</span><br><span class="line">        cat fun.awk</span><br><span class="line">            function max(v1,v2) &#123;</span><br><span class="line">                v1&gt;v2?var&#x3D;v1:var&#x3D;v2</span><br><span class="line">                         return var</span><br><span class="line">            &#125;</span><br><span class="line">            BEGIN&#123;a&#x3D;3;b&#x3D;2;print max(a,b)&#125;</span><br><span class="line">        awk -f fun.awk</span><br></pre></td></tr></table></figure>
<h3 id="awk中调用shell命令"><a href="#awk中调用shell命令" class="headerlink" title="awk中调用shell命令"></a>awk中调用shell命令</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">system命令</span><br><span class="line">空格是awk中的字符串连接符，如果system中需要使用awk中的变量可以使用空格分隔，或者说除了awk的变量外其他一律用&quot;&quot;引用起来。</span><br><span class="line"># awk BEGIN&#39;&#123;system(&quot;hostname&quot;) &#125;&#39;</span><br><span class="line"># awk &#39;BEGIN&#123;score&#x3D;100; system(&quot;echo your score is &quot; score) &#125;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="awk脚本"><a href="#awk脚本" class="headerlink" title="awk脚本"></a>awk脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">将awk程序写成脚本，直接调用或执行</span><br><span class="line">示例：</span><br><span class="line"># cat f1.awk</span><br><span class="line">&#123;if($3&gt;&#x3D;1000)print $1,$3&#125;</span><br><span class="line"># awk -F: -f f1.awk &#x2F;etc&#x2F;passwd</span><br><span class="line"># cat f2.awk</span><br><span class="line">    #!&#x2F;bin&#x2F;awk -f</span><br><span class="line">        #this is a awk script</span><br><span class="line">        &#123;if($3&gt;&#x3D;1000)print $1,$3&#125;</span><br><span class="line">#chmod +x f2.awk</span><br><span class="line">#  f2.awk -F: &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<h3 id="向awk脚本传递参数"><a href="#向awk脚本传递参数" class="headerlink" title="向awk脚本传递参数"></a>向awk脚本传递参数</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">格式：</span><br><span class="line">        awkfile var&#x3D;value var2&#x3D;value2... Inputfile</span><br><span class="line">    注意：在BEGIN过程中不可用。直到首行输入完成以后，变量才可用。可以通过-v参数，让awk在执行BEGIN之前得到变量的值。命令行中每一个指定的变量都需要一个-v参数</span><br></pre></td></tr></table></figure>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat test.awk</span><br><span class="line">            #!&#x2F;bin&#x2F;awk -f</span><br><span class="line">            &#123;if($3 &gt;&#x3D;min &amp;&amp; $3&lt;&#x3D;max)print $1,$3&#125;</span><br><span class="line">        chmod +x test.awk</span><br><span class="line"># test.awk -F: min&#x3D;100 max&#x3D;200 &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>redis 常用功能</title>
    <url>/2018/04/27/redis/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="redis-常用功能"><a href="#redis-常用功能" class="headerlink" title="redis 常用功能"></a>redis 常用功能</h1><p><img src="/images/redis_n1.jpg" class="lazyload" data-srcset="/images/redis_n1.jpg" srcset="data:image/png;base64,666" alt=""><br>KV cache and store<br>REmote DIctionary Server(远程字典服务器)<br>redis 运行都在内存中来实现，周期性的写入磁盘，来实现持久功能;</p>
<h2 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">KV cache and store</span><br><span class="line">    in-memory;</span><br><span class="line">    持久化 ;</span><br><span class="line">    主从(借助于sentinal实现一定意义上的HA);</span><br><span class="line">    Clustering(分布式);</span><br><span class="line">数据结构服务器:</span><br><span class="line">    String, List, Hash, Set, Sorted Set, Bitmap,HperLoglogs;</span><br><span class="line">Memcached 与 Redis的区别:</span><br><span class="line">    1、Memcached 是一个分布式的内存对象缓存系统;</span><br><span class="line">    2、Reis 可以实现持久存储的;</span><br><span class="line">    3、Mecached 是一个LUR 缓存，将过期数据清理出去;</span><br><span class="line">    4、Redis支持更多的数据类型;</span><br><span class="line">    5、Memcached 是多线程;</span><br><span class="line">    6、Redis是单线程;</span><br><span class="line">    7、二者的性能不相上下;</span><br><span class="line">Redis 3.0的LRU算法的改进:</span><br><span class="line">    预设随机取5个样本，插入并排序至一个pool， 移除最佳者，如此反复;</span><br><span class="line">    走到内存用理小于maxmemory的设定;</span><br><span class="line">    样本5比先前的3多;</span><br><span class="line">    从局部最优趋向全局最优;</span><br><span class="line">存储系统三类:</span><br><span class="line">    RDBMS</span><br><span class="line">    NoSQL:</span><br><span class="line">        KV NoSQL: redis</span><br><span class="line">        Column Family NoSQL: HBase</span><br><span class="line">        Documentation NoSQL: MongoDB</span><br><span class="line">        Graph NoSQL: Neo4j</span><br><span class="line">    NewSQL(支持分布式)</span><br><span class="line">Redis的组件:</span><br><span class="line">    redis.io(官方站点)</span><br></pre></td></tr></table></figure>
<h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-server</span><br><span class="line">redis-cli</span><br><span class="line">    Command line interface </span><br><span class="line">redis-benchmark</span><br><span class="line">    Benchmarking utility</span><br><span class="line">redis-check-dump &amp; redis-check-aof</span><br><span class="line">    Corrupted RDB&#x2F;AOF files utilities</span><br></pre></td></tr></table></figure>
<h2 id="Redis守护进程"><a href="#Redis守护进程" class="headerlink" title="Redis守护进程"></a>Redis守护进程</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;redis.conf</span><br><span class="line">监听6379端口;</span><br><span class="line">tcp-backlog 511 #是redis守护进程的等队列,当并发较高时，再找位置来缓存新请求;</span><br><span class="line">bind # 是指监听的地址;</span><br><span class="line">bind 127.0.0.1 172.16.55.128</span><br><span class="line">unixsocket &#x2F;tmp&#x2F;redis.sock # 当服务和redis在一台服务器上使用socket来通信，提高效率;</span><br><span class="line">unixsocketperm 700</span><br><span class="line">timeout #当一个客端连接多久后，认为超时，0表示禁用，认为一直存在;</span><br><span class="line">tcp-keepaoive 0</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &#x2F;var&#x2F;log&#x2F;redis&#x2F;redis.log</span><br><span class="line">databases 16  # 表示可以使用多少个数据库;</span><br><span class="line">save &lt;sencods&gt; &lt;changes&gt; # 如果多少秒发生多少变化则存储，因此这取决于业务模型;</span><br><span class="line">save &quot;&quot;   #这样写表示禁用redis持久化功能;</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes </span><br><span class="line">rdbcompression yes</span><br><span class="line">dbcheksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir &#x2F;var&#x2F;lib&#x2F;redis</span><br><span class="line"># 配置以为成为从服务器</span><br><span class="line">salveof   ip # 这里指定主服务器的ip即可;</span><br><span class="line">maxclients 100000</span><br><span class="line">appendonly yes # 开启appendonly 持久化功能;</span><br><span class="line">appendfsync  everysec # 是否使用fsync来持久化;</span><br><span class="line"># redis服务端的参数，大多可以在redis-cli连接到服务器后进行动态修复或修改的; </span><br></pre></td></tr></table></figure>
<h2 id="redis-cli-常用命令"><a href="#redis-cli-常用命令" class="headerlink" title="redis-cli 常用命令"></a>redis-cli 常用命令</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># redis-cli -p 25612 </span><br><span class="line">127.0.0.1:25612&gt; AUTH xxxxxxx</span><br><span class="line">127.0.0.1:25612&gt; HELP APPEND # help 用来查看帮助</span><br><span class="line">127.0.0.1:25612&gt; CLIENT LIST</span><br><span class="line">id&#x3D;3 addr&#x3D;127.0.0.1:25666 fd&#x3D;5 name&#x3D; age&#x3D;275 idle&#x3D;0 flags&#x3D;N db&#x3D;0 sub&#x3D;0 psub&#x3D;0 multi&#x3D;-1 qbuf&#x3D;0 qbuf-free&#x3D;32768 obl&#x3D;0 oll&#x3D;0 omem&#x3D;0 events&#x3D;r cmd&#x3D;client</span><br><span class="line">127.0.0.1:25612&gt; SELECT 1 # 第开第几个数据库，也可以理解成为名称空间;</span><br><span class="line">127.0.0.1:25612&gt; SELECT 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612[1]&gt; SET disto fedora</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612[1]&gt; GET disto</span><br><span class="line">&quot;fedora&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; SET disto centos</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612[1]&gt; STRLEN disto</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:25612[1]&gt; DECR count</span><br><span class="line">(integer) -1</span><br><span class="line">127.0.0.1:25612[1]&gt; DECR count</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:25612[1]&gt; DECR count</span><br><span class="line">(integer) -3</span><br><span class="line">127.0.0.1:25612[1]&gt; SET disto gentoo NX # 显示为未能执行的操作,该值不存在则设定;</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:25612[1]&gt; SET foo bar XX # 该值则在则设定;</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:25612[1]&gt; SADD w1 mon tue wed thu sat sun</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:25612[1]&gt; SADD w1 mon tue wed thu fre sat sun</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:25612[1]&gt; </span><br><span class="line">127.0.0.1:25612[1]&gt; SADD w2 tue thu day</span><br><span class="line">127.0.0.1:25612[1]&gt; ZADD weekday1 1 mon 2 tue 3 wed</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:25612[1]&gt; ZCARD weekday1</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:25612[1]&gt; ZRANK weekday1 tue</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:25612[1]&gt; ZRANK weekday1 mon</span><br><span class="line">(integer) 0</span><br><span class="line">    </span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:25612[1]&gt; SINTER w1 w2 # 求两个集合的交集;</span><br><span class="line">1) &quot;thu&quot;</span><br><span class="line">2) &quot;tue&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; SUNION w1 w2  # 求两个集合的并集;</span><br><span class="line">1) &quot;sun&quot;</span><br><span class="line">2) &quot;wed&quot;</span><br><span class="line">3) &quot;sat&quot;</span><br><span class="line">4) &quot;day&quot;</span><br><span class="line">5) &quot;tue&quot;</span><br><span class="line">6) &quot;thu&quot;</span><br><span class="line">7) &quot;mon&quot;</span><br><span class="line">8) &quot;fre&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; SPOP w1 # 弹出一个元素 ;</span><br><span class="line">&quot;tue&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; SPOP w1</span><br><span class="line">&quot;sun&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; SISMEMBER w1 day # 表示已经没有这个元素;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:25612[1]&gt; SISMEMBER w1 sat</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:25612[1]&gt; ZRANGE weekday1 0 1</span><br><span class="line">1) &quot;mon&quot;</span><br><span class="line">2) &quot;tue&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; HSET h1 a mon</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:25612[1]&gt; HGET h1 a</span><br><span class="line">&quot;mon&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; HSET h1 b tue</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:25612[1]&gt; HGET h1 a </span><br><span class="line">&quot;mon&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; HGET h1 b </span><br><span class="line">&quot;tue&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; HVALS h1</span><br><span class="line">1) &quot;mon&quot;</span><br><span class="line">2) &quot;tue&quot;</span><br><span class="line">127.0.0.1:25612[1]&gt; HKEYS h1</span><br><span class="line">1) &quot;a&quot;</span><br><span class="line">2) &quot;b&quot;</span><br><span class="line">Strings: 字串</span><br><span class="line">    SET key value [EX #]  [NX|XX]</span><br><span class="line">    GET</span><br><span class="line">    INCR</span><br><span class="line">    DECR</span><br><span class="line">    EXIST</span><br><span class="line">Lists: 列表</span><br><span class="line">    LPUSH</span><br><span class="line">    RPUSH</span><br><span class="line">    LDROP</span><br><span class="line">    RPOP</span><br><span class="line">    LINDEX</span><br><span class="line">    LSET</span><br><span class="line">Sets: 集合</span><br><span class="line">    SADD</span><br><span class="line">    SINTER</span><br><span class="line">    SUNTON</span><br><span class="line">    SPOP</span><br><span class="line">    SISMEMBER</span><br><span class="line">Sorted Sets 有序集合， 其命令都以Z开头</span><br><span class="line">    ZADD </span><br><span class="line">    ZRANGE</span><br><span class="line">    ZCARD</span><br><span class="line">    ZRANK</span><br><span class="line">Hashes： 一组关联数的集合</span><br><span class="line">    HSET</span><br><span class="line">    HSETNX</span><br><span class="line">    HGET </span><br><span class="line">    HKEYS</span><br><span class="line">    HVALS</span><br><span class="line">    HDEL</span><br></pre></td></tr></table></figure>
<h2 id="认证实现方法"><a href="#认证实现方法" class="headerlink" title="认证实现方法"></a>认证实现方法</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(1) redis.conf</span><br><span class="line">    requirepass PASSWORD</span><br><span class="line">(2) redis-cli</span><br><span class="line">    AUTH PASSWD</span><br></pre></td></tr></table></figure>
<h2 id="清空数据库"><a href="#清空数据库" class="headerlink" title="清空数据库"></a>清空数据库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># FLUSHDB:  清空当前库</span><br><span class="line"># FLUSHALL: 清空所有库</span><br></pre></td></tr></table></figure>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 通过MULTI, EXEC, WATCH等命令实现事务功能;</span><br><span class="line"># 将一个或多个命令归并为一个操作提请服务器按顺序执行的机制;</span><br><span class="line"># Redis数据不支持回滚操作;</span><br><span class="line"># MULTI: 启动一个事务，中间的所有命令会放置在队列中;</span><br><span class="line"># EXEC: 执行事务;</span><br><span class="line">#  一次性将事务中的所有操作执行完成后返回给客户端;</span><br><span class="line">127.0.0.1:25612&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612&gt; SET ip 172.16.55.123</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:25612&gt; GET ip </span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:25612&gt; SET port 8080</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:25612&gt; GET port </span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:25612&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) &quot;172.16.55.123&quot;</span><br><span class="line">3) OK</span><br><span class="line">4) &quot;8080&quot;</span><br><span class="line"># WATCH: 乐观锁， 在EXEC命令执行之间有用于监视指定数量键;</span><br><span class="line">    #如果监视中的某任意键数据被修改，则服务器拒绝执行事务;</span><br><span class="line"># 打开两个终端</span><br><span class="line">term1</span><br><span class="line">127.0.0.1:25612&gt; WATCH ip</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612&gt; SET ip 10.0.0.1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:25612&gt; GET ip</span><br><span class="line">QUEUED</span><br><span class="line">term2 </span><br><span class="line">127.0.0.1:25612&gt; GET ip </span><br><span class="line">&quot;172.16.55.123&quot;</span><br><span class="line">127.0.0.1:25612&gt; SET ip 172.16.55.123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612&gt; GET ip </span><br><span class="line">&quot;172.16.55.123&quot;</span><br><span class="line">term1</span><br><span class="line">127.0.0.1:25612&gt; EXEC</span><br><span class="line">(nil)</span><br><span class="line"># 监控的一个键，EXEC之前键发生了改动，EXEC将拒绝提交;</span><br></pre></td></tr></table></figure>
<h2 id="Connection相关的命令"><a href="#Connection相关的命令" class="headerlink" title="Connection相关的命令:"></a>Connection相关的命令:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AUTH</span><br><span class="line">127.0.0.1:25612&gt; HELP PING </span><br><span class="line"></span><br><span class="line">  PING [message]</span><br><span class="line">  summary: Ping the server</span><br><span class="line">  since: 1.0.0</span><br><span class="line">  group: connection</span><br><span class="line"></span><br><span class="line">127.0.0.1:25612&gt; PING</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:25612&gt; ECHO &quot;hello redis&quot;</span><br><span class="line">&quot;hello redis&quot;</span><br><span class="line">127.0.0.1:25612&gt; </span><br><span class="line">QUIT</span><br><span class="line">127.0.0.1:25612&gt; HELP @connection</span><br></pre></td></tr></table></figure>
<h2 id="Server相关的命令"><a href="#Server相关的命令" class="headerlink" title="Server相关的命令"></a>Server相关的命令</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CLIENT GETNAME</span><br><span class="line">CLIENT KILL ip:port</span><br><span class="line">127.0.0.1:25612&gt; CLIENT SETNAME localconn</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:25612&gt; CLIENT GETNAME</span><br><span class="line">&quot;localconn&quot;</span><br><span class="line">127.0.0.1:25612&gt; HELP INFO # 获取当前服务器的状态及信息;</span><br><span class="line">  INFO [section]</span><br><span class="line">  summary: Get information and statistics about the server</span><br><span class="line">  since: 1.0.0</span><br><span class="line">  group: server</span><br><span class="line">127.0.0.1:25612&gt; INFO CPU</span><br><span class="line"># CPU</span><br><span class="line">used_cpu_sys:474.20</span><br><span class="line">used_cpu_user:258.88</span><br><span class="line">used_cpu_sys_children:0.01</span><br><span class="line">used_cpu_user_children:0.00</span><br><span class="line">CONFIG RESETSTAT</span><br><span class="line">CONFIG SET PARAMETER value</span><br><span class="line">CONFIG REWRITE </span><br><span class="line">DBSIZE</span><br><span class="line"># 跟持久化相关的数据 </span><br><span class="line">BGSAVE </span><br><span class="line">SAVE</span><br><span class="line">LASTSAVE</span><br><span class="line">monitor # 实时监控对数据的请求</span><br><span class="line">SHUTDOWN SAVE #将数据安全的同步到磁盘后关闭redis-server </span><br></pre></td></tr></table></figure>
<h2 id="redis-发布与订阅功能-publish-subscribe"><a href="#redis-发布与订阅功能-publish-subscribe" class="headerlink" title="redis 发布与订阅功能(publish/subscribe)"></a>redis 发布与订阅功能(publish/subscribe)</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 频道: 消息队列</span><br><span class="line"># SUBSCRIBE: 订阅一个或多个队列;</span><br><span class="line"># PUBLISH: 向频道发布消息;</span><br><span class="line"># UNSUBSCRIBE: 退订此前订阅的频道;</span><br><span class="line"># PSUBSCRIBE: 模式订阅;</span><br><span class="line"># term1 中开始一个频道; </span><br><span class="line">127.0.0.1:25612&gt; SUBSCRIBE news</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;news&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line"></span><br><span class="line"># term2 中向一个频道中发布消息;</span><br><span class="line">127.0.0.1:25612&gt; PUBLISH news &quot;hello renjin&quot;</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"># term1 中可以收到消息;</span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;news&quot;</span><br><span class="line">3) &quot;hello renjin&quot;</span><br><span class="line"></span><br><span class="line"># term1 中使用扩展模式开启两个频道;</span><br><span class="line">127.0.0.1:25612&gt; PSUBSCRIBE &quot;rj.i[to]&quot;</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;psubscribe&quot;</span><br><span class="line">2) &quot;rj.i[to]&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line"></span><br><span class="line"># term2 中向两个频道发布消息;</span><br><span class="line">127.0.0.1:25612&gt; PUBLISH rj.io &quot;hello RenJin&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:25612&gt; PUBLISH rj.it &quot;hello SSJinYao&quot;</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"># term1 中可以收到两条消息;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;rj.i[to]&quot;</span><br><span class="line">3) &quot;rj.io&quot;</span><br><span class="line">4) &quot;hello RenJin&quot;</span><br><span class="line">1) &quot;pmessage&quot;</span><br><span class="line">2) &quot;rj.i[to]&quot;</span><br><span class="line">3) &quot;rj.it&quot;</span><br><span class="line">4) &quot;hello SSJinYao&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Redis-的持久化"><a href="#Redis-的持久化" class="headerlink" title="Redis 的持久化:"></a>Redis 的持久化:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 提供了RDB和AOF两种机制;</span><br><span class="line">    RDB: snapshot: 二进制格式; 按事先定制的策略，周期性地将数据保存至磁盘:数据文件默认为dump.rdb;</span><br><span class="line">        客户端 也可以使用SAVE或BGSAVE命令启快照保存机制;</span><br><span class="line">            SAVE：同步,在主线程中保存快照; 此时会阻塞所有客户端请求;</span><br><span class="line">            BGSAVE: 异步，</span><br><span class="line">    AOF:Aappend Only Fil</span><br><span class="line">        记录每一次写操作至指定 的文件尾部实现持久化; 当redis重启时，可通过重新执行文件中的命令在内存重建数据库;</span><br><span class="line">        BGREWRITEAOF: AOF文件重写:</span><br><span class="line">            不会读取正在使用的AOF文件，而通过将内存中的数据以命令的方式保存到临时文件中，完之后替换原来的AOF文件;</span><br><span class="line">    RDB:默认保存策略，取决于磁盘IO能力，与客户端对redis的读写;</span><br><span class="line">        SAVE 900 1 </span><br><span class="line">        SAVE 300 10</span><br><span class="line">        SAVE 60 1000 </span><br><span class="line">stop-writes-on-bgsave-error yes  # 在进行快照备份时，监控到持久化发现错误时，是否停止下来; 会报告一个访问错误;</span><br><span class="line">rdbcompression yes # 是否采用压缩来节省使有空间，当然消耗cpu使用周期;</span><br><span class="line">rdbchecksum yes  # 是否对rdb做校验码操作;</span><br><span class="line">dbfilename dump.rdb # 指明文件名;</span><br><span class="line">dir &#x2F;var&#x2F;lib&#x2F;redis #指明保存文件的位置;</span><br><span class="line">127.0.0.1:25612&gt; CONFIG GET dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;&#x2F;var&#x2F;lib&#x2F;redis&quot;            </span><br><span class="line"></span><br><span class="line">AOF:</span><br><span class="line">    重写过程:</span><br><span class="line">        (1) redis 主进程通过fork创建子进程;</span><br><span class="line">        (2) 子进程根据redis内存中的数据创建数据库重建命令序列于临时文件中;</span><br><span class="line">        (3) 父进程继承client的请求时，并会把这些请求中的写操作继续追加至原来的AOF文件;</span><br><span class="line">            额外地，这些新的写请求还会被放置于一个缓冲队列中;</span><br><span class="line">        (4) 子进程重写完成，会通知父进程，父进程把缓冲中的命令写到临时文件中;</span><br><span class="line">        (5) 父进程用临时文件替换老的aof文件;</span><br><span class="line">        </span><br><span class="line">        appenonly no #没有开启AOF 功能;</span><br><span class="line">        appendfilename &quot;appendonly.aof&quot; # 文件名</span><br><span class="line">        appendfsync eversec  # 每秒中写一次</span><br><span class="line">        no-appedfsync-no-rewrite no #  对新的操作不做fsync，而是放在缓存队列中的;</span><br><span class="line">        auto-aof-rewrite-percentage 100 # 当前afo 文件是上次的两倍时，再重新触发重写操作;</span><br><span class="line">                auto-aof-rewrite-min-size 64mb # </span><br><span class="line">127.0.0.1:25612&gt; CONFIG SET appendonly yes</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># 注意: 持久本身不能取代备份: 还应该制定备份策略,对redis数据库进行定期备份;</span><br><span class="line"># RDB与AOF同时启用:</span><br><span class="line">    (1) BGSAVE和BGREWRITEAOF 不会同是执行;</span><br><span class="line">    (2) 在Redis服务器启用于恢复数据时，会优先使用AOF;</span><br></pre></td></tr></table></figure>
<h2 id="Redis复制"><a href="#Redis复制" class="headerlink" title="Redis复制:"></a>Redis复制:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">特点:</span><br><span class="line">    一个Master 可以有多个Slave;</span><br><span class="line">    支持链式复制;</span><br><span class="line">        Master以非阻塞方式同步数据至slave; 注:主服务器不建议关闭持久化;</span><br><span class="line">slave:</span><br><span class="line">    &gt; SLAVEOF MASTER_IP MASTER_PORT</span><br><span class="line">    min-salves-to-write 3  # 至少应该有三个从节点，小于三个，禁止主服务器写操作;</span><br><span class="line">    min-salves-max-lag # 从服务器必需不能滞后于服务器10秒以上;</span><br><span class="line">注意: 如果master使用requirespass开启了认证功能，从服务器要使用masterauth &lt;PASSWORD&gt;;</span><br><span class="line">    来连入服务请求使用此密码进行认证;</span><br><span class="line">    </span><br><span class="line">sentinal: 万一主服务器岩了，那么它会从从服务器节点中选则一台服务器成为主节点;</span><br><span class="line">    万sentinal 故障，或者连接不上主节点时，需要sentinal配置多个节点;</span><br></pre></td></tr></table></figure>
<h2 id="sentinel"><a href="#sentinel" class="headerlink" title="sentinel:"></a>sentinel:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用于管理多个redis服务实现HA;</span><br><span class="line">    监控;</span><br><span class="line">    通知;</span><br><span class="line">    自动故障转移;</span><br><span class="line">    本质上，sentinel也是redis的分布式功能;</span><br><span class="line">    使用流言协议、投票协议;</span><br><span class="line">程序:</span><br><span class="line">    redis-sentinel &#x2F;path&#x2F;to&#x2F;file.conf</span><br><span class="line">    redis-server &#x2F;path&#x2F;to&#x2F;file.conf</span><br><span class="line">(1) 服务器自身初始化，运行redis-server中专用于sentinel功能的代码;</span><br><span class="line">(2) 初始化sentinel状态，根据给定的配置文件，初始化监控的master服务器列表;</span><br><span class="line">(3) 创建连向master的连接；</span><br><span class="line">专用配置文件: &#x2F;etc&#x2F;redis-sentinel.conf</span><br><span class="line">(1) # sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br><span class="line">    sentinel monitor mymaster  127.0.0.1 6379 2</span><br><span class="line">(2) # sentinel down-after-millisenconds &lt;master-name&gt; &lt;millisends&gt;</span><br><span class="line">    sentinel down-afer-millisenconds mymaster 3000</span><br><span class="line">(3) # sentinel parellel-syncs  &lt;master-name&gt; &lt;numslaves&gt;</span><br><span class="line">    seninel parallel-syncs mymaster 1 </span><br><span class="line">(4) # sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line">    sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line">主观下线,客观下线:</span><br><span class="line">    主观下线: 一个sentinel实例判断出某节点下线:</span><br><span class="line">    客观下线:多个seninel 节点协商后判断出某节点下线:</span><br><span class="line"></span><br><span class="line">专用命令:</span><br><span class="line">    SENTINEL masters</span><br><span class="line">    SENTINEL slaves &lt;master name&gt;</span><br><span class="line">    SENTINEL get-master-addr-by-name &lt;master name&gt;</span><br><span class="line">    SENTINEL reset</span><br><span class="line">    SENTINEL failover &lt;master name&gt;</span><br><span class="line"></span><br><span class="line">Clustering:</span><br><span class="line">    分布式数据库，通过分片机制进行数据分布，clustering内的每个子节点仅数据库的一部分数据;    </span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx的常用架构</title>
    <url>/2018/04/26/nginx%E5%B8%B8%E7%94%A8%E6%9E%B6%E6%9E%84/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="Nginx-常用架构"><a href="#Nginx-常用架构" class="headerlink" title="Nginx 常用架构"></a>Nginx 常用架构</h1><p><img src="/images/nginx_001.png" class="lazyload" data-srcset="/images/nginx_001.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="LB-Cluster"><a href="#LB-Cluster" class="headerlink" title="LB Cluster"></a>LB Cluster</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">提升系统容量的方式:</span><br><span class="line">    scale up:</span><br><span class="line">    scale out:</span><br><span class="line"></span><br><span class="line">session保持方法:</span><br><span class="line">    session绑定:sh</span><br><span class="line">    session复制:</span><br><span class="line">    session服务器: memchached redis (key-value,kv store)</span><br><span class="line">    对url 做hash 计算后，做为key</span><br><span class="line">    对url 对应的内容做为value</span><br></pre></td></tr></table></figure>
<h2 id="I-O："><a href="#I-O：" class="headerlink" title="I/O："></a>I/O：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">同步&#x2F;异步:被调用者，在收到调用请求后，是否立即返回。还是得到最终结果后才返回； </span><br><span class="line">阻塞&#x2F;非阻塞:调用者发起调用之后，在收到响应结果之前，是否会被挂起，被挂起，被称为阻塞，非挂起为非阻塞;</span><br><span class="line">I&#x2F;O网络编程模型中，常用网络模型有5种;</span><br><span class="line">1、同步阻塞 </span><br><span class="line">2、同步非阻塞</span><br><span class="line">3、复用型I&#x2F;O</span><br><span class="line">4、(Event Driver) 事件驱动</span><br><span class="line">5、异步I&#x2F;O</span><br><span class="line"></span><br><span class="line">libevent: 项目</span><br><span class="line">    epoll()</span><br><span class="line">可以对nginx进程对CPU的核心数来进行绑定;</span><br><span class="line">LRU:最近最少缓存条目算法;</span><br><span class="line">平滑升级，平滑故障处理，或者灰度发布;</span><br><span class="line">对于web服务器来说，日志至关重要，需要对日志进行分析;</span><br><span class="line">CacheManager: 缓存的失效，过期检验及清理操作;</span><br></pre></td></tr></table></figure>
<h2 id="Nginx-配置"><a href="#Nginx-配置" class="headerlink" title="Nginx 配置"></a>Nginx 配置</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">main, event, http 基于c语言风格；</span><br><span class="line"></span><br><span class="line">httpd&#123; </span><br><span class="line">    drective</span><br><span class="line">    server&#123;</span><br><span class="line">        listen</span><br><span class="line">        server_name</span><br><span class="line">        location&#123;</span><br><span class="line">            if &#123;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> server &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="nginx-的安装包"><a href="#nginx-的安装包" class="headerlink" title="nginx 的安装包"></a>nginx 的安装包</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 这里采用的采用的是阿里云的epel源</span><br><span class="line"># cd &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo</span><br><span class="line">[epel]</span><br><span class="line">name&#x3D;Extra Packages for Enterprise Linux 7 - $basearch</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">failovermethod&#x3D;priority</span><br><span class="line">baseurl&#x3D;http:&#x2F;&#x2F;mirrors.cloud.aliyuncs.com&#x2F;epel&#x2F;7&#x2F;$basearch</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">gpgkey&#x3D;http:&#x2F;&#x2F;mirrors.cloud.aliyuncs.com&#x2F;epel&#x2F;RPM-GPG-KEY-EPEL-7</span><br><span class="line"># yum -y install nginx</span><br><span class="line"># rpm -q --scripts nginx # 查看nginx  的安装前脚本，卸载后脚本; </span><br></pre></td></tr></table></figure>
<h2 id="ngx-http-proxy-module-模块"><a href="#ngx-http-proxy-module-模块" class="headerlink" title="ngx_http_proxy_module 模块"></a>ngx_http_proxy_module 模块</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen</span><br><span class="line">    server_name</span><br><span class="line">    location &#x2F;&#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;172.16.55.180:80&#x2F;</span><br><span class="line">        proxy_set_header Host $host  # 设定请求报文的，Host首部，一般apache基于主机名解析的重要首部信息;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 请求到代理服务器的过程，Ningx把报文拆除，了解请求的内容是什么;</span><br><span class="line"># 于是Nginx需要重新构建请求报文 ，来送到的后端服务器;</span><br><span class="line"># cip（客户端 ip） --&gt; pip(代理ip) --&gt; lip(本地ip) --&gt; uip(后端服务器ip);</span><br><span class="line">http:&#x2F;&#x2F;www.ssjinyao.com</span><br><span class="line">http:&#x2F;&#x2F;mysql.ssjinyao.com</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在node1中配置一台httpd服务</span><br><span class="line"># echo &quot;&lt;h1&gt;node1&lt;&#x2F;h1&gt;&quot; &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br><span class="line"># systemctl start httpd </span><br><span class="line"># 在node2中 配置一台httpd 服务</span><br><span class="line">echo &quot;&lt;h1&gt;node2&lt;&#x2F;h1&gt;&quot; &gt; &#x2F;var&#x2F;www&#x2F;html&#x2F;index.html</span><br><span class="line"># systemctl start httpd </span><br><span class="line"></span><br><span class="line">格式:</span><br><span class="line">    localtion &#x2F;uri &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;back_server:port&#x2F;newuri;</span><br><span class="line">    &#125;</span><br><span class="line">    # 这样的配置 uri 将补到newuri的后面</span><br><span class="line">    location &#x2F;uri &#123;</span><br><span class="line">        rewrite http:&#x2F;&#x2F;back_server:port&#x2F;newuri</span><br><span class="line">        # proxy_pass http:&#x2F;&#x2F;back_server:port&#x2F;newuri </span><br><span class="line">    &#125;</span><br><span class="line">    # 这样的配置 uri 将重写到newuri   </span><br><span class="line">    &#x2F;uri --&gt; &#x2F;newuri</span><br><span class="line"># cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;</span><br><span class="line"># cp defalt.conf&#123;,.bak&#125;</span><br><span class="line"># vim default.conf</span><br><span class="line"></span><br><span class="line">server_name  www.ssjinyao.com;</span><br><span class="line">location &#x2F; </span><br><span class="line">    &#123;</span><br><span class="line">    proxy_ass http:&#x2F;&#x2F;172.16.55.128&#x2F;;</span><br><span class="line">    index index.htm index.html ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># systemctl restart nginx</span><br><span class="line"># tial -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在node2 apache 端进行编辑</span><br><span class="line"># mkdir &#x2F;var&#x2F;www&#x2F;html&#x2F;bbs</span><br><span class="line"># echo &quot;&lt;h1&gt; bbs on node2 &lt;&#x2F;h1&gt;&quot; &#x2F;var&#x2F;www&#x2F;html&#x2F;bbs&#x2F;index.html</span><br><span class="line"></span><br><span class="line"># 对应的在nginx 端</span><br><span class="line"></span><br><span class="line">location &#x2F;bbs&#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;172.16.55.128&#x2F;bbs&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"># nginx -t  or # sevice nginx configtest  </span><br><span class="line"># systemctl rsload nginx </span><br><span class="line"></span><br><span class="line"># 或者可以使用forum</span><br><span class="line">location &#x2F;forum&#x2F; &#123;</span><br><span class="line">    proxy_cache mycache;</span><br><span class="line">    proxy_cache_valid 200 1h;</span><br><span class="line">    proxy_cache_valid 301 302 10m;</span><br><span class="line">    proxy_cache_valid any 1m;</span><br><span class="line">    proxy_cache_use_statle error timeout invalid_header http_500 http_502 http_503 http504;  # 什么情况下使用过期缓存</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;172.16.55.128&#x2F;bbs&#x2F;;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">&#125;</span><br><span class="line"># nginx -t </span><br><span class="line"># systemctl reload nginx</span><br><span class="line"></span><br><span class="line">location ~* \.(jpg|png|gif)$ &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;172.16.55.128;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">&#125;</span><br><span class="line"># nginx -t </span><br><span class="line"># systemctl reload nginx </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 注意 在location 进行正则匹配的模式匹配时</span><br><span class="line"># proxy_pass 加http:&#x2F;&#x2F;172.16.55.128; 这个位置这后什么都不能带的，&#x2F; 也不能带的，否则会报语法错误; </span><br><span class="line"># apache 记录客户端请求的日志,向后端发送特定首部;</span><br><span class="line">需要在Logformat中加入 将第一个值 %h 换成%&#123;X-Real-IP&#125;i</span><br><span class="line"># systemctl restart httpd </span><br><span class="line"></span><br><span class="line"># 定义proxy缓存 </span><br><span class="line"># 在nginx httpd 段中配置cache path;</span><br><span class="line"># vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">proxy_cache_path &#x2F;cache&#x2F;nginx&#x2F; level&#x3D;1:1:1 keys_zone&#x3D;mycache:32m;</span><br><span class="line"># mkdir -pv &#x2F;cache&#x2F;nginx</span><br><span class="line"># chown -R nginx.nginx &#x2F;cache&#x2F;nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">proxy_connect_timeout:  nginx  proxy 请求连接到后端连接请求的超时时长;</span><br><span class="line">proxy_hide_header: 设定响应到客户端时需要隐藏的首部信息;‘</span><br><span class="line">proxy_buffers 8k; 指定缓冲大小</span><br></pre></td></tr></table></figure>
<h2 id="upstream-负载均衡-模块"><a href="#upstream-负载均衡-模块" class="headerlink" title="upstream(负载均衡) 模块"></a>upstream(负载均衡) 模块</h2><p>upstream 模块只能使用在http段中</p>
<p>例子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 注 启用负载均衡时要把缓存关了</span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server www.ssjinyao.com weight&#x3D;5 </span><br><span class="line">    server 127.0.0.1:8080  max_fails&#x3D;3  fail_timeout&#x3D;30s;</span><br><span class="line">    server unix:&#x2F;tmp&#x2F;backend3;</span><br><span class="line">    server backup1.ssjinyao.com backup;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">upstream upservers &#123;</span><br><span class="line">    ip hash;</span><br><span class="line">    server 172.16.55.127 max_fail&#x3D;2  fail_timeout&#x3D;2 # 自带健康状态检测功能;</span><br><span class="line">    # server 172.16.55.128 weight&#x3D;2;</span><br><span class="line">    server 172.16.55.129 bakup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server_name  www.ssjinyao.com;</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;upservers&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># nginx -t </span><br><span class="line"># systemctl reload nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="SNAT模式的大量的Client"><a href="#SNAT模式的大量的Client" class="headerlink" title="SNAT模式的大量的Client"></a>SNAT模式的大量的Client</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">基于sticky实现session绑定:</span><br><span class="line">    cookie 而我们一般常用的是基于cookie的绑定;</span><br><span class="line">    route</span><br><span class="line">    learn() 需要Nginx 在 1.8 版本以上;</span><br><span class="line"></span><br><span class="line">example:</span><br><span class="line"></span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com;</span><br><span class="line">    server backend2.example.com;</span><br><span class="line">    </span><br><span class="line">    sticky cookie srv_id expires&#x3D;1h domain&#x3D;.example.com path&#x3D;&#x2F;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">least_conn:调度方法，最少连接;</span><br><span class="line"></span><br><span class="line">upstream memcached_backend &#123;</span><br><span class="line">    server 127.0.0.1:11211;</span><br><span class="line">    server 172.16.55.121:11211;</span><br><span class="line">    </span><br><span class="line">    keepavlie 32;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location &#x2F;memcached&#x2F; &#123;</span><br><span class="line">        set $memcached_key $uri;</span><br><span class="line">        memcached_pass memcached_backend;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">    health_check;</span><br><span class="line">&#125;</span><br><span class="line">    helth_check; 即健康状态检查;</span><br><span class="line">    建议: 关闭访问日志;</span><br><span class="line">    </span><br><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">    ...</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;backend;</span><br><span class="line">            health_check match&#x3D;welcome; # 做字符串匹配;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        metch welcome &#123;</span><br><span class="line">            status 200;</span><br><span class="line">            header Content-Type &#x3D; text&#x2F;html;</span><br><span class="line">            body ~ &quot;Welcome to nginx&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nginx-自定义首部给客户端"><a href="#Nginx-自定义首部给客户端" class="headerlink" title="Nginx 自定义首部给客户端"></a>Nginx 自定义首部给客户端</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"># 代理服务器响应给客户端时，如何自定义响应首部;</span><br><span class="line">     listen 443;</span><br><span class="line">    server_name www.ssjinyao.com;</span><br><span class="line">    add_header SSJinYao-Server &#39;Next-SSJinYao&#39;;</span><br><span class="line">    add_header SSJinYao-IP $server_addr;</span><br><span class="line">    add_header X-Cache $upstream_cache_status;</span><br><span class="line">    add_header Name &#39;ssjinyao&#39;;</span><br><span class="line">    </span><br><span class="line"># curl -I https:&#x2F;&#x2F;www.ssjinyao.com  # 定义完响应首部后，进行验证;</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Tue, 24 Apr 2018 07:24:37 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line">Content-Length: 39777</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Last-Modified: Thu, 19 Apr 2018 09:14:18 GMT</span><br><span class="line">ETag: &quot;9b61-56a2fff0c14a1&quot;</span><br><span class="line">SSJinYao-Server: Next-SSJinYao</span><br><span class="line">SSJinYao-IP: 172.31.253.156</span><br><span class="line">X-Cache: HIT</span><br><span class="line">Name: ssjinyao</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<h3 id="fast-cgi-使用"><a href="#fast-cgi-使用" class="headerlink" title="fast-cgi 使用"></a>fast-cgi 使用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LNMP</span><br><span class="line"># yum -y install php-fpm</span><br><span class="line"># rpm -ql php-fpm </span><br><span class="line"># vim &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf</span><br><span class="line"># systemctl start php-fpm </span><br><span class="line"># vim &#x2F;etc&#x2F;nginx.conf.d&#x2F;default.conf</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">    root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~\.php$ &#123;</span><br><span class="line">    fastcgi_cache fcgicache;</span><br><span class="line">    fastcgi_cache_valid 200 10m;</span><br><span class="line">    fastcgi_cache_valid 302 3m;</span><br><span class="line">    fastcgi_cache_valid any 1m;</span><br><span class="line">    root &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">    fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">    fastcgi_index indexphp;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME &#x2F;scripts$fastcgi-script_naame;</span><br><span class="line">    indclude fastcgi_paramgs;</span><br><span class="line">&#125;</span><br><span class="line"># systemctl restart nginx</span><br><span class="line"># 若调用fastcgi 失败 </span><br><span class="line"># 编辑&#x2F;etc&#x2F;nginx&#x2F;fastcgi_params，将其内容更改为如下内容：</span><br><span class="line">fastcgi_param  GATEWAY_INTERFACE  CGI&#x2F;1.1;</span><br><span class="line">fastcgi_param  SERVER_SOFTWARE    nginx;</span><br><span class="line">fastcgi_param  QUERY_STRING       $query_string;</span><br><span class="line">fastcgi_param  REQUEST_METHOD     $request_method;</span><br><span class="line">fastcgi_param  CONTENT_TYPE       $content_type;</span><br><span class="line">fastcgi_param  CONTENT_LENGTH     $content_length;</span><br><span class="line">fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span><br><span class="line">fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;</span><br><span class="line">fastcgi_param  REQUEST_URI        $request_uri;</span><br><span class="line">fastcgi_param  DOCUMENT_URI       $document_uri;</span><br><span class="line">fastcgi_param  DOCUMENT_ROOT      $document_root;</span><br><span class="line">fastcgi_param  SERVER_PROTOCOL    $server_protocol;</span><br><span class="line">fastcgi_param  REMOTE_ADDR        $remote_addr;</span><br><span class="line">fastcgi_param  REMOTE_PORT        $remote_port;</span><br><span class="line">fastcgi_param  SERVER_ADDR        $server_addr;</span><br><span class="line">fastcgi_param  SERVER_PORT        $server_port;</span><br><span class="line">fastcgi_param  SERVER_NAME        $server_name;</span><br><span class="line"># nginx -s reload</span><br><span class="line"># yum -y install php-mysql mariadb maraidb-server</span><br><span class="line"># cd &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line"># vim index.php</span><br><span class="line">&lt;?php </span><br><span class="line">    $conn &#x3D; mysql_connect(&#39;127.0.0.1&#39;,&#39;root&#39;,&#39;&#39;);</span><br><span class="line">    if ($conn)</span><br><span class="line">        echo succ</span><br><span class="line">    else</span><br><span class="line">        echo fail;</span><br><span class="line">    mysql_close();</span><br><span class="line">?&gt;</span><br><span class="line"># 当LNMP 环境跑起来时，可以通匹配反像代理来实现动静分离;</span><br><span class="line">(1) root为同一路径;</span><br><span class="line">(2) root为不同路径;</span><br><span class="line">    location \.php$&#123;</span><br><span class="line">        root &#x2F;web&#x2F;app&#x2F;wp;</span><br><span class="line">    &#125;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root &#x2F;web&#x2F;htdocs;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">(3) fpm server 为另一主机 ;</span><br><span class="line"></span><br><span class="line">    location \.php$&#123;</span><br><span class="line">        fastcgi_pass fastcgi:&#x2F;&#x2F;172.16.55.129:9000;</span><br><span class="line">    &#125;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root &#x2F;web&#x2F;htdocs;</span><br><span class="line">    &#125;</span><br><span class="line"># 注: 如果动态内容能过缓存来进行加速的话，加速效果是非常明显示的;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB NOSQL的使用、分布式搭建、切片存储</title>
    <url>/2018/04/17/MongoDB%20NoSQL%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="MongoDB-NoSQL使用"><a href="#MongoDB-NoSQL使用" class="headerlink" title="MongoDB NoSQL使用"></a>MongoDB NoSQL使用</h1><p>[toc]</p>
<p>NoSQL: Not Only SQL</p>
<p><img src="/images/mongodb_logo.png" class="lazyload" data-srcset="/images/mongodb_logo.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="常用需求及实现"><a href="#常用需求及实现" class="headerlink" title="常用需求及实现"></a>常用需求及实现</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">大数据问题: BigData</span><br><span class="line">    并行数据库系统，无共享体系结构中，采用关系结构模型，像MySQL的水平切片技术,分区查询;</span><br><span class="line">    NoSQL数据库管理系统: 不是一种单一单纯的技术，非关系模型、分布式、不支持ACID数据库设计范式;</span><br><span class="line">        简单数据模型;</span><br><span class="line">        元数据和数据分离;</span><br><span class="line">        弱一致性;</span><br><span class="line">        高吞吐量;</span><br><span class="line">        高水平扩展能力和低端硬件集群;</span><br><span class="line">   NewSQL数据库管理系统</span><br><span class="line">        相关产品: Clustrix、 GenleDB 、ScaleBase、NimbusDB、mysql(NDBCluster、Drizzle)</span><br><span class="line">    云数据管理系统:</span><br><span class="line">        相关产品: DBAAS,RDS</span><br><span class="line"></span><br><span class="line">大数据的分析处理:</span><br><span class="line">    常见的有MapReduce机制:将大的数据映射成键值对，而后对各各键值对处理后进行聚合;</span><br><span class="line">    而hadoop 就是类似于这种系统; habase也是NoSQL的一种;</span><br><span class="line">    CAP: 强一致性;可用性;分区容错性(出现脑裂的时候可否处理业务需求);</span><br><span class="line">        最终一致性细分:</span><br><span class="line">            困果一致性;</span><br><span class="line">            读自己写一致性;</span><br><span class="line">            会话一致性;</span><br><span class="line">            单调读一致性;</span><br><span class="line">            时间轴一致性;</span><br><span class="line">            </span><br><span class="line">    ACID &amp; BASE</span><br><span class="line">        Atomicity  原子性;</span><br><span class="line">        Consistency 一致性;</span><br><span class="line">        Isolation 隔离性 ;</span><br><span class="line">        Durability 持久性;</span><br><span class="line">        BASE 基本可用;</span><br><span class="line">        </span><br><span class="line">    ACID特性: 强一致性、隔离性、采用悲观保守的方法、难以变化;</span><br><span class="line">    BASE特性: 弱一致性、可用性优先、采用乐观的方法、更简单、更快;</span><br><span class="line"></span><br><span class="line">    数据一致性的实现技术:</span><br><span class="line">            NRW</span><br><span class="line">            2PC</span><br><span class="line">            Paxos</span><br><span class="line">            Vecotr Clock </span><br><span class="line"></span><br><span class="line">数据存储模型:   www.nosql-databases.org</span><br><span class="line">    列式存储模型 </span><br><span class="line">    文档存储模型</span><br><span class="line">    键值数据模型</span><br><span class="line">    图式数据模型</span><br><span class="line">    列式模型:</span><br><span class="line">        应用场景: 在分布式文件系统之上提供支持随机读写分布式数据存储;</span><br><span class="line">        典型产品: HBase、Hypertable、Cassandra</span><br><span class="line">        数据模型: 以&quot;列&quot;为中心进行存储 ，将同一列数据存储在一起;</span><br><span class="line">        优点: 快速查询、高可扩展性、易于实现分布式扩展;</span><br><span class="line">    </span><br><span class="line">    文档模型:</span><br><span class="line">        应用场景:非强事务需求的web应用;</span><br><span class="line">        典型产品:MongoDB、ElasticSearch(构建的搜索引擎工具)、CouchDB、CouchBase Server</span><br><span class="line">        数据模型: 键值模型，存储为文档;</span><br><span class="line">        优点: 数据模型无需事先定义</span><br><span class="line">        </span><br><span class="line">    键值模型:</span><br><span class="line">        应用场景: 内容缓存，用于大量并行数据访问高载场景;</span><br><span class="line">        典型产品: Redis、DynamoDB、Riak、Redis;</span><br><span class="line">        数据模型: 基于哈希表实现的key-value模型;</span><br><span class="line">        优点: 查询迅速， 缺点：数据没有结构;</span><br><span class="line">        </span><br><span class="line">    图式模型:</span><br><span class="line">        应用场景: 社交网络、推荐系统、关系图普</span><br><span class="line">        典型产品: Neo4J  、TITAN 、 Infinite Graph</span><br><span class="line">        数据模型: 图式结构</span><br><span class="line">        优点: 适应于图式计算场景</span><br><span class="line"></span><br><span class="line">MongoDB: NoSQL、文档存储、Json数据模型</span><br><span class="line">    适用场景: </span><br><span class="line">        Websites</span><br><span class="line">        Caching</span><br><span class="line">        High volume, low value</span><br><span class="line">        High scalability </span><br><span class="line">        Storage of program objects and json</span><br><span class="line">     不适用场景:</span><br><span class="line">        Hightly transactional</span><br><span class="line">        Ad-hoc business intelligence</span><br><span class="line">        Problems requiring SQL</span><br></pre></td></tr></table></figure>
<h2 id="mongo-的安装与使用"><a href="#mongo-的安装与使用" class="headerlink" title="mongo 的安装与使用"></a>mongo 的安装与使用</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> # vim &#x2F;etc&#x2F;yum.repos.d&#x2F;mongodb.repo</span><br><span class="line"> [mongodb-org-3.4]  </span><br><span class="line">name&#x3D;MongoDB Repository  </span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;repo.mongodb.org&#x2F;yum&#x2F;redhat&#x2F;$releasever&#x2F;mongodb-org&#x2F;3.4&#x2F;x86_64&#x2F;  </span><br><span class="line">gpgcheck&#x3D;1  </span><br><span class="line">enabled&#x3D;1  </span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;www.mongodb.org&#x2F;static&#x2F;pgp&#x2F;server-3.4.asc</span><br><span class="line"># yum clean all</span><br><span class="line"># yum makeacahe</span><br><span class="line"># yum -y install mongodb-org</span><br></pre></td></tr></table></figure>
<h3 id="server包生成的关键文件"><a href="#server包生成的关键文件" class="headerlink" title="server包生成的关键文件"></a>server包生成的关键文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rpm -ql mongodb-org-server</span><br><span class="line">&#x2F;etc&#x2F;mongod.conf</span><br><span class="line">&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;mongod.service</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongod</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;mongo</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;mongodb</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;mongodb&#x2F;mongod.log</span><br><span class="line">&#x2F;var&#x2F;run&#x2F;mongodb</span><br></pre></td></tr></table></figure>
<h3 id="shell包生成的关键文件"><a href="#shell包生成的关键文件" class="headerlink" title="shell包生成的关键文件"></a>shell包生成的关键文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rpm -ql mongodb-org-shell</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongo</span><br></pre></td></tr></table></figure>
<h3 id="tools包生成的关键文件"><a href="#tools包生成的关键文件" class="headerlink" title="tools包生成的关键文件"></a>tools包生成的关键文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rpm -ql mongodb-org-tools</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;bsondump</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongodump</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongoexport</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongofiles</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongoimport</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongooplog</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongoperf</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongorestore</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongostat</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mongotop</span><br></pre></td></tr></table></figure>
<h3 id="server端配置项"><a href="#server端配置项" class="headerlink" title="server端配置项"></a>server端配置项</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;mongod.conf </span><br></pre></td></tr></table></figure>
<h3 id="Mongo基本操作"><a href="#Mongo基本操作" class="headerlink" title="Mongo基本操作"></a>Mongo基本操作</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">help # 查看常用的使用帮助命令;</span><br><span class="line">db.help() # 查看对库操作的使用帮助;</span><br><span class="line">db.mycoll.cind().help()</span><br><span class="line">db.mycoll.help()</span><br><span class="line">show dbs # 查看目前存在哪些库;</span><br><span class="line">show collections # 列出列表;</span><br><span class="line">use testdb # 切换至哪个库，或者新建哪个库 </span><br><span class="line">db.status() #查看当前库的状态;</span><br><span class="line">db.version() # 查看当前库的版本;</span><br><span class="line">db.serverStatus() # 查看当前MongoDB服务的状态;</span><br><span class="line">show users # 查看当前存在哪些用户;</span><br><span class="line">show logs # 查看Mongo开启了哪些日志记录;</span><br><span class="line">user db.help() # 查寻帮助;</span><br><span class="line">db.getCollectionNames() # 查看列表名称;</span><br><span class="line">db.students.status() #查看某个库，某张表的状态;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Collection Query Criteria Modifier</span><br><span class="line">db.users.find( &#123;age: &#123;$gt: 18&#125; &#125; ).sort( &#123;age: 1&#125; )</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JSON: JavaScript Object Notation</span><br><span class="line">    名称&#x2F;值对象的集合;</span><br><span class="line">    值的有序列表;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.students.inert( &#123;name:&quot;tome&quot;, age:23&#125; )</span><br><span class="line">show clollections</span><br><span class="line">show dbs</span><br><span class="line">db.status</span><br><span class="line">db.students.stats()</span><br><span class="line">db.getCollectionNames()</span><br><span class="line">db.students.insert([name:&#39;&#39;renjin&quot;,age:23,gender:&quot;M&quot;])</span><br><span class="line">db.students.find() </span><br><span class="line">db.students.insert([name:&quot;ssjinyao&quot;,Age:23,Course:&quot;PieXieJianFa&quot;])</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find() 的高级用法:</span><br><span class="line">    比较操作:</span><br><span class="line">        $gt, 语法格式&#123;filed: &#123;$gt VALUE&#125;&#125;</span><br><span class="line">db.statuents.find(&#123;Age:&#123;$gt 23&#125;&#125;)</span><br><span class="line">        $gte</span><br><span class="line">        $lt</span><br><span class="line">        $lte</span><br><span class="line">        $ne</span><br><span class="line">        $in,语法格式&#123;filed: &#123;$in: [&#39;value&#39;]&#125;&#125;</span><br><span class="line">db.students.find&#123;Age:&#123;$in: [20,23]&#125;&#125;</span><br><span class="line">组合条件: 逻辑运算</span><br><span class="line">        $or: 或运算，语法格式&#123;$or: &#123;&lt;expression1&gt;,...&#125;&#125;</span><br><span class="line">db.students.find(&#123;$or: &#123;Age: &#123;$nin: [20,40], age &#123;$nin:[20,40]&#125;&#125;&#125;)</span><br><span class="line">db.students.find(&#123;$or: [&#123;Age: &#123;$nin: [20,40]&#125;&#125;, &#123;age: &#123;$nin:  [20,40]&#125;&#125;]&#125;)</span><br><span class="line">        $and: 与运算</span><br><span class="line">        $not: 非运算</span><br><span class="line">        $nor: 反运算,返回不符指定件的所有文档</span><br><span class="line"></span><br><span class="line">元素查询: 根据文档中是否存在指定的字段进行查询;</span><br><span class="line">        $exists: 语法格式&#123;$filed:&#123;$exists:&lt;boolean&gt;&#125;&#125;</span><br><span class="line">        db.students.find(&#123;gender: &#123;$exits: false&#125;&#125;)</span><br><span class="line">        $mod: </span><br><span class="line">        $type: 返回指定的字段的值的类型为指定类型的文档,语法格式&#123;field:&#123;$type: &lt;BSON type&gt;&#125;&#125;</span><br><span class="line">            Double,String,Object, Arrary, Binary data, Undefined, Boolean,Data ,Null, Regular Expression, JavaScript, Timestamp</span><br><span class="line"></span><br><span class="line">更新操作:</span><br><span class="line">    db.mycoll.update()</span><br><span class="line">        $set: 修改字段的值为新指定的值: 语法格式&#123;filed: value&#125;, &#123;$set: &#123;filed: new_value&#125;&#125;)</span><br><span class="line">        $unset: 删除指定字段;语法格式(&#123;filed: value&#125;, &#123;$unset:&#123;filed1, field2,....&#125;&#125;)</span><br><span class="line">    db.students.update(&#123;name: &quot;renjin&quot;&#125;, &#123;$set: &#123;age: 22&#125;&#125;)</span><br><span class="line">        $rename: 更改字段名,语法格式(&#123;$rename: &#123;oldname: newname, oldname: newname&#125;&#125;)</span><br><span class="line">    db.students.update(&#123;$rename: &#123;age:Age&#125;)</span><br><span class="line">        $inc</span><br><span class="line"></span><br><span class="line">删除操作:</span><br><span class="line">    db.mycoll.remove(&lt;query&gt;,&lt;justOne&gt;)</span><br><span class="line">    db.students.remove(&#123;age:21&#125;)</span><br><span class="line">    db.students.findOne(&#123;Age: &#123;$gt:10&#125;&#125;)</span><br><span class="line">删除collection:</span><br><span class="line">    db.mycoll.drop()</span><br><span class="line">    db.studetns.drop()</span><br><span class="line">删除database:</span><br><span class="line">    db.dropDatabase()</span><br><span class="line"></span><br><span class="line">php+mongodb</span><br><span class="line">    php的mongo扩展</span><br></pre></td></tr></table></figure>
<h2 id="MongoDB-Indexes-and-Administration"><a href="#MongoDB-Indexes-and-Administration" class="headerlink" title="MongoDB Indexes and Administration"></a>MongoDB Indexes and Administration</h2><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>类型: B+ Tree、hash、空间索引、全文索引</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MongoDB索引类型 </span><br><span class="line">    单字段索引</span><br><span class="line">    组合索引(多字段索引)</span><br><span class="line">    多键索引</span><br><span class="line">    空间索引</span><br><span class="line">    文本索引</span><br><span class="line">    hash索引  hash 索引只支持精确值查找</span><br><span class="line">    db.people.ensureIndex(&#123; zipcode:1&#125;, &#123;background: ture&#125;)</span><br><span class="line">    db.account.ensureIndex( &#123; username: 1 &#125; , &#123;unique: ture, dropDups: true &#125;)</span><br><span class="line">    </span><br><span class="line">MongoDB与索引相关的方法:</span><br><span class="line">    db.mycoll.ensureIndex(field[,options])</span><br><span class="line">        name、unique、dropDups、sparse</span><br><span class="line">    db.mycoll.dropIndex(index_name)</span><br><span class="line">    db.mycoll.dropIndexes()</span><br><span class="line">    db.mycoll.getIndexes()</span><br><span class="line">    db.mycoll.reIndex()    </span><br></pre></td></tr></table></figure>
<h3 id="mongodb-用for-循环来连续插入数据"><a href="#mongodb-用for-循环来连续插入数据" class="headerlink" title="mongodb 用for 循环来连续插入数据"></a>mongodb 用for 循环来连续插入数据</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use testdb</span><br><span class="line">for (i&#x3D;1; i&lt;&#x3D;1000;i++) db.students.insert(&#123;name:&quot;student&quot;+i, age:(i%120), address:&quot;#85 Wenhua Road, Zhengzhou, China&quot;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56c&quot;), &quot;name&quot; : &quot;student1&quot;, &quot;age&quot; : 1, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56d&quot;), &quot;name&quot; : &quot;student2&quot;, &quot;age&quot; : 2, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56e&quot;), &quot;name&quot; : &quot;student3&quot;, &quot;age&quot; : 3, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56f&quot;), &quot;name&quot; : &quot;student4&quot;, &quot;age&quot; : 4, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d570&quot;), &quot;name&quot; : &quot;student5&quot;, &quot;age&quot; : 5, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d571&quot;), &quot;name&quot; : &quot;student6&quot;, &quot;age&quot; : 6, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d572&quot;), &quot;name&quot; : &quot;student7&quot;, &quot;age&quot; : 7, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d573&quot;), &quot;name&quot; : &quot;student8&quot;, &quot;age&quot; : 8, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d574&quot;), &quot;name&quot; : &quot;student9&quot;, &quot;age&quot; : 9, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d575&quot;), &quot;name&quot; : &quot;student10&quot;, &quot;age&quot; : 10, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d576&quot;), &quot;name&quot; : &quot;student11&quot;, &quot;age&quot; : 11, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d577&quot;), &quot;name&quot; : &quot;student12&quot;, &quot;age&quot; : 12, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d578&quot;), &quot;name&quot; : &quot;student13&quot;, &quot;age&quot; : 13, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d579&quot;), &quot;name&quot; : &quot;student14&quot;, &quot;age&quot; : 14, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57a&quot;), &quot;name&quot; : &quot;student15&quot;, &quot;age&quot; : 15, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57b&quot;), &quot;name&quot; : &quot;student16&quot;, &quot;age&quot; : 16, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57c&quot;), &quot;name&quot; : &quot;student17&quot;, &quot;age&quot; : 17, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57d&quot;), &quot;name&quot; : &quot;student18&quot;, &quot;age&quot; : 18, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57e&quot;), &quot;name&quot; : &quot;student19&quot;, &quot;age&quot; : 19, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57f&quot;), &quot;name&quot; : &quot;student20&quot;, &quot;age&quot; : 20, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">Type &quot;it&quot; for more</span><br><span class="line">&gt; it</span><br><span class="line"># mongo为了结省服务器资源，不会将所有的字段一下子列出来，而需要输入it来翻页查看，与more类似</span><br></pre></td></tr></table></figure>
<h3 id="在name-1-上构建升序索引"><a href="#在name-1-上构建升序索引" class="headerlink" title="在name 1 上构建升序索引"></a>在name 1 上构建升序索引</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> db.students.ensureIndex(&#123;name: 1&#125;)</span><br><span class="line">&#123;</span><br><span class="line">        &quot;createdCollectionAutomatically&quot; : false,</span><br><span class="line">        &quot;numIndexesBefore&quot; : 1,</span><br><span class="line">        &quot;numIndexesAfter&quot; : 2,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line"> db.students.getIndexes()</span><br><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;v&quot; : 2,</span><br><span class="line">                &quot;key&quot; : &#123;</span><br><span class="line">                        &quot;_id&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;v&quot; : 2,</span><br><span class="line">                &quot;key&quot; : &#123;</span><br><span class="line">                        &quot;name&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot; : &quot;name_1&quot;,</span><br><span class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="移除之前建立的索引"><a href="#移除之前建立的索引" class="headerlink" title="移除之前建立的索引"></a>移除之前建立的索引</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.students.dropIndex(&quot;name_1&quot;)</span><br><span class="line">&#123; &quot;nIndexesWas&quot; : 2, &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看索引是否被移除"><a href="#查看索引是否被移除" class="headerlink" title="查看索引是否被移除"></a>查看索引是否被移除</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> db.students.getIndexes()</span><br><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;v&quot; : 2,</span><br><span class="line">                &quot;key&quot; : &#123;</span><br><span class="line">                        &quot;_id&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="建立维一键索引"><a href="#建立维一键索引" class="headerlink" title="建立维一键索引"></a>建立维一键索引</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.students.ensureIndex(&#123;name: 1&#125;,&#123;unique: true&#125;)</span><br><span class="line">&#123;</span><br><span class="line">        &quot;createdCollectionAutomatically&quot; : false,</span><br><span class="line">        &quot;numIndexesBefore&quot; : 1,</span><br><span class="line">        &quot;numIndexesAfter&quot; : 2,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; </span><br><span class="line">&gt; db.students.getIndexes()</span><br><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;v&quot; : 2,</span><br><span class="line">                &quot;key&quot; : &#123;</span><br><span class="line">                        &quot;_id&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot; : &quot;_id_&quot;,</span><br><span class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;v&quot; : 2,</span><br><span class="line">                &quot;unique&quot; : true,</span><br><span class="line">                &quot;key&quot; : &#123;</span><br><span class="line">                        &quot;name&quot; : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot; : &quot;name_1&quot;,</span><br><span class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="利用索引快速查询"><a href="#利用索引快速查询" class="headerlink" title="利用索引快速查询"></a>利用索引快速查询</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.students.find(&#123;name: &quot;student500&quot;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d75f&quot;), &quot;name&quot; : &quot;student500&quot;, &quot;age&quot; : 20, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</span><br><span class="line">db.students.find(&#123;name: &quot;student500&quot;&#125;).explain()</span><br></pre></td></tr></table></figure>
<h3 id="查看索引执行过程"><a href="#查看索引执行过程" class="headerlink" title="查看索引执行过程"></a>查看索引执行过程</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;queryPlanner&quot; : &#123;</span><br><span class="line">                &quot;plannerVersion&quot; : 1,</span><br><span class="line">                &quot;namespace&quot; : &quot;testdb.students&quot;,</span><br><span class="line">                &quot;indexFilterSet&quot; : false,</span><br><span class="line">                &quot;parsedQuery&quot; : &#123;</span><br><span class="line">                        &quot;name&quot; : &#123;</span><br><span class="line">                                &quot;$eq&quot; : &quot;student500&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;winningPlan&quot; : &#123;</span><br><span class="line">                        &quot;stage&quot; : &quot;FETCH&quot;,</span><br><span class="line">                        &quot;inputStage&quot; : &#123;</span><br><span class="line">                                &quot;stage&quot; : &quot;IXSCAN&quot;,</span><br><span class="line">                                &quot;keyPattern&quot; : &#123;</span><br><span class="line">                                        &quot;name&quot; : 1</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;indexName&quot; : &quot;name_1&quot;,</span><br><span class="line">                                &quot;isMultiKey&quot; : false,</span><br><span class="line">                                &quot;multiKeyPaths&quot; : &#123;</span><br><span class="line">                                        &quot;name&quot; : [ ]</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &quot;isUnique&quot; : true,</span><br><span class="line">                                &quot;isSparse&quot; : false,</span><br><span class="line">                                &quot;isPartial&quot; : false,</span><br><span class="line">                                &quot;indexVersion&quot; : 2,</span><br><span class="line">                                &quot;direction&quot; : &quot;forward&quot;,</span><br><span class="line">                                &quot;indexBounds&quot; : &#123;</span><br><span class="line">                                        &quot;name&quot; : [</span><br><span class="line">                                                &quot;[\&quot;student500\&quot;, \&quot;student500\&quot;]&quot;</span><br><span class="line">                                        ]</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;rejectedPlans&quot; : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;serverInfo&quot; : &#123;</span><br><span class="line">                &quot;host&quot; : &quot;ssjinyao&quot;,</span><br><span class="line">                &quot;port&quot; : 27017,</span><br><span class="line">                &quot;version&quot; : &quot;3.4.14&quot;,</span><br><span class="line">                &quot;gitVersion&quot; : &quot;fd954412dfc10e4d1e3e2dd4fac040f8b476b268&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Mongod的常用先项"><a href="#Mongod的常用先项" class="headerlink" title="Mongod的常用先项:"></a>Mongod的常用先项:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">General option:  通用选项</span><br><span class="line">    fork &#x3D; &#123;true|false&#125;: mongod是否运行在后台;</span><br><span class="line">    bind_ip &#x3D; IP: 指定监听的地址;</span><br><span class="line">    port&#x3D;PORT:指定监听的端口，默认为27017，httpd访问28017;</span><br><span class="line">    maxConns&#x3D;: 并发最大连接数;</span><br><span class="line">    pidfilepath&#x3D;: pid 文件位置;</span><br><span class="line">    httpinterface&#x3D;:内置httpd统计信息等;</span><br><span class="line">    keyFile&#x3D;:主从同步基于密钥的认证;</span><br><span class="line">    auth: 是否开启认证功能;</span><br><span class="line">    repair: 服务器意外重启，或未正重关闭时，要使用repair来修复;</span><br><span class="line">    journal:是否启用日志功能;</span><br><span class="line">    jounalCommit: 日志提交的时间间隔;</span><br><span class="line">    cpu: 间断性的显示内存CPU的使用率;</span><br><span class="line">    slowms arg: 超出指定值后采用慢查询;    </span><br><span class="line">Replication options 复制选项</span><br><span class="line">Master&#x2F;slvae options 主从复制选项</span><br><span class="line">Replica set options 复制集选项</span><br><span class="line">Sharding options 跟切片相关的选项</span><br></pre></td></tr></table></figure>
<h3 id="MongoDB的复制功能"><a href="#MongoDB的复制功能" class="headerlink" title="MongoDB的复制功能"></a>MongoDB的复制功能</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">两种类型:</span><br><span class="line">    master&#x2F;slave</span><br><span class="line">    replica set: 复制集、副本集</span><br><span class="line">        两种类型: 主节点支持读写操作，而从节点仅支持读操作;</span><br><span class="line">        服务于同一数据集的多个mongodb实例;</span><br><span class="line">        主节点操作数据修改操作保存至oplog中;</span><br><span class="line">            arbiter: 仲裁者，即便用不上三个节点，也添加三个节点，以避免脑裂;</span><br><span class="line">工作特性:至少三个，且应该为奇数据个节点;可以使用arbiter来参与选举;</span><br><span class="line">    hertbeat(默认2s传递一次),自动失效转移(通过选举方式实现)</span><br><span class="line"></span><br><span class="line">复制集的中节点分类的集中类型:</span><br><span class="line">    0优先级的节点: 准备节点,这种节点不会选举成为主节点，但可以参与选举过程;</span><br><span class="line">    被隐藏的从节点: 首先是一个0优先级的从节点，且地客户端不可见;</span><br><span class="line">    延迟复制的从节点: 当在主节点误删除数据时，可以立即断开主从，可保留从节点上未改变的数据;</span><br><span class="line">            首先是一个0优先级的从节点，且复制时间落后于主节点一个固定时长;</span><br><span class="line">            arbiter:</span><br><span class="line">MongoDB的复制架构:</span><br><span class="line">    oplog</span><br><span class="line">    heartbeat</span><br><span class="line">    </span><br><span class="line">    oplog: 大小固定的文件，存储在local数据库中;</span><br><span class="line">    即便从节点有aplog也不会使用;</span><br><span class="line">        初始同步(initial sync)</span><br><span class="line">        回滚后追赶(post-rollback catch-up)</span><br><span class="line">        切分块迁移(sharding chunk migrations)</span><br><span class="line">    </span><br><span class="line">    local: 存放了副本集的所有元数据和oplog: 用于存储aplog的是一个名为oplog.rs的collection</span><br><span class="line">        aplog.rs 的大小依赖于OS 及文件系统 ;</span><br><span class="line">    </span><br><span class="line">    Mongo的数同步类型 :</span><br><span class="line">        初始同步:</span><br><span class="line">            节点没有任何数据时</span><br><span class="line">            节点丢失副本复制历史</span><br><span class="line">        复制</span><br><span class="line">        </span><br><span class="line">        初始同步的步骤:</span><br><span class="line">            1、克隆所有数据;</span><br><span class="line">            2、应用数据集的所有改变，复制oplog并应用于本地;</span><br><span class="line">            3、为所有collection构建索引;</span><br></pre></td></tr></table></figure>
<h3 id="Mongod-数据同步过程"><a href="#Mongod-数据同步过程" class="headerlink" title="Mongod 数据同步过程"></a>Mongod 数据同步过程</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">初始同步:</span><br><span class="line">    节点没有任何数据</span><br><span class="line">    从节点丢失复本，复制历史数据;</span><br><span class="line">初始同步的步骤:</span><br><span class="line">    1、克隆所有数据库;</span><br><span class="line">    2、应用数据集的所有改变;复制oplog并应用在本地;</span><br><span class="line">    3、为所有的collection构建索引;</span><br><span class="line">这样初始同步就完成了;</span><br><span class="line">优于MySQL的地方， MongoDB 支持多线程复制功能;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;mongd.conf</span><br><span class="line">replSet&#x3D;testSet</span><br><span class="line">replIndexPrefetch&#x3D;_id_only</span><br><span class="line"></span><br><span class="line"># systemctl mongod restart</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show dbs</span><br><span class="line">use local</span><br><span class="line">show collections</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># node2的配置</span><br><span class="line"># 将需要安装的rpm 包复制到第二个节点上，或者在另一台服务器上配置mongo的yum源;</span><br><span class="line"># yum -y install mongodb-org-server</span><br><span class="line"># mkdir -pv &#x2F;mongodb&#x2F;data</span><br><span class="line"># chown -R mongod.mongod &#x2F;mongodb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># node3的配置</span><br><span class="line"># 将需要安装的rpm 包复制到第三个节点上，或者在另一台服务器上配置mongo的yum源;</span><br><span class="line"># yum -y install mongodb-org-server</span><br><span class="line"># mkdir -pv &#x2F;mongodb&#x2F;data </span><br><span class="line"># chown -R mongod.mongod &#x2F;mongodb</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># scp  &#x2F;etc&#x2F;mongod.conf root@node2:&#x2F;etc&#x2F; </span><br><span class="line"># scp &#x2F;etc&#x2F;mongod.conf root@node3:&#x2F;etc&#x2F;</span><br><span class="line"># 保证三个节点的配置文件一致，并将服务器启动;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rs.conf()</span><br><span class="line">rs.status()</span><br><span class="line">rs.initiate()</span><br><span class="line">rs.status()</span><br><span class="line">rs.help() # 查找mongo的帮助文档，查看如何添加主机进来, rs. 主要指mongo的分布式配置;</span><br><span class="line">rs.add(&quot;172.16.55.128&quot;)  # 在主节点的mongo中执行;</span><br><span class="line">show dbs </span><br><span class="line"># 从节点默认是不支持查询的，因此需要手动开启;</span><br><span class="line"># 在node2 节点中，将当前服务器节点改为从节点;</span><br><span class="line">rs.salveOK() </span><br><span class="line">rs.status()</span><br><span class="line">rs.isMaster() # 查看自己是否为主节点;</span><br><span class="line"># 因此，当服务器改为从节点之后可以在从节点上查询信息; </span><br><span class="line"># db.statudents.findOne();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 第三个节点</span><br><span class="line">rs.add(&quot;172.16.55.129&quot;) # 在主节点的mongo中执行</span><br><span class="line"># 在 node3 节点中，将当前服务器节点改为从节点；</span><br><span class="line">rs.salveOK()</span><br><span class="line"># 注要写数据的时候，还是要到主节点中支写;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.classes.insert(&#123;class: &quot;One&quot;, nostu: 40&#125;) # 尝试在主节点中插入数据;</span><br><span class="line">show collections # 这里主服务器对应的数据已经有了;</span><br><span class="line">db.classes.findOne()  # 尝试在从服务器中查找数据，如查有数据，则说明数据同步没有问题;</span><br><span class="line"># 从节点中是不能写入数据;</span><br><span class="line">rs.stepDown() # 将主节点强制成为从节点;</span><br><span class="line">rs.status() # 可以看出，其中有一个节点会自动成为主节点;</span><br><span class="line">db.printReplicationInfo() #  查看产中事件的间时，大小;</span><br></pre></td></tr></table></figure>
<h3 id="副本集的重新先举的影响条件"><a href="#副本集的重新先举的影响条件" class="headerlink" title="副本集的重新先举的影响条件:"></a>副本集的重新先举的影响条件:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">心跳信息</span><br><span class="line">优先级</span><br><span class="line">optime</span><br><span class="line">网络连接</span><br><span class="line">网络分区</span><br></pre></td></tr></table></figure>
<h3 id="先举机制"><a href="#先举机制" class="headerlink" title="先举机制:"></a>先举机制:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">触发选举的事件</span><br><span class="line">    新副本集初始化时;</span><br><span class="line">    从节点联系不到主节点时;</span><br><span class="line">    主节点&quot;下台&quot;时;</span><br><span class="line">        主节点收到stepDown()命令时;</span><br><span class="line">        某从节点有更高的优先级且已经满足了成主节点的其它所有条件;</span><br><span class="line">        主节点无法联系到副本集的&quot;多数方&quot;；</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cfg&#x3D; rs.conf() # 保存当前mongo的配置；</span><br><span class="line">cfg.member[1].priority&#x3D;2</span><br><span class="line">rs.conf() # 这时的配置依然是1</span><br><span class="line">rs.reconfig(cfg) # 生效配置则必需要在主节点中进行;</span><br><span class="line"># 触发新的选举机制；</span><br><span class="line"></span><br><span class="line">cfg &#x3D; rs.confg()</span><br><span class="line">cfg.member[2].abiterOnly&#x3D;ture # 设置abiterOnly 属性;</span><br><span class="line">rs.reconfgi(cfg)</span><br><span class="line">rs.conf()</span><br><span class="line">rs.printSlaveReplicationInfo() # 同时也可以看是每个从节点是否落后于主节点;</span><br></pre></td></tr></table></figure>
<h2 id="MongoDB的分片"><a href="#MongoDB的分片" class="headerlink" title="MongoDB的分片:"></a>MongoDB的分片:</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sharding 分片</span><br><span class="line">    # 随着公司业务的分展，数据集会变的越来越大；</span><br><span class="line">    # 会在某一个时刻，CPU，内存，IO 等单机上出现瓶颈;</span><br><span class="line">    # 因此向上外向外扩展，向上扩展是经济形势的解决方案，而从技术角度，我们可以向外扩展;</span><br><span class="line"></span><br><span class="line">MySQL: Gizzard, HivedDB(独立的项目，转门来对MySQL来实现分片的)，MySQL Proxy + HSACLE, Hibernate Shared Pyshards</span><br><span class="line">    </span><br><span class="line">    # 分片架构中的角色:</span><br><span class="line">        mongos: Router;</span><br><span class="line">        config server: 元数据服务器;</span><br><span class="line">        shard: 数据节点，也称mongod实例节点; 负责将数据存下来，并响应客户端的;</span><br><span class="line">        zookeeper: 通常用于分布式节点的协调; </span><br><span class="line">    # 基于范围切片</span><br><span class="line">            range</span><br><span class="line">    # 基于列表切片</span><br><span class="line">            list</span><br><span class="line">    #  基于hash切片</span><br><span class="line">            hash</span><br><span class="line">        写离散，读要集中</span><br></pre></td></tr></table></figure>
<p><img src="/images/mongofs.png" class="lazyload" data-srcset="/images/mongofs.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="分片式架构配置"><a href="#分片式架构配置" class="headerlink" title="分片式架构配置"></a>分片式架构配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rm -rf  &#x2F;mongodb&#x2F;data&#x2F; # 注: 在生产中，这个操作非常危险！需要将数据库用mongodump 备份；</span><br><span class="line"># 将mongodb 安装的rpm包，或者yum的配置文件用ansible 或scp 同步到其它四个节点上去;</span><br><span class="line"># 在四个节点将mongodb 相关软件包都安装好</span><br><span class="line"># 先要配置config server --&gt; mongos --&gt; Shard1 --&gt; Shard2</span><br><span class="line">-------------------------&gt; confiserver 服务器配置</span><br><span class="line"># vim &#x2F;etc&#x2F;mongod.conf</span><br><span class="line"># replSet&#x3D;testSet</span><br><span class="line"># replIndexPrefetch&#x3D;id_only #  </span><br><span class="line">dbpath&#x3D;&#x2F;mongodb&#x2F;data</span><br><span class="line">configsvr&#x3D;true</span><br><span class="line"># chown -R mongod.mongod &#x2F;mongodb</span><br><span class="line"># install -o mongod -g mongod -d &#x2F;mongodb&#x2F;data  # 建立数据库的元数据 ;</span><br><span class="line"># systemctl start mongod  mongo    # config server 默认监听在27019的端口上;  </span><br><span class="line"></span><br><span class="line">-----------------------&gt; mongofs 服务器配置</span><br><span class="line"># yum -y insetall mongodb-org-mongos  # </span><br><span class="line">#  启动 mongofs 节点</span><br><span class="line"># mongos --configdb&#x3D;172.16.55.172.16.55.128 --fork --logpath&#x3D;&#x2F;var&#x2F;log&#x2F;mongodb&#x2F;mongo.log</span><br><span class="line"># mongo --host 172.16.55.127</span><br><span class="line">help</span><br><span class="line">sh.status() </span><br><span class="line"># 以下节点起动后</span><br><span class="line">sh.addShard(&quot;172.16.55.129&quot;)</span><br><span class="line">ss.addShard(&quot;172.16.55.120&quot;)</span><br><span class="line">sh.enableShareding(&quot;testdb&quot;) # 在testdb中启有shard功能;</span><br><span class="line">sh.help() # 查找shards集群相关的配置项;</span><br><span class="line">sh.enableSharding(dbname)  # 在哪个节点起用sharding;</span><br><span class="line">sh.shardCollection(fullName,key,unique) # 在collection哪个键，索引上做sharding ;</span><br><span class="line">sh.shardCollection(&quot;students&quot;, &#123;&quot;age&quot; : 1 &#125;)</span><br><span class="line">sh.status() # 此时就可以查看分片信息了;</span><br><span class="line">use testdb;</span><br><span class="line">for (i&#x3D;1; i&lt;&#x3D;100000;i++) db.students.insert(&#123;name:&quot;studentt&quot;+i,  age:(i%120),classes:&quot;class&quot;+(i%10),address:&quot;www.ssjinyao.com, Magedu, #85 WenhuaRoad, BeiJin, China&quot;&#125;) # 批量插入测试数据;</span><br><span class="line">use testdb</span><br><span class="line">db.students.find().count()</span><br><span class="line">sh.status() # 可以看到分片存储的信息;</span><br><span class="line">db.databases.find(&quot;partitioned&quot;:true)</span><br><span class="line">db.runCommands(&quot;listShards&quot;)</span><br><span class="line">use admin</span><br><span class="line">db.runCommand(&quot;listShards&quot;)</span><br><span class="line">db.printShardingStatus()</span><br><span class="line">sh.isBalancerRunning()  # 查看均衡器状态，它会在需要时自动启动;</span><br><span class="line">sh.getBalancerState() # 查看BlancerSate的状态;</span><br><span class="line">-----------------------&gt; Shard1 服务器配置</span><br><span class="line"># vim &#x2F;etc&#x2F;mongod.conf</span><br><span class="line"># replSet&#x3D;testSet</span><br><span class="line"># replIndexPrefetch&#x3D;id_only # 注释以上配置</span><br><span class="line"># dbpath&#x3D;&#x2F;mongodb&#x2F;data</span><br><span class="line"># chown -R mongod.mongod &#x2F;mongodb</span><br><span class="line"># systemctl start mongod</span><br><span class="line"></span><br><span class="line">-----------------------&gt; Shard2 服务器配置</span><br><span class="line"># vim &#x2F;etc&#x2F;mongod.conf</span><br><span class="line"># replSet&#x3D;testSet</span><br><span class="line"># replIndexPrefetch&#x3D;id_only # 注释以上配置</span><br><span class="line"># dbpath&#x3D;&#x2F;mongodb&#x2F;data</span><br><span class="line"># chown -R mongod.mongod &#x2F;mongodb</span><br><span class="line"># systemctl start mongod</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ansible 自动化运维</title>
    <url>/2018/04/09/ansible%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="ansible-自动化运维"><a href="#ansible-自动化运维" class="headerlink" title="ansible 自动化运维"></a>ansible 自动化运维</h1><p><img src="/images/ansbile_n1.png" class="lazyload" data-srcset="/images/ansbile_n1.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="运维工具"><a href="#运维工具" class="headerlink" title="运维工具"></a>运维工具</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OS Provisioning: PXE, Cobbler(repository, distritution, profile)</span><br><span class="line">    PXE: dhcp, tftp,(http,ftp)</span><br><span class="line">        dnsmsq:dhcp,dns</span><br><span class="line">OS Config:</span><br><span class="line">    puppet, saltstack, func </span><br><span class="line">Task Excute:</span><br><span class="line">    fabric, func,saltstack</span><br><span class="line">Deployment:</span><br><span class="line">    fabric,</span><br><span class="line">运维工具分类:</span><br><span class="line">    agent: puppet, func  这些工具必需要有agent端;</span><br><span class="line">    agentless: ansible, fabirc 这些工具必需启用ssh服务;</span><br><span class="line">Properties:</span><br><span class="line">    Minimal learning curve, auditability: 入门曲线非常平缓;</span><br><span class="line">    No bootstrapping:  无需agent;</span><br><span class="line">    No DAG ordering, Fails  Fast: 没有次序; </span><br><span class="line">    No agents(other than sshd) -o resource consumption when not in use: 没有代理;</span><br><span class="line">    No Server: 也没有服务端；</span><br><span class="line">    No additional PKI : 无需证书等功能;</span><br><span class="line">    Modules in any language: 模块可以使用任意编程语言来编写;</span><br><span class="line">    YAML, not code: 使用yaml配置文件;</span><br><span class="line">    SSH by default: 使用ssh默认接口;</span><br><span class="line">    Strong multi-tier solution: 支持多级使用方案;</span><br><span class="line">Host Inventory:</span><br><span class="line">    定义可被 ansible管控的主机; </span><br><span class="line">Core Modules:</span><br><span class="line">    可被调用的核心模块，可以完成大部作的任务;</span><br><span class="line">Custom Modules:</span><br><span class="line">    自定义模块，当ansible实现不了时，可以使用任意编程语言来编写模块;</span><br><span class="line">Connection Plugins:</span><br><span class="line">    ansible 可以支持一些插件来实现一些功能，如发送邮件功能;</span><br><span class="line">ansible的核心线件:</span><br><span class="line">    ansible core </span><br><span class="line">    host iventory</span><br><span class="line">    core modules </span><br><span class="line">    custom modules</span><br><span class="line">    playbook (yaml, jinjia2)</span><br><span class="line">    connect plugin</span><br><span class="line">ansible特性:</span><br><span class="line">    基于Python语言实现，由Paramiko模块实现，PyYAML和Jinia2 三个关键的模块构建</span><br><span class="line">python特性:,agentless;</span><br><span class="line">    默认使用SSH协议: 会有安全隐患;</span><br><span class="line">        基于密钥认证来连接到各节点操作;</span><br><span class="line">    主从模式:</span><br><span class="line">        master: ansible, ssh client;</span><br><span class="line">        savle: ssh server结点;</span><br><span class="line">    支持自定义模块:支持各种编程语言;</span><br><span class="line">    支持Playbook</span><br><span class="line">    基于&quot;模块&quot;完成各种&quot;任务&quot;;</span><br></pre></td></tr></table></figure>
<h2 id="ansible-的安装和使用"><a href="#ansible-的安装和使用" class="headerlink" title="ansible 的安装和使用"></a>ansible 的安装和使用</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible 在于epel源中</span><br><span class="line"># yum list all *ansible*</span><br><span class="line">ansible.noarch              2.4.2.0-2.el7                               @extras</span><br><span class="line"># 安装依赖于epel源</span><br><span class="line">    配置文件 &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</span><br><span class="line">    Invertory: &#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line"># vim &#x2F;etc&#x2F;ansible # 保留以下配置</span><br><span class="line">[dbserver]</span><br><span class="line">172.16.55.123</span><br><span class="line"></span><br><span class="line">[webserver]</span><br><span class="line">172.16.55.124</span><br><span class="line">172.1655.125</span><br><span class="line"># 在ansible主机生成一组密钥</span><br><span class="line"># ssh-keygen</span><br><span class="line"># 实现双机互信</span><br><span class="line"># for i in &#123;3..5&#125; ; do ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub root@172.16.55.12$i; done</span><br><span class="line"># for i in &#123;3..5&#125; ; do ssh root@172.16.55.12$i &quot;date&quot; &amp;&amp; echo &quot;The Messages From 172.16.55.12$i&quot;; done</span><br><span class="line">2018年 04月 09日 星期一 09:47:09 CST</span><br><span class="line">The Messages From 172.16.55.123</span><br><span class="line">2018年 04月 09日 星期一 09:47:10 CST</span><br><span class="line">The Messages From 172.16.55.124</span><br><span class="line">2018年 04月 09日 星期一 09:47:10 CST</span><br><span class="line">The Messages From 172.16.55.125</span><br><span class="line"># 此时ansbile所在的服务器可以实现对各结点的控制</span><br></pre></td></tr></table></figure>
<h2 id="asnbile-doc-的使用"><a href="#asnbile-doc-的使用" class="headerlink" title="asnbile-doc 的使用"></a>asnbile-doc 的使用</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible-doc  # 用来查看asnbile 模块的使用查询;</span><br><span class="line"># ansible-doc -l # 例出所有可用的模块; </span><br><span class="line"># ansible-doc -s MODULE_NAME; # 查看某个模块的使用用法;</span><br><span class="line"># ansible-doc -s yum</span><br></pre></td></tr></table></figure>
<h2 id="ansible命令的应用基础"><a href="#ansible命令的应用基础" class="headerlink" title="ansible命令的应用基础"></a>ansible命令的应用基础</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible命令应用基础:</span><br><span class="line">    语法: ansible &lt;host-pattern&gt; [-f forks] [-m module_name] [-a args]</span><br><span class="line">        -f forks: 启动的并发线程数;</span><br><span class="line">        -m module_name: 要使用的模块;</span><br><span class="line">        -a args: 模块特有的参数;</span><br></pre></td></tr></table></figure>
<h2 id="常见的模块"><a href="#常见的模块" class="headerlink" title="常见的模块:"></a>常见的模块:</h2><h3 id="command-命令模块，默认模块，用于在远程命令"><a href="#command-命令模块，默认模块，用于在远程命令" class="headerlink" title="command: 命令模块，默认模块，用于在远程命令;"></a>command: 命令模块，默认模块，用于在远程命令;</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible 172.16.55.124 -m command -a &quot;date&quot;</span><br><span class="line">172.16.55.124 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">2018年 04月 09日 星期一 09:57:39 CST</span><br><span class="line"></span><br><span class="line"># ansible dbserver -m command -a &quot;date&quot;              </span><br><span class="line">172.16.55.123 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">2018年 04月 09日 星期一 09:58:02 CST</span><br><span class="line"></span><br><span class="line"># ansible all -m command -a &quot;date&quot;        </span><br><span class="line">172.16.55.124 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">2018年 04月 09日 星期一 09:58:24 CST</span><br><span class="line"></span><br><span class="line">172.16.55.123 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">2018年 04月 09日 星期一 09:58:24 CST</span><br><span class="line"></span><br><span class="line">172.16.55.125 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">2018年 04月 09日 星期一 09:58:32 CST</span><br><span class="line"></span><br><span class="line"># ansible all -m command -a &quot;tail -2 &#x2F;var&#x2F;log&#x2F;messages&quot;</span><br><span class="line">172.16.55.124 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">Apr  9 09:58:24 fabric1 ansible-command: Invoked with warn&#x3D;True executable&#x3D;None _uses_shell&#x3D;False _raw_params&#x3D;date removes&#x3D;None creates&#x3D;None chdir&#x3D;None stdin&#x3D;None</span><br><span class="line">Apr  9 09:59:22 fabric1 ansible-command: Invoked with warn&#x3D;True executable&#x3D;None _uses_shell&#x3D;False _raw_params&#x3D;tail -2 &#x2F;var&#x2F;log&#x2F;messages removes&#x3D;None creates&#x3D;None chdir&#x3D;None stdin&#x3D;None</span><br><span class="line"></span><br><span class="line">172.16.55.123 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">Apr  9 09:58:24 hyperledger ansible-command: Invoked with warn&#x3D;True executable&#x3D;None _uses_shell&#x3D;False _raw_params&#x3D;date removes&#x3D;None creates&#x3D;None chdir&#x3D;None stdin&#x3D;None</span><br><span class="line">Apr  9 09:59:23 hyperledger ansible-command: Invoked with warn&#x3D;True executable&#x3D;None _uses_shell&#x3D;False _raw_params&#x3D;tail -2 &#x2F;var&#x2F;log&#x2F;messages removes&#x3D;None creates&#x3D;None chdir&#x3D;None stdin&#x3D;None</span><br><span class="line"></span><br><span class="line">172.16.55.125 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">Apr  9 09:58:31 fabric2 ansible-command: Invoked with warn&#x3D;True executable&#x3D;None _uses_shell&#x3D;False _raw_params&#x3D;date removes&#x3D;None creates&#x3D;None chdir&#x3D;None stdin&#x3D;None</span><br><span class="line">Apr  9 09:59:23 fabric2 ansible-command: Invoked with warn&#x3D;True executable&#x3D;None _uses_shell&#x3D;False _raw_params&#x3D;tail -2 &#x2F;var&#x2F;log&#x2F;messages removes&#x3D;None creates&#x3D;None chdir&#x3D;None stdin&#x3D;None</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="cron-模块-可以使被管理节点自动生成一生任务计划"><a href="#cron-模块-可以使被管理节点自动生成一生任务计划" class="headerlink" title="cron 模块:可以使被管理节点自动生成一生任务计划;"></a>cron 模块:可以使被管理节点自动生成一生任务计划;</h3><p>state所有属性:</p>
<ul>
<li>present: 安装 </li>
<li>absent: 移除</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    *&#x2F;10 * * * *  &#x2F;bin&#x2F;echo &quot;Test Message&quot;</span><br><span class="line"># ansible webserver -m cron -a  &#39;minute&#x3D;&quot;*&#x2F;10&quot; job&#x3D;&quot;&#x2F;bin&#x2F;echo Test Message&quot; name&#x3D;&quot;Test Cron Job&quot;&#39; </span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;Test Cron Job&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;Test Cron Job&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"># 执行完之后登录以上的某一台服务器进行验证</span><br><span class="line"># crontab  -l</span><br><span class="line">#Ansible: Test Cron Job</span><br><span class="line">*&#x2F;10 * * * * &#x2F;bin&#x2F;echo Test Message</span><br><span class="line"># ansible webserver -m cron -a  &#39;minute&#x3D;&quot;*&#x2F;10&quot; job&#x3D;&quot;&#x2F;bin&#x2F;echo Test Message&quot; name&#x3D;&quot;Test Cron Job&quot; state&#x3D;&quot;absent&quot;&#39;</span><br><span class="line"># 将以上建立的定时任务计划移除</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="user模块-用于建立用户；"><a href="#user模块-用于建立用户；" class="headerlink" title="user模块: 用于建立用户；"></a>user模块: 用于建立用户；</h3><p>name=: 指明需要建立用户的用户名;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible all -m user -a &#39;user&#x3D;&quot;user1&quot;&#39;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 1001, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;user1&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;user1&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 1001</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 1001, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;user1&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;user1&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 1001</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 1001, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;user1&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;user1&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 1001</span><br><span class="line">&#125;</span><br><span class="line"># 验证是否创建了用户</span><br><span class="line"># id user1</span><br><span class="line"># 将以上建立的用户删除</span><br><span class="line"># ansible all -m user -a &#39;user&#x3D;&quot;user1&quot; state&#x3D;&quot;absent&quot;&#39;</span><br><span class="line"># 创建系统用户系统组</span><br><span class="line"># ansible all -m group -a &#39;name&#x3D;&quot;mysql&quot; gid&#x3D;&quot;306&quot; system&#x3D;&quot;yes&quot;&#39; </span><br><span class="line"># ansible all -m user -a &#39;name&#x3D;&quot;mysqld&quot; uid&#x3D;&quot;306&quot; group&#x3D;&quot;mysql&quot; system&#x3D;&quot;yes&quot;&#39; </span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 306, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;mysqld&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;mysqld&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true, </span><br><span class="line">    &quot;uid&quot;: 306</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 306, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;mysqld&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;mysqld&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true, </span><br><span class="line">    &quot;uid&quot;: 306</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 306, </span><br><span class="line">    &quot;home&quot;: &quot;&#x2F;home&#x2F;mysqld&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;mysqld&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;&#x2F;bin&#x2F;bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true, </span><br><span class="line">    &quot;uid&quot;: 306</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="copy模块-用于文件的远程传输"><a href="#copy模块-用于文件的远程传输" class="headerlink" title="copy模块: 用于文件的远程传输;"></a>copy模块: 用于文件的远程传输;</h3><ul>
<li>src=: 定义本地源文件路径;</li>
<li>dest=: 定义远程目标文件路径，但不支持绝对路径;</li>
<li>content=: 取代src=,表示直接用此处指定的信息生成目标文件, <code>但这里要注意的是，会把节点主机的源文件覆盖，类似于 echo &gt; /path/to/file</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible all -m copy -a &#39;src&#x3D;&#x2F;etc&#x2F;fstab dest&#x3D;&#x2F;tmp&#x2F;fstab.ansible owner&#x3D;root mode&#x3D;&quot;640&quot;&#39;  </span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;3858e5b009a8c0828cb529780a2ad547411d8d94&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;fstab.ansible&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;01ea40602497b8cfe5a53743054fa04d&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0640&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 541, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1523241179.42-225211025896206&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;3858e5b009a8c0828cb529780a2ad547411d8d94&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;fstab.ansible&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;01ea40602497b8cfe5a53743054fa04d&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0640&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 541, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1523241179.42-108291746173038&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;3858e5b009a8c0828cb529780a2ad547411d8d94&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;fstab.ansible&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;01ea40602497b8cfe5a53743054fa04d&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0640&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 541, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1523241179.35-169240840464627&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"># ansible all -m copy -a &#39;content&#x3D;&quot;Hellow Ansible\nWelcome to ssjinyao\n&quot; dest&#x3D;&quot;&#x2F;tmp&#x2F;ssjinyao&quot;&#39;</span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;06759ebeeffb1ec2ba32b71d0440258a2ec812ca&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;7da4c3d419470482101fa8cfa338c882&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 35, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1523241579.59-247115936338069&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;06759ebeeffb1ec2ba32b71d0440258a2ec812ca&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;7da4c3d419470482101fa8cfa338c882&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 35, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1523241579.53-265190945061484&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;06759ebeeffb1ec2ba32b71d0440258a2ec812ca&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;7da4c3d419470482101fa8cfa338c882&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 35, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1523241579.58-230356470158720&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"># cat &#x2F;tmp&#x2F;ssjinyao </span><br><span class="line">Hellow Ansible</span><br><span class="line">Welcome to ssjinyao</span><br></pre></td></tr></table></figure>
<h3 id="file-用于设定文件属性"><a href="#file-用于设定文件属性" class="headerlink" title="file: 用于设定文件属性;"></a>file: 用于设定文件属性;</h3><ul>
<li>path=: 指定文件路径, 可以使用name 或dest来替换;</li>
<li>创建文件的符号链接;</li>
<li>src=:指明源文件;</li>
<li>path=: 指明符号链接文件路径;     </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible all -m file -a &#39;owner&#x3D;&quot;mysql&quot; group&#x3D;&quot;mysql&quot; mode&#x3D;&quot;644&quot; path&#x3D;&quot;&#x2F;tmp&#x2F;ssjinyao&quot;&#39;  </span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 306, </span><br><span class="line">    &quot;group&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;size&quot;: 35, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 27</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 306, </span><br><span class="line">    &quot;group&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;size&quot;: 35, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 27</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 306, </span><br><span class="line">    &quot;group&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 35, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 27</span><br><span class="line">&#125;</span><br><span class="line"># ansible all -m file -a &#39;path&#x3D;&quot;&#x2F;tmp&#x2F;ssjinyao.link&quot; src&#x3D;&quot;&#x2F;tmp&#x2F;ssjinyao&quot; state&#x3D;&quot;link&quot;&#39;</span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao.link&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 13, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;tmp&#x2F;172.16&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao.link&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 13, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao.link&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:user_tmp_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 13, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;tmp&#x2F;ssjinyao&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ping-测试远程主机的连接性"><a href="#ping-测试远程主机的连接性" class="headerlink" title="ping: 测试远程主机的连接性;"></a>ping: 测试远程主机的连接性;</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible all -m ping </span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="service-指定运行状态"><a href="#service-指定运行状态" class="headerlink" title="service: 指定运行状态;"></a>service: 指定运行状态;</h3><ul>
<li>enabled=: 是否开机自动启动;</li>
<li>name =: 服务名称;</li>
<li>state =: 状态，取值有started, stopped, restarted;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible webserver -m service -a &quot;enabled&#x3D;true name&#x3D;httpd state&#x3D;started&quot;</span><br></pre></td></tr></table></figure>
<h3 id="shell-在远程主机运行命令"><a href="#shell-在远程主机运行命令" class="headerlink" title="shell: 在远程主机运行命令;"></a>shell: 在远程主机运行命令;</h3><p>尤其是用到管道等复杂命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible all -m shell -a &#39;echo &quot;xxxxxxxx&quot; | passwd --stdin user1 &#39;         </span><br><span class="line">172.16.55.123 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">更改用户 user1 的密码 。</span><br><span class="line">passwd：所有的身份验证令牌已经成功更新。</span><br><span class="line"></span><br><span class="line">172.16.55.124 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">更改用户 user1 的密码 。</span><br><span class="line">passwd：所有的身份验证令牌已经成功更新。</span><br><span class="line"></span><br><span class="line">172.16.55.125 | SUCCESS | rc&#x3D;0 &gt;&gt;</span><br><span class="line">更改用户 user1 的密码 。</span><br><span class="line">passwd：所有的身份验证令牌已经成功更新。</span><br></pre></td></tr></table></figure>
<h3 id="script-将本地脚本复制到远程主机上并运行之"><a href="#script-将本地脚本复制到远程主机上并运行之" class="headerlink" title="script:  将本地脚本复制到远程主机上并运行之;"></a>script:  将本地脚本复制到远程主机上并运行之;</h3><p>注意: 要使用相对路径指定脚本;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat test.sh       </span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">sum&#x3D;0</span><br><span class="line">for i in &#123;1..100&#125;; do </span><br><span class="line">        sum&#x3D;$[$sum+$i]</span><br><span class="line">done</span><br><span class="line">    echo $sum</span><br><span class="line">    </span><br><span class="line"># chmod +x test.sh </span><br><span class="line"># ansible all -m script -a &quot;&#x2F;tmp&#x2F;test.sh&quot;</span><br><span class="line">172.16.55.123 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 172.16.55.123 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;5050\r\n&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: [</span><br><span class="line">        &quot;5050&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.124 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 172.16.55.124 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;5050\r\n&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: [</span><br><span class="line">        &quot;5050&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">172.16.55.125 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 172.16.55.125 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;5050\r\n&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: [</span><br><span class="line">        &quot;5050&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="yum-安装程序包"><a href="#yum-安装程序包" class="headerlink" title="yum: 安装程序包;"></a>yum: 安装程序包;</h3><ul>
<li>name=: 指明要安装的程序包，可以带上版本号;</li>
<li>state=: present, latest表示安装，absent表示卸载;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansible all -m yum -a &#39;name&#x3D;&quot;zsh&quot; state&#x3D;&quot;present&quot;&#39;</span><br><span class="line"># ansible all -m yum -a &#39;name&#x3D;&quot;zsh&quot; state&#x3D;&quot;absent&quot;&#39;</span><br></pre></td></tr></table></figure>
<h3 id="setup-收集远程主机的facts"><a href="#setup-收集远程主机的facts" class="headerlink" title="setup: 收集远程主机的facts;"></a>setup: 收集远程主机的facts;</h3><ul>
<li>每个被管理节点在接收并运行管理命令之前，会将自己主机相关信息；</li>
<li>如操作系统版本、IP地址等报告给远程的ansible主机;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查看远程节点的服务器信息，方便我们调用配置</span><br><span class="line"># ansible all -m setup</span><br></pre></td></tr></table></figure>
<h2 id="ansible-playbook-剧本-的使用"><a href="#ansible-playbook-剧本-的使用" class="headerlink" title="ansible-playbook(剧本) 的使用"></a>ansible-playbook(剧本) 的使用</h2><h3 id="playbook的核心元素"><a href="#playbook的核心元素" class="headerlink" title="playbook的核心元素;"></a>playbook的核心元素;</h3><ul>
<li>taskfs:任务</li>
<li>variadble: 变量</li>
<li>templates: 模板</li>
<li>handlers: 处理器</li>
<li>roles:角色</li>
</ul>
<h3 id="YAML-介绍"><a href="#YAML-介绍" class="headerlink" title="YAML 介绍;"></a>YAML 介绍;</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">YAML 是一个可读性高的用来表达资料序列的格式，YAML参考了其他多处语言;</span><br><span class="line">包括:XML、C语言、Python、Perl以及电子邮件格式等</span><br><span class="line">Clark Evans在2001年首次发表了这种语言</span><br><span class="line"></span><br><span class="line">YAML Ain&#39;t Markup Language, 即YAML不是XML。不过，在开发的这种语言时;</span><br><span class="line">YAML的意思其实是:&quot;Yet Another Markup Language(仍是一种标记语言)。&quot;其特性:</span><br><span class="line"></span><br><span class="line">YAML的可读性好</span><br><span class="line">YAML 和脚本语言的交互性好</span><br><span class="line">YAML 使用实现语言的数据类型</span><br><span class="line">YAML 有一个一致的信息模型</span><br><span class="line">YAML 易于实现</span><br><span class="line">YAML 可以基于流来处理</span><br><span class="line">YAML 表达能力强，扩展性好</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构; </span><br><span class="line">其结构(Structure)通过空格来展示，序列(Sequence)里的项用&quot;-&quot;来代表，Map里的键值用&quot;;&quot;分隔</span><br></pre></td></tr></table></figure>
<h3 id="ansible变量"><a href="#ansible变量" class="headerlink" title="ansible变量:"></a>ansible变量:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">变量命名</span><br><span class="line">    变量名仅能由字母、数字和下划线组成，且只能以字母开头;</span><br><span class="line"> facts</span><br><span class="line">    facts是由正在通信的远程目标主机发回的信息，这些信息被保存在ansible变量中;</span><br><span class="line">    要获取指定的远程主机所支持的所有facts，可使用如下命令进行;</span><br><span class="line"># ansible hostname -m setup</span><br><span class="line">register</span><br><span class="line">把任务的输出定义为变量，然后用于其他任务，示例如下:</span><br><span class="line">  tasks:</span><br><span class="line">     - shell: &#x2F;usr&#x2F;bin&#x2F;foo</span><br><span class="line">       register: foo_result</span><br><span class="line">       ignore_errors: True</span><br><span class="line">    - hosts: websrvs</span><br><span class="line">      remote_user: root</span><br><span class="line">      tasks:</span><br><span class="line">      - name: copy file</span><br><span class="line">        copy: content&#x3D;&quot;&#123;&#123; ansible_all_ipv4_address &#125;&#125;&quot; dest&#x3D;&#x2F;tmp&#x2F;var.dns</span><br><span class="line"></span><br><span class="line">通过命令行传递变量</span><br><span class="line">在运行playbook的时候也可以传递一些变量供playbook使用，示例如下：</span><br><span class="line">	ansible-playbook test.yml --extra-vars &quot;hosts&#x3D;www user&#x3D;ssjinyao&quot;</span><br><span class="line">通过roles传递变量</span><br><span class="line">当给一个主机应用角色的时候可以传递变量，然后在角色内使用这些变量，示例如下：</span><br><span class="line">	- hosts: webservers</span><br><span class="line">	  roles:</span><br><span class="line">	    - common</span><br><span class="line">	    - &#123; role: foo_app_instance, dir: &#39;&#x2F;web&#x2F;htdocs&#x2F;a.com&#39;,  port: 8080 &#125;</span><br><span class="line">Inventory</span><br><span class="line">    ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机;</span><br><span class="line">    可以在inventory file中将其分组命名，默认的inventory file为&#x2F;etc&#x2F;ansible&#x2F;hosts;</span><br><span class="line">    inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成;</span><br><span class="line">inventory文件格式</span><br><span class="line">    inventory文件遵循INI文件风格，中括号中的字符为组名;</span><br><span class="line">    可以将同一个主机同时归并到多个不同的组中；</span><br><span class="line">    此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明;</span><br><span class="line">	</span><br><span class="line">        	[webservers]</span><br><span class="line">            web1.ssjinyao.com:25181</span><br><span class="line">            web2.ssjinyao.com</span><br><span class="line">        	[dbservers]</span><br><span class="line">        	db1.ssjinyao</span><br><span class="line">        	db2.ssjinyao.com</span><br><span class="line">        	db3.ssjinyao.com</span><br><span class="line">	如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机，例如：</span><br><span class="line"></span><br><span class="line">            [webservers]</span><br><span class="line">            www[01:50].ssjinyao.com</span><br><span class="line">            [databases]</span><br><span class="line">            db-[a:f].ssjinyao.com</span><br><span class="line"></span><br><span class="line">主机变量</span><br><span class="line">    可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用。例如：</span><br><span class="line">        [webservers]</span><br><span class="line">        web1.ssjinyao.com http_port&#x3D;80 maxRequestsPerChild&#x3D;808</span><br><span class="line">        web2.ssjinyao.com http_port&#x3D;8080 maxRequestsPerChild&#x3D;909</span><br><span class="line"></span><br><span class="line">组变量</span><br><span class="line">    组变量是指赋予给指定组内所有主机上的在playbook中可用的变量。例如：</span><br><span class="line">    [webservers]</span><br><span class="line">    web1.ssjinyao.com</span><br><span class="line">    web2.ssjinyao.com</span><br><span class="line">    </span><br><span class="line">    [webservers:vars]</span><br><span class="line">    ntp_server&#x3D;web1.ssjinyao.com</span><br><span class="line">    nfs_server&#x3D;web2.ssjinyao.com</span><br><span class="line"></span><br><span class="line">组嵌套</span><br><span class="line">    在inventory中组还可以包含其它的组，并且也可以向组中的主机指定变量;</span><br><span class="line">    不过，这些变量只能在ansible-playbook中使用，而ansible不支持;</span><br><span class="line">    </span><br><span class="line">[apache]</span><br><span class="line">httpd1.ssjinyao.com</span><br><span class="line">httpd2.ssjinyao.com</span><br><span class="line">[nginx]</span><br><span class="line">nginx1.ssjinyao.com</span><br><span class="line">nginx2.ssjinyao.com</span><br><span class="line">[webservers:children]</span><br><span class="line">apache</span><br><span class="line">nginx</span><br><span class="line">[webservers:vars]</span><br><span class="line">ntp_server&#x3D;ntp.ssjinyao.com</span><br><span class="line">    inventory参数</span><br><span class="line">        ansible基于ssh连接inventory中指定的远程主机时，还可以通过参数指定其交互方式；这些参数如下所示：</span><br><span class="line">            ansible_ssh_host</span><br><span class="line">                The name of the host to connect to, if different from the alias you wish to give to it.</span><br><span class="line">            ansible_ssh_port</span><br><span class="line">                The ssh port number, if not 22</span><br><span class="line">            ansible_ssh_user</span><br><span class="line">                The default ssh user name to use.</span><br><span class="line">            ansible_ssh_pass</span><br><span class="line">                The ssh password to use (this is insecure, we strongly recommend using --ask-pass or SSH keys)</span><br><span class="line">            ansible_sudo_pass</span><br><span class="line">                The sudo password to use (this is insecure, we strongly recommend using --ask-sudo-pass)</span><br><span class="line">            ansible_connection</span><br><span class="line">                Connection type of the host. Candidates are local, ssh or paramiko.  The default is paramiko before         </span><br><span class="line">                Ansible 1.2, and &#39;smart&#39; afterwards which detects whether usage of &#39;ssh&#39; would be feasible based on         </span><br><span class="line">                whether ControlPersist is supported.</span><br><span class="line">        ansible_ssh_private_key_file</span><br><span class="line">                Private key file used by ssh.  Useful if using multiple keys and you don&#39;t want to use SSH agent.</span><br><span class="line">ansible_shell_type</span><br><span class="line">                The shell type of the target system. By default commands are formatted using &#39;sh&#39;-style syntax by default. </span><br><span class="line">                Setting this to &#39;csh&#39; or &#39;fish&#39; will cause commands executed on target systems to follow those shell&#39;s syntax instead.</span><br><span class="line">            ansible_python_interpreter</span><br><span class="line">                The target host python path. This is useful for systems with more</span><br><span class="line">                than one Python or not located at &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot; such as \*BSD, or where &#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line">                is not a 2.X series Python.  We do not use the &quot;&#x2F;usr&#x2F;bin&#x2F;env&quot; mechanism as that requires the remote user&#39;s</span><br><span class="line">                path to be set right and also assumes the &quot;python&quot; executable is named python, where the executable might</span><br><span class="line">                 be named something like &quot;python26&quot;.</span><br><span class="line">                ansible\_\*\_interpreter</span><br><span class="line">                Works for anything such as ruby or perl and works just like ansible_python_interpreter.</span><br><span class="line">                This replaces shebang of modules which will run on that host.</span><br></pre></td></tr></table></figure>
<h3 id="条件测试"><a href="#条件测试" class="headerlink" title="条件测试"></a>条件测试</h3><p>如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试;</p>
<h3 id="when语句"><a href="#when语句" class="headerlink" title="when语句"></a>when语句</h3><p>在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  - name: &quot;shutdown Debian flavored systems&quot;</span><br><span class="line">    command: &#x2F;sbin&#x2F;shutdown -h now</span><br><span class="line">    when: ansible_os_family &#x3D;&#x3D; &quot;Debian&quot;</span><br><span class="line"># when语句中还可以使用Jinja2的大多“filter”;</span><br><span class="line"># 例如要忽略此前某语句的错误并基于其结果（failed或者sucess）运行后面指定的语句</span><br><span class="line">tasks:</span><br><span class="line">  - command: &#x2F;bin&#x2F;false</span><br><span class="line">    register: result</span><br><span class="line">    ignore_errors: True</span><br><span class="line">  - command: &#x2F;bin&#x2F;something</span><br><span class="line">    when: result|failed</span><br><span class="line">  - command: &#x2F;bin&#x2F;something_else</span><br><span class="line">    when: result|success</span><br><span class="line">  - command: &#x2F;bin&#x2F;still&#x2F;something_else</span><br><span class="line">    when: result|skipped</span><br><span class="line">- hosts: all </span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">  - username: user10</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create &#123;&#123; username &#125;&#125; user</span><br><span class="line">    user: name&#x3D;&#123;&#123;username&#125;&#125;</span><br><span class="line">    when: ansible_fqdn &#x3D;&#x3D; &quot;fabric2&quot;</span><br><span class="line"># when语句中还可以使用facts或playbook中定义的变量;</span><br></pre></td></tr></table></figure>
<h3 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 当有需要重复性执行的任务时，可以使用迭代机制;</span><br><span class="line"># 其使用格式为将需要迭代的内容定义为item变量引用，并通过with_items语句来指明迭代的元素列表</span><br><span class="line">- name: add several users</span><br><span class="line">  user: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present groups&#x3D;wheel</span><br><span class="line">  with_items:</span><br><span class="line">     - testuser1</span><br><span class="line">     - testuser2</span><br><span class="line"># 上面语句功能等同于下面语句的功能</span><br><span class="line">- name: add user testuser1</span><br><span class="line">  user: name&#x3D;testuser1 state&#x3D;present groups&#x3D;wheel</span><br><span class="line">- name: add user testuser2</span><br><span class="line">  user: name&#x3D;testuser2 state&#x3D;present groups&#x3D;wheel</span><br><span class="line"># with_items中可以使用元素还可为hashes</span><br><span class="line">- name: add several users</span><br><span class="line">  user: name&#x3D;&#123;&#123; item.name &#125;&#125; state&#x3D;present groups&#x3D;&#123;&#123; item.groups &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; name: &#39;testuser1&#39;, groups: &#39;wheel&#39; &#125;</span><br><span class="line">    - &#123; name: &#39;testuser2&#39;, groups: &#39;root&#39; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Host和User"><a href="#Host和User" class="headerlink" title="Host和User"></a>Host和User</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务;</span><br><span class="line"># hosts用于指定要执行指定任务的主机，其可以是一个或多个由冒号分隔主机组</span><br><span class="line"># remote_user则用于指定远程主机上的执行任务的用户;</span><br><span class="line">		-hosts: webnodes</span><br><span class="line">		 remote_user: root</span><br><span class="line"></span><br><span class="line"># remote_user也可用于各task中;</span><br><span class="line"># 也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务;</span><br><span class="line"># 可以在sudo时使用sudo_user指定sudo时切换的用户。</span><br><span class="line"></span><br><span class="line">		- hosts: webnodes</span><br><span class="line">		  remote_user: ssjinyao</span><br><span class="line">		  tasks:</span><br><span class="line">		    - name: test connection</span><br><span class="line">		      ping:</span><br><span class="line">		      remote_user: ssjinyao</span><br><span class="line">		      sudo: yes</span><br></pre></td></tr></table></figure>
<h3 id="任务列表与action"><a href="#任务列表与action" class="headerlink" title="任务列表与action"></a>任务列表与action</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># play的主体部分是task list;</span><br><span class="line"># task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后再开始第二个</span><br><span class="line"># 在运行自下而下某playbook时，如果中途发生错误，所有已执行任务都将回滚，因此，在更正playbook后重新执行一次即可;</span><br><span class="line"># task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量;</span><br><span class="line"># 模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致;</span><br><span class="line"># 每个task都应该有其name，用于playbook的执行结果输出;</span><br><span class="line"># 建议其内容尽可能清晰地描述任务执行步骤,如果未提供name，则action的结果将用于输出。</span><br><span class="line"></span><br><span class="line"># 定义task的可以使用“action: module options”或“module: options”的格式，推荐使用后者以实现向后兼容;</span><br><span class="line"># 如果action一行的内容过多，也中使用在行首使用几个空白字符进行换行。</span><br><span class="line">		tasks:</span><br><span class="line">		  - name: make sure apache is running</span><br><span class="line">		    service: name&#x3D;httpd state&#x3D;running</span><br><span class="line"># 在众多模块中，只有command和shell模块仅需要给定一个列表而无需使用“key&#x3D;value”格式，例如：</span><br><span class="line">			tasks:</span><br><span class="line">			  - name: disable selinux</span><br><span class="line">			    command: &#x2F;sbin&#x2F;setenforce 0</span><br><span class="line"># 如果命令或脚本的退出码不为零，可以使用如下方式替代：</span><br><span class="line">			tasks:</span><br><span class="line">			  - name: run this command and ignore the result</span><br><span class="line">			    shell: &#x2F;usr&#x2F;bin&#x2F;somecommand || &#x2F;bin&#x2F;true</span><br><span class="line"># 或者使用ignore_errors来忽略错误信息：</span><br><span class="line">			tasks:</span><br><span class="line">			  - name: run this command and ignore the result</span><br><span class="line">			    shell: &#x2F;usr&#x2F;bin&#x2F;somecommand</span><br><span class="line">			    ignore_errors: True		</span><br></pre></td></tr></table></figure>
<h3 id="handlers"><a href="#handlers" class="headerlink" title="handlers"></a>handlers</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 用于当关注的资源发生变化时采取一定的操作;</span><br><span class="line"># “notify”这个action可用于在每个play的最后被触发;</span><br><span class="line"># 这样可以避免多次有改变发生时每次都执行指定的操作，取而代之;</span><br><span class="line"># 仅在所有的变化发生完成后一次性地执行指定操作;</span><br><span class="line"># 在notify中列出的操作称为handler，也即notify中调用handler中定义的操作;</span><br><span class="line">	- name: template configuration file</span><br><span class="line">	  template: src&#x3D;template.j2 dest&#x3D;&#x2F;etc&#x2F;foo.conf</span><br><span class="line">	  notify:</span><br><span class="line">	     - restart memcached</span><br><span class="line">	     - restart apache	</span><br><span class="line"># handler是task列表，这些task与前述的task并没有本质上的不同;</span><br><span class="line">	handlers:</span><br><span class="line">	    - name: restart memcached</span><br><span class="line">	      service:  name&#x3D;memcached state&#x3D;restarted</span><br><span class="line">	    - name: restart apache</span><br><span class="line">	      service: name&#x3D;apache state&#x3D;restarted</span><br></pre></td></tr></table></figure>
<h3 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ansilbe自1.2版本引入的新特性，用于层次性、结构化地组织playbook;</span><br><span class="line"># roles能够根据层次型结构自动装载变量文件、tasks以及handlers等;</span><br><span class="line"># 要使用roles只需要在playbook中使用include指令即可;</span><br><span class="line"># roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中;</span><br><span class="line"># 并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中;</span><br><span class="line">    一个roles的案例如下所示：</span><br><span class="line">    site.yml</span><br><span class="line">    webservers.yml</span><br><span class="line">    fooservers.yml</span><br><span class="line">    roles&#x2F;</span><br><span class="line">       common&#x2F;</span><br><span class="line">         files&#x2F;</span><br><span class="line">         templates&#x2F;</span><br><span class="line">         tasks&#x2F;</span><br><span class="line">         handlers&#x2F;</span><br><span class="line">         vars&#x2F;</span><br><span class="line">         meta&#x2F;</span><br><span class="line">       webservers&#x2F;</span><br><span class="line">         files&#x2F;</span><br><span class="line">         templates&#x2F;</span><br><span class="line">         tasks&#x2F;</span><br><span class="line">         handlers&#x2F;</span><br><span class="line">         vars&#x2F;</span><br><span class="line">         meta&#x2F;</span><br><span class="line">而在playbook中，可以这样使用roles：</span><br><span class="line">    ---</span><br><span class="line">    </span><br><span class="line">    - hosts: webservers</span><br><span class="line">    roles:</span><br><span class="line">     - common</span><br><span class="line">     - webservers</span><br><span class="line">    也可以向roles传递参数，例如：</span><br><span class="line">    ---</span><br><span class="line">    </span><br><span class="line">    - hosts: webservers</span><br><span class="line">    roles:</span><br><span class="line">    - common</span><br><span class="line">    - &#123; role: foo_app_instance, dir: &#39;&#x2F;opt&#x2F;a&#39;,  port: 5000 &#125;</span><br><span class="line">    - &#123; role: foo_app_instance, dir: &#39;&#x2F;opt&#x2F;b&#39;,  port: 5001 &#125;</span><br><span class="line">    </span><br><span class="line">    甚至也可以条件式地使用roles，例如：</span><br><span class="line">    ---</span><br><span class="line">    </span><br><span class="line">    - hosts: webservers</span><br><span class="line">    roles:</span><br><span class="line">    - &#123; role: some_role, when: &quot;ansible_os_family &#x3D;&#x3D; &#39;RedHat&#39;&quot; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建role的步骤"><a href="#创建role的步骤" class="headerlink" title="创建role的步骤"></a>创建role的步骤</h3><ul>
<li>创建以roles命名的目录；</li>
<li>在roles目录中分别创建以各角色名称命名的目录，如webservers等；</li>
<li>在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；</li>
<li>用不到的目录可以创建为空目录，也可以不创建；</li>
<li>在playbook文件中，调用各角色；</li>
</ul>
<h3 id="role内各目录中可用的文件"><a href="#role内各目录中可用的文件" class="headerlink" title="role内各目录中可用的文件"></a>role内各目录中可用的文件</h3><ol>
<li>tasks目录：至少应该包含一个名为main.yml的文件，其定义了此角色的任务列表；此文件可以使用include包含其它的位于此目录中的task文件;</li>
<li>files目录：存放由copy或script等模块调用的文件;</li>
<li>templates目录：template模块会自动在此目录中寻找Jinja2模板文件;</li>
<li>handlers目录：此目录中应当包含一个main.yml文件，用于定义此角色用到的各handler；在handler中使用include包含的其它的handler文件也应该位于此目录中;</li>
<li>vars目录：应当包含一个main.yml文件，用于定义此角色用到的变量;</li>
<li>meta目录：应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系;</li>
<li>ansible 1.3及其以后的版本才支持;</li>
<li>default目录：为当前角色设定默认变量时使用此目录；应当包含一个main.yml文件;</li>
</ol>
<h3 id="Tags"><a href="#Tags" class="headerlink" title="Tags"></a>Tags</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tags用于让用户选择运行或路过playbook中的部分代码;</span><br><span class="line">ansible具有幂等性，因此会自动跳过没有变化的部分;</span><br><span class="line">有些代码为测试其确实没有发生变化的时间依然会非常地长;</span><br><span class="line">此时，如果确信其没有变化，就可以通过tags跳过此些代码片断。</span><br></pre></td></tr></table></figure>
<ol>
<li>目录名同角色名;</li>
<li>目录结构有固定格式;</li>
<li>files: 表态文件;</li>
</ol>
<ul>
<li>templates: Jinjia2模板文件;</li>
<li>tasks:至少有main.yml文件，定义各tasks;</li>
<li>handlers: 至少有一个main.yml文件，定义各handlers;</li>
<li>vars:至少有一个mian.yml文件，定义变量;</li>
<li>meta:定义依赖关系等信息;</li>
<li>site.yml中定义playbook，额外也可以有其它的yml文件;</li>
</ul>
<h3 id="ansible-playbook使用示例"><a href="#ansible-playbook使用示例" class="headerlink" title="ansible-playbook使用示例"></a>ansible-playbook使用示例</h3><h4 id="在webserver中执行简单管理类命令"><a href="#在webserver中执行简单管理类命令" class="headerlink" title="在webserver中执行简单管理类命令"></a>在webserver中执行简单管理类命令</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: create nginx group</span><br><span class="line">    group: name&#x3D;nginx system&#x3D;yes gid&#x3D;208</span><br><span class="line">  - name: create nginx user</span><br><span class="line">    user: name&#x3D;nginx uid&#x3D;208 group&#x3D;nginx system&#x3D;yes</span><br><span class="line">- hosts: dbserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: copy file to db_servers</span><br><span class="line">    copy: src&#x3D;&#x2F;etc&#x2F;inittab dest&#x3D;&#x2F;tmp&#x2F;inittab.ans## ansible-playbook test.yml</span><br></pre></td></tr></table></figure>
<h4 id="heartbeat-部署"><a href="#heartbeat-部署" class="headerlink" title="heartbeat 部署"></a>heartbeat 部署</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">heartbeat.yaml</span><br><span class="line">- hosts: hbhosts</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: ensure heartbeat latest version</span><br><span class="line">      yum: name&#x3D;heartbeat state&#x3D;present</span><br><span class="line">    - name: authkeys configure file</span><br><span class="line">      copy: src&#x3D;&#x2F;root&#x2F;hb_conf&#x2F;authkeys dest&#x3D;&#x2F;etc&#x2F;ha.d&#x2F;authkeys</span><br><span class="line">    - name: authkeys mode 600</span><br><span class="line">      file: path&#x3D;&#x2F;etc&#x2F;ha.d&#x2F;authkeys mode&#x3D;600</span><br><span class="line">      notify:</span><br><span class="line">        - restart heartbeat</span><br><span class="line">    - name: ha.cf configure file</span><br><span class="line">      copy: src&#x3D;&#x2F;root&#x2F;hb_conf&#x2F;ha.cf dest&#x3D;&#x2F;etc&#x2F;ha.d&#x2F;ha.cf</span><br><span class="line">      notify: </span><br><span class="line">       	- restart heartbeat</span><br><span class="line">  handlers:</span><br><span class="line">  	- name: restart heartbeat</span><br><span class="line">  	  service: name&#x3D;heartbeat state&#x3D;restarted</span><br></pre></td></tr></table></figure>
<h4 id="系统环境初始化"><a href="#系统环境初始化" class="headerlink" title="系统环境初始化"></a>系统环境初始化</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--- </span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Add mongodb 3.4 yum repo</span><br><span class="line">      template: src&#x3D;.&#x2F;yum&#x2F;mongo34.repo dest&#x3D;&#x2F;etc&#x2F;yum.repos.d&#x2F;</span><br><span class="line">    - name: Yum remove old mongodb</span><br><span class="line">      yum: name&#x3D;mongodb state&#x3D;removed update_cache&#x3D;true</span><br><span class="line">    - name: Yum install mongodb 3.4</span><br><span class="line">      yum: name&#x3D;mongodb-org state&#x3D;installed update_cache&#x3D;true</span><br><span class="line">    - name: Mongo shell edit</span><br><span class="line">      shell: |</span><br><span class="line">        killall mongod</span><br><span class="line">        echo &#39;never&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br><span class="line">        echo &#39;never&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;defrag</span><br><span class="line">    - name: start mongodb</span><br><span class="line">      service: name&#x3D;mongod state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">    - name: Create mongo user and passwd admin xxxxxx</span><br><span class="line">      mongodb_user: </span><br><span class="line">        name: &quot;admin&quot; </span><br><span class="line">        password: &quot;xxxxxxssjinyao.com&quot; </span><br><span class="line">        database: &quot;admin&quot;</span><br><span class="line">        roles: &quot;userAdminAnyDatabase&quot; </span><br><span class="line">        state: &quot;present&quot;</span><br><span class="line">      yum: name&#x3D;mod_ssl state&#x3D;installed update_cache&#x3D;true</span><br><span class="line">    - name: Install git</span><br><span class="line">      yum: name&#x3D;git state&#x3D;installed update_cache&#x3D;true</span><br><span class="line">    - name: Install tree</span><br><span class="line">      yum: name&#x3D;tree state&#x3D;installed update_cache&#x3D;true</span><br><span class="line"></span><br><span class="line">    - name: Install any packages</span><br><span class="line">      yum: name&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;installed update_cache&#x3D;true</span><br><span class="line">      with_items:</span><br><span class="line">        - libffi</span><br><span class="line">        - libffi-devel</span><br><span class="line">        - openssl</span><br><span class="line">        - openssl-devel</span><br><span class="line">        - libxml2</span><br><span class="line">        - libxml2-devel</span><br><span class="line">        - libjpeg-turbo</span><br><span class="line">        - libjpeg-turbo-devel</span><br><span class="line"></span><br><span class="line">    - name: Install any packages2</span><br><span class="line">      yum: name&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;installed update_cache&#x3D;true</span><br><span class="line">      with_items:</span><br><span class="line">        - zlib</span><br><span class="line">        - zlib-devel</span><br><span class="line">        - vim</span><br><span class="line">        - httpd</span><br><span class="line">        - mariadb-server</span><br><span class="line">        - redis</span><br><span class="line">        - php</span><br><span class="line">        - php-intl</span><br><span class="line">        - php-pear</span><br><span class="line">        - php-devel</span><br><span class="line">        - libicu</span><br><span class="line">        - libicu-devel</span><br><span class="line">        - git</span><br><span class="line">        - centos-release-scl</span><br><span class="line"></span><br><span class="line">    - name: Install any packages3</span><br><span class="line">      yum: name&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;present update_cache&#x3D;true</span><br><span class="line">      with_items:</span><br><span class="line">        - python-pip</span><br><span class="line">        - python-devel</span><br><span class="line">        - gcc</span><br><span class="line">        - gcc-c++</span><br><span class="line">        - kernel-devel </span><br><span class="line">        - make</span><br><span class="line">        - MySQL-python</span><br><span class="line">        - php-mysql</span><br><span class="line">        - php-gd</span><br><span class="line">        - mysql-devel</span><br><span class="line">        - libcurl</span><br><span class="line">        - libcurl-devel</span><br><span class="line">        - python-lxml </span><br><span class="line"></span><br><span class="line">    - name: Install any packages4</span><br><span class="line">      yum: name&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;present update_cache&#x3D;true</span><br><span class="line">      with_items:</span><br><span class="line">        - php55</span><br><span class="line">        - php-pecl-mongo</span><br><span class="line">        - php55-php</span><br><span class="line">        - php55-php-gd</span><br><span class="line">        - php55-php-mbstring</span><br><span class="line">        - php55-php-devel</span><br><span class="line">        - php55-php-mysqlnd</span><br><span class="line">        - php55-php-ldap</span><br><span class="line">        - php55-php-intl</span><br><span class="line">        - php55-php-pear</span><br><span class="line">        - php55-php-mongo</span><br><span class="line">        - unzip</span><br><span class="line"></span><br><span class="line">    - name: Install any packages5 other, you can add</span><br><span class="line">      yum: name&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;present update_cache&#x3D;true</span><br><span class="line">      with_items: </span><br><span class="line">        - readline-devel</span><br><span class="line">        - patch</span><br><span class="line"></span><br><span class="line">    - name: Copy php-55 config file to etc</span><br><span class="line">      copy: remote_src&#x3D;True src&#x3D;&#x2F;opt&#x2F;rh&#x2F;httpd24&#x2F;root&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;php55-php.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;</span><br><span class="line">    - name: Copy php-55 httpd modules to etc</span><br><span class="line">      copy: remote_src&#x3D;True src&#x3D;&#x2F;opt&#x2F;rh&#x2F;httpd24&#x2F;root&#x2F;etc&#x2F;httpd&#x2F;conf.modules.d&#x2F;10-php55-php.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;</span><br><span class="line">    - name: Copy php-55 httpd moduels to etc</span><br><span class="line">      copy: remote_src&#x3D;True src&#x3D;&#x2F;opt&#x2F;rh&#x2F;httpd24&#x2F;root&#x2F;etc&#x2F;httpd&#x2F;modules&#x2F;libphp55-php5.so dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;modules&#x2F;</span><br><span class="line"></span><br><span class="line">    - name: pip install any packages</span><br><span class="line">      pip: name&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;present</span><br><span class="line">      with_items:</span><br><span class="line">        - supervisor</span><br><span class="line">        - virtualenv</span><br><span class="line">        - celery</span><br><span class="line">        - flower</span><br><span class="line">        - mongo</span><br><span class="line">        - redis</span><br><span class="line"></span><br><span class="line">    - name: echo a messages</span><br><span class="line">      shell: |</span><br><span class="line">        ifconfig &amp;&gt; &#x2F;tmp&#x2F;test.ifconfig</span><br><span class="line">        netstat -ant &amp;&gt; &#x2F;tmp&#x2F;test.netstat</span><br><span class="line">        exit 0</span><br><span class="line">      notify:</span><br><span class="line">        - start nginx </span><br><span class="line">    - name: Add redis config file </span><br><span class="line">      template: src&#x3D;.&#x2F;redis&#x2F;redis.conf dest&#x3D;&#x2F;etc&#x2F;</span><br><span class="line"></span><br><span class="line">    - name: start redis </span><br><span class="line">      service: name&#x3D;redis  state&#x3D;started</span><br><span class="line"></span><br><span class="line">    - name: stop apache </span><br><span class="line">      service: name&#x3D;httpd state&#x3D;stopped</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: start nginx</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;started</span><br><span class="line">    - name: restart httpd</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;restarted</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbix监控实现文档</title>
    <url>/2018/04/02/zabbix%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="Zabbix-监控实现文档"><a href="#Zabbix-监控实现文档" class="headerlink" title="Zabbix 监控实现文档"></a>Zabbix 监控实现文档</h1><p><img src="/images/zabbix_chatu.png" class="lazyload" data-srcset="/images/zabbix_chatu.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="理论知识了解"><a href="#理论知识了解" class="headerlink" title="理论知识了解"></a>理论知识了解</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">传感器;</span><br><span class="line">数据采集 --&gt; 数据存储 --&gt; 数据展示; </span><br><span class="line">        报警: 采集到的数据超出阈值时，通常会执行报警操作;</span><br><span class="line">        时间序列数据;</span><br><span class="line">大规模的监控:        </span><br><span class="line">开源监控工具: </span><br><span class="line">    Nagios</span><br><span class="line">有两种结点类型: </span><br><span class="line">NMS(网络监控系统)，周期性的完成数据采集,且最重要的是要完成存储，不仅仅是主机。更重要的路由器;  </span><br><span class="line">SNMP 对其它物理设备进行监控, Simple Network Management Protocol  </span><br><span class="line">一般而言要对其它结点中安装agent端; </span><br><span class="line">SNMP的工作模式:</span><br><span class="line">        NMS向agent采集数据;</span><br><span class="line">        agent向NMS报告数据;</span><br><span class="line">        NMS请求agent修改配置;</span><br></pre></td></tr></table></figure>
<h3 id="SNMP的组件"><a href="#SNMP的组件" class="headerlink" title="SNMP的组件"></a>SNMP的组件</h3><p>MIB: management information base;<br>SMI: MIB表示符号;<br>SNMP协议中的 NMS;<br>SNMP协议的版本;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">v1,v2,v3</span><br><span class="line">v2c:NMS --&gt; agent</span><br><span class="line">v3:认证、加密、 解密</span><br></pre></td></tr></table></figure>
<p>NMS 可以发起的操作:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get, GetNext，Set, Trap(捕获);</span><br><span class="line">agent: Response,返回一个或者多个值;</span><br><span class="line">UDP  NMS:161端口  agent:162端口;</span><br><span class="line">cacti: 可以调用编程接口，利用SNMP，即时绘制展示图形;</span><br><span class="line">cacti: 报警能力是非常弱的;</span><br><span class="line">    万一服务莫名奇妙的的关闭了，可以尝试启动服务，启动不了后再执行报警操作;</span><br><span class="line">    为避免误判，应要多次采样;</span><br><span class="line">Nagios: 可以调用各种报警工具来执行报警操作;</span><br><span class="line">    报警次数据和报警范围，报警范围的操作; </span><br><span class="line">    代码上线的时候不需要报警，且要定义不报警时间段;</span><br><span class="line">    Nagios 可以理解为一个非常强大的报警工具; </span><br><span class="line">    NMS 可能要监控数万个指标，那么会对NMS 的磁盘IO,网络带宽，CPU负载等造成较大的压力;</span><br><span class="line">        我们可以对设备与网络划分，部署多套监控系统，而且它们是用不同的方法实现的;  </span><br><span class="line">        但这样对我们的针对式管理就会带来巨大的麻烦;</span><br><span class="line">        完成状态转换，并完成报警;</span><br><span class="line">        cacti 完成数据收集和展示，但对于报警能力比较薄弱;  </span><br></pre></td></tr></table></figure>
<p>Zabbix:结合了以上两种工具的功能; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、zabbix 会自己先解决</span><br><span class="line">2、zabbix 解决不了报警给部门负责人</span><br><span class="line">3、zabbix 继续报警升级，报警给部门负责人, 部门领导</span><br></pre></td></tr></table></figure>
<p>著名的开源监控工具: zabbix, zennos, opennms, cacti, nagios(icinga),ganglia</p>
<p>(NMS linux) (被监控端 Linux主机) </p>
<h3 id="监控功能的实现"><a href="#监控功能的实现" class="headerlink" title="监控功能的实现:"></a>监控功能的实现:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、agent </span><br><span class="line">2、ssh</span><br><span class="line">3、SIMP</span><br><span class="line">4、IPMI 智慧平台管理接口</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zabbix NMS 与 agent 端双方支持的协议(JSON,XML)</span><br><span class="line">视图(读操作&#x2F;写操作各定义一个团体)</span><br><span class="line">在linux上要使用snmp功能要使用&quot;Linux: net-snmp程序包&quot;</span><br><span class="line">zabbix：有专用agent的监控工具;</span><br><span class="line">        监控主机:</span><br><span class="line">            linux、windows、FreeBSD</span><br><span class="line">            网络设置、路由交换设备，可以用SNMP这种协议来进行监控; </span><br><span class="line">采集网卡流量，可以将多个网卡流量都加起来进行计算;  </span><br><span class="line">报警，需要添加报警策略，另外需要报警跟踪，报警连动;   </span><br><span class="line">对监控系统要做系统评估;</span><br><span class="line">zabbix 是由php实现的，所以可以实现功能的二次开发;</span><br></pre></td></tr></table></figure>
<h3 id="监控对象"><a href="#监控对象" class="headerlink" title="监控对象"></a>监控对象</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">设备和软件</span><br><span class="line">    设备:服务器、路由器 、交换机、IO系统</span><br><span class="line">    软件: OS、网络、应用程序</span><br><span class="line">偶发性故障</span><br><span class="line">    主机down机、服务不可用、主机不可达</span><br><span class="line">严重故障</span><br><span class="line">主机性能批标</span><br><span class="line">趋势:时间序列数据</span><br></pre></td></tr></table></figure>
<h3 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cacti: rrd(round robin database) 强大的集成工具</span><br><span class="line">zabbix: mysql,pgsql</span><br><span class="line">企业级的监控解决方案; </span><br><span class="line">    如果定义了触发器，超出了预值，则执行脚本，而后再执行报警，报警升级操作;</span><br><span class="line">    zabbix可以做分布式; zabbix可以部署中心节点，与分布式节点;</span><br><span class="line">        要关注系统有多大的压力，需要什么样的组件;</span><br><span class="line">        基于Zabbix agent,SNMP Agent, IPMI Agent,SSH.ping，Database Monitoring ,自定义监控脚本;</span><br><span class="line">    监控目标: CPU, Memeory, Network, Disk, Service, Log, File, Other</span><br><span class="line">    对Web做监控时，可以知道响应的时间，速度，及获取的内容;</span><br><span class="line">    获取通知: 邮件，短信，电话等等; </span><br><span class="line">Zabbix 的四个主要功能</span><br><span class="line">    Data gathering: 数据的收集</span><br><span class="line">    Data storage: 数据的存储 </span><br><span class="line">    Alerting: 报警</span><br><span class="line">    Visualisation:可视化</span><br></pre></td></tr></table></figure>
<h3 id="zabbix-架构中的组件"><a href="#zabbix-架构中的组件" class="headerlink" title="zabbix 架构中的组件"></a>zabbix 架构中的组件</h3><p>1、zabbix之间的通信</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zabbix-server: 使用C语言研发的</span><br><span class="line">OS zabbix-agent: 使用C语言研发的</span><br><span class="line">zabbix-web: GUI,用于实现zabbix设定和展示</span><br><span class="line">zabbix-proxy:分布式监控环境中的专用组件</span><br><span class="line">因此工作性能也是相当不错的</span><br><span class="line">架构通信协议:</span><br><span class="line">    agent架构使用zabbix agent协议进行通信</span><br><span class="line">    web pagess 使用http协议 </span><br><span class="line">    ICMP&#x2F;IPMI&#x2F;SNMP: Device</span><br><span class="line">zabbix dabases:</span><br><span class="line">    MySQL,PGSQL(postgreSQL),DB2,Orcale,SQLite</span><br><span class="line">    zabbix-server(zabbix-get) 与 zabbix-agentd 进行通信</span><br><span class="line">    zabbix-get与zabbix-agentd(zabbix-sender) 进行通信</span><br><span class="line">    zabbix-server 的日志保存在 &#x2F;var&#x2F;log&#x2F;zabbix&#x2F;zabbix-server.log中</span><br><span class="line">    zabbix-agentd 的日志保存在 &#x2F;var&#x2F;log&#x2F;zabbix&#x2F;zabbix-agentd.log中</span><br><span class="line">    zabbix-gui  接口需要一个lamp平台来运行</span><br></pre></td></tr></table></figure>
<p>2、 zabbix的部署分类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a、可以将zabbix-server，zabbix-gui web (lamp),database分别放在一台服务器上;</span><br><span class="line">        然而,zabbix-server与database通信， zabbix-gui也只需要与database通信就可以了;</span><br><span class="line">b、可以将zabbix-server, zabbix-gui web(lamp),database 统一放在一台服务器上;</span><br><span class="line">d、可以将以上组件，两两部署在一台服务器上;</span><br></pre></td></tr></table></figure>
<h3 id="zabbix常用术语"><a href="#zabbix常用术语" class="headerlink" title="zabbix常用术语"></a>zabbix常用术语</h3><ol>
<li>主机Host: 要监控的网络设备;</li>
<li>主机组Host Group: 分类监控的服务器，一组模板(监控项，触发器，等等);</li>
<li>监控项item: zabbix进行数据收集的核心，一个指定的监控指标;</li>
<li>触发器trigger: 是指一个表达式，评估item收集的数据是否在合理范围内; </li>
<li>事件event: 即发生一件值得关注的事情，例如trigger状态由problem转为ok状态;  </li>
<li>动作action: 即预先定义的处理方法，通过定义的动作，发送邮件，知信等等;</li>
<li>报警升级escalation:发送报警，或者执行远程命令，每五分钟发一次，共发5次等; </li>
<li>媒介media: 发送通知的手段或通道，如Email、Jobber、SMS 或者微信等等;  </li>
<li>通知notification:通过选定的媒介向用户发送有关的某件事情; </li>
<li>远程命令(remote command): 预定义的命令，可以在被监控的主机处于某特定条件下时自动执行;  </li>
<li>模板(template): 用于快度定义被监控主机的的预设条目集合，通常包含了item、trigeer、graph、screen; </li>
<li>另外，模板可以直接链接至单个主机;  </li>
<li>应用(application):一组item的集合;</li>
<li>web场景(web scennario):用于检测web站点可用性的一个或多个HTTP请求;  </li>
<li>前端(frontend): zabbix的web接口; </li>
</ol>
<p>可根据系统类型 ，业务需求，设备类型等等将服务器分组;  </p>
<h3 id="zabbix-server-实现"><a href="#zabbix-server-实现" class="headerlink" title="zabbix server 实现"></a>zabbix server 实现</h3><ul>
<li>watchdog 负责运行的进程是否在运行中;</li>
<li>housekeeper 管家，指明你的数据将要被保存多久;</li>
<li>alerter 执行警报操作的;</li>
<li>poller 监控进程；</li>
<li>httppoler  监控web页面的专用poller;</li>
<li>discover  高级的发现机制，可以自动加载进来，但它的工作相当占用资源; </li>
<li>escalator 报警升级; </li>
<li>timer  计时器;</li>
<li>nodewatcher 监控各节点的; </li>
<li>db_data_syncer  数据库的数据同步器;</li>
<li>db_config_syncer 数据库的数据同步器;</li>
<li>pinger 能过ping操作查看各主机是否在线的工具;</li>
</ul>
<h3 id="zabbix-监控实现的硬件需求"><a href="#zabbix-监控实现的硬件需求" class="headerlink" title="zabbix 监控实现的硬件需求"></a>zabbix 监控实现的硬件需求</h3><table>
<thead>
<tr>
<th>Name</th>
<th>Platform</th>
<th>CPU/Memory</th>
<th>Database</th>
<th>Monitored Hosts</th>
</tr>
</thead>
<tbody>
<tr>
<td>Small</td>
<td>Ubuntu Linux</td>
<td>PII 350MHZ 256MB</td>
<td>SQLite</td>
<td>20</td>
</tr>
<tr>
<td>Medium</td>
<td>Ubuntu linux 64 bit</td>
<td>AMD Athlon  320 + 2GB</td>
<td>MySQL InnoDB</td>
<td>500</td>
</tr>
<tr>
<td>Large</td>
<td>Ubuntu Linux 64 bit</td>
<td>Inter Dual Core 6400 + 6GB</td>
<td>RAID 10 MySQL InnoDB or PostgreSQL</td>
<td>&gt;1000</td>
</tr>
<tr>
<td>Verfy Large</td>
<td>RedHat Enterprise</td>
<td>Inter Xeon 2xCPU 8G</td>
<td>FAST RAID 10 MySQl InnoDB or PostgreSQL</td>
<td>&gt;10000</td>
</tr>
</tbody>
</table>
<h3 id="zabbix产生的数据组成共有四部分"><a href="#zabbix产生的数据组成共有四部分" class="headerlink" title="zabbix产生的数据组成共有四部分"></a>zabbix产生的数据组成共有四部分</h3><ol>
<li>配置数据;</li>
<li>历史数据 50Bytes;</li>
<li>历史趋势数据 128Bytes;</li>
<li>事件数据130Bytes; </li>
</ol>
<p>Zabbix 目前部署在Linux服务器最为常见</p>
<p><a href="https://www.zabbix.com/download">zabbix 官方源码 </a> </p>
<h2 id="zabbix的安装与使用"><a href="#zabbix的安装与使用" class="headerlink" title="zabbix的安装与使用"></a>zabbix的安装与使用</h2><h3 id="zabbix-server-的安装与使用"><a href="#zabbix-server-的安装与使用" class="headerlink" title="zabbix-server 的安装与使用"></a>zabbix-server 的安装与使用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install mariadb-server mariadb </span><br><span class="line"># systemctl enable mariadb</span><br><span class="line"># systemctl start mariadb</span><br><span class="line"># mysql </span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE zabbix CHARACTER SET utf8;</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL on zabbix.* TO &#39;zbxuser&#39;@&#39;127.0.0.1&#39; IDENTIFIED BY &#39;xxxxxxx%3&#39;; </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL on zabbix.* TO &#39;zbxuser&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;xxxxxxx%3&#39;;              </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">MariaDB [mysql]&gt; FLUSH PRIVILEGES ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 5.5.56-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| test               |</span><br><span class="line">| zabbix             |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; </span><br></pre></td></tr></table></figure>
<p>这里选用 zabbix 2.2 的包来安装;之后会附zabbix 2.2 升级3.4 的文档</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rpm -i http:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;2.2&#x2F;rhel&#x2F;7&#x2F;x86_64&#x2F;zabbix-release-2.2-1.el7.noarch.rpm</span><br><span class="line"># yum clean all</span><br><span class="line"># yum -y install zabbix zabbix-server zabbix-server-mysql zabbix-get  zabbix-web zabbix-web-mysql zabbix-agent zabbix-sender </span><br><span class="line"># systemctl start httpd</span><br><span class="line"># systemctl enable httpd </span><br><span class="line">Created symlink from &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;httpd.service to &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;httpd.service.</span><br><span class="line"># cd &#x2F;usr&#x2F;share&#x2F;doc&#x2F;zabbix-server-mysql-2.2.21&#x2F;create&#x2F;</span><br><span class="line"># mysql zabbix &lt; schema.sql </span><br><span class="line"># mysql zabbix &lt; images.sql </span><br><span class="line"># mysql zabbix &lt; data.sql </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf</span><br><span class="line"># 参数说明</span><br><span class="line">ListenPort &#x3D; 10051  指定端口 </span><br><span class="line">LogFile &#x3D; 指定日志文件</span><br><span class="line">LogFileSize &#x3D;0 表示不做滚动</span><br><span class="line">DebugLevel &#x3D; 3 </span><br><span class="line">PidFile &#x3D; &#x2F;var&#x2F;run&#x2F;zabbix&#x2F;zabbix_server.pid </span><br><span class="line">DBHost &#x3D; localhost </span><br><span class="line">DBName &#x3D; zabbix </span><br><span class="line">DBUser &#x3D; zbxuser</span><br><span class="line">DBPassword &#x3D; xxxxxxx%3</span><br><span class="line">DBSocket &#x3D; &#x2F;tmp&#x2F;mysql.sock</span><br><span class="line">StartPollers &#x3D; 5  随时等待的进程有多少个</span><br><span class="line">SNMPTrapperFile &#x3D; &#x2F;var&#x2F;log&#x2F;snmppt&#x2F;snmptt.log</span><br><span class="line">MaxHousekeeperDelete&#x3D;500 最多删除多少个</span><br><span class="line">CacheUpdateFrequency&#x3D; 60  cache 最大的更新频率</span><br><span class="line">StartDBsyncers&#x3D;4 DB同步进程多少个</span><br><span class="line">StartDiscoverers &#x3D;1  是启动自动添加模板功能的</span><br><span class="line">StartHTTPPollers &#x3D;1 作为http浏览器来请求被监控页面的</span><br><span class="line">StartTimers &#x3D;1  启动计时器 </span><br><span class="line">JavaGateway &#x3D; 1    监控java网关的</span><br><span class="line">一般默认的缓存值不用调 </span><br><span class="line">AlertScriptsPath&#x3D;&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts&#x2F; 报警脚本的存放位置</span><br><span class="line">ExternalScripts&#x3D;&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F; 外部脚本的存放位置</span><br><span class="line">FpingLocation&#x3D;&#x2F;usr&#x2F;sbin&#x2F;fping 并行发送多个请求，可以当作攻击命令</span><br><span class="line">SSLCerLocation &#x3D; 如果启用SSL的话则配配置该项</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># systemctl start zabbix-server</span><br><span class="line"># vim &#x2F;etc&#x2F;php.ini</span><br><span class="line">date.timezone &#x3D; Asia&#x2F;Chongqing</span><br><span class="line">max_input_time &#x3D; 600</span><br><span class="line">max_execution_time &#x3D; 600</span><br><span class="line">post_max_size &#x3D; 28M</span><br><span class="line"># systemctl restart httpd</span><br></pre></td></tr></table></figure>
<p><img src="/images/zabbix2.2.png" class="lazyload" data-srcset="/images/zabbix2.2.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/zabbix_logging.png" class="lazyload" data-srcset="/images/zabbix_logging.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="如果使用编译安装"><a href="#如果使用编译安装" class="headerlink" title="如果使用编译安装"></a>如果使用编译安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 同时安装 server 和agent ，并支持将数据放入myql数据中，可使用类似如下配置命令;</span><br><span class="line"># .&#x2F;configure --enable-server --enable-agent --with-mysql --enable-ipv6 --with-net-snmp --with-libcurl --with-ssh2 </span><br><span class="line"></span><br><span class="line"># 如果仅安装 server,并支持将数据放入mysql数据中，可使用似如下配置命令; </span><br><span class="line"># .&#x2F;configure --enable-server --with-mysql --with-net-snmp --with-libcurl</span><br><span class="line"></span><br><span class="line"># 如果仅安装 proxy，并支持将数据放入mysql数据中，可使用类似如下配置命令; </span><br><span class="line"># .&#x2F;configure --profix&#x3D;&#x2F;usr --enable-proxy --with-net-snmp --with-mysql --with-ssh2</span><br><span class="line"></span><br><span class="line"># 如果仅安装 agent，可以使用类似如下配置命令;</span><br><span class="line"># .&#x2F;configure --enable-agent </span><br><span class="line"></span><br><span class="line"># 而后编译安装zabbix 即可;</span><br><span class="line"># make </span><br><span class="line"># make install </span><br></pre></td></tr></table></figure>
<h3 id="zabbix-agent-的安装和使用"><a href="#zabbix-agent-的安装和使用" class="headerlink" title="zabbix agent 的安装和使用"></a>zabbix agent 的安装和使用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf </span><br><span class="line">ServerActive&#x3D;127.0.0.1,172.16.55.123</span><br><span class="line">Hostname&#x3D;zabbix-test-server</span><br><span class="line"># systemctl start zabbix-agent</span><br><span class="line">Congiguration --&gt; Hosts --&gt; (将zabbix-server端的agent服务启用)</span><br></pre></td></tr></table></figure>
<p><img src="/images/zabbix2.2_server_agent.png" class="lazyload" data-srcset="/images/zabbix2.2_server_agent.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="zabbix-添加额外的agent端"><a href="#zabbix-添加额外的agent端" class="headerlink" title="zabbix 添加额外的agent端"></a>zabbix 添加额外的agent端</h3><p>在一台需要被监控的服务器上安装 zabbix-agent </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rpm -i http:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;2.2&#x2F;rhel&#x2F;7&#x2F;x86_64&#x2F;zabbix-release-2.2-1.el7.noarch.rpm</span><br><span class="line">#  yum clean all </span><br><span class="line">#  yum -y install zabbix zabbix-agent zabbix-sender</span><br><span class="line"># vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf </span><br><span class="line">Server&#x3D;172.16.55.123</span><br><span class="line">ServerActive&#x3D;172.16.55.123</span><br><span class="line">Hostname&#x3D; zabbix-agent-node1</span><br><span class="line"># systemctl start zabbix-agent</span><br><span class="line"># netstat  -tnlup | grep zabbix</span><br><span class="line">tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      30383&#x2F;zabbix_agentd </span><br><span class="line">tcp6       0      0 :::10050                :::*                    LISTEN      30383&#x2F;zabbix_agentd </span><br><span class="line">注: 最好在zabbix-server 做一下探测，确保在zabbix-server 端可以探测通agent的端口</span><br><span class="line"># telnet 172.16.55.124 10050</span><br><span class="line">Trying 172.16.55.124...</span><br><span class="line">Connected to 172.16.55.124.</span><br><span class="line">Escape character is &#39;^]&#39;.</span><br></pre></td></tr></table></figure>
<p><img src="/images/zabbix-agent-host-node1.png" class="lazyload" data-srcset="/images/zabbix-agent-host-node1.png" srcset="data:image/png;base64,666" alt=""><br>登录zabbix-server 的web接口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configuration --&gt; Hosts --&gt; Create Hosts --&gt;</span><br><span class="line">[</span><br><span class="line">Host name: zabbix-agent-node1</span><br><span class="line">Visible name: zabbix-agent-node1</span><br><span class="line">Group In goups : Linux servers</span><br><span class="line">Agent interfaces: 这里选用的是ip-&gt; 172.16.55.124</span><br><span class="line">Templates -&gt; Template OS Linux --&gt; Add -&gt; Save --&gt; </span><br><span class="line">IPMI -&gt; 先留空</span><br><span class="line">Macros -&gt; 先留空</span><br><span class="line">Host inventory -&gt; 先留空</span><br><span class="line">]</span><br><span class="line">Host &lt;-- Save</span><br></pre></td></tr></table></figure>
<h2 id="zabbix-on-CentOS7"><a href="#zabbix-on-CentOS7" class="headerlink" title="zabbix on CentOS7"></a>zabbix on CentOS7</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Linux开源监控系统:</span><br><span class="line">    nagios</span><br><span class="line">    cacti</span><br><span class="line">    zabbix: 内nagios，cacti </span><br><span class="line">    ganglia: 内置强大的聚合功能，这个功能zabbix是不具备的</span><br><span class="line">    在大公司能了解到更好规范; </span><br><span class="line">    在小公司能够得到更多的经验;</span><br><span class="line"># vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">innodb_file_per_table &#x3D; 1 </span><br><span class="line">skip_name_reslove &#x3D;  1 </span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">CentOS 7.1 安装</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># yum install zabbix-2.4.6-1.el7.x86_64.rpm zabbix-server-2.4.6-1.el7.x86_64.rpm zabbix-server-mysql-2.4.6-1.el7.x86_64.rpm zabbix-agent-2.4.6-1.el7.x86_64.rpm zabbix-sender-2.4.6-1.el7.x86_64.rpm zabbix-web-2.4.6-1.el7.noarch.rpm zabbix-get-2.4.6-1.el7.x86_64.rpm  zabbix-web-mysql-2.4.6-1.el7.noarch.rpm trousers-0.3.11.2-4.el7_1.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">说明：CentOS 7.1安装zabbix-2.4.6-1.el7，其与trousers-0.3.11.2-3不兼容，需要升级trousers至0.3.11.2-4.el7_1。如果没有zabbix rpm包，可以在官网查找安装yum源rpm包 ，类似以上的安装方法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建数据库：</span><br><span class="line"></span><br><span class="line">	server和proxy的运行都依赖于数据库，agent则不需要。</span><br><span class="line"></span><br><span class="line">	以MySQL数据库为例：</span><br><span class="line">		shell&gt; mysql -uroot -p&lt;password&gt;</span><br><span class="line">		mysql&gt; create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">		mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by &#x27;&lt;password&gt;&#x27;;</span><br><span class="line">		mysql&gt; quit;</span><br><span class="line">		shell&gt; mysql -uzabbix -p&lt;password&gt; zabbix &lt; database/mysql/schema.sql</span><br><span class="line">		<span class="comment"># stop here if you are creating database for Zabbix proxy</span></span><br><span class="line">		shell&gt; mysql -uzabbix -p&lt;password&gt; zabbix &lt; database/mysql/images.sql</span><br><span class="line">		shell&gt; mysql -uzabbix -p&lt;password&gt; zabbix &lt; database/mysql/data.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置zabbix：</span><br><span class="line"></span><br><span class="line">	(1) zabbix_server</span><br><span class="line">	server的配置文件为zabbix_server.conf，至少应该为其配置数据库等相关的信息；例如：</span><br><span class="line">		LogFile=/var/log/zabbix/zabbix_server.log</span><br><span class="line">		LogFileSize=0</span><br><span class="line">		PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">		DBHost=172.16.100.67</span><br><span class="line">		DBName=zabbix</span><br><span class="line">		DBUser=zbxuser</span><br><span class="line">		DBPassword=zbxpass</span><br><span class="line">		DBSocket=/var/lib/mysql/mysql.sock</span><br><span class="line">		SNMPTrapperFile=/var/log/snmptt/snmptt.log</span><br><span class="line">		AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">		ExternalScripts=/usr/lib/zabbix/externalscripts		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	(2) 配置php环境</span><br><span class="line">		编辑/etc/httpd/conf.d/zabbix.conf，添加如下项。</span><br><span class="line">	    php_value date.timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line">	   	启动httpd服务：systemctl <span class="keyword">start</span> httpd.service</span><br><span class="line"></span><br><span class="line">	   	访问zabbix web</span><br><span class="line">	   		<span class="keyword">http</span>://your_host/zabbix</span><br><span class="line"></span><br><span class="line">	   		登录：<span class="keyword">Admin</span>/zabbix</span><br><span class="line"></span><br><span class="line">	(<span class="number">3</span>) 配置zabbix_agent</span><br><span class="line">		<span class="keyword">agent</span>的配置文件为zaabix_agentd.conf，至少应该为其指定<span class="keyword">server</span>的IP地址；</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zabbix组件</span><br><span class="line">    zabbix</span><br><span class="line">    zabbix-server</span><br><span class="line">    zabbix-database</span><br><span class="line">    zabbix-web</span><br><span class="line">    zabbix-agent</span><br><span class="line">    zabbix-proxy</span><br><span class="line">zabbix 逻辑组件</span><br><span class="line">    主机组、主机</span><br><span class="line">    item(监控项)、appliction(应用)</span><br><span class="line">    trigger(触发器)</span><br><span class="line">        even(事件)</span><br><span class="line">    action</span><br><span class="line">        notice</span><br><span class="line">        command</span><br><span class="line">    media</span><br><span class="line">    users(media)</span><br><span class="line">    监控系统: 数据采集、数据存储、报警、数据可视化</span><br><span class="line">    </span><br><span class="line">    zabbix:</span><br><span class="line">        database --&gt; zabbix-server (zabbix_server.conf)--&gt; zabbix-web(LAMP平台) </span><br><span class="line">        --&gt; http:&#x2F;&#x2F;zabbix-web-server&#x2F;zabbix&#x2F;zabbix-agent (zabix-agent.conf)</span><br></pre></td></tr></table></figure>
<h3 id="zabbix-报警入门配置"><a href="#zabbix-报警入门配置" class="headerlink" title="zabbix 报警入门配置"></a>zabbix 报警入门配置</h3><p><code>注: 在添加主机的时候如果要想让支持snmp协议，则安装yum -y install net-snmp</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;snmp&#x2F;snmp.conf</span><br><span class="line"># service snmpd start </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查看支持的key MariaDB [zabbix]&gt; SELECT key_,type FROM items ;</span><br><span class="line"># 查看支持的items MariaDB [zabbix]&gt; SELECT * FROM items\G;</span><br><span class="line"># zabbix_get -h 向指定的主机获取指定的值的</span><br><span class="line"># zabbix_get -s 172.16.55.124 -k &quot;net.if.out[ens3]&quot;</span><br><span class="line">1161497309</span><br><span class="line"># zabbix_get -s 172.16.55.124 -k &quot;net.if.in[ens3]&quot; </span><br><span class="line">1390144843</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 手动创建item</span><br><span class="line"># 先在zabbix服务器端尝试获取CPU中断数 </span><br><span class="line"># zabbix_get -s 172.16.55.124 -k &quot;system.cpu.intr&quot;</span><br><span class="line">597504908</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configuration --&gt; Hosts --&gt; 选定主机的Items </span><br><span class="line">Name: cpu interrupts </span><br><span class="line">Type: zabbix  </span><br><span class="line">Key:system.cpu.intr</span><br><span class="line">Host interface:172.16.100.8:10050</span><br><span class="line">Type of information: Numeric(unsigned) : 数据类型决定以下配置是否可用</span><br><span class="line">Data type : Decimal </span><br><span class="line">Units:</span><br><span class="line">Use custom multipier: 做单位换算</span><br><span class="line">New flexible interval Interval(in sec)：指定监控时间</span><br><span class="line">History storage period (in days): 历史数据的存放天数，只要满足需要了，尽可能不可时长过多 90</span><br><span class="line">Treand storage period (in days): 历史采样的数据 365</span><br><span class="line">历史数据:采样生成的数据;</span><br><span class="line">历史趋势数据 :每小时的最大值 、最小值 、平均值、统计值</span><br><span class="line">Sotre valus: 数据存储的结果 As is，不做任何处理; </span><br><span class="line">Delta(sppd per second): (value -per_value)&#x2F;(time - pre_time)</span><br><span class="line">    10: 1200 , 20: 13000</span><br><span class="line">添加完以上信息之后，添add即可; 可以在hosts中查看到状态是enabled</span><br><span class="line">同样的方式可以创建 其它Item</span><br></pre></td></tr></table></figure>
<p>手动创建一个图形</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configuration --&gt; Hosts --&gt; --&gt; 选定主机的Graph </span><br><span class="line">Name: cpu interrupts </span><br><span class="line">Width: 900</span><br><span class="line">Heig: 200</span><br><span class="line">Graph type: Normal </span><br><span class="line">Show legend </span><br><span class="line">Show working time </span><br><span class="line">Show triggers</span><br><span class="line">add Items</span><br><span class="line">Preview ，配置完之后，可以预览后添加; </span><br></pre></td></tr></table></figure>
<p>触发器状态严重性，级别</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Not classfiled Grey  无分类</span><br><span class="line">Information Light green 资讯</span><br><span class="line">Warning Yellow 警告</span><br><span class="line">Average Orange 觉见问题</span><br><span class="line">High red     高危</span><br><span class="line">Disaster bright red 毁灭</span><br></pre></td></tr></table></figure>
<p>创建触发器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configuration --&gt; Hosts --&gt; 选定主机的Trigger</span><br><span class="line">Name too many interrupts</span><br><span class="line">Expression  add </span><br><span class="line">    --&gt; node1:cpu intterrupts </span><br><span class="line">    --&gt; last(most recent)T value is &gt; N</span><br><span class="line">    --&gt; Last of (T) </span><br><span class="line">    --&gt; Time shift</span><br><span class="line">        --&gt; N 50</span><br><span class="line">    --&gt; add</span><br><span class="line">Description</span><br><span class="line">    名称中可以使用宏:</span><br><span class="line">        &#123;HOST.HOST&#125;,&#123;HOST.NAME&#125;,&#123;HOST.IP&#125;,&#123;HOST.COMN&#125;,&#123;HOST.DNS&#125;</span><br><span class="line">    </span><br><span class="line">    URL: 可以留空，也可以添加一个url，报警则说明由哪个url触发的</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install hping3 多个hping3可以实现DDOS攻击</span><br><span class="line"># hping3 172.16.55.124 --faster </span><br><span class="line">可以在124上看到,cpu上下文切换速度非常的快,cpu中断飙升</span><br><span class="line"># vmstat 1</span><br></pre></td></tr></table></figure>
<p>定义报媒介 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Administration --&gt; Media types </span><br><span class="line">    --&gt; Name Email</span><br><span class="line">    --&gt; Type Email </span><br><span class="line">    --&gt; SMTP Server 可以指定到邮件服务器</span><br><span class="line">    --&gt; SMTP helo localhost 指定收件人</span><br><span class="line">    --&gt; SMTP email zabbix@xxxxx.com 指定发件人  </span><br><span class="line"></span><br><span class="line"># 定义报警用户 </span><br><span class="line">这里建议不创建报警用户，直接使用admin发</span><br><span class="line">Media 可以实现报警升级功能;在admin用户中配置报警媒介</span><br></pre></td></tr></table></figure>
<p>配置Actions</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configure --&gt; Actions--&gt; Create Actions </span><br><span class="line">    Action--&gt; names</span><br><span class="line">    信息采用宏，启用报故障恢复后发送信息;</span><br><span class="line">    </span><br><span class="line">Conditions 条定执行条件</span><br><span class="line">Operations 定义报警升级 (每一次可有多个跨度区间)</span><br></pre></td></tr></table></figure>
<h3 id="zabbix-常用配置"><a href="#zabbix-常用配置" class="headerlink" title="zabbix 常用配置"></a>zabbix 常用配置</h3><p>由zabbix监控某关注的指标</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">host group --&gt; host --&gt; item(存储于MySQL) --&gt; graph (zabbix-web)</span><br><span class="line">--&gt; trigger(触发器) --&gt; action(conditon+operation)</span><br><span class="line">application: 把功能相近的一组item归类在一起统一进行管理组件:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ServerActive&#x3D; 172.16.55.124 ; 这里在agent中如果指定了，则说明是主动的监控方式;</span><br><span class="line">Actions 可以接收事件，可以发送动作而用来报警;</span><br><span class="line">(Events,Actions,Trigger) 是zabbix的核心组件</span><br></pre></td></tr></table></figure>
<p>Zabbix 完整的监控配置流程大体由如下组成:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Host group --&gt; Hosts --&gt; Applications --&gt; Items --&gt; Triggers --&gt; Events --&gt; Actions  (发警告) --&gt; User group </span><br><span class="line">--&gt; Users --&gt; Medias</span><br><span class="line"></span><br><span class="line">graph, screen </span><br><span class="line">依赖关系:</span><br><span class="line">        Host --&gt; Item --&gt; Trigger --&gt; Action </span><br></pre></td></tr></table></figure>
<p>添加主机到zabbix server:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一定不要让没有监控的服务器上线</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">定义好discoevery: 可以根据给定的网段，自动描网段，并添加，此种方式是服务器端主动</span><br><span class="line">auto_registrion: 被监控主机，自动向服务端注册</span><br><span class="line">low level discovery: 区别不同的底层设备的</span><br></pre></td></tr></table></figure>
<p>模板(template):</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一般模板是套在主机之上的;(item,application,trigger,graph,action)</span><br></pre></td></tr></table></figure>
<p>Item</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">默认的Iems有多种类型</span><br><span class="line">    Zabbix-agent</span><br><span class="line">        工作模式: passive, active</span><br><span class="line">    </span><br><span class="line">    网卡流量相关:</span><br><span class="line">        net.if.in[if,&lt;mode&gt;]</span><br><span class="line">            if: 接口，如eth0</span><br><span class="line">            mode:bytes, packets, errors, dropped</span><br><span class="line">        net.if.out[if,&lt;mode&gt;]</span><br><span class="line">        net.if.total[if.&lt;mode&gt;]</span><br><span class="line">    </span><br><span class="line">    端口相关:</span><br><span class="line">        net.tcp.listen[port]</span><br><span class="line">        net.tcp.port[&lt;ip&gt;,port]</span><br><span class="line">        net.tcp.service[service,&lt;ip&gt;,&lt;port&gt;]</span><br><span class="line">        net.udp.listen[port]</span><br><span class="line">    监控端口是否处于监听状态</span><br><span class="line">        </span><br><span class="line">    进程相关:</span><br><span class="line">        kernel.maxfiles 内核打开的文件数</span><br><span class="line">        kernel.maxproc 内核打开的最大进程数</span><br><span class="line">    CPU相关:</span><br><span class="line">        system.cpu.intr 中断次数</span><br><span class="line">        system.cpu.load[&lt;cpu&gt;,&lt;mode&gt;] cpu负载</span><br><span class="line">        system.cpu.num[type] cpu个数 </span><br><span class="line">        system.cpu.switches  cpu切换频率</span><br><span class="line">        system.cpu.util [&lt;cpu&gt;,&lt;type&gt;,&lt;mode&gt;] cpu哪个指标的利用率</span><br><span class="line">        </span><br><span class="line">    磁盘IO相关:</span><br><span class="line">        vfs.dev.read[&lt;device&gt;,&lt;type&gt;,&lt;mode&gt;]</span><br><span class="line">        vfs.dev.write[&lt;device&gt;,&lt;type&gt;,&lt;mode&gt;]</span><br><span class="line">        vfs.fs.inode [fs,&lt;mode&gt;]</span><br></pre></td></tr></table></figure>
<p>用户可自定义item:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">关键:选取一个惟一的key;</span><br><span class="line">命令:收集数据 的命令或脚本;</span><br></pre></td></tr></table></figure>
<p>Trigger:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">状态: </span><br><span class="line">    OK: 事件转为正状态;</span><br><span class="line">    PROBLEM：表示有事件发生;</span><br><span class="line">    zabbix server 每次接收到items的新数据时</span><br><span class="line">就会对Item的当前采样值进行判断，即与trigger的表达式进行比较;</span><br><span class="line">一个trigger只能属于一个Item，但一个Item可有有多个Trigger;</span><br><span class="line">Severity:</span><br><span class="line">    No classfied: 未知级别，灰色;</span><br><span class="line">    Information: 一般信息，亮绿;</span><br><span class="line">    Warning: 警告信息，黄色;</span><br><span class="line">    Average: 一般故障，红色;</span><br><span class="line">    Disater:致命故障，亮红;</span><br></pre></td></tr></table></figure>
<p>Action:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">触发条件一般为事件:</span><br><span class="line">    Trigger events: OK --&gt; PROBLEM;</span><br><span class="line">    Discovery events: zabbix的network discovery工作;</span><br><span class="line">    Auto registration events: 主动模式的agent注册时产生的事件;</span><br><span class="line">    Internal events: Item变成不再被支持，或Trigger变成为未知道状态</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>zabbix使用进阶</title>
    <url>/2018/04/02/zabbix%E9%AB%98%E7%BA%A7/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="zabbix-高级用法"><a href="#zabbix-高级用法" class="headerlink" title="zabbix 高级用法"></a>zabbix 高级用法</h1><p><img src="/images/zabbix_chatu.png" class="lazyload" data-srcset="/images/zabbix_chatu.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="zabbix-报警媒介"><a href="#zabbix-报警媒介" class="headerlink" title="zabbix 报警媒介"></a>zabbix 报警媒介</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 对于邮件报警接口，CentOS默认邮件服务就是启动的，但是，只能服务本地到本地发邮件;  </span><br><span class="line"># 如果需要往互联网上发邮件，需要把服务器配置成邮件服务器;</span><br><span class="line"># 但一般来讲，自建邮件系统，付出的成本和技术都较高，因此，我们可以考虑网联上的邮件服务;</span><br><span class="line"># 而对于报警的内容，一般是我们在zabbix服务端配置的宏所定义的内容;</span><br><span class="line"># 没有item的配置，那么将意味着没有监控数据; </span><br></pre></td></tr></table></figure>
<h2 id="Zabbix术语与操作注意项"><a href="#Zabbix术语与操作注意项" class="headerlink" title="Zabbix术语与操作注意项"></a>Zabbix术语与操作注意项</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Item Key </span><br><span class="line">    命名求: 只能使用字母、数字、下划线、点号、连接符;</span><br><span class="line">    接受参数: system.cpu.load[&lt;cpu&gt;,&lt;mode&gt;], net.if.inbound[if,&lt;mode&gt;]</span><br><span class="line">    注意: 每一个key背后都应该有一个命令或者脚本来负责实现数据收集；命令或者脚本可以调用传递给key的参数，调用方式为$1,$2,...</span><br><span class="line">    在zabbix中定义item时调用某key，还需要额外定义数据采集频率(每30秒采集一次)、历史数据的保存时长等;</span><br><span class="line">Trigger:</span><br><span class="line">    触发器表达式: &#123;&lt;Server&gt;:&lt;key&gt;.&lt;function&gt;(&lt;parameter&gt;)&#125;&lt;operator&gt;&lt;constant&gt;</span><br><span class="line">    例: &#123;api.transfereasy.com:net.tcp.listen[9991].last()&#125;#1</span><br><span class="line">    &lt;function&gt;: 评估采集到的数据是否在合理范围内时所使用的函数，共评估过程可以根据采集到的数据、当前时间或其它因素;</span><br><span class="line">        avg:平均值;</span><br><span class="line">        count:指定时间内的统计;</span><br><span class="line">        change:返回最近返回的值，与之前一次的差值;</span><br><span class="line">        date:当天的值;</span><br><span class="line">        dayofweek:返回本周的第几天的值;</span><br><span class="line">        dayofmonth:返回本月的第几天的值;</span><br><span class="line">        delta:指定时间范围内最大值与最小值之差;</span><br><span class="line">        diff:当文件不一样时;</span><br><span class="line">        iregexp:忽略大小写它符的正则表达式;</span><br><span class="line">        last:最近一次采样;</span><br><span class="line">        max:最近采样的最大值;</span><br><span class="line">        min:最近采样的最小值;</span><br><span class="line">        nodata: 表示没有数据;</span><br><span class="line">        sum:最后一次采样数据之和;</span><br><span class="line">        regexp:检查最后一次采样的值是否能够被指定的模式所匹配: 1、表示匹配, 0表示不匹配;</span><br><span class="line">        now:返回自Unix元年至此刻经历的秒数;</span><br><span class="line">        prev:倒数第二个采样值:</span><br><span class="line">        str:从最后一次的采样中查找到此处指定的子串:</span><br><span class="line">        strlen: 做字符串的长度比较;</span><br><span class="line">        prev:倒数第二个采样值</span><br><span class="line">    &lt;operator&gt;:</span><br><span class="line">            &gt;, &lt;, &#x3D;, #(表示不等于)事实上我们可以让表达式的值直接来做算术运算的;</span><br><span class="line">            &#x2F; ,* ,- ,+</span><br><span class="line">            &amp;(与),|(或)</span><br><span class="line">    触发器之间的关系        </span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line">    message:</span><br><span class="line">    condition:</span><br><span class="line">        一般由event触发:</span><br><span class="line">            trigger</span><br><span class="line">            discover:</span><br><span class="line">                Service Up ,Srvice Down ,Host up ,Host down, Service Discovered,Service Lost,Host Discovered, Host Lost</span><br><span class="line">            auto-registration</span><br><span class="line">            </span><br><span class="line">    operation:</span><br><span class="line">        send message</span><br><span class="line">            Medis Type</span><br><span class="line">                Email (常用),SMS ,Jabber, Scripts(常用), EZ Texting</span><br><span class="line">            Usser</span><br><span class="line">        remote command(远程命令)</span><br><span class="line">            运行zabbix进程的用户是zabix用户</span><br><span class="line">            所以这里要注意，zabbix未必有权限执行</span><br><span class="line">            (1) 给zabbix 定义sudo规则:    </span><br><span class="line">                zabbix ALL&#x3D;(ALL) ALL</span><br><span class="line">            (2) 不支持active模式的agent:</span><br><span class="line">            (3) 不支持代理模式:</span><br><span class="line">            (4) 命令长度不得超过255个字符:</span><br><span class="line">            (5) 可以使用宏:</span><br><span class="line">            (6) zabbix-server仅执行命令，而不关命令是否执行成功:</span><br><span class="line">            </span><br><span class="line">            前提: zabbix-agent要配置为支持执行远程命令:</span><br><span class="line">                EanbleRemoteCommands &#x3D;1  </span><br><span class="line">                LogRemoteCammands &#x3D;1  # 启用执行远程命令后记录</span><br><span class="line">            # vim &#x2F;etc&#x2F;sudoers  或者  visudo </span><br><span class="line">                zabbix ALL&#x3D;(ALL)  NOPASSWD:ALL</span><br><span class="line">                注: 以上服务器权限的是操作是非常用风限性的; </span><br><span class="line">            Actions --&gt; Operations --&gt; New </span><br><span class="line">                --&gt; Operation type Remote Command:</span><br><span class="line">                --&gt; Host  挑远出远程主机</span><br><span class="line">                --&gt; Global script --&gt;在方框中加入远程命令 </span><br><span class="line">            Hosts --&gt; Applications --&gt; Create Applications --&gt; Http</span><br><span class="line">            Hosts --&gt; Items --&gt; Create Items</span><br><span class="line">            --&gt; Name http server </span><br><span class="line">            --&gt; Type zabbix aggent </span><br><span class="line">            --&gt; Key net.tcp.listen[80]</span><br><span class="line">            --&gt; Applications http service</span><br><span class="line">            Add Items &lt;--</span><br><span class="line">            </span><br><span class="line">            Host --&gt; Triger --&gt; Create Triger</span><br><span class="line">            --&gt; Name http service is on</span><br><span class="line">                Expresion --&gt; add </span><br><span class="line">                    --&gt;Item node2: http service </span><br><span class="line">                    --&gt; Function: Previous value is &#x3D;1 </span><br><span class="line">                    --&gt; Last of(T) 1</span><br><span class="line">                    --&gt; N 0</span><br><span class="line">                    --&gt; 严重级别先Hight </span><br><span class="line">            Configuration --&gt; Actions --&gt; Create Action --&gt;</span><br><span class="line">                Action Name http service</span><br><span class="line">                Conditions --&gt; New condition Trigger &#x3D;&#x3D; node1: httpd serivce is value</span><br><span class="line">                Operations --&gt; 定义报警升级 --&gt; 可以定义由第一步到第几步执行什么样的操作       </span><br><span class="line">                注意:</span><br><span class="line">                    (1) 如果用到以某它用户身份运行其它命令的话，要加 sudo 来运行;</span><br><span class="line">                        sudo systemctl restart httpd</span><br><span class="line">                    (2) 在各gent上的sudoers 文件中，要注释如下行，否则命令依旧无法正常运行;</span><br><span class="line">                        # Default requiretty </span><br><span class="line">        Script: Alert Script </span><br><span class="line">        </span><br><span class="line">            放置于特定目录中: AlertScriptsPath&#x3D;&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts</span><br><span class="line">                zabbix_server.conf配置文件中的参数:</span><br><span class="line">                脚本中使用$1,$2,$3来调用Action先项卡中的收件人地址, Default Subject , Default Massage:</span><br><span class="line">                # vim alert_message.sh</span><br><span class="line">                #!&#x2F;bin&#x2F;bash</span><br><span class="line">                to&#x3D;$1</span><br><span class="line">                subject&#x3D;&quot;$2&quot;</span><br><span class="line">                body&#x3D;&quot;$3&quot;</span><br><span class="line">                echo &quot;$body&quot; | mail -s &quot;$subject&quot; &quot;$to&quot;</span><br><span class="line">                # chmod +x alert_message.sh </span><br><span class="line">                当然这里是一个最简单的实现脚本，这里也可以使用python,bash,ruby,perl 等脚本</span><br><span class="line">                注意: 新放入此目录中的脚本，只有重启zabbix 方能被实别;</span><br><span class="line">                </span><br><span class="line">                Administration --&gt; Mdedia types --&gt; </span><br><span class="line">                            --&gt; Name AlterScript</span><br><span class="line">                            --&gt; Type Script </span><br><span class="line">                            --&gt; Script name alert_message.sh </span><br><span class="line">                Administration --&gt; Users ---&gt;</span><br><span class="line">                            --&gt; Media --&gt; add </span><br><span class="line">                            --&gt; AlterScripts root@localhost</span><br><span class="line">                这样的话，通过两种方式都能收到邮件</span><br><span class="line">Escalation </span><br><span class="line">Template</span><br><span class="line">Web Scennario</span><br></pre></td></tr></table></figure>
<h2 id="Zabbix服务器进程"><a href="#Zabbix服务器进程" class="headerlink" title="Zabbix服务器进程"></a>Zabbix服务器进程</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">housekeeper 用来清理过期数据的;</span><br><span class="line">alter 专门用来发送警告的进程;</span><br><span class="line">discoverer 实现主机发现的; </span><br><span class="line">httppoller 对web服务器进行监控时;</span><br><span class="line">Poller 主动去被监控节点去拉取数据;</span><br><span class="line">Pinger 基于ping命令来探测主机是否在线;</span><br><span class="line">db_config_syncer 服务器配置同步的; </span><br><span class="line">timer 计时器;</span><br><span class="line">escaltor  报警升级器;</span><br></pre></td></tr></table></figure>
<h2 id="zabbix-可视化"><a href="#zabbix-可视化" class="headerlink" title="zabbix 可视化"></a>zabbix 可视化</h2><p>自定义图形属性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Name: 图形的独有名称;</span><br><span class="line">Width: 图形的宽度，单位为像素;仅适用于&quot;预览(perview)&quot; 模式、饼图或分离型饼图; </span><br><span class="line">Height: 图形的类型, 共有四种，即&quot;线状图normal&quot;、&quot;堆叠面积图&quot;、&quot;饼图(pie)&quot;、 分离型饼图(exploded);</span><br><span class="line">Show legend: 是否显示图例，即图形数据序列说明;</span><br><span class="line">Show working time: 是否高亮显示工作时间区域;选定时，非工作时间区间的背景为灰色;此功能不用于pie和exploded;</span><br><span class="line">Show Triggers: 是否显示触发器;此功能不适用于pie和exploded; </span><br></pre></td></tr></table></figure>
<p>多图形合并显示 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configuration --&gt; Screen --&gt; Create Screen </span><br><span class="line">--&gt; Name Test Screen</span><br><span class="line">--&gt; Columns 3 # 列</span><br><span class="line">--&gt; Row 2  # 行</span><br><span class="line">        --&gt; Test Screen </span><br><span class="line">            --&gt; change 这里就可以看到一个2行3列的表格，然后往里面添加图片; </span><br><span class="line">            </span><br></pre></td></tr></table></figure>
<p>多屏翻转</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Slide shows</span><br><span class="line">Name </span><br><span class="line">Default delay(in seconds)</span><br></pre></td></tr></table></figure>
<p>可视化: graph ,screen, slide shows,map</p>
<p>宏(macros)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 宏其实说白了就是变量，类型通常为文本类型; </span><br><span class="line">#  为了更强的灵活性,zabbix还支持在全局、模板或主机级别使用用户自定义宏(user macro);</span><br><span class="line">#  用户自定义宏要使用&quot;&#123;$MACRO&#125;&quot;这种特殊的语法格式; </span><br><span class="line">#  宏可以应用在item keys 和descriptions、 trigger 名称和表达式、主机接口IP&#x2F;DNS及端口、 discovery机制的SNMP协议的相关信息等;</span><br><span class="line"># 宏的名称只能使用大写字母、数字及下划线;</span><br><span class="line"># 两类:</span><br><span class="line">    内建: &#123;MACRO_NAME&#125;</span><br><span class="line">    自定义:&#123;$MACRO_NAME&#125;</span><br><span class="line"></span><br><span class="line"># 可以在三个级别使用:</span><br><span class="line">    Global, Template, Host</span><br><span class="line"></span><br><span class="line"># 优先级: Host --&gt; Template --&gt; Global</span><br><span class="line">    在某级别找到后将直接使用: 将不再查找</span><br><span class="line">    </span><br><span class="line">    全局宏:</span><br><span class="line">        Adminstration --&gt; General --&gt; Macrios(在先项卡中)</span><br><span class="line">    </span><br><span class="line">    主机宏:</span><br><span class="line">        Configuration --&gt; Hosts --&gt; Macrios 主机级别的宏优先级最高;</span><br><span class="line">    </span><br><span class="line">    Template:</span><br><span class="line">        Configuration --&gt; Complation --&gt; Macrios</span><br></pre></td></tr></table></figure>
<h2 id="模板-Templats"><a href="#模板-Templats" class="headerlink" title="模板(Templats)"></a>模板(Templats)</h2><p>一系列配置的集合，此些配置可以通过”链接”的方式应用于指定的主机:<br>application, item, trigger, graph, scree 及发现规则; </p>
<p>添加例行惯常的维护时间; </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Configuration --&gt; maintenance --&gt; Maintenance</span><br></pre></td></tr></table></figure>
<p>User Parameters:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># zabbix 内置了许多item key:</span><br><span class="line">实现用户自定义 item key ,实现特有数据指标监控;</span><br><span class="line">语法:</span><br><span class="line">    UserParameter&#x3D;&lt;key&gt;,&lt;command&gt;</span><br><span class="line"># vim  &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.d&#x2F;os.conf</span><br><span class="line">UserParameter&#x3D;os.memory.used, free -m | awk &#39;&#x2F;^Mem&#x2F; &#123;print $3&#125;&#39;</span><br><span class="line">UserParameter&#x3D;os.memory.used, free -m | awk &#39;&#x2F;^Mem&#x2F; &#123;print $3&#125;&#39;</span><br><span class="line">UserParameter&#x3D;os.memory.used, free -m | awk &#39;&#x2F;^Mem&#x2F; &#123;print $3&#125;&#39;</span><br><span class="line">注: 需要重启zabbix-agent 才能使用</span><br><span class="line"># systemctl restart zabbix-agent</span><br><span class="line">这个时候定义的zabbix-agent key就可以使用了,在server web 接口中添加; </span><br><span class="line">如果找不到key  则直接输入即可 os.memory.used</span><br></pre></td></tr></table></figure>
<h2 id="监控nginx-status"><a href="#监控nginx-status" class="headerlink" title="监控nginx status"></a>监控nginx status</h2><p>nginx status 开启方法:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        ...</span><br><span class="line">        location &#x2F;status &#123;</span><br><span class="line">            stub_status on;</span><br><span class="line">            access_log off;</span><br><span class="line">            allow 172.16.55.123; # 允许访问的IP</span><br><span class="line">            allow 127.0.0.1;</span><br><span class="line">            deny all;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">状态页面各项数据的意义;</span><br><span class="line">active connections - 当前Nginx 正处理的活动连接数;</span><br><span class="line">serveraccepts handled requests - 总共处理了 233851个连接，成功创建 233851次握手(证明中间没有失败的)</span><br><span class="line">    总共处了 687942个请求(平均每次扬处理了  2.94 个数据请求)。</span><br><span class="line">    reading -nginx 读取到客户端的Header信息数;</span><br><span class="line">    writing -nginx 返回给客户端的Header 信息数; </span><br><span class="line">    waiting - 开启 keep-alive 的情况下，这个值等于 active- (reading +wrting) 意思就是Nginx 已经处理完正等候一次请求指令的驻留连接;</span><br><span class="line">UserParameter&#x3D;Mysql.dml[*], &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysql -h$1 -u$2 -p$3 -e &#39;SHOW GLOBAL STATUS&#39; | awk &#39;&#x2F;Com_$4\&gt;&#x2F;&#123;print $$2&#125;&#39; # 在&#x2F;etc&#x2F;init.d&#x2F;zabbix_agentd.d&#x2F;xx.conf中定义了以上项后; </span><br><span class="line">在zabbix-server 终端</span><br><span class="line"></span><br><span class="line">zabbix_get -s 172.16.55.124 -p 10050 -k &quot;Mysql.dml[172.16.55.124,root,password,delete]&quot;  #注意mysql用户的授权</span><br><span class="line">zabbix_get -s 172.16.55.124 -p 10050 -k &quot;Mysql.dml[172.16.55.124]&quot;</span><br><span class="line">UserParameter&#x3D;Nginx.active[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | awk &#39;&#x2F;^Active&#x2F; &#123;print $NF&#125;&#39;</span><br><span class="line">UserParameter&#x3D;Nginx.reading[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | grep &#39;Reading&#39; | cut -d&quot; &quot; -f2</span><br><span class="line">UserParameter&#x3D;Nginx.writing[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | grep &#39;Writing&#39; | cut -d&quot; &quot; -f4</span><br><span class="line">UserParameter&#x3D;Nginx.waiting[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | grep &#39;Waiting&#39; | cut -d&quot; &quot; -f6</span><br><span class="line">UserParameter&#x3D;Nginx.accepted[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | awk &#39;&#x2F;^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+&#x2F; &#123;print $$1&#125;&#39;</span><br><span class="line">UserParameter&#x3D;Nginx.handled[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | awk &#39;&#x2F;^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+&#x2F; &#123;print $$2&#125;&#39;</span><br><span class="line">UserParameter&#x3D;Nginx.requests[*], &#x2F;usr&#x2F;bin&#x2F;curl -s &quot;http:&#x2F;&#x2F;$1:$2&#x2F;status&quot; | awk &#39;&#x2F;^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+&#x2F; &#123;print $$3&#125;&#39;</span><br><span class="line"></span><br><span class="line">UserParameter&#x3D;nginx.access_countaccess, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;logcheck_nginx.accesslog totalaccess</span><br><span class="line">UserParameter&#x3D;nginx.access_count200, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;logcheck_nginx.accesslog 200access</span><br><span class="line">UserParameter&#x3D;nginx.access_count202, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;logcheck_nginx.accesslog 202access</span><br><span class="line">UserParameter&#x3D;nginx.access_count4xx, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;logcheck_nginx.accesslog 4xxaccess</span><br><span class="line">UserParameter&#x3D;nginx.access_count3xx, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;logcheck_nginx.accesslog 3xxaccess</span><br><span class="line">UserParameter&#x3D;nginx.access_count5xx, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;logcheck_nginx.accesslog 5xxaccess</span><br><span class="line"></span><br><span class="line">UserParameter&#x3D;varnish.stat[*], &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;varnishstatus varnish_stat $1</span><br><span class="line">UserParameter&#x3D;varnish.count[*], &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;varnishstatus varnish_count $1</span><br><span class="line">UserParameter&#x3D;varnish.hitrate, &#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;externalscripts&#x2F;varnishstatus varnish_hitrate</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="zabbix-自动发现功能"><a href="#zabbix-自动发现功能" class="headerlink" title="zabbix 自动发现功能"></a>zabbix 自动发现功能</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zabbix 提供网络发现功能: network discovery</span><br><span class="line">    基于HTTP、 ICMP、 SSH、 LDAP、 TCP、 SNMP、 Telnet、 Zabbix_agent扫描指定网内的主机;</span><br><span class="line">    一旦主机被发现，如何对其进行操作，将由action来决定;</span><br><span class="line">    LLD: low leverl Discovery (底级网络发现功能)</span><br><span class="line">    此二者的功能:</span><br><span class="line">        自动添加主机、链接至模板&#x2F;移除链接、自动分组、自动添加监控项、定义触发器等、执行远程脚本;</span><br><span class="line">    Discovery中的事件:</span><br><span class="line">        Service Up, Service Down, Host Up, Host Down, Service Discovered, Service Lost, Host Discovererd, Host Lost</span><br><span class="line"></span><br><span class="line">    网络发现有两个步骤:</span><br><span class="line">        discovery --&gt; action</span><br><span class="line">    actions:</span><br><span class="line">        Sending notifications</span><br><span class="line">        Adding&#x2F;removting hosts</span><br><span class="line">        Enabling&#x2F;disabling hosts</span><br><span class="line">        Adding hosts to a group</span><br><span class="line">        Removing hosts from a group </span><br><span class="line">        Linking hosts to&#x2F;unlinking from a template</span><br><span class="line">        Executing remote scripts</span><br><span class="line">        </span><br><span class="line">        自动发现功能的使用，首先要将server端和agentu端的时间自动同步;</span><br><span class="line">         # vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf </span><br><span class="line">         Server &#x3D; 172.16.55.124</span><br><span class="line">         ServerActive &#x3D; 172.16.55.124</span><br><span class="line">         Hostname &#x3D; test.xxxxxx.com</span><br><span class="line">         LogRemoteCommand &#x3D; 1</span><br><span class="line">         # systectl start zabbix-agent</span><br><span class="line">         </span><br><span class="line">         Configure --&gt; Discovery --&gt; Create discovery rule </span><br><span class="line">            --&gt; Name Local Linux Servers </span><br><span class="line">            --&gt; IP range 172.16.55.125-127</span><br><span class="line">            Delay(in sec)  3600</span><br><span class="line">            --&gt; Checks  Check type ICMP ping(最易于实现的方式) --&gt; Add</span><br><span class="line">            --&gt; Device uniqueness criteria IP address </span><br><span class="line">            --&gt; Enabled </span><br><span class="line">            Add &lt;--</span><br><span class="line">        # 当返回到Discovery 时，可以看到服务器已经被自动发现;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> # 创建动作</span><br><span class="line"> Configuration --&gt; Actions --&gt; Discovery(和以往action不同，在选项卡中先择)</span><br><span class="line"> 主机发现的条件</span><br><span class="line">    Conditions: New condition Host IP &#x3D;</span><br><span class="line">                        或者指定网络的发现规则来定义</span><br><span class="line">    Operations:  这里就可以定义对应的操作（添加到组中）</span><br><span class="line"> Configuration --&gt; Templates --&gt; </span><br><span class="line">    --&gt; Template name Linux Server Memory Stats</span><br><span class="line">    --&gt; Visible anme</span><br><span class="line">    --&gt; Groups In groups test group </span><br><span class="line">    Add &lt;--</span><br><span class="line"># 另外需要自己定义好一个模板</span><br><span class="line"></span><br><span class="line">Configuration --&gt; Actions  --&gt; Create Action</span><br><span class="line">--&gt; Conditions --&gt; Type of calculation And&#x2F;Or </span><br><span class="line">--&gt; Conditions --&gt; Host IP &#x3D; 172.16.55.125-128</span><br><span class="line">                            --&gt;Discovery rule &#x3D; Local Linux Servers</span><br><span class="line">                            --&gt; Discovery status &#x3D; Discovered</span><br><span class="line">--&gt; Operations --&gt; New</span><br><span class="line">        --&gt; Add  To host group  (Test group) # 添加到组中</span><br><span class="line">        --&gt; Link to template  Linux Server Memory status  add </span><br><span class="line">ADD &lt;--</span><br><span class="line"></span><br><span class="line">在网络的自动发现中，我们可以使用zabbix-agent来发现 </span><br><span class="line">在网络的主动发现中，由于是zabbix主动扫描，因此这种模型是非常消耗性能的</span><br></pre></td></tr></table></figure>
<p>在mariadb中查看支持的key</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MariaDB&gt; use zabbix;</span><br><span class="line">MariaDB&gt; SELECT key_ FROM items;</span><br><span class="line">使用agent-ping 来做实现主机探测;</span><br></pre></td></tr></table></figure>
<h2 id="auto-registation-主动注册功能"><a href="#auto-registation-主动注册功能" class="headerlink" title="auto_registation 主动注册功能"></a>auto_registation 主动注册功能</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Active Agent Auto-Registration</span><br><span class="line"># 首先主机之间要时间同步; </span><br><span class="line"># 安装zabbix-agent 端;</span><br><span class="line"># vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix-agent.conf</span><br><span class="line"># ServerActive&#x3D;172.16.100.6</span><br><span class="line"># Hostname&#x3D;test.xxxxx.com</span><br><span class="line"># ListenIp&#x3D;172.16.55.126</span><br><span class="line"># HostMetdata &#x3D; test4  (只用于自动注册主机的唯一标识)</span><br><span class="line"> # systemctl restart zabbix-agent </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 添加自动注册的动作</span><br><span class="line">Configuration --&gt;  Actions --&gt; (Event source Autoregistration) --&gt; Create Action</span><br><span class="line">--&gt; Actions: auto registration </span><br><span class="line">--&gt; Condition: Hostname like node4  (比如主机名中包中包涵node4) --&gt; Add</span><br><span class="line">--&gt; Operations  Add to Host groups --&gt; Link with templates 链接至模板</span><br><span class="line"># 支持使用agent(active)类型的item key:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置过程:</span><br><span class="line">    (1)定义agent端:</span><br><span class="line">        ServerActive&#x3D;</span><br><span class="line">        Server&#x3D;</span><br><span class="line">        Hostname&#x3D;</span><br><span class="line">        ListenIP&#x3D; 设置为本机某特定IP：</span><br><span class="line">        ListenPort&#x3D;</span><br><span class="line">        HostMetadata&#x3D;</span><br><span class="line">        HostMetadataItem&#x3D; item key， 一般使用system.uname</span><br><span class="line">    </span><br><span class="line">    (2) 配置action，要求其事件一源为auto-registation </span><br></pre></td></tr></table></figure>
<p>LLD: low Level Discovery </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 自动发现特定变更的名称</span><br><span class="line">    #IFNAME(接口名称) , #FSNAME(文件系统名称)</span><br><span class="line"># 主要将本地的一些特殊数据发送到服务端，比如接口类的数据;</span><br><span class="line"># 添加针对变理的Items:</span><br><span class="line"># 返回值为JSON </span><br><span class="line"></span><br><span class="line">Configurations --&gt;Templates --&gt; discovery rules --&gt; create discovery rules</span><br><span class="line">--&gt; name if lld</span><br><span class="line">--&gt; Type zabbix agent </span><br><span class="line">--&gt; Key  net.if.[#IFNAME,bytes]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 登录 zabbix数据库查询对应的key</span><br><span class="line"># use zabbix;</span><br><span class="line"># SELECT key_ FROM iem WHERE key_ LIKE &#39;%discovery%&#39;;</span><br></pre></td></tr></table></figure>
<h2 id="Web-监控"><a href="#Web-监控" class="headerlink" title="Web 监控"></a>Web 监控</h2><ul>
<li>Zabbix 还可以进行web 站点的可用性检测; </li>
<li>创建web监控需要定义一个web方案(scenarios);</li>
<li>web方案包括一个或多个HTTP请求或”步骤(step)”;</li>
<li>步骤(step)的执行过程按照预先定义的顺序进行执行;</li>
<li>通过web监控可以实时获取以下信息;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 整个web方案中所有的步骤的平均下载速度;</span><br><span class="line"># 失败的步骤号;</span><br><span class="line"># 失败的报错信息;</span><br></pre></td></tr></table></figure>
<ul>
<li>在web方案的具体步骤中，可以按需要使用如下信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 该步骤的下载速度;</span><br><span class="line"># 回应时间;</span><br><span class="line"># 回应状态码;</span><br></pre></td></tr></table></figure>
<ul>
<li>Zabbix也可以检测获取到HTML页面中是否包含预设的字符串，也可以实现登录和页面点击;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 首先需要定意一个application</span><br><span class="line"># Configuration --&gt; Hosts --&gt; Web</span><br><span class="line">    --&gt; Scenario Zabbix server</span><br><span class="line">    --&gt; google charme</span><br><span class="line">--&gt; Steps</span><br><span class="line">    --&gt; zabbix home </span><br><span class="line">    --&gt; http:&#x2F;&#x2F;172.16.55.123&#x2F;index.html</span><br><span class="line">    --&gt; Require status code 200 </span><br></pre></td></tr></table></figure>
<p>zabbix的监控方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># zabbix-web 所能够显示的且可指定为监控接口类型的监控方式:</span><br><span class="line">Agent: passive active</span><br><span class="line">SNMP: Simple Network Management Protocol</span><br><span class="line">IPMI:</span><br><span class="line">    智慧平台管理接口（Interlligent-Platform Management Interface）原本是一种Inter架构的企业系统的周边</span><br><span class="line">    设备所采用的一种工业标准;</span><br><span class="line">    IPMI亦是一开放的免费标准，使用者无需支付额外的费即可使用此标准;</span><br><span class="line">JMX: Java Manaement Extensions, 用于通过Java自己的接口对java程序进行监控;</span><br><span class="line">zabbix-java-getway用于获取监控数据:</span><br></pre></td></tr></table></figure>
<p>SNMP 监控方式 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 操作: Get, NetNext, Set , Resonse, Trap</span><br><span class="line">MIB: 是被 管理对象的集合，而且还额外定义了被管理对象的名称、访问权限、数据类型等属性;</span><br><span class="line">MIB视图: MIB的子集;</span><br><span class="line">授权:将MIB视图与Community绑定来实现;</span><br><span class="line">OID: Object ID 1.3.5.1.2.1</span><br><span class="line">    1: system </span><br><span class="line">    2: interface</span><br><span class="line">    4:ip </span><br><span class="line">    6: tcp </span><br><span class="line">    7: udp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install net-snmp  net-snmp-libs net-snmp-utils</span><br><span class="line"># vim &#x2F;etc&#x2F;snmp&#x2F;snmpd.conf </span><br><span class="line">com2sec notConfigUser default public </span><br><span class="line">group notConfigGroup v1 notConfigUser </span><br><span class="line">group notConfigGroup v2c notConfigUser </span><br><span class="line"></span><br><span class="line">view  systemview include .1.3.6.1.2.1 </span><br><span class="line">view systemview include .1.3.6.1.2.1.25.1.1</span><br><span class="line"></span><br><span class="line">access notConfigGroup &quot;&quot; any noauth exact systemview none none</span><br><span class="line"># service smpd start </span><br><span class="line"># 确定udp 的161端口已经启用;</span><br><span class="line"># 此时可以使用icmp来收集数据了;</span><br></pre></td></tr></table></figure>
<p>JMX监控方式:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(1) 安装zabbix-java-gateway:</span><br><span class="line">    配置文件: &#x2F;etc&#x2F;zabbix&#x2F;zabbix_java_gateway.conf</span><br><span class="line">    Listen_IP &#x3D; </span><br><span class="line">    Listen_PORT &#x3D; 10052</span><br><span class="line"></span><br><span class="line">    zabbix server的配置文件 &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf</span><br><span class="line">        JavaGateWay&#x3D;</span><br><span class="line">        JavaGateWayPort&#x3D; 10052</span><br><span class="line">        </span><br><span class="line">    (2) Java应用程序开户JMX接口:</span><br><span class="line">        java -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port &#x3D;10053 -Dcom.sun.management.jmxremote.authenticate&#x3D;false -Dcom.sun.management.jmxremoe.ssl&#x3D;false</span><br><span class="line"></span><br><span class="line">监控Tomcat</span><br><span class="line">        export CATALINA_OPTS&#x3D;&quot;$CATALINA_OPTS -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port &#x3D;10053 -Dcom.sun.management.jmxremote.authenticate&#x3D;false -Dcom.sun.management.jmxremoe.ssl&#x3D;false&quot;</span><br></pre></td></tr></table></figure>
<h2 id="zabbix-分布式监控概述"><a href="#zabbix-分布式监控概述" class="headerlink" title="zabbix 分布式监控概述"></a>zabbix 分布式监控概述</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Zabbix能高效地监控分布式IT架构;</span><br><span class="line"># 在大型环境中Zabbix提供两种解决方案;</span><br><span class="line">    1、使用代理(proxy);</span><br><span class="line">    2、使用节点(node);</span><br><span class="line"># 代理(proxy)用于本区域数据收集，并将数据发送给server;</span><br><span class="line"># 节点(node) 提供完整的Zabbix server用以建立分布式监控中的层级;</span><br><span class="line"># Server-Node-Client特性;</span><br><span class="line">    解决host过多时单台Server面临性能瓶颈的问题;</span><br><span class="line">        使用多个instance;</span><br><span class="line">        每个instance是独立的一套zabbix，有database和Frontend(optional);</span><br><span class="line">    支持热插拔，Node和Server的连接可以随时断开，但不影响Node的正常运行;</span><br><span class="line">    Node定时给Server发送configuration, history,event;</span><br><span class="line">    Server定时给Node发送configurations</span><br><span class="line">    所有配置变更只能在Node节点操作，不能再Server操作;</span><br><span class="line">    支持树状结构，Node又可以是多个Server;</span><br><span class="line"># Proxy vs Node</span><br><span class="line">        Node本身是一台server,它有完整的web页面，完整的数据库，它将数据源源不断传送给Master;</span><br><span class="line">        Poxy是只有一个proxy的daemon进程，proxy也有自己的数据库，但它的数据库只会保存一定时间的数据;</span><br><span class="line">        它与Master通信是将一批信息打包后发送到Master， Master将这些数据merge入Mater数据库;</span><br><span class="line"># Master-Proxy 相比Master-Node的优点有以下</span><br><span class="line">        Proxy压力小，数据库只存储一定时间数据;</span><br><span class="line">        Master压力变小，数据不是源源不断获取，减小IO压力;</span><br><span class="line">        架构更清晰，易维护；</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># zabbix-proxy 也需要被监控</span><br><span class="line"># yum -y install zabbix-proxy zabbix-proxy-mysql zabbix zabbix-agent</span><br><span class="line"># mysql </span><br><span class="line">CREATE DATABASE zabbix_proxy CHARACTER SET utf8;</span><br><span class="line">GRANT ALL ON zabbix_proxy.* TO zbxuser@&#39;172.16.%.%&#39; IDENTIFIED BY &#39;xxxxxx&#39;;</span><br><span class="line">FLUSH PREVILEGES; </span><br><span class="line"># vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_proxy.conf</span><br><span class="line">Server&#x3D;172.16.55.123</span><br><span class="line">Hostname&#x3D;test.xxxx.com</span><br><span class="line">DBHost&#x3D;172.16.55.123</span><br><span class="line">DBName&#x3D;zabbix_proxy</span><br><span class="line">DBUser&#x3D;zbxuser</span><br><span class="line">DBPassword&#x3D;xxxxxx</span><br><span class="line">ConfigFrequency&#x3D;600  #多久向服务器端拉取一次数据</span><br><span class="line"># server zabbix-proxy start </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Administration --&gt; Proxies </span><br><span class="line">Proxy name test.xxxx.com</span><br><span class="line">Proxy mode Active</span><br><span class="line">Hosts Proxy hosts</span><br><span class="line"># 再添加被监控服务器时可以在创建主机时可以指明Monitored by proxy</span><br></pre></td></tr></table></figure>
<p>zabbix database需要用到的空间:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">60000&#x2F;60 &#x3D; 1000条 </span><br><span class="line">历史数据&#x3D;天数x每秒钟处理的数据是x24x3600x50Bytes</span><br><span class="line">    90x1000x8600x50Bytes</span><br><span class="line">趋势数据:</span><br><span class="line">    每一个趋势数据128Bytes,</span><br><span class="line">        大小&#x3D;天数x监控项x24x128Bytes</span><br><span class="line">事件数据:</span><br><span class="line">    每个占据130Bytes</span><br><span class="line">        大小:天数x86400x130</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>运行一个简单的Fabric网络</title>
    <url>/2018/03/21/%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Fabric%E7%BD%91%E7%BB%9C/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="运行一个简单的Fabric网络"><a href="#运行一个简单的Fabric网络" class="headerlink" title="运行一个简单的Fabric网络"></a>运行一个简单的Fabric网络</h1><p><img src="/images/fabric.png" class="lazyload" data-srcset="/images/fabric.png" srcset="data:image/png;base64,666" alt=""><br>设定一个简单的Fabric的网络场景,包括2个organization,每个有2个peer,并使用”solo” ordering服务;网络实体所需的加密材料(x509证书)已预先生成并放到相应目录和配置文件里了。无需修改这些配置; example/e2e_cli文件夹里包含了docker-compose文件和要用来创建和测试的网络的脚本文件;  </p>
<p>另外如何使用配置生成工具configtxgen生成网络配置;  </p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>完成以下安装Fabric源码和编译configtxgen工具: </p>
<ul>
<li>完成环境，并设置正确的$GOPATH环境变量;  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在&#x2F;etc&#x2F;profile&#x2F;go.sh 中加入以下内容</span><br><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;srv&#x2F;jdk1.8.0_66&#x2F;bin:&#x2F;root&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;go&#x2F;bin</span><br><span class="line">export GOPATH&#x3D;&#x2F;opt&#x2F;gopath</span><br><span class="line">chmod +x &#x2F;etc&#x2F;profile&#x2F;go.sh   &amp;&amp; source &#x2F;etc&#x2F;profile&#x2F;go.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>接取Fabric源码;  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># git clone https:&#x2F;&#x2F;github.com&#x2F;hyperledger&#x2F;fabric.git</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果运行在linux，在Fabric目录下执行以下命令:</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd $GOPATH/src/github.com/hyperledger/fabric</span></span><br><span class="line"><span class="comment"># make configtxgen </span></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">build/bin/configtxgen</span><br><span class="line">CGO_CFLAGS=<span class="string">&quot; &quot;</span> GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/build/bin go install -tags <span class="string">&quot;nopkcs11&quot;</span> -ldflags <span class="string">&quot;-X github.com/hyperledger/fabric/common/configtx/tool/configtxgen/metadata.Version=1.0.7-snapshot-84a7e5c&quot;</span> github.com/hyperledger/fabric/common/configtx/tool/configtxgen</span><br><span class="line">Binary available as build/bin/configtxgen</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果运行在OSX，先安装Xcode 8.0或者以上版本，然后在Fabric目录下执行以下命令: </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 安装 Homebrew,若mac上有brew的可以跳过此步骤</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;ruby -e &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;Homebrew&#x2F;install&#x2F;master&#x2F;install)&quot; </span><br><span class="line"></span><br><span class="line">#添加  gnu-tar</span><br><span class="line"># brew install gnu-tar --with-default-name </span><br><span class="line"></span><br><span class="line">#添加 libtool</span><br><span class="line"># brew install libtool</span><br><span class="line"></span><br><span class="line"># 编译 configtxgen </span><br><span class="line"># make confgitxgen</span><br><span class="line">build&#x2F;bin&#x2F;configtxgen</span><br><span class="line">CGO_CFLAGS&#x3D;&quot; &quot; GOBIN&#x3D;&#x2F;Users&#x2F;johndoe&#x2F;work&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;build&#x2F;bin go install -ldflags &quot;-X github.com&#x2F;hyperledger&#x2F;fabric&#x2F;common&#x2F;metadata.Version&#x3D;1.0.0-snapshot-8d3275f -X github.com&#x2F;hyperledger&#x2F;fabric&#x2F;common &#x2F;metadata.BaseVersion&#x3D;0.3.0 -X github.com&#x2F;hyperledger&#x2F;fabric&#x2F;common&#x2F;metadata.BaseDockerLabel&#x3D;org.hyperledger.fabric&quot;       github.com&#x2F;hyperledger&#x2F;fabric&#x2F;common&#x2F;configtx&#x2F;tool&#x2F;configtxgen</span><br><span class="line">Binary available as build&#x2F;bin&#x2F;configtxgen&#96;&#96;</span><br></pre></td></tr></table></figure>
<p>编译后扫行文件放在Fabric目录下的 build/bin/configtxgen中 </p>
<h2 id="执行完整脚本"><a href="#执行完整脚本" class="headerlink" title="执行完整脚本"></a>执行完整脚本</h2><p>为了加快部署过程，Fabric提供了一个脚本 来执行所有任务。执行该脚本 会生成配置结果、本地网络、Chaincode测试;   </p>
<p>进入 <code>examples/e2e_cli</code>目录，首先从Dcoker Hub摘取镜像:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 执行脚本</span><br><span class="line">#  bash .&#x2F;download-dockerimages.sh </span><br></pre></td></tr></table></figure>
<p>这个执行过程耗时会比较长，脚本执行后输出: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&gt; List out hyperledger docker images</span><br><span class="line">hyperledger&#x2F;fabric-ca          latest               35311d8617b4        7 days ago          240 MB</span><br><span class="line">hyperledger&#x2F;fabric-ca          x86_64-1.0.0-alpha   35311d8617b4        7 days ago          240 MB</span><br><span class="line">hyperledger&#x2F;fabric-couchdb     latest               f3ce31e25872        7 days ago          1.51 GB</span><br><span class="line">hyperledger&#x2F;fabric-couchdb     x86_64-1.0.0-alpha   f3ce31e25872        7 days ago          1.51 GB</span><br><span class="line">hyperledger&#x2F;fabric-kafka       latest               589dad0b93fc        7 days ago          1.3 GB</span><br><span class="line">hyperledger&#x2F;fabric-kafka       x86_64-1.0.0-alpha   589dad0b93fc        7 days ago          1.3 GB</span><br><span class="line">hyperledger&#x2F;fabric-zookeeper   latest               9a51f5be29c1        7 days ago          1.31 GB</span><br><span class="line">hyperledger&#x2F;fabric-zookeeper   x86_64-1.0.0-alpha   9a51f5be29c1        7 days ago          1.31 GB</span><br><span class="line">hyperledger&#x2F;fabric-orderer     latest               5685fd77ab7c        7 days ago          182 MB</span><br><span class="line">hyperledger&#x2F;fabric-orderer     x86_64-1.0.0-alpha   5685fd77ab7c        7 days ago          182 MB</span><br><span class="line">hyperledger&#x2F;fabric-peer        latest               784c5d41ac1d        7 days ago          184 MB</span><br><span class="line">hyperledger&#x2F;fabric-peer        x86_64-1.0.0-alpha   784c5d41ac1d        7 days ago          184 MB</span><br><span class="line">hyperledger&#x2F;fabric-javaenv     latest               a08f85d8f0a9        7 days ago          1.42 GB</span><br><span class="line">hyperledger&#x2F;fabric-javaenv     x86_64-1.0.0-alpha   a08f85d8f0a9        7 days ago          1.42 GB</span><br><span class="line">hyperledger&#x2F;fabric-ccenv       latest               91792014b61f        7 days ago          1.29 GB</span><br><span class="line">hyperledger&#x2F;fabric-ccenv       x86_64-1.0.0-alpha   91792014b61f        7 days ago          1.29 GB</span><br><span class="line">现在运行完整脚本：</span><br></pre></td></tr></table></figure>
<p>现在运行完整脚本: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash network_setup.sh up mychannel</span><br></pre></td></tr></table></figure>
<p>如果没有设置 <code>channel-ID</code>参数，channel名默认是<code>mychannel</code>。脚本执行成功后输出: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Query on PEER3 on channel &#39;mychannel&#39; is successful &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; All GOOD, End-2-End execution completed &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<p>此时，网络启动运行并测试成功</p>
<h2 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h2><p>停止网络:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在e2e_cli目录下 </span></span><br><span class="line"><span class="comment"># docker rm -f $(docker ps -aq)</span></span><br></pre></td></tr></table></figure>
<p>然后执行 <code>docker images</code>命令查看Chaincode镜像，类似输出如下:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REPOSITORY                     TAG                  IMAGE ID            CREATED             SIZE</span><br><span class="line">dev-peer3-mycc-1.0             latest               13f6c8b042c6        5 minutes ago       176 MB</span><br><span class="line">dev-peer0-mycc-1.0             latest               e27456b2bd92        5 minutes ago       176 MB</span><br><span class="line">dev-peer2-mycc-1.0             latest               111098a7c98c        5 minutes ago       176 MB</span><br></pre></td></tr></table></figure>
<p>删除镜像:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker rmi &lt;IMAGE ID&gt; &lt;IMAGE ID&gt; &lt;IMAGE ID&gt;</span><br></pre></td></tr></table></figure>
<p>例如:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker rmi -f 13e e122 333</span><br></pre></td></tr></table></figure>
<p>最后删除配置结果， 在<code>crypto/orderer</code> 目录删除 <code>orderer.block</code>和channel.tx;   </p>
<h2 id="configtxgen"><a href="#configtxgen" class="headerlink" title="configtxgen"></a>configtxgen</h2><p>configtxgen 工具生成两个内容: Orderer的bootstrap block和Fabric的channel configuration transaction;    </p>
<p>roderer block是ordering服务的创世区块; channel transaction文件在create channel时会被广播给orderer;   </p>
<p><code>configtx.yaml</code>包含网络的定义，并给出了网络组件的拓扑结构-2个成员(Org0和Org1)分别管理维护2个peer。 还指出每个网络实体的加密材料的存储位置。<code>crypto</code>目录包含每个实体的admin证书、ca证书、签名证书和私钥;  </p>
<p>为了方便使用，官方提供了一个脚本 <code>generateCfgTrx.sh</code>,该脚本整合了<code>configtxgen</code>的执行过程，执行后会生成两个配置结果:<code>orderer.block</code>和<code>channel.tx</code>。如果运行过上边<code>network_setup.sh</code>则这两个配置结果已生成，要先到<code>crypto/orderere</code>目录将之删除;  </p>
<h2 id="执行generateCfgTrx-sh脚本"><a href="#执行generateCfgTrx-sh脚本" class="headerlink" title="执行generateCfgTrx.sh脚本"></a>执行<code>generateCfgTrx.sh</code>脚本</h2><p>在<code>e2e_cli</code>目录下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd $GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli</span><br></pre></td></tr></table></figure>
<p><code>generateCfgTrx.sh</code>脚本有个可选能数channel-ID,如果不设此参数，则默认为mychannel；  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &lt;channel-ID&gt;参数是要可选的</span><br><span class="line"># bash generateCfgTrx.sh &lt;channel-ID&gt;</span><br></pre></td></tr></table></figure>
<p>执行成功后输出:   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2017&#x2F;02&#x2F;28 17:01:52 Generating new channel configtx</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 Creating no-op MSP instance</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 Obtaining default signing identity</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 Creating no-op signing identity instance</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 Serializing identity</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 signing message</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 signing message</span><br><span class="line">2017&#x2F;02&#x2F;28 17:01:52 Writing new channel tx</span><br></pre></td></tr></table></figure>
<p>生成的<code>orderer.block</code>和<code>channel.tx</code>两个文件存放在<code>corypto/orderer</code>目录;  </p>
<p><code>orderer.block</code>是ordering服务的创世区块，<code>channel.tx</code>包含新channel的配置信息。如前所述，这俩文件 都来自configtx.yaml及其所包含的加密材料和网络信息的数据;   </p>
<p>注: 也可以手动执行脚本<code>generateCfgTrx.sh</code>里的命令。如果傅这种方式，则必需先用<code>e2e_cli</code>目录下的<code>configtx.yaml</code>替换Fabric sampleconfgi目录下默认的<code>configtx.yaml</code>，然后返回fabric目录执行这些命令，前提是删除之前的<code>generateCfgTrx.sh</code>生成的两个文件;    </p>
<h2 id="启动网络"><a href="#启动网络" class="headerlink" title="启动网络"></a>启动网络</h2><p>使用docker-compose启动网络，如果还没有摘取 Fabric镜像，则返回之前的操作去拉取镜像;  </p>
<p>脚本<code>scrpit.sh</code>嵌入到docker-compose文件里，该脚本将peer加入到channel并向peer发送read/write请求，如此便可自动执行交易流程。如果还不想使用这个脚本自动执行交易，可以跳到下面”手动执行交易”一节;    </p>
<p>在<code>e2e_cli</code>目录下使用docker-compose生成网络实体并执行嵌入的脚本:    </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CHANNEL_NAME&#x3D;&lt;channel-id&gt; docker-compose up -d </span><br></pre></td></tr></table></figure>
<p>如果之前创建了个channel名，就必须将其作为参数，否则使用默认的mychannel。例如:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CHANNEL_NAME&#x3D;mychannel dcoker -comopse up -d </span><br></pre></td></tr></table></figure>
<p>等待一会儿，因为背后有交易会发送到peer。执行<code>docker ps</code>查看运行状态的container，可以看到以下内容:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vagrant@hyperledger-devenv:v0.3.0-4eec836:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;e2e_cli$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED              STATUS              PORTS                                              NAMES</span><br><span class="line">45e3e114f7a2        dev-peer3-mycc-1.0           &quot;chaincode -peer.a...&quot;   4 seconds ago        Up 4 seconds                                                           dev-peer3-mycc-1.0</span><br><span class="line">5970f740ad2b        dev-peer0-mycc-1.0           &quot;chaincode -peer.a...&quot;   24 seconds ago       Up 23 seconds                                                          dev-peer0-mycc-1.0</span><br><span class="line">b84808d66e99        dev-peer2-mycc-1.0           &quot;chaincode -peer.a...&quot;   48 seconds ago       Up 47 seconds                                                          dev-peer2-mycc-1.0</span><br><span class="line">16d7d94c8773        hyperledger&#x2F;fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:10051-&gt;7051&#x2F;tcp, 0.0.0.0:10053-&gt;7053&#x2F;tcp   peer3</span><br><span class="line">3561a99e35e6        hyperledger&#x2F;fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:9051-&gt;7051&#x2F;tcp, 0.0.0.0:9053-&gt;7053&#x2F;tcp     peer2</span><br><span class="line">0baad3047d92        hyperledger&#x2F;fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:8051-&gt;7051&#x2F;tcp, 0.0.0.0:8053-&gt;7053&#x2F;tcp     peer1</span><br><span class="line">1216896b7b4f        hyperledger&#x2F;fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:7051-&gt;7051&#x2F;tcp, 0.0.0.0:7053-&gt;7053&#x2F;tcp     peer0</span><br><span class="line">155ff8747b4d        hyperledger&#x2F;fabric-orderer   &quot;orderer&quot;                About a minute ago   Up About a minute   0.0.0.0:7050-&gt;7050&#x2F;tcp                             orderer</span><br></pre></td></tr></table></figure>
<h2 id="背后发生了什么？"><a href="#背后发生了什么？" class="headerlink" title="背后发生了什么？"></a>背后发生了什么？</h2><ul>
<li><p>在CLI容器中执行了脚本<code>script.sh</code>。该脚本用默认的<code>mychannel</code>执行<code>createChannel</code>命令，这个命令用到了之前<code>configtxgen</code>工具生成的<code>channel.tx</code>。   </p>
</li>
<li><p><code>createChannel</code>执行后会生成一个创世区块<code>mychannel.block</code>并保存到当前目录 ;   </p>
</li>
<li><p>对4个peer分别执行<code>joinChannel</code>命令，通过初始区块<code>mychannel.block</code>加入channel。 至此有一个channel包含4个peer和2个organzation；  </p>
</li>
<li><p><code>PER0</code>和<code>PEER1</code>属于Org0, <code>PEER2</code>和    <code>PEER3</code>属于Org1。这些关系的定义都在<code>confiigtx.yaml</code>中   </p>
</li>
<li><p>Chaincode<code>chaincode_example02</code>被 install到<code>PEER0</code>和<code>PEER2</code></p>
</li>
<li><p>然后Chaincode在<code>PEER2</code>上instantiate。实例化是指启动容器和初始化与Chaincode相关的键值对，本例中的初始值 是<code>[&quot;a&quot;,&quot;100&quot; &quot;b&quot;,&quot;200&quot;]</code>。实例化的结果是一个名为<code>dev-peer2-mycc-1.0</code>的容器启动，注意，这个容器仅是针对<code>PEER2</code>;  </p>
</li>
<li><p>实例化时还会带有背书策略参数，本例中背书策略为”-P” OR(‘OrgOMSP.memeber”,Org1MSP.member’)”,意思是任何交易必须由绑定到Org0或者Org1的peer背书;   </p>
</li>
<li><p>对于”a”的query请求发慈禧太后到<code>PEER0</code>。在之前Chaincode被install到<code>PEER0</code>了，所以就可以启动一个名为<code>dev-peer0-mycc-1.0</code>的新容器，然后返回查询结果。由于没有write操作发生，所以”a”的值依然是”100”。  </p>
</li>
<li><p>从”a”转移”10”给”b”的invoke请求发送到<code>PEER0</code></p>
</li>
<li><p>Chaincode install 到 <code>PEER3</code></p>
</li>
<li><p>对”a”的query 请求发关到<code>PEER3</code>。 这启动了第三个名为<code>dev-peer3-mycc-1.0</code>的容器，并返回查询结果90，正确的反应了之前的交易;   </p>
</li>
</ul>
<p>Chaincode必须被 install到一个peer上才能成功的对这个peer的ledger执行read/write操作。此外，只有当在peer上针对chaincode执行read/writer操作时，这个peer上才会启该chaincode容器(比如，查询”a”的值)交易到容器启动。channel中的所有peer（包括那结没有install chaincode的peer，就像上例中的<code>PEER3</code>）都会维护一个准确的ledger，ledger包含存储了不可变的、有序的交易记录的block，还有维护current state的statedb。在peer上install chaincode之后就可以直接使用该peer上的chaincode了（就像上例中的<code>PEER3</code>），因为之前已经instantiated过了;    </p>
<p>查看交易</p>
<p>查看CLI容器的log:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker logs -f cli </span><br></pre></td></tr></table></figure>
<p>输出: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2017-02-28 04:31:20.841 UTC [logging] InitFromViper -&gt; DEBU 001 Setting default logging level to DEBUG for command &#39;chaincode&#39;</span><br><span class="line">2017-02-28 04:31:20.842 UTC [msp] GetLocalMSP -&gt; DEBU 002 Returning existing local MSP</span><br><span class="line">2017-02-28 04:31:20.842 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 003 Obtaining default signing identity</span><br><span class="line">2017-02-28 04:31:20.843 UTC [msp] Sign -&gt; DEBU 004 Sign: plaintext: 0A8F050A59080322096D796368616E6E...6D7963631A0A0A0571756572790A0161</span><br><span class="line">2017-02-28 04:31:20.843 UTC [msp] Sign -&gt; DEBU 005 Sign: digest: 52F1A41B7B0B08CF3FC94D9D7E916AC4C01C54399E71BC81D551B97F5619AB54</span><br><span class="line">Query Result: 90</span><br><span class="line">2017-02-28 04:31:30.425 UTC [main] main -&gt; INFO 006 Exiting.....</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Query on chaincode on PEER3 on channel &#39;mychannel&#39; is successful &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; All GOOD, End-2-End execution completed &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<p>实时查看日志时，需要打开两个终端;  </p>
<p>首先，停止运行着的docker容器:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker rm -f $(docker ps -aq)</span><br></pre></td></tr></table></figure>
<p>在第一个终端启动docker-compose脚本:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CHANNEL_NAME&#x3D;&lt;channel-id&gt; docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>在第二个终端查看log：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker logs -f cli </span><br></pre></td></tr></table></figure>
<p>这将实时输出通过<code>script.sh</code>执行的交易信息;  </p>
<h2 id="查看chaincode日志"><a href="#查看chaincode日志" class="headerlink" title="查看chaincode日志"></a>查看chaincode日志</h2><p>对每个chaincode容器单独查看log，输出:   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ docker logs dev-peer2-mycc-1.0</span><br><span class="line">04:30:45.947 [BCCSP_FACTORY] DEBU : Initialize BCCSP [SW]</span><br><span class="line">ex02 Init</span><br><span class="line">Aval &#x3D; 100, Bval &#x3D; 200</span><br><span class="line"></span><br><span class="line">$ docker logs dev-peer0-mycc-1.0</span><br><span class="line">04:31:10.569 [BCCSP_FACTORY] DEBU : Initialize BCCSP [SW]</span><br><span class="line">ex02 Invoke</span><br><span class="line">Query Response:&#123;&quot;Name&quot;:&quot;a&quot;,&quot;Amount&quot;:&quot;100&quot;&#125;</span><br><span class="line">ex02 Invoke</span><br><span class="line">Aval &#x3D; 90, Bval &#x3D; 210</span><br><span class="line"></span><br><span class="line">$ docker logs dev-peer3-mycc-1.0</span><br><span class="line">04:31:30.420 [BCCSP_FACTORY] DEBU : Initialize BCCSP [SW]</span><br><span class="line">ex02 Invoke</span><br><span class="line">Query Response:&#123;&quot;Name&quot;:&quot;a&quot;,&quot;Amount&quot;:&quot;90&quot;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="手动执行交易"><a href="#手动执行交易" class="headerlink" title="手动执行交易"></a>手动执行交易</h2><p>停止所有容器:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker rm -f $(docker ps -aq)</span><br></pre></td></tr></table></figure>
<p>然后，执行<code>docker iamge</code> 命令查看chaincode镜像，会有类似以下内容:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REPOSITORY                     TAG                  IMAGE ID            CREATED             SIZE</span><br><span class="line">dev-peer3-mycc-1.0             latest               13f6c8b042c6        5 minutes ago       176 MB</span><br><span class="line">dev-peer0-mycc-1.0             latest               e27456b2bd92        5 minutes ago       176 MB</span><br><span class="line">dev-peer2-mycc-1.0             latest               111098a7c98c        5 minutes ago       176 MB</span><br></pre></td></tr></table></figure>
<p>删除这些镜像：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi &lt;IMAGE ID&gt; &lt;IMAGE ID&gt; &lt;IMAGE ID&gt;</span><br></pre></td></tr></table></figure>
<p>比如:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker rmi -f 12f e27 111 </span><br></pre></td></tr></table></figure>
<p>确保之前生成的配置内容还在，如果删除了就再执行脚本:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;generatecCfgTrx.sh&lt;channel-ID&gt;</span><br></pre></td></tr></table></figure>
<p>或者使用脚本中的命令手动生成;   </p>
<h2 id="修改docker-compose文件"><a href="#修改docker-compose文件" class="headerlink" title="修改docker-compose文件"></a>修改docker-compose文件</h2><p>打开docker-compose文件注释掉执行<code>script.sh</code>脚本的命令，如下:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">working_dir: &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer</span><br><span class="line"># command: &#x2F;bin&#x2F;bash -c &#39;.&#x2F;scripts&#x2F;script.sh $&#123;CHANNEL_NAME&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>保存文件 ，重启网络:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在e2e_cli目录下执行，设置正确的CHANNEL_NAME</span><br><span class="line">CHANNEL_NAME&#x3D;&lt;channel-id&gt; docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>命令语法</p>
<p>参照 <code>script.sh</code>脚本中的creaete和join命令。下面的命令只是针对<code>PEER0</code>的，当对orderer和peer执行命令，需要修改下面给出的四个环境变量的值;   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 对PEER0所用的环境变量</span><br><span class="line">CORE_PEER_MSPCONFIGPATH&#x3D;$GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;peer&#x2F;peer0&#x2F;localMspConfig</span><br><span class="line">CORE_PEER_ADDRESS&#x3D;peer0:7051</span><br><span class="line">CORE_PEER_LOCALMSPID&#x3D;&quot;Org0MSP&quot;</span><br><span class="line">CORE_PEER_TLS_ROOTCERT_FILE&#x3D;$GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;peer&#x2F; peer0&#x2F;localMspConfig&#x2F;cacerts&#x2F;peerOrg0.pem</span><br></pre></td></tr></table></figure>
<p>第个peer的环境变的值都在docker-compose文件中</p>
<h2 id="Create-channel"><a href="#Create-channel" class="headerlink" title="Create channel"></a>Create channel</h2><p>进去cli容器:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker exec -it cli bash</span><br></pre></td></tr></table></figure>
<p>执行成功输出: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@0d78bb69300d:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer#</span><br></pre></td></tr></table></figure>
<p>用<code>-c</code>指定channel name, <code>-f</code>指定channel configruation transaction(此例中是<code>channel.tx</code>)当然也可以使用不同的名称安装configuration transaction;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># channel.tx 和 orderer.block 在 cli 容器的 crypto&#x2F;orderer 目录下</span><br><span class="line">peer channel create -o orderer0:7050 -c mychannel -f crypto&#x2F;orderer&#x2F;channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem</span><br></pre></td></tr></table></figure>
<p>由于此例的<code>peer channel create</code>命令是针对orderer的，所以需要修改之前的环境变量，因此上边的命令应该是: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CORE_PEER_MSPCONFIGPATH&#x3D;$GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig CORE_PEER_LOCALMSPID&#x3D;&quot;OrdererMSP&quot; peer channel create -o orderer0:7050 -c mychannel -f crypto&#x2F;orderer&#x2F;channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem</span><br></pre></td></tr></table></figure>
<p>注意:下面的其他命令依然在CLI容中执行，而且要记住命令里每个peer对应的环境变量;   </p>
<p>将指定的peer加入到channel:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#默认只将 PEER0 加入 </span><br><span class="line">peer channel join -b mychannel.block </span><br></pre></td></tr></table></figure>
<p>完整的命令应该是: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CORE_PEER_MSPCONFIGPATH&#x3D;$GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;peer&#x2F;peer0&#x2F;localMspConfig CORE_PEER_ADDRESS&#x3D;peer0:7051 CORE_PEER_LOCALMSPID&#x3D;&quot;Org0MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE&#x3D;$GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;peer&#x2F;peer0&#x2F;localMspConfig&#x2F;cacerts&#x2F;peerOrg0.pem peer channel join -b mychannel.block</span><br></pre></td></tr></table></figure>
<p>修改这四个环境变量将其他的peer加入到channel中 </p>
<p>将示例chaincode代码安装到四个对等节点中的一个:</p>
<p>Install chaincode<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在命令前面要加上peer对应的四个环境变量</span><br><span class="line">peer chaincode install -n mycc -v 1.0 -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;chaincode_example02</span><br></pre></td></tr></table></figure><br>在一个peer上实例化chaincode，这将对该peer启动一个chaincode容器，并为该chaincode设置背书策略。此例中定义的策略是有<code>org0</code>或<code>org1</code>中的一个peer背书即可;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在命令前面要加上peer对应的四个环境变量</span><br><span class="line"># 用 -C 参数设置正确的channel名，默认是 mychannel</span><br><span class="line">peer chaincode instantiate -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n mycc -v 1.0 -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;chaincode_example02 -c &#39;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&#39; -P &quot;OR (&#39;Org0MSP.member&#39;,&#39;Org1MSP.member&#39;)&quot;</span><br></pre></td></tr></table></figure>
<p>Invoke chaincode </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在命令前面要加上peer对应的四个环境变量</span><br><span class="line">peer chaincode invoke -o orderer0:7050  --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem  -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>Query chaincode </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在命令前面要加上peer对应的四个环境变量</span><br><span class="line">peer chaincode query -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>执行结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query Result: 90</span><br></pre></td></tr></table></figure>
<h2 id="手动构建镜像"><a href="#手动构建镜像" class="headerlink" title="手动构建镜像"></a>手动构建镜像</h2><p>构建peer和orderer镜像:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 在farbic目录下执行，如果不能顺利生成镜像，则使用vagrant环境</span><br><span class="line"># make peer-docker orderer-docker </span><br></pre></td></tr></table></figure>
<p>执行<code>docker images</code>命令输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vagrant@hyperledger-devenv:v0.3.0-4eec836:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric$ docker images</span><br><span class="line">REPOSITORY                     TAG                             IMAGE ID            CREATED             SIZE</span><br><span class="line">hyperledger&#x2F;fabric-orderer     latest                          264e45897bfb        10 minutes ago      180 MB</span><br><span class="line">hyperledger&#x2F;fabric-orderer     x86_64-0.7.0-snapshot-a0d032b   264e45897bfb        10 minutes ago      180 MB</span><br><span class="line">hyperledger&#x2F;fabric-peer        latest                          b3d44cff07c6        10 minutes ago      184 MB</span><br><span class="line">hyperledger&#x2F;fabric-peer        x86_64-0.7.0-snapshot-a0d032b   b3d44cff07c6        10 minutes ago      184 MB</span><br><span class="line">hyperledger&#x2F;fabric-javaenv     latest                          6e2a2adb998a        10 minutes ago      1.42 GB</span><br><span class="line">hyperledger&#x2F;fabric-javaenv     x86_64-0.7.0-snapshot-a0d032b   6e2a2adb998a        10 minutes ago      1.42 GB</span><br><span class="line">hyperledger&#x2F;fabric-ccenv       latest                          0ce0e7dc043f        12 minutes ago      1.29 GB</span><br><span class="line">hyperledger&#x2F;fabric-ccenv       x86_64-0.7.0-snapshot-a0d032b   0ce0e7dc043f        12 minutes ago      1.29 GB</span><br><span class="line">hyperledger&#x2F;fabric-baseimage   x86_64-0.3.0                    f4751a503f02        4 weeks ago         1.27 GB</span><br><span class="line">hyperledger&#x2F;fabric-baseos      x86_64-0.3.0                    c3a4cf3b3350        4 weeks ago         161 MB</span><br></pre></td></tr></table></figure>
<h2 id="使用本地二进制文件"><a href="#使用本地二进制文件" class="headerlink" title="使用本地二进制文件"></a>使用本地二进制文件</h2><p>进支vagrant环境 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd $GOPATH&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;devenv</span><br><span class="line"></span><br><span class="line"># 第一次启动VM用 vagrant up </span><br><span class="line">vagrant ssh</span><br></pre></td></tr></table></figure>
<p>在fabric目录编译peer和orderer:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">make clean</span><br><span class="line">make native</span><br></pre></td></tr></table></figure>
<p>生成<code>ccenv</code>镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">make peer-docker</span><br></pre></td></tr></table></figure>
<p>然后打开两个终端都进入vagrant，至此有三个终端都在vagrant里;<br>首先清空ledger文件<code>/var/hyperledger/</code> (每次运行后，为避免错误或重复，都要清空): </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm -rf &#x2F;var&#x2F;hyperledger&#x2F;* </span><br></pre></td></tr></table></figure>
<p>使用<code>configtxgen</code>工具创建orderer创世区块:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">configtxgen -profile SampleMSPSolo -outputBlock orderer.block </span><br></pre></td></tr></table></figure>
<p>用刚生成的创世区块启动orderer: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ORDERER_GENERAL_GENESISMETHOD&#x3D;file ORDERER_GENERAL_GENESISFILE&#x3D;.&#x2F;orderer.block orderer</span><br></pre></td></tr></table></figure>
<p>创建 channel  configuration transaction: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">configtxgen -profile  SampleSingleMSPSolo -outputCreateChannelTx channel.tx -channelID &lt;channel-ID&gt;</span><br></pre></td></tr></table></figure>
<p>执行成功会在当前目录生成<code>channel.tx</code></p>
<p>以<code>chanless</code>模块启动peer: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer node start --peer-defaultchain-false</span><br></pre></td></tr></table></figure>
<p>以<code>channel.tx</code>为参数创建channel:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer channel create -o 127.0.0.1:7050 -c mychannel -f channel.tx</span><br></pre></td></tr></table></figure>
<p>执行后在当前目录生成一个channel的创世区块<code>mychannel.block</code> </p>
<p>Join channel<br>通过channel的创世区块<code>mychannel.block</code>加入channel: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer channel join -b mychannel.block</span><br></pre></td></tr></table></figure>
<p>Install chaincode<br>在peer上安装chaincode:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode install -o 127.0.0.1:7050 -n mycc -v 1.0 -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;chaincode_example02</span><br></pre></td></tr></table></figure>
<p>执行成功后查看文件可以看到mycc.1.0: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls &#x2F;var&#x2F;hyperledger&#x2F;production&#x2F;chaincodes</span><br></pre></td></tr></table></figure>
<p>Instantiate chaincode </p>
<p>实例化chaincode:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode instantiate -o 127.0.0.1:7050 -C mychannel -n mycc -v 1.0 -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;chaincode_example02 -c &#39;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p><code>docker ps</code>查看运行中的容器，如果chaincode启动成功，则显示: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">bd9c6bda7560        dev-jdoe-mycc-1.0   &quot;chaincode -peer.a...&quot;   5 seconds ago       Up 5 seconds                            dev-jdoe-mycc-1.0</span><br></pre></td></tr></table></figure>
<p>Invoke chaincode<br>调用chaincode从”a”转移”10”给”b”:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode invoke -o 127.0.0.1:7050 -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>Query chaincode<br>查询”a”的值: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 返回值应是 90</span><br><span class="line">peer chaincode query -o 127.0.0.1:7050 -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>运行完成后不要忘记清空ledger文件夹<code>/var/hyperledger</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm -rf &#x2F;var&#x2F;hyperledger&#x2F;* </span><br></pre></td></tr></table></figure>
<h2 id="使用CouchDB"><a href="#使用CouchDB" class="headerlink" title="使用CouchDB"></a>使用CouchDB</h2><p>可以将stateDB默认的goleveldb替换成CouchDB。对于CouchDB, chainocde各功能依然可用，但将chaincode数据以JSON方式存储的话就可以使用CouchDB的复杂查询的功能;    </p>
<p>为了使用CouchDB，除了最前面的”前提”一节的操作外，还需要下边两步启动CouchDB容器并将之与peer容器关联;   </p>
<ul>
<li>构建 CouchDB镜像 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># make sure you are in the fabric directory</span><br><span class="line">make couchdb</span><br></pre></td></tr></table></figure>
<ul>
<li>编辑<code>fabric/example/e2e_cli/docker-compose.yaml</code> 和<code>docker-compose.yam</code> 将所有与CouchDB有关的内容取消注释。这样  <code>chaincode_xample02</code>就可以CouchDB下运行了;   </li>
</ul>
<p>注意:如果将CouchDB容器的端口映射的主机，请一定要注意安全，在开发环境 中将端映射出来可以通过CouchDB的web界面可视化操作数据。生产环境中一般不会做端口映射，以限制CouchDB的外部访问;   </p>
<p>可以用<code>chaincode_example02</code>在CouldDB下执行上边的chaincode操作，但是为了使用CouchDB的复杂查询功能，chaincode数据一定要以JSON格式存储(例如 fabric/examples/chaincode/go/merbles02);   </p>
<p>使用<code>手动执行交易</code>这一节中的步骤install、instantiate、invoke和query<code>marbles02</code>，执行完成<code>join channel</code>这步后使用下边的命令操作<code>marbles02</code>: </p>
<ul>
<li>在<code>PEER0</code>上安装实例化chaincode</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode install -o orderer0:7050 -n marbles -v 1.0 -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;marbles02</span><br><span class="line">peer chaincode instantiate -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -v 1.0 -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;marbles02 -c &#39;&#123;&quot;Args&quot;:[&quot;init&quot;]&#125;&#39; -P &quot;OR (&#39;Org0MSP.member&#39;,&#39;Org1MSP.member&#39;)&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一些marble并移动它们</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;initMarble&quot;,&quot;marble1&quot;,&quot;blue&quot;,&quot;35&quot;,&quot;tom&quot;]&#125;&#39;</span><br><span class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;initMarble&quot;,&quot;marble2&quot;,&quot;red&quot;,&quot;50&quot;,&quot;tom&quot;]&#125;&#39;</span><br><span class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;initMarble&quot;,&quot;marble3&quot;,&quot;blue&quot;,&quot;70&quot;,&quot;tom&quot;]&#125;&#39;</span><br><span class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;transferMarble&quot;,&quot;marble2&quot;,&quot;jerry&quot;]&#125;&#39;</span><br><span class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;transferMarblesBasedOnColor&quot;,&quot;blue&quot;,&quot;jerry&quot;]&#125;&#39;</span><br><span class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile &#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer&#x2F;crypto&#x2F;orderer&#x2F;localMspConfig&#x2F;cacerts&#x2F;ordererOrg0.pem -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;delete&quot;,&quot;marble1&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果做了CouchDB容器的端口映射，可以通过web界面查看数据，可以看到名为<code>mychannel</code>的数据库及其文档 </p>
</li>
<li><p>如果使用的是vagrant环境 </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:15984&#x2F;_utils</span><br><span class="line">* 如果不是vagrant环境，使用CouchDB容器指定的端口</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;localhost:5984&#x2F;_utils</span><br></pre></td></tr></table></figure>
<ul>
<li>有可规律的查询chaincode(例如,读取marble2) </li>
</ul>
<p>peer chaincode query-C mychannel -n marbles -c {“Args”:[“readMarble”,”marble2”]}’</p>
<p>可以看到<code>mable2</code>的详细信息:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query Result: &#123;&quot;color&quot;:&quot;red&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble2&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:50&#125;</span><br></pre></td></tr></table></figure>
<p>获取 <code>marble1</code>的历史 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;getHistoryForMarble&quot;,&quot;marble1&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>可以看到操作过<code>marbel1</code>的交易: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query Result: [&#123;&quot;TxId&quot;:&quot;1c3d3caf124c89f91a4c0f353723ac736c58155325f02890adebaa15e16e6464&quot;, &quot;Value&quot;:&#123;&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble1&quot;,&quot;color&quot;:&quot;blue&quot;,&quot;size&quot;:35,&quot;owner&quot;:&quot;tom&quot;&#125;&#125;,&#123;&quot;TxId&quot;:&quot;755d55c281889eaeebf405586f9e25d71d36eb3d35420af833a20a2f53a3eefd&quot;, &quot;Value&quot;:&#123;&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble1&quot;,&quot;color&quot;:&quot;blue&quot;,&quot;size&quot;:35,&quot;owner&quot;:&quot;jerry&quot;&#125;&#125;,&#123;&quot;TxId&quot;:&quot;819451032d813dde6247f85e56a89262555e04f14788ee33e28b232eef36d98f&quot;, &quot;Value&quot;:&#125;]</span><br></pre></td></tr></table></figure>
<p> 还可以执行复杂查询,比喻如查询<code>jerry</code>所拥有的marble:</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;queryMarblesByOwner&quot;,&quot;jerry&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>查询结果为<code>jerry</code>所拥有的2个marble的信息: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;queryMarblesByOwner&quot;,&quot;jerry&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>查询结果为<code>jerry</code>所拥有的2个marble的信息:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query Result: [&#123;&quot;Key&quot;:&quot;marble2&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;red&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble2&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:50&#125;&#125;,&#123;&quot;Key&quot;:&quot;marble3&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;blue&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble3&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:70&#125;&#125;]</span><br></pre></td></tr></table></figure>
<p>通过<code>owner</code>字段等于<code>jerry</code>查询:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n marbles -c &#39;&#123;&quot;Args&quot;:[&quot;queryMarbles&quot;,&quot;&#123;\&quot;selector\&quot;:&#123;\&quot;owner\&quot;:\&quot;jerry\&quot;&#125;&#125;&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>查询结果如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query Result: [&#123;&quot;Key&quot;:&quot;marble2&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;red&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble2&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:50&#125;&#125;,&#123;&quot;Key&quot;:&quot;marble3&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;blue&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble3&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:70&#125;&#125;]</span><br></pre></td></tr></table></figure>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>如果需要对peer或CouchDB容器的数据持久化，一种是选择是将容器的相关目录挂载到docker主机;<br>例如，将下面两内容器入到<code>docker-compose.yaml</code>文件中的对应peer处:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volumes:</span><br><span class="line"> - &#x2F;var&#x2F;hyperledger&#x2F;peer0:&#x2F;var&#x2F;hyperledger&#x2F;production</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volumes:</span><br><span class="line">- &#x2F;var&#x2F;hyperledger&#x2F;couchdb0:&#x2F;opt&#x2F;couchdb&#x2F;data</span><br></pre></td></tr></table></figure>
<p>故障排除 </p>
<ul>
<li>每次运行后要清理文件</li>
<li>如果出现docker错误，则删除镜像，从头再操作一遍;  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">make clean </span><br><span class="line">make peer-docker orderer-docker</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现下面的错误 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Error: Error endorsing chaincode: rpc error: code &#x3D; 2 desc &#x3D; Error installing chaincode code mycc:1.0(chaincode &#x2F;var&#x2F;hyperledger&#x2F;production&#x2F;chaincodes&#x2F;mycc.1.0 exits)</span><br></pre></td></tr></table></figure>
<p>chaincode镜像(如<code>dev-peer0-mycc-1.0</code>或<code>dev-peer1-mycc-1.0</code>)可能是以前运行过的，删除它们然后重试;  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker rmi -f $(docker images | grep peer[0-9]-peer[0-9] | awk &#39;&#123;print $3&#125;&#39;)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>down</code>选项清理网络 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;network_setup.sh down </span><br><span class="line">Next Previous</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Hyperledger Fabric Chaincode for Operators</title>
    <url>/2018/03/20/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="实操智能合约"><a href="#实操智能合约" class="headerlink" title="实操智能合约"></a>实操智能合约</h1><p><img src="/images/heyue.jpg" class="lazyload" data-srcset="/images/heyue.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="什么是Chaincode"><a href="#什么是Chaincode" class="headerlink" title="什么是Chaincode"></a>什么是Chaincode</h2><blockquote>
<p>chaincode是一个程序，它是使用Go语言编写的，最终在Java等其它编程语言中实现了指定的接口；<br>chaincode运行一个被 背书peer进程独立出来的安全的Docker容器中;<br>chaincode通过应用程序提交的事务初始化和管理帐本状态;   </p>
</blockquote>
<blockquote>
<p>chaincode通常处理被网络成员认可的业务逻辑;<br>因此它被认为是一种”智能合约”;<br>由chaincode创建的状态只作用于该chaincode，而不能通过另一个chaincode直接访问;<br>但是，在同一个网络中，给定适当的权限;<br>chaincode可以调用另一个chaincode来访问它的状态;   </p>
</blockquote>
<blockquote>
<p>通过区块链通信产品应用方案供应商诺亚的视角来探索chaincode;<br>主要关注诺亚对chaincode生命周期的操作;<br>在区块链网络中，打包，安装，实例化和升级chaincode的过程;<br>是chaincode的操作生命周期的一个功能;  </p>
</blockquote>
<h2 id="Packaging-包"><a href="#Packaging-包" class="headerlink" title="Packaging(包)"></a>Packaging(包)</h2><p>chaincode包由3部分组成: </p>
<ul>
<li><p>chaincode由chaincode部署规范(ChaincodeDeploymentSpec)或CDS定义码和其他属性(如名称如版本) 定义了chaincode包; </p>
</li>
<li><p>一个可选的实例化策略，他可以在策略上用相同的策略来描述;用于一支持和在背书策略中描述。  </p>
</li>
<li><p>由”拥有”chaincode的实体的一组签名;   </p>
</li>
</ul>
<p>这些签名有以下目的: </p>
<ul>
<li>为了建立chaincode的所有权; </li>
<li>允许对包的内容进行验证; </li>
<li>允许检测包是否篡改;  </li>
</ul>
<p>一个channel上的chaincode实例化事务的创建者是通过chaincode的实例化策略来验证的;  </p>
<h2 id="创建package-包"><a href="#创建package-包" class="headerlink" title="创建package(包)"></a>创建package(包)</h2><blockquote>
<p>打包chaincode有两种方法。一种是当想要一个chaincode拥有多个所有者时，需要使用多个身份标识为该chaincode签名;<br>这个工作流程需要我们首先创建一个已签名的chaincode(一个签署的CDS);<br>然后通过序列的方式将其传递给其他所有者来签署 ;   </p>
</blockquote>
<blockquote>
<p>更简单的工作流程是正在发行安装事务的节点的身份签名时部署已部署的CDS;<br>首先将处理更复杂的情况，但是，如果不需要担心多个所有者;  那么可以跳过下在的安装chaincode部分;  </p>
</blockquote>
<blockquote>
<p>要创建一个已签名的chaincode包，使用如下命令: </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@6edc4e6c7b9c:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer# peer chaincode package -n mycc -p github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;chaincode_example02 -v 0 -s -S -i &quot;AND(&#39;OrgA.admin&#39;)&quot; ccpack.out</span><br><span class="line">2018-03-20 06:28:29.298 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing local MSP</span><br><span class="line">2018-03-20 06:28:29.299 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2018-03-20 06:28:29.299 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default escc</span><br><span class="line">2018-03-20 06:28:29.299 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 004 Using default vscc</span><br><span class="line">2018-03-20 06:28:29.526 UTC [golang-platform] getCodeFromFS -&gt; DEBU 005 getCodeFromFS github.com&#x2F;hyperledger&#x2F;fabric&#x2F;examples&#x2F;chaincode&#x2F;go&#x2F;chaincode_example02</span><br><span class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 006 Discarding GOROOT package fmt</span><br><span class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 007 Discarding provided package github.com&#x2F;hyperledger&#x2F;fabric&#x2F;core&#x2F;chaincode&#x2F;shim</span><br><span class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 008 Discarding provided package github.com&#x2F;hyperledger&#x2F;fabric&#x2F;protos&#x2F;peer</span><br><span class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 009 Discarding GOROOT package strconv</span><br><span class="line">2018-03-20 06:28:29.965 UTC [golang-platform] GetDeploymentPayload -&gt; DEBU 00a done</span><br><span class="line">2018-03-20 06:28:29.968 UTC [msp&#x2F;identity] Sign -&gt; DEBU 00b Sign: plaintext: 0A58080112520A476769746875622E63...0A2D2D2D2D2D454E44202D2D2D2D2D0A </span><br><span class="line">2018-03-20 06:28:29.968 UTC [msp&#x2F;identity] Sign -&gt; DEBU 00c Sign: digest: 8A854844B0721EB24D348CC38C19A3D5E182CBE46FDFFE8CB9ECA7C44406F720 </span><br><span class="line">2018-03-20 06:28:29.969 UTC [chaincodeCmd] chaincodePackage -&gt; DEBU 00d Packaged chaincode into deployment spec of size &lt;3409&gt;, with args &#x3D; [ccpack.out]</span><br></pre></td></tr></table></figure>
<p>-s 参数是指可以创建一个由多个所有签署的包，而不是简单地创建一个未处理/修饰过的CDS；<br>当指定了-s时，如果其他所有者需要签名，也必需要指定-s参数; 否则，这个进程会创建一个除了CDS<br>实例化策略之外的已签署CDS;  </p>
<p>-S 参数使用在core.yaml中由localMspid属性值标识的MSP来指示该程序的签名;   </p>
<p>-S 参数是可选的。但是，如果一个包是在没有签名的情况下创建的，那么它就不能由任何其他<br>所有者使用signpackage来签署; </p>
<p>-i 参数是可选的，即指定 chaincode实例化策略。实例化策略与背书策略具有相同的格式；<br>并指定哪些id可以实例化chaincode。在上面的示例中，只允许使用OrgA的admin实例化链代码;<br>如果没有提供策略，则使用默认策略，这将只允许peer中MSP的admin身份来实例化chaincode；  </p>
<h2 id="包签名-Package-signing"><a href="#包签名-Package-signing" class="headerlink" title="包签名(Package signing)"></a>包签名(Package signing)</h2><p>一个已经被签名的chaincode包在被创建时候可以交由其它所有者检查并签名;<br>这个工作流程支持chaincode包带外签署;  </p>
<p>SignedCDS包含了3个元素;  </p>
<ol>
<li>CDS包含了chaincode的源码,即表示背书策略;  </li>
<li>chaincode的实例化策略，即表示背书策略; </li>
<li>chaincode的所有者列表,以背书的方式定义;  </li>
</ol>
<p><code>注: 当chaincode在某些channel上实例化时，此背书策略是由带外决定的，以提供适当的MSP原则。</code><br><code>如果没有指定实例化策略，则默认策略是channel的任何MSP的admin</code></p>
<p>每个所有都通过将其与所有者的身份(例如证书) 相结合，并签署结合后的结果来为ChaincodeDeploymentSpec背书;<br>一个caincode所有者可以使用下面的命令来签署一个以前创建的签名包: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@6edc4e6c7b9c:&#x2F;opt&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;hyperledger&#x2F;fabric&#x2F;peer# peer chaincode signpackage ccpack.out signedccpack.out</span><br><span class="line">2018-03-20 06:48:52.479 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing local MSP</span><br><span class="line">2018-03-20 06:48:52.479 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2018-03-20 06:48:52.479 UTC [msp&#x2F;identity] Sign -&gt; DEBU 003 Sign: plaintext: 0A58080112520A476769746875622E63...0A2D2D2D2D2D454E44202D2D2D2D2D0A </span><br><span class="line">2018-03-20 06:48:52.479 UTC [msp&#x2F;identity] Sign -&gt; DEBU 004 Sign: digest: 8A854844B0721EB24D348CC38C19A3D5E182CBE46FDFFE8CB9ECA7C44406F720 </span><br><span class="line">Wrote signed package to signedccpack.out successfully</span><br><span class="line">2018-03-20 06:48:52.480 UTC [main] main -&gt; INFO 005 Exiting.....</span><br></pre></td></tr></table></figure>
<p>ccpack.out 和signedccpack.out分别是输入和输出包。signedccpack.out包含了使用的包附加签名;  </p>
<h2 id="安装chaincode"><a href="#安装chaincode" class="headerlink" title="安装chaincode"></a>安装chaincode</h2><p>安装事务将chaincode的源代码打包成一种指定的格式，称为ChaincodeDeploymentSpec(chaincode部署规范或CDS);<br>并将其安装到运行该chaincode的peer节点上;   </p>
<p><code>必须在channel中的每个背书节点上安装chaincode。以运行chaincode;</code></p>
<p>当安装API被简单地给出一个ChaincodeDeploymentSpec时，它会将默认实例化策略;并包含一个空的所有者列表;  </p>
<p><code>chaincode只应该安装在chaincode拥有的成员的背书pper节点上; 以保护网络中其他成员的chaincode逻辑的机密性</code>  </p>
<p><code>那些没有chaincode的成员，不能成为chaincode交易的背书人; 也就是说，它们不能执行chaincode</code></p>
<p><code>但是，它们仍然可以难并将事务提交到账本上;</code></p>
<p>要安装一个chainocde，请将一个签署的提案发送到system chaincode(系统智能合约) 其中被描述为生命周期系统智能合约(lifecycle system chaincode –LSCC) 的部分;<br>例如，要安装使用CLI的简单资产chaincode中描述的sacc示例chaincode，使用如下命令: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># peer chaincode install -n asset_mgmt -v 1.0 -p sacc</span><br></pre></td></tr></table></figure>
<p>CLI容器执行创建的SignedChaincodeDeploymentSpec sacc ，并将其发送给本地peer；<br>本地peer会调用LSCC上的安装方法。对-p选项的参数指定 了chaincode的路径；<br>它必需们位于用户的GOPATH的源码树中，例如 $GOPATH/src/sacc;<br><code>为了在peer上安装，签署的提案的签名必需来自peer的地本MSP管理员的一个签名</code></p>
<h2 id="chaincode实例化"><a href="#chaincode实例化" class="headerlink" title="chaincode实例化"></a>chaincode实例化</h2><p>实例化事务调用生命击期系统chaincode(LSCC)来创建和初始化一个channel的chaincode;<br>这是一个chaincode-chanel绑定过程: chaincode可以绑定到任意数量的channel，并分别在每个channel上独立操作;<br>不管chaincode安装和实例化了多少个其他channel，状态都被隔离到一个事务提交到channel上; </p>
<p>实例化事务的创建者必需满足在SingedCDS中包含的chincode的实例化策略;<br>并且该创建者作为创建该channel配置信息的一部分，也必需是channel上的一个写入者;<br>这对于channel的安全性来说是非常重要的，它可以防止恶意实体部署chaincode或欺骗成员在一个未绑定的channel上执行chaincode; </p>
<p>例如，默认的实例化策略是任何channel的MSP管理员，因此一个chaincode实例化事务的创建者必须是channel管理员的成员;<br>当事务提案到达背书(节点)的时候，它将验证创建者的签名与实例化策略; 并且在将其提交给账本之前;<br>在事务验证期间再次执行此操作;   </p>
<p>实例化事务还为channel 上的chaincode设置了背书策略。背书策略描述了交易结果的认证需求;<br>被该channel的所有成员所接受;  </p>
<p>例如,使用CLI实例化sacc chaincode，并使用john和0初始化状态，命令如下: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode instantiate -n sacc -v 1.0 -c &#39;&#123;&quot;Args&quot;:[&quot;john&quot;,&quot;0&quot;]&#125;&#39; -P &quot;OR (&#39;Org1.member&#39;,&#39;Org2.member&#39;)&quot;</span><br></pre></td></tr></table></figure>
<p><code>签注策略(CLI使用波兰表示法)，它需要来自Org1或Org2的任意成员的支持</code><br><code>以支持所有的事务到sacc。也就是说，无论是Org1还是Org2都必须签署在sacc上执行调用的结果，以使用事务是有效的</code>  </p>
<p>波兰表示法(Polish notation,或波兰记法)，是一种逻辑、算术和代数表示方法;<br>其特点是操作符置于操作数的前面,因此也称做前缀表示法;<br>如果操作符的元数(arity)是固定的，则语法上不需要括号仍然能被无歧义的解析;<br>波兰记法是波兰数学家扬. 武卡谢维奇1920年代引入的。用于简化命题逻辑;  </p>
<p>在chaincode成功实例化之后,chaincode在channel上进入活跃状态;<br>并准备处理任何背书事务类武技的事务协议。。这些事务是并发处理的，因为它们到达了背书peer;  </p>
<h2 id="chaincode升级"><a href="#chaincode升级" class="headerlink" title="chaincode升级"></a>chaincode升级</h2><p>任何时候，chaincode都可以通过更改其版本来进行升级，这是SignedCDS的一部分;<br>其他部分，例如所有者和实例化策略是可选的。但是，chaincode的名称必需是相同的;<br>否则，它将被视为完全不同的chaincode;  </p>
<p>在升级之前，必须将chaincode的新版本安装在需要背书peer上，升级是一个类似于实例化事务的事务;<br>它将chaincode的新版本绑定到channel。其他channel所绑定的旧版本chaincode将会继续运行旧版的chaincode；  </p>
<p>换句话说，升级事务只会一次影响 一个channel，即提交事务的channel;  </p>
<p>注意:由于chaincode的多个版本可能同时处于活跃状态，所以升级过程不会自动删除旧版本；<br>因此用户必需暂时管理这个版本;  </p>
<p>与实例化事务一个微妙的区别; 升级事务是根据当前的chaincode 实例化策略检查的，而不是新策略;<br>这是为了确保当前的实例化策略中指定的现有成员可以升级chaincode;  </p>
<p><code>在升级过程中，调用chaincode Init函数来执行任何与数据 相关的更新或重新初始化它;</code><br><code>因此在升级chaincode时必需注意避免重新设置状态;</code></p>
<h2 id="停止和启动chaincode"><a href="#停止和启动chaincode" class="headerlink" title="停止和启动chaincode"></a>停止和启动chaincode</h2><p><code>停止和启动生命周期事务还没有实现。但是，可以通过每个背书人删除chaincode容器和SignedCDS包来手动停止chaincode</code><br><code>这是通过peer节点运行的每个主机或虚拟机上删除chaincode的容器来完成的,然后从每个背书peer节点 上删除SignedCDS</code> </p>
<p><code>TODO-为了peer节点删除CDS，首先需要进入peer节点的容器，我们确实需要提供一个能够执行功能的实用程序脚本</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#docker rm -f &lt;container id&gt;</span><br><span class="line">rm &#x2F;var&#x2F;hyperledger&#x2F;production&#x2F;chaincodes&#x2F;&lt;ccname&gt;:&lt;ccversion&gt;</span><br></pre></td></tr></table></figure>
<p> Stop在工作iytkk是有用的,可以控制方式上进行升级，在进行升级之前，可以在所有peer上停止一个chaincode ;</p>
<h2 id="CLI-客户端"><a href="#CLI-客户端" class="headerlink" title="CLI(客户端)"></a>CLI(客户端)</h2><p> 官方正在评估为Hyperledger Fabric peer二进制文件分发特定平台的二进制文件的需求;<br> 目前，可以简单地运行dodcker 容器中调用命令; </p>
<p> 查看当前的可用的CLI命令，运行的fabric-peer Docker容器中执行以下命令: </p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># docker run -it hyperledger&#x2F;fabric-peer bash</span><br><span class="line"># peer chaincode --help </span><br></pre></td></tr></table></figure>
<p> 注: 可使用docker exec -it cli (容器名) bash命令进入cli  </p>
<p> 与下面类似的输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Usage:</span><br><span class="line">  peer chaincode [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  install     Package the specified chaincode into a deployment spec and save it on the peer&#39;s path.</span><br><span class="line">  instantiate Deploy the specified chaincode to the network.</span><br><span class="line">  invoke      Invoke the specified chaincode.</span><br><span class="line">  package     Package the specified chaincode into a deployment spec.</span><br><span class="line">  query       Query using the specified chaincode.</span><br><span class="line">  signpackage Sign the specified chaincode package</span><br><span class="line">  upgrade     Upgrade chaincode.</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --cafile string     Path to file containing PEM-encoded trusted certificate(s) for the ordering endpoint</span><br><span class="line">  -C, --chainID string    The chain on which this command should be executed (default &quot;testchainid&quot;)</span><br><span class="line">  -c, --ctor string       Constructor message for the chaincode in JSON format (default &quot;&#123;&#125;&quot;)</span><br><span class="line">  -E, --escc string       The name of the endorsement system chaincode to be used for this chaincode</span><br><span class="line">  -l, --lang string       Language the chaincode is written in (default &quot;golang&quot;)</span><br><span class="line">  -n, --name string       Name of the chaincode</span><br><span class="line">  -o, --orderer string    Ordering service endpoint</span><br><span class="line">  -p, --path string       Path to chaincode</span><br><span class="line">  -P, --policy string     The endorsement policy associated to this chaincode</span><br><span class="line">  -t, --tid string        Name of a custom ID generation algorithm (hashing and decoding) e.g. sha256base64</span><br><span class="line">      --tls               Use TLS when communicating with the orderer endpoint</span><br><span class="line">  -u, --username string   Username for chaincode operations when security is enabled</span><br><span class="line">  -v, --version string    Version of the chaincode specified in install&#x2F;instantiate&#x2F;upgrade commands</span><br><span class="line">  -V, --vscc string       The name of the verification system chaincode to be used for this chaincode</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">      --logging-level string       Default logging level and overrides, see core.yaml for full syntax</span><br><span class="line">      --test.coverprofile string   Done (default &quot;coverage.cov&quot;)</span><br><span class="line"></span><br><span class="line">Use &quot;peer chaincode [command] --help&quot; for more information about a command.</span><br><span class="line">2018-03-20 07:55:59.840 UTC [main] main -&gt; INFO 003 Exiting.....</span><br></pre></td></tr></table></figure>
<p>全局flags: –logging-level string<br>默认的日志记录level和overrides   </p>
<ul>
<li>test.coverprofile string Done(default “coverage.cov”)<br>-v ,–version<br>使用”peer chaincode [command] -help” 获取更多关于命令的信息;<br>为了方便在脚本化的应用程序中使用，peer命令总是在发生命令失败时生成非零返回代码;  </li>
</ul>
<p>chaincode命令的例子: </p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">peer chaincode install -n mycc -v 0 -p path&#x2F;to&#x2F;my&#x2F;chaincode&#x2F;v0</span><br><span class="line">peer chaincode instantiate -n mycc -v 0 -c &#39;&#123;&quot;Args&quot;:[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#125;&#39; -C mychannel</span><br><span class="line">peer chaincode install -n mycc -v 1 -p path&#x2F;to&#x2F;my&#x2F;chaincode&#x2F;v1</span><br><span class="line">peer chaincode upgrade -n mycc -v 1 -c &#39;&#123;&quot;Args&quot;:[&quot;d&quot;, &quot;e&quot;, &quot;f&quot;]&#125;&#39; -C mychannel</span><br><span class="line">peer chaincode query -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;e&quot;]&#125;&#39;</span><br><span class="line">peer chaincode invoke -o orderer.example.com:7050  --tls --cafile $ORDERER_CA -C mychannel -n mycc -c &#39;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<h2 id="系统智能合约-System-chaincode"><a href="#系统智能合约-System-chaincode" class="headerlink" title="系统智能合约(System chaincode)"></a>系统智能合约(System chaincode)</h2><p>系统chaincode具有相同的编程模型，除了它在peer进程中运行，而不是普通的chaincode那样在一个单独的容器中运行; 因此，系统chaincode被构建到peer中可执行文件中，并且不遵循上面描述的相同的生命周期。特别是安装、实例化和升级 并不适用于系统chaincode；  </p>
<p>系统chaincode的目的是为了在peer和chaincode之间减少gRPC的通信成本，并权衡管理 的灵活性;<br>例如,系统chaincode只能用peer二进制进行升级。它还必须注册一个固定的参数集，并且没有背书策略或背书策略的功能;  </p>
<p>系统chaincode用于Hyperledger Fabric以实现许多系统行为，使它们可以被系统集成所取代或修改;  </p>
<p>系统chaincode列表:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. LSCC(Lifecycle system chaincode): 生命周期系统chaindoe处理上描述的生命周期请求;  </span><br><span class="line">2. CSCC(Configuration system chaincode):配置系统chaincode在peer端处理channel配置;  </span><br><span class="line">3. QSCC(Query system chaincode): 查询系统chaincode提供了分类查询api,例如获取块和事务;  </span><br><span class="line">4. ESCC(Query system chaincode): 背书系统chaincode通过签署事务提案响应来处理支持;  </span><br><span class="line">5. VSCC(Validation system chaincode): 验证系统chaincode处理事务验证,策略和多版本并发控制;  </span><br></pre></td></tr></table></figure>
<p>在修改或替换这些系统chaincode时必需注意,特别是LSCC、ESCC和VSCC，因为它们在主事务执行路径 中；<br>值得注意的是，当VSCC在将其提交到账本之前一个块，重要的是，channel中的所有peer节点都要计算相同的验证，以避免账本差异。因此，如果VSCC被修改或替换，就需要特别的处理和维护;  </p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>MariaDB之SELECT语法练习</title>
    <url>/2018/02/28/MariaDB%E4%B9%8BSELECT%E8%AF%AD%E6%B3%95%E7%BB%83%E4%B9%A0/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="一-、导入hellodb-sql生成数据库后实现以下操作"><a href="#一-、导入hellodb-sql生成数据库后实现以下操作" class="headerlink" title="一 、导入hellodb.sql生成数据库后实现以下操作"></a>一 、导入hellodb.sql生成数据库后实现以下操作</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql -uroot -h172.16.23.23 -pcento.123 &lt; hellodb.sql</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW DATABASES; #可以列出已存在的数据库 </span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| NODE1              |</span><br><span class="line">| RJYY               |</span><br><span class="line">| hellodb            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; USE hellodb;</span><br><span class="line">mysql&gt; SHOW TABLES; </span><br><span class="line">+<span class="comment">-------------------+</span></span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+<span class="comment">-------------------+</span></span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+<span class="comment">-------------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="1、-在students表中，查询年龄大于25岁，且为男性的同学的名字和年龄；"><a href="#1、-在students表中，查询年龄大于25岁，且为男性的同学的名字和年龄；" class="headerlink" title="1、 在students表中，查询年龄大于25岁，且为男性的同学的名字和年龄；"></a>1、 在students表中，查询年龄大于25岁，且为男性的同学的名字和年龄；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT Name,Age FROM students WHERE Age &gt;25 AND Gender=&#x27;M&#x27;; </span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br><span class="line">| Name         | Age |</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br><span class="line">| Xie Yanke    |  53 |</span><br><span class="line">| Ding Dian    |  32 |</span><br><span class="line">| Yu Yutong    |  26 |</span><br><span class="line">| Shi Qing     |  46 |</span><br><span class="line">| Tian Boguang |  33 |</span><br><span class="line">| Xu Xian      |  27 |</span><br><span class="line">| Sun Dasheng  | 100 |</span><br><span class="line">+<span class="comment">--------------+-----+ </span></span><br></pre></td></tr></table></figure>
<h3 id="2、-以ClassID为分组依据，显示每组的平均年龄；"><a href="#2、-以ClassID为分组依据，显示每组的平均年龄；" class="headerlink" title="2、 以ClassID为分组依据，显示每组的平均年龄；"></a>2、 以ClassID为分组依据，显示每组的平均年龄；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT avg(age),ClassID FROM students WHERE ClassID IS NOT NULL GROUP BY ClassID ;</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br><span class="line">| avg(age) | ClassID |</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br><span class="line">|  20.5000 |       1 |</span><br><span class="line">|  36.0000 |       2 |</span><br><span class="line">|  20.2500 |       3 |</span><br><span class="line">|  24.7500 |       4 |</span><br><span class="line">|  46.0000 |       5 |</span><br><span class="line">|  20.7500 |       6 |</span><br><span class="line">|  19.6667 |       7 |</span><br><span class="line">+<span class="comment">----------+---------+ </span></span><br></pre></td></tr></table></figure>
<h3 id="3、-显示第2题中平均年龄大于30的分组及平均年龄；"><a href="#3、-显示第2题中平均年龄大于30的分组及平均年龄；" class="headerlink" title="3、 显示第2题中平均年龄大于30的分组及平均年龄；"></a>3、 显示第2题中平均年龄大于30的分组及平均年龄；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT avg(Age),ClassID FROM students WHERE ClassID IS NOT NULL  GROUP BY ClassID HAVING avg(Age) &gt; 30;</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br><span class="line">| avg(Age) | ClassID |</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br><span class="line">|  36.0000 |       2 |</span><br><span class="line">|  46.0000 |       5 |</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br></pre></td></tr></table></figure>
<h3 id="4、-显示以L开头的名字的同学的信息；"><a href="#4、-显示以L开头的名字的同学的信息；" class="headerlink" title="4、 显示以L开头的名字的同学的信息；"></a>4、 显示以L开头的名字的同学的信息；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM students WHERE Name LIKE &#x27;L%&#x27;;</span><br><span class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></span><br><span class="line">| StuID | Name        | Age | Gender | ClassID  TeacherID  |</span><br><span class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></span><br><span class="line">|     8 | Lin Daiyu   |  17 | F      |       7 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang |  17 | F      |       3 |      NULL |</span><br><span class="line">|    17 | Lin Chong   |  25 | M      |       4 |      NULL |</span><br><span class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></span><br></pre></td></tr></table></figure>
<h3 id="5、-显示TeacherID非空的同学的相关信息；"><a href="#5、-显示TeacherID非空的同学的相关信息；" class="headerlink" title="5、 显示TeacherID非空的同学的相关信息；"></a>5、 显示TeacherID非空的同学的相关信息；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM students WHERE TeacherID IS NOT NULL;   </span><br><span class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></span><br><span class="line">|     1 | Shi Zhongyu |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian  |  22 | M      |       1 |         7 |</span><br><span class="line">|     3 | Xie Yanke   |  53 | M      |       2 |        16 |</span><br><span class="line">|     4 | Ding Dian   |  32 | M      |       4 |         4 |</span><br><span class="line">|     5 | Yu Yutong   |  26 | M      |       3 |         1 |</span><br><span class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6、-以年龄排序后，显示年龄最大的前10位同学的信息；"><a href="#6、-以年龄排序后，显示年龄最大的前10位同学的信息；" class="headerlink" title="6、 以年龄排序后，显示年龄最大的前10位同学的信息；"></a>6、 以年龄排序后，显示年龄最大的前10位同学的信息；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM students ORDER BY Age DESC LIMIT 10;</span><br><span class="line">+<span class="comment">-------+--------------+-----+--------+---------+-----------+</span></span><br><span class="line">| StuID | Name         | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+<span class="comment">-------+--------------+-----+--------+---------+-----------+</span></span><br><span class="line">|    25 | Sun Dasheng  | 100 | M      |    NULL |      NULL |</span><br><span class="line">|     3 | Xie Yanke    |  53 | M      |       2 |        16 |</span><br><span class="line">|     6 | Shi Qing     |  46 | M      |       5 |      NULL |</span><br><span class="line">|    13 | Tian Boguang |  33 | M      |       2 |      NULL |</span><br><span class="line">|     4 | Ding Dian    |  32 | M      |       4 |         4 |</span><br><span class="line">|    24 | Xu Xian      |  27 | M      |    NULL |      NULL |</span><br><span class="line">|     5 | Yu Yutong    |  26 | M      |       3 |         1 |</span><br><span class="line">|    17 | Lin Chong    |  25 | M      |       4 |      NULL |</span><br><span class="line">|    23 | Ma Chao      |  23 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong     |  23 | M      |       7 |      NULL |</span><br><span class="line">+<span class="comment">-------+--------------+-----+--------+---------+-----------+</span></span><br></pre></td></tr></table></figure>
<h3 id="7、-查询年龄大于等于20岁，小于等于25岁的同学的信息；用三种方法；"><a href="#7、-查询年龄大于等于20岁，小于等于25岁的同学的信息；用三种方法；" class="headerlink" title="7、 查询年龄大于等于20岁，小于等于25岁的同学的信息；用三种方法；"></a>7、 查询年龄大于等于20岁，小于等于25岁的同学的信息；用三种方法；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM students WHERE Age &gt;=20 AND Age &lt;=25;    </span><br><span class="line">mysql&gt; SELECT * FROM students WHERE Age  BETWEEN 20 AND 25; </span><br><span class="line">mysql&gt; SELECT * FROM students WHERE Age  IN (20,21,22,23,24,25);</span><br><span class="line">+<span class="comment">-------+---------------+-----+--------+---------+-----------+</span></span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+<span class="comment">-------+---------------+-----+--------+---------+-----------+</span></span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |</span><br><span class="line">+<span class="comment">-------+---------------+-----+--------+---------+-----------+</span></span><br></pre></td></tr></table></figure>
<h2 id="二、-导入hellodb-sql，以下操作在students表上执行"><a href="#二、-导入hellodb-sql，以下操作在students表上执行" class="headerlink" title="二、  导入hellodb.sql，以下操作在students表上执行"></a>二、  导入hellodb.sql，以下操作在students表上执行</h2><h3 id="1、以ClassID分组，显示每班的同学的人数；"><a href="#1、以ClassID分组，显示每班的同学的人数；" class="headerlink" title="1、以ClassID分组，显示每班的同学的人数；"></a>1、以ClassID分组，显示每班的同学的人数；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT count(StuID),ClassID FROM students GROUP BY ClassID ;  </span><br><span class="line">+<span class="comment">--------------+---------+</span></span><br><span class="line"> | count(StuID) | ClassID |</span><br><span class="line">+<span class="comment">--------------+---------+</span></span><br><span class="line">|            2 |    NULL |</span><br><span class="line">|            4 |       1 |</span><br><span class="line">|            3 |       2 |</span><br><span class="line">|            4 |       3 |</span><br><span class="line">|            4 |       4 |</span><br><span class="line">|            1 |       5 |</span><br><span class="line">|            4 |       6 |</span><br><span class="line">|            3 |       7 |</span><br><span class="line">+<span class="comment">--------------+---------+</span></span><br></pre></td></tr></table></figure>
<h3 id="2、以Gender分组，显示其年龄之和；"><a href="#2、以Gender分组，显示其年龄之和；" class="headerlink" title="2、以Gender分组，显示其年龄之和；"></a>2、以Gender分组，显示其年龄之和；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT sum(Age),Gender FROM students GROUP BY Gender ;</span><br><span class="line">+<span class="comment">----------+--------+</span></span><br><span class="line">| sum(Age) | Gender |</span><br><span class="line">+<span class="comment">----------+--------+</span></span><br><span class="line">|      190 | F      |</span><br><span class="line">|      495 | M      |</span><br><span class="line">+<span class="comment">----------+--------+</span></span><br></pre></td></tr></table></figure>
<h3 id="3、以ClassID分组，显示其平均年龄大于25的班级；"><a href="#3、以ClassID分组，显示其平均年龄大于25的班级；" class="headerlink" title="3、以ClassID分组，显示其平均年龄大于25的班级；"></a>3、以ClassID分组，显示其平均年龄大于25的班级；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT avg(Age),ClassID FROM students GROUP BY ClassID HAVING avg(Age) &gt; 25;</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br><span class="line">| avg(Age) | ClassID |</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br><span class="line">|  63.5000 |    NULL |</span><br><span class="line">|  36.0000 |       2 |</span><br><span class="line">|  46.0000 |       5 |</span><br><span class="line">+<span class="comment">----------+---------+</span></span><br></pre></td></tr></table></figure>
<h3 id="4、以Gender分组，显示各组中年龄大于25的学员的年龄之和；"><a href="#4、以Gender分组，显示各组中年龄大于25的学员的年龄之和；" class="headerlink" title="4、以Gender分组，显示各组中年龄大于25的学员的年龄之和；"></a>4、以Gender分组，显示各组中年龄大于25的学员的年龄之和；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT sum(Age),Gender FROM students WHERE Age &gt; 25 GROUP BY Gender ;</span><br><span class="line">+<span class="comment">----------+--------+</span></span><br><span class="line">| sum(Age) | Gender |</span><br><span class="line">+<span class="comment">----------+--------+</span></span><br><span class="line">|      317 | M      |</span><br><span class="line">+<span class="comment">----------+--------+</span></span><br></pre></td></tr></table></figure>
<h2 id="三、-导入hellodb-sql，完成以下题目："><a href="#三、-导入hellodb-sql，完成以下题目：" class="headerlink" title="三、 导入hellodb.sql，完成以下题目："></a>三、 导入hellodb.sql，完成以下题目：</h2><h3 id="1、显示前5位同学的姓名、课程及成绩；"><a href="#1、显示前5位同学的姓名、课程及成绩；" class="headerlink" title="1、显示前5位同学的姓名、课程及成绩；"></a>1、显示前5位同学的姓名、课程及成绩；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT s.Name,courses.Course,scores.Score FROM (select * from students limit 5) </span><br><span class="line">AS s  LEFT JOIN scores ON scores.StuID = s.StuID LEFT JOIN courses ON scores.CourseID =courses.CourseID;</span><br><span class="line">mysql&gt; SELECT s.name,sc.course,sc.score FROM (SELECT * FROM students LIMIT 5 ) </span><br><span class="line">AS s LEFT JOIN (<span class="keyword">SELECT</span> scores.stuid,courses.course,scores.score <span class="keyword">FROM</span> scores <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> courses <span class="keyword">ON</span> </span><br><span class="line">courses.CourseID=scores.CourseID)<span class="keyword">AS</span> sc <span class="keyword">ON</span> s.StuId=sc.StuID;</span><br><span class="line">+<span class="comment">-------------+----------------+-------+</span></span><br><span class="line">| name        | course         | score |</span><br><span class="line">+<span class="comment">-------------+----------------+-------+</span></span><br><span class="line">| Shi Zhongyu | Kuihua Baodian |    77 |</span><br><span class="line">| Shi Zhongyu | Weituo Zhang   |    93 |</span><br><span class="line">| Shi Potian  | Kuihua Baodian |    47 |</span><br><span class="line">| Shi Potian  | Daiyu Zanghua  |    97 |</span><br><span class="line">| Xie Yanke   | Kuihua Baodian |    88 |</span><br><span class="line">| Xie Yanke   | Weituo Zhang   |    75 |</span><br><span class="line">| Ding Dian   | Daiyu Zanghua  |    71 |</span><br><span class="line">| Ding Dian   | Kuihua Baodian |    89 |</span><br><span class="line">| Yu Yutong   | Hamo Gong      |    39 |</span><br><span class="line">| Yu Yutong   | Dagou Bangfa   |    63 |</span><br><span class="line">+<span class="comment">-------------+----------------+-------+</span></span><br></pre></td></tr></table></figure>
<h3 id="2、显示其成绩高于80的同学的名称及课程；"><a href="#2、显示其成绩高于80的同学的名称及课程；" class="headerlink" title="2、显示其成绩高于80的同学的名称及课程；"></a>2、显示其成绩高于80的同学的名称及课程；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT Name,Course,Score FROM (students LEFT JOIN scores ON students.StuID=scores.StuID ) </span><br><span class="line">LEFT JOIN courses ON courses.CourseID=scores.CourseID WHERE Score &gt; 80; </span><br><span class="line">+<span class="comment">-------------+----------------+-------+</span></span><br><span class="line">| Name        | Course         | Score |</span><br><span class="line">+<span class="comment">-------------+----------------+-------+</span></span><br><span class="line">| Shi Zhongyu | Weituo Zhang   |    93 |</span><br><span class="line">| Shi Potian  | Daiyu Zanghua  |    97 |</span><br><span class="line">| Xie Yanke   | Kuihua Baodian |    88 |</span><br><span class="line">| Ding Dian   | Kuihua Baodian |    89 |</span><br><span class="line">| Shi Qing    | Hamo Gong      |    96 |</span><br><span class="line">| Xi Ren      | Hamo Gong      |    86 |</span><br><span class="line">| Xi Ren      | Dagou Bangfa   |    83 |</span><br><span class="line">| Lin Daiyu   | Jinshe Jianfa  |    93 |</span><br><span class="line">+<span class="comment">-------------+----------------+-------+</span></span><br></pre></td></tr></table></figure>
<h3 id="3、求前8位同学每位同学自己两门课的平均成绩，并按降序排列；"><a href="#3、求前8位同学每位同学自己两门课的平均成绩，并按降序排列；" class="headerlink" title="3、求前8位同学每位同学自己两门课的平均成绩，并按降序排列；"></a>3、求前8位同学每位同学自己两门课的平均成绩，并按降序排列；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT Name,avg(Score) FROM (SELECT  * FROM students LIMIT 8) AS rj LEFT JOIN scores AS</span><br><span class="line">jr ON rj.StuID=jr.StuID GROUP BY Name ORDER BY avg(Score) DESC;</span><br><span class="line">+<span class="comment">-------------+------------+</span></span><br><span class="line">| Name        | avg(Score) |</span><br><span class="line">+<span class="comment">-------------+------------+</span></span><br><span class="line">| Shi Qing    |    96.0000 |</span><br><span class="line">| Shi Zhongyu |    85.0000 |</span><br><span class="line">| Xi Ren      |    84.5000 |</span><br><span class="line">| Xie Yanke   |    81.5000 |</span><br><span class="line">| Ding Dian   |    80.0000 |</span><br><span class="line">| Lin Daiyu   |    75.0000 |</span><br><span class="line">| Shi Potian  |    72.0000 |</span><br><span class="line">| Yu Yutong   |    51.0000 |</span><br><span class="line">+<span class="comment">-------------+------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="4、显示每门课程课程名称及学习了这门课的同学的个数；"><a href="#4、显示每门课程课程名称及学习了这门课的同学的个数；" class="headerlink" title="4、显示每门课程课程名称及学习了这门课的同学的个数；"></a>4、显示每门课程课程名称及学习了这门课的同学的个数；</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT courses.Course,count(rj.StuID) FROM scores AS rj LEFT JOIN courses ON courses.CourseID=rj.CourseID GROUP BY rj.CourseID;</span><br><span class="line">+<span class="comment">----------------+-----------------+</span></span><br><span class="line">| Course         | count(rj.StuID) |</span><br><span class="line">+<span class="comment">----------------+-----------------+</span></span><br><span class="line">| Hamo Gong      |               3 |</span><br><span class="line">| Kuihua Baodian |               4 |</span><br><span class="line">| Jinshe Jianfa  |               1 |</span><br><span class="line">| Taiji Quan     |               1 |</span><br><span class="line">| Daiyu Zanghua  |               2 |</span><br><span class="line">| Weituo Zhang   |               2 |</span><br><span class="line">| Dagou Bangfa   |               2 |</span><br><span class="line">+<span class="comment">----------------+-----------------+</span></span><br></pre></td></tr></table></figure>
<h2 id="四、思考题"><a href="#四、思考题" class="headerlink" title="四、思考题"></a>四、思考题</h2><h3 id="1、如何显示其年龄大于平均年龄的同学的名字？"><a href="#1、如何显示其年龄大于平均年龄的同学的名字？" class="headerlink" title="1、如何显示其年龄大于平均年龄的同学的名字？"></a>1、如何显示其年龄大于平均年龄的同学的名字？</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT Name,Age FROM students WHERE Age &gt; (SELECT avg(Age) FROM students);</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br><span class="line">| Name         | Age |</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br><span class="line">| Xie Yanke    |  53 |</span><br><span class="line">| Ding Dian    |  32 |</span><br><span class="line">| Shi Qing     |  46 |</span><br><span class="line">| Tian Boguang |  33 |</span><br><span class="line">| Sun Dasheng  | 100 |</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br></pre></td></tr></table></figure>
<h3 id="2、如何显示其学习的课程为第1、2，4或第7门课的同学的名字？"><a href="#2、如何显示其学习的课程为第1、2，4或第7门课的同学的名字？" class="headerlink" title="2、如何显示其学习的课程为第1、2，4或第7门课的同学的名字？"></a>2、如何显示其学习的课程为第1、2，4或第7门课的同学的名字？</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT rj.Name,scores.CourseID FROM students AS rj LEFT JOIN scores ON scores.StuID = rj.StuID WHERE scores.CourseID IN (1,2,4,7);</span><br><span class="line">+<span class="comment">-------------+----------+</span></span><br><span class="line">| Name        | CourseID |</span><br><span class="line">+<span class="comment">-------------+----------+</span></span><br><span class="line">| Shi Zhongyu |        2 |</span><br><span class="line">| Shi Potian  |        2 |</span><br><span class="line">| Xie Yanke   |        2 |</span><br><span class="line">| Ding Dian   |        2 |</span><br><span class="line">| Yu Yutong   |        1 |</span><br><span class="line">| Yu Yutong   |        7 |</span><br><span class="line">| Shi Qing    |        1 |</span><br><span class="line">| Xi Ren      |        1 |</span><br><span class="line">| Xi Ren      |        7 |</span><br><span class="line">| Lin Daiyu   |        4 |</span><br><span class="line">+<span class="comment">-------------+----------+</span></span><br></pre></td></tr></table></figure>
<h3 id="3、如何显示其成员数最少为3个的班级的同学中年龄大于同班同学平均年龄的同学？"><a href="#3、如何显示其成员数最少为3个的班级的同学中年龄大于同班同学平均年龄的同学？" class="headerlink" title="3、如何显示其成员数最少为3个的班级的同学中年龄大于同班同学平均年龄的同学？"></a>3、如何显示其成员数最少为3个的班级的同学中年龄大于同班同学平均年龄的同学？</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT students.name,students.age,tp.classid,tp.vg FROM students,(SELECT classid,COUNT(stuid) </span><br><span class="line">AS cs,AVG(age) AS vg FROM students GROUP BY classid HAVING cs &gt;=3) AS tp WHERE  students.age&gt;tp.vg AND students.classid=tp.classid;</span><br><span class="line">+<span class="comment">---------------+-----+---------+---------+</span></span><br><span class="line">| name          | age | classid | vg      |</span><br><span class="line">+<span class="comment">---------------+-----+---------+---------+</span></span><br><span class="line">| Shi Potian    |  22 |       1 | 20.5000 |</span><br><span class="line">| Xie Yanke     |  53 |       2 | 36.0000 |</span><br><span class="line">| Ding Dian     |  32 |       4 | 24.7500 |</span><br><span class="line">| Yu Yutong     |  26 |       3 | 20.2500 |</span><br><span class="line">| Yuan Chengzhi |  23 |       6 | 20.7500 |</span><br><span class="line">| Xu Zhu        |  21 |       1 | 20.5000 |</span><br><span class="line">| Lin Chong     |  25 |       4 | 24.7500 |</span><br><span class="line">| Hua Rong      |  23 |       7 | 19.6667 |</span><br><span class="line">| Huang Yueying |  22 |       6 | 20.7500 |</span><br><span class="line">+<span class="comment">---------------+-----+---------+---------+</span></span><br></pre></td></tr></table></figure>
<h3 id="4、统计各班级中年龄大于全校同学平均年龄的同学。"><a href="#4、统计各班级中年龄大于全校同学平均年龄的同学。" class="headerlink" title="4、统计各班级中年龄大于全校同学平均年龄的同学。"></a>4、统计各班级中年龄大于全校同学平均年龄的同学。</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT rj.Name,rj.Age FROM students AS rj LEFT JOIN classes AS jr ON  </span><br><span class="line">rj.ClassID=jr.ClassID WHERE rj.ClassID=jr.ClassID AND Age &gt; (SELECT AVG(Age) FROM students);</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br><span class="line">| Name         | Age |</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br><span class="line">| Xie Yanke    |  53 |</span><br><span class="line">| Ding Dian    |  32 |</span><br><span class="line">| Shi Qing     |  46 |</span><br><span class="line">| Tian Boguang |  33 |</span><br><span class="line">+<span class="comment">--------------+-----+</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>从头开始了解Hyperledger</title>
    <url>/2018/02/15/hyperledger%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="从头开始了解Hyperledger"><a href="#从头开始了解Hyperledger" class="headerlink" title="从头开始了解Hyperledger"></a>从头开始了解Hyperledger</h1><p><img src="images/fabric.png" class="lazyload" data-srcset="images/fabric.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Hyperledger词汇表"><a href="#Hyperledger词汇表" class="headerlink" title="Hyperledger词汇表"></a>Hyperledger词汇表</h2><ul>
<li>Anchor Peer -锚节点</li>
</ul>
<p>锚节点是通道中能被所有对等节点探测、并能与之进行通信的一种对等节点;<br>通道中的每个成员都有一个(或者多个，以防单点故障) 锚节点 ;<br>允许属于不同成员身份的节点来发现通道中存在的其它节点;   </p>
<ul>
<li>Block - 区块</li>
</ul>
<p>在一个通道上，(区块是)一组有序交易的集合;<br>区块往往通过密码学手段(Hash值)连接到前导区块;<br>区块是一组有序的交易集合，在通道中经过加密码(哈希加密，后与前序区块连接)；  </p>
<ul>
<li>Chain - 链 </li>
</ul>
<p>chain就是block之间以hash连接为结构的交易日志。peer从order service接收交易block;<br>并根据背书策和并发冲突标记block上交易是否有效;<br>然后将该block追回到pper文件系统中的hash chain </p>
<p>帐本的链是一个交易区块经过”哈希连接”结构化的交易日志;<br>对等节点从排序服务收到交交易区块;<br>基于背书策略和并发冲突来标注区块的交易为有效或者无效状态;<br>并且将区块追回到等结点文件系统的哈希链中;   </p>
<ul>
<li>Chaincode-链码   </li>
</ul>
<p>链码是一个运行在帐本上的软件，它可以对资产过行编码;<br>其中的交易指令(或者叫业务逻辑)也呆以用来修改资产;  </p>
<ul>
<li>Channel-通道 </li>
</ul>
<p>通道是构建在”Fabric”网络上的私有区块链，实现了数据的隔离和保密;<br>通道特定的帐本在通道中是与所有对等节点共享的;<br>并且交易方必须通过该通道的正确验证才能与账本进行交互;<br>通道是由一个”配置块”来定义的;  </p>
<ul>
<li>Commitment-提交 </li>
</ul>
<p>一个通道中的每个对等节点都会难交易的有序区块，然后将区块提交至该通道上帐本的各个副本;<br>对等节点也会票房每个区块中的每笔交易的状态 是有效或者无效;  </p>
<ul>
<li>Concurrency Control Version Check- 并发控制版本检查(CCVC)</li>
</ul>
<p>CCVC是保持通道中各对等节点状态同步的一种方法。对等节点并行的交易；<br>在交易提交到帐本之前，对等节点会检查交易在执行期间读到的数据是否被修改;<br>如果读取的数据在执行和提交之间被改变，就会引发CCVC冲突;<br>该交易就会在帐本中被标记为无效，而且值不会更新到状态数据库;   </p>
<ul>
<li>Configuration Block - 配置区块</li>
</ul>
<p>包含为系统链(排序服务)或通道定义成员和策略的配置数据。对某个通道或整个网络的修改;<br>(比如，成员离开或加入)都将导致生成一个新的配置区块并追回到适当的链上;<br>这个配置区块会包含创始区块的内容加上增量;   </p>
<ul>
<li>Consensus - 共识 </li>
</ul>
<p>共识是贯穿整个交易流程的广义术语，其用于产生个对于排序的同意书和确认构成区块的交易集的正确性;   </p>
<ul>
<li>Current State -当前状态  </li>
</ul>
<p>ledger的current state表示其chain交易log中所有key的最新值。peer会将处理过的block中的每个交易;<br>对应的修改value提交到ledger和current state。由于current state 表示channel所知的所有最新的k-v;<br>所以current state也被称为World State. Chaincode执行交易proposal就是针对的current state;   </p>
<ul>
<li>Dynamic Membership -动态成员</li>
</ul>
<p>Fabric支持动态添加-移除member、peer 和ordering服务节点，而不会影响整个网络的操作性;<br>当业务关系调整或因各种原因需添加-移除实体时，Dynamic Membership 至关重要；  </p>
<ul>
<li>Endorsement-背书</li>
</ul>
<p>Endorsement是指一个peer执行一个交易并返回YES-NO给生成交易proposal的client app的过程;<br>chaincode具有相应的endorsement policies.其中指定了endorsing peer;   </p>
<ul>
<li>Endorsement plolicy - 背书策略 </li>
</ul>
<p>Endorsement policy定义了依赖于特定chaincode执行交易的channel上的peer和响应结果;<br>(endorsements) 的必要组合条件(即反回Yes或NO的条件)。 Endorsement policy可以指定对于某一chaincode;<br>可以对交易背书的最小背书节点或者最小背书节点百分比;<br>背书策略由背书节点基于应用程序和对抵御不良行为的期望水来来组织管理;<br>在install和instantiate Chaincode (deploy tx)时需要指定背书策略;   </p>
<ul>
<li>Fabric-ca  </li>
</ul>
<p>Fabric-ca是默认的证书管理组件，它向网络成员及其用户颁发基于PKI的证书;<br>CA为每个成员颁发一个根证书(RootCert),为每个授权用户颁发一个注册证书(eCert);<br>为每个注册证书颁发大量交易证书(tCerts);   </p>
<ul>
<li>Genesis Block - 初始区块</li>
</ul>
<p>Genesis Block是初始化区块链网络或channel的配置块，也是链上的每一个区块;   </p>
<ul>
<li>Gossip Protocol - Gossip 协议 </li>
</ul>
<p>Gossiop数据传输协议有三项功能 </p>
<p>1.管理peer发和channel成员;<br>2.channel上的所有peer间广播帐本数据;<br>3.channel上的所有peer间同步收本数据;  </p>
<ul>
<li>Initialize- 初始化 </li>
</ul>
<p>一个初始化chaincode程序的方法;  </p>
<ul>
<li>Install -安装 </li>
</ul>
<p>将chaincode放到peer的文件系统的过程;</p>
<ul>
<li>Instantiate - 实例化</li>
</ul>
<p>启动chaincode容器的过程; </p>
<ul>
<li>Invoke - 调用</li>
</ul>
<p>用于调用 chaincode内的函数; Chaincode invoke就是一个交易proposal;<br>然后执行模块化的流程(背书、共识、验证、提交);<br>invoke的结构就是一个函数和一个参数数组;   </p>
<ul>
<li>Leading Peer - 主导节点</li>
</ul>
<p>每一个Member在其订阅的channel上可以拥有多个peer；<br>其中一个peer会作为chanel的leading peer 代表该Member与ordering service 通信;<br>ordering service 将block传递给leading peerd， 该peer再将此block分发给同一memer下的其他peer; </p>
<ul>
<li>Ledger - 帐本</li>
</ul>
<p>Ledger是个channel的chain和由channel中每个peer维护 的world state；  </p>
<ul>
<li>Member- 成员 </li>
</ul>
<p>拥有网络唯一根证书的合法独立实体。像peer节点和app client这样的网络组件会链接到一个Member;   </p>
<ul>
<li>Membership Service Provider -MSP </li>
</ul>
<p>MSP是指为client和peer提供证书的系统抽象线件。Cient用证书来谁他们的交易;<br>peer用证书认证其交易背书。该接口与系统的交易处理组件密切相关;<br>旨在使已定义的成员身份服务组件以这种方式顺利挺好入而不会修改系统的交易处理组件的核心;  </p>
<ul>
<li>Membership Services - 成员服务  </li>
</ul>
<p>成员服务在许可的区块链网络上认证、授权和管理身份 ;<br>在peer和order运行的成员服务的代码者会认证和授权区块链操作;<br>它是基于PKI的MSP实现; </p>
<p>fabric-ca组件实现了成员服务，来管理身份。特别的，它处理ECert和TCert的颁发和撤销;  </p>
<p>ECert是长期的身份任证; TCert是短期的身份凭证，是匿名和不可链接的;  </p>
<ul>
<li>Ordering Service -排序服务或共识服务 </li>
</ul>
<p>将交易排序放入block的节点的集合。ordering service 独立于peer流程之外;<br>并以先到先得的方式为网络上所有的channel作交易排序;<br>ordering service 支持可插拔实现，目前默认实现了SOLO和Kafka;<br>ordering service是整个网络的公用binding， 包含每个Member相关的加密材料;  </p>
<ul>
<li>Peer -节点</li>
</ul>
<p>一个网络实体，维护ledger并运行Chaincode容器来对ledger很乖read-write操作;<br>peer由Member拥有和维护;  </p>
<ul>
<li>Policy-策略  </li>
</ul>
<p>有背书策略;校验策略;区块提交策略;Chaincode管理策略和网络-通道管理策略;  </p>
<ul>
<li>Proposal - 提案</li>
</ul>
<p>一种针对channel中某peer的背书请求。每个proposal要么是Chaincode instantiate 要么是Chaincode inovke;   </p>
<ul>
<li>Query- 查询 </li>
</ul>
<p>对于current state中某个key的value的查询请求;  </p>
<ul>
<li>Software Development Kit -SDK </li>
</ul>
<p>SDk为开发人员提供了一个结构化的库环境，用于编写和测试链码应用程序；<br>SDK完全可以通过标准接口实现配置和扩展，像签名的加密算法;<br>日志框架和state存储这样的组件都可以轻松地实现替换;<br>SDK API 使用gRPC进行交易处理，成员服务、节点遍历以及事件处理都是据此与fabric通信;<br>目前SDK支持Node.js Java 和python ;  </p>
<ul>
<li>State Database - stateDB</li>
</ul>
<p>为了从Chainncode中高效的读写,Current state数据礁在stateDB中， 包括levelDB和souchDB; </p>
<ul>
<li>System chain-系统链</li>
</ul>
<p>包含在系统级定义网络的配置区块。系统链存在于ordering service中;<br>具有包含以下信息的初始配置:MSP信息、策略和信息配置。对整个网络的任何变化;<br>(例如新的Or加入或者添加新的Ordering 节点)将导致新的配置区块被添加到系统链;   </p>
<p>Transaction- 交易</p>
<p>Caincode的invoke或instantiate操作; Invoke是从ledger中请求read-write set；<br>Instantiate是请求在peer上启动Chaincode容器;   </p>
<h2 id="了解Hyperledger-Farbic"><a href="#了解Hyperledger-Farbic" class="headerlink" title="了解Hyperledger Farbic"></a>了解Hyperledger Farbic</h2><p>Hyperledger Fabric是一个提供 分布式账本方案的平台。Hyperledger Fabric由模块化架构支撑;  并具备极佳的保密性、可伸缩性、灵活性和可扩展平台; Hyperledger Fabirc被设计成支持不同的模块组件直接拔插启动;  并能适应在经济生态系统中错综复杂的和种场景;   </p>
<p>Hyperledger Fabric提供了一个独特的可伸缩、可扩展的架构，这也是Hyperledger Fabric与其他区块的链解决方案的显著区别;如果正计划部署具备完整审查机制以及开源架构的企业级区块链; Hyperledger Fabric昌一个不错的起点;   </p>
<h2 id="区块链"><a href="#区块链" class="headerlink" title="区块链"></a>区块链</h2><h3 id="分布式账本"><a href="#分布式账本" class="headerlink" title="分布式账本"></a>分布式账本</h3><p>一个区链网络的核心是一个分布式账本，在这个账本中记录了网络发生的所有交易信息;   </p>
<p>区块链账本通常被定义为去中心化，这是因为在整个网络中，每个参与者都保存着一个区块链账本的副本，所有参与者通过协作 共同维护着账本; 去中心化与协作 这两个特点在现实世界的商业货物交易和商务服务中展出现的显著优点;  </p>
<p>除了去中心化与协作，区链链的另一个显著特点是信息在只能以”附加”的方式记录在区块链中;   同时使用加密码技术保障了交易一旦被添加进账本中，就无法被篡改。区块链的这种不可篡改性使得信息来源的确认变得异常容易，这是由于参与者可以肯定信息一旦被写入区块链中就几乎不可被 篡改。这也是为什么区块链常常也被称为证明的系统的原因;  </p>
<h3 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h3><p>为了持续的进行信息的更新，以及帐本进行管理(写入交易，进行查询等)，区块链网络引入了智能合约来实现对账本的访问和控制;  </p>
<p>智能合约不仅仅可用于在区块链网络中打包信息，它们也可以被用于自动的执行由参与者定义的特定交易操作;   </p>
<p>例如,买卖双方要以定义一个智能合约，以保证当卖方发货的端口运送到达时，买方支付的货款会自二甲双胍转帐给卖方;   </p>
<h3 id="共识"><a href="#共识" class="headerlink" title="共识"></a>共识</h3><p>保持网络中所有账本交易的同步流程，就是共识。共识保证 了账本只会在交易双方都确认后才进行更新。同时在账本更新时，交易双方能够在在账本中的相同位置 ，更新一个相同的交易信息;   </p>
<p>##区块链因何可行 </p>
<h3 id="当前的记录系统"><a href="#当前的记录系统" class="headerlink" title="当前的记录系统"></a>当前的记录系统</h3><p>自从商业数据记录网络系统诞生以来，直到今天的交易网络并不骨发生太大的变化;   在商业网络中的成员进行相互交易时，他们各自维护着自己独立的交易记录。同时，人们交易的物品–无论是16世纪佛兰德的挂毯，还是现代的有价证券–都任然需要在每次卖出交易过程中提供来源信息，以确保卖方拥有所出售端口的所有权;   </p>
<p>随着科技的进步，交易流程不断深化发展，经历了从使用用石碑、使用纸质账本、使用硬盘存储器直到使用云计算平台的不同阶段，但流程的底层架构并没有发生任何变化。并不存一个可以统一管理网络参与者身份的系统，确认商品来源十分费劲,常常会耗费数天的时间 明确证券的交易(包含数以万计美元的数量)。人们必需签订合约并手动执行，每一个系统中的数据库都包含着独立 的信息并最终代表一个单点的错误。  </p>
<p>在今天的信息和过程共享断裂的方法中，建立一个跨越商业网络的记录系统是不可能的，尽管可见性和信任的需求是明确的;   </p>
<p>区块链的不同点</p>
<p>为什么不用”现代”的交易系统来替代这种效率低下的网络？新的商业网络可以具有标准的方法建立身份信息，执行交易，并且存储数据。为什么不建立一个可住的交易链条记录？通过查询这个链条上的所有交易，来确定交易商品来源，并且这个链条上的信息一旦被写入，就无法被再次篡改;  </p>
<p>这就是区块链网络。在区块链网络中，每一个参与者都保有一份账本的副本。在区块链网络中，不仅仅是账本信息会被共享，更新账本的流程是共享的。不同于目前的系统–参与者使用私有的程序对私胡的账本进行更新，而区块链系统使用共享的程序对共享的账本进行更新;   </p>
<p>通过使用共享账协调整个商业网络，区块链网络能免减少时间、成本以及隐私信息泄露的风险，并且能使用流程更加可信和透明;   </p>
<h3 id="Hyperledger-Fabric"><a href="#Hyperledger-Fabric" class="headerlink" title="Hyperledger Fabric"></a>Hyperledger Fabric</h3><p>2015年，Linux基金会启动了Hyperledger项目，hhsfi是发展跨行业的区块链技术。Hyperledger项目并不仅仅是定义一个单一的区块链标准，它更鼓励能过开源社区的力量协作开发区块链技术 ;   </p>
<p>Hyperledger Fabric是Hyperledger中的一个区块链项目。与其他区块链技术类似, Hyperledger Fabric包含一个账本，使用智能合约并且是一个通过所有参与者管理 交易的系统;  </p>
<p>Hyperledger Fabric 与其他区块链系统最大的不同体现在私有和许可。与开放无需许可的网络系统允许未知身份的参与者加入网络不同(需要能过工作量证明协议来保证交易有效并维护网络的安全)，Hyperledger Fabric通过Membership Service Provider(MSP)来登记所有的成员;   </p>
<p>Hyperledger Fabric也提供了多个可拔插选项。账本数据可被存储为多种格式，共识机制可被接入或者断开，同时支持多种不同的MSP。 </p>
<p>Hyperledger Fabric提供了建立 channel的功能，这允许参与者为交易新建一个单独的账本。当网络中的一些参与者是竞争对手时，这个功能变得尤为重要。因为这些参与者并不希望所有的交易信息–比如提供给部分客户的特定价格信息–都对网络中所有参与者公开。只有在同一个channel中的参与者，才会拥有该channel中的账本，而其他不在此channel中的参与者则看不到这个账本;   </p>
<h2 id="共享账本"><a href="#共享账本" class="headerlink" title="共享账本"></a>共享账本</h2><p>Hyperledger Fabric包含一个账本子系统，这个子系统包含两个组件:世界状态(world state) 和交易记录。在Hyperledger Fabric网络中的每一个参与者都拥有一个账本的副本;  </p>
<p>世界状态组件描述了账本在特定时间点的状态，它是账本的数据库。交易记录组件记录了产生世界状态当前值的所有交易，它是世界状态的更新历史。那么，账本则是世界状态数据库和交易历史记录的集合;   </p>
<p>账本的世界状态存储数据库是可更换的。默认配置下，这是一个key-value存储数据库。交易记录模 块不需要被不接入。只需要记录在区块链网络中曲棍球数据库被 使用时之前和之后的值就可以了;   </p>
<h2 id="智能合约-1"><a href="#智能合约-1" class="headerlink" title="智能合约"></a>智能合约</h2><p>Hyperledger Fabric智能合约被称为chaincode，当一个区块链外部的一个应用程序需要访问账本时,就会调用chaincode。大多数情况下，chaincode只会访问账本的数据库组件和世界状态(world sate)(比如查询)，但不会查询交易记录;  </p>
<p>chaincode可通过多种不同编程语言实现。目前支持chaincode的语言是Go(包含对java的支持) </p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Installing and Accessing Mysql Server</title>
    <url>/2018/02/09/Installing-and-Accessing-Mysql-Server/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="MariaDB-or-MySQL"><a href="#MariaDB-or-MySQL" class="headerlink" title="MariaDB or MySQL"></a>MariaDB or MySQL</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DBMS: 数据库管理系统，只是一个程序，而非数据</span><br><span class="line">RDBMS: 关系型数据库管理系统</span><br><span class="line">     C&#x2F;S: 专有协议</span><br><span class="line">     关系模型: 表(行，列) 组成的二维关系</span><br><span class="line">     范式:第一范式、第二范式、第三范式</span><br><span class="line">     关系运算:</span><br><span class="line">        选择</span><br><span class="line">        投影</span><br><span class="line">     数据库: 表，索引，视图(虚表)</span><br><span class="line">        SQL: Structure Query Language (结构化查询语言)</span><br><span class="line">            DDL(数据定义语言),DML(数据操纵语言，操作表中的数据)</span><br><span class="line">            编程接口:</span><br><span class="line">                存储过程</span><br><span class="line">                存储函数</span><br><span class="line">                触发器 </span><br><span class="line">                事件调试器 (Event scheduling)</span><br><span class="line">                过程式编辑: 选择、循环</span><br><span class="line">三层模型:</span><br><span class="line">    物理层(一张表，或者多张表，表现为一个文件)</span><br><span class="line">    逻辑层(表，索引，视图，等等)</span><br><span class="line">    视图层(最终用户所看到的样子，授权用户所看到的)</span><br><span class="line">    做为DBA需要:  设计&#x2F;创建表  设计&#x2F;创建索引 设计&#x2F;创建视图  </span><br><span class="line">        数据库的导入导出等</span><br><span class="line"></span><br><span class="line">解决方案:</span><br><span class="line">    付费: Oracle ,Sybase ,Infomix(IBM) ,DB2(IBM)</span><br><span class="line">    开源: MySQL ,MariaDB ,PostgreSQL , SQLite(是一种嵌入式的解决方案)</span><br><span class="line">        目前MySQL已经被Oracle收购</span><br><span class="line">    有三成把握的时候，就要争取。不然机会就错过了，但要做好充份准备。</span><br><span class="line">    没有谁好谁坏，只要向往自己的理想就好了。</span><br><span class="line"> </span><br><span class="line"> MySQL --&gt; 5.1 --&gt; 5.5 --&gt; 5.6 --&gt; 5.7</span><br><span class="line"> MariaDB </span><br><span class="line">    插件式存储引擎(支持众多类型的存储引擎)</span><br><span class="line">    MySQL是否支持事物，则需要查看存储引擎是否支持事物 </span><br><span class="line">    单进程多线程</span><br><span class="line">        连接线程</span><br><span class="line">        守护线程</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [mysql]&gt; SHOW ENGINES ;</span><br><span class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line">| Engine             | Support | <span class="keyword">Comment</span>                                                                    | Transactions | XA   | Savepoints |</span><br><span class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line">| CSV                | YES     | CSV <span class="keyword">storage</span> <span class="keyword">engine</span>                                                         | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection <span class="keyword">of</span> identical MyISAM <span class="keyword">tables</span>                                      | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| <span class="keyword">MEMORY</span>             | YES     | <span class="keyword">Hash</span> based, <span class="keyword">stored</span> <span class="keyword">in</span> <span class="keyword">memory</span>, useful <span class="keyword">for</span> <span class="keyword">temporary</span> <span class="keyword">tables</span>                  | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/<span class="literal">null</span> <span class="keyword">storage</span> <span class="keyword">engine</span> (anything you write <span class="keyword">to</span> it disappears)             | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| MyISAM             | YES     | MyISAM <span class="keyword">storage</span> <span class="keyword">engine</span>                                                      | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| <span class="keyword">InnoDB</span>             | <span class="keyword">DEFAULT</span> | Percona-XtraDB, Supports transactions, <span class="keyword">row</span>-<span class="keyword">level</span> locking, <span class="keyword">and</span> <span class="keyword">foreign</span> <span class="keyword">keys</span> | YES          | YES  | YES        |</span><br><span class="line">| <span class="keyword">ARCHIVE</span>            | YES     | <span class="keyword">Archive</span> <span class="keyword">storage</span> <span class="keyword">engine</span>                                                     | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| FEDERATED          | YES     | FederatedX <span class="keyword">pluggable</span> <span class="keyword">storage</span> <span class="keyword">engine</span>                                        | YES          | <span class="keyword">NO</span>   | YES        |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | <span class="keyword">Performance</span> <span class="keyword">Schema</span>                                                         | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| Aria               | YES     | Crash-<span class="keyword">safe</span> <span class="keyword">tables</span> <span class="keyword">with</span> MyISAM heritage                                     | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MySQL配置文件:集中式的配置，能够为mysql的各应用程序提供配置信息</span><br><span class="line">    [mysqld] 专用于mysqld应用程序</span><br><span class="line">    [mysqld_safe] 线程安全的mysqld专有配置</span><br><span class="line">    [mysqld_multi] 多实例共离的mysql</span><br><span class="line">    [server] 只要有是mysql服务端的都有效的</span><br><span class="line">    [mysql] mysql客户端的</span><br><span class="line">    [mysqldump] 数据导入导出的</span><br><span class="line">    [client] 对于客户端工具的</span><br><span class="line">        parameter &#x3D; value  支持_ - 两种</span><br><span class="line">        skip-name-reslove</span><br><span class="line">        skip_name_reslove 两种方式都是可以的</span><br><span class="line">mysql启动时查找路径</span><br><span class="line">    &#x2F;etc&#x2F;my.cnf  --&gt; &#x2F;etc&#x2F;mysql&#x2F;my.cnf  --&gt; $MYSQL_HOME&#x2F;my.cnf </span><br><span class="line">    --&gt; default-extra-file&#x3D;&#x2F;path&#x2F;to&#x2F;somdir&#x2F;my.cnf --&gt; ~&#x2F;.my.cnf</span><br><span class="line">    后找到的，行会覆盖先找到的，于是，越住后的是，越是先生效</span><br><span class="line">    </span><br><span class="line">安装方法</span><br><span class="line">    os vendor: rpm  ubuntu最成功的领域在桌面</span><br><span class="line">    服务器建议使用CentOS, SUSE,OpenSUSE,Debian等等 </span><br><span class="line">    Debian 要求技术能力偏高</span><br><span class="line">    </span><br><span class="line">    MySQL:</span><br><span class="line">        rpm </span><br><span class="line">        展开可用，一般安装就用的这种方式</span><br><span class="line">        源码，源码安装时需要对代码打布丁，对MySQL订制</span><br><span class="line">    安装后的设计:</span><br><span class="line">        （1）为所有root用户设定密码</span><br><span class="line">            mysql&gt; SET PASSWORD</span><br><span class="line">            mysql&gt; update mysql.user  SET password&#x3D; PASSWORD(&#39;your_pass&#39;) WHERE cluase;</span><br><span class="line">            mysql&gt; FLUSH PRIVILEGES ;</span><br><span class="line">            # mysqladmin 用这个命令来修改</span><br><span class="line">         (2) 删除所有匿名用户</span><br><span class="line">            mysql&gt; DROP USER &#39;&#39;@ &#39;localhost&#39;;</span><br><span class="line">            上术两步骤可运行命令: mysql_secure_installation</span><br><span class="line">         (3) 建议关闭主机名反解功能</span><br><span class="line">元数据数据库: mysql</span><br><span class="line">    user,host 等</span><br><span class="line">mysql 客户端工具 mysql</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>linux 常用命令与技巧</title>
    <url>/2018/02/08/linux-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E6%8A%80%E5%B7%A7/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="linux-常用命令与技巧"><a href="#linux-常用命令与技巧" class="headerlink" title="linux 常用命令与技巧"></a>linux 常用命令与技巧</h1><p><img src="/images/bash.png" class="lazyload" data-srcset="/images/bash.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="1-检查远程端口是否对bash开放："><a href="#1-检查远程端口是否对bash开放：" class="headerlink" title="1.检查远程端口是否对bash开放："></a>1.检查远程端口是否对bash开放：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> &gt;/dev/tcp/8.8.8.8/53 &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;open&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-让进程转入后台："><a href="#2-让进程转入后台：" class="headerlink" title="2.让进程转入后台："></a>2.让进程转入后台：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Ctrl + z</span><br></pre></td></tr></table></figure>
<h2 id="3-将进程转到前台："><a href="#3-将进程转到前台：" class="headerlink" title="3.将进程转到前台："></a>3.将进程转到前台：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">fg</span></span><br></pre></td></tr></table></figure>
<h2 id="4-产生随机的十六进制数，其中n是字符数："><a href="#4-产生随机的十六进制数，其中n是字符数：" class="headerlink" title="4.产生随机的十六进制数，其中n是字符数："></a>4.产生随机的十六进制数，其中n是字符数：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl rand -hex n</span><br></pre></td></tr></table></figure>
<h2 id="5-在当前shell里执行一个文件里的命令："><a href="#5-在当前shell里执行一个文件里的命令：" class="headerlink" title="5.在当前shell里执行一个文件里的命令："></a>5.在当前shell里执行一个文件里的命令：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /home/user/file.name</span><br></pre></td></tr></table></figure>
<h2 id="6-截取前5个字符："><a href="#6-截取前5个字符：" class="headerlink" title="6.截取前5个字符："></a>6.截取前5个字符：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$&#123;variable:0:5&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="7-SSH-debug-模式"><a href="#7-SSH-debug-模式" class="headerlink" title="7.SSH debug 模式:"></a>7.SSH debug 模式:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -vvv user@ip_address</span><br></pre></td></tr></table></figure>
<h2 id="8-SSH-with-pem-key"><a href="#8-SSH-with-pem-key" class="headerlink" title="8.SSH with pem key:"></a>8.SSH with pem key:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh user@ip_address -i key.pem</span><br></pre></td></tr></table></figure>
<h2 id="9-用wget抓取完整的网站目录结构，存放到本地目录中："><a href="#9-用wget抓取完整的网站目录结构，存放到本地目录中：" class="headerlink" title="9.用wget抓取完整的网站目录结构，存放到本地目录中："></a>9.用wget抓取完整的网站目录结构，存放到本地目录中：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -r --no-parent --reject <span class="string">&quot;index.html*&quot;</span> http://hostname/ -P /home/user/<span class="built_in">dirs</span></span><br></pre></td></tr></table></figure>
<h2 id="10-一次创建多个目录："><a href="#10-一次创建多个目录：" class="headerlink" title="10.一次创建多个目录："></a>10.一次创建多个目录：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /home/user/&#123;<span class="built_in">test</span>,test1,test2&#125;</span><br></pre></td></tr></table></figure>
<h2 id="11-列出包括子进程的进程树："><a href="#11-列出包括子进程的进程树：" class="headerlink" title="11.列出包括子进程的进程树："></a>11.列出包括子进程的进程树：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps axwef</span><br></pre></td></tr></table></figure>
<h2 id="12-创建-war-文件"><a href="#12-创建-war-文件" class="headerlink" title="12.创建 war 文件:"></a>12.创建 war 文件:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jar -cvf name.war file</span><br></pre></td></tr></table></figure>
<h2 id="13-测试硬盘写入速度："><a href="#13-测试硬盘写入速度：" class="headerlink" title="13.测试硬盘写入速度："></a>13.测试硬盘写入速度：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/tmp/output.img bs=8k count=256k; rm -rf /tmp/output.img</span><br></pre></td></tr></table></figure>
<h2 id="14-测试硬盘读取速度："><a href="#14-测试硬盘读取速度：" class="headerlink" title="14.测试硬盘读取速度："></a>14.测试硬盘读取速度：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hdparm -Tt /dev/sda</span><br></pre></td></tr></table></figure>
<h2 id="15-获取文本的md5-hash："><a href="#15-获取文本的md5-hash：" class="headerlink" title="15.获取文本的md5 hash："></a>15.获取文本的md5 hash：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;text&quot;</span> | md5sum</span><br></pre></td></tr></table></figure>
<h2 id="16-检查xml格式："><a href="#16-检查xml格式：" class="headerlink" title="16.检查xml格式："></a>16.检查xml格式：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xmllint --noout file.xml</span><br></pre></td></tr></table></figure>
<h2 id="17-将tar-gz提取到新目录里："><a href="#17-将tar-gz提取到新目录里：" class="headerlink" title="17.将tar.gz提取到新目录里："></a>17.将tar.gz提取到新目录里：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar zxvf package.tar.gz -C new_dir</span><br></pre></td></tr></table></figure>
<h2 id="18-使用curl获取HTTP头信息："><a href="#18-使用curl获取HTTP头信息：" class="headerlink" title="18.使用curl获取HTTP头信息："></a>18.使用curl获取HTTP头信息：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -I http://www.example.com</span><br></pre></td></tr></table></figure>
<h2 id="19-修改文件或目录的时间戳-YYMMDDhhmm"><a href="#19-修改文件或目录的时间戳-YYMMDDhhmm" class="headerlink" title="19.修改文件或目录的时间戳(YYMMDDhhmm):"></a>19.修改文件或目录的时间戳(YYMMDDhhmm):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch -t 0812250000 file</span><br></pre></td></tr></table></figure>
<h2 id="20-用wget命令执行ftp下载："><a href="#20-用wget命令执行ftp下载：" class="headerlink" title="20.用wget命令执行ftp下载："></a>20.用wget命令执行ftp下载：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -m ftp://username:password@hostname</span><br></pre></td></tr></table></figure>
<h2 id="21-生成随机密码-例子里是16个字符长"><a href="#21-生成随机密码-例子里是16个字符长" class="headerlink" title="21.生成随机密码(例子里是16个字符长):"></a>21.生成随机密码(例子里是16个字符长):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LANG=c &lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c<span class="variable">$&#123;1:-16&#125;</span>;<span class="built_in">echo</span>;</span><br></pre></td></tr></table></figure>
<h2 id="22-快速备份一个文件："><a href="#22-快速备份一个文件：" class="headerlink" title="22.快速备份一个文件："></a>22.快速备份一个文件：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cp some_file_name&#123;,.bkp&#125;</span><br></pre></td></tr></table></figure>
<h2 id="23-访问Windows共享目录："><a href="#23-访问Windows共享目录：" class="headerlink" title="23.访问Windows共享目录："></a>23.访问Windows共享目录：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">smbclient -U <span class="string">&quot;DOMAIN\user&quot;</span> //dc.domain.com/share/<span class="built_in">test</span>/dir</span><br></pre></td></tr></table></figure>
<h2 id="24-执行历史记录里的命令-这里是第100行"><a href="#24-执行历史记录里的命令-这里是第100行" class="headerlink" title="24.执行历史记录里的命令(这里是第100行):"></a>24.执行历史记录里的命令(这里是第100行):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">!100</span><br></pre></td></tr></table></figure>
<h2 id="25-解压"><a href="#25-解压" class="headerlink" title="25.解压:"></a>25.解压:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">unzip package_name.zip -d dir_name</span><br><span class="line">tar xvf package_name.tar.gz -d dir_name</span><br><span class="line">tar cvf package_name.tar.gz /path/to/file/</span><br></pre></td></tr></table></figure>
<h2 id="26-输入多行文字-CTRL-d-退出"><a href="#26-输入多行文字-CTRL-d-退出" class="headerlink" title="26.输入多行文字(CTRL + d 退出):"></a>26.输入多行文字(CTRL + d 退出):</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt; &gt;&gt; test.txt</span><br></pre></td></tr></table></figure>
<h2 id="27-创建空文件或清空一个现有文件："><a href="#27-创建空文件或清空一个现有文件：" class="headerlink" title="27.创建空文件或清空一个现有文件："></a>27.创建空文件或清空一个现有文件：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">\&gt; test.txt</span><br></pre></td></tr></table></figure>
<h2 id="28-与Ubuntu-NTP-server同步时间："><a href="#28-与Ubuntu-NTP-server同步时间：" class="headerlink" title="28.与Ubuntu NTP server同步时间："></a>28.与Ubuntu NTP server同步时间：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ntpdate ntp.ubuntu.com</span><br></pre></td></tr></table></figure>
<h2 id="29-用netstat显示所有tcp4监听端口："><a href="#29-用netstat显示所有tcp4监听端口：" class="headerlink" title="29.用netstat显示所有tcp4监听端口："></a>29.用netstat显示所有tcp4监听端口：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">netstat -lnt4 | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span> | cut -f2 -d: | grep -o <span class="string">&#x27;[0-9]*&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="30-qcow2镜像文件转换："><a href="#30-qcow2镜像文件转换：" class="headerlink" title="30.qcow2镜像文件转换："></a>30.qcow2镜像文件转换：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">qemu-img convert -f qcow2 -O raw precise-server-cloudimg-amd64-disk1.img \precise-server-cloudimg-amd64-disk1.raw</span><br></pre></td></tr></table></figure>
<h2 id="31-重复运行文件，显示其输出（缺省是2秒一次）："><a href="#31-重复运行文件，显示其输出（缺省是2秒一次）：" class="headerlink" title="31.重复运行文件，显示其输出（缺省是2秒一次）："></a>31.重复运行文件，显示其输出（缺省是2秒一次）：</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">watch ps -ef</span><br><span class="line">watch -n1 &quot;df -h&quot;</span><br></pre></td></tr></table></figure>
<h2 id="32-所有用户列表："><a href="#32-所有用户列表：" class="headerlink" title="32.所有用户列表："></a>32.所有用户列表：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">getent passwd</span><br><span class="line">awk -F: <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> /etc/passwd </span><br><span class="line">cat /etc/passwd | cut -d <span class="string">&#x27;:&#x27;</span> -f 1</span><br></pre></td></tr></table></figure>
<h2 id="33-Mount-root-in-read-write-mode"><a href="#33-Mount-root-in-read-write-mode" class="headerlink" title="33.Mount root in read/write mode:"></a>33.Mount root in read/write mode:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mount -o remount,rw /</span><br></pre></td></tr></table></figure>
<h2 id="34-挂载一个目录（这是不能使用链接的情况）"><a href="#34-挂载一个目录（这是不能使用链接的情况）" class="headerlink" title="34.挂载一个目录（这是不能使用链接的情况）:"></a>34.挂载一个目录（这是不能使用链接的情况）:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mount --<span class="built_in">bind</span> /<span class="built_in">source</span> /destination</span><br></pre></td></tr></table></figure>
<h2 id="35-动态更新DNS-server"><a href="#35-动态更新DNS-server" class="headerlink" title="35.动态更新DNS server:"></a>35.动态更新DNS server:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nsupdate &lt; &lt;EOF</span><br><span class="line">update add <span class="variable">$HOST</span> 86400 A <span class="variable">$IP</span></span><br><span class="line">send</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="36-递归grep所有目录："><a href="#36-递归grep所有目录：" class="headerlink" title="36.递归grep所有目录："></a>36.递归grep所有目录：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep -r <span class="string">&quot;some_text&quot;</span> /path/to/dir</span><br></pre></td></tr></table></figure>
<h2 id="37-列出前10个最大的文件："><a href="#37-列出前10个最大的文件：" class="headerlink" title="37.列出前10个最大的文件："></a>37.列出前10个最大的文件：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsof / | awk <span class="string">&#x27;&#123; if($7 &gt; 1048576) print $7/1048576 &quot;MB &quot;$9 &#125;&#x27;</span> | sort -n -u | tail</span><br></pre></td></tr></table></figure>
<h2 id="38-显示剩余内存-MB"><a href="#38-显示剩余内存-MB" class="headerlink" title="38.显示剩余内存(MB):"></a>38.显示剩余内存(MB):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">free -m | grep cache | awk <span class="string">&#x27;/[0-9]/&#123; print $4&quot; MB&quot; &#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="39-打开Vim并跳到文件末："><a href="#39-打开Vim并跳到文件末：" class="headerlink" title="39.打开Vim并跳到文件末："></a>39.打开Vim并跳到文件末：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim + some_file_name</span><br></pre></td></tr></table></figure>
<h2 id="40-Git-克隆指定分支-master"><a href="#40-Git-克隆指定分支-master" class="headerlink" title="40.Git 克隆指定分支(master):"></a>40.Git 克隆指定分支(master):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:name/app.git -b master</span><br></pre></td></tr></table></figure>
<h2 id="41-Git-切换到其它分支-develop"><a href="#41-Git-切换到其它分支-develop" class="headerlink" title="41.Git 切换到其它分支(develop):"></a>41.Git 切换到其它分支(develop):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git checkout develop</span><br></pre></td></tr></table></figure>
<h2 id="42-Git-删除分支-myfeature"><a href="#42-Git-删除分支-myfeature" class="headerlink" title="42.Git 删除分支(myfeature):"></a>42.Git 删除分支(myfeature):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git branch -d myfeature</span><br></pre></td></tr></table></figure>
<h2 id="43-Git-删除远程分支"><a href="#43-Git-删除远程分支" class="headerlink" title="43.Git 删除远程分支"></a>43.Git 删除远程分支</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push origin :branchName</span><br></pre></td></tr></table></figure>
<h2 id="44-Git-将新分支推送到远程服务器："><a href="#44-Git-将新分支推送到远程服务器：" class="headerlink" title="44.Git 将新分支推送到远程服务器："></a>44.Git 将新分支推送到远程服务器：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push -u origin mynewfeature</span><br></pre></td></tr></table></figure>
<h2 id="45-打印历史记录中最后一次cat命令："><a href="#45-打印历史记录中最后一次cat命令：" class="headerlink" title="45.打印历史记录中最后一次cat命令："></a>45.打印历史记录中最后一次cat命令：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">!cat:p</span><br></pre></td></tr></table></figure>
<h2 id="46-运行历史记录里最后一次cat命令："><a href="#46-运行历史记录里最后一次cat命令：" class="headerlink" title="46.运行历史记录里最后一次cat命令："></a>46.运行历史记录里最后一次cat命令：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">!cat</span><br></pre></td></tr></table></figure>
<h2 id="47-找出-home-user下所有空子目录"><a href="#47-找出-home-user下所有空子目录" class="headerlink" title="47.找出/home/user下所有空子目录:"></a>47.找出/home/user下所有空子目录:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find /home/user -maxdepth 1 -<span class="built_in">type</span> d -empty</span><br></pre></td></tr></table></figure>
<h2 id="48-获取test-txt文件中第50-60行内容："><a href="#48-获取test-txt文件中第50-60行内容：" class="headerlink" title="48.获取test.txt文件中第50-60行内容："></a>48.获取test.txt文件中第50-60行内容：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt; test.txt sed -n <span class="string">&#x27;50,60p&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="49-运行最后一个命令-如果最后一个命令是mkdir-root-test-下面将会运行-sudo-mkdir-root-test-："><a href="#49-运行最后一个命令-如果最后一个命令是mkdir-root-test-下面将会运行-sudo-mkdir-root-test-：" class="headerlink" title="49.运行最后一个命令(如果最后一个命令是mkdir /root/test, 下面将会运行: sudo mkdir /root/test)："></a>49.运行最后一个命令(如果最后一个命令是mkdir /root/test, 下面将会运行: sudo mkdir /root/test)：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo !!</span><br></pre></td></tr></table></figure>
<h2 id="50-创建临时RAM文件系统-–-ramdisk-先创建-tmpram目录"><a href="#50-创建临时RAM文件系统-–-ramdisk-先创建-tmpram目录" class="headerlink" title="50.创建临时RAM文件系统 – ramdisk (先创建/tmpram目录):"></a>50.创建临时RAM文件系统 – ramdisk (先创建/tmpram目录):</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mount -t tmpfs tmpfs /tmpram -o size=512m</span><br></pre></td></tr></table></figure>
<h2 id="51-Grep-whole-words"><a href="#51-Grep-whole-words" class="headerlink" title="51.Grep whole words:"></a>51.Grep whole words:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep -w <span class="string">&quot;name&quot;</span> test.txt</span><br></pre></td></tr></table></figure>
<h2 id="52-在需要提升权限的情况下往一个文件里追加文本："><a href="#52-在需要提升权限的情况下往一个文件里追加文本：" class="headerlink" title="52.在需要提升权限的情况下往一个文件里追加文本："></a>52.在需要提升权限的情况下往一个文件里追加文本：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;some text&quot;</span> | sudo tee -a /path/file</span><br></pre></td></tr></table></figure>
<h2 id="53-列出所有kill-signal参数"><a href="#53-列出所有kill-signal参数" class="headerlink" title="53.列出所有kill signal参数:"></a>53.列出所有kill signal参数:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">kill</span> -l</span><br></pre></td></tr></table></figure>
<h2 id="54-在bash历史记录里禁止记录最后一次会话："><a href="#54-在bash历史记录里禁止记录最后一次会话：" class="headerlink" title="54.在bash历史记录里禁止记录最后一次会话："></a>54.在bash历史记录里禁止记录最后一次会话：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 $$</span><br></pre></td></tr></table></figure>
<h2 id="55-扫描网络寻找开放的端口："><a href="#55-扫描网络寻找开放的端口：" class="headerlink" title="55.扫描网络寻找开放的端口："></a>55.扫描网络寻找开放的端口：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nmap -p 8081 172.20.0.0/16</span><br></pre></td></tr></table></figure>
<h2 id="56-设置git-email"><a href="#56-设置git-email" class="headerlink" title="56.设置git email:"></a>56.设置git email:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git config --global user.email <span class="string">&quot;me@example.com&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="57-To-sync-with-master-if-you-have-unpublished-commits"><a href="#57-To-sync-with-master-if-you-have-unpublished-commits" class="headerlink" title="57.To sync with master if you have unpublished commits:"></a>57.To sync with master if you have unpublished commits:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git pull --rebase origin master</span><br></pre></td></tr></table></figure>
<h2 id="58-将所有文件名中含有”txt”的文件移入-home-user目录"><a href="#58-将所有文件名中含有”txt”的文件移入-home-user目录" class="headerlink" title="58.将所有文件名中含有”txt”的文件移入/home/user目录:"></a>58.将所有文件名中含有”txt”的文件移入/home/user目录:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find -iname <span class="string">&quot;*txt*&quot;</span> -<span class="built_in">exec</span> mv -v &#123;&#125; /home/user \;</span><br></pre></td></tr></table></figure>
<h2 id="59-将文件按行并列显示："><a href="#59-将文件按行并列显示：" class="headerlink" title="59.将文件按行并列显示："></a>59.将文件按行并列显示：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">paste test.txt test1.txt</span><br></pre></td></tr></table></figure>
<h2 id="60-shell里的进度条"><a href="#60-shell里的进度条" class="headerlink" title="60.shell里的进度条:"></a>60.shell里的进度条:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pv data.log</span><br></pre></td></tr></table></figure>
<h2 id="61-使用netcat将数据发送到Graphite-server"><a href="#61-使用netcat将数据发送到Graphite-server" class="headerlink" title="61.使用netcat将数据发送到Graphite server:"></a>61.使用netcat将数据发送到Graphite server:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hosts.sampleHost 10 `date +%s`&quot;</span> | nc </span><br><span class="line">192.168.200.2 3000</span><br></pre></td></tr></table></figure>
<h2 id="62-将tabs转换成空格："><a href="#62-将tabs转换成空格：" class="headerlink" title="62.将tabs转换成空格："></a>62.将tabs转换成空格：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">expand test.txt &gt; test1.txt</span><br></pre></td></tr></table></figure>
<h2 id="63-Skip-bash-history"><a href="#63-Skip-bash-history" class="headerlink" title="63.Skip bash history:"></a>63.Skip bash history:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt; space &gt;cmd</span><br></pre></td></tr></table></figure>
<h2 id="64-去之前的工作目录："><a href="#64-去之前的工作目录：" class="headerlink" title="64.去之前的工作目录："></a>64.去之前的工作目录：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> -</span><br></pre></td></tr></table></figure>
<h2 id="65-拆分大体积的tar-gz文件-每个100MB-，然后合并回去："><a href="#65-拆分大体积的tar-gz文件-每个100MB-，然后合并回去：" class="headerlink" title="65.拆分大体积的tar.gz文件(每个100MB)，然后合并回去："></a>65.拆分大体积的tar.gz文件(每个100MB)，然后合并回去：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">split –b 100m /path/to/large/archive /path/to/output/files</span><br><span class="line">cat files* &gt; archive</span><br></pre></td></tr></table></figure>
<h2 id="66-使用curl获取HTTP-status-code"><a href="#66-使用curl获取HTTP-status-code" class="headerlink" title="66.使用curl获取HTTP status code:"></a>66.使用curl获取HTTP status code:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -sL -w <span class="string">&quot;%&#123;http_code&#125;\\n&quot;</span> www.example.com -o /dev/null</span><br></pre></td></tr></table></figure>
<h2 id="67-设置root密码，强化MySQL安全安装"><a href="#67-设置root密码，强化MySQL安全安装" class="headerlink" title="67.设置root密码，强化MySQL安全安装:"></a>67.设置root密码，强化MySQL安全安装:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/bin/mysql_secure_installation</span><br></pre></td></tr></table></figure>
<h2 id="68-当Ctrl-c不好使时"><a href="#68-当Ctrl-c不好使时" class="headerlink" title="68.当Ctrl + c不好使时:"></a>68.当Ctrl + c不好使时:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Ctrl + \</span><br></pre></td></tr></table></figure>
<h2 id="69-获取文件owner"><a href="#69-获取文件owner" class="headerlink" title="69.获取文件owner:"></a>69.获取文件owner:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> -c %U file.txt</span><br></pre></td></tr></table></figure>
<h2 id="70-block设备列表："><a href="#70-block设备列表：" class="headerlink" title="70.block设备列表："></a>70.block设备列表：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsblk -f</span><br></pre></td></tr></table></figure>
<h2 id="71-找出文件名结尾有空格的文件："><a href="#71-找出文件名结尾有空格的文件：" class="headerlink" title="71.找出文件名结尾有空格的文件："></a>71.找出文件名结尾有空格的文件：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> egrep -l <span class="string">&quot; +$&quot;</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<h2 id="72-找出文件名有tab缩进符的文件"><a href="#72-找出文件名有tab缩进符的文件" class="headerlink" title="72.找出文件名有tab缩进符的文件"></a>72.找出文件名有tab缩进符的文件</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> egrep -l $<span class="string">&#x27;\t&#x27;</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<h2 id="73-用”-”打印出横线-全选复制放进笔记"><a href="#73-用”-”打印出横线-全选复制放进笔记" class="headerlink" title="73.用”=”打印出横线:全选复制放进笔记"></a>73.用”=”打印出横线:全选复制放进笔记</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;%100s\n&#x27;</span> | tr <span class="string">&#x27; &#x27;</span> =</span><br></pre></td></tr></table></figure>
<h2 id="74-当一个文件较大，rm-rf-也无法删除时"><a href="#74-当一个文件较大，rm-rf-也无法删除时" class="headerlink" title="74.当一个文件较大，rm -rf 也无法删除时"></a>74.当一个文件较大，rm -rf 也无法删除时</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; filename</span><br><span class="line">rm -rf filename</span><br></pre></td></tr></table></figure>
<h2 id="75-统计访问量前5的ip"><a href="#75-统计访问量前5的ip" class="headerlink" title="75.统计访问量前5的ip"></a>75.统计访问量前5的ip</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /var/<span class="built_in">log</span>/nginx/access.log| cut -d <span class="string">&quot; &quot;</span> -f 1  | sort -r | uniq  -c | sort -nr | head -n5</span><br><span class="line">awk &#123;<span class="string">&#x27;print $1&#x27;</span>&#125; /var/<span class="built_in">log</span>/nginx/access.log | sort -r | uniq -c  | sort -nr  | head -5</span><br></pre></td></tr></table></figure>
<h2 id="76-CPU占用最多的前10个进程："><a href="#76-CPU占用最多的前10个进程：" class="headerlink" title="76.CPU占用最多的前10个进程："></a>76.CPU占用最多的前10个进程：</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k3|head -10 </span><br></pre></td></tr></table></figure>
<h2 id="78-内存消耗最多的前10个进程"><a href="#78-内存消耗最多的前10个进程" class="headerlink" title="78.内存消耗最多的前10个进程"></a>78.内存消耗最多的前10个进程</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k4|head -10 </span><br></pre></td></tr></table></figure>
<h2 id="79-虚拟内存使用最多的前10个进程"><a href="#79-虚拟内存使用最多的前10个进程" class="headerlink" title="79.虚拟内存使用最多的前10个进程"></a>79.虚拟内存使用最多的前10个进程</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ps auxw|head -1;ps auxw|sort -rn -k5|head -10</span><br></pre></td></tr></table></figure>
<h2 id="80-将443端口转发到8080端口"><a href="#80-将443端口转发到8080端口" class="headerlink" title="80.将443端口转发到8080端口"></a>80.将443端口转发到8080端口</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 8080</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;root&#x2F;config</span><br><span class="line">touch &#x2F;root&#x2F;config&#x2F;postfix-accounts.cf</span><br><span class="line">docker run --rm \</span><br><span class="line"> -e MAIL_USER&#x3D;renjin@ssjinyao.com \</span><br><span class="line"> -e MAIL_PASS&#x3D;centos.123\</span><br><span class="line"> -ti tvial&#x2F;docker-mailserver:latest \</span><br><span class="line"> &#x2F;bin&#x2F;sh -c &#39;echo &quot;$MAIL_USER|$(doveadm pw -s SHA512-CRYPT -u $MAIL_USER -p $MAIL_PASS)&quot;&#39; &gt;&gt; &#x2F;root&#x2F;config&#x2F;postfix-accounts.cf</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx 负载均衡多个nmmp主机</title>
    <url>/2018/02/07/Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%A4%9A%E4%B8%AAnmmp%E4%B8%BB%E6%9C%BA/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="设计拓扑图"><a href="#设计拓扑图" class="headerlink" title="设计拓扑图"></a>设计拓扑图</h2><p><img src="/images/nginx_upstream_lnmp.png" class="lazyload" data-srcset="/images/nginx_upstream_lnmp.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="一、Memcache简介"><a href="#一、Memcache简介" class="headerlink" title="一、Memcache简介"></a>一、Memcache简介</h2><h3 id="cache-缓存系统"><a href="#cache-缓存系统" class="headerlink" title="cache(缓存系统)"></a>cache(缓存系统)</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">高性能分布式缓存服务器，缓存所有的“可流式化”数据</span><br><span class="line">livejournal旗下Danga Interacive公司 </span><br><span class="line">程序&#x3D;指令+数据</span><br><span class="line">指令：程序</span><br><span class="line">数据：IO操作</span><br><span class="line">文件系统：</span><br><span class="line">特征：协议简单</span><br><span class="line">基于libevent的事件处理</span><br><span class="line">内置内存存储方式</span><br><span class="line">memcached 不互通信的分布式</span><br><span class="line">由于一台memcached变动时会导致数据无法查询到，客户端使用一致性hash算法</span><br><span class="line">一台memcached变动时，数据会丢失。memcached之间不能互相通信，所以不支持冗余。</span><br><span class="line">注:memcacched服务重启时，缓存的数据会丢失；</span><br><span class="line">CentOS 7 memcached的安装流程；</span><br><span class="line">base repository;</span><br><span class="line">服务端程序:memcached</span><br></pre></td></tr></table></figure>
<h3 id="程序环境"><a href="#程序环境" class="headerlink" title="程序环境"></a>程序环境</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">配置文件； &#x2F;etc&#x2F;sysconfig&#x2F;memcached</span><br><span class="line">主程序:&#x2F;usr&#x2F;bin&#x2F;memcached</span><br><span class="line">工具&#x2F;usr&#x2F;bin&#x2F;memcached-tool</span><br><span class="line">unitfile &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;memcached.service</span><br><span class="line">libmemcached:libmemcached 是一个C&#x2F;C++对于memcached服务器的客户端库和工具</span><br><span class="line">libmemcached-devel:这个包中包涵libmemcached的头文件和库</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    Memcached命令详解 </span><br><span class="line">    memcached</span><br><span class="line">memcached [options]:</span><br><span class="line">-l &lt;ip_addr&gt;:监听的地址</span><br><span class="line">-d Run memcahched as a daemon</span><br><span class="line">-m &lt;num&gt; 缓存空间最大值</span><br><span class="line">-u &lt;username&gt;:进程属主</span><br><span class="line">-p &lt;num&gt;:监听的tcp端口，默认为11211</span><br><span class="line">-U &lt;num&gt;:监听的udp端口，0表示关闭</span><br><span class="line">-M 当缓存满时，禁止对缓存清理</span><br><span class="line">-c 最大并发连接数</span><br><span class="line">-t &lt;threads&gt;用于指定服务器启动的线程数；每个线程数响应多个请求</span><br><span class="line">Slab Allocator:内存分配器</span><br><span class="line">预先分配好固定大小（slab class）内存块，每种大小的块（chunk）有1 或多个；</span><br><span class="line">相信的slab class的大小差别由增长因子控制;-f&lt;factor&gt;,默认为1.25</span><br><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;memcached</span><br><span class="line">OPITONS&#x3D;&quot; -f 1.1 -U 0&quot; 可以更改</span><br></pre></td></tr></table></figure>
<h3 id="php连接memcached程序"><a href="#php连接memcached程序" class="headerlink" title="php连接memcached程序"></a>php连接memcached程序</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php-pecl-memcache</span><br><span class="line">php-pecl-memcached</span><br><span class="line">Cluster保持会话的方法</span><br><span class="line">session sticky</span><br><span class="line">session cluster</span><br><span class="line">session server</span><br></pre></td></tr></table></figure>
<h2 id="二、安装配置memcached-php-fpm-nginx"><a href="#二、安装配置memcached-php-fpm-nginx" class="headerlink" title="二、安装配置memcached,php-fpm,nginx"></a>二、安装配置memcached,php-fpm,nginx</h2><h3 id="node3-安装memcached"><a href="#node3-安装memcached" class="headerlink" title="node3 安装memcached"></a>node3 安装memcached</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ansible node3 -m yum -a &quot;name=memcached state=present&quot;</span></span><br><span class="line"><span class="comment"># ansible node3 -m command -a &quot;rpm -ql memcached&quot;</span></span><br><span class="line"><span class="comment"># ansible node3 -m service -a &quot;name=memcached state=started&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="node0-1-2安装nginx"><a href="#node0-1-2安装nginx" class="headerlink" title="node0,1,2安装nginx"></a>node0,1,2安装nginx</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m copy -a &quot;src=/root/nginx-1.10.0-1.el7.ngx.x86_64.rpm dest=/root/ &quot; ; done</span></span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ssh node$i yum -y install  /root/nginx-1.10.0-1.el7.ngx.x86_64.rpm ; done</span></span><br><span class="line">node1,2安装php-fpm mariadb php-pecl-memcached php-memcache php-memcached</span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m yum -a &quot;name=mariadb-server state=present&quot; ; done</span></span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m yum -a &quot;name=php-fpm state=present&quot; ; done</span></span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m service -a &quot;name=mariadb enabled=on&quot; ; done</span></span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m yum -a &quot;name=php-pecl-memcached state=present&quot; ; done</span></span><br><span class="line"><span class="comment"># ll /usr/lib64/php/modules/ 安装完 php-peclmemcached 后可以看到 memcached.so</span></span><br><span class="line">-rwxr-xr-x 1 root root  118160 Apr  2  2014 memcached.so</span><br><span class="line">-rwxr-xr-x 1 root root  106160 Jun 10  2014 memcache.so</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ansible node$i -m yum -a &quot;name=php-memcache state=present&quot;;done;</span></span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ansible node$i -m yum -a &quot;name=php-memcached state=present&quot;;done;</span></span><br><span class="line"><span class="comment"># vim /etc/php.ini </span></span><br><span class="line"><span class="comment"># 注这里用的是ansible 所以可以修改或编辑好一个配置文件，然后复制到其它的两个在线的结点</span></span><br><span class="line">[PHP]  </span><br><span class="line">extension = <span class="string">&quot;/usr/lib64/php/modules/memcache.so&quot;</span>  注：要修改的地方</span><br><span class="line">extension = <span class="string">&quot;/usr/lib64/php/modules/memcached.so&quot;</span> 注：要修改的地方</span><br><span class="line">session.save_handler = memcached  注:需要修改</span><br><span class="line">session.save_path = <span class="string">&quot;tcp://node3:11211 注：需要修改 </span></span><br><span class="line"><span class="string"># for i in &#123;1..2&#125;; do ansible node<span class="variable">$i</span> -m copy -a &quot;</span>src=/etc/php.ini dest=/etc/ <span class="string">&quot; ; done</span></span><br><span class="line"><span class="string"># for i in &#123;1..2&#125;; do ansible node<span class="variable">$i</span> -m service -a &quot;</span>name=php-fpm state=started <span class="string">&quot; ; done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/nginx/conf.d/default.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">listen       80;</span><br><span class="line">server_name  localhost;</span><br><span class="line">location / &#123;</span><br><span class="line">       root   /usr/share/nginx/html;</span><br><span class="line">       index  index.html index.htm index.php;</span><br><span class="line">&#125;</span><br><span class="line">error_page   500 502 503 504  /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root   /usr/share/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">root           /usr/share/nginx/html;</span><br><span class="line">fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">fastcgi_index  index.php;</span><br><span class="line">fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">include        fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#vim /usr/share/nginx/html/index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">phpinfo() ;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="将nignx的配置文件和php的测试页复制到两个结点上"><a href="#将nignx的配置文件和php的测试页复制到两个结点上" class="headerlink" title="将nignx的配置文件和php的测试页复制到两个结点上"></a>将nignx的配置文件和php的测试页复制到两个结点上</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m copy -a &quot;src=/etc/nginx/conf.d/default.conf dest=/etc/nginx/conf.d/ &quot; ; done</span></span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m copy -a &quot;src=/usr/share/nginx/html/index.php dest=/usr/share/nginx/html/ &quot; ; done</span></span><br><span class="line">启动两个结点(node1,node2)的nginx</span><br><span class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ansible node$i -m service -a &quot;name=nginx state=started&quot;;done;</span></span><br></pre></td></tr></table></figure>
<p><code>在浏览器中输入 http://172.16.23.11/index.php</code><br>查看两个结点的php是否正常工作，并且查看其index.php中提供的phpinfo(); php<br>配置信息 ，可以查看到memcache 和memcached两项<br><img src="/images/nginx_upstream_test1.png" class="lazyload" data-srcset="/images/nginx_upstream_test1.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/nginx_upstream_test2.png" class="lazyload" data-srcset="/images/nginx_upstream_test2.png" srcset="data:image/png;base64,666" alt=""></p>
<p><code>访问 http://172.16.23.12/index.php</code></p>
<p><img src="/images/nginx_upstream_test3.png" class="lazyload" data-srcset="/images/nginx_upstream_test3.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/nginx_upstream_test4.png" class="lazyload" data-srcset="/images/nginx_upstream_test4.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="三、在node0结点上配置nginx负载均衡"><a href="#三、在node0结点上配置nginx负载均衡" class="headerlink" title="三、在node0结点上配置nginx负载均衡"></a>三、在node0结点上配置nginx负载均衡</h2><p>后台两台(node1,node2)主机，为两结点通过php程序测试mariadb<br>注：</p>
<ol>
<li>由于ansible就在node0上，所以此处直接用系统自身的命令来进行配置，而非远程执行;</li>
<li>把刚刚给node1,node2远程复制的default.conf配置还原还去;</li>
<li>由于node0的nginx无其它将配置文件删了重新安装一下nignx 也行；</li>
</ol>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 在http段中加入以下内容</span></span><br><span class="line">upstream mem &#123;</span><br><span class="line">server node1:80;</span><br><span class="line">server node2:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="comment"># 在每一个location中加入以下内容</span></span><br><span class="line">proxy_pass http://mem;</span><br><span class="line"><span class="comment"># systemctrl start nginx  </span></span><br></pre></td></tr></table></figure>
<p>此时nginx已经可以负载均衡后面的两台服务器了<br>为node1,node2提供两个php连接mysql的测试页</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;h1&gt;www.rj.com NODE2&lt;/h1&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$link=mysql_connect(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;centos.123&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!$link)<span class="keyword">echo</span><span class="string">&quot;CNONNECT FILED!&quot;</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;CAN CNONNECT !&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>此时访问nginx的负载均衡的结点172.16.23.10后可测试结果如下</p>
<p><img src="/images/nginx_upstream_test5.png" class="lazyload" data-srcset="/images/nginx_upstream_test5.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/nginx_upstream_test6.png" class="lazyload" data-srcset="/images/nginx_upstream_test6.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>MariaDB之基于openssl的主从复制</title>
    <url>/2018/02/07/MariaDB%E4%B9%8B%E5%9F%BA%E4%BA%8Eopenssl%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="一、配置openssl"><a href="#一、配置openssl" class="headerlink" title="一、配置openssl"></a>一、配置openssl</h2><h3 id="1、-在master-server-node0-上根CA的搭建-及生成自签名证书"><a href="#1、-在master-server-node0-上根CA的搭建-及生成自签名证书" class="headerlink" title="1、   在master server(node0)上根CA的搭建(及生成自签名证书)"></a>1、   在master server(node0)上根CA的搭建(及生成自签名证书)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 ~]<span class="comment"># cd /etc/pki/CA/</span></span><br><span class="line">[root@node0 CA]<span class="comment"># (umask 077;openssl genrsa -out private/cakey.pem 2048)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.................+++</span><br><span class="line">..................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@node0 CA]<span class="comment"># touch index.txt </span></span><br><span class="line">[root@node0 CA]<span class="comment"># echo 01 &gt; serial</span></span><br><span class="line">[root@node0 CA]<span class="comment"># openssl req -new -x509 -key private/cakey.pem -out ./cacert.pem -days 3650</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BJ</span><br><span class="line">Locality Name (eg, city) [Default City]:BJ</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:rj</span><br><span class="line">Organizational Unit Name (eg, section) []:rj</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.rj.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br></pre></td></tr></table></figure>
<h3 id="2、为master主机生成密钥，并名为之签名"><a href="#2、为master主机生成密钥，并名为之签名" class="headerlink" title="2、为master主机生成密钥，并名为之签名"></a>2、为master主机生成密钥，并名为之签名</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 CA]<span class="comment"># cd /etc/my.cnf.d/</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># (umask 077;openssl genrsa -out master.key 2048)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...............................................+++</span><br><span class="line">................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># openssl req -new -key /etc/my.cnf.d/master.key -out /etc/my.cnf.d/master.csr</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BJ  </span><br><span class="line">Locality Name (eg, city) [Default City]:BJ</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:rj</span><br><span class="line">Organizational Unit Name (eg, section) []:rj</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.rj.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:</span></span><br><span class="line"><span class="string">An optional company name []: </span></span><br></pre></td></tr></table></figure>
<h3 id="3、根CA签发master请求"><a href="#3、根CA签发master请求" class="headerlink" title="3、根CA签发master请求"></a>3、根CA签发master请求</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 my.cnf.d]<span class="comment"># openssl ca -in master.csr -out master.crt -days 3650</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Feb 16 06:55:06 2017 GMT</span><br><span class="line">            Not After : Feb 14 06:55:06 2027 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = BJ</span><br><span class="line">            organizationName          = rj</span><br><span class="line">            organizationalUnitName    = rj</span><br><span class="line">            commonName                = www.rj.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                B4:A1:66:8C:5B:2B:F9:59:9D:F6:4F:F7:35:72:E2:87:9C:A5:95:F9</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:71:DD:03:78:51:12:5F:58:C2:1B:53:76:A0:2B:E9:BF:60:D8:67:36</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Feb 14 06:55:06 2027 GMT (3650 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure>
<h3 id="4、为slave结点-node1-配置openssl"><a href="#4、为slave结点-node1-配置openssl" class="headerlink" title="4、为slave结点(node1)配置openssl"></a>4、为slave结点(node1)配置openssl</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 CA]<span class="comment"># cd /etc/my.cnf.d/</span></span><br><span class="line">[root@node1 my.cnf.d]<span class="comment"># (umask 077;openssl genrsa -out slave.key 2048)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.............+++</span><br><span class="line">......................................................................................................................................................................................................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@node1 my.cnf.d]<span class="comment"># openssl req -new -key slave.key -out slave.csr</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BJ</span><br><span class="line">Locality Name (eg, city) [Default City]:BJ</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:rj</span><br><span class="line">Organizational Unit Name (eg, section) []:rj</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.rj.com</span></span><br><span class="line"><span class="string">Email Address []:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br><span class="line"><span class="string">[root@node1 my.cnf.d]# scp slave.csr node0:/tmp</span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>node0 (172.16.23.10)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is 2b:98:49:35:5b:78:24:ed:f0:ab:fa:54:b1:8e:df:29.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="string">&#x27;node0,172.16.23.10&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">root@node0<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">slave.csr</span></span><br></pre></td></tr></table></figure>
<h3 id="5、为slave结点签发请求"><a href="#5、为slave结点签发请求" class="headerlink" title="5、为slave结点签发请求"></a>5、为slave结点签发请求</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 my.cnf.d]<span class="comment"># mv /etc/pki/CA/serial /root/</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># mv /etc/pki/CA/index.txt /root/</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># touch /etc/pki/CA/index.txt</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># echo 01 &gt; /etc/pki/CA/serial</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># openssl ca -in /tmp/slave.csr -out slave.crt -days 3650</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Feb 16 07:07:14 2017 GMT</span><br><span class="line">            Not After : Feb 14 07:07:14 2027 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = BJ</span><br><span class="line">            organizationName          = rj</span><br><span class="line">            organizationalUnitName    = rj</span><br><span class="line">            commonName                = www.rj.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                A5:FE:11:EB:4D:B5:F1:85:61:E7:18:E3:1D:B7:25:C6:1B:24:97:AF</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:71:DD:03:78:51:12:5F:58:C2:1B:53:76:A0:2B:E9:BF:60:D8:67:36</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Feb 14 07:07:14 2027 GMT (3650 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 my.cnf.d]<span class="comment"># scp slave.crt node1:/etc/my.cnf.d/</span></span><br><span class="line">slave.crt                                                                                                                                                    100% 4382     4.3KB/s   00:00    </span><br><span class="line"><span class="comment"># 此时主从结点的证书都已经准备好</span></span><br></pre></td></tr></table></figure>
<h2 id="二、配置mariadb主从服务器"><a href="#二、配置mariadb主从服务器" class="headerlink" title="二、配置mariadb主从服务器"></a>二、配置mariadb主从服务器</h2><h3 id="1、工作拓扑图"><a href="#1、工作拓扑图" class="headerlink" title="1、工作拓扑图"></a>1、工作拓扑图</h3><p><img src="/images/mariadb_openssl.png" class="lazyload" data-srcset="/images/mariadb_openssl.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="2、主服务器配置"><a href="#2、主服务器配置" class="headerlink" title="2、主服务器配置"></a>2、主服务器配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 ~]<span class="comment"># yum -y install mariadb</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">将mysqld段中的配置修改为以下内容</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">innodb-file-per-table = ON</span><br><span class="line">skip-name-resolve = ON</span><br><span class="line">server-id = 1 </span><br><span class="line">log-bin = master-log</span><br><span class="line">ssl</span><br><span class="line">ssl_ca=/etc/my.cnf.d/cacert.pem </span><br><span class="line">ssl_cert=/etc/my.cnf.d/master.crt</span><br><span class="line">ssl_key=/etc/my.cnf.d/master.key </span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># cp /etc/pki/CA/cacert.pem  .</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># chown mysql.mysql cacert.pem master.*</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>
<h3 id="3、从服务配置"><a href="#3、从服务配置" class="headerlink" title="3、从服务配置"></a>3、从服务配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 ~]<span class="comment"># yum -y install mariadb</span></span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">将mysqld段中的配置修改为以下内容</span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">skip_name_resolve = ON </span><br><span class="line">relay-log = relay-log</span><br><span class="line">server-id = 2 注id号不能与主服务的一样</span><br><span class="line">ssl</span><br><span class="line">ssl-ca = /etc/my.cnf.d/cacert.pem</span><br><span class="line">ssl-cert = /etc/my.cnf.d/slave.crt</span><br><span class="line">ssl-key = /etc/my.cnf.d/slave.key</span><br><span class="line">[root@node0 my.cnf.d]<span class="comment"># scp /etc/pki/CA/cacert.pem node1:/etc/my.cnf.d/</span></span><br><span class="line">cacert.pem </span><br><span class="line">[root@node1 my.cnf.d]<span class="comment"># cd /etc/my.cnf.d/ &amp;&amp; chown mysql.mysql cacert.pem slave.*</span></span><br><span class="line">[root@node1 my.cnf.d]<span class="comment"># systemctl start mariadb</span></span><br></pre></td></tr></table></figure>
<h3 id="4、主服务器授权一个用户可连接mysql拉取二进制文件"><a href="#4、主服务器授权一个用户可连接mysql拉取二进制文件" class="headerlink" title="4、主服务器授权一个用户可连接mysql拉取二进制文件"></a>4、主服务器授权一个用户可连接mysql拉取二进制文件</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO &#x27;rj&#x27;@&#x27;172.16.23.11&#x27; IDENTIFIED BY &#x27;centos.123&#x27; REQUIRE ssl;</span><br></pre></td></tr></table></figure>
<h3 id="5、配置从服务器连接到主服务器，并拉取数据"><a href="#5、配置从服务器连接到主服务器，并拉取数据" class="headerlink" title="5、配置从服务器连接到主服务器，并拉取数据"></a>5、配置从服务器连接到主服务器，并拉取数据</h3><p>先查看主结点的二进制日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt;  SHOW MASTER STATUS; </span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| master-log.000007 |      342 |              |                  |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=&#x27;172.16.23.10&#x27;, MASTER_USER=&#x27;rj&#x27;, MASTER_PASSWORD=&#x27;centos.123&#x27;, MASTER_LOG_FILE=&#x27;master-log.000007&#x27;, MASTER_LOG_POS=245, MASTER_SSL=1, MASTER_SSL_CA=&#x27;/etc/my.cnf.d/cacert.pem&#x27;, MASTER_SSL_CERT=&#x27;/etc/my.cnf.d/slave.crt&#x27;, MASTER_SSL_KEY=&#x27;/etc/my.cnf.d/slave.key&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line">查看主从服务器的openssl的是用否用</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE &#x27;%ssl%&#x27;;</span><br><span class="line">+<span class="comment">---------------+--------------------------+</span></span><br><span class="line">| Variable_name | Value                    |</span><br><span class="line">+<span class="comment">---------------+--------------------------+</span></span><br><span class="line">| have_openssl  | YES                      |</span><br><span class="line">| have_ssl      | YES                      |</span><br><span class="line">| ssl_ca        | /etc/my.cnf.d/cacert.pem |</span><br><span class="line">| ssl_capath    |                          |</span><br><span class="line">| ssl_cert      | /etc/my.cnf.d/master.crt |</span><br><span class="line">| ssl_cipher    |                          |</span><br><span class="line">| ssl_key       | /etc/my.cnf.d/master.key |</span><br><span class="line">+<span class="comment">---------------+--------------------------+</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE &#x27;%ssl%&#x27;;</span><br><span class="line">+<span class="comment">---------------+--------------------------+</span></span><br><span class="line">| Variable_name | Value                    |</span><br><span class="line">+<span class="comment">---------------+--------------------------+</span></span><br><span class="line">| have_openssl  | YES                      |</span><br><span class="line">| have_ssl      | YES                      |</span><br><span class="line">| ssl_ca        | /etc/my.cnf.d/cacert.pem |</span><br><span class="line">| ssl_capath    |                          |</span><br><span class="line">| ssl_cert      | /etc/my.cnf.d/slave.crt  |</span><br><span class="line">| ssl_cipher    |                          |</span><br><span class="line">| ssl_key       | /etc/my.cnf.d/slave.key  |</span><br><span class="line">+<span class="comment">---------------+--------------------------+</span></span><br></pre></td></tr></table></figure>
<h3 id="6、启用从服务器"><a href="#6、启用从服务器" class="headerlink" title="6、启用从服务器"></a>6、启用从服务器</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.16.23.10</span><br><span class="line">                  Master_User: rj</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-log.000007</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: relay-log.000003</span><br><span class="line">                Relay_Log_Pos: 530</span><br><span class="line">        Relay_Master_Log_File: master-log.000007</span><br><span class="line">             Slave_IO_Running: Yes  注:IO SQL这两项表示主从同步已经正学进行</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 245</span><br><span class="line">              Relay_Log_Space: 818</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: Yes</span><br><span class="line">           Master_SSL_CA_File: /etc/my.cnf.d/cacert.pem</span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: /etc/my.cnf.d/slave.crt</span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: /etc/my.cnf.d/slave.key</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="7、由于从服务器只能读，所以需要开启mariadb的只读"><a href="#7、由于从服务器只能读，所以需要开启mariadb的只读" class="headerlink" title="7、由于从服务器只能读，所以需要开启mariadb的只读"></a>7、由于从服务器只能读，所以需要开启mariadb的只读</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt;  SHOW VARIABLES LIKE &#x27;read_only&#x27;;</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| read_only     | ON    |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SET GLOBAL read_only=ON;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="8、openssl进行测试"><a href="#8、openssl进行测试" class="headerlink" title="8、openssl进行测试"></a>8、openssl进行测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">[root@node1 my.cnf.d]<span class="comment"># mysql -urj -pcentos.123 -h172.16.23.10 --ssl-ca=/etc/my.cnf.d/cacert.pem --ssl-cert=/etc/my.cnf.d/slave.crt --ssl-key=/etc/my.cnf.d/slave.key</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; or \g.</span><br><span class="line">Your MariaDB connection id is 7</span><br><span class="line">Server version: 5.5.44-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#x27;<span class="keyword">help</span>;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| test               |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="9、主从同步测试"><a href="#9、主从同步测试" class="headerlink" title="9、主从同步测试"></a>9、主从同步测试</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CREATE DATABASE node0create;在主服务上创建了一个库</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES; 在从服务器上也可以查看到了</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| node0create        |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>corosync v2 + pacemaker + crmsh 实现mariadb高可用</title>
    <url>/2018/02/07/corosync-v2-pacemaker-crmsh-%E5%AE%9E%E7%8E%B0mariadb%E9%AB%98%E5%8F%AF%E7%94%A8/</url>
    <content><![CDATA[<p>[toc]</p>
<p>高可用mariadb拓扑图</p>
<p><img src="/images/corosync_mariadb_rhca.png" class="lazyload" data-srcset="/images/corosync_mariadb_rhca.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="一、设计前提"><a href="#一、设计前提" class="headerlink" title="一、设计前提"></a>一、设计前提</h2><p>1、时间同步 # ntpdate 172.16.0.1 或者 # chronyc sources<br>2、所有的主机对应的IP地址解析可以正常工作， 主机名要与命令#uname -n 所得的结果一致</p>
<p>因此，/etc/hosts中的内容为以下内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">172.16.23.10 node1.rj.com node1 </span><br><span class="line">172.16.23.11 node2.rj.com node2 </span><br><span class="line">172.16.23.12 node3.rj.com node3</span><br></pre></td></tr></table></figure>
<h2 id="二、环境的建立及安装orosync-pacemaker-crmsh"><a href="#二、环境的建立及安装orosync-pacemaker-crmsh" class="headerlink" title="二、环境的建立及安装orosync ,pacemaker ,crmsh"></a>二、环境的建立及安装orosync ,pacemaker ,crmsh</h2><p>三台机器都安装好ansible （对于ansible集群管理工具而言需要双机互信,其中node1当做堡垒机）</p>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ssh-keygen  </span></span><br><span class="line"><span class="comment"># for i in &#123;10..12&#125;; do ssh-copy-id -i 172.16.23.$i ; done ; </span></span><br><span class="line"><span class="comment"># 此条命令将公钥发送给三台机器，其中包括自己也就是堡垒机</span></span><br><span class="line"><span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">	[mariadb]</span><br><span class="line">	172.16.23.10</span><br><span class="line">	172.16.23.11</span><br><span class="line">	172.16.23.12</span><br><span class="line"><span class="comment"># ansible mariadb -m ping </span></span><br><span class="line"><span class="comment"># 测试三台主机与堡垒机之间的连通性 </span></span><br><span class="line"><span class="comment"># vim /etc/hosts 主机名解析配置</span></span><br><span class="line">	172.16.23.10 node1.rj.com node1</span><br><span class="line">	172.16.23.11 node2.rj.com node2</span><br><span class="line">	172.16.23.12 node3.rj.com node3</span><br><span class="line"><span class="comment"># ansible mariadb -m command -a &quot;ntpdate 172.16.0.1&quot;  同步三台主机的时间 </span></span><br><span class="line"><span class="comment"># ansible mariadb -m yum -a &quot;name=pacemaker,mariadb-server state=present&quot; 在三台主机上安装 mariadb ,corosync 和 pacemaker</span></span><br></pre></td></tr></table></figure>
<pre><code>注：yum 安装pacemaker 的时候，其corosync也会自动安装上
</code></pre><h3 id="corosync配置"><a href="#corosync配置" class="headerlink" title="corosync配置"></a>corosync配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/corosync/corosync.conf </span></span><br><span class="line">加入以下信息</span><br><span class="line">	totem &#123;</span><br><span class="line">		version: 2</span><br><span class="line">		crypto_cipher: aes256</span><br><span class="line">		crypto_hash: sha1</span><br><span class="line">		interface &#123;</span><br><span class="line">			ringnumber: 0</span><br><span class="line">			bindnetaddr: 172.16.0.0</span><br><span class="line">			mcastaddr: 239.255.23.1</span><br><span class="line">			mcastport: 5405</span><br><span class="line">			ttl: 1</span><br><span class="line">		&#125;</span><br><span class="line">	logging &#123;</span><br><span class="line">		fileline: off</span><br><span class="line">		to_stderr: no</span><br><span class="line">		to_logfile: yes</span><br><span class="line">		logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">		to_syslog: no</span><br><span class="line">		debug: off</span><br><span class="line">		timestamp: on</span><br><span class="line">		logger_subsys &#123;</span><br><span class="line">			subsys: QUORUM</span><br><span class="line">			debug: off</span><br><span class="line">		&#125;</span><br><span class="line">	quorum &#123;</span><br><span class="line">		provider: corosync_votequorum</span><br><span class="line">		node &#123;</span><br><span class="line">			ring0_addr: node1.rj.com</span><br><span class="line">			nodeid:1 </span><br><span class="line">		&#125;</span><br><span class="line">		node &#123;</span><br><span class="line">			ring0_addr: node2.rj.com</span><br><span class="line">			nodeid:2 </span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		node &#123;</span><br><span class="line">			</span><br><span class="line">ring0_addr: node3.rj.com</span><br><span class="line">			nodeid:3</span><br><span class="line">				&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># corosync-keygen </span></span><br><span class="line"><span class="comment"># ansible mariadb -m copy -a &quot;src=/etc/corosync/authkey dest=/etc/corosync/&quot;</span></span><br><span class="line"><span class="comment"># ansible mariadb -m copy -a &quot;src=/etc/corosync/corosync.conf dest=/etc/corosync/&quot;</span></span><br><span class="line"><span class="comment"># ansible mariadb -m service -a &quot;name=corosync state=persent&quot;</span></span><br><span class="line"><span class="comment"># ansible mariadb -m service -a &quot;name=pacemaker state=persent&quot;</span></span><br><span class="line"><span class="comment">#  tcpdump -i eno16777736 -nn port 5405</span></span><br></pre></td></tr></table></figure>
<h3 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h3><p>使用tcpdump抓包工具可以来查看三台主机之间传递的心跳信息</p>
<p><img src="/images/corosync_mariadb_tcpdump.png" class="lazyload" data-srcset="/images/corosync_mariadb_tcpdump.png" srcset="data:image/png;base64,666" alt=""><br>注:mariadb在集群资源的配置中必需是开机自启动的<br>这样corosync才能实别其Unitfile 文件，而不能在配置前启动所以服务一定是关闭的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ansible mariadb -m service -a &quot;name=mariadb enabled=on&quot;</span></span><br><span class="line"><span class="comment"># ansible mariadb -m service -a &quot;name=corosync enabled=on&quot;</span></span><br><span class="line"><span class="comment"># ansible mariadb -m service -a &quot;name=pacemaker enabled=on&quot;</span></span><br><span class="line"><span class="comment"># mkdir rpm &amp;&amp; cd rpm </span></span><br><span class="line"><span class="comment"># wget 172.18.0.1/pub/Sources/7.x86_64/crmsh/crmsh-2.1.4-1.1.x86_64.rpm 下载crmsh及其所依赖的rpm包 </span></span><br><span class="line"><span class="comment"># wget 172.18.0.1/pub/Sources/7.x86_64/crmsh/pssh*.rpm</span></span><br><span class="line"><span class="comment"># wget 172.18.0.1/pub/Sources/7.x86_64/crmsh/python-passh*.rpm </span></span><br><span class="line"><span class="comment"># ansible mariadb -m copy -a &quot;src=/root/rpm dest=/root/&quot;</span></span><br><span class="line"><span class="comment"># for i in &#123;1..3&#125;; do ssh node$i yum -y install /root/rpm/*; done</span></span><br></pre></td></tr></table></figure>
<h3 id="查看corosync引擎是否已经正常启动"><a href="#查看corosync引擎是否已经正常启动" class="headerlink" title="查看corosync引擎是否已经正常启动"></a>查看corosync引擎是否已经正常启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ansible mariadb -e command -a &quot;grep -e &#x27;Corosync Cluster Engine&#x27; -e &#x27;configuration file&#x27; /var/log/messages&quot; </span></span><br><span class="line">Feb 13 11:27:35 node1 systemd: Stopped Corosync Cluster Engine.</span><br><span class="line">Feb 13 14:08:03 node1 systemd: Starting Corosync Cluster Engine...</span><br><span class="line">Feb 13 14:08:04 node1 corosync: Starting Corosync Cluster Engine (corosync): [  OK  ]</span><br><span class="line">Feb 13 14:08:04 node1 systemd: Started Corosync Cluster Engine.</span><br><span class="line">Feb 13 14:28:16 node1 systemd: Mounted NFSD configuration filesystem.</span><br><span class="line">Feb 13 14:28:44 node1 smartd[787]: Opened configuration file /etc/smartmontools/smartd.conf</span><br><span class="line">Feb 13 14:32:12 node1 systemd: Starting Corosync Cluster Engine...</span><br><span class="line">        	Feb 13 14:32:13 node1 corosync: Starting Corosync Cluster Engine (corosync): [  OK  ]</span><br><span class="line">Feb 13 14:32:13 node1 systemd: Started Corosync Cluster Engine.</span><br><span class="line">Feb 13 14:43:03 node1 systemd: Started Corosync Cluster Engine.</span><br></pre></td></tr></table></figure>
<h3 id="查看其成员之间的结点通知信息是否正常"><a href="#查看其成员之间的结点通知信息是否正常" class="headerlink" title="查看其成员之间的结点通知信息是否正常"></a>查看其成员之间的结点通知信息是否正常</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ansible mariadb -e command -a &quot;grep TOTEM /var/log/messages&quot;</span></span><br><span class="line">查看启动过程中是否有错误信息产生 </span><br><span class="line"><span class="comment"># ansible mariadb -e command -a &quot;grep &#x27;ERROR&#x27; /var/log/messages&quot;</span></span><br><span class="line">查看pacemaker是否已经正常启动</span><br><span class="line"><span class="comment"># ansible mariadb -e command -a &quot;grep &#x27;pacemaker&#x27; /var/log/messages &quot;</span></span><br><span class="line"> 使用以下命令查看结点的状态</span><br><span class="line"><span class="comment"># crm status  </span></span><br><span class="line">Last updated: Mon Feb 13 15:43:08 2017</span><br><span class="line">Last change: Mon Feb 13 14:33:58 2017 by hacluster via crmd on node3.rj.com</span><br><span class="line">Stack: corosync		Current DC: node3.rj.com (version 1.1.13-10.el7-44eb2dd) - partition with quorum</span><br><span class="line">3 nodes and 0 resources configured	Online: [ node1.rj.com node2.rj.com node3.rj.com ]</span><br></pre></td></tr></table></figure>
<h3 id="查看pacemaker-和与corosync所启动的进程"><a href="#查看pacemaker-和与corosync所启动的进程" class="headerlink" title="查看pacemaker 和与corosync所启动的进程"></a>查看pacemaker 和与corosync所启动的进程</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ansible mariadb -m command -a &quot;ps auxf &quot; | grep pacemaker</span></span><br><span class="line">root       1720  0.0  1.3 130484  6384 ?        Ss   14:33   0:00 /usr/sbin/pacemakerd -f</span><br><span class="line">haclust+   1729  0.0  2.7 132816 13268 ?        Ss   14:33   0:01  \_ /usr/libexec/pacemaker/cib</span><br><span class="line">root       1730  0.0  1.4 133968  6956 ?        Ss   14:33   0:00  \_ /usr/libexec/pacemaker/stonithd</span><br><span class="line">root       1731  0.0  0.8 102936  4108 ?        Ss   14:33   0:00  \_ /usr/libexec/pacemaker/lrmd</span><br><span class="line">haclust+   1732  0.0  1.3 124780  6736 ?        Ss   14:33   0:00  \_ /usr/libexec/pacemaker/attrd</span><br><span class="line">haclust+   1733  0.0  0.7 114896  3668 ?        Ss   14:33   0:00  \_ /usr/libexec/pacemaker/pengine</span><br><span class="line">haclust+   1734  0.0  1.5 143160  7484 ?        Ss   14:33   0:00  \_ /usr/libexec/pacemaker/crmd</span><br><span class="line"><span class="comment"># ansible marriadb -m command -a &quot;ps auxf&quot; | grep corosync </span></span><br><span class="line">root       1483  0.6  7.9 134848 38436 ?        Ssl  14:32   0:28 corosync</span><br></pre></td></tr></table></figure>
<h2 id="三、利用crmsh来配置corosync的IP地址资源及mariadb资源"><a href="#三、利用crmsh来配置corosync的IP地址资源及mariadb资源" class="headerlink" title="三、利用crmsh来配置corosync的IP地址资源及mariadb资源"></a>三、利用crmsh来配置corosync的IP地址资源及mariadb资源</h2><pre><code>如果想要查看某种类别下的所用资源代理的列表，可以使用类似以下的命令来实现
</code></pre><h3 id="安装配置-1"><a href="#安装配置-1" class="headerlink" title="安装配置"></a>安装配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#crm ra list lsb </span></span><br><span class="line"><span class="comment">#crm ra list ocf heartbeat </span></span><br><span class="line"><span class="comment">#crm ra list ocf pacemaker </span></span><br><span class="line"><span class="comment">#crm ra list ocf stonith</span></span><br></pre></td></tr></table></figure>
<h3 id="配置vip"><a href="#配置vip" class="headerlink" title="配置vip"></a>配置vip</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> <span class="comment"># crm configure property stonith-enabled=false #关闭stonsth设备</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crm configure primitive DBIP ocf:heartbeat:IPaddr params ip=172.16.23.23 添加vip资源代理  </span></span><br><span class="line"><span class="comment"># crm configure verify 查看是否有错误</span></span><br><span class="line"><span class="comment"># crm configure commit 用来提交配置信息 </span></span><br><span class="line"><span class="comment"># crm configure show  可以用来查看配置信息</span></span><br><span class="line">	node 1: node1.rj.com</span><br><span class="line">	node 2: node2.rj.com</span><br><span class="line">	node 3: node3.rj.com</span><br><span class="line">	primitive DBIP IPaddr \</span><br><span class="line">		params ip=172.16.23.23</span><br><span class="line">	property cib-bootstrap-options: \</span><br><span class="line">		have-watchdog=<span class="literal">false</span> \</span><br><span class="line">		dc-version=1.1.13-10.el7-44eb2dd \</span><br><span class="line">		cluster-infrastructure=corosync \</span><br><span class="line">		stonith-enabled=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crm node standby node1.rj.com	当将node1结点成为备用结点时 </span></span><br><span class="line"><span class="comment"># ansible mariadb -m command -a &quot;ip addr list&quot; 查看其vip的变化信息</span></span><br><span class="line"><span class="comment"># crm ra info systemd:mairadb 用来查看systemd类型的mariadb资源的语法格式 </span></span><br><span class="line">	systemd unit file <span class="keyword">for</span> mariadb (systemd:mariadb)</span><br><span class="line">		MariaDB database server</span><br><span class="line">	Operations<span class="string">&#x27; defaults (advisory minimum):</span></span><br><span class="line"><span class="string">		start         timeout=15</span></span><br><span class="line"><span class="string">		stop          timeout=15</span></span><br><span class="line"><span class="string">		status        timeout=15</span></span><br><span class="line"><span class="string">		restart       timeout=15</span></span><br><span class="line"><span class="string">		monitor       timeout=15 interval=15 start-delay=15</span></span><br></pre></td></tr></table></figure>
<h3 id="vip资源"><a href="#vip资源" class="headerlink" title="vip资源"></a>vip资源</h3><p><img src="/images/corosync_mariadb_test1.png" class="lazyload" data-srcset="/images/corosync_mariadb_test1.png" srcset="data:image/png;base64,666" alt=""></p>
<pre><code>当node1 # crm node standby node1.rj.com 时
</code></pre><p><img src="/images/corosync_mariadb_test2.png" class="lazyload" data-srcset="/images/corosync_mariadb_test2.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="定义mariadbg资源并设定监控"><a href="#定义mariadbg资源并设定监控" class="headerlink" title="定义mariadbg资源并设定监控"></a>定义mariadbg资源并设定监控</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crm configure primitive MDB systemd:mariadb op start timeout=15s op stop timeout=15s op monitor interval=15s timeout=15s </span></span><br><span class="line"><span class="comment"># crm configure group DBservice DBIP MDB</span></span><br><span class="line"><span class="comment"># crm configure verify </span></span><br><span class="line"><span class="comment"># crm configure commit </span></span><br><span class="line"><span class="comment"># crm configure show  </span></span><br><span class="line">	node 1: node1.rj.com \</span><br><span class="line">		attributes standby=on</span><br><span class="line">	node 2: node2.rj.com \</span><br><span class="line">		attributes standby=off</span><br><span class="line">	node 3: node3.rj.com \</span><br><span class="line">		attributes standby=off</span><br><span class="line">	primitive DBIP IPaddr \</span><br><span class="line">		params ip=172.16.23.23</span><br><span class="line">	primitive MDB systemd:mariadb \</span><br><span class="line">		op start timeout=15s interval=0 \</span><br><span class="line">		op stop timeout=15s interval=0 \</span><br><span class="line">		op monitor interval=15s timeout=15s</span><br><span class="line">	group DBservice DBIP MDB</span><br><span class="line">	property cib-bootstrap-options: \</span><br><span class="line">		have-watchdog=<span class="literal">false</span> \</span><br><span class="line">		dc-version=1.1.13-10.el7-44eb2dd \</span><br><span class="line">		cluster-infrastructure=corosync \</span><br><span class="line">		stonith-enabled=<span class="literal">false</span> \</span><br><span class="line">		no-quorum-policy=ignore</span><br></pre></td></tr></table></figure>
<pre><code>为mariadb服务加入数据库资源，并配置远程用户远程接入进行测试 
</code></pre><p>注：此时有一个资源已经启动，但其它的两个mariadb服务启动之后才能进行对数据库的更改</p>
<pre><code>           但更改完后旋得再将那两个结点的数据库停止调

node1 node2 node3上执行: #  mysql -e &quot;GRANT ALL  ON *.* TO &apos;root&apos;@&apos;%.%.%.%&apos; IDENTIFIED BY &apos;centos.123&apos;;&quot; 
node1 # mysql -e &quot;CREATE DATABASE NODE1&quot;
node2 # mysql -e &quot;CREATE DATABASE NODE2&quot;
node3 # mysql -e &quot;CREATE DATABASE NODE3&quot;
</code></pre><h3 id="启用一台测试机进行测试"><a href="#启用一台测试机进行测试" class="headerlink" title="启用一台测试机进行测试"></a>启用一台测试机进行测试</h3><p><img src="/images/corosync_mariadb_test3.png" class="lazyload" data-srcset="/images/corosync_mariadb_test3.png" srcset="data:image/png;base64,666" alt=""></p>
<pre><code>node1    
</code></pre><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop corosync.service pacemaker.service </span></span><br><span class="line"><span class="comment"># 当node1的服务停止时</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/corosync_mariadb_test4.png" class="lazyload" data-srcset="/images/corosync_mariadb_test4.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop corosync.service pacemaker.service </span></span><br><span class="line"><span class="comment"># 当node2的服务停止时</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/corosync_mariadb_test5.png" class="lazyload" data-srcset="/images/corosync_mariadb_test5.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 7 tomcat 7.0.54 的功能实现及详解</title>
    <url>/2018/02/07/CentOS-7-tomcat-7-0-54-%E7%9A%84%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%8F%8A%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="一、-jdk-安装配置"><a href="#一、-jdk-安装配置" class="headerlink" title="一、 jdk 安装配置"></a>一、 jdk 安装配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install java-1.8.0-openjdk-devel (依赖的java-1.8.0-openjdk,java-1.8.0-openjdk,headless也会被安装 )</span></span><br><span class="line"><span class="comment"># alternatives -h</span></span><br><span class="line"><span class="comment"># vim /etc/profile.d/java.sh</span></span><br><span class="line">   <span class="comment"># 加入 export JAVA_HOME=/usr</span></span><br><span class="line"><span class="comment"># . /etc/profile.d/java.sh </span></span><br><span class="line"><span class="comment"># printenv 查看环境变量</span></span><br><span class="line"><span class="comment">#用rpm包安装 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># wget ftp://172.16.0.1/pub/Sources/7.x86_64/jdk/jdk-8u25-linux-x64.rpm</span></span><br><span class="line"><span class="comment"># rpm -ivh jdk-8u25-linux-x64.rpm</span></span><br><span class="line"><span class="comment"># rpm -ql jdk1.8.0_25-1.8.0_25-fcs</span></span><br><span class="line"><span class="comment"># cd /usr/java/default</span></span><br><span class="line"><span class="comment"># vim /etc/profile.d/javad.sh</span></span><br><span class="line">JAVA_HOME=/usr/java/latest</span><br><span class="line">PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME PATH</span><br><span class="line"><span class="comment"># . /etc/profile.d/javad.sh </span></span><br><span class="line"><span class="comment"># java -version</span></span><br></pre></td></tr></table></figure>
<p>tomcat:运行于JDK之上，表现为一个独立而完整的java进程，可与用户交互的web服务器<br>使用Java语言编写<br>Tomcat的核心组件:server.xml，其配置的格式为 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Serivce</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">connector</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">connecotr</span>/&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>顶级组件:Server</li>
<li>服务类组件:Service </li>
<li>类 连接类组件:http,https,ajp t</li>
<li>容器类:Engine,Host,Context </li>
<li>被嵌套类:value,logger,realm,loader,manager </li>
<li>集群类组件:listener,cluster,… </li>
<li>cluster,… </li>
</ul>
<h2 id="二、Tomcat安装配置"><a href="#二、Tomcat安装配置" class="headerlink" title="二、Tomcat安装配置"></a>二、Tomcat安装配置</h2><h3 id="1、安装tomcat"><a href="#1、安装tomcat" class="headerlink" title="1、安装tomcat:"></a>1、安装tomcat:</h3><h4 id="a、二进制格式安装"><a href="#a、二进制格式安装" class="headerlink" title="a、二进制格式安装"></a>a、二进制格式安装</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar xvf apache-tomcat-VERSION.tar.gz -C /usr/local/ </span></span><br><span class="line"><span class="comment"># cd /usr/local/ </span></span><br><span class="line"><span class="comment"># ln -sv apache-tomcat-VERSION tomcat </span></span><br><span class="line"><span class="comment">#vim /etc/profile.d/tomcat.sh </span></span><br><span class="line"><span class="built_in">export</span> CATALINA_BASE=/usr/<span class="built_in">local</span>/tomcat </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$CATALINA_BASE</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment"># . /etc/profile.d/tomcat.sh</span></span><br></pre></td></tr></table></figure>
<h4 id="b、yum源安装"><a href="#b、yum源安装" class="headerlink" title="b、yum源安装"></a>b、yum源安装</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install tomcat-webapps tomcat-docs-webapp tomcat-admin-webapps tomcat tomcat-lib</span></span><br><span class="line"><span class="comment"># 安装完后可以使用命令</span></span><br><span class="line"><span class="comment"># systemctl start tomcat &amp;&amp; ss -tnl</span></span><br></pre></td></tr></table></figure>
<p>启动tomcat服务并且查看8080端口是否启用<br><code>在浏览器中进行测试 http://172.16.254.248:8080/</code></p>
<p><img src="/images/tomcat_master.png" class="lazyload" data-srcset="/images/tomcat_master.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="2、tomcat程序目录结构"><a href="#2、tomcat程序目录结构" class="headerlink" title="2、tomcat程序目录结构"></a>2、tomcat程序目录结构</h3><ul>
<li>bin:脚本及启动时用到的类 </li>
<li>conf:配置文件目录 </li>
<li>lib:库文件，java类库</li>
<li>logs:日志文件目录</li>
<li>temp:临时文件目录 </li>
<li>webapps:webapp的默认目录 </li>
<li>work:工作目录 </li>
</ul>
<h3 id="3、tomcat的配置文件说明"><a href="#3、tomcat的配置文件说明" class="headerlink" title="3、tomcat的配置文件说明"></a>3、tomcat的配置文件说明</h3><ul>
<li>server.xml：主配置文件;</li>
<li>web.xml：每个webapp只有部署后才能被访问，它的部署方式通过由web.xml进行定义，其存位置为WEB-INF/目录中，此文件为所有的webapps提供默认配置;</li>
<li>context.xml:每个web都可专用的配置文件，它通常由专用的配置文件context.xml来定义，其存放位置为WEB-INF/目录中，此文件为所有的webapps提供默认配置;</li>
<li>tomcat-users.xml:用户的账号和文件;</li>
<li>catalina.policy:当使用security选项启动tomcat时，用于为tomcat设置安全策略； </li>
<li>catalina.propreteis:java物定义文件，用于设定类加载器路径，以及一些与JVM高估相关参数； </li>
<li>logging.properties:日志系统相关的配置 ;</li>
</ul>
<h3 id="4、tomcat-users-xml配置"><a href="#4、tomcat-users-xml配置" class="headerlink" title="4、tomcat-users.xml配置"></a>4、tomcat-users.xml配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/tomcat/tomcat-users.xml</span></span><br></pre></td></tr></table></figure>
<p>在<tomcat-users>段中加入以五内容 </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">&quot;centos&quot;</span> <span class="attr">password</span>=<span class="string">&quot;centos&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">&quot;admin-gui&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">&quot;centos&quot;</span> <span class="attr">password</span>=<span class="string">&quot;centos&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;admin-gui&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>重启服务后并重新访问http://172.16.254.248:8080/</code></p>
<p><img src="/images/tomcat_server1.png" class="lazyload" data-srcset="/images/tomcat_server1.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/tomcat_server2.png" class="lazyload" data-srcset="/images/tomcat_server2.png" srcset="data:image/png;base64,666" alt=""><br>点Server Status、Manager App、 Host Manager时输入用户名centos密码centos进行访问</p>
<h3 id="5、提供一测试类应用，并冷部署；"><a href="#5、提供一测试类应用，并冷部署；" class="headerlink" title="5、提供一测试类应用，并冷部署；"></a>5、提供一测试类应用，并冷部署；</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#mkdir -pv /usr/share/tomcat/webapps/test/&#123;classes,lib,WEB-INF&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/tomcat/webapps/test/index.jsp </span><br><span class="line"> &lt;%@ page language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"> &lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line"> &lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line">&lt;title&gt; Test Page &lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% out.println(<span class="string">&quot;hellow world&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line">重新访问http:<span class="comment">//172.16.254.248:8080/test/时会显示hellow world  </span></span><br></pre></td></tr></table></figure>
<h3 id="6、nginx-tomcat-cluster"><a href="#6、nginx-tomcat-cluster" class="headerlink" title="6、nginx + tomcat cluster"></a>6、nginx + tomcat cluster</h3><p>用nginx 反代两台tomcat主机 ，cluster(172.16.254.248[nginx]) ,node1(172.16.251.232[Tomcat A]),node2(172.16.251.74[Tomcat B])</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cluster<span class="comment"># yum -y install nginx &amp;&amp; systemctl start nginx </span></span><br><span class="line"><span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 在http段中加入</span></span><br><span class="line">upstream tomcat &#123;</span><br><span class="line">server 172.16.251.232:8080;</span><br><span class="line">server 172.16.251.74:8080;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># vim /etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="comment"># 在location中加入 </span></span><br><span class="line">proxy_pass http://tomcat/;</span><br><span class="line">nod1    <span class="comment"># mkdir -pv /usr/share/tomcat/webapps/test/&#123;WEB-INF,classes,lib&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/tomcat/pwebapps/test/index.jsp </span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">&lt;h1&gt;&lt;font color=&quot;red&quot;&gt;TomcatA.rj.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">&lt;table align=<span class="string">&quot;centre&quot;</span> border=<span class="string">&quot;1&quot;</span>&gt;</span><br><span class="line">  &lt;tr&gt;</span><br><span class="line">&lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">&lt;% session.setAttribute(<span class="string">&quot;magedu.com&quot;</span>,<span class="string">&quot;magedu.com&quot;</span>); %&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">  &lt;/tr&gt;</span><br><span class="line">  &lt;tr&gt;</span><br><span class="line">&lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line"> &lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">nod2    # mkdir -pv /usr/share/tomcat/webapps/test/&#123;WEB-INF,classes,lib&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/tomcat/pwebapps/test/index.jsp </span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">&lt;h1&gt;&lt;font color=&quot;red&quot;&gt;TomcatB.rj.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">&lt;table align=<span class="string">&quot;centre&quot;</span> border=<span class="string">&quot;1&quot;</span>&gt;</span><br><span class="line">  &lt;tr&gt;</span><br><span class="line">&lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">&lt;% session.setAttribute(<span class="string">&quot;magedu.com&quot;</span>,<span class="string">&quot;magedu.com&quot;</span>); %&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">  &lt;/tr&gt;</span><br><span class="line">  &lt;tr&gt;</span><br><span class="line">&lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line"> &lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><code>访问http://172.16.254.248/test/时效果如果下</code></p>
<p><img src="/images/tomcat_test1.png" class="lazyload" data-srcset="/images/tomcat_test1.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/tomcat_test2.png" class="lazyload" data-srcset="/images/tomcat_test2.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="7、-httpd-proxy-http-module-tomcat-cluster"><a href="#7、-httpd-proxy-http-module-tomcat-cluster" class="headerlink" title="7、 httpd(proxy_http_module) + tomcat cluster"></a>7、 httpd(proxy_http_module) + tomcat cluster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cluster<span class="comment">#systemctl disable nginx &amp;&amp; systemctl stop nginx</span></span><br><span class="line">   <span class="comment"># yum -y install httpd </span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># vim /etc/httpd/conf.d/tomcat.conf </span><br><span class="line">&lt;proxy balancer:<span class="comment">//tomcat&gt;</span></span><br><span class="line">BalancerMember http:<span class="comment">//172.16.251.232:8080</span></span><br><span class="line">BalancerMember http:<span class="comment">//172.16.251.74:8080</span></span><br><span class="line">ProxySet  lbmethod=byrequests</span><br><span class="line">&lt;/proxy&gt;</span><br><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">ServerName www.rj.com</span><br><span class="line">ProxyVia On</span><br><span class="line">ProxyRequests Off</span><br><span class="line">ProxyPreserveHost On</span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">ProxyPass / balancer:<span class="comment">//tomcat/</span></span><br><span class="line">ProxyPassReverse / balancer:<span class="comment">//tomcat/</span></span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p><code>访问http://172.16.254.248/test/时效果如下</code></p>
<p><img src="/images/tomcat_test3.png" class="lazyload" data-srcset="/images/tomcat_test3.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/tomcat_test4.png" class="lazyload" data-srcset="/images/tomcat_test4.png" srcset="data:image/png;base64,666" alt=""><br>启用balancer管理接口</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">cluster# vim /etc/httpd/conf.d/balancer-manager.conf </span><br><span class="line">&lt;Location /balancer-manager&gt;</span><br><span class="line">Sethandler balancer-manager </span><br><span class="line">ProxyPass !</span><br><span class="line">Require all granted </span><br><span class="line">&lt;/Location&gt;</span><br></pre></td></tr></table></figure>
<pre><code>`访问其管理接口http://172.16.254.248/balancer-manager效果如下`
</code></pre><p><img src="/images/tomcat_manager1.png" class="lazyload" data-srcset="/images/tomcat_manager1.png" srcset="data:image/png;base64,666" alt=""></p>
<h3 id="8、-httpd-proxy-ajp-module-tomcat-cluster"><a href="#8、-httpd-proxy-ajp-module-tomcat-cluster" class="headerlink" title="8、 httpd(proxy_ajp_module)+tomcat cluster"></a>8、 httpd(proxy_ajp_module)+tomcat cluster</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /etc/httpd/conf.d/tomcat.conf /etc/httpd/conf.d/tomcat.conf.bak</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># vim /etc/httpd/conf.d/tomcat.conf </span><br><span class="line">&lt;proxy balancer:<span class="comment">//tomcat&gt;</span></span><br><span class="line">BalancerMember ajp:<span class="comment">//172.16.251.232:8009</span></span><br><span class="line">BalancerMember ajp:<span class="comment">//172.16.251.74:8009</span></span><br><span class="line">ProxySet  lbmethod=byrequests</span><br><span class="line">&lt;/proxy&gt;</span><br><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">ServerName www.rj.com</span><br><span class="line">ProxyVia On </span><br><span class="line">ProxyRequests Off </span><br><span class="line">ProxyPreserveHost On </span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">Require all granted </span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">ProxyPass / balancer:<span class="comment">//tomcat/</span></span><br><span class="line">ProxyPassReverse / balancer:<span class="comment">//tomcat/</span></span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">Require all granted </span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p>访问<a href="http://172.16.254.248/test/时效果如下">http://172.16.254.248/test/时效果如下</a></p>
<p><img src="/images/tomcat_test5.png" class="lazyload" data-srcset="/images/tomcat_test5.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/tomcat_test6.png" class="lazyload" data-srcset="/images/tomcat_test6.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="三、常用组件配置"><a href="#三、常用组件配置" class="headerlink" title="三、常用组件配置"></a>三、常用组件配置</h2><p>Server:代表tomcat instance, 即表现出一个Java进程：监听在8005端口，只接收“SHUTDOWN”；<br>各server监听的端口不能相同，因此，在同一物理主机启动多个实例时，需要个改其监听端口为不同的端口； </p>
<p>service：用于实现将一个或多个connector组件关联至一个engine组件；<br>Connector组件<br>负责接收请求，常见的有三类http/https/ajp:<br>进入tomcat的请求可分为两类； </p>
<h3 id="1-standalone-请求来自于客户端的反代理服务器："><a href="#1-standalone-请求来自于客户端的反代理服务器：" class="headerlink" title="(1)standalone:请求来自于客户端的反代理服务器："></a>(1)standalone:请求来自于客户端的反代理服务器：</h3><ul>
<li>nginx –&gt; http connector –&gt; tomcat </li>
<li>httpd(proxy_http_module) –&gt; http connector –&gt; tomcat </li>
<li>httpd(proxy_ajp_module) –&gt; ajp connecetor –&gt; tomcat </li>
</ul>
<p>属性：</p>
<ul>
<li>port=”8080”</li>
<li>protocol=”HTTP/1.1”</li>
<li>connectionTimeout=”20000”</li>
<li>address：监听的IP地址；默认为本机所有可用地址；</li>
<li>maxThreads：最大并发连接数，默认为150；</li>
<li>enableLookups：是否启用DNS查询功能；</li>
<li>acceptCount：等待队列的最大长度；</li>
<li>secure：</li>
<li>sslProtocol：</li>
</ul>
<p>Engine组件：Servlet实例，即servlet引擎，其内部可以一个或多个host组件来定义站点； 通常需要通过defaultHost来定义默认的虚拟主机；</p>
<p>属性：</p>
<ul>
<li>name=</li>
<li>defaultHost=”localhost”</li>
<li>jvmRoute=</li>
</ul>
<p>Host组件：位于engine内部用于接收请求并进行相应处理的主机或虚拟主机，示例：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;Host name=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;webapps&quot;</span></span><br><span class="line">unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;/Host&gt;</span><br></pre></td></tr></table></figure>
<h3 id="常用属性说明："><a href="#常用属性说明：" class="headerlink" title="常用属性说明："></a>常用属性说明：</h3><p>(1) appBase：此Host的webapps的默认存放目录，指存放非归档的web应用程序的目录或归档的WAR文件目录路径；可以使用基于$CATALINA_BASE变量所定义的路径的相对路径；</p>
<p>(2) autoDeploy：在Tomcat处于运行状态时，将某webapp放置于appBase所定义的目录中时，是否自动将其部署至tomcat；</p>
<p>示例：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;Host name=<span class="string">&quot;tc1.magedu.com&quot;</span> appBase=<span class="string">&quot;/appdata/webapps&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;/Host&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># mkdir -pv /appdata/webapps</span><br><span class="line"># mkdir -pv /appdata/webapps/ROOT/&#123;lib,classes,WEB-INF&#125;</span><br></pre></td></tr></table></figure>
<p>提供一个测试页即可；</p>
<h2 id="四、tomcat-cluster-升级为session-cluster，使用deltaManager"><a href="#四、tomcat-cluster-升级为session-cluster，使用deltaManager" class="headerlink" title="四、tomcat cluster 升级为session cluster，使用deltaManager"></a>四、tomcat cluster 升级为session cluster，使用deltaManager</h2><p>配置node1,和node2 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node1<span class="comment"># vim /etc/tomcat/server.xml </span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"> &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;localhost&quot;</span> jvmRoute=<span class="string">&quot;TomcatA&quot;</span>&gt;</span><br><span class="line">&lt;Cluster className=<span class="string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span></span><br><span class="line">channelSendOptions=<span class="string">&quot;8&quot;</span>&gt;</span><br><span class="line">&lt;Manager className=<span class="string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span></span><br><span class="line">expireSessionsOnShutdown=<span class="string">&quot;false&quot;</span></span><br><span class="line">notifyListenersOnReplication=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">&lt;Channel className=<span class="string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;</span><br><span class="line">&lt;Membership className=<span class="string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span></span><br><span class="line">address=<span class="string">&quot;228.0.32.4&quot;</span></span><br><span class="line">port=<span class="string">&quot;45564&quot;</span></span><br><span class="line">frequency=<span class="string">&quot;500&quot;</span></span><br><span class="line">dropTime=<span class="string">&quot;3000&quot;</span>/&gt;</span><br><span class="line">&lt;Receiver className=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span><br><span class="line">address=<span class="string">&quot;192.168.254.130&quot;</span></span><br><span class="line">port=<span class="string">&quot;4000&quot;</span></span><br><span class="line">autoBind=<span class="string">&quot;100&quot;</span></span><br><span class="line">selectorTimeout=<span class="string">&quot;5000&quot;</span></span><br><span class="line">maxThreads=<span class="string">&quot;6&quot;</span>/&gt;</span><br><span class="line">&lt;Sender className=<span class="string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;</span><br><span class="line">&lt;Transport className=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;</span><br><span class="line">&lt;/Sender&gt;</span><br><span class="line">&lt;Interceptor className=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;</span><br><span class="line">&lt;Interceptor className=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor&quot;</span>/&gt;</span><br><span class="line">&lt;/Channel&gt;</span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span></span><br><span class="line">filter=<span class="string">&quot;&quot;</span>/&gt;</span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;</span><br><span class="line">&lt;Deployer className=<span class="string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span></span><br><span class="line">tempDir=<span class="string">&quot;/tmp/war-temp/&quot;</span></span><br><span class="line">deployDir=<span class="string">&quot;/tmp/war-deploy/&quot;</span></span><br><span class="line">watchDir=<span class="string">&quot;/tmp/war-listen/&quot;</span></span><br><span class="line">watchEnabled=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">&lt;ClusterListener className=<span class="string">&quot;org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener&quot;</span>/&gt;</span><br><span class="line">&lt;ClusterListener className=<span class="string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>/&gt;</span><br><span class="line">&lt;/Cluster&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># scp /etc/tomcat/server.xml 172.16.251.74:/etc/tomcat/server.xml</span></span><br><span class="line"><span class="comment"># cp /etc/tomcat/web.xml /var/lib/tomcat/webapps/test/WEB-INF/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># vim /var/lib/tomcat/webapps/test/WEB-INF/web.xml</span><br><span class="line">在 &lt;!--                       listings is enabled? [<span class="keyword">true</span>]                    --&gt;的后面加入</span><br><span class="line">&lt;distributable/&gt;</span><br><span class="line"># scp /var/lib/tomcat/webapps/test/WEB-INF/web.xml 172.16.251.74:/var/lib/tomcat/webapps/test/WEB-INF/</span><br><span class="line">   node2# vim /etc/tomcat/server.xml </span><br><span class="line">更改  &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;localhost&quot;</span> jvmRoute=<span class="string">&quot;TomcatB&quot;</span>&gt;</span><br><span class="line">address=<span class="string">&quot;172.16.251.74&quot;</span></span><br><span class="line">node1,2 #systemctl restart tomcat</span><br></pre></td></tr></table></figure>
<p><code>进入页测试http://172.16.254.248/test/</code></p>
<p><img src="/images/tomcat_test7.png" class="lazyload" data-srcset="/images/tomcat_test7.png" srcset="data:image/png;base64,666" alt=""></p>
<p><img src="/images/tomcat_test8.png" class="lazyload" data-srcset="/images/tomcat_test8.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="五、cluster将会话保存至memcached中"><a href="#五、cluster将会话保存至memcached中" class="headerlink" title="五、cluster将会话保存至memcached中"></a>五、cluster将会话保存至memcached中</h2><p>node1,2需要的操作<br>将deltaManager的配置还原</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">  <span class="comment"># cd /usr/share/tomcat/lib/</span></span><br><span class="line">   <span class="comment"># wget ftp://172.16.0.1/pub/Sources/7.x86_64/msm/* &amp;&amp; rm -rf memcached-session-manager-tc8-1.8.3.jar</span></span><br><span class="line">   <span class="comment"># yum -y install memcached libmemcached </span></span><br><span class="line">   <span class="comment"># systemctl start memcached </span></span><br><span class="line">   <span class="comment"># sustemctl enable memcached</span></span><br><span class="line">node1(tomcat1,memcached1) </span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"> # memcached 1配置 </span><br><span class="line"># vim /etc/tomcat/server.xml</span><br><span class="line"># 修改 </span><br><span class="line">&lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;localhost&quot;</span> jvmRoute=<span class="string">&quot;rjTomcat1&quot;</span>&gt;</span><br><span class="line">在Host段中添加</span><br><span class="line">        &lt;Context path=<span class="string">&quot;/test&quot;</span> docBase=<span class="string">&quot;test&quot;</span> reloadable=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">memcachedNodes=<span class="string">&quot;n1:172.16.251.232:11211,n2:172.16.251.74:11211&quot;</span></span><br><span class="line">failoverNodes=<span class="string">&quot;n1&quot;</span></span><br><span class="line">requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&quot;</span></span><br><span class="line">/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br><span class="line">node2(tomcat,memcached2)</span><br><span class="line"> # memcached 2配置 </span><br><span class="line">&lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;localhost&quot;</span> jvmRoute=<span class="string">&quot;rjTomcat2&quot;</span>&gt;</span><br><span class="line"># 在Host段中添加</span><br><span class="line"> &lt;Context path=<span class="string">&quot;/test&quot;</span> docBase=<span class="string">&quot;test&quot;</span> reloadable=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">&lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">memcachedNodes=<span class="string">&quot;n1:172.16.251.232:11211,n2:172.16.251.74:11211&quot;</span></span><br><span class="line">failoverNodes=<span class="string">&quot;n1&quot;</span></span><br><span class="line">requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&quot;</span></span><br><span class="line">/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>
<p>关于tomcat memcached session绑定配置详解地址</p>
<p><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#configure-memcached-session-manager-as--context-manager">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#configure-memcached-session-manager-as--context-manager</a><br>此时cluster将会话保存于memcached 中 </p>
<p><code>访问http://172.16.254.248/test/效果如下</code></p>
<p><img src="/images/tomcat_test9.png" class="lazyload" data-srcset="/images/tomcat_test9.png" srcset="data:image/png;base64,666" alt=""><br><img src="/images/tomcat_test10.png" class="lazyload" data-srcset="/images/tomcat_test10.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="六、Tomcat的常用优化配置"><a href="#六、Tomcat的常用优化配置" class="headerlink" title="六、Tomcat的常用优化配置"></a>六、Tomcat的常用优化配置</h2><h3 id="（1）内存空间："><a href="#（1）内存空间：" class="headerlink" title="（1）内存空间："></a>（1）内存空间：</h3><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">#vim /etc/sysyconfig/tomcat </span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms -Xmx -XX:NewSize= -XX:MaxNewSize= -XX:PermSize= -XX:MaxPermSize=&quot;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>-server:服务器模型 </li>
<li>-Xms:堆内存初始化大小； </li>
<li>-Xmx:堆内存空间上限； </li>
<li>-XX:NewSize=:新生代空间初始化大小 ； </li>
<li>-XX:MaxNewSize=:新生代空间最大值 ； </li>
<li>-XX:PermSize=:持久代空间初始化大小； </li>
<li>-XX:MaxPermSize=:持久代空间最大值；  </li>
</ol>
<h3 id="（2）线程池设置："><a href="#（2）线程池设置：" class="headerlink" title="（2）线程池设置："></a>（2）线程池设置：</h3><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> connectionTimeout=<span class="string">&quot;200000&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>常用属性：</p>
<ol>
<li>maxThreads:最大线程数； </li>
<li>minSpareThreads:最小空闲线程数； </li>
<li>maxSpareThreads:最大空闲线程数； </li>
<li>acceptCount:等待队列的最大长度； </li>
<li>URIEnconding:URI地址编码格式，建议使用UTF-8； </li>
<li>enableLookups:是否启用dns解析，建议禁用； </li>
<li>compression:是否启用传输压缩机制，建议”on”;</li>
<li>compressionMinSize:启用压缩传输的数据流最小值，单位是字节；</li>
<li>compressableMimeType:定义启用压缩功能的MIME类型;<br>text/html,text/xml,text/css,text/javascript;</li>
</ol>
<h3 id="（3）禁用8005端口"><a href="#（3）禁用8005端口" class="headerlink" title="（3）禁用8005端口"></a>（3）禁用8005端口</h3><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;Server port=<span class="string">&quot;-1&quot;</span> shutdown=<span class="string">&quot;SHUTDOWN&quot;</span>&gt; </span><br><span class="line">Server=<span class="string">&quot;SOME STRING&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="（4）隐藏版本信息"><a href="#（4）隐藏版本信息" class="headerlink" title="（4）隐藏版本信息"></a>（4）隐藏版本信息</h3><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> connection Timeout=<span class="string">&quot;20000&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line">Server=<span class="string">&quot;SOME STRING&quot;</span> </span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>keepalived双主模型的实现</title>
    <url>/2018/02/07/keepalived%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><blockquote>
<p>keepalived 简介:是服务器高可用的一个重要软件;<br>它的核心组件有vrrp ，stack， checker ，ipvs，warpper， watch dog ;</p>
</blockquote>
<blockquote>
<p>它是vrrp协议的实现，原生设计目的为高可用ipvs服务；<br>keepalived能够通过配置文件中定义生成ipvs规则;</p>
</blockquote>
<blockquote>
<p>并能够对RS的健康状态进行检测；vrrp_script,vrrp_track; </p>
</blockquote>
<ul>
<li>双主模型的实现</li>
</ul>
<blockquote>
<p>简介:<br>双方模型(主/备，备/主)的这里的意思是，一个keepalived配置中;<br>一个虚拟IP地址为主，另一个为备。而在另一个keepalived的配置中;<br>与其它主机则恰恰相反，一个虚拟IP地址为备，另一个为主;</p>
</blockquote>
<p>以下为此次双主模型实现的拓扑<br><img src="/images/keepalived_rhca.jpg" class="lazyload" data-srcset="/images/keepalived_rhca.jpg" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="二、HA-Cluster配置的前提；"><a href="#二、HA-Cluster配置的前提；" class="headerlink" title="二、HA Cluster配置的前提；"></a>二、HA Cluster配置的前提；</h2><h3 id="1-要点-各节点之间的时间秘需要同步"><a href="#1-要点-各节点之间的时间秘需要同步" class="headerlink" title="(1)要点:各节点之间的时间秘需要同步:"></a>(1)要点:各节点之间的时间秘需要同步:</h3><blockquote>
<p>ntpdate 172.16.0.1 (注此:处可自己在网上找个时间同步服务器)</p>
</blockquote>
<h3 id="2-确保iptables及selinux不会阻碍"><a href="#2-确保iptables及selinux不会阻碍" class="headerlink" title="(2)确保iptables及selinux不会阻碍:"></a>(2)确保iptables及selinux不会阻碍:</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#iptables -F &amp;&amp; setenforce 0</span></span><br></pre></td></tr></table></figure>
<p>###(3)各节点之间可通过主机名互相通信(对keepalived并非必须):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/hosts </span></span><br><span class="line"></span><br><span class="line">172.16.250.140 kpl1</span><br><span class="line"></span><br><span class="line">172.16.250.158 kpl2 两台keepalived主机都要修改 </span><br></pre></td></tr></table></figure>
<p>###(4)各节点之间root用户可以基于密钥认证的ssh通信</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ssh-copy-id -i 172.16.250.140</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh-copy-id -i 172.16.250.158</span></span><br></pre></td></tr></table></figure>
<h2 id="三、dr集群配置"><a href="#三、dr集群配置" class="headerlink" title="三、dr集群配置"></a>三、dr集群配置</h2><p>此处使用dr集群类型</p>
<p>首先将dr模型配置好 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim setkp.sh</span></span><br><span class="line"><span class="comment"># !/bin/bash </span></span><br><span class="line">vip=172.16.26.126</span><br><span class="line">vip2=172.16.26.127</span><br><span class="line">mask=255.255.255.255</span><br><span class="line">interface=<span class="string">&#x27;lo:0&#x27;</span></span><br><span class="line">interface2=<span class="string">&#x27;lo:1&#x27;</span></span><br><span class="line">eth=<span class="string">&#x27;eno16777736:0&#x27;</span> </span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </span><br><span class="line">start) </span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">ifconfig <span class="variable">$interface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up </span><br><span class="line">ifconfig <span class="variable">$interface2</span> <span class="variable">$vip2</span> netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip2</span> up </span><br><span class="line">route add -host <span class="variable">$vip</span> dev <span class="variable">$interface</span> </span><br><span class="line">route add -host <span class="variable">$vip2</span> dev <span class="variable">$interface2</span></span><br><span class="line">;; </span><br><span class="line">dstart) </span><br><span class="line">ifconfig <span class="variable">$eth</span> <span class="variable">$vip</span>/32 netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up</span><br><span class="line">;;</span><br><span class="line">dstop)</span><br><span class="line">ifconfig <span class="variable">$eth</span> down</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">ifconfig <span class="variable">$interface</span> down </span><br><span class="line">ifconfig <span class="variable">$interface2</span> down</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">;; </span><br><span class="line">status) </span><br><span class="line">ifconfig </span><br><span class="line">cat /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">cat /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">cat /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">cat /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">;; </span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> &#123;dstart|dstop|start|stop&#125;&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1 </span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<p>RS1、RS2主机中都执行执行此脚本 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sh setkp.sh start </span></span><br><span class="line"><span class="comment"># sh setkp.sh status 可用来查看当前网络的配置状态 </span></span><br><span class="line"><span class="comment">#RS1、RS2主机中安装httpd并启动 </span></span><br><span class="line"><span class="comment"># yum -y install httpd &amp;&amp; systemctl start httpd  </span></span><br><span class="line">RS1<span class="comment"># echo &quot;&lt;h1&gt;RS1&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html </span></span><br><span class="line">RS2 <span class="comment"># echo &quot;&lt;h1&gt;RS2&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure>
<h2 id="四、keepalived配置"><a href="#四、keepalived配置" class="headerlink" title="四、keepalived配置"></a>四、keepalived配置</h2><p>keepalived,keepalived2 中安装nginx<br>(httpd和nginx都可以,此处用来做为keepalived的本身的提供sorry server)<br>当dr集群的两台节点都停止时，会由keepalived本身来提供一个页面</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install nginx keepalived ipvsadm &amp;&amp; systemctl start nginx </span></span><br><span class="line"><span class="comment"># echo &quot;&lt;h1&gt;sorry server keepalived 1 &lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html </span></span><br><span class="line"><span class="comment"># echo &quot;&lt;h1&gt;sorry server keepalived 2 &lt;/h2&gt;&quot; &gt; /usr/share/nginx/html/index.html </span></span><br><span class="line">```bash</span><br><span class="line"></span><br><span class="line">在一台keepalived主机上进行测试</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># curl 172.16.251.232</span></span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line"><span class="comment"># curl 172.16.250.159</span></span><br><span class="line">&lt;h1&gt;RS2&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<p>keepalived,keepalived2 中在 /etc/keepalived/目录下编辑一个脚本来用来在主备变化<br>或服务down掉时发邮件给系统用户 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim kmail.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">contact=<span class="string">&#x27;root@localhost&#x27;</span></span><br><span class="line"><span class="function"><span class="title">notify</span></span>()&#123;</span><br><span class="line">mailsubject=<span class="string">&quot;<span class="subst">$(hostname)</span> to be <span class="variable">$1</span>:vip floating&quot;</span></span><br><span class="line">mailbody=<span class="string">&quot;<span class="subst">$(date +&#x27;%F %T&#x27;)</span>:vrrp transition, <span class="subst">$(hostname)</span> change to be <span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$mailbody</span> | mail -s <span class="string">&quot;<span class="variable">$mailsubject</span>&quot;</span> <span class="variable">$contact</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </span><br><span class="line">master )</span><br><span class="line">notify master</span><br><span class="line">;;</span><br><span class="line">backup )</span><br><span class="line">notify backup </span><br><span class="line">;;</span><br><span class="line">fault )</span><br><span class="line">notify fault </span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Usage:<span class="subst">$(basename $0)</span> &#123;master |backup|fault&#125;&quot;</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="comment">#chmod +x kmail.sh </span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注:keepalived的两台主机的配置基本相同，当配置模型为主/备模型的时候，主备之间需要修改三个指令 </p>
</blockquote>
<p>分别为 router_id kpl1 在keepalived2上时需要修改为 router_id kpl2<br>state MASTER 在keepalived2上时需要修改为 state BACKUP<br>priority 100 在keepalived2上时需要修改为  priority 90 (此处的值比主服务器的小便可以)<br>以下主/备的配置示例</p>
<p><img src="/images/keepalived_master.jpg" class="lazyload" data-srcset="/images/keepalived_master.jpg" srcset="data:image/png;base64,666" alt=""><br><img src="/images/keepalived_slave.jpg" class="lazyload" data-srcset="/images/keepalived_slave.jpg" srcset="data:image/png;base64,666" alt=""></p>
<p>###先把备的服务器启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tcpdump -i eno33554984 -nn host 224.0.61.61</span></span><br></pre></td></tr></table></figure>
<p>可使用tcpdump 抓取组播地址 来查看其通过组播方式传递的心跳信息<br>以下的配置文件便是keepavlied双主模型的实现<br>对防火墙打标记<br>keepalived 1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.126 -p tcp --dport 80 -j MARK --set-mark 3 </span></span><br><span class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.127 -p tcp --dport 80 -j MARK --set-mark 3</span></span><br><span class="line"><span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived </span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">root@localhost</span><br><span class="line">&#125;</span><br><span class="line">  notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id kpl1</span><br><span class="line">  vrrp_mcast_group4 224.0.61.61</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state MASTER</span><br><span class="line">interface eno33554984</span><br><span class="line">virtual_router_id 55</span><br><span class="line">priority 100</span><br><span class="line">advert_int 1</span><br><span class="line">notify_master <span class="string">&quot;/etc/keepalived/kmail.sh master&quot;</span></span><br><span class="line">notify_backup <span class="string">&quot;/etc/keepalived/kmail.sh backup&quot;</span></span><br><span class="line">notify_fault  <span class="string">&quot;/etc/keepalived/kmail.sh fault&quot;</span></span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass zE2kNsRQ</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">172.16.26.126 dev eno33554984 label eno33554984:0    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">state BACKUP</span><br><span class="line">interface eno33554984</span><br><span class="line">virtual_router_id 66</span><br><span class="line">priority 90</span><br><span class="line">advert_int 1</span><br><span class="line">notify_master <span class="string">&quot;/etc/keepalived/kmail.sh master&quot;</span></span><br><span class="line">notify_backup <span class="string">&quot;/etc/keepalived/kmail.sh backup&quot;</span></span><br><span class="line">notify_fault  <span class="string">&quot;/etc/keepalived/kmail.sh fault&quot;</span></span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass zE2kfsRQ</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">172.16.26.127 dev eno33554984 label eno33554984:1    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server fwmark 3 &#123;</span><br><span class="line">delay_loop 2</span><br><span class="line">lb_algo wrr </span><br><span class="line">lb_kind DR</span><br><span class="line">nat_mask 255.255.0.0</span><br><span class="line">protocol TCP</span><br><span class="line">sorry_server 127.0.0.1 80</span><br><span class="line"> </span><br><span class="line">real_server 172.16.251.232 80 &#123;</span><br><span class="line">weight 3</span><br><span class="line">HTTP_GET &#123;</span><br><span class="line">url &#123; </span><br><span class="line"> path /</span><br><span class="line"> status_code 200  </span><br><span class="line"> &#125;</span><br><span class="line">connect_timeout 2</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">real_server 172.16.250.159 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">HTTP_GET &#123;</span><br><span class="line">url &#123; </span><br><span class="line">path /</span><br><span class="line">status_code 200  u</span><br><span class="line"> &#125;</span><br><span class="line">oconnect_timeout 2e</span><br><span class="line">nb_get_retry n</span><br><span class="line">delay_before_retry 3</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p> keepalived 2 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.126 -p tcp --dport 80 -j MARK --set-mark 3</span></span><br><span class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.127 -p tcp --dport 80 -j MARK --set-mark 3</span></span><br><span class="line"><span class="comment"># vim /etc/keepavlied/keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">  notification_email &#123;</span><br><span class="line">root@localhost</span><br><span class="line">&#125;</span><br><span class="line">  notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">  smtp_server 127.0.0.1</span><br><span class="line">  smtp_connect_timeout 30</span><br><span class="line">  router_id kpl2</span><br><span class="line">  vrrp_mcast_group4 224.0.61.61</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state BACKUP</span><br><span class="line">interface eno33554984</span><br><span class="line">virtual_router_id 55</span><br><span class="line">priority 90</span><br><span class="line">advert_int 1</span><br><span class="line">notify_master <span class="string">&quot;/etc/keepalived/kmail.sh master&quot;</span></span><br><span class="line">notify_backup <span class="string">&quot;/etc/keepalived/kmail.sh backup&quot;</span></span><br><span class="line">notify_fault  <span class="string">&quot;/etc/keepalived/kmail.sh fault&quot;</span></span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass zE2kNsRQ</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">172.16.26.126 dev eno33554984 label eno33554984:0    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">state MASTER</span><br><span class="line">interface eno33554984</span><br><span class="line">virtual_router_id 66</span><br><span class="line">priority 100</span><br><span class="line">advert_int 1</span><br><span class="line">notify_master <span class="string">&quot;/etc/keepalived/kmail.sh master&quot;</span></span><br><span class="line">notify_backup <span class="string">&quot;/etc/keepalived/kmail.sh backup&quot;</span></span><br><span class="line">notify_fault  <span class="string">&quot;/etc/keepalived/kmail.sh fault&quot;</span></span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass zE2kfsRQ</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">172.16.26.127 dev eno33554984 label eno33554984:1    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">virtual_server fwmark 3  &#123;</span><br><span class="line">delay_loop &#123;</span><br><span class="line">lb_algo wrr</span><br><span class="line">lb_kind DR</span><br><span class="line">nat_mask 255.255.0.0</span><br><span class="line">protocol TCP</span><br><span class="line">sorry_server 127.0.0.1 80</span><br><span class="line">real_server 172.16.251.232 80 &#123;</span><br><span class="line">weight 3</span><br><span class="line">HTTP_GET &#123;</span><br><span class="line">url &#123;</span><br><span class="line"> path /</span><br><span class="line"> status_code 200</span><br><span class="line"> &#125;</span><br><span class="line">connect_timeout 2</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">real_server 172.16.250.159 80 &#123;</span><br><span class="line">weight 1</span><br><span class="line">HTTP_GET &#123;</span><br><span class="line">url &#123;</span><br><span class="line"> path /</span><br><span class="line"> status_code 200</span><br><span class="line"> &#125;</span><br><span class="line">connect_timeout 2</span><br><span class="line">nb_get_retry 3</span><br><span class="line">delay_before_retry 3</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h2><p>此时可以测试其访问</p>
<p><img src="/images/keepalived_test1.jpg" class="lazyload" data-srcset="/images/keepalived_test1.jpg" srcset="data:image/png;base64,666" alt=""><br>当一个keepavlied停止时<br><img src="/images/keepalived_test2.jpg" class="lazyload" data-srcset="/images/keepalived_test2.jpg" srcset="data:image/png;base64,666" alt=""><br>当RS2停止时<br><img src="/images/keepalived_test3.jpg" class="lazyload" data-srcset="/images/keepalived_test3.jpg" srcset="data:image/png;base64,666" alt=""><br>当RS1，RS2都停止时<br><img src="/images/keepalived_test4.jpg" class="lazyload" data-srcset="/images/keepalived_test4.jpg" srcset="data:image/png;base64,666" alt=""></p>
<p>##六、keepavlied配置指令说明 </p>
<p>虚拟路由器段</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">state MASTER：当前节点在虚拟路由器中的初始状态；</span><br><span class="line">interface ETHERCARD: vrrp实际工作的网卡接口</span><br><span class="line">virtual_route_id 51 :虚拟路由器ID，范围0-255；</span><br><span class="line">priority 100 :当前物理节点在此虚拟路由器中的优先级；</span><br><span class="line">advert_int 1:每隔多久发送心跳(通行的时间间隔)</span><br><span class="line">auth_type PASS ：选择认证机制 </span><br><span class="line">auth_pass 1111 ：密码 八位有效</span><br><span class="line">virtual_ipaddress ：定义虚拟IP </span><br><span class="line">track_interface ： 定义要监控的接口</span><br><span class="line">notify_master &lt;STRING&gt; | &lt;QUOTED-STRING&gt; ：当前节点变为主节点时用STRING脚本通告</span><br><span class="line">notfy_backup&lt;STRING&gt; | &lt;QUOTED-STRING&gt; : 当前节点变为主节时用 STRING脚本通告</span><br><span class="line">notify_fault&lt;STRING&gt; | &lt;QUOTED-STRING&gt; : 当前节点上不了线时用STRING脚本通告</span><br><span class="line">notify&lt;STRING&gt; | &lt;QUOTED-STRING&gt; : 如果三种状态用一个脚本来实现用STRING脚本通告 </span><br></pre></td></tr></table></figure>
<p>虚拟服务段</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lb_algo rr | wrr|lc|lblc|sh|dh :定义负载均衡调度算法</span><br><span class="line">delay_loop&lt;INT&gt;：：定义服务轮询时间间隔</span><br><span class="line">bl_kind NAT |DR |TUN ：集群的类型</span><br><span class="line">persistence_time_out&lt;INT&gt; ：持久连接时长</span><br><span class="line">protocol TCP : 服务协议</span><br><span class="line">sorry_server&lt;IPADDR&gt;&lt;PORT&gt;：所有RS均故障时，提供sorry server的服务器；</span><br><span class="line">real_server&lt;IPADDR&gt;&lt;PORT&gt;:</span><br><span class="line">weight&lt;INT&gt;：权重</span><br><span class="line">notify_up&lt;STRING&gt;|&lt;QUOTED-STRING&gt; ： 节点上线通知脚本</span><br><span class="line">notify_down &lt;STRING&gt;|&lt;QUOTED-STRNG&gt;：节点离线通知脚本；</span><br><span class="line"><span class="comment">#HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK ：支持的所以健康状态的检测方式</span></span><br><span class="line">url:健康状态检测时请求的资源的URL </span><br><span class="line">delay_before_retry&lt;INT&gt; ：两次尝试之间的时间间隔 </span><br><span class="line">connect_timeoute&lt;STRING&gt;：连接的超时时长</span><br><span class="line">connect_ip&lt;IP ADDRESS&gt;：向此处指定的地址发测试请求</span><br><span class="line">connect_port&lt;PORT&gt;：向此处指定的PORT发测试请求</span><br><span class="line">bindto&lt;IP ADDRESS&gt;：指定测试请求报文的源IP </span><br><span class="line">bind_port&lt;PORT&gt;： 指定测试请求报文的源PORT</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>MariaDB之MHA配置</title>
    <url>/2018/02/06/MariaDB%E4%B9%8BMHA%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="工作拓扑"><a href="#工作拓扑" class="headerlink" title="工作拓扑"></a>工作拓扑</h2><p><img src="/images/mariadb_mha.png" class="lazyload" data-srcset="/images/mariadb_mha.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="一、MHA简明"><a href="#一、MHA简明" class="headerlink" title="一、MHA简明"></a>一、MHA简明</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MHA（Master HA）是一款开源的MySQL的高可用程序，它为MySQL主从复制架构提供了</span><br><span class="line">    automating master failover 功能。MHA在监控到master节点故障时，会提升其中</span><br><span class="line">    拥有最新数据的slave节点来成为新的master节点。在此期间，MHA会通过于其它从节点</span><br><span class="line">    获取额外信息来避免一致性方面的问题。MHA还提供了master节点的在线切换功能，即按</span><br><span class="line">    需切换master&#x2F;slave节点。</span><br><span class="line">MHA服务有两咱角色。MHA Mangager(管理节点)和MHA Node(数据节点)：</span><br><span class="line">    MHA Manager：通常单独部署在一台独立机器上管理多个master&#x2F;slave集群，每个</span><br><span class="line">    master&#x2F;slave集群称作一个application:</span><br><span class="line">    MHA node:运行在每台MySQL服务器之上(master&#x2F;slave&#x2F;manager),它通过监控</span><br><span class="line">    具务解析和清理logs功能来脚本来加快故障转移。       </span><br></pre></td></tr></table></figure>
<h2 id="二、MHA-组件"><a href="#二、MHA-组件" class="headerlink" title="二、MHA 组件"></a>二、MHA 组件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    MHA会提供诸多工具程序，其常见的如下所示。 </span><br><span class="line">    Manager节点:</span><br><span class="line">       masterha_check_ssh:MHA依赖的SSH环境检测工具；</span><br><span class="line">        masterha_check_repl:MySQL复制环境检测工具；</span><br><span class="line">        masterha_mamager:MHA服务主程序；</span><br><span class="line">        masterha_check_status:MHA运行状态探测工具；</span><br><span class="line">        masterha_master_monitor:MySQL master节点可用性监测工具；</span><br><span class="line">        masterha_master_swith:master节点切换工具；</span><br><span class="line">        masterha_conf_host:添加或删除配置的节点；</span><br><span class="line">        masterha_stop:斗闭MHA服务的工具 ；</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    Node 节点:</span><br><span class="line">        save_binary_logs:保存和复制Master的二进制日志 ；</span><br><span class="line">        apply_diff_replay_logs:识别差异的中继日志事件并应用于其它slave;</span><br><span class="line">        filter_mysqlbinlog:去除不必要的ROLLBACK事件(MHA已不再使用这个工具)；</span><br><span class="line">        purge_replay_logs:清除中继日志(不会阻塞SQL线程)；</span><br><span class="line">        </span><br><span class="line">    自定义扩展:</span><br><span class="line">        secondary_check_script:通过多条网络路由检测master的可用性；</span><br><span class="line">        master_ip_failover_scipt:更新application使用的masterip;</span><br><span class="line">        shutdown_script：强制关闭master节点；</span><br><span class="line">        report_scipt:发送报告；</span><br><span class="line">        init_conf_load_script:加载初始配置参数；</span><br><span class="line">        master_ip_online_change_scipt:更新master节点ip地址；</span><br></pre></td></tr></table></figure>
<h2 id="三、准备MySQL-Replicatin环境"><a href="#三、准备MySQL-Replicatin环境" class="headerlink" title="三、准备MySQL Replicatin环境"></a>三、准备MySQL Replicatin环境</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    MHA对MySQL复制环境有特殊要求，例如各节点都要开启二进制日志及中继日志，</span><br><span class="line">    各从节点 必须启用其read-only skip_name_resolve innodb_file_per_table&#x3D;ON 属性，</span><br><span class="line">    并关闭relay_log_purge功能等，还有体集事物所必需的同步；</span><br></pre></td></tr></table></figure>
<h3 id="同步主机"><a href="#同步主机" class="headerlink" title="同步主机"></a>同步主机</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;0..3&#125; ; do ssh node$i ntpdate 172.16.0.1 ; done</span></span><br><span class="line">    <span class="comment"># 本实验境共有四个节点，其中角色分配如下；</span></span><br><span class="line">node0 :MHA Manager(172.16.23.10);</span><br><span class="line">node1 :MariaDB master</span><br><span class="line">node2 :MariaDB slave</span><br><span class="line">node3 :MariaDB slave</span><br><span class="line">   <span class="comment"># 各节点的/etc/hosts文件配置内容添加如下内容；</span></span><br><span class="line">172.16.23.10 node0 node0.rj.com</span><br><span class="line">172.16.23.11 node1 node1.rj.com</span><br><span class="line">172.16.23.12 node2 node2.rj.com</span><br><span class="line">172.16.23.13 node3 node3.rj.com</span><br></pre></td></tr></table></figure>
<h3 id="初始主节点的master配置"><a href="#初始主节点的master配置" class="headerlink" title="初始主节点的master配置"></a>初始主节点的master配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node1 # vim &#x2F;etc&#x2F;my.cnf</span><br><span class="line">        innodb_file_per_table&#x3D;ON # 此项内容与下面一项内容一般在服务器启动时便加上</span><br><span class="line">        skip_name_resolve&#x3D;ON</span><br><span class="line">        server_id&#x3D;1</span><br><span class="line">        relay_log&#x3D;relay-bin</span><br><span class="line">        log-bin&#x3D;log-bin</span><br><span class="line">        symbolic-links&#x3D;0</span><br></pre></td></tr></table></figure>
<h3 id="所有slave节点依赖的配置"><a href="#所有slave节点依赖的配置" class="headerlink" title="所有slave节点依赖的配置"></a>所有slave节点依赖的配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node(2,3)# vim &#x2F;etc&#x2F;my.cnf    </span><br><span class="line">    innodb_file_per_table&#x3D;ON</span><br><span class="line">    skip_name_resolve&#x3D;ON</span><br><span class="line">    server_id&#x3D;2 #注 此处的结点到了别的节点中一定要改，各节点的id必需唯一；</span><br><span class="line">    relay-log&#x3D;relay-bin</span><br><span class="line">    log-bin&#x3D;master-bin</span><br><span class="line">    relay-log-purge&#x3D;OFF</span><br><span class="line">    read-only&#x3D;ON</span><br></pre></td></tr></table></figure>
<pre><code>按上述要求分别配置好主
从节点之后,按MySQL复制配置架构的配置方式将其配置完成并吂动
master节点和各slave节点，以及各slave节点启动其IO和SQL线程，确保主从复制运行无误
</code></pre><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">node1     mysql&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO &#x27;rj&#x27;@&#x27;172.16.%.%&#x27; IDENTIFIED BY &#x27;centos.123&#x27; ;</span><br><span class="line">node(2,3) mysql&gt; CHANGE MASTER TO MASTER_HOST=&#x27;172.16.23.11&#x27;,MASTER_USER=&#x27;rj&#x27;,MASTER_PASSWORD=&#x27;centos.123&#x27;,MASTER_LOG_FILE=&#x27;log-bin.000001&#x27;,MASTER_LOG_POS=492;</span><br><span class="line">          mysql&gt; START SLAVE;</span><br><span class="line">          mysql&gt; SHOW SLAVE STATUS;</span><br><span class="line">              Slave_IO_Running: Yes</span><br><span class="line">              Slave_SQL_Running: Yes</span><br><span class="line">              <span class="comment"># 以下两项是否为yes </span></span><br></pre></td></tr></table></figure>
<pre><code>同时，也可以在主结点上创建个库或表，查看其是否可台实现主从同步； 
而后，在所有MySQL节点授权拥有管理权限的用户可在本地网络中有其它节点上远程方问。
当然，此时仅需要且只能在master节点运行类似如下SQL语句即可。
</code></pre><figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt;  GRANT ALL ON *.* to &#x27;rjyy&#x27;@&#x27;172.16.%.%&#x27; IDENTIFIED BY &#x27;centos.123&#x27;;</span><br></pre></td></tr></table></figure>
<h2 id="三、安装配置MHA"><a href="#三、安装配置MHA" class="headerlink" title="三、安装配置MHA"></a>三、安装配置MHA</h2><h3 id="准备基于ssh互信通信环境"><a href="#准备基于ssh互信通信环境" class="headerlink" title="准备基于ssh互信通信环境"></a>准备基于ssh互信通信环境</h3><pre><code>MHA集群中的各节点彼此之间均需基于ssh互信通信，以实现远程控制及数据管理功能。
简单起见，可在Manager节点生成密钥对，并设置其可远程连接本地主机后，将私钥文件及authorized_keys文件复制给余下的所有结点即可。
下面的的操作在manager（node0）节点操作完成。
</code></pre><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;0..3&#125; ; do scp -p .ssh/id_rsa .ssh/authorized_keys node$i:/root/.ssh/; done</span></span><br></pre></td></tr></table></figure>
<h3 id="安装MHA"><a href="#安装MHA" class="headerlink" title="安装MHA"></a>安装MHA</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node0 <span class="comment"># yum install  mha4mysql-manager-0.56-0.el6.noarch.rpm mha4mysql-node-0.56-0.el6.noarch.rpm</span></span><br><span class="line">      <span class="comment">#  for i in &#123;1..3&#125;; do scp mha4mysql-node-0.56-0.el6.noarch.rpm node$i:/root/ ; done</span></span><br><span class="line">node(1,2,3) <span class="comment"># yum -y install  mha4mysql-node-0.56-0.el6.noarch.rpm    </span></span><br><span class="line">    [root@node0 ~]<span class="comment"># rpm -ql mha4mysql-manager</span></span><br><span class="line">    /usr/bin/masterha_check_repl</span><br><span class="line">    /usr/bin/masterha_check_ssh</span><br><span class="line">    /usr/bin/masterha_check_status</span><br><span class="line">    /usr/bin/masterha_conf_host</span><br><span class="line">    /usr/bin/masterha_manager</span><br><span class="line">    /usr/bin/masterha_master_monitor</span><br><span class="line">    /usr/bin/masterha_master_switch</span><br><span class="line">    /usr/bin/masterha_secondary_check</span><br><span class="line">    /usr/bin/masterha_stop                以上为可执行文件，就是上面所列出的命令</span><br><span class="line">    /usr/share/man/man1/masterha_check_repl.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_check_ssh.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_check_status.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_conf_host.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_manager.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_master_monitor.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_master_switch.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_secondary_check.1.gz</span><br><span class="line">    /usr/share/man/man1/masterha_stop.1.gz</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/Config.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/DBHelper.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/FileStatus.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerAdmin.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerAdminWrapper.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerConst.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/MasterFailover.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/MasterRotate.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/SSHCheck.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/Server.pm</span><br><span class="line">    /usr/share/perl5/vendor_perl/MHA/ServerManager.pm</span><br></pre></td></tr></table></figure>
<pre><code>Manager节点需要为每个监控的master/slave集群提供一个专用的配置文件，而所有的master/salve集群也可共享全局
配置。全局配置文件默认为/etc/masterha_default.cnf,其为可先配置。如果仅监控一组 master/slave集群，也可
直接通过application的配置提供各服务器的默认配置信息。而每个application的配置文件路径为自定义，本示例将使用
/etc/masterha/appl.cnf  
</code></pre><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/masterha/appl.cnf</span></span><br><span class="line">  [server default]</span><br><span class="line">  user=rjrj</span><br><span class="line">  password=centos.123</span><br><span class="line">  manager_workdir=/data/masterha/app1</span><br><span class="line">  manager_log=/data/masterha/app1/manager.log</span><br><span class="line">  remote_workdir=/data/masterha/app1</span><br><span class="line">  ssh_user=root</span><br><span class="line">  repl_user=rjrj</span><br><span class="line">  repl_password=centos.123</span><br><span class="line">  ping_interval=1</span><br><span class="line"></span><br><span class="line">  [server1]</span><br><span class="line">  hostname=172.16.23.11</span><br><span class="line">  candidate_master=1</span><br><span class="line"></span><br><span class="line">  [server2]</span><br><span class="line">  hostname=172.16.23.12</span><br><span class="line">  candidate_master=1</span><br><span class="line"></span><br><span class="line">  [server3]</span><br><span class="line">  hostname=172.16.23.13    </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 ~]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Tue Feb 21 23:13:48 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [info] Starting SSH connection tests..</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [debug]  Connecting via SSH from root@172.16.23.11(172.16.23.11:22) to root@172.16.23.12(172.16.23.12:22)..</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [debug]   ok.</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [debug]  Connecting via SSH from root@172.16.23.11(172.16.23.11:22) to root@172.16.23.13(172.16.23.13:22)..</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [debug]   ok.</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]</span><br><span class="line">Tue Feb 21 23:13:48 2017 - [debug]  Connecting via SSH from root@172.16.23.12(172.16.23.12:22) to root@172.16.23.11(172.16.23.11:22)..</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]   ok.</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]  Connecting via SSH from root@172.16.23.12(172.16.23.12:22) to root@172.16.23.13(172.16.23.13:22)..</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]   ok.</span><br><span class="line">Tue Feb 21 23:13:50 2017 - [debug]</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]  Connecting via SSH from root@172.16.23.13(172.16.23.13:22) to root@172.16.23.11(172.16.23.11:22)..</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]   ok.</span><br><span class="line">Tue Feb 21 23:13:49 2017 - [debug]  Connecting via SSH from root@172.16.23.13(172.16.23.13:22) to root@172.16.23.12(172.16.23.12:22)..</span><br><span class="line">Tue Feb 21 23:13:50 2017 - [debug]   ok.</span><br><span class="line">Tue Feb 21 23:13:50 2017 - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>
<p> 最后显示为successfully表示已经成功了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node0 ~]<span class="comment"># masterha_check_repl --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Wed Feb 22 10:18:40 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Feb 22 10:18:40 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Feb 22 10:18:40 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Feb 22 10:18:40 2017 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] GTID failover mode = 0</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Dead Servers:</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Alive Servers:</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.11(172.16.23.11:3306)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.12(172.16.23.12:3306)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.13(172.16.23.13:3306)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Alive Slaves:</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.12(172.16.23.12:3306)  Version=5.5.44-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]     Replicating from 172.16.23.11(172.16.23.11:3306)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.13(172.16.23.13:3306)  Version=5.5.44-MariaDB-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]     Replicating from 172.16.23.11(172.16.23.11:3306)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Current Alive Master: 172.16.23.11(172.16.23.11:3306)</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Checking slave configurations..</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]  binlog_do_db= , binlog_ignore_db=</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Feb 22 10:18:41 2017 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Feb 22 10:18:43 2017 - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Feb 22 10:18:43 2017 - [info] Checking MHA Node version..</span><br><span class="line">Wed Feb 22 10:18:48 2017 - [info]  Version check ok.</span><br><span class="line">Wed Feb 22 10:18:48 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Feb 22 10:18:48 2017 - [info] HealthCheck: SSH to 172.16.23.11 is reachable.</span><br><span class="line">Wed Feb 22 10:18:49 2017 - [info] Master MHA Node version is 0.56.</span><br><span class="line">Wed Feb 22 10:18:49 2017 - [info] Checking recovery script configurations on 172.16.23.11(172.16.23.11:3306)..</span><br><span class="line">Wed Feb 22 10:18:49 2017 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/var/lib/mysql,/var/<span class="built_in">log</span>/mysql --output_file=/data/masterha/app1/save_binary_logs_test --manager_version=0.56 --start_file=log-bin.000003</span><br><span class="line">Wed Feb 22 10:18:49 2017 - [info]   Connecting to root@172.16.23.11(172.16.23.11:22)..</span><br><span class="line">  Creating /data/masterha/app1 <span class="keyword">if</span> not exists.. Creating directory /data/masterha/app1.. <span class="keyword">done</span>.</span><br><span class="line">   ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to log-bin.000003</span><br><span class="line">Wed Feb 22 10:18:50 2017 - [info] Binlog setting check <span class="keyword">done</span>.</span><br><span class="line">Wed Feb 22 10:18:50 2017 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Feb 22 10:18:50 2017 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">&#x27;rjyy&#x27;</span> --slave_host=172.16.23.12 --slave_ip=172.16.23.12 --slave_port=3306 --workdir=/data/masterha/app1 --target_version=5.5.44-MariaDB-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Feb 22 10:18:50 2017 - [info]   Connecting to root@172.16.23.12(172.16.23.12:22)..</span><br><span class="line">Creating directory /data/masterha/app1.. <span class="keyword">done</span>.</span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to relay-bin.000009</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/relay-bin.000009</span><br><span class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Wed Feb 22 10:18:51 2017 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">&#x27;rjyy&#x27;</span> --slave_host=172.16.23.13 --slave_ip=172.16.23.13 --slave_port=3306 --workdir=/data/masterha/app1 --target_version=5.5.44-MariaDB-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Feb 22 10:18:51 2017 - [info]   Connecting to root@172.16.23.13(172.16.23.13:22)..</span><br><span class="line">Creating directory /data/masterha/app1.. <span class="keyword">done</span>.</span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to relay-bin.000007</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/relay-bin.000007</span><br><span class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info] Slaves settings check <span class="keyword">done</span>.</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info]</span><br><span class="line">172.16.23.11(172.16.23.11:3306) (current master)</span><br><span class="line"> +--172.16.23.12(172.16.23.12:3306)</span><br><span class="line"> +--172.16.23.13(172.16.23.13:3306)</span><br><span class="line"></span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info] Checking replication health on 172.16.23.12..</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info]  ok.</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info] Checking replication health on 172.16.23.13..</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info]  ok.</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [warning] master_ip_failover_script is not defined.</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Feb 22 10:18:52 2017 - [info] Got <span class="built_in">exit</span> code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure>
<pre><code>检查管理的MySQL复制集群的连接配置参数是正常的；
</code></pre><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &gt; /data/master/app1/manager.log 2&gt;&amp;1 &amp; </span></span><br><span class="line">   <span class="comment"># 让masterha_manager进程工作于后台</span></span><br></pre></td></tr></table></figure>
<h2 id="四、开始测试"><a href="#四、开始测试" class="headerlink" title="四、开始测试"></a>四、开始测试</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># systemctl stop mariadb # 让主服务器停掉；</span></span><br><span class="line">[root@node2 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 50</span><br><span class="line">Server version: 5.5.44-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| master-bin.000005 |      245 |              |                  |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure>
<p>  此时node2被提升为主服务器 ,node3拉取数据走向node2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[11:12:41root@node3~]<span class="comment">#mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 33</span><br><span class="line">Server version: 5.5.44-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.23.12</span><br><span class="line">                  Master_User: rj</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-bin.000008</span><br><span class="line">          Read_Master_Log_Pos: 245</span><br><span class="line">               Relay_Log_File: relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 530</span><br><span class="line">        Relay_Master_Log_File: master-bin.000008</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 245</span><br><span class="line">              Relay_Log_Space: 818</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 7 ELK(Elasticsearch Logstash Kibana) 搭建</title>
    <url>/2018/01/30/CentOS-7-ELK-Elasticsearch-Logstash-Kibana-%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="CentOS-7-ELK-Elasticsearch-Logstash-Kibana-搭建"><a href="#CentOS-7-ELK-Elasticsearch-Logstash-Kibana-搭建" class="headerlink" title="CentOS 7 ELK(Elasticsearch Logstash Kibana) 搭建"></a>CentOS 7 ELK(Elasticsearch Logstash Kibana) 搭建</h1><blockquote>
<p>不管是用于记录，监控或者程序的Debug，日志，对于任何系统来说都是一个及其重要的部分;<br>但一般日志的数据量会比较大，并且分散在各个地方。如果管理的服务器或者程序比较少的情况;<br>我们还可以逐一登录到各个服务器去查看，分析。但如果服务器或者程序的数量比较多了;<br>之后这种方法就显得力不从心。基于此，一些集中式的日志系统也就应用而生;<br>目前比较有名成熟的有，Sentry、Splunk(商业)、FaceBook 的Scribe、Apache 的 Chukwa;<br>Cloudera 的 Fluentd、还有ELK 等等;  </p>
</blockquote>
<h1 id="Sentry-与-ELK的对比"><a href="#Sentry-与-ELK的对比" class="headerlink" title="Sentry 与 ELK的对比"></a>Sentry 与 ELK的对比</h1><p>1、 sentry  </p>
<blockquote>
<p>sentry 是由python开发且开源的日志存储工具，占用内存较小，执行速度较慢，适合少量日志存储;<br>php python等程序可以直接调用sentry url 将日志写入，不支持sentry主动去额外的收集日志;<br>不支持分布式与横向扩展;<br>只能查找错误日志，不支持全局搜索;<br>一般运行在docker中，部署方便。出现问题排查费劲;<br>最底配置1核1G;</p>
</blockquote>
<p>2、 ELK </p>
<blockquote>
<p>ELK即(Elasticsearch[搜索引擎]，Logstash[日志收集]，Kibana [客户端接入的web平台]);<br>ELK 是由JAVA开发且开源的日志存储套件，占用内存较大，执行速度较快，适合大量志日志高并发存储;<br>支持分存式与横向扩展;<br>支持全局搜索，支持正则表达式搜索，支持图形统计, 支持日志json、表格形式;<br>一般运行在系统层面，部署费劲。出现问题易于拆分，排查;<br>最底配置2核4G;</p>
</blockquote>
<p><img src="/images/elk.png" class="lazyload" data-srcset="/images/elk.png" srcset="data:image/png;base64,666" alt=""></p>
<h1 id="此次部署过程"><a href="#此次部署过程" class="headerlink" title="此次部署过程"></a>此次部署过程</h1><ul>
<li>注: 二进制包Elasticsearch 不能用root用户启动服务 </li>
</ul>
<h2 id="JDK-8-的安装与配置"><a href="#JDK-8-的安装与配置" class="headerlink" title="JDK 8 的安装与配置"></a>JDK 8 的安装与配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># useradd  elasticsearch</span></span><br><span class="line"><span class="comment"># passwd elasticsearch</span></span><br><span class="line"><span class="comment"># vim /etc/profile #在最后加入以下内容 </span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/share/logstash/bin/:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># source /etc/profile </span></span><br><span class="line"><span class="comment"># yum -y install yum -y install java</span></span><br><span class="line">[root@iz8vbap8o8nj8n6yoc05n6z logstash-5.3.0]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_161&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_161-b14)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.161-b14, mixed mode)</span><br><span class="line">[root@iz8vbap8o8nj8n6yoc05n6z logstash-5.3.0]<span class="comment"># echo $JAVA_HOME </span></span><br><span class="line">/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64</span><br></pre></td></tr></table></figure>
<h2 id="ElasticSearch-安装与配置"><a href="#ElasticSearch-安装与配置" class="headerlink" title="ElasticSearch 安装与配置"></a>ElasticSearch 安装与配置</h2><p>1、安装 ElasticSearch</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.3.0.zip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># unzip elasticsearch-5.3.0.zip</span></span><br><span class="line"><span class="comment"># mv elasticsearch-5.3.0 /usr/local/</span></span><br><span class="line"><span class="comment"># chown elasticsearch.elasticsearch /usr/local/elasticsearch-5.3.0/ -R</span></span><br><span class="line"><span class="comment"># vim /usr/local/elasticsearch-5.3.0/config/elasticsearch.yml #启用变更以下配置</span></span><br><span class="line"></span><br><span class="line">cluster.name: transfereasy-elk</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">path.data: /data/elasticData</span><br><span class="line"></span><br><span class="line">path.logs: /data/logs</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></table></figure>
<p>2、安装x-pack插件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /usr/local/elasticsearch-5.3.0/bin/elasticsearch-plugin  install x-pack</span></span><br></pre></td></tr></table></figure>
<p>3、启动 ElasticSearch </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su - elasticsearch </span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/elasticsearch-5.3.0/bin/elasticsearch -d</span><br><span class="line">$ <span class="built_in">exit</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务启动验证</span></span><br><span class="line"><span class="comment"># netstat -tnlup | egrep &quot;9200|9300&quot;</span></span><br><span class="line">tcp        0      0 0.0.0.0:9200            0.0.0.0:*               LISTEN      14459/java          </span><br><span class="line">tcp        0      0 0.0.0.0:9300            0.0.0.0:*               LISTEN      14459/java  </span><br></pre></td></tr></table></figure>
<p>4、api 验证 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://localhost:9200 -u elastic</span></span><br><span class="line"><span class="comment"># 默认用户 elastic 默认密码:changeme</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;RXHIrkw&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;ssjinyao-elk&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;xxxxxxxxxxxxxxxxxx&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;5.3.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;3adb13b&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2017-03-23T03:31:50.652Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;6.4.1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、添加开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/elasticsearch-5.3.0/bin/elasticsearch -d&quot;</span> &gt; /etc/rc.local</span><br></pre></td></tr></table></figure>
<p>6、问题解决</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">a、can not run elasticsearch as root <span class="comment"># 需新建启动ElasticSearch的用户</span></span><br><span class="line">b、max file descriptors [65535] <span class="keyword">for</span> elasticsearch process is too low, increase to at least [65536]</span><br><span class="line"><span class="comment"># vim /etc/sercurity/limits.conf</span></span><br><span class="line">* soft nofile 655350</span><br><span class="line">* hard nofile 655350</span><br><span class="line">$ su - elasticsearch <span class="comment"># 再次合对是否可以打开655350个文件 </span></span><br><span class="line">c、max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144] </span><br><span class="line"><span class="comment"># vim /etc/sysctl.conf 添加以下内容</span></span><br><span class="line">vm.max_map_count=655300</span><br><span class="line"><span class="comment"># sysctl -p </span></span><br></pre></td></tr></table></figure>
<h2 id="Kibana的安装与配置"><a href="#Kibana的安装与配置" class="headerlink" title="Kibana的安装与配置"></a>Kibana的安装与配置</h2><p>1、 安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-5.3.0-linux-x86_64.tar.gz </span></span><br><span class="line"><span class="comment"># tar -zxf kibana-5.3.0-linux-x86_64.tar.gz</span></span><br><span class="line"><span class="comment"># mv kibana-5.3.0-linux-x86_64 /usr/local/</span></span><br><span class="line"><span class="comment"># chown elasticsearch.elasticsearch /usr/local/kibana-5.3.0-linux-x86_64/ -R</span></span><br><span class="line"><span class="comment"># cd /usr/local/kibana-5.3.0-linux-x86_64/</span></span><br><span class="line"><span class="comment"># bin/kibana-plugin  install x-pack</span></span><br></pre></td></tr></table></figure>
<p>2、 配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/local/kibana-5.3.0-linux-x86_64/config/kibana.yml  # 变更以下配置</span></span><br><span class="line">elasticsearch.url: <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># su - elasticsearch</span></span><br><span class="line">$ nohup /usr/<span class="built_in">local</span>/kibana-5.3.0-linux-x86_64/bin/kibana &amp;</span><br><span class="line"><span class="comment"># exit </span></span><br><span class="line"><span class="comment"># netstat  -tnlup | grep 5601</span></span><br><span class="line">tcp        0      0 127.0.0.1:5601          0.0.0.0:*               LISTEN      14132/node </span><br></pre></td></tr></table></figure>
<h2 id="Nginx-的安装与配置"><a href="#Nginx-的安装与配置" class="headerlink" title="Nginx 的安装与配置"></a>Nginx 的安装与配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install nginx -y </span></span><br><span class="line"><span class="comment"># nginx -t </span></span><br><span class="line"><span class="comment"># vim /etc/nginx/conf.d/kibana.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    listen       [::]:80 default_server;</span><br><span class="line">    server_name _;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:5601;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        proxy_set_header Connection <span class="string">&#x27;upgrade&#x27;</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_cache_bypass <span class="variable">$http_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># vim /etc/nginx/nginx.conf  注释默认虚拟主机</span></span><br><span class="line"><span class="comment">#    server &#123;</span></span><br><span class="line"><span class="comment">#        listen       80 default_server;</span></span><br><span class="line"><span class="comment">#        listen       [::]:80 default_server;</span></span><br><span class="line"><span class="comment">#        server_name  _;</span></span><br><span class="line"><span class="comment">#        root         /usr/share/nginx/html;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        # Load configuration files for the default server block.</span></span><br><span class="line"><span class="comment">#        include /etc/nginx/default.d/*.conf;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        location / &#123;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        error_page 404 /404.html;</span></span><br><span class="line"><span class="comment">#            location = /40x.html &#123;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#        error_page 500 502 503 504 /50x.html;</span></span><br><span class="line"><span class="comment">#            location = /50x.html &#123;</span></span><br><span class="line"><span class="comment">#        &#125;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx -t </span></span><br><span class="line"><span class="comment"># systemctl restart nginx </span></span><br></pre></td></tr></table></figure>
<p>浏览器访问 <a href="http://xxx.ssjinyao.com/">http://xxx.ssjinyao.com/</a></p>
<p><img src="/images/kibana.png" class="lazyload" data-srcset="/images/kibana.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="Logstash-的安装与配置"><a href="#Logstash-的安装与配置" class="headerlink" title="Logstash 的安装与配置"></a>Logstash 的安装与配置</h2><ul>
<li>注:由于logstash-5.3的二进制包无法实别系统环境PASH变量，所以这里用rpm包，yum安装  </li>
</ul>
<p>1、 下载并安装Logstash rpm 包 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/logstash/logstash-6.1.2.rpm</span></span><br><span class="line"><span class="comment"># yum -y install logstash-6.1.2.rpm</span></span><br></pre></td></tr></table></figure>
<p>2、 配置Logstash 收集远程日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim first-pipeline.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  udp &#123;</span><br><span class="line">    port =&gt; 5959</span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    geoip &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;clientip&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    <span class="comment">#stdout &#123; codec =&gt; rubydebug &#125;</span></span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [<span class="string">&quot;127.0.0.1:9200&quot;</span>]</span><br><span class="line">        user =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">        password =&gt; <span class="string">&quot;xxxxxxxxx&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># logstash -f first-pipeline.conf --path.settings=/etc/logstash/ --config.reload.automatic &amp;</span></span><br></pre></td></tr></table></figure>
<h2 id="beats-的安装与配置"><a href="#beats-的安装与配置" class="headerlink" title="beats 的安装与配置"></a>beats 的安装与配置</h2><blockquote>
<p>Beats是作为代理在服务器上安装的开源的 data shippers，能将各种不同类型的操作数据;<br>（如， wireData、LogFiles、Metrics、WinEvent）直接发送到 Elasticsearch;<br>或者通过Logstash将其发送到Elasticsearch。我们可以使用它来解析和转换我们需要收集的各种数据;  </p>
</blockquote>
<p>1、 安装 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-5.3.1-x86_64.rpm</span></span><br><span class="line"><span class="comment"># yum -y install  metricbeat-5.3.1-x86_64.rpm</span></span><br></pre></td></tr></table></figure>
<p>2、 配置 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/metricbeat/metricbeat.yml</span></span><br><span class="line">metricbeat.modules:</span><br><span class="line">- module: system</span><br><span class="line">  metricsets:</span><br><span class="line">    - cpu</span><br><span class="line">    - load</span><br><span class="line">    - core</span><br><span class="line">    - diskio</span><br><span class="line">    - filesystem</span><br><span class="line">    - fsstat</span><br><span class="line">    - memory</span><br><span class="line">    - network</span><br><span class="line">    - process</span><br><span class="line">    - socket</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  period: 10s</span><br><span class="line">  processes: [<span class="string">&#x27;.*&#x27;</span>]</span><br><span class="line">- module: nginx</span><br><span class="line">  metricsets: [<span class="string">&quot;stubstatus&quot;</span>]</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  period: 10s</span><br><span class="line">  hosts: [<span class="string">&quot;http://127.0.0.1&quot;</span>]</span><br><span class="line">  server_status_path: <span class="string">&quot;NginxStatus&quot;</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;127.0.0.1:9200&quot;</span>]</span><br><span class="line">  username: <span class="string">&quot;elastic&quot;</span></span><br><span class="line">  password: <span class="string">&quot;changeme&quot;</span></span><br><span class="line">logging.level: debug</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;localhost:9200&quot;</span>]</span><br><span class="line"><span class="comment"># metricbeat.sh -c metricbeat.yml  -configtest</span></span><br><span class="line">Config OK</span><br></pre></td></tr></table></figure>
<h2 id="登录查询日志"><a href="#登录查询日志" class="headerlink" title="登录查询日志"></a>登录查询日志</h2><p>1、 相看日志源ip区域分布</p>
<p><img src="/images/kibana_ditu.png" class="lazyload" data-srcset="/images/kibana_ditu.png" srcset="data:image/png;base64,666" alt=""></p>
<p>2、 Nginx 日志格式如下</p>
<p><img src="/images/kibana_nginx.png" class="lazyload" data-srcset="/images/kibana_nginx.png" srcset="data:image/png;base64,666" alt=""></p>
<p>3、 使用正则搜索</p>
<p><img src="/images/kibana_zhengze.png" class="lazyload" data-srcset="/images/kibana_zhengze.png" srcset="data:image/png;base64,666" alt=""></p>
<p>4、 直接写入Logstash的python日志表格式</p>
<p><img src="/images/kibana_table.png" class="lazyload" data-srcset="/images/kibana_table.png" srcset="data:image/png;base64,666" alt=""></p>
<p>5、 直接写入Logstash的python日志json格式</p>
<p><img src="/images/kibana_json.png" class="lazyload" data-srcset="/images/kibana_json.png" srcset="data:image/png;base64,666" alt=""></p>
<h2 id="远程日志收集"><a href="#远程日志收集" class="headerlink" title="远程日志收集"></a>远程日志收集</h2><p>1、 filebeat 的安装  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ curl -L -O https:&#x2F;&#x2F;download.elastic.co&#x2F;beats&#x2F;filebeat&#x2F;filebeat_1.3.0_amd64.deb</span><br><span class="line">$ sudo dpkg -i filebeat_1.3.0_amd64.deb</span><br><span class="line">$ sudo vim &#x2F;etc&#x2F;filebeat&#x2F;filebeat.yml </span><br><span class="line">filebeat:</span><br><span class="line">  prospectors:</span><br><span class="line">    -</span><br><span class="line">      paths:</span><br><span class="line">        - &#x2F;var&#x2F;log&#x2F;nginx&#x2F;*.log</span><br><span class="line">        - &#x2F;var&#x2F;log&#x2F;cashier&#x2F;logs&#x2F;*.log</span><br><span class="line">        - &#x2F;var&#x2F;log&#x2F;topen&#x2F;logs&#x2F;*.log</span><br><span class="line">        - &#x2F;var&#x2F;log&#x2F;xbasement&#x2F;logs&#x2F;*log</span><br><span class="line">      input_type: log</span><br><span class="line">      document_type: nginx-access-testapi.transfereasy.com</span><br><span class="line">  registry_file: &#x2F;var&#x2F;lib&#x2F;filebeat&#x2F;registry</span><br><span class="line">output:</span><br><span class="line">  logstash:</span><br><span class="line">          hosts: [&quot;xxx.xx.xxx.xx:5959&quot;]</span><br><span class="line">shipper:</span><br><span class="line">logging:</span><br><span class="line">  files:</span><br></pre></td></tr></table></figure>
<p>2、 将数据同步到elk</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo &#x2F;etc&#x2F;init.d&#x2F;filebeat start</span><br><span class="line">$ sudo &#x2F;etc&#x2F;init.d&#x2F;filebeat status</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>rhca</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>python 之业务服务监控详解(四)</title>
    <url>/2018/01/23/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E5%9B%9B/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="实现图文格式的服务器性能报表邮件"><a href="#实现图文格式的服务器性能报表邮件" class="headerlink" title="实现图文格式的服务器性能报表邮件"></a>实现图文格式的服务器性能报表邮件</h2><p>通过MIMEText 与 MIMEImage类的组合，实现图文邮件格式。<br>另通过MIMEText类再定义Content-Disposition 属性来实现附件的邮件。<br>可以利用这些特性来定质服务器周报。   </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat email_open.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart <span class="comment"># 导入MIMEMultipart类 </span></span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText <span class="comment"># 导入MIMEText类 </span></span><br><span class="line"><span class="keyword">from</span> email.mime.image <span class="keyword">import</span> MIMEImage <span class="comment"># 导入MIMEImae 类</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;smtp.139.com&quot;</span> <span class="comment"># 定义邮件 stmp 主机</span></span><br><span class="line">SUBJECT = <span class="string">u&quot;业务性能数据报表&quot;</span> <span class="comment"># 定义邮件主题</span></span><br><span class="line">TO = <span class="string">&quot;1922006891@qq.com&quot;</span>  <span class="comment"># 定义邮件收件人</span></span><br><span class="line">FROM = <span class="string">&quot;15822097176@139.com&quot;</span> <span class="comment"># 定义邮件发件人</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addimg</span>(<span class="params">src,imgid</span>):</span>  <span class="comment"># 添加片函数，参数1:图片路径,参数2: 图片id</span></span><br><span class="line">    fp = <span class="built_in">open</span>(src, <span class="string">&#x27;rb&#x27;</span>) <span class="comment"># 打开文件</span></span><br><span class="line">    msgImage = MIMEImage(fp.read()) <span class="comment"># 创建MIMEImage对象，读取图片内容并作为参数</span></span><br><span class="line">    fp.close() <span class="comment"># 关闭文件 </span></span><br><span class="line">    msgImage.add_header(<span class="string">&#x27;Content-ID&#x27;</span>, imgid) <span class="comment"># 指定图片文件的Content-ID,&lt;img&gt; 标签src用到</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> msgImage <span class="comment"># 返回msgImage 对象</span></span><br><span class="line"></span><br><span class="line">msg = MIMEMultipart(<span class="string">&#x27;related&#x27;</span>) <span class="comment"># 创建MIMEMultipart对象，采用related定义内嵌资源的邮件体</span></span><br><span class="line"><span class="comment">#创建MIMEText对象，HTML元素包括表格&lt;stable&gt;及图片&lt;img&gt;</span></span><br><span class="line">msgtext = MIMEText(<span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string">&lt;table width=&quot;600&quot; border=&quot;0&quot;  cellspacing=&quot;0&quot; cellpadding=&quot;4&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;tr bgcolor=&quot;#CECFAD&quot; height=&quot;20&quot; style=&quot;font-size:14px&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;td colspan=2&gt; * 官网性能数据 &lt;a href=&quot;www.ssinyao.com&quot;&gt; 更多&gt;&gt; &lt;/a&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">      &lt;/tr&gt;</span></span><br><span class="line"><span class="string">      &lt;tr bgcolor=&quot;#EFEBDE&quot; height=&quot;100&quot; style=&quot;font-size:13px&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;td&gt;</span></span><br><span class="line"><span class="string">        &lt;img src=&quot;cid:systemload&quot;&lt;/td&gt;&lt;td&gt;</span></span><br><span class="line"><span class="string">        &lt;img src=&quot;cid:cpu&quot;&lt;td&gt;</span></span><br><span class="line"><span class="string">      &lt;/tr&gt;</span></span><br><span class="line"><span class="string">      &lt;tr bgcolor=&quot;#EFEBDE&quot; height=&quot;100&quot; sytle=&quot;font-size:13px&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;td&gt;</span></span><br><span class="line"><span class="string">        &lt;img src=&quot;cid:eth0&quot;&gt;&lt;/td&gt;&lt;td&gt;</span></span><br><span class="line"><span class="string">        &lt;img src=&quot;cid:eth1&quot;&gt;&lt;/td&gt;</span></span><br><span class="line"><span class="string">      &lt;/tr&gt;</span></span><br><span class="line"><span class="string">    &lt;/table&gt;&quot;&quot;&quot;</span>, <span class="string">&quot;html&quot;</span>,<span class="string">&quot;utf-8&quot;</span>) <span class="comment">#&lt;img&gt; 标签的src属性是通过Content-ID 来引用的</span></span><br><span class="line"></span><br><span class="line">msg.attach(msgtext) </span><br><span class="line">msg.attach(addimg(<span class="string">&quot;./systemload.png&quot;</span>, <span class="string">&quot;systemload&quot;</span>)) </span><br><span class="line">msg.attach(addimg(<span class="string">&quot;./cpu.png&quot;</span>, <span class="string">&quot;cpu&quot;</span>)) </span><br><span class="line">msg.attach(addimg(<span class="string">&quot;./eth0.png&quot;</span>, <span class="string">&quot;eth0&quot;</span>)) </span><br><span class="line">msg.attach(addimg(<span class="string">&quot;./eth1.png&quot;</span>, <span class="string">&quot;eth1&quot;</span>)) </span><br><span class="line">msg[<span class="string">&#x27;Subject&#x27;</span>] = SUBJECT <span class="comment"># 邮件主题</span></span><br><span class="line">msg[<span class="string">&#x27;From&#x27;</span>] = FROM <span class="comment"># 邮件发送人，邮件头部可见</span></span><br><span class="line">msg[<span class="string">&#x27;TO&#x27;</span>] = TO <span class="comment"># 邮件收件人，邮件头部可见</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    server = smtplib.SMTP()  <span class="comment"># 创建一个SMTP()对象 </span></span><br><span class="line">    server.connect(HOST, <span class="string">&quot;25&quot;</span>) <span class="comment"># 通过connect方法连接smtp主机</span></span><br><span class="line">    server.starttls() <span class="comment">#启动安全传输模式</span></span><br><span class="line">    server.login(<span class="string">&quot;15822097176@139.com&quot;</span>,<span class="string">&quot;xxxxxxxx&quot;</span>) <span class="comment"># 邮箱帐号登录校验</span></span><br><span class="line">    server.sendmail(FROM, TO, msg.as_string()) <span class="comment">#邮件发送 </span></span><br><span class="line">    server.quit() <span class="comment"># 断开stmp连接</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;邮件发送成功&quot;</span></span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;失败:&quot;</span> +<span class="built_in">str</span>(e)</span><br><span class="line">➜  test ./email_open.py </span><br><span class="line">邮件发送成功    </span><br></pre></td></tr></table></figure>
<h2 id="实现的功能如下"><a href="#实现的功能如下" class="headerlink" title="实现的功能如下"></a>实现的功能如下</h2><p><img src="http://ssjinyao.oss-cn-beijing.aliyuncs.com/ssjinyao/hexo_file/message_table.png" class="lazyload" data-srcset="http://ssjinyao.oss-cn-beijing.aliyuncs.com/ssjinyao/hexo_file/message_table.png" srcset="data:image/png;base64,666" alt="Alt text"></p>
<h2 id="同样功能的实现-muttrc-msmtp-发送邮件"><a href="#同样功能的实现-muttrc-msmtp-发送邮件" class="headerlink" title="同样功能的实现 muttrc + msmtp 发送邮件"></a>同样功能的实现 muttrc + msmtp 发送邮件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># yum -y install msmtp mutt  </span><br><span class="line"></span><br><span class="line"># cat &#x2F;etc&#x2F;muttrc </span><br><span class="line">et sendmail&#x3D;&quot;&#x2F;usr&#x2F;bin&#x2F;msmtp&quot;</span><br><span class="line">set use_from&#x3D;yes</span><br><span class="line">set realname&#x3D;&quot;15822097176@139.com&quot;</span><br><span class="line">set editor&#x3D;&quot;vim&quot;</span><br><span class="line"></span><br><span class="line"># cat &#x2F;etc&#x2F;msmtprc</span><br><span class="line">account default</span><br><span class="line">host smtp.139.com</span><br><span class="line">port 25</span><br><span class="line">from 15822097176@139.com</span><br><span class="line">auth login</span><br><span class="line">tls off</span><br><span class="line">user 15822097176@139.com</span><br><span class="line">password xxxxxxxx</span><br><span class="line"></span><br><span class="line"># echo &quot;test&quot; | mutt -s &quot;test&quot; -a &#x2F;path&#x2F;to&#x2F;file</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 之业务服务监控详解(三)</title>
    <url>/2018/01/22/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%B8%89/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="DNS处理模块dnspython"><a href="#DNS处理模块dnspython" class="headerlink" title="DNS处理模块dnspython"></a>DNS处理模块dnspython</h2><blockquote>
<p>dnspython(<a href="https://www.dnspython.org/)是Python实现的一个DNS式具包，它支持几乎所有的">https://www.dnspython.org/)是Python实现的一个DNS式具包，它支持几乎所有的</a><br>记录类型 ，可以用于查询、传输并动态更新ZONE信息， 同时支持TSIG(事务签名)验证消息和<br>EDNS0(扩展DNS)。在系统管理方面，我们可以利用其查询功能来实现DNS服务监控以及解析<br>结果的校验，可以代替nslookup及dig等，轻松做到与现有平台的整合</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># pip install dnspython </span><br><span class="line"># easy_install dnspython </span><br><span class="line"># wget http:&#x2F;&#x2F;www.dnspython.org&#x2F;kits&#x2F;1.9.4&#x2F;dnspython-1.9.4.tar.gz</span><br><span class="line"># tar -zxvf dnspython-1.9.4.tar.gz</span><br><span class="line"># cd dnspython-1.9.4</span><br><span class="line"># python setuppy install </span><br></pre></td></tr></table></figure>
<h2 id="模块域名解析方法详解"><a href="#模块域名解析方法详解" class="headerlink" title="模块域名解析方法详解"></a>模块域名解析方法详解</h2><blockquote>
<p>dnspython 模块提供了大量的DNS处理方法，最常用的方法是域名查询。dnspython提供了一个<br>DNS解析器类–resolver，使用它的uquery方法来实现域名的查询功能。query方法定义如下;  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">query(self, qname, rdtype=<span class="number">1</span>, rdclass=<span class="number">1</span>, tcp=<span class="literal">False</span>, source=<span class="literal">None</span>, </span><br><span class="line">raise_on_no_answer=<span class="literal">True</span>, source_port=<span class="number">0</span>)	</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其中，qnae参数为查询的域名。rdtype参数用来指定RR资源的类型，常用的有以下几种:  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># A 记录，将主机名转换成IP地址:  </span></span><br><span class="line"><span class="comment"># MX 记录，邮件交换记录，定义邮件服务器的域名； </span></span><br><span class="line"><span class="comment"># CNAME记录，指别名记录，实现域名间的映射; </span></span><br><span class="line"><span class="comment"># NS记录，标记区域的域名服务器及授权子域; </span></span><br><span class="line"><span class="comment"># PTR记录，反向解析，与A记录相反，将IP转换成主机名;   </span></span><br><span class="line"><span class="comment"># SOA记录，SOA标记，一个起妈授权区的定义;   </span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>rdclass参数用于指定网络类型，可选的值有IN、CH与HS、其中IN为默认，使用最广泛;<br>tcp参数用于指定查询是否启用TCP协议，默认为False(不启用);<br>source 与source_port 参数作为指定查询源地址与端口;<br>默认值为查询设备IP地址和0。raise_on_no_answer;<br>参当用于指定当查询无应答时是否触发异常。默认为True;  </p>
</blockquote>
<h2 id="常见解析类型"><a href="#常见解析类型" class="headerlink" title="常见解析类型"></a>常见解析类型</h2><blockquote>
<p>常见的DNS解析类型包括A、MX、NS、CNAME等。利用dnspython和dns.resolver.query方法<br>可以简单实现这些DNS类型的查询，为后面要实现的功能提供数据来源，比如对一个使用DNS轮循<br>业务的域名进行可用性可用性，需要得到当前的解析结果。  </p>
</blockquote>
<p>1、实现A记录查询方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat dns_domain.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#from dns import resolver</span></span><br><span class="line"><span class="keyword">import</span> dns.resolver</span><br><span class="line">domain = raw_input(<span class="string">&quot;Please input an domain: &quot;</span>)  <span class="comment"># 输入域名地址</span></span><br><span class="line">A = dns.resolver.query(domain, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># 指定查询类型为A记录 </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> A.response.answer: <span class="comment"># 通过 response.answer 方法获取查询回应信息</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i.items: <span class="comment"># 遍历回应信息</span></span><br><span class="line">        <span class="built_in">print</span> j.address</span><br><span class="line">➜  test ./dns_domain.py </span><br><span class="line">Please <span class="built_in">input</span> an domain: www.ssjinyao.com</span><br><span class="line"><span class="number">47.94</span><span class="number">.3</span><span class="number">.76</span> </span><br></pre></td></tr></table></figure>
<p>2、实现MX记录查询方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test ./dns_mx.py</span><br><span class="line">Please <span class="built_in">input</span> an domain: ^CTraceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;./dns_mx.py&quot;</span>, line <span class="number">4</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    domain = raw_input(<span class="string">&quot;Please input an domain: &quot;</span>)</span><br><span class="line">KeyboardInterrupt</span><br><span class="line">➜  test cat ./dns_mx.py</span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> dns.resolver </span><br><span class="line">domain = raw_input(<span class="string">&quot;Please input an domain: &quot;</span>)</span><br><span class="line">MX = dns.resolver.query(domain, <span class="string">&#x27;MX&#x27;</span>)  <span class="comment"># 指定查询类型为MX记录</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> MX: <span class="comment"># 遍历回应结果，输出MX记录的preference 及exchanger信息</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;MX preference =&#x27;</span> , i.preference, <span class="string">&#x27;mail exchanger=&#x27;</span> , i.exchange</span><br><span class="line">➜  test ./dns_mx.py</span><br><span class="line">Please <span class="built_in">input</span> an domain: <span class="number">139.</span>com</span><br><span class="line">MX preference = <span class="number">10</span> mail exchanger= mx2.mail<span class="number">.139</span>.com.</span><br><span class="line">MX preference = <span class="number">20</span> mail exchanger= mx3.mail<span class="number">.139</span>.com.</span><br><span class="line">MX preference = <span class="number">5</span> mail exchanger= mx1.mail<span class="number">.139</span>.com.</span><br></pre></td></tr></table></figure>
<p>3、 实现 NS 记录查询方法源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat dns_ns.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> dns.resolver </span><br><span class="line">domain = raw_input(<span class="string">&#x27;Please input an domain: &#x27;</span>)</span><br><span class="line">ns = dns.resolver.query(domain, <span class="string">&#x27;NS&#x27;</span>)  <span class="comment"># 指定查询类型为NS记录</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ns.response.answer:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i.items:</span><br><span class="line">        <span class="built_in">print</span> j.to_text()</span><br><span class="line">➜  test ./dns_ns.py            </span><br><span class="line">Please <span class="built_in">input</span> an domain: ssjinyao.com</span><br><span class="line">dns30.hichina.com.</span><br><span class="line">dns29.hichina.com.</span><br><span class="line">➜  test ./dns_ns.py</span><br><span class="line">Please <span class="built_in">input</span> an domain: baidu.com</span><br><span class="line">ns2.baidu.com.</span><br><span class="line">ns7.baidu.com.</span><br><span class="line">dns.baidu.com.</span><br><span class="line">ns3.baidu.com.</span><br><span class="line">ns4.baidu.com.</span><br></pre></td></tr></table></figure>
<p>4、 实现CNAME记录查询方法 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat dns_cname.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> dns.resolver </span><br><span class="line">domain = raw_input(<span class="string">&quot;Please input an domain: &quot;</span>)</span><br><span class="line">cname = dns.resolver.query(domain, <span class="string">&#x27;CNAME&#x27;</span>) <span class="comment"># 指定查询类型为CNAME记录</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cname.response.answer:  <span class="comment"># 结果将回应 cname 后的目标域名</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i.items:</span><br><span class="line">        <span class="built_in">print</span> j.to_text()</span><br><span class="line">➜  test ./dns_cname.py  </span><br><span class="line">Please <span class="built_in">input</span> an domain: mail.ssjinyao.com</span><br><span class="line">mail.mxhichina.com.</span><br><span class="line">➜  test ./dns_cname.py</span><br><span class="line">Please <span class="built_in">input</span> an domain: ll.ssjinyao.com</span><br><span class="line">www.leleol.com.</span><br></pre></td></tr></table></figure>
<p>5、 DNS域名轮循业务监控 </p>
<blockquote>
<p>大部分的DNS解析都是一个域名对应一个IP地址，但是通过DNS轮循可以做到一个域名对应多个IP<br>从而实现最简单且最高效的负载均衡，不过此方案最大的弊端是目标主机不可以用时，无法被自动<br>剔除，因此做好业务主机的服务可用监控是至关重要的，通过分析当前域名的解析IP<br>再结合服务端口探测来实现自动监控，在域名解析中添加、删除IP时无须对监控脚本进行更改  </p>
</blockquote>
<p>a、 步骤 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 实现对域名的解析，获取域名 所有的A记录解析IP列表; </span></span><br><span class="line"><span class="comment"># 对IP 列表进行HTTP级别的探测;  </span></span><br></pre></td></tr></table></figure>
<p>b、 实现拓扑图 </p>
<p><img src="/images/dnspython.png" class="lazyload" data-srcset="/images/dnspython.png" srcset="data:image/png;base64,666" alt=""></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> dns.resolver </span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> httplib</span><br><span class="line"></span><br><span class="line">iplist = [] <span class="comment"># 定义域名IP列表变量</span></span><br><span class="line">appdomain = <span class="string">&quot;www.qqlilin.com&quot;</span> <span class="comment"># 定义业务域名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_iplist</span>(<span class="params">domain=<span class="string">&quot;&quot;</span></span>):</span> <span class="comment"># 域名解析函数，解析成功IP将被追加到iplist</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        A = dns.resolver.query(domain, <span class="string">&#x27;A&#x27;</span>) <span class="comment"># 解析A记录类型</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;dns resolver error:&quot;</span> + <span class="built_in">str</span>(e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> A.response.answer:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i.items:</span><br><span class="line">                iplist.append(j.address)  <span class="comment"># 追加到iplist</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkip</span>(<span class="params">ip</span>):</span></span><br><span class="line">    checkurl=ip+<span class="string">&quot;:80&quot;</span></span><br><span class="line">    getcontent=<span class="string">&quot;&quot;</span></span><br><span class="line">    httplib.socket.setdefaulttimeout(<span class="number">5</span>) <span class="comment"># 定义http连接超时间为5秒</span></span><br><span class="line">    conn=httplib.HTTPConnection(checkurl) <span class="comment"># 创建http连接对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn.request(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/&quot;</span>, headers = &#123;<span class="string">&quot;Host&quot;</span>: appdomain&#125;)  <span class="comment"># 发起URL请求，添加host 主机头</span></span><br><span class="line">        r=conn.getresponse()</span><br><span class="line">        getcontent = r.read(<span class="number">15</span>) <span class="comment"># 获取URL页面前15个字符，以便做可用性校验</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> getcontent==<span class="string">&quot;&lt;!doctype html&gt;&quot;</span>: <span class="comment"># 监控URL页的内容一般是事先定义好的，比如 &quot;HTTP200&quot; 等 </span></span><br><span class="line">            <span class="built_in">print</span> (getcontent)</span><br><span class="line">            <span class="built_in">print</span> ip + <span class="string">&quot; [OK]&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> ip + <span class="string">&quot; [Error]&quot;</span> <span class="comment"># 此处可放告警程序，可以是邮件，短信通知</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> get_iplist(appdomain) <span class="keyword">and</span> <span class="built_in">len</span>(iplist) &gt; <span class="number">0</span>:  <span class="comment"># 条件:域名解析正确至少返回一个IP</span></span><br><span class="line">        <span class="keyword">for</span> ip <span class="keyword">in</span> iplist:</span><br><span class="line">            checkip(ip)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;dns resolver error&quot;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 之业务服务监控详解(二)</title>
    <url>/2018/01/19/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%BA%8C/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="文件-目录差异对比法"><a href="#文件-目录差异对比法" class="headerlink" title="文件/目录差异对比法"></a>文件/目录差异对比法</h2><blockquote>
<p>当我们进行代码审计或校验备份时，往往需要检查原始与目标目录的一致性;<br>Python的标准库已经自带了满足此需求的模块filecmp;<br>filecmp可以实现文件、目录遍历子目录的差异对比功能;<br>比如报告中输出目录目录比原始多出的文件或子目录;<br>即使文件同名也会判断是否为同一个文件(内容级比对)等;<br>python2.3 或更高版本默认自带fileemp模块,无需额外安装;  </p>
</blockquote>
<h2 id="模块常用方法说明"><a href="#模块常用方法说明" class="headerlink" title="模块常用方法说明"></a>模块常用方法说明</h2><blockquote>
<p>filecmp 提供了三个操作方法，分别为cmp（单文件对比）、cmpfiles(多文件对比）<br>dircmp（目录对比) </p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">单文件对比，采用filecmp.cmp(f1,f2[,shallow])方法，比较文件名为f1和f2的文件   </span><br><span class="line">相同反回True，不相同返回False,shallow默认为True，意思是只根据os.stat()方法  </span><br><span class="line">返回的文件基本信息进行对比，比如最后访问时间、修改时间、状态改变时间等  </span><br><span class="line">忽略对文件内容的对比。当shallow为False时，则os.stat()与文件内容同时进行校验</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 对比文件的差异</span></span><br><span class="line">➜  test echo <span class="string">&quot;good user&quot;</span> &gt; f1   </span><br><span class="line">➜  test echo <span class="string">&quot;good user&quot;</span> &gt; f3</span><br><span class="line">➜  test echo <span class="string">&quot;good user2&quot;</span> &gt; f2</span><br><span class="line">In [<span class="number">2</span>]: <span class="keyword">import</span> filecmp</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: filecmp.cmp(<span class="string">&quot;/Users/macbookdzsbe/Desktop/MyPython/test/f1&quot;</span>,<span class="string">&quot;/Users/macbookdzsbe/Desktop/MyPython/test/f3&quot;</span>)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: filecmp.cmp(<span class="string">&quot;/Users/macbookdzsbe/Desktop/MyPython/test/f1&quot;</span>,<span class="string">&quot;/Users/macbookdzsbe/Desktop/MyPython/test/f2&quot;</span>)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h2 id="dir1-与-dir2目录中指定文件清单对比"><a href="#dir1-与-dir2目录中指定文件清单对比" class="headerlink" title="dir1 与 dir2目录中指定文件清单对比"></a>dir1 与 dir2目录中指定文件清单对比</h2><blockquote>
<p>两目录下文件的 md5 信息如下<br>两目录下文件的 md5 信息如下,其中f1、f2匹配; f3不匹配<br>f4,f5对应的目录中不存在无法比较</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[root@test dir2]<span class="comment"># md5sum ../dir1/*</span></span><br><span class="line"><span class="number">1</span>a9dbd408f626389539e9feb1d234df7  ../dir1/f1</span><br><span class="line"><span class="number">235</span>dce31eebce0213322102f698bc249  ../dir1/f2</span><br><span class="line"><span class="number">1</span>a9dbd408f626389539e9feb1d234df7  ../dir1/f3</span><br><span class="line">d41d8cd98f00b204e9800998ecf8427e  ../dir1/f5</span><br><span class="line">[root@test dir2]<span class="comment"># md5sum *</span></span><br><span class="line"><span class="number">1</span>a9dbd408f626389539e9feb1d234df7  f1</span><br><span class="line"><span class="number">235</span>dce31eebce0213322102f698bc249  f2</span><br><span class="line"><span class="number">68e51</span>baf228d447b199a75268dd5634b  f3</span><br><span class="line"><span class="number">764</span>c976782dec989b043d08714ec21a5  f4</span><br><span class="line"><span class="comment"># 使用cmpfiles 对比的结果如下，符合我们的预期 </span></span><br><span class="line">In [<span class="number">4</span>]: <span class="keyword">import</span> filecmp</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: filecmp.cmpfiles(<span class="string">&quot;/root/test/dir1&quot;</span>, <span class="string">&quot;/root/test/dir2&quot;</span>,[<span class="string">&#x27;f1&#x27;</span>,<span class="string">&#x27;f2&#x27;</span>,<span class="string">&#x27;f3&#x27;</span>,<span class="string">&#x27;f4&#x27;</span>,<span class="string">&#x27;f5&#x27;</span>])</span><br><span class="line">Out[<span class="number">5</span>]: ([<span class="string">&#x27;f1&#x27;</span>, <span class="string">&#x27;f2&#x27;</span>], [<span class="string">&#x27;f3&#x27;</span>], [<span class="string">&#x27;f4&#x27;</span>, <span class="string">&#x27;f5&#x27;</span>])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>目录对比，能过dircmp(a,b[,ingore[,hide]]) 类创建一个目录比较对象;<br>其中a和b是参加比较的目录名。ignore代表文件名忽略的列表，并默认为[‘RCS’,’CVS’,’’tags];<br>hide代表隐藏的列表，默认为[os.curdir, os.pardir]。dircmp类可以获得目录比较的详细信息;<br>如只有在a目录中包括的文件、a与b都存在的子目录、匹配的文件等，同时支持递归;  </p>
</blockquote>
<h2 id="dircmp提供了三个输出报的方法"><a href="#dircmp提供了三个输出报的方法" class="headerlink" title="dircmp提供了三个输出报的方法"></a>dircmp提供了三个输出报的方法</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># report()，比较当前指定目录中的内容;  </span></span><br><span class="line"><span class="comment"># report_partial_closure(),比较当前指定目录 及第一级子目录中的内容;  </span></span><br><span class="line"><span class="comment"># report_full_closure(),递归比较所有指定目录的内容;  </span></span><br><span class="line"><span class="comment"># 为输出更加详细的比较内容，dircmp类还提供了以下属性;  </span></span><br><span class="line"><span class="comment"># left, 左目录,如类定义的a; </span></span><br><span class="line"><span class="comment"># right, 右目录,如类定义中的b; </span></span><br><span class="line"><span class="comment"># left_list, 左目录中的文件及目录列表;  </span></span><br><span class="line"><span class="comment"># right_list, 右目录中的文件及目录列表; </span></span><br><span class="line"><span class="comment"># common, 两边目录共同存在的文件或者目录;  </span></span><br><span class="line"><span class="comment"># left_only, 只在左目录中的文件或者目录; </span></span><br><span class="line"><span class="comment"># right_only, 只在右目录的文件或者目录; </span></span><br><span class="line"><span class="comment"># common_dirs, 两边目录都存在的子目录; </span></span><br><span class="line"><span class="comment"># common_files, 两边目录都存在的子文件;  </span></span><br><span class="line"><span class="comment"># common_funny, 两边目录都存在的子目录(不同目录类型或os.stat()记录的错误);  </span></span><br><span class="line"><span class="comment"># same_files, 匹配相同的文件;  </span></span><br><span class="line"><span class="comment"># diff_files, 不匹配的文件;  </span></span><br><span class="line"><span class="comment"># funny_files, 两边目录中都存在，但无法比较的文件; </span></span><br><span class="line"><span class="comment"># subdirs, 将common_dirs目录名映身到新的dircmp对象，格式为字典类型; </span></span><br></pre></td></tr></table></figure>
<h2 id="对比dir1与dir2目录差异"><a href="#对比dir1与dir2目录差异" class="headerlink" title="对比dir1与dir2目录差异"></a>对比dir1与dir2目录差异</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> <span class="built_in">test</span>]<span class="comment"># mkdir dir1/&#123;a/&#123;a1,b/&#123;b1,b2,b3&#125;&#125;,f1,f2,f3,f4&#125; -pv</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/a&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/a/a1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/a/b&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/a/b/b1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/a/b/b2&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/a/b/b3&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/f1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/f2&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/f3&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir1/f4&quot;</span></span><br><span class="line">[root@<span class="built_in">test</span> <span class="built_in">test</span>]<span class="comment"># touch dir1/test.py</span></span><br><span class="line">[root@<span class="built_in">test</span> <span class="built_in">test</span>]<span class="comment"># tree  dir1/</span></span><br><span class="line">dir1/</span><br><span class="line">├── a</span><br><span class="line">│   ├── a1</span><br><span class="line">│   └── b</span><br><span class="line">│       ├── b1</span><br><span class="line">│       ├── b2</span><br><span class="line">│       └── b3</span><br><span class="line">├── f1</span><br><span class="line">├── f2</span><br><span class="line">├── f3</span><br><span class="line">├── f4</span><br><span class="line">└── test.py</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@tf-test <span class="built_in">test</span>]<span class="comment"># mkdir dir2/&#123;a/&#123;a1,b/&#123;b1,b2,b3&#125;&#125;,aa&#123;/aa1&#125;,f1,f2,f3,f5&#125; -pv</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/a&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/a/a1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/a/b&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/a/b/b1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/a/b/b2&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/a/b/b3&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/aa&#123;&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/aa&#123;/aa1&#125;&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/f1&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/f2&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/f3&quot;</span></span><br><span class="line">mkdir: 已创建目录 <span class="string">&quot;dir2/f5&quot;</span></span><br><span class="line">[root@tf-test <span class="built_in">test</span>]<span class="comment"># touch dir2/test.py</span></span><br><span class="line">[root@tf-test <span class="built_in">test</span>]<span class="comment"># tree dir2/</span></span><br><span class="line">dir2/</span><br><span class="line">├── a</span><br><span class="line">│   ├── a1</span><br><span class="line">│   └── b</span><br><span class="line">│       ├── b1</span><br><span class="line">│       ├── b2</span><br><span class="line">│       └── b3</span><br><span class="line">├── aa&#123;</span><br><span class="line">│   └── aa1&#125;</span><br><span class="line">├── f1</span><br><span class="line">├── f2</span><br><span class="line">├── f3</span><br><span class="line">├── f5</span><br><span class="line">└── test.py</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[root@test test]<span class="comment"># cat cmpy.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*- </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> filecmp</span><br><span class="line">a = <span class="string">&quot;/root/test/dir1&quot;</span> <span class="comment"># 定义左目录 </span></span><br><span class="line">b = <span class="string">&quot;/root/test/dir2&quot;</span> <span class="comment"># 定义右目录 </span></span><br><span class="line"></span><br><span class="line">dirobj=filecmp.dircmp(a,b,[<span class="string">&#x27;test.y&#x27;</span>]) <span class="comment"># 目录比较，忽略test.py文件 </span></span><br><span class="line"><span class="comment">#输出对比结果数据报表</span></span><br><span class="line"></span><br><span class="line">dirobj.report()</span><br><span class="line">dirobj.report_partial_closure()</span><br><span class="line">dirobj.report_full_closure() </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;left_list:&quot;</span> + <span class="built_in">str</span>(dirobj.left_list)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;right_list&quot;</span> + <span class="built_in">str</span>(dirobj.right_list)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;common:&quot;</span> + <span class="built_in">str</span>(dirobj.common)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;left_only:&quot;</span> + <span class="built_in">str</span>(dirobj.left_only)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;right_only:&quot;</span> + <span class="built_in">str</span>(dirobj.right_only)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;common_dirs:&quot;</span> + <span class="built_in">str</span>(dirobj.common_dirs)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;common_files:&quot;</span> + <span class="built_in">str</span>(dirobj.common_files)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;common_funny:&quot;</span> + <span class="built_in">str</span>(dirobj.common_funny)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;same_file:&quot;</span> + <span class="built_in">str</span>(dirobj.same_files)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;diff_files:&quot;</span> + <span class="built_in">str</span>(dirobj.diff_files)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;funny_files:&quot;</span> + <span class="built_in">str</span>(dirobj.funny_files)</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">diff /root/test/dir1 /root/test/dir2</span><br><span class="line">Only in /root/test/dir1 : [&#x27;f4&#x27;]</span><br><span class="line">Only in /root/test/dir2 : [&#x27;aa&#123;&#x27;, &#x27;f5&#x27;]</span><br><span class="line">Identical files : [&#x27;test.py&#x27;]</span><br><span class="line">Common subdirectories : [&#x27;a&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;]</span><br><span class="line">diff /root/test/dir1 /root/test/dir2</span><br><span class="line">Only in /root/test/dir1 : [&#x27;f4&#x27;]</span><br><span class="line">Only in /root/test/dir2 : [&#x27;aa&#123;&#x27;, &#x27;f5&#x27;]</span><br><span class="line">Identical files : [&#x27;test.py&#x27;]</span><br><span class="line">Common subdirectories : [&#x27;a&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;]</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a /root/test/dir2/a</span><br><span class="line">Common subdirectories : [&#x27;a1&#x27;, &#x27;b&#x27;]</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/f1 /root/test/dir2/f1</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/f2 /root/test/dir2/f2</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/f3 /root/test/dir2/f3</span><br><span class="line">diff /root/test/dir1 /root/test/dir2</span><br><span class="line">Only in /root/test/dir1 : [&#x27;f4&#x27;]</span><br><span class="line">Only in /root/test/dir2 : [&#x27;aa&#123;&#x27;, &#x27;f5&#x27;]</span><br><span class="line">Identical files : [&#x27;test.py&#x27;]</span><br><span class="line">Common subdirectories : [&#x27;a&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;]</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a /root/test/dir2/a</span><br><span class="line">Common subdirectories : [&#x27;a1&#x27;, &#x27;b&#x27;]</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a/a1 /root/test/dir2/a/a1</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a/b /root/test/dir2/a/b</span><br><span class="line">Common subdirectories : [&#x27;b1&#x27;, &#x27;b2&#x27;, &#x27;b3&#x27;]</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a/b/b1 /root/test/dir2/a/b/b1</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a/b/b2 /root/test/dir2/a/b/b2</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/a/b/b3 /root/test/dir2/a/b/b3</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/f1 /root/test/dir2/f1</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/f2 /root/test/dir2/f2</span><br><span class="line"></span><br><span class="line">diff /root/test/dir1/f3 /root/test/dir2/f3</span><br><span class="line">left_list:[&#x27;a&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;, &#x27;f4&#x27;, &#x27;test.py&#x27;]</span><br><span class="line">right_list[&#x27;a&#x27;, &#x27;aa&#123;&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;, &#x27;f5&#x27;, &#x27;test.py&#x27;]</span><br><span class="line">common:[&#x27;a&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;, &#x27;test.py&#x27;]</span><br><span class="line">left_only:[&#x27;f4&#x27;]</span><br><span class="line">right_only:[&#x27;aa&#123;&#x27;, &#x27;f5&#x27;]</span><br><span class="line">common_dirs:[&#x27;a&#x27;, &#x27;f1&#x27;, &#x27;f2&#x27;, &#x27;f3&#x27;]</span><br><span class="line">common_files:[&#x27;test.py&#x27;]</span><br><span class="line">common_funny:[]</span><br><span class="line">same_file:[&#x27;test.py&#x27;]</span><br><span class="line">diff_files:[]</span><br><span class="line">funny_files:[]</span><br></pre></td></tr></table></figure>
<h2 id="校验源与备份目录差异"><a href="#校验源与备份目录差异" class="headerlink" title="校验源与备份目录差异"></a>校验源与备份目录差异</h2><blockquote>
<p>有时候我们无法确认备份目录与源目录文件是否保持一致，包括源目录中的新文件或目录;<br>更新文件或目录 有无成功同步，定期进行校验，没有成功则希望有针对性地进行补备份;<br>本未例使用了filecmp模块的left_only、diff_files方法递归获取目录的更新项;<br>再通过shuti.copyfile、 os.makedirs 方法对更新项进行复制，最终保持一致状态;  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat dir_contrast.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os, sys </span><br><span class="line"><span class="keyword">import</span> filecmp</span><br><span class="line"><span class="keyword">import</span> re </span><br><span class="line"><span class="keyword">import</span> shutil </span><br><span class="line"><span class="keyword">import</span> difflib</span><br><span class="line">holderlist = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compareme</span>(<span class="params">dir1,dir2</span>):</span>   <span class="comment"># 递归获取更新项函数</span></span><br><span class="line">    dircomp=filecmp.dircmp(dir1,dir2)</span><br><span class="line">    only_in_one=dircomp.left_only  <span class="comment"># 源目录新文件或目录</span></span><br><span class="line">    diff_in_one=dircomp.diff_files <span class="comment"># 不匹配文件，源目录文件已发生变化</span></span><br><span class="line">    dirath=os.path.abspath(dir1)   <span class="comment"># 定义源目录绝对路径</span></span><br><span class="line">    <span class="comment">#将更新文件名或目录追回到holderlist </span></span><br><span class="line">    [holderlist.append(os.path.abspath(os.path.join(dir1,x))) <span class="keyword">for</span> x <span class="keyword">in</span> only_in_one]</span><br><span class="line">    [holderlist.append(os.path.abspath(os.path.join(dir1,x))) <span class="keyword">for</span> x <span class="keyword">in</span> diff_in_one]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span> (dircomp.common_dirs) &gt; <span class="number">0</span>: <span class="comment"># 判断是否存在相同子目录，以便递归</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> dircomp.common_dirs: <span class="comment">#递归子目录</span></span><br><span class="line">            compareme(os.path.abspath(os.path.join(dir1, item)), \</span><br><span class="line">            os.path.abspath(os.path.join(dir2,item)))</span><br><span class="line">    <span class="keyword">return</span> holderlist </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt;<span class="number">2</span>: <span class="comment">#  要求输入源目录与备份目录</span></span><br><span class="line">        dir1 = sys.argv[<span class="number">1</span>]</span><br><span class="line">        dir2 = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Usage:&quot;</span>, sys.argv[<span class="number">0</span>], <span class="string">&quot;datadir backupdir&quot;</span></span><br><span class="line">        sys.exit()</span><br><span class="line">    </span><br><span class="line">    source_files = compareme(dir1,dir2)</span><br><span class="line">    dir1 = os.path.abspath(dir1)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> dir2.endswith(<span class="string">&#x27;/&#x27;</span>): dir2=dir2+<span class="string">&#x27;/&#x27;</span> <span class="comment">#备份目录路径加&quot;/&quot;符</span></span><br><span class="line">    dir2=os.path.abspath(dir2)</span><br><span class="line">    destination_files=[]</span><br><span class="line">    createdir_bool = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> source_files:   <span class="comment"># 遍历返回的差异文件或目录清单</span></span><br><span class="line">        destination_dir= re.sub(dir1,dir2, item) <span class="comment"># 将源目录差异路径清单对应替换成备份目录</span></span><br><span class="line">    </span><br><span class="line">        destination_files.append(destination_dir)</span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(item): <span class="comment"># 如果差异路径 为目录且不存在,则在备份目录中创建</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(destination_dir):</span><br><span class="line">                os.makedirs(destination_dir)</span><br><span class="line">                createdir_bool = <span class="literal">True</span> <span class="comment">#再次调用compareme 函数标记</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> createdir_bool: <span class="comment">#重新调用compareme函数,重新遍历新创建目录的内容</span></span><br><span class="line">        destination_files = [] </span><br><span class="line">        source_files=[]</span><br><span class="line">        source_files=compareme(dir1,dir2) <span class="comment"># 调用compareme函数</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> source_files: <span class="comment">#获取目录差异路径清单，对应替换成备分目录</span></span><br><span class="line">            destination_dir = re.sub(dir1,dir2, item)</span><br><span class="line">            destination_files.append(destination_dir)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;update item:&quot;</span></span><br><span class="line">    <span class="built_in">print</span> source_files <span class="comment">#输出更新项列表清单</span></span><br><span class="line">    copy_pair = <span class="built_in">zip</span>(source_files,destination_files) <span class="comment">#将源目录与备份目录文件拆分成无组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> copy_pair:</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(item[<span class="number">0</span>]): </span><br><span class="line">            shutil.copyfile(item[<span class="number">0</span>], item[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python 之业务服务监控详解(一)</title>
    <url>/2018/01/18/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%B8%80/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="业务服务监控详解"><a href="#业务服务监控详解" class="headerlink" title="业务服务监控详解"></a>业务服务监控详解</h2><blockquote>
<p>业务服务监控是运维体系中最重要的环节，是保证业务服务质量的关键手段。如何更有效地实现业务服务<br>是每个运维人员应该思考的问题，不同业务场景需定制不同的监控策略。Python在监控方面提供了大量<br>的第三方式具，可以帮助我们快速、有效地开发企业级服务监控平台，为我们的业务保驾护航。  </p>
</blockquote>
<h2 id="文件内容差异对比方法"><a href="#文件内容差异对比方法" class="headerlink" title="文件内容差异对比方法"></a>文件内容差异对比方法</h2><blockquote>
<p>通过difflib模块实现文件内容差异比对。difflib作为Python的标准库模块，无需安装，作用是对比<br>文本之间的差异，且支持输出可读性较强的HTML档，与linux下的diff命令相似。 我们可以使用<br>difflib对比代码、配置文件的差别，在版本控制方在是非常有用的。python2.3或者更高版本默认<br>自带difflib模块  </p>
</blockquote>
<h2 id="两个字符串的差异对比"><a href="#两个字符串的差异对比" class="headerlink" title="两个字符串的差异对比"></a>两个字符串的差异对比</h2><blockquote>
<p>通过使用difflib模块实现两个字符串的差异对比，然后以版本控制风格进行输出  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat diff.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> difflib</span><br><span class="line">text1 = <span class="string">&quot;&quot;&quot;text1: </span></span><br><span class="line"><span class="string">This module provides classes and funcitons for compring sequences.</span></span><br><span class="line"><span class="string">including HTML and context and unified diffs. </span></span><br><span class="line"><span class="string">difflib document v7.4</span></span><br><span class="line"><span class="string">add sring </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">text1_lines = text1.splitlines() <span class="comment">#以行进行分隔，以便进行对比  </span></span><br><span class="line">text2 = <span class="string">&quot;&quot;&quot;text2</span></span><br><span class="line"><span class="string">This module provides classes and functions for Comparing sequences. </span></span><br><span class="line"><span class="string">including HTML and context and unified diffs. </span></span><br><span class="line"><span class="string">difflib document v7.5</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">text2_lines = text2.splitlines() </span><br><span class="line">d = difflib.Differ()</span><br><span class="line">diff = d.compare(text1_lines, text2_lines) <span class="comment"># 采用compare方法对字符串进行比较</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;\n&#x27;</span> .join(<span class="built_in">list</span>(diff))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例结果</span></span><br><span class="line">➜  test python diff.py </span><br><span class="line">- text1: </span><br><span class="line">+ text2</span><br><span class="line">- This module provides classes <span class="keyword">and</span> funcitons <span class="keyword">for</span> compring sequences.</span><br><span class="line">?                                       -        ^</span><br><span class="line"></span><br><span class="line">+ This module provides classes <span class="keyword">and</span> functions <span class="keyword">for</span> Comparing sequences. </span><br><span class="line">?                                      +         ^   +               +</span><br><span class="line"></span><br><span class="line">  including HTML <span class="keyword">and</span> context <span class="keyword">and</span> unified diffs. </span><br><span class="line">- difflib document v7<span class="number">.4</span></span><br><span class="line">?                     ^</span><br><span class="line"></span><br><span class="line">+ difflib document v7<span class="number">.5</span></span><br><span class="line">?                     ^</span><br><span class="line"></span><br><span class="line">- add sring </span><br><span class="line">➜  test </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 符号说明</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>‘_’   ‘包含在第一个序列行中，但不包含在第二个序列行’<br>‘+’   ‘包含在第二个序列行中，但不包含在第一个序列行’<br>‘’      ‘两个序列行一致’<br>‘?’   ‘标志两个序列行存在增量差异’<br>‘^’      ‘标志出两个序列行存在的差异字符’<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">## 生成美观的对比HTML格式文档</span><br><span class="line"></span><br><span class="line">&gt; 采用HtmlDiff()类的make_file() 方法就可以生成美观的HTML文档  </span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;python</span><br><span class="line">d  &#x3D; difflib.Differ()</span><br><span class="line">diff &#x3D; d.compare(text1_lines, text2_lines)</span><br><span class="line">print &#39;\n&#39; .join(list(diff))</span><br><span class="line"></span><br><span class="line">替换成:</span><br><span class="line"></span><br><span class="line">d &#x3D; difflib.HtmlDiff()</span><br><span class="line">print d.make_file(text1_lines, text2_lines)</span><br></pre></td></tr></table></figure></p>
<h2 id="对比Nginx配置文件差异"><a href="#对比Nginx配置文件差异" class="headerlink" title="对比Nginx配置文件差异"></a>对比Nginx配置文件差异</h2><blockquote>
<p>当我们维护多个Nginx配置时，时常会对比不同版本的配置文件的差异，使用运维人员更加清晰地<br>了解不同版本迭代的更新项，实现的思路是读取两个需对比的配置文件，再以换行符作为分隔符<br>调用 difflib.HtmlDiff() 生成HTML格式的差异文档  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">scp diff_nginx.py root@www.ssjinyao.com:/root/</span><br><span class="line">diff_nginx.py                                                                                                                                                                                               <span class="number">100</span>% <span class="number">1035</span>     <span class="number">1.0</span>KB/s   <span class="number">00</span>:<span class="number">00</span>    </span><br><span class="line">➜  test ssh root@www.ssjinyao.com       </span><br><span class="line">Last failed login: Thu Jan <span class="number">18</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">31</span> CST <span class="number">2018</span> <span class="keyword">from</span> <span class="number">140.205</span><span class="number">.201</span><span class="number">.39</span> on ssh:notty</span><br><span class="line">There were <span class="number">48</span> failed login attempts since the last successful login.</span><br><span class="line">Last login: Tue Jan <span class="number">16</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">45</span> <span class="number">2018</span> <span class="keyword">from</span> <span class="number">111.198</span><span class="number">.29</span><span class="number">.81</span></span><br><span class="line"></span><br><span class="line">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="line"></span><br><span class="line">[root@iz2zearhdmowvugecyh820z ~]<span class="comment"># vim diff_nginx.py </span></span><br><span class="line">[root@iz2zearhdmowvugecyh820z ~]<span class="comment"># python diff_nginx.py /etc/nginx/conf.d/leleol.conf  /etc/nginx/conf.d/hexo.conf &gt; /var/www/ssjinyao/diff_nginx.html</span></span><br><span class="line">[root@iz2zearhdmowvugecyh820z ~]<span class="comment"># cat diff_nginx.py </span></span><br><span class="line"><span class="comment">#!/bin/bash/env python </span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> difflib</span><br><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    textfile1 = sys.argv[<span class="number">1</span>] <span class="comment">#第一个配置文件路径参数 </span></span><br><span class="line">    textfile2 = sys.argv[<span class="number">2</span>] <span class="comment">#第二个配置文件路径参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Error:&quot;</span> + <span class="built_in">str</span>(e)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;Usage: diff_nginx.py filename1 filename2&quot;</span></span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readfile</span>(<span class="params">filename</span>):</span>  <span class="comment"># 文件读取分隔函数</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        fileHandle = <span class="built_in">open</span> (filename, <span class="string">&#x27;rb&#x27;</span> )</span><br><span class="line">        text=fileHandle.read() .splitlines() <span class="comment">#读取后以行进行分隔</span></span><br><span class="line">        fileHandle.close()</span><br><span class="line">        <span class="keyword">return</span> text </span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> error: </span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;Read file Error:&#x27;</span> +<span class="built_in">str</span>(error))</span><br><span class="line">        sys.exit()</span><br><span class="line">    <span class="keyword">if</span> textfile1 == <span class="string">&quot;&quot;</span> <span class="keyword">or</span> textfile2 == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Usage: diff_nginx.py filename1 filename2 &quot;</span></span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">text1_lines = readfile(textfile1) <span class="comment">#调用readfile函数，获取分隔后的字符串</span></span><br><span class="line">text2_lines = readfile(textfile2) </span><br><span class="line"></span><br><span class="line">d = difflib.HtmlDiff() <span class="comment">#创建HtmlDiff()类对象</span></span><br><span class="line"><span class="built_in">print</span> d.make_file(text1_lines,text2_lines)  <span class="comment">#通过make_file方法输出HTML的对比结果</span></span><br><span class="line">https://www.ssjinyao.com/diff_nginx.html</span><br></pre></td></tr></table></figure>
<p><img src="/images/python_diff_nginx.png" class="lazyload" data-srcset="/images/python_diff_nginx.png" srcset="data:image/png;base64,666" alt=""></p>
]]></content>
      <tags>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>python wxpy 模块实现微信通知与告警</title>
    <url>/2018/01/16/python-wxpy-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5%E4%B8%8E%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="python-wxpy-模块实现微信通知与告警"><a href="#python-wxpy-模块实现微信通知与告警" class="headerlink" title="python wxpy 模块实现微信通知与告警"></a>python wxpy 模块实现微信通知与告警</h2><p>1、python wxpy的安装</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pip install wxpy -i &quot;https://pypi.doubanio.com/simple/&quot;</span></span><br><span class="line"><span class="comment"># pip install wechat_sender -i &quot;https://pypi.doubanio.com/simple/&quot;</span></span><br></pre></td></tr></table></figure>
<p>2、 wxpy登录后向文件助手发送一条信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat wechat.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line">bot = Bot()</span><br><span class="line">bot.file_helper.send(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;ending&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>3、wxpy登录后实现与好友/群聊</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat wechat_friends.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line">reload (sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="comment"># 这里要注意中文编码的问题</span></span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line">bot = Bot()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有好友</span></span><br><span class="line">friends = bot.friends()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历输出好友名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> friend <span class="keyword">in</span> friends: </span><br><span class="line">    print(friend)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到好友 </span></span><br><span class="line"></span><br><span class="line">friend = bot.friends() .search(unicode(<span class="string">&#x27;有你&#x27;</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">print(friend)</span><br><span class="line">friend.send(<span class="string">&#x27;你在干嘛了?&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有聊天群 </span></span><br><span class="line"></span><br><span class="line">groups = bot.groups()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历输出所有聊天群</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> group <span class="keyword">in</span> groups:</span><br><span class="line">    print(group)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到目标群</span></span><br><span class="line"><span class="comment"># 搜索聊天群时，要确保将要搜索的群组保存在通讯录中</span></span><br><span class="line">group = bot.groups() .search(unicode(<span class="string">&quot;an&quot;</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i&lt;= <span class="number">999</span>:</span><br><span class="line">    group.send(<span class="string">&quot;This is bug ！！！&quot;</span>)</span><br><span class="line">    i +=<span class="number">1</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4、 实现自动对消息处理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat wechat_message.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7 </span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload (sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">bot = Bot()</span><br><span class="line"><span class="comment"># 获取好友 </span></span><br><span class="line">my_friend = bot.friends() .search(unicode(<span class="string">&#x27;有你真好&#x27;</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索信息</span></span><br><span class="line">messages = bot.messages.search(keywords=<span class="string">&#x27;测试&#x27;</span>, sender=bot.self)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> messages:</span><br><span class="line">    print(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送文本</span></span><br><span class="line">my_friend.send(<span class="string">&#x27;hello,yangyang!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送图片</span></span><br><span class="line">my_friend.send_image(<span class="string">&#x27;yangyang.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送视频</span></span><br><span class="line"><span class="comment">#my_friend.send_video(&#x27;yangyang.mov&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发磅文件</span></span><br><span class="line">my_friend.send_file(<span class="string">&#x27;yangyang.zip&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以动态的方式发送图片</span></span><br><span class="line"></span><br><span class="line">my_friend.send(<span class="string">&#x27;yangyang.png&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送公众号</span></span><br><span class="line">my_friend.send_raw_msg(</span><br><span class="line">    <span class="comment">#名片原始消息类型</span></span><br><span class="line">    raw_type=<span class="number">42</span>,</span><br><span class="line">    <span class="comment"># 注意`ussername` 这里应为微信ID，且被发送的名片必须为自己的好友</span></span><br><span class="line">    raw_content = <span class="string">&#x27;&lt;msg username=&quot;wxpy_bot&quot; nickname=&quot;wxpy 机器人&quot;/&gt;&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消息接收监听器</span></span><br><span class="line"><span class="meta">@bot.register()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_others</span>(<span class="params">msg</span>):</span></span><br><span class="line">    <span class="comment"># 输出监听到的消息</span></span><br><span class="line">    print(msg)</span><br><span class="line">    <span class="comment">#回复消息</span></span><br><span class="line">    msg.reply(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line"></span><br><span class="line">embed()</span><br></pre></td></tr></table></figure>
<p>5、 wxpy图灵机器人</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat wechat_tulin.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python2.7</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">reload (sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">bot = Bot() </span><br><span class="line"><span class="comment"># 获取好友 </span></span><br><span class="line">dear =  bot.friends() .search(unicode(<span class="string">&#x27;有你真好&#x27;</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册获得个人的图录机器人key填入 </span></span><br><span class="line">tuling = Tuling(api_key=<span class="string">&#x27;45a3c4xxxxxxxxx043a126a7119363d9fe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用图灵机器人自动与指定好友聊天</span></span><br><span class="line"><span class="meta">@bot.register(dear)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reply_my_friend</span>(<span class="params">msg</span>):</span></span><br><span class="line">    print(msg)</span><br><span class="line">    tuling.do_reply(msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">embed()</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>python 自动化之paramiko</title>
    <url>/2018/01/12/python-%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bparamiko/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p>paramiko 是基于Python实现的SSH2远程安全连接，支支认证及密钥方式 。可以实现远程命令执行;<br>文件传输、中间SSH代理等功能，相对于Pexpect，封装的层次更高，更贴近SSH协议的功能;  </p>
</blockquote>
<h2 id="paramiko-的安装"><a href="#paramiko-的安装" class="headerlink" title="paramiko 的安装"></a>paramiko 的安装</h2><p>1、 paramiko 支持pip、 easy_install 或者源安装方式，很方便解决依赖的问题，具体安装命令如下;   </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pip easy_install paramiko</span></span><br><span class="line"><span class="comment"># easy_install paramiko</span></span><br></pre></td></tr></table></figure>
<p>2、 paramiko 依赖第三方的Crypto、Ecdsa包及Python开发包python-devel的支持，源码如下;  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install python-devel </span></span><br><span class="line"><span class="comment"># wget http://ftp.dlitz.net/pub/dlitz/crypto/pycrypto/pycrypto-2.6.tar.gz</span></span><br><span class="line"><span class="comment"># tar -zxvf pycrypto-2.6.tar.gz</span></span><br><span class="line"><span class="comment"># cd pycrypto-2.6</span></span><br><span class="line"><span class="comment"># python setup.py install</span></span><br><span class="line"><span class="comment"># cd ..</span></span><br><span class="line"><span class="comment"># wget https://pypi.python.org/packages/source/e/ecdsa/ecdsa-0.10.tar.gz --no-check-certificate </span></span><br><span class="line"><span class="comment"># tar -zxvf ecdsa-0.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd ecdsa-0.10</span></span><br><span class="line"><span class="comment"># python setup.py install </span></span><br><span class="line"><span class="comment"># cd ..</span></span><br><span class="line"><span class="comment"># git clone https://github.com/paramiko/paramiko.git</span></span><br><span class="line"><span class="comment"># cd paramiko</span></span><br><span class="line"><span class="comment"># python setup.py install</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3、 校验安装结果，导入模块 没有提示异常，则说明该包安装成功;   </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  ~ ipython</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.14</span> (default, Sep <span class="number">25</span> <span class="number">2017</span>, <span class="number">09</span>:<span class="number">53</span>:<span class="number">22</span>) </span><br><span class="line">Type <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> <span class="keyword">or</span> <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">IPython <span class="number">5.5</span><span class="number">.0</span> -- An enhanced Interactive Python.</span><br><span class="line">?         -&gt; Introduction and overview of IPython&#x27;s features.</span><br><span class="line">%quickref -&gt; Quick reference.</span><br><span class="line">help      -&gt; Python&#x27;s own help system.</span><br><span class="line">object?   -&gt; Details about &#x27;object&#x27;, use &#x27;object??&#x27; for extra details.</span><br><span class="line"></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> paramiko </span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: </span><br></pre></td></tr></table></figure>
<p>4、使用密码认证方式，通过exec_command()方法执行命令;   </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">➜  test cat paramiko_ssh.py </span><br><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line">hostname = <span class="string">&#x27;192.168.0.78&#x27;</span></span><br><span class="line">username = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;paramiko_test*5&#x27;</span></span><br><span class="line">paramiko.util.log_to_file(<span class="string">&#x27;syslogin.log&#x27;</span>) <span class="comment"># 发送paramiko 日志到syslog 文件</span></span><br><span class="line">ssh=paramiko.SSHClient() <span class="comment"># 创建一个ssh客户端 client对象</span></span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">ssh.load_system_host_keys()</span><br><span class="line"><span class="comment"># 获取客户端host_keys，默认 ~/.ssh/known_hosts</span></span><br><span class="line"><span class="comment">#ssh.load_system_host_keys(filname=&#x27;/Users/macbookdzsbe/.ssh/known_hosts&#x27;)  # 获取客户端host_keys，默认 ~/.ssh/known_hosts</span></span><br><span class="line"><span class="comment"># ssh.load_host_keys(filename=&#x27;/root/.ssh/known_hosts&#x27;)</span></span><br><span class="line">ssh.connect(hostname=hostname,username=username,password=password)<span class="comment"># 创建ssh连接</span></span><br><span class="line">stdin,stdout,stderr=ssh.exec_command(<span class="string">&#x27;netstat -tnlup&#x27;</span>) <span class="comment">#调用远程执行命令方法exec_command</span></span><br><span class="line"><span class="comment"># 打印命令执行结果，得到Pyhton列表形，可以使用stdout.readlines()</span></span><br><span class="line"><span class="built_in">print</span> stdout.read()</span><br><span class="line">stdin,stdout,stderr=ssh.exec_command(<span class="string">&#x27;date&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> stdout.readlines()</span><br><span class="line">ssh.close <span class="comment"># 关闭 ssh 连接</span></span><br><span class="line">➜  test python paramiko_ssh.py </span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">22</span>              <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">885</span>/sshd            </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">25</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">1341</span>/master         </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">18341</span>/mongod        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">3306</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">1266</span>/mysqld         </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">22</span>                   :::*                    LISTEN      <span class="number">885</span>/sshd            </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">25</span>                  :::*                    LISTEN      <span class="number">1341</span>/master         </span><br><span class="line">udp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">323</span>           <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*                           <span class="number">624</span>/chronyd         </span><br><span class="line">udp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">323</span>                 :::*                                <span class="number">624</span>/chronyd         </span><br><span class="line"></span><br><span class="line">[<span class="string">u&#x27;2018\u5e74 01\u6708 12\u65e5 \u661f\u671f\u4e94 16:50:33 CST\n&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>5、 paramiko 的核组件</p>
<blockquote>
<p>paramiko 包含两个核心组件，一个为SSHClient类，另一个为SFTPClient类 </p>
</blockquote>
<p>6、 SSHClient类 </p>
<blockquote>
<p>SSHClient类是SSH服务会话的高级表示，该类封装了传输(transport)、通道(channel)<br>及SFTPClient的检验、建立的方法，通常用于执行远程命令</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 例 </span></span><br><span class="line">client = SSHClient() </span><br><span class="line">client.load_system_host_keys()</span><br><span class="line">client.connect(<span class="string">&#x27;ssh.example.com&#x27;</span>)</span><br><span class="line">stdin, stdout, stderr = client.exec_command(<span class="string">&#x27;ls -l&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="SSHClient类方法使用"><a href="#SSHClient类方法使用" class="headerlink" title="SSHClient类方法使用"></a>SSHClient类方法使用</h2><p>1、 connect 方法</p>
<blockquote>
<p>connect 方法实现了远程SSH连接并检验</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法定义</span></span><br><span class="line">connect(self, hostname, port=<span class="number">22</span>, username=<span class="literal">None</span>, password=<span class="literal">None</span>, pkey=<span class="literal">None</span>,</span><br><span class="line">key_filename=<span class="literal">None</span>, timeout=<span class="literal">None</span>, allow_agent=<span class="literal">True</span>, look_for_keys=<span class="literal">True</span>, compress=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># hostname (str类型)，连接的目标主机地址；</span></span><br><span class="line"><span class="comment"># prot (int 类型)，连接目录主机的端口，默认为22;  </span></span><br><span class="line"><span class="comment"># username (str 类型), 校验的用户名 (默认为当前的本地用户名);  </span></span><br><span class="line"><span class="comment"># password (str 类型), 密码用于身份检验或解锁私钥; </span></span><br><span class="line"><span class="comment"># pkey (PKey 类型), 私钥方式用于身份难; </span></span><br><span class="line"><span class="comment"># key_filename(str or list(str) 类型),一个文件名或者文件名的列表，用于私钥的身份验证;</span></span><br><span class="line"><span class="comment"># timeout (float 类型),一个可选 的超时时间(以秒为单位)的TCP连接;</span></span><br><span class="line"><span class="comment"># allow_agent (bool 类型)，设置为False时用于禁用连接到SSH代理; </span></span><br><span class="line"><span class="comment"># look_for_keys (bool 类型)，设置False时用来禁用在~/.ssh中搜索私钥文件; </span></span><br><span class="line"><span class="comment"># compress (bool 类型), 设置为True时打开压缩</span></span><br></pre></td></tr></table></figure>
<p>2、 exec_command 方法</p>
<blockquote>
<p>远程命令执行方法，该命令的输入与输出流为标准输入(stdin)、输出(stdout)、错误(stderr)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法定义 </span></span><br><span class="line">exec_command(self, command, bufsize=<span class="number">-1</span>)</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># command (str 类型), 执行的命令串;</span></span><br><span class="line"><span class="comment"># bufsize (int 类型), 文件缓冲区大小，默认为-1（不局限）;</span></span><br></pre></td></tr></table></figure>
<p>3、loa_syste_host_keys 方法 </p>
<blockquote>
<p>加载本地公钥校验文件，默认为~/.ssh/known_hosts，非默认路径需要手工指定;  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">load_system_host_keys(self, filename=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">fiename(<span class="built_in">str</span>类型 ),指定远程主机公钥记录文件; </span><br></pre></td></tr></table></figure>
<p>4、 set_missing_host_key_policy 方法</p>
<blockquote>
<p>设置连接的远程主机没有本地主机密钥或HostKeys对象时的策略，目前支持三种<br>分别是 AutoAddPolicy、RejectPolicy(默认),WarnningPolicy，仅限于SSHClient类  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用方法如下</span></span><br><span class="line">ssh=paramiko.SSHClient() </span><br><span class="line">ssh.set_missing_host_keypolicy(paramiko.AutoAddPolicy)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AutoAddPolicy,自动添加主机名及主机密钥到本地HostKeys对象，并将其保存</span></span><br><span class="line"><span class="comment"># 不依赖load_system_host_keys()的配置，即使 ~/.ssh/known_hosts不存在也不产生影响  </span></span><br><span class="line"><span class="comment"># RejectPolicy,自动拒绝未知的主机名和密钥，依赖load_system_host_keys()的配置</span></span><br><span class="line"><span class="comment"># WarningPolicy,用于记录一个未知的主机密钥的Python警告并接受它，功能上与AutoAddPolicy相似</span></span><br><span class="line"><span class="comment"># 但区别在于，未知的主机会有警告</span></span><br></pre></td></tr></table></figure>
<h2 id="SFTPClient类"><a href="#SFTPClient类" class="headerlink" title="SFTPClient类"></a>SFTPClient类</h2><blockquote>
<p>SFTPClient 作为一个SFTP客户端对象,根据SSH传输协议的sftp会话，实现远客程文件操作<br>比如文件上传、下载、权限、状态等操作; </p>
</blockquote>
<p>1、 from_transport 方法</p>
<blockquote>
<p>创建一个已连接通的SFTP客户端通道;  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法定义 </span></span><br><span class="line">from_transport(cls, t)</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">t(Transport),一个已经通过验证的传输对象。</span><br><span class="line">t = paramiko.Transport((<span class="string">&quot;192.168.0.78&quot;</span>, <span class="number">22</span>))</span><br><span class="line">t.connect(username=<span class="string">&quot;root&quot;</span>,password=<span class="string">&quot;paramiko_test*5&quot;</span>)</span><br><span class="line">sftp =paramiko.SFTPClient.from_transport(t)</span><br></pre></td></tr></table></figure>
<p>2、 put 方法 </p>
<blockquote>
<p>上传本地文件到远程SFTP服务端;  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">put(self, localpath, remotepath, callback=<span class="literal">None</span>, confirm=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># localpath (str 类型)，需上传的本地文件(源);</span></span><br><span class="line"><span class="comment"># remotepath (str 类型),远程路径(目标); </span></span><br><span class="line"><span class="comment"># collback(functioin(int,int))，获取已接收的字字数及总传输字节数，以便回调函数高用,默认为None;  </span></span><br><span class="line"><span class="comment"># connfirm (bool类型),文件上传完毕后是否调用 stat()方法，以便确认文件的大小。 </span></span><br><span class="line">localpath=<span class="string">&#x27;/var/log/httpd/access.log&#x27;</span></span><br><span class="line">remotepath=<span class="string">&#x27;/data/bak/log/httpd/access.log&#x27;</span></span><br><span class="line">sftp.put(localpath,remotepath)</span><br></pre></td></tr></table></figure>
<p>3、 get方法</p>
<blockquote>
<p>从远程SFTP服务端下载文件到本地;  </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">get(self, remotepth, localpath, callbak=<span class="literal">None</span>)</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># remotepath (str类型)，需下载的远程文件 (源文件); </span></span><br><span class="line"><span class="comment"># localpath (str类型)，本地路径(目标);</span></span><br><span class="line"><span class="comment"># callback(function(int, int)),获取已接收的字节数及总传输字节数，以便回调函数及调用，默认为None</span></span><br><span class="line">remotepath=<span class="string">&#x27;/var/log/httpd/access.og&#x27;</span></span><br><span class="line">localpath=<span class="string">&#x27;/data/bak/log/httpd/access.log&#x27;</span></span><br><span class="line">sftp.get(remotepath,localpath)</span><br></pre></td></tr></table></figure>
<p>4、其他方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mkdir，在SFTP服务器端创建目录，如sftp.mkdir(<span class="string">&quot;/home/testdir&quot;</span>,<span class="number">0700</span>)</span><br><span class="line">remove, 删除SFTP服务端创指定目录，如sftp.remove(<span class="string">&quot;/home/testdir&quot;</span>)</span><br><span class="line">rename, 重命名SFTP服务器端文件或目录，如sftp.rename(<span class="string">&quot;/home/testdir&quot;</span>,<span class="string">&quot;/home/test&quot;</span>)</span><br><span class="line">state, 获取远程SFTP服务器指定文件信息，如sftp.stat(<span class="string">&quot;/home/test&quot;</span>) </span><br><span class="line">listdir, 获取远程SFTP服务器端指定目录列表, 以Python的(List)形式返回, 如sftp.listdir(<span class="string">&quot;/home&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>5、SFTPClient类应用示例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">username = <span class="string">&quot;root&quot;</span></span><br><span class="line">password = <span class="string">&quot;paramiko_test*5&quot;</span></span><br><span class="line">hostname = <span class="string">&quot;10.180.55.118&quot;</span></span><br><span class="line">port = <span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	t = paramiko.Transport((hostname, port))</span><br><span class="line">	t.connect(username=username, password=password)</span><br><span class="line">	sftp =paramiko.SFTPClient.from_transport(t)</span><br><span class="line">	</span><br><span class="line">	sftp.put(<span class="string">&quot;/tmp/next.vim.log&quot;</span>, <span class="string">&quot;/home/root/next.vim.log&quot;</span>) <span class="comment">#上传文件 </span></span><br><span class="line">	sftp.get(<span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;/tmp/hosts&quot;</span>) <span class="comment">#下载文件 </span></span><br><span class="line">	sftp.mkdir(<span class="string">&quot;/home/testdir&quot;</span>,<span class="number">0700</span>) <span class="comment">#创建文件 </span></span><br><span class="line">	sftp.rmdir(<span class="string">&quot;/home/root/test5.sql&quot;</span>) <span class="comment">#删除目录 </span></span><br><span class="line">	sftp.rename(<span class="string">&quot;/home/root/test1.sql&quot;</span>, <span class="string">&quot;/home/root/test5.sql&quot;</span>) <span class="comment">#文件重命名</span></span><br><span class="line">	<span class="built_in">print</span> sftp.stat(<span class="string">&quot;/home/root/test5.sql&quot;</span>) <span class="comment">#打印文件信息</span></span><br><span class="line">	<span class="built_in">print</span> sftp.listdir(<span class="string">&quot;/home/root&quot;</span>) <span class="comment"># 打印目录列表</span></span><br><span class="line">	t.close();</span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line">	<span class="built_in">print</span> <span class="built_in">str</span>(e)</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>自习之python基础语法</title>
    <url>/2018/01/07/%E8%87%AA%E4%B9%A0%E4%B9%8Bpython%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h1><h2 id="常量／变量"><a href="#常量／变量" class="headerlink" title="常量／变量"></a>常量／变量</h2><ul>
<li>字面常量 </li>
<li>变量<br>变量一个指针，它指向一块内存；</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">v = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>这样就定义了v这个变量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">v2 = v </span><br></pre></td></tr></table></figure>
<ul>
<li>变量的命名规则<br>1 只能包含字母、数字和下划线<br>2 只能以字母或者下划线开头<br>3 不能是Python解释器的保留字</li>
<li>不能以类似 for if in 来做变量名，加个后缀也可以使用。但不建议这样使用；  </li>
</ul>
<h2 id="运算符跟表达式"><a href="#运算符跟表达式" class="headerlink" title="运算符跟表达式"></a>运算符跟表达式</h2><ul>
<li><p>算术符<br>1 算术运算符<br>2 逻辑运算符<br>3 比较运算符<br>4 其它运算符 （赋值、成员运算符、身份运算符）</p>
</li>
<li><p>算术运算符<br>1 算术运算符通常只针对数值类型<br>1+1  3 * 5 3/5 3//5 5%3 2**4</p>
</li>
<li><p>比较运算符<br>1 == 相等<br>2 != 不等于<br>3 &gt; 大于<br>4 &gt;= 大于等于<br>5 &lt; 小于<br>6 &lt;= 小于等于</p>
</li>
</ul>
<p>比较运算，最好是让他的类型是相同的<br>除了  == 和 !=最好类型相同</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">float</span> (<span class="number">3</span>)/<span class="number">5</span> <span class="comment"># python2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>逻辑运算符 （参与运算的成员只能是bool类型，或者可以隐式转化为bool为类型的类型）<br>True False</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="literal">True</span> <span class="keyword">and</span> <span class="literal">True</span></span><br><span class="line">Out[<span class="number">1</span>]: <span class="literal">True</span></span><br><span class="line"><span class="comment"># and 需要运算符两边都是True结果才为True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="literal">True</span> <span class="keyword">or</span> <span class="literal">False</span></span><br><span class="line">Out[<span class="number">2</span>]: <span class="literal">True</span></span><br><span class="line"><span class="comment"># or 只要运算符两边任意一个为True,结果就是True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">3</span>]: <span class="keyword">not</span> <span class="literal">True</span></span><br><span class="line">Out[<span class="number">3</span>]: <span class="literal">False</span></span><br><span class="line"><span class="comment"># not 类似短路的</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">4</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y</span>):</span></span><br><span class="line">   ...:     print(<span class="string">&quot;&#123;0&#125; + &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(x,y))</span><br><span class="line">   ...:     <span class="keyword">return</span> x + y</span><br><span class="line">   ...: </span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: </span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: add(<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">3</span></span><br><span class="line">Out[<span class="number">5</span>]: <span class="number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &gt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">and</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line"><span class="number">2</span> + <span class="number">4</span></span><br><span class="line"><span class="number">3</span> + <span class="number">4</span></span><br><span class="line">Out[<span class="number">6</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &lt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">and</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="literal">False</span></span><br><span class="line"><span class="comment"># 总是从左到右的计算，一旦能够斛决定表达式的最终的值，将立刻停止计算</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &gt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">or</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line">Out[<span class="number">8</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &lt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">or</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line"><span class="number">2</span> + <span class="number">4</span></span><br><span class="line"><span class="number">3</span> + <span class="number">4</span></span><br><span class="line">Out[<span class="number">9</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">10</span>]: left =  add(<span class="number">1</span>,<span class="number">3</span>) &lt; add(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">11</span>]: right  = add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="number">2</span> + <span class="number">4</span></span><br><span class="line"><span class="number">3</span> + <span class="number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: left <span class="keyword">or</span> right</span><br><span class="line">Out[<span class="number">12</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<ul>
<li>位运算符</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">12</span>]: <span class="built_in">bin</span>(<span class="number">60</span>)</span><br><span class="line">Out[<span class="number">12</span>]: <span class="string">&#x27;0b111100&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">13</span>]: <span class="built_in">bin</span>(<span class="number">12</span>)</span><br><span class="line">Out[<span class="number">13</span>]: <span class="string">&#x27;0b1100&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">14</span>]: <span class="number">60</span> &amp; <span class="number">12</span></span><br><span class="line">Out[<span class="number">14</span>]: <span class="number">12</span></span><br><span class="line"><span class="comment"># 0011 1100</span></span><br><span class="line"><span class="comment"># 0000 1100</span></span><br><span class="line"><span class="comment"># 0000 1100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">15</span>]: <span class="number">60</span> | <span class="number">12</span></span><br><span class="line">Out[<span class="number">15</span>]: <span class="number">60</span></span><br><span class="line"><span class="comment"># 0011 1100</span></span><br><span class="line"><span class="comment"># 0000 1100</span></span><br><span class="line"><span class="comment"># 0011 1100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">16</span>]: <span class="number">60</span> ^ <span class="number">12</span></span><br><span class="line">Out[<span class="number">16</span>]: <span class="number">48</span></span><br><span class="line"><span class="comment"># 0011 1100</span></span><br><span class="line"><span class="comment"># 0000 1100</span></span><br><span class="line"><span class="comment"># 0011 0000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">18</span>]: <span class="built_in">int</span>(<span class="string">&#x27;0b110000&#x27;</span>,<span class="number">2</span>)</span><br><span class="line">Out[<span class="number">18</span>]: <span class="number">48</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">19</span>]: ~<span class="number">60</span></span><br><span class="line">Out[<span class="number">19</span>]: <span class="number">-61</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">20</span>]: <span class="number">60</span> &gt;&gt;<span class="number">2</span> </span><br><span class="line">Out[<span class="number">20</span>]: <span class="number">15</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">21</span>]: <span class="number">60</span> &lt;&lt;<span class="number">2</span></span><br><span class="line">Out[<span class="number">21</span>]: <span class="number">240</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">22</span>]: a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">23</span>]: a</span><br><span class="line">Out[<span class="number">23</span>]: <span class="number">1</span></span><br><span class="line"><span class="comment"># 左边是一个标实符  右边是一个值（或者可以计算为一个值）</span></span><br><span class="line"><span class="comment"># 让这个标实符指向这个值所在的内存</span></span><br><span class="line">In [<span class="number">24</span>]: a = <span class="number">3</span>+<span class="number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">25</span>]: a</span><br><span class="line">Out[<span class="number">25</span>]: <span class="number">7</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运算符的优先级  </li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">26</span>]: <span class="number">1</span>+<span class="number">2</span>*<span class="number">3</span></span><br><span class="line">Out[<span class="number">26</span>]: <span class="number">7</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">27</span>]: <span class="number">2</span> * <span class="number">3</span> **<span class="number">2</span></span><br><span class="line">Out[<span class="number">27</span>]: <span class="number">18</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">28</span>]: <span class="number">2</span> * <span class="number">3</span> &gt; <span class="number">1</span>+<span class="number">2</span></span><br><span class="line">Out[<span class="number">28</span>]: <span class="literal">True</span></span><br><span class="line"><span class="comment"># 算术运算符优先级高于比较运算符</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">29</span>]: <span class="number">2</span>* <span class="number">3</span> &gt; <span class="number">1</span>+<span class="number">2</span> <span class="keyword">and</span> <span class="literal">True</span></span><br><span class="line">Out[<span class="number">29</span>]: <span class="literal">True</span></span><br><span class="line"><span class="comment"># 比较运算符的优先级高于逻辑运算符</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">30</span>]: (<span class="number">2</span> * <span class="number">3</span> &gt; <span class="number">1</span>+<span class="number">2</span>) <span class="keyword">and</span> <span class="literal">True</span> </span><br><span class="line">Out[<span class="number">30</span>]: <span class="literal">True</span></span><br><span class="line"><span class="comment"># 拿不准的时候加括号，或者我们的代码表现力更清晰的时候</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">32</span>]: ((<span class="number">2</span>*<span class="number">3</span>) &gt; (<span class="number">1</span>+<span class="number">2</span>)) <span class="keyword">and</span> <span class="literal">True</span></span><br><span class="line">Out[<span class="number">32</span>]: <span class="literal">True</span></span><br><span class="line"><span class="comment"># 表达式由变量/常量 和运算符组成</span></span><br></pre></td></tr></table></figure>
<ul>
<li>程序控制结构</li>
</ul>
<blockquote>
<p>顺序<br>分支<br>循环</p>
</blockquote>
<ul>
<li>顺序结构</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">33</span>]: a = <span class="number">0</span></span><br><span class="line">In [<span class="number">34</span>]: a = a+<span class="number">1</span></span><br><span class="line">In [<span class="number">35</span>]: print(a)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>分支结构</li>
<li>单分支<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> cond:</span><br><span class="line">	block</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">36</span>]: <span class="keyword">if</span> <span class="number">1</span> &lt; <span class="number">2</span>:</span><br><span class="line">    ...:     <span class="built_in">print</span> (<span class="string">&#x27;1 less 2&#x27;</span>)</span><br><span class="line"><span class="number">1</span> less <span class="number">2</span></span><br><span class="line">In [<span class="number">37</span>]: <span class="keyword">if</span> <span class="number">1</span> &lt; <span class="number">2</span>:</span><br><span class="line">    ...:     <span class="built_in">print</span> (<span class="string">&#x27;1 less 2&#x27;</span>)</span><br><span class="line">    ...: <span class="built_in">print</span> (<span class="string">&#x27;main block&#x27;</span>)</span><br><span class="line"><span class="number">1</span> less <span class="number">2</span></span><br><span class="line">main block</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">39</span>]: <span class="built_in">bool</span>(<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">39</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">40</span>]: <span class="built_in">bool</span>(<span class="number">-0</span>)</span><br><span class="line">Out[<span class="number">40</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">41</span>]: <span class="built_in">bool</span>(<span class="number">1</span>)</span><br><span class="line">Out[<span class="number">41</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">42</span>]: <span class="built_in">bool</span>(<span class="literal">None</span>)</span><br><span class="line">Out[<span class="number">42</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">43</span>]: <span class="built_in">bool</span>([])</span><br><span class="line">Out[<span class="number">43</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">44</span>]: <span class="built_in">bool</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">Out[<span class="number">44</span>]: <span class="literal">False</span></span><br><span class="line"><span class="comment"># 0\空的内置结构\None bool的结构都是False,非0非空的内置结构都是True</span></span><br></pre></td></tr></table></figure>
<ul>
<li>双分支</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> cond:</span><br><span class="line">	true_block</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	false_block</span><br><span class="line"></span><br><span class="line">In [<span class="number">45</span>]: <span class="keyword">if</span> <span class="number">1</span>&lt;<span class="number">2</span>:</span><br><span class="line">    ...:     <span class="built_in">print</span> (<span class="string">&#x27;1&lt;2&#x27;</span>)</span><br><span class="line">    ...: <span class="keyword">else</span>:</span><br><span class="line">    ...:     <span class="built_in">print</span> (<span class="string">&#x27;2&lt;1&#x27;</span>)</span><br><span class="line">    ...:     </span><br><span class="line"><span class="number">1</span>&lt;<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cond:</span><br><span class="line">	true_block</span><br><span class="line"><span class="keyword">elif</span> cond:</span><br><span class="line">	true_block</span><br><span class="line"><span class="keyword">elif</span> cond:</span><br><span class="line">	true_block</span><br><span class="line"><span class="keyword">elif</span> cond:</span><br><span class="line">	true_block</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	false_block</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: a = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: <span class="keyword">if</span> a &lt; <span class="number">0</span>:</span><br><span class="line">   ...:     <span class="built_in">print</span> (<span class="string">&#x27;less 0&#x27;</span>)</span><br><span class="line">   ...: <span class="keyword">elif</span> a &lt; <span class="number">3</span>:</span><br><span class="line">   ...:     <span class="built_in">print</span> (<span class="string">&#x27;less 3&#x27;</span>)</span><br><span class="line">   ...: <span class="keyword">elif</span> a &lt; <span class="number">5</span>:</span><br><span class="line">   ...:     <span class="built_in">print</span> (<span class="string">&#x27;less 5&#x27;</span>)</span><br><span class="line">   ...: <span class="keyword">elif</span> a &lt; <span class="number">7</span>:</span><br><span class="line">   ...:     <span class="built_in">print</span> (<span class="string">&#x27;less 7&#x27;</span>)</span><br><span class="line">   ...: <span class="keyword">else</span>:</span><br><span class="line">   ...:     <span class="built_in">print</span> (<span class="string">&#x27;oops&#x27;</span>)</span><br><span class="line">   ...:     </span><br><span class="line">less <span class="number">7</span></span><br><span class="line"><span class="comment"># 分支结构永远只有一个分支可执行；</span></span><br></pre></td></tr></table></figure>
<ul>
<li>循环有while for 两种语句</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> cond:</span><br><span class="line">	block</span><br><span class="line">	</span><br><span class="line">In [<span class="number">8</span>]: <span class="keyword">while</span> a &lt; <span class="number">10</span>:</span><br><span class="line">   ...:     print(a)</span><br><span class="line">   ...:     a +=<span class="number">1</span> <span class="comment"># a = a + 1</span></span><br><span class="line">   ...:     </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="comment"># 通常在while循环中，循环体只需要修改条件，以使得条件为假</span></span><br><span class="line">In [<span class="number">34</span>]: i = <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">In [<span class="number">35</span>]: s =<span class="number">0</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">36</span>]: <span class="keyword">while</span> i &lt;= <span class="number">100</span>:</span><br><span class="line">    ...:     s +=i</span><br><span class="line">    ...:     i +=<span class="number">1</span></span><br><span class="line">    ...:     <span class="built_in">print</span> (s)</span><br><span class="line">    ...: </span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> itrator:</span><br><span class="line">	block</span><br><span class="line">In [<span class="number">26</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    ...:     <span class="built_in">print</span> (i)</span><br><span class="line">    ...:     </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">In [<span class="number">38</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    ...:     <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">    ...:         <span class="built_in">print</span> (i)</span><br><span class="line">    ...:         </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">for</span>  i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">   ...:     <span class="keyword">if</span> i &gt; <span class="number">3</span>:</span><br><span class="line">   ...:         <span class="keyword">break</span></span><br><span class="line">   ...:     <span class="built_in">print</span> (i)</span><br><span class="line">   ...:     </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="comment"># break 用于提前结束循环；</span></span><br><span class="line">In [<span class="number">3</span>]: <span class="keyword">for</span>  i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">   ...:     <span class="keyword">if</span> i == <span class="number">3</span>:</span><br><span class="line">   ...:         <span class="keyword">continue</span></span><br><span class="line">   ...:     <span class="built_in">print</span> (i)</span><br><span class="line">   ...:     </span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="comment"># continue 用于跳过之后的语句</span></span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>自习之python环境初准备</title>
    <url>/2018/01/07/%E8%87%AA%E4%B9%A0%E4%B9%8Bpython%E7%8E%AF%E5%A2%83%E5%88%9D%E5%87%86%E5%A4%87/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h2><ul>
<li>安装Python解释器</li>
<li>管理Python版本 </li>
<li>管理Python虚拟环境<br>相当于一个独立的版本,是bash写的一个程序，所以没有依赖；</li>
</ul>
<ul>
<li>pyenv github地址</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/yyuu/pyenv-installer</span><br></pre></td></tr></table></figure>
<ul>
<li>苹果系统安装pyenv</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash</span></span><br><span class="line"><span class="comment"># sudo vim /etc/bashrc</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/Users/ssjinyao/.pyenv/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span></span><br><span class="line"><span class="comment"># source  /etc/bashrc</span></span><br></pre></td></tr></table></figure>
<ul>
<li>linux系统安装pyenv </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash</span></span><br><span class="line"><span class="comment"># vim /etc/profile.d/pyenv.sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/Users/ssjinyao/.pyenv/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>安装一个python的依赖（CentOS）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum -y install. gcc make patch gdbm-devel openssl-devel sqlite-devel zlib-devel bzip2-devel readline-devel</span></span><br><span class="line"><span class="comment"># 注：在不同的linux系统上安装包的名字不一样</span></span><br></pre></td></tr></table></figure>
<ul>
<li>pyenv安装一个python版本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pyenv update #用来更新pyenv</span></span><br><span class="line"><span class="comment"># pyenv install 3.5.2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>切换python 3.5.3</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> 3.5.2</span><br><span class="line">bogon:~ ssjinyao$ pyenv version</span><br><span class="line">3.5.2 (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</span><br><span class="line">bogon:~ ssjinyao$ cat .python-version </span><br><span class="line">3.5.2</span><br></pre></td></tr></table></figure>
<ul>
<li>切换python到系统版本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> system</span><br><span class="line">bogon:~ ssjinyao$ pyenv version</span><br><span class="line">system (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</span><br></pre></td></tr></table></figure>
<ul>
<li>切换全局python变量（希望永远不要执行）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pyenv global x.x.x</span></span><br></pre></td></tr></table></figure>
<h2 id="使用pyenv"><a href="#使用pyenv" class="headerlink" title="使用pyenv"></a>使用pyenv</h2><ul>
<li><p>local 命令<br>local 命令切换当前目录及其子目录的Python版本<br>如何恢复，可以通过删除 ‘.python-version’恢复默认的Python版本</p>
</li>
<li><p>global 命令<br>global命令切换全局默认python版本</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bogon:~ ssjinyao$ pyenv commands</span><br><span class="line">--version</span><br><span class="line">activate</span><br><span class="line">commands</span><br><span class="line">completions</span><br><span class="line">deactivate</span><br><span class="line">doctor</span><br><span class="line"><span class="built_in">exec</span></span><br><span class="line">global</span><br><span class="line"><span class="built_in">help</span></span><br><span class="line">hooks</span><br><span class="line">init</span><br><span class="line">install</span><br><span class="line">installer</span><br><span class="line"><span class="built_in">local</span></span><br><span class="line">offline-installer</span><br><span class="line">prefix</span><br><span class="line"><span class="built_in">rehash</span></span><br><span class="line">root</span><br><span class="line">shell</span><br><span class="line">shims</span><br><span class="line">uninstall</span><br><span class="line">update</span><br><span class="line">version</span><br><span class="line">version-file</span><br><span class="line">version-file-read</span><br><span class="line">version-file-write</span><br><span class="line">version-name</span><br><span class="line">version-origin</span><br><span class="line">versions</span><br><span class="line">virtualenv</span><br><span class="line">virtualenv-delete</span><br><span class="line">virtualenv-init</span><br><span class="line">virtualenv-prefix</span><br><span class="line">virtualenvs</span><br><span class="line"><span class="built_in">whence</span></span><br><span class="line"><span class="built_in">which</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bogon:~ ssjinyao$ pyenv  virtualenv 3.5.2 magedu</span><br><span class="line">Ignoring indexes: https://pypi.python.org/simple</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): setuptools <span class="keyword">in</span> /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu/lib/python3.5/site-packages</span><br><span class="line">Requirement already satisfied (use --upgrade to upgrade): pip <span class="keyword">in</span> /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu/lib/python3.5/site-packages  </span><br><span class="line">bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> 3.5.2/envs/magedu </span><br><span class="line">(3.5.2/envs/magedu) bogon:~ ssjinyao$ </span><br><span class="line">(3.5.2/envs/magedu) bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> 3.5.2</span><br><span class="line">bogon:~ ssjinyao$ </span><br><span class="line">bogon:~ ssjinyao$ ls -l ~/.pyenv/versions/ </span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x  7 ssjinyao  staff  238 11 19 10:30 3.5.2</span><br><span class="line">lrwxr-xr-x  1 ssjinyao  staff   49 11 19 10:35 magedu -&gt; /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bogon:~ ssjinyao$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.5.2 (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</span><br><span class="line">  3.5.2/envs/magedu</span><br><span class="line">  magedu</span><br><span class="line">bogon:~ ssjinyao$ pyenv uninstall magedu</span><br><span class="line">pyenv-virtualenv: remove /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu? y</span><br><span class="line">bogon:~ ssjinyao$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.5.2 (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>virtualenv 命令<br>创建虚拟环境 <code>pyenv virtualenv $bash_version $name</code></p>
</li>
<li><p>uninstall 命令<br>卸载某个版本，包括虚拟环境；</p>
</li>
</ul>
<h2 id="选择python版本时，可以这样选择"><a href="#选择python版本时，可以这样选择" class="headerlink" title="选择python版本时，可以这样选择"></a>选择python版本时，可以这样选择</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bogon:~ ssjinyao$ ls ~/.pyenv/versions/3.5.2/envs/magedu/bin/python</span><br><span class="line">/Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu/bin/python</span><br></pre></td></tr></table></figure>
<h2 id="vim-python插件（jedi）"><a href="#vim-python插件（jedi）" class="headerlink" title="vim python插件（jedi）"></a>vim python插件（jedi）</h2><h2 id="vim-python插件包-（maximum-awesome）"><a href="#vim-python插件包-（maximum-awesome）" class="headerlink" title="vim python插件包 （maximum-awesome）%"></a>vim python插件包 （maximum-awesome）%</h2>]]></content>
  </entry>
  <entry>
    <title>自习之 Linux HA Cluster 2</title>
    <url>/2018/01/03/Linux-HA-Cluster-2/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="温故而知新"><a href="#温故而知新" class="headerlink" title="温故而知新"></a>温故而知新</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Messaaging Layer:</span><br><span class="line">	heartbaet v1,v2,v3 </span><br><span class="line">	corosync v1, v2(votequorum)</span><br><span class="line">	OpenAIS</span><br><span class="line">CRM:</span><br><span class="line">	pacemaker 需要一个配置接口</span><br><span class="line">		配置接口:crmsh (由SUSE研发的),由pssh管理工具来实现</span><br><span class="line">				 pcs (agent c/s ),pcsd来实现</span><br><span class="line">				 conga(ricci运行在各结点上的进程/luci发送指令到各节点)组成</span><br><span class="line">				 </span><br><span class="line">				 group,constraint(基于约束)</span><br><span class="line">				 </span><br><span class="line">				 rgmanager(cman)</span><br><span class="line">				 	resouce group(资源组):</span><br><span class="line">				 		failover domain</span><br><span class="line">RA:</span><br><span class="line">	LSB: /etc/rc.d/init.d</span><br><span class="line">	systemd: /etc/systemd/system/multi-user.wants</span><br><span class="line">		服务开机处于<span class="built_in">enable</span>状态;</span><br><span class="line">	OCF:[provider]</span><br><span class="line">		heartbeat</span><br><span class="line">		pacemaker </span><br><span class="line">		linbit 基于内核跨节点的块设备</span><br><span class="line">	service</span><br><span class="line">	stonith</span><br><span class="line">	高可用集群的可用方案:</span><br><span class="line">		heartbeat v1</span><br><span class="line">		heartbeat v2</span><br><span class="line">		heartbeat v3 + pacemaker X </span><br><span class="line">		corosync + pacemaker </span><br><span class="line">		cman + rgmanager </span><br><span class="line">		corosync + cman + pacemaker</span><br><span class="line">		keepalived</span><br></pre></td></tr></table></figure>
<h2 id="Linux-HA-Cluster-2"><a href="#Linux-HA-Cluster-2" class="headerlink" title="Linux-HA-Cluster 2"></a>Linux-HA-Cluster 2</h2><blockquote>
<p>Heartbeat集群之间传递心跳的方法<br>1、使用串型线缆<br>2、使用以太网通信<br>3、Unicast  单播，使用udpu，一般在不支持多播的网络中使用的<br>4、Mutlicast  多播/组播, 使用udp<br>5、Broadcast  广播，占用过高的网络资源    </p>
</blockquote>
<p>1、组播地址:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用于标识一个IP组播域:IANA把D类地址留给组播使用:224.0.0.0-239.255.255.255 </span><br><span class="line">永久组播地址:224.0.0.0-224.0.0.255</span><br><span class="line">临时组播地址:224.0.1.0-238.255.255.255  建议使用临时组播地址</span><br><span class="line">本地组播地址:239.0.0.0-239.255.255.255</span><br></pre></td></tr></table></figure>
<p>2、配置以组播方式进行高可用集群通信  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在Node1 和 Node2中执行</span></span><br><span class="line"><span class="comment"># yum -y install corosync pacemaker</span></span><br><span class="line"><span class="comment"># rpm -ql corosync #查看corosync安装完之后所生成的配置文件;</span></span><br><span class="line">/etc/corosync</span><br><span class="line">/etc/corosync/corosync.conf.example</span><br><span class="line">/etc/corosync/corosync.conf.example.udpu</span><br><span class="line">/etc/corosync/corosync.xml.example</span><br><span class="line">/etc/corosync/uidgid.d</span><br><span class="line">/etc/dbus-1/system.d/corosync-signals.conf</span><br><span class="line">/etc/logrotate.d/corosync</span><br><span class="line">/etc/sysconfig/corosync</span><br><span class="line">/etc/sysconfig/corosync-notifyd</span><br><span class="line">/usr/bin/corosync-blackbox</span><br><span class="line">/usr/bin/corosync-xmlproc</span><br><span class="line">/usr/lib/systemd/system/corosync-notifyd.service</span><br><span class="line">/usr/lib/systemd/system/corosync.service</span><br><span class="line">/usr/sbin/corosync</span><br><span class="line">/usr/sbin/corosync-cfgtool</span><br><span class="line">/usr/sbin/corosync-cmapctl</span><br><span class="line">/usr/sbin/corosync-cpgtool</span><br><span class="line">/usr/sbin/corosync-keygen</span><br><span class="line">/usr/sbin/corosync-notifyd</span><br><span class="line">/usr/sbin/corosync-quorumtool</span><br><span class="line">/usr/share/corosync</span><br><span class="line">/usr/share/corosync/corosync</span><br><span class="line">/usr/share/corosync/corosync-notifyd</span><br><span class="line">/usr/share/corosync/xml2conf.xsl</span><br><span class="line">/usr/share/doc/corosync-2.4.0</span><br><span class="line">/usr/share/doc/corosync-2.4.0/LICENSE</span><br><span class="line">/usr/share/doc/corosync-2.4.0/SECURITY</span><br><span class="line">/usr/share/man/man5/corosync.conf.5.gz</span><br><span class="line">/usr/share/man/man5/corosync.xml.5.gz</span><br><span class="line">/usr/share/man/man5/votequorum.5.gz</span><br><span class="line">/usr/share/man/man8/cmap_keys.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-blackbox.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-cfgtool.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-cmapctl.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-cpgtool.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-keygen.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-notifyd.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-quorumtool.8.gz</span><br><span class="line">/usr/share/man/man8/corosync-xmlproc.8.gz</span><br><span class="line">/usr/share/man/man8/corosync.8.gz</span><br><span class="line">/usr/share/man/man8/corosync_overview.8.gz</span><br><span class="line">/usr/share/snmp/mibs/COROSYNC-MIB.txt</span><br><span class="line">/var/lib/corosync</span><br><span class="line">/var/<span class="built_in">log</span>/cluster</span><br><span class="line"><span class="comment"># rpm -ql pacemaker #查看pacemaker所生成的配置文件;</span></span><br><span class="line">/etc/sysconfig/pacemaker</span><br><span class="line">/usr/lib/ocf/resource.d/.isolation</span><br><span class="line">/usr/lib/ocf/resource.d/.isolation/docker-wrapper</span><br><span class="line">/usr/lib/ocf/resource.d/pacemaker/controld</span><br><span class="line">/usr/lib/ocf/resource.d/pacemaker/remote</span><br><span class="line">/usr/lib/systemd/system/pacemaker.service</span><br><span class="line">/usr/libexec/pacemaker/attrd</span><br><span class="line">/usr/libexec/pacemaker/cib</span><br><span class="line">/usr/libexec/pacemaker/cibmon</span><br><span class="line">/usr/libexec/pacemaker/crmd</span><br><span class="line">/usr/libexec/pacemaker/lrmd</span><br><span class="line">/usr/libexec/pacemaker/lrmd_internal_ctl</span><br><span class="line">/usr/libexec/pacemaker/pengine</span><br><span class="line">/usr/libexec/pacemaker/stonith-test</span><br><span class="line">/usr/libexec/pacemaker/stonithd</span><br><span class="line">/usr/sbin/crm_attribute</span><br><span class="line">/usr/sbin/crm_master</span><br><span class="line">/usr/sbin/crm_node</span><br><span class="line">/usr/sbin/pacemakerd</span><br><span class="line">/usr/sbin/stonith_admin</span><br><span class="line">/usr/share/doc/pacemaker-1.1.16</span><br><span class="line">/usr/share/doc/pacemaker-1.1.16/COPYING</span><br><span class="line">/usr/share/doc/pacemaker-1.1.16/ChangeLog</span><br><span class="line">/usr/share/licenses/pacemaker-1.1.16</span><br><span class="line">/usr/share/licenses/pacemaker-1.1.16/GPLv2</span><br><span class="line">/usr/share/man/man7/crmd.7.gz</span><br><span class="line">/usr/share/man/man7/ocf_pacemaker_controld.7.gz</span><br><span class="line">/usr/share/man/man7/ocf_pacemaker_remote.7.gz</span><br><span class="line">/usr/share/man/man7/pengine.7.gz</span><br><span class="line">/usr/share/man/man7/stonithd.7.gz</span><br><span class="line">/usr/share/man/man8/crm_attribute.8.gz</span><br><span class="line">/usr/share/man/man8/crm_master.8.gz</span><br><span class="line">/usr/share/man/man8/crm_node.8.gz</span><br><span class="line">/usr/share/man/man8/pacemakerd.8.gz</span><br><span class="line">/usr/share/man/man8/stonith_admin.8.gz</span><br><span class="line">/usr/share/pacemaker/alerts</span><br><span class="line">/usr/share/pacemaker/alerts/alert_file.sh.sample</span><br><span class="line">/usr/share/pacemaker/alerts/alert_smtp.sh.sample</span><br><span class="line">/usr/share/pacemaker/alerts/alert_snmp.sh.sample</span><br><span class="line">/var/lib/pacemaker/cib</span><br><span class="line">/var/lib/pacemaker/pengine</span><br></pre></td></tr></table></figure>
<p>2、配置corosync  </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /etc/corosync/</span></span><br><span class="line"><span class="comment"># cp corosync.conf.example </span></span><br><span class="line"><span class="comment"># cp corosync.conf.example corosync.conf</span></span><br><span class="line"><span class="comment"># 某些环境中可能不支持组播。这时应该配置Corosync使用单播;  </span></span><br><span class="line"><span class="comment"># 下面是使用单播的Corosync 配置文件的一部分;</span></span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">		 <span class="comment">#...</span></span><br><span class="line">		 interface &#123;</span><br><span class="line">		 		ringnumber: 0</span><br><span class="line">		 		bindnetaddr: 10.180.22.0</span><br><span class="line">		 		broadcast: yes (1) </span><br><span class="line">		 		mcastport: 5405</span><br><span class="line">		 &#125;</span><br><span class="line">		 interface &#123;</span><br><span class="line">		 		ringnumber: 1 </span><br><span class="line">		 		bindnetaddr: 10.180.22.0</span><br><span class="line">		 		brodcast: yes</span><br><span class="line">		 		mcastport: 5405</span><br><span class="line">		 &#125;</span><br><span class="line">		 transport: udpu (2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist&#123; (3)</span><br><span class="line">		node &#123;</span><br><span class="line">					ring0_addr: 10.180.22.166</span><br><span class="line">					ring1_addr:10.180.55.1</span><br><span class="line">					nodedid: 1</span><br><span class="line">		&#125;</span><br><span class="line">		node &#123; </span><br><span class="line">					ring0_addr: 10.180.22.167</span><br><span class="line">					ring1_addr: 10.180.55.2</span><br><span class="line">					nodeid: 2</span><br><span class="line">	 	&#125;</span><br><span class="line"><span class="comment"># 如果将 broadcast 设置为yes,集群心跳将通过广播实现。设置该参数时,不能设置mcastaddr;</span></span><br><span class="line"><span class="comment"># transport 配置项决定集群通信方式，要完全禁用组播，应该配置单播传输参数 udpu;</span></span><br><span class="line"><span class="comment"># 这要求将所有的节点服务器信息写入nodelist;</span></span><br><span class="line"><span class="comment"># 也就是需要在配置HA 集群之前确定节点组成。默认配置是udp。 通信方式类型还支持udpu和iba;</span></span><br><span class="line"><span class="comment"># 在nodelist 之下可以为栽一节点设置只与该节点相关的信息，这些设置项只能包含在node之中;</span></span><br><span class="line"><span class="comment"># 即只能对属于集群的节点服务器进行设置，而且只应包括那些与默认设置不同的参数;</span></span><br><span class="line"><span class="comment"># 每台服务器都必需配置 ring0_addr; </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实验中配置信息如下</span></span><br><span class="line"><span class="comment"># Please read the corosync.conf.5 manual page</span></span><br><span class="line">totem &#123;</span><br><span class="line">	version: 2</span><br><span class="line"></span><br><span class="line">	<span class="comment"># crypto_cipher and crypto_hash: Used for mutual node authentication.</span></span><br><span class="line">	<span class="comment"># If you choose to enable this, then do remember to create a shared</span></span><br><span class="line">	<span class="comment"># secret with &quot;corosync-keygen&quot;.</span></span><br><span class="line">	<span class="comment"># enabling crypto_cipher, requires also enabling of crypto_hash.</span></span><br><span class="line">	crypto_cipher: aes128</span><br><span class="line">	crypto_hash: sha1</span><br><span class="line">	secauth: on</span><br><span class="line">	<span class="comment"># interface: define at least one interface to communicate</span></span><br><span class="line">	<span class="comment"># over. If you define more than one interface stanza, you must</span></span><br><span class="line">	<span class="comment"># also set rrp_mode.</span></span><br><span class="line">	interface &#123;</span><br><span class="line">                <span class="comment"># Rings must be consecutively numbered, starting at 0.</span></span><br><span class="line">		ringnumber: 0</span><br><span class="line">		<span class="comment"># This is normally the *network* address of the</span></span><br><span class="line">		<span class="comment"># interface to bind to. This ensures that you can use</span></span><br><span class="line">		<span class="comment"># identical instances of this configuration file</span></span><br><span class="line">		<span class="comment"># across all your cluster nodes, without having to</span></span><br><span class="line">		<span class="comment"># modify this option.</span></span><br><span class="line">		bindnetaddr: 10.180.0.0</span><br><span class="line">		<span class="comment"># However, if you have multiple physical network</span></span><br><span class="line">		<span class="comment"># interfaces configured for the same subnet, then the</span></span><br><span class="line">		<span class="comment"># network address alone is not sufficient to identify</span></span><br><span class="line">		<span class="comment"># the interface Corosync should bind to. In that case,</span></span><br><span class="line">		<span class="comment"># configure the *host* address of the interface</span></span><br><span class="line">		<span class="comment"># instead:</span></span><br><span class="line">		<span class="comment"># bindnetaddr: 192.168.1.1</span></span><br><span class="line">		<span class="comment"># When selecting a multicast address, consider RFC</span></span><br><span class="line">		<span class="comment"># 2365 (which, among other things, specifies that</span></span><br><span class="line">		<span class="comment"># 239.255.x.x addresses are left to the discretion of</span></span><br><span class="line">		<span class="comment"># the network administrator). Do not reuse multicast</span></span><br><span class="line">		<span class="comment"># addresses across multiple Corosync clusters sharing</span></span><br><span class="line">		<span class="comment"># the same network.</span></span><br><span class="line">		mcastaddr: 239.185.1.31</span><br><span class="line">		<span class="comment"># Corosync uses the port you specify here for UDP</span></span><br><span class="line">		<span class="comment"># messaging, and also the immediately preceding</span></span><br><span class="line">		<span class="comment"># port. Thus if you set this to 5405, Corosync sends</span></span><br><span class="line">		<span class="comment"># messages over UDP ports 5405 and 5404.</span></span><br><span class="line">		mcastport: 5405</span><br><span class="line">		<span class="comment"># Time-to-live for cluster communication packets. The</span></span><br><span class="line">		<span class="comment"># number of hops (routers) that this ring will allow</span></span><br><span class="line">		<span class="comment"># itself to pass. Note that multicast routing must be</span></span><br><span class="line">		<span class="comment"># specifically enabled on most network routers.</span></span><br><span class="line">		ttl: 1</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist&#123; </span><br><span class="line">		node &#123;</span><br><span class="line">			ring0_addr: 10.180.22.166</span><br><span class="line">			nodedid: 1</span><br><span class="line">		&#125;</span><br><span class="line">		node &#123; </span><br><span class="line">			ring0_addr: 10.180.22.167</span><br><span class="line">			nodeid: 2</span><br><span class="line">	   &#125;</span><br><span class="line">	   node &#123;</span><br><span class="line">	   		ring0_addr: 10.180.22.168</span><br><span class="line">	   		nodeid: 3</span><br><span class="line">	   &#125;</span><br><span class="line">	 &#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	<span class="comment"># Log the source file and line where messages are being</span></span><br><span class="line">	<span class="comment"># generated. When in doubt, leave off. Potentially useful for</span></span><br><span class="line">	<span class="comment"># debugging.</span></span><br><span class="line">	fileline: off</span><br><span class="line">	<span class="comment"># Log to standard error. When in doubt, set to no. Useful when</span></span><br><span class="line">	<span class="comment"># running in the foreground (when invoking &quot;corosync -f&quot;)</span></span><br><span class="line">	to_stderr: no</span><br><span class="line">	<span class="comment"># Log to a log file. When set to &quot;no&quot;, the &quot;logfile&quot; option</span></span><br><span class="line">	<span class="comment"># must not be set.</span></span><br><span class="line">	to_logfile: yes</span><br><span class="line">	logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">	<span class="comment"># Log to the system log daemon. When in doubt, set to yes.</span></span><br><span class="line">	to_syslog: no</span><br><span class="line">	<span class="comment"># Log debug messages (very verbose). When in doubt, leave off.</span></span><br><span class="line">	debug: off</span><br><span class="line">	<span class="comment"># Log messages with time stamps. When in doubt, set to on</span></span><br><span class="line">	<span class="comment"># (unless you are only logging to syslog, where double</span></span><br><span class="line">	<span class="comment"># timestamps can be annoying).</span></span><br><span class="line">	timestamp: on</span><br><span class="line">	logger_subsys &#123;</span><br><span class="line">		subsys: QUORUM</span><br><span class="line">		debug: off</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line">	<span class="comment"># Enable and configure quorum subsystem (default: off)</span></span><br><span class="line">	<span class="comment"># see also corosync.conf.5 and votequorum.5</span></span><br><span class="line">	provider: corosync_votequorum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成密钥文件  </span></span><br><span class="line"><span class="comment"># corosync-keygen</span></span><br><span class="line"><span class="comment"># scp -p authkey coronsync.conf root@node2.ssjinyao.com:/etc/corosync</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># corosync 启动集群投票系统默认必需需要三人结点;</span></span><br><span class="line"><span class="comment"># systemctl start corosync.serivce #这个时候启动是失败的;</span></span><br><span class="line"><span class="comment"># systemctl status corosync.serivce #查看corosync的状态信息;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时需要开启另一个结点</span></span><br><span class="line"><span class="comment"># yum -y install corosync pacemaker </span></span><br><span class="line"><span class="comment"># Node1 中执行</span></span><br><span class="line"><span class="comment"># scp -p  /etc/coronsync.conf /etc/authkey root@node2.ssjinyao.com:/etc/corosync</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3、验证结点 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># corosync-cfgtool -s  # 验证结点</span><br><span class="line"># corosync-cmapctl  #查看结点间的信息;</span><br><span class="line"># grep -v &#39;^[[:space:]]*#&#39; &#x2F;etc&#x2F;corosync.conf  # 保存实用的配置示例</span><br></pre></td></tr></table></figure>
<p>4、编辑pacemaker</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># vim &#x2F;etc&#x2F;sysconfig&#x2F;pacemaker</span><br><span class="line">PCMK_logfile&#x3D; &#x2F;var&#x2F;log&#x2F;pacemaker.log</span><br><span class="line"># 各个节点间需要启动pacemaker</span><br><span class="line"># systemctl start pacemaker.service</span><br><span class="line"># crm_mon  # 进行验证</span><br></pre></td></tr></table></figure>
<p>5、 crm 工具的使用简明 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># crm_node -n  # 查看当前节点信息</span><br><span class="line"># crm_node -l  # 例出集群所有的节点信息</span><br><span class="line"># crm_verify -L -V # 但看报错信息</span><br><span class="line"># crm shell 的安装与使用，若无rpm包，可在网上找相关的rpm包</span><br><span class="line"># yum -y install crmsh pssh python-pssh </span><br></pre></td></tr></table></figure>
<h2 id="HA-Web-Service"><a href="#HA-Web-Service" class="headerlink" title="HA Web Service"></a>HA Web Service</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	vip: 10.180.xx.xxx, ocf:hearbeat:IPaddr </span><br><span class="line">	httpd: systemd </span><br><span class="line">	nfs shared storage: ocf:heartbeat:Filesystem</span><br><span class="line">Ha Cluster 工作模型:</span><br><span class="line">	A&#x2F;P: 两节点集群; active&#x2F;apsslve;</span><br><span class="line">		without-quorum-policy&#x3D;(stop|ignore|suicide|freeze)</span><br><span class="line">	A&#x2F;A: </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># node0 </span><br><span class="line"># mkdir -pv  &#x2F;www&#x2F;htdocs </span><br><span class="line"># echo &quot;&lt;h1&gt; Test Page on NFS Server&lt;&#x2F;h1&gt;&quot; &gt; &#x2F;www&#x2F;htdocs&#x2F;index.html</span><br><span class="line"># vim &#x2F;etc&#x2F;exports </span><br><span class="line">&#x2F;www&#x2F;htdocs 10.180.xx.xxx&#x2F;16(rw)</span><br><span class="line"># iptables -L -n  # 查看是否有防火墙规则</span><br><span class="line"># checkconfig nfs on </span><br><span class="line"># systemctl start nfs</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># node 1 </span><br><span class="line"># showmount -e 10.180.xx.xxx</span><br><span class="line"># mount -t nfs 10.180.xx.xxx:&#x2F;www&#x2F;htdocs &#x2F;var&#x2F;www&#x2F;html # 挂载网络存储NFS </span><br><span class="line"># systemctl start httpd </span><br><span class="line"># systemctl enable httpd</span><br><span class="line"># 此时便可以查看能否可以能否访问到以上的测试信息</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># node 2 </span><br><span class="line"># systemctl start httpd </span><br><span class="line"># systemctl enabl httpd  </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># crm configure </span><br><span class="line">crm(live)configure# show</span><br><span class="line">crm(live)# configure property </span><br><span class="line">crm(live)# configure property stonith-enabled&#x3D;false</span><br><span class="line">crm(live)# configrue verify </span><br><span class="line">crm(live)# show </span><br><span class="line">crm(live)# configure commit</span><br><span class="line">crm(live)# configure </span><br><span class="line">crm(live)configure# primitive webip ocf:heartbeat:IPaddr2 params ip&#x3D;&quot;10.180.xx.xxx&quot; op monitor interval&#x3D;30s timeout&#x3D;20s</span><br><span class="line">crm(live)# configure show </span><br><span class="line">crm(live)# configure commit</span><br><span class="line">crm(live)# configure edit  # 可以打开vim编辑配置文件 </span><br><span class="line">crm(live)# configure verify</span><br><span class="line">crm(live)# configure primitive webstore ocf:heartbat:Filesystem params device&#x3D;&quot;10.180.xx.xxx:&#x2F;www&#x2F;htdocs&quot; directory&#x3D;&quot;&#x2F;var&#x2F;www&#x2F;html&quot; fstype&#x3D;&quot;nfs&quot; op start timeout&#x3D;60s op stop timeout&#x3D;60s op monitor interval&#x3D;20s timeout&#x3D;40s </span><br><span class="line">crm(live)# configure verify</span><br><span class="line">crm(live)configure# colocation webserver_with_webstore_and_webip inf: webserver </span><br><span class="line">( webip webstore )</span><br><span class="line">crm(live)# show xmls # 查看xml格式的配置</span><br><span class="line">crm(live)configure# order webstore_afer_webip Mandatory: webip webstore</span><br><span class="line">crm(live)configure# order webserver_after_webstore Manadatory: webstore webserver </span><br><span class="line">crm(live)configure# verify </span><br><span class="line">crm(live)configure# commit </span><br><span class="line">crm(live)configure# location webservice_perf_node1 webip 100: node1.ssjinao.com</span><br><span class="line">crm(live)configure# verify </span><br><span class="line">crm(live)configure# commit</span><br><span class="line"></span><br><span class="line">crom(live)configure# property default-resource-sticklines &#x3D; 50</span><br><span class="line"></span><br><span class="line"># systemctl stop httpd.service </span><br><span class="line"># systemctl enable httpd.service </span><br><span class="line"># crm_verify -V -L</span><br><span class="line"># crm node standby  </span><br><span class="line"># crm onde online</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>自习之Linux HA Cluster</title>
    <url>/2018/01/01/Linux-HA-Cluster/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="Linux-HA-Cluster"><a href="#Linux-HA-Cluster" class="headerlink" title="Linux HA Cluster"></a>Linux HA Cluster</h2><h2 id="一、理论介绍"><a href="#一、理论介绍" class="headerlink" title="一、理论介绍"></a>一、理论介绍</h2><blockquote>
<p>LB,HA,HP,hadoop  </p>
</blockquote>
<p>1、LB（负载均衡）:  </p>
<blockquote>
<p>传输层:lvs<br>应用层:nginx,haproxy,httpd,perlbal,ats,varnish   </p>
</blockquote>
<p>2、HA(高可用）:</p>
<blockquote>
<p>vrrp: keepalived<br>HA Cluster: heartbeat,OpenAIS corosync/pacemaker,cman,RHCS（红帽集群套件）<br>corosync/pacemaker,cman  是从 OpenAIS中独立出来的  </p>
</blockquote>
<p>3、HA:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">故障场景:  </span><br><span class="line">硬件故障:设计缺陷，使用过久自然损坏，人为故障  </span><br><span class="line">软件故障:设计缺陷，bug,人为误操作  </span><br><span class="line">A(可用性)=MTBF[平均无故障时间]/(MTBF[平均无故障时间]+MTTR[平均修复时间])  </span><br><span class="line">MTBF:Mean Time Between Failre</span><br><span class="line">MTTR:Mean Time To Repair  </span><br><span class="line">可用性区间:0&lt;A&lt;1  </span><br><span class="line">百分比:90%,95%,99%  </span><br><span class="line">通常会用几个9来衡量可用性    </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">提供冗余: </span><br><span class="line">    Messaging Layer (同可用结构间的信息传递层)  </span><br><span class="line">    Resource Manager (在Messaging Layer之上，管理多个资源)  </span><br><span class="line">    Local Resource Manager (在Resource Messaging Layer之上，决定在哪个结点上启动服务)  </span><br><span class="line">    <span class="built_in">local</span> Resource agent: 四种基本功能(start,stop,restart,status)  </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">network partition: 发生了网络分区  </span><br><span class="line">隔离：  </span><br><span class="line">	STONITH: shoot the other node on the head (节点级别的隔离)  </span><br><span class="line">	Fence:资源级别的隔离  </span><br><span class="line">	通过交换机断掉网络，或者通过电源交换机，把服务器的电源停丢  </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">集群节点必须大于半数，而非等于  </span><br><span class="line">或者加一个仲裁设备  </span><br><span class="line">高可用节点，只能有一个节点是工作的状态  </span><br><span class="line">但可以在多个节点上，配置出来多个服务，N-M模型  </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">failover domain: </span><br><span class="line">故障转移域 </span><br><span class="line">	fda: node1,node5  </span><br><span class="line">	fdb: node2,node5 </span><br><span class="line">	fdc: node3,node5 </span><br><span class="line">	fdd: node4,node5 </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">资源的约束性:</span><br><span class="line">	位置约束，资源对节点的倾向性; </span><br><span class="line">	排列约束，资源彼此间是否能运行于同一节点的倾向性； </span><br><span class="line">	顺序约束，多个资源启动顺序依赖关系； </span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vote system:</span><br><span class="line">	少数服从多数:quorum </span><br><span class="line">			with quorum:拥有法定票数，( &gt; total/2 )</span><br><span class="line">			without quorum:不拥有法定票数  </span><br><span class="line">	两个节点(偶数个节点):</span><br><span class="line">		Ping node </span><br><span class="line">		qdisk 		</span><br><span class="line">	failover (资源将要转移出去)</span><br><span class="line">	failback (资源将要转移回来)</span><br></pre></td></tr></table></figure>
<p>4、Messaging Layer:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">heartbeat,</span><br><span class="line">	v1</span><br><span class="line">	v2</span><br><span class="line">	v3</span><br><span class="line">corosync,cman</span><br></pre></td></tr></table></figure>
<p>5、Cluster Resource Manager (CRM):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">heartbeat v1 haresources (配置接口:配置文件[haresources])</span><br><span class="line">heartbeat v2 crm（在每个节点运行一个crmd守护进程（5560/tcp），有命令行接口[crmsh],很大程度上需要编辑xml的配置文件）; GUI;hb_gui</span><br><span class="line">heartbeat v3 pacemaker (心跳启读器) （配置接口:crmsh,pcs;GUI: hawk(suse),LCMC,pacemaker-gui)</span><br><span class="line">rgmanager （配置文件:cluster.conf,system-config-cluster,conga（webgui）, cman_tool, clustat,）</span><br></pre></td></tr></table></figure>
<p>6、组合方式: </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">heartbeat v1 (haresources)</span><br><span class="line">heartbeat v2 (crm)</span><br><span class="line">heartbeat v3 + pacemaker </span><br><span class="line">heartbeat + pacemaker</span><br><span class="line">corosync + pacemaker </span><br><span class="line">	corosync v1 + pacemaker (plugin)</span><br><span class="line">	corosync v2 + pacemaker (standalone service)</span><br><span class="line">cman + rgmanger </span><br><span class="line">CentOS 6 cman + pacemaker  </span><br><span class="line">CentOS 6 (corosync v1 + cman +pacemaker) </span><br><span class="line">RHCS: Red Hat Cluster Suite</span><br><span class="line">	RHEL5: cman + rgmanager + conga (ricci/luci)</span><br><span class="line">	RHEL6: cman + rgmanager + conga (ricci/luci)</span><br><span class="line">			corosync + pacemaker </span><br><span class="line">			corosync + cman + pacemaker </span><br><span class="line">	RHEL7: corosync + pacemaker </span><br></pre></td></tr></table></figure>
<p>7、资源代理: </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Resource Agent:</span><br><span class="line">	hearteat legacy: /etc/ha.d/haresources.d/目录下的脚本；</span><br><span class="line">	LSB: /etc/rc.d/init.d/ 目录下的脚本；</span><br><span class="line">	OCF: Open Cluster Framework;</span><br><span class="line">		provider: </span><br><span class="line">	STONITH设备:</span><br><span class="line">	Systemctl: </span><br></pre></td></tr></table></figure>
<p>8、资源类型: </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">primitive: 主资源，原始资源:在集群中只能运行一个实例;</span><br><span class="line"><span class="built_in">clone</span>:克隆资源，在集群中可以运行多个实例: </span><br><span class="line">	匿名克隆，全局惟一克隆、状态克隆(主动、被动)</span><br><span class="line">multi-state(master/slave);克隆资源的特殊实现;多状态资源:</span><br><span class="line">group: 组资源:</span><br><span class="line">	启动或停止:</span><br><span class="line">	资源监视;</span><br><span class="line">	相关性;</span><br><span class="line">资源属性:</span><br><span class="line">	priority:优先级;</span><br><span class="line">	target-role:started,stopped,master 目标角色;</span><br><span class="line">	is-managed:是否允许群集管理此资源;</span><br><span class="line">	resource-stickiness: 资源粘性; </span><br><span class="line">	allow-migrate:是否允许资源迁移;</span><br><span class="line">约束:score</span><br><span class="line">	位置约束:资源对节点的倾向性；</span><br><span class="line">		(-oo,+oo)</span><br><span class="line">			任何值+无穷大=无穷大</span><br><span class="line">			任何值+负无穷大=负无穷大</span><br><span class="line">			无穷大+负无穷大=负无穷大</span><br><span class="line">	排列约束:资源彼此间是否能运行同一节点的倾向性;</span><br><span class="line">		(-oo,+oo)</span><br><span class="line">	顺序的约束:多个资源启动顺序依赖关系;</span><br><span class="line">		(-oo,+oo)</span><br><span class="line">			Mandatory</span><br></pre></td></tr></table></figure>
<h2 id="二、安装配置"><a href="#二、安装配置" class="headerlink" title="二、安装配置"></a>二、安装配置</h2><p>1、 CentOS 7: corosync v2 + pacemaker<br>        corosync v2: vote system<br>        pacemaker:独立服务<br>    集群的全生命周期管理工具:<br>        pcs: agent(pcsd)<br>        crmsh : agentless (pssh)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum info pcs </span></span><br></pre></td></tr></table></figure>
<p>2、集群配置前提</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">a、时间同步;</span><br><span class="line">b、基于当前正在使用的主机名互相访问; </span><br><span class="line">c、是否会用到仲裁设备; </span><br><span class="line">e、双机互信</span><br></pre></td></tr></table></figure>
<p>3.1安装并启动pcsd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/hosts </span></span><br><span class="line">xx.xxx.xx.xxx node1.ssjinyao.com</span><br><span class="line">xx.xxx.xx.xxx node2.ssjinyao.com</span><br><span class="line"><span class="comment"># scp /etc/hosts root@node2.ssjinyao.com:/etc/</span></span><br><span class="line"><span class="comment"># date ; ssh root@node2.ssjinyao.com &#x27;date&#x27; #查看两个节点服务器时间是否一致</span></span><br><span class="line"><span class="comment"># ntpdate date.xxx.com #若服务器时间不同步，则同步服务器的时间</span></span><br><span class="line"></span><br><span class="line">Node1 AND Node2</span><br><span class="line"><span class="comment"># yum install -y pacemaker pcs psmisc policycoreutils-python</span></span><br><span class="line"><span class="comment"># 也可以 yum insetall -y pcs </span></span><br><span class="line"><span class="comment"># systemctl start pcsd.service </span></span><br><span class="line"><span class="comment"># systemctl enable pcsd.service </span></span><br></pre></td></tr></table></figure>
<p>3.2 各节点统一执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/ansible</span></span><br><span class="line">[ha]</span><br><span class="line">node1.ssjinyao.com</span><br><span class="line">node2.ssjinyao.com</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Node1 AND Node2</span><br><span class="line"><span class="comment"># ansible ha -m service -a &quot;name=pcsd state=started enabled=yes&quot;</span></span><br><span class="line"><span class="comment"># systemctl status pcsd </span></span><br><span class="line"><span class="comment"># ansible ha -m shell -a &#x27;echo &quot;xxxxxx&quot; | passwd --stdin hacluster&#x27; </span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pcs help </span></span><br><span class="line"><span class="comment"># pcs cluster --help </span></span><br><span class="line"><span class="comment"># pcs cluster auth node1.ssjinyao.com node2.ssjinyao.com -u hacluster # pcs认证通过</span></span><br><span class="line"><span class="comment"># pcs cluster setup --name jycluster node1.ssjinyao.com node2.ssjinyao.com</span></span><br><span class="line"><span class="comment"># cd /etc/corosync/</span></span><br><span class="line"><span class="comment"># cat corosync.conf </span></span><br><span class="line"><span class="comment"># 注 totem是专门传递集群间的心跳信息;</span></span><br><span class="line">     nodelist 集群中目前存的节点;</span><br><span class="line">     quorum 法定票数的投票机制; corosync_votequorum; </span><br><span class="line"><span class="comment"># cd /etc/corosync/ &amp;&amp; cat corosync.conf.example.udpu # 醒看集群配置实例; </span></span><br><span class="line"><span class="comment"># vim corosync.conf </span></span><br><span class="line">修改 loggin</span><br><span class="line">logging &#123;</span><br><span class="line">to_logfile:yes </span><br><span class="line">logfile: /var/<span class="built_in">log</span>/cluster/corosync.log </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># scp corosync.conf node2.ssjinyao.com:/etc/corosync/</span></span><br></pre></td></tr></table></figure>
<p>3.3 启动集群 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Node1 Or Node2 </span><br><span class="line"><span class="comment"># pcs cluster  start --all </span></span><br><span class="line"><span class="comment"># corosync-cfgtool --help </span></span><br><span class="line">检查各节点通信状态(显示为no faults即为OK):</span><br><span class="line"><span class="comment"># corosync-cfgtool -s </span></span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 1 </span><br><span class="line">RING ID 0 </span><br><span class="line">	 id = xx.xxx.xx.xxx</span><br><span class="line">	 status = ring 0 active with no faults s</span><br><span class="line">同时也可以在node2.ssjinyao.com上查看节点状态 </span><br><span class="line">检查集群成员关及Quorum API:</span><br><span class="line"><span class="comment"># corosync-cmapctl | grep members </span></span><br><span class="line"><span class="comment"># pcs staus corosync </span></span><br><span class="line"><span class="comment"># pcs staus </span></span><br><span class="line">查看pcs资源可配置选项有哪些</span><br><span class="line"><span class="comment"># pcs property list --all</span></span><br><span class="line">查看pcs配置是否存在问题</span><br><span class="line"><span class="comment"># crm_verify -L -V  </span></span><br><span class="line"><span class="comment"># pcs property se stonith-enabled=false </span></span><br><span class="line"><span class="comment"># pcs property list </span></span><br><span class="line"><span class="comment"># crm_verify -L -V </span></span><br></pre></td></tr></table></figure>
<p>3.4 crmsh 下载并安装 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget crmsh-2.1.4.x86_64.rpm </span></span><br><span class="line"><span class="comment"># wget pssh-2.3.1-4.2.x86_64.rpm</span></span><br><span class="line"><span class="comment"># wget python-pssh-2.3.1-4.2.x86_64.rpm</span></span><br><span class="line"><span class="comment"># yum install -y *rpm </span></span><br><span class="line">注 crmsh 找一个结点安装就可以，当然两个节点可以都安装 </span><br><span class="line">	pssh 是并行执行ssh命令</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crm help </span></span><br><span class="line"><span class="comment"># crm status </span></span><br><span class="line"><span class="comment"># crm 可以直接进入交互式接口 </span></span><br><span class="line"><span class="comment"># help start </span></span><br><span class="line">&gt;crm(live)node<span class="comment"># configure </span></span><br><span class="line">&gt;crm(live)configure<span class="comment"># help </span></span><br><span class="line">&gt;crm(live)configure<span class="comment"># show</span></span><br><span class="line">&gt;crm(live)configure<span class="comment"># edit </span></span><br></pre></td></tr></table></figure>
<p>3.5 利用crmsh配置一个web serice:<br>        vip:10.180.xxx.xx<br>        httpd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Node1 AND Node2</span><br><span class="line"><span class="comment"># yum -y install httpd </span></span><br><span class="line">Node1</span><br><span class="line"><span class="comment"># echo &quot;&lt;h1&gt;node1.ssjinyao.com&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span></span><br><span class="line"><span class="comment"># systemctl enabled httpd </span></span><br><span class="line">注:对于CentOS 6 来说必需要禁用 </span><br><span class="line"><span class="comment"># systemctl stop httpd  </span></span><br><span class="line">Node2 </span><br><span class="line"><span class="comment"># echo &quot;&lt;h1&gt;nodd2.ssjinyao.com&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span></span><br><span class="line"><span class="comment"># systemctl enabled httpd </span></span><br><span class="line"><span class="comment"># systemctl stop httpd  </span></span><br><span class="line">测试服务器可以访问后，再将httpd服务停止</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crm    或者 # crm ra </span></span><br><span class="line">&gt;crm(live)<span class="comment"># ra</span></span><br><span class="line">&gt;crm(live)ra<span class="comment"># list systemd</span></span><br><span class="line">&gt;crm(live)ra<span class="comment"># list ocf heartbeat </span></span><br><span class="line">&gt;crm(live)ra<span class="comment"># info ocf:heartbeat:IPaddr </span></span><br><span class="line">&gt;crm(live)ra<span class="comment"># info ocf:heartbeat:IPaddr </span></span><br><span class="line">&gt;crm(live)ra<span class="comment"># cd ..</span></span><br><span class="line">&gt;crm(live)<span class="comment"># configure </span></span><br><span class="line">&gt;crm(live)configure<span class="comment"># primitive webip ocf:heartbeat:IPaddr params ip=10.xxx.xx.xxx</span></span><br><span class="line">&gt;crm(live)<span class="comment"># status </span></span><br><span class="line"><span class="comment"># ifconfig 可以看到资源已经配置好了 </span></span><br><span class="line">把当前结点变成备用模式</span><br><span class="line">&gt;crm(live)node<span class="comment"># standby # 软下线</span></span><br><span class="line">&gt;crm(live)node<span class="comment"># status</span></span><br><span class="line">&gt;crm(live)<span class="comment"># node only</span></span><br><span class="line">&gt;crm(live)<span class="comment"># configure </span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># primitive webserver systemd:httpd</span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># verify</span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># commit </span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># group</span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># grouop webservice webip webserivce </span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># verfy</span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># commit </span></span><br><span class="line"><span class="comment"># crm node standby </span></span><br><span class="line">注:可以查看web请求的反回内容，与资源定义情况;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># crm node onlie </span></span><br><span class="line"><span class="comment"># crm </span></span><br><span class="line">&gt;crm(live) <span class="comment"># configure</span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># verify</span></span><br><span class="line"><span class="comment"># crm status </span></span><br><span class="line"><span class="comment"># systemctl stop  pacemaker.service corosync.serivce </span></span><br><span class="line"><span class="comment"># crm status </span></span><br><span class="line">在CentOS 6的情况下，假如将服务器直接关机后，会造成 partition with quorum </span><br><span class="line"><span class="comment"># crm configure </span></span><br><span class="line">&gt;crm(live)configure <span class="comment"># property no-quorum-policy=ignore</span></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>python自动化之admin自动切换root</title>
    <url>/2017/12/07/python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Badmin%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2root/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="python自动化之admin自动切换root"><a href="#python自动化之admin自动切换root" class="headerlink" title="python自动化之admin自动切换root"></a>python自动化之admin自动切换root</h2><blockquote>
<p>ssh登录系统，如果是非root帐号(普通帐号)登录采取行动，则su切换到root</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/env/bin python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># des:ssh登录系统，如果是非root帐号(普通帐号)登录采取行动，则su切换到root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python 的SSHV2 protocol协议实现，用于python调用各种ssh功能;</span></span><br><span class="line"><span class="keyword">import</span> paramiko </span><br><span class="line"><span class="comment"># python内置时间模块</span></span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line"></span><br><span class="line"><span class="comment">#根据用户名密码从普通用户揽权到root用记执行给定命令</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssh_su_root</span>(<span class="params">ip,username,password,root_pwd,cmd</span>):</span></span><br><span class="line"><span class="comment">#建立SSHClient对象</span></span><br><span class="line">    myssh = paramiko.SSHClient()</span><br><span class="line"><span class="comment">#设置自动接收公钥</span></span><br><span class="line">    myssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"><span class="comment">#使用给定用户名密码尝试连接服务器</span></span><br><span class="line">         myssh.connect(ip, <span class="number">22</span>, username=username, password=password, timeout=<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception, ex:</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">str</span>(ex)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># 如果默认root不允许远程登录，提供的是普通用户帐号+root帐号,</span></span><br><span class="line">    <span class="comment">#则调用invoke_shell,使用交互式shell方式切换同到root帐号，并执行命令。</span></span><br><span class="line">    <span class="keyword">if</span> username != <span class="string">&#x27;root&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;I am NOT root&quot;</span></span><br><span class="line">        ssh = myssh.invoke_shell()</span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br><span class="line">        ssh.send(<span class="string">&#x27;su -\n&#x27;</span>)</span><br><span class="line">        buff = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#循环检测密码输入提示，出现后发送root口令，</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> (buff.endswith(<span class="string">&#x27;Password:&#x27;</span>) <span class="keyword">or</span> buff.endswith(<span class="string">&#x27;密码: &#x27;</span>)):</span><br><span class="line">    <span class="comment">#从接收缓存中读入最多9999bytes数据。</span></span><br><span class="line">            resp = ssh.recv(<span class="number">9999</span>)</span><br><span class="line">            buff += resp </span><br><span class="line">        ssh.send(root_pwd)</span><br><span class="line">        ssh.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        buff = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#循环检测#提示符，出现后执行传入的命令。</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> buff.endwith(<span class="string">&#x27;# &#x27;</span>):</span><br><span class="line">            resp = ssh.recv(<span class="number">9999</span>)</span><br><span class="line">            buff += resp </span><br><span class="line">        ssh.send[cmd]</span><br><span class="line">        ssh.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        buff =<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#循环检测#提示符，意味着命令执行完成，出现后关闭ssh连接并输出结果。</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> buff.endswith(<span class="string">&#x27;# &#x27;</span>):</span><br><span class="line">            resp = ssh.recv(<span class="number">9999</span>)</span><br><span class="line">            buff += resp</span><br><span class="line">        myssh.close()</span><br><span class="line">        result = buff</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;su root result ---&gt;&quot;</span>,result </span><br><span class="line"></span><br><span class="line">        myssh.close()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    <span class="comment">#如果提供的是root帐号，则直接调用paramiko exec_command 方法，执行命令。</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;I am root&quot;</span></span><br><span class="line">        stdin, stdout, stderr = myssh.exec_command(cmd)</span><br><span class="line">        stdin,write(<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;stdout.readlines() ---&gt;&quot;</span>, stdout.readlines()</span><br><span class="line">        myssh.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cmd = <span class="string">&#x27;date&#x27;</span></span><br><span class="line">    ip = <span class="string">&#x27;xx.xxx.xx.xxx&#x27;</span></span><br><span class="line">    username = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    password = <span class="string">&#x27;xxxxxxxxxx&#x27;</span></span><br><span class="line">    ssh_su_root(ip, username, password, <span class="string">&#x27;xxxxxxxxxxxx&#x27;</span>, cmd)</span><br><span class="line">    username = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">    ssh_su_root(ip, username, password, <span class="string">&#x27;xxxxxxxxxxxx&#x27;</span>, cmd)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>安全加固</title>
    <url>/2017/12/03/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h1><h2 id="安全加固脚本V1"><a href="#安全加固脚本V1" class="headerlink" title="安全加固脚本V1"></a>安全加固脚本V1</h2><ul>
<li>用来做iptables ssh地址白名单限制</li>
<li>openssh-server ssh用户白名单限制</li>
<li>更改登录欢迎信息为警告信息</li>
<li>应用根目录权限最小化</li>
<li>zabbix agent安装配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#定义一个函数，程序由前往后执行，次顺序非常重要，一不小心会将自己拒在外面，遇到这种情况让规则失效的处理方式是重启服器，或者从阿里云接接口接入清空规则，可选后者；</span></span><br><span class="line"><span class="comment">#注zabbix(xxx.xx.xxx.xx)\xx.xx.xx.xxx主机不加入iptables规则 </span></span><br><span class="line"><span class="function"><span class="title">IP_TABLES</span></span> () &#123;</span><br><span class="line">	/sbin/iptables -A INPUT -p tcp --dport 22 -s xxx.xxx.xx.xx -j ACCEPT <span class="comment">#首先放行 xxx.xxx.xxx.xxx 我们内网路由地址</span></span><br><span class="line">	/sbin/iptables -A INPUT -p tcp --dport 22 -s xxx.xxx.xx.xx -j ACCEPT <span class="comment">#放行备用地址 xxx.xxx.xx.xxx 同时也是我们的zabbix地址</span></span><br><span class="line">	/sbin/iptables -A INPUT -p tcp --dport 22 -s xxx.xxx.xx.xx  -j ACCEPT <span class="comment">#此服务器为我们闲置的一台服务器</span></span><br><span class="line">	/sbin/iptables -A INPUT -p tcp --dport 22 -j DROP <span class="comment">#丢弃所有对22号端口的请求</span></span><br><span class="line">	iptables -vnL <span class="comment">#查看防火墙设置</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#添加唯一可以登录服务器的用户</span></span><br><span class="line"><span class="function"><span class="title">SSH_INIT</span></span> () &#123;</span><br><span class="line">	useradd xxxxxxxx <span class="comment">#添加用户</span></span><br><span class="line">	cp -a /etc/skel /home/xxxxxxxx</span><br><span class="line">	chown -R xxxxxxxx.xxxxxxxx /home/TransferEasyd0--01 </span><br><span class="line">	usermod -s /bin/bash xxxxxxxx </span><br><span class="line">	PASS=<span class="string">&#x27;xxxxxxxxxx&#x27;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;xxxxxxxx:<span class="variable">$PASS</span>&quot;</span> | chpasswd <span class="comment">#给用户设置密码 </span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;AllowUsers xxxxxxxx&quot;</span> &gt;&gt; /etc/ssh/sshd_config <span class="comment">#添加白名单到sshd_config中</span></span><br><span class="line">	service  ssh restart   <span class="comment">#重启服务器</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#Web根目录权限最小化</span></span><br><span class="line"><span class="function"><span class="title">PY_INIT</span></span> () &#123;</span><br><span class="line">chmod 700 /home/admin/</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">WEB_INIT</span></span> () &#123;</span><br><span class="line">	chown www-data.www-data  /var/www/html &amp;&amp; chmod 700 /var/www/html <span class="comment">#设置启动用户和用启动组都为www-data用户，设置所有者权限读\写\执行; 所属组0; 其它人0;</span></span><br><span class="line">	usermod -s /sbin/nologin www-data  <span class="comment">#完全禁止www-data用户登录</span></span><br><span class="line">	cat /etc/passwd | grep --color www-data  <span class="comment">#查看修改登录 </span></span><br><span class="line">	ls -ld /var/www/html 					 <span class="comment">#查看修改权限</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#更改欢迎信息为警告信息</span></span><br><span class="line"><span class="function"><span class="title">MO_TD</span></span> () &#123;</span><br><span class="line">	[ -e /etc/.motd.bak ] || cp /etc/motd /etc/.motd.bak</span><br><span class="line">	cat &lt;&lt;<span class="string">EOF &gt; /etc/motd</span></span><br><span class="line"><span class="string">非xxxxxxxx管理人员请勿登录系统，否则后果自负</span></span><br><span class="line"><span class="string">非xxxxxxxx管理人员请勿登录系统，否则后果自负</span></span><br><span class="line"><span class="string">Non xxxxxxxx administrators are not allowed to log on to the system, otherwise they may be affected</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">	[ -e /etc/update-motd.d/.00-header.bak ] || cp /etc/update-motd.d/00-header /etc/update-motd.d/.00-header.bak</span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /etc/update-motd.d/00-header</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string">[ -r /etc/lsb-release ] &amp;&amp; . /etc/lsb-release</span></span><br><span class="line"><span class="string">if [ -z &quot;$DISTRIB_DESCRIPTION&quot; ] &amp;&amp; [ -x /usr/bin/lsb_release ]; then</span></span><br><span class="line"><span class="string"># Fall back to using the very slow lsb_release utility</span></span><br><span class="line"><span class="string">DISTRIB_DESCRIPTION=$(lsb_release -s -d)</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">printf &quot;xxxxxxxx %s (%s %s %s)\n&quot; &quot;$DISTRIB_DESCRIPTION&quot; &quot;$(uname -o)&quot; &quot;$(uname -r)&quot; &quot;$(uname -m)&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">	[ -e /etc/.lsb-release.bak ] || cp /etc/lsb-release /etc/.lsb-release.bak</span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /etc/lsb-release </span></span><br><span class="line"><span class="string">DISTRIB_ID=CentOS</span></span><br><span class="line"><span class="string">DISTRIB_RELEASE=10000</span></span><br><span class="line"><span class="string">DISTRIB_CODENAME=trusty</span></span><br><span class="line"><span class="string">DISTRIB_DESCRIPTION=&quot;CentOS 1000&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">ZAB_BBIX</span></span> () &#123;</span><br><span class="line">   apt-get install zabbix-agent </span><br><span class="line">	mv /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak</span><br><span class="line">	cp /home/admin/zabbix_agentd.conf /etc/zabbix/</span><br><span class="line">	cp /home/admin/zabbix_agentd.conf /tmp</span><br><span class="line">	service zabbix-agent restart </span><br><span class="line">&#125;</span><br><span class="line">IP_TABLES</span><br><span class="line">SSH_INIT</span><br><span class="line">PY_INIT</span><br><span class="line">WEB_INIT</span><br><span class="line">MO_TD</span><br><span class="line">ZAB_BBIX</span><br></pre></td></tr></table></figure>
<h2 id="对应回滚脚本"><a href="#对应回滚脚本" class="headerlink" title="对应回滚脚本"></a>对应回滚脚本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#安全加固后，服务器如有问题时的回滚方案；</span></span><br><span class="line"><span class="function"><span class="title">IP_TABLES_F</span></span> () &#123;</span><br><span class="line">	iptables -F</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">SSH_INIT_F</span></span> () &#123;</span><br><span class="line">	sed -i <span class="string">&#x27;s/AllowUsers xxxxxxxx//g&#x27;</span> /etc/ssh/sshd_config</span><br><span class="line">	userdel xxxxxxxx</span><br><span class="line">	service ssh restart</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">WEB_INIT_F</span></span> () &#123;</span><br><span class="line">	chmod 700 /var/www/html</span><br><span class="line">	chown admin.admin /var/www/html</span><br><span class="line">	usermod -s /sbin/<span class="literal">false</span> www-data</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">PY_INIT_F</span></span> () &#123;</span><br><span class="line">	chmod 700 /home/admin</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">MO_TD_F</span></span>() &#123;</span><br><span class="line">	rm -rf /etc/motd</span><br><span class="line">	mv /etc/.motd.bak /etc/motd</span><br><span class="line">	rm -rf /etc/update-motd.d/00-header</span><br><span class="line">	mv  /etc/update-motd.d/.00-header.bak /etc/update-motd.d/00-header</span><br><span class="line">	rm -rf /etc/lsb-release</span><br><span class="line">	mv /etc/.lsb-release.bak /etc/lsb-release</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">ZA_BBIX_F</span></span> () &#123;</span><br><span class="line">	service zabbix-agent stop</span><br><span class="line">	apt-get remove zabbix-agent</span><br><span class="line">	rm -rf /etc/zabbix/</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IP_TABLES_F</span><br><span class="line">SSH_INIT_F</span><br><span class="line">WEB_INIT_F</span><br><span class="line">MO_TD_F</span><br><span class="line">ZA_BBIX_F</span><br><span class="line">PY_INIT_F</span><br></pre></td></tr></table></figure>
<h1 id="对无agent探针的RDS网络监控"><a href="#对无agent探针的RDS网络监控" class="headerlink" title="对无agent探针的RDS网络监控"></a>对无agent探针的RDS网络监控</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#用户RDS通知及报警</span></span><br><span class="line"><span class="comment">#作者：任锦</span></span><br><span class="line"><span class="comment">#RDS_IP=&quot;localhost&quot;</span></span><br><span class="line">RDS_IP=<span class="string">&quot;www.xxxxxxxx.com&quot;</span></span><br><span class="line"><span class="function"><span class="title">TOOL_S</span></span> () &#123; </span><br><span class="line">    rpm -qa nc &amp;&gt; /dev/null || yum -y install nc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ON_LINE</span></span> () &#123;</span><br><span class="line">    DATE=`date | awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span> | cut -d<span class="string">&quot;:&quot;</span> -f3`</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span> |nc -w 5 <span class="variable">$RDS_IP</span> 3306 &amp;&gt; /dev/null || STATP=<span class="string">&quot;RDS 服务器已经停止了运行，请您尽快来处理 😰  😰  😰  😰  😰  😰  &quot;</span></span><br><span class="line">        <span class="comment">#echo $STATP</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">WEI_XIN</span></span> () &#123;</span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$STATP</span>&quot;</span> --user=xxx@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$STATP</span>&quot;</span> --user=xxx2@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$STATP</span>&quot;</span> --user=xxx3@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$STATP</span>&quot;</span> --user=xxx4@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> sleep 60 ; <span class="keyword">do</span> </span><br><span class="line">TOOL_S</span><br><span class="line">ON_LINE</span><br><span class="line">WEI_XIN </span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="除线上zabbix多角度的监控网络状态"><a href="#除线上zabbix多角度的监控网络状态" class="headerlink" title="除线上zabbix多角度的监控网络状态"></a>除线上zabbix多角度的监控网络状态</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">HOSTS</span></span> ()  &#123;</span><br><span class="line">        CN=<span class="string">&#x27;xxx.xxx.xxx.xxx xxx.xxx.xx.xx.xxx xxx.xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx&#x27;</span></span><br><span class="line">        HK=<span class="string">&#x27;xxx.xxx.xxx.xxx xxx.xxx.xx.xx.xxx xxx.xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx&#x27;</span></span><br><span class="line">        XN=<span class="string">&#x27;xxx.xxx.xxx.xxx xxx.xxx.xx.xx.xxx xxx.xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">MESSAGES</span></span> () &#123;</span><br><span class="line">        OK_MESSAGES_CN=<span class="string">&#x27;阿里云xx区域ECS主机网络正常&#x27;</span></span><br><span class="line">        OK_MESSAGES_HK=<span class="string">&#x27;阿里云xx区域ECS主机网络正常&#x27;</span></span><br><span class="line">        OK_MESSAGES_XN=<span class="string">&#x27;阿里云xx区域ECS主机网络正常&#x27;</span></span><br><span class="line">        CN_MES=<span class="string">&#x27;阿里云xx区域ECS主机网络不通！&#x27;</span></span><br><span class="line">        HK_MES=<span class="string">&#x27;阿里云xx区域ECS主机网络不通！&#x27;</span></span><br><span class="line">        XN_MES=<span class="string">&#x27;阿里云xx区域ECS主机网络不通！&#x27;</span></span><br><span class="line">        CN_MES_TIME=<span class="string">&quot;阿里云xx区域ECS主机网络超时较高，超时时间及丢包率为&quot;</span></span><br><span class="line">        HK_MES_TIME=<span class="string">&quot;阿里云xx区域ECS主机网络超时较高，超时时间及丢包率为&quot;</span></span><br><span class="line">        XN_MES_TIME=<span class="string">&quot;阿里云xx区域ECS主机网络超时较高，超时时间及丢包率为&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WEIXIN_E-<span class="function"><span class="title">MAIL_API</span></span> () &#123;</span><br><span class="line"><span class="comment">#       echo &quot;$1</span></span><br><span class="line"><span class="comment">#       $2&quot; | mutt -s &quot;Zabbix 报警&quot; xxx@xxxxxxxxxxx.com  xxx2.xxxxxxxxxxxx.com  xxx3@xxxxxxxxxxx.com</span></span><br><span class="line"></span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --</span><br><span class="line">corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$1</span></span></span><br><span class="line"><span class="string"><span class="variable">$2</span>&quot;</span> --user=xxx@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </span><br><span class="line"></span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$1</span></span></span><br><span class="line"><span class="string"><span class="variable">$2</span>&quot;</span> --user=xxx2@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </span><br><span class="line"></span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$1</span></span></span><br><span class="line"><span class="string"><span class="variable">$2</span>&quot;</span> --user=xxx3@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </span><br><span class="line"></span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;<span class="variable">$1</span></span></span><br><span class="line"><span class="string"><span class="variable">$2</span>&quot;</span> --user=xxx4@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </span><br><span class="line">&#125;</span><br><span class="line">HOSTS</span><br><span class="line">MESSAGES</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> HOSTS_NET_CN <span class="keyword">in</span> <span class="variable">$CN</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                STATE_CN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_CN</span> | tail -n 2 | head -n 1 | awk &#123;<span class="string">&#x27;print $6&#x27;</span>&#125;`</span><br><span class="line">                TIME_CN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_CN</span> | head -n 3 | tail -n2 | awk &#123;<span class="string">&#x27;print $7,$8&#x27;</span>&#125;`</span><br><span class="line">                <span class="keyword">if</span> ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_CN</span> &amp;&gt; /dev/null ;<span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OK_MESSAGES_CN</span> `date` <span class="variable">$HOSTS_NET_CN</span>  OK&quot;</span> &amp;&gt;&gt; /tmp/<span class="variable">$HOSTS_NET_CN</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        WEIXIN_E-MAIL_API <span class="string">&quot;<span class="variable">$CN_MES</span> `date` <span class="variable">$HOSTS_NET_CN</span> <span class="variable">$CN_MES_TIME</span> <span class="variable">$STATE_CN</span></span></span><br><span class="line"><span class="string">                        <span class="variable">$TIME_CN</span>&quot;</span> <span class="string">&quot;PROBLEM&quot;</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> HOSTS_NET_HK <span class="keyword">in</span> <span class="variable">$HK</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                STATE_HK=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_HK</span> | tail -n 2 | head -n 1 | awk &#123;<span class="string">&#x27;print $6&#x27;</span>&#125;`</span><br><span class="line">                TIME_HK=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_HK</span> | head -n 3 | tail -n2 | awk &#123;<span class="string">&#x27;print $7,$8&#x27;</span>&#125;`</span><br><span class="line">                <span class="keyword">if</span> ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_HK</span> &amp;&gt; /dev/null ; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OK_MESSAGES_HK</span> `date` <span class="variable">$HOSTS_NET_HK</span>  OK&quot;</span> &amp;&gt;&gt; /tmp/<span class="variable">$HOSTS_NET_HK</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        WEIXIN_E-MAIL_API <span class="string">&quot;<span class="variable">$HK_MES</span> `date` <span class="variable">$HOSTS_NET_HK</span> <span class="variable">$HK_MES_TIME</span> <span class="variable">$STATE_HK</span></span></span><br><span class="line"><span class="string">                <span class="variable">$TIME_HK</span>&quot;</span> <span class="string">&quot;PROBLEM&quot;</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> HOSTS_NET_XN <span class="keyword">in</span> <span class="variable">$XN</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                STATE_XN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_XN</span> | tail -n 2 | head -n 1 | awk &#123;<span class="string">&#x27;print $6&#x27;</span>&#125;`</span><br><span class="line">                TIME_XN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_XN</span> | head -n 3 | tail -n2 | awk &#123;<span class="string">&#x27;print $7,$8&#x27;</span>&#125;`</span><br><span class="line">                <span class="keyword">if</span> ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_XN</span> &amp;&gt; /dev/null ; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$OK_MESSAGES_XN</span> `date` <span class="variable">$HOSTS_NET_XN</span>  OK&quot;</span> &amp;&gt;&gt; /tmp/<span class="variable">$HOSTS_NET_XN</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        WEIXIN_E-MAIL_API <span class="string">&quot;<span class="variable">$XN_MES</span> `date` <span class="variable">$HOSTS_NET_XN</span> <span class="variable">$XN_MES_TIME</span> <span class="variable">$STATE_XN</span></span></span><br><span class="line"><span class="string">                <span class="variable">$TIME_XN</span>&quot;</span> <span class="string">&quot;PROBLEM&quot;</span></span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="将对应的脚本加入定时计划"><a href="#将对应的脚本加入定时计划" class="headerlink" title="将对应的脚本加入定时计划"></a>将对应的脚本加入定时计划</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab -e</span><br><span class="line">*/3 * * * * /bin/bash /root/bin/ds.sh</span><br></pre></td></tr></table></figure>
<h2 id="关于-bin-weixin"><a href="#关于-bin-weixin" class="headerlink" title="关于/bin/weixin"></a>关于/bin/weixin</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">链接:http://pan.baidu.com/s/1slcAlTb  密码:f3gz</span><br><span class="line">weixin接口的调用可以创建一个企业微信来配置一个接口</span><br><span class="line">mutt发短信，mutt+msmtp配置使用</span><br></pre></td></tr></table></figure>
<h2 id="删除mongo表中的某一字段"><a href="#删除mongo表中的某一字段" class="headerlink" title="删除mongo表中的某一字段"></a>删除mongo表中的某一字段</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">db.screening_sections.remove(&#123;<span class="string">&#x27;no&#x27;</span>:<span class="string">&#x27;5a279c19756a7&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>gitlab备份与迁移</title>
    <url>/2017/11/22/gitlab%E5%A4%87%E4%BB%BD%E4%B8%8E%E8%BF%81%E7%A7%BB/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="gitlab的备份与同步"><a href="#gitlab的备份与同步" class="headerlink" title="gitlab的备份与同步"></a>gitlab的备份与同步</h1><h2 id="gitlab备份"><a href="#gitlab备份" class="headerlink" title="gitlab备份"></a>gitlab备份</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo gitlab-rake gitlab:backup:create</span></span><br><span class="line"><span class="comment"># sudo scp -r /var/opt/gitlab/backups/ root@xx.xxx.xx.xxx:/root </span></span><br></pre></td></tr></table></figure>
<h2 id="由于版本问题，在迁移目标主机安装同样版本"><a href="#由于版本问题，在迁移目标主机安装同样版本" class="headerlink" title="由于版本问题，在迁移目标主机安装同样版本"></a>由于版本问题，在迁移目标主机安装同样版本</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># scp gitlab-ci-multi-runner_1.4.2_amd64.deb gitlab-ce_8.6.2-ce.0_amd64.deb root@xx.xxx.xx.xxx:/root</span></span><br><span class="line"><span class="comment"># 若无此版本的备份包时选择以下方式下载</span></span><br><span class="line">链接:http://pan.baidu.com/s/1eS4H6NK  密码:e7i6</span><br></pre></td></tr></table></figure>
<h2 id="迁移目标主机安装与恢复"><a href="#迁移目标主机安装与恢复" class="headerlink" title="迁移目标主机安装与恢复"></a>迁移目标主机安装与恢复</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dpkg -i /root/gitlab-ci-multi-runner_1.4.2_amd64.deb</span></span><br><span class="line"><span class="comment"># dpkg -i /root/gitlab-ce_8.6.2-ce.0_amd64.deb </span></span><br><span class="line"><span class="comment"># mv /root/1510889754_gitlab_backup.tar /var/opt/gitlab/backups/</span></span><br><span class="line"><span class="comment"># gitlab-rake gitlab:backup:restore BACKUP=1510889754</span></span><br><span class="line"><span class="comment"># gitlab-ctl start</span></span><br><span class="line"><span class="comment"># vim /etc/gitlab/gitlab.rb</span></span><br><span class="line">	 unicorn[<span class="string">&#x27;listen&#x27;</span>] = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">	 unicorn[<span class="string">&#x27;port&#x27;</span>] = 8080</span><br><span class="line"><span class="comment"># gitlab-ctl reconfigure</span></span><br><span class="line"><span class="comment"># gitlab-ctl start</span></span><br></pre></td></tr></table></figure>
<h2 id="检查8080端口是否启动"><a href="#检查8080端口是否启动" class="headerlink" title="检查8080端口是否启动"></a>检查8080端口是否启动</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># netstat  -tnlup | grep 8080</span></span><br><span class="line">tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      3290/config.ru  </span><br></pre></td></tr></table></figure>
<h2 id="源主机利用bash脚本-定时任务自动备份与同步备份"><a href="#源主机利用bash脚本-定时任务自动备份与同步备份" class="headerlink" title="源主机利用bash脚本+定时任务自动备份与同步备份"></a>源主机利用bash脚本+定时任务自动备份与同步备份</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 数据同步，首要做的就是双机互信；</span></span><br><span class="line"><span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@xx.xxx.xx.xxx </span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Can Bakup gitlab to xx.xxx.xx.xxx</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">FileBack</span></span> () &#123; </span><br><span class="line">	[ -d /var/opt/gitlab/backups/.bak ] || mkdir /var/opt/gitlab/backups/.bak -p</span><br><span class="line">	mv /var/opt/gitlab/backups/*tar /var/opt/gitlab/backups/.bak/</span><br><span class="line">	find /var/opt/gitlab/backups/.bak/  -<span class="built_in">type</span> f -mtime +7 -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</span><br><span class="line">	/usr/bin/gitlab-rake gitlab:backup:create &amp;&gt; /dev/null</span><br><span class="line">	sleep 240</span><br><span class="line">	ssh root@xx.xxx.xx.xxx <span class="string">&quot;[ -d /var/opt/gitlab/backups/.bak ] || mkdir /var/opt/gitlab/backups/.bak -p&quot;</span></span><br><span class="line">	ssh root@xx.xxx.xx.xxx <span class="string">&quot;mv /var/opt/gitlab/backups/*tar /var/opt/gitlab/backups/.bak/&quot;</span></span><br><span class="line">	ssh root@xx.xxx.xx.xxx <span class="string">&quot;find /var/opt/gitlab/backups/.bak/  -type f -mtime +7 -exec rm -rf &#123;&#125; \;&quot;</span></span><br><span class="line">	scp  /var/opt/gitlab/backups/*tar root@xx.xxx.xx.xxx:/var/opt/gitlab/backups/</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Message</span></span> () &#123;</span><br><span class="line"></span><br><span class="line">	MESSAGE=<span class="string">&quot;gitlab 已备份成功 `ls -l /var/opt/gitlab/backups/` &amp;&amp; `ls -ld /var/opt/gitlab/backups/` gitlab当前主服务器xx.xxx.xx.xxx&quot;</span></span><br><span class="line">	MESSAGE_2=`ssh root@xx.xxx.xx.xxx <span class="string">&quot;ls -l /var/opt/gitlab/backups/;ls -ld /var/opt/gitlab/backups/; ifconfig | sed -n &#x27;/inet addr/s/^[^:]*:\([0-9.]\&#123;7,15\&#125;\) .*/\1/p&#x27; | head -1&quot;</span>`</span><br><span class="line">	/bin/weixin --corpid=xxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.  --msg=<span class="string">&quot;<span class="variable">$MESSAGE</span></span></span><br><span class="line"><span class="string">	gitlab当前从服务器<span class="variable">$MESSAGE_2</span>&quot;</span> --user=15822097176@139.com --agentid=100000x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FileBack &amp;&amp; Message</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Can rolebak gitlab</span></span><br><span class="line"><span class="function"><span class="title">FILE_BAK</span></span> () &#123;</span><br><span class="line">scp /var/opt/gitlab/backups/*tar root@xx.xxx.xx.xxx:/volume1/skill-operation/bakup/gitlab/</span><br><span class="line">ssh root@xx.xxx.xx.xxx <span class="string">&quot;find /volume1/skill-operation/bakup/gitlab/  -type f -mtime +7 -exec rm -rf &#123;&#125; \;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">GIT_ROLBAK</span></span> () &#123;</span><br><span class="line">BAKID=`<span class="built_in">cd</span> /var/opt/gitlab/backups/ &amp;&amp; ls | tr -dc <span class="string">&quot;[:digit:]&quot;</span>`</span><br><span class="line"><span class="built_in">cd</span> /var/opt/gitlab/backups/ &amp;&amp; chmod 666 *</span><br><span class="line">/usr/bin/gitlab-rake gitlab:backup:restore BACKUP=<span class="variable">$BAKID</span> &lt;&lt;<span class="string">EOF &amp;&gt; /dev/null</span></span><br><span class="line"><span class="string">yes</span></span><br><span class="line"><span class="string">yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">MESSAGE</span></span> () &#123;</span><br><span class="line">/bin/weixin --corpid=xxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">&quot;ID 为 <span class="variable">$BAKID</span> 的gitlab压缩包恢复完毕&quot;</span> --user=15822097176@139.com --agentid=100000x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FILE_BAK</span><br><span class="line">GIT_ROLBAK &amp;&amp; MESSAGE</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定时任务进行实时备份与同步</span></span><br><span class="line">su - root</span><br><span class="line">crontab -e</span><br><span class="line">10 22 * * * /bin/bash /bin/GITLAB_BAK.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - root</span><br><span class="line">crontab -e</span><br><span class="line">30 22 * * * /bin/bash /bin/GIT_ROL.sh</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>python自动化之fabric</title>
    <url>/2017/11/21/python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bfabric-lnmp%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
    <content><![CDATA[<p>[toc]</p>
<p>#lnmp环境的建立</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">env.user=<span class="string">&#x27;root&#x27;</span></span><br><span class="line">env.roledefs = &#123;  <span class="comment">#定义业务角色分组</span></span><br><span class="line">	<span class="string">&#x27;webservers&#x27;</span>: [ <span class="string">&#x27;xx.xxx.xx.xxx&#x27;</span> ],</span><br><span class="line">   <span class="string">&#x27;dbservers&#x27;</span>: [<span class="string">&#x27;xx.xxx.xx.xxx&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">env.passwords = &#123;</span><br><span class="line">    <span class="string">&#x27;root@xxx.xx.xx.xxx:22&#x27;</span> : <span class="string">&#x27;passwd&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;root@xxx.xx.xx.xxx:22&#x27;</span> : <span class="string">&#x27;passwd&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@roles(&#x27;webservers&#x27;) #webtask任务函数引用&#x27;webservers&#x27;角色修饰符</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">webtask</span>():</span></span><br><span class="line">    <span class="built_in">print</span> yellow(<span class="string">&quot;Install webtask packages class ! &quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> settings(warn_only=<span class="literal">True</span>):</span><br><span class="line">        run(<span class="string">&quot;yum -y install nginx&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;yum -y install php-fpm php-mysql php-mbstring php-xml php-mcrypt php-gd&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;chkconfig --levels 235 php-fpm on&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;chkconfig --levels 235 nginx on&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;systemctl start php-fpm&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;systemctl start nginx&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@roles(&#x27;dbservers&#x27;) # dbtask任务函引用&#x27;dbservers&#x27;角色修饰符</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbtask</span>():</span> <span class="comment">#部署mysql环境</span></span><br><span class="line">    <span class="built_in">print</span> green(<span class="string">&quot;Install mariadb server !&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> settings(warn_only=<span class="literal">True</span>):</span><br><span class="line">        run(<span class="string">&quot;yum -y install mariadb mariadb-server&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;chkconfig --levels 235 mariadb on&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;systemctl start mariadb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@roles(&#x27;webservers&#x27;,&#x27;dbservers&#x27;) # publictask任务函数同时引用两个角色修饰符</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">publictask</span>():</span>  <span class="comment"># 部署公共环境，如epel、ntp等</span></span><br><span class="line">    <span class="built_in">print</span> blue(<span class="string">&quot;Install epel ntp !&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> settings(warn_only=<span class="literal">True</span>):</span><br><span class="line">        run(<span class="string">&quot;rpm -Uvh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm&quot;</span>)</span><br><span class="line">        run(<span class="string">&quot;rpm -y install ntp ntpdate&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deploy</span>():</span></span><br><span class="line">    execute(publictask)</span><br><span class="line">    execute(webtask)</span><br><span class="line">    execute(dbtask)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#vim 底行模式的执行</span></span><br><span class="line">: ! fab -f NGINX_DPL.py deploy</span><br></pre></td></tr></table></figure>
<h1 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h1><p>注:目前代码还有些问题，小心参考</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fabric.context_managers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fabric.contrib.console <span class="keyword">import</span> confirm</span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line"></span><br><span class="line">env.user = <span class="string">&#x27;root&#x27;</span></span><br><span class="line">env.hosts = [<span class="string">&#x27;xx.xxx.xx.xxx&#x27;</span>,<span class="string">&#x27;xx.xxx.xx.xxx&#x27;</span>]</span><br><span class="line">env.password = <span class="string">&#x27;test.......&#x27;</span></span><br><span class="line">env.project_dev_source = <span class="string">&#x27;/var/www/html&#x27;</span>  <span class="comment">#开发机项目主目录</span></span><br><span class="line">env.project_tar_source = <span class="string">&#x27;/var/www/releases&#x27;</span> <span class="comment">#开发机项目压缩包存储目录</span></span><br><span class="line">env.project_pack_name = <span class="string">&#x27;release&#x27;</span>  <span class="comment"># 项目压缩包前缀，文件名为 release.tar.gz</span></span><br><span class="line"></span><br><span class="line">env.deploy_project_root = <span class="string">&#x27;/var/www/data&#x27;</span> <span class="comment">#项目生产环境主目录</span></span><br><span class="line">env.deploy_release_dir = <span class="string">&#x27;release&#x27;</span> <span class="comment">#项目发布目录，位于主目录下面</span></span><br><span class="line">env.deploy_current_dir = <span class="string">&#x27;current&#x27;</span> <span class="comment">#对外服务的当前版本软链接</span></span><br><span class="line">env.deploy_version = time.strftime (<span class="string">&quot;%Y%m%d&quot;</span>) +<span class="string">&quot;V2&quot;</span> <span class="comment">#版本号</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@runs_once #相当于一个模块</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_versionid</span>():</span></span><br><span class="line">    <span class="keyword">return</span> prompt (<span class="string">&quot;please input project rollbak version ID:&quot;</span>,default=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="meta">@runs_once</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tar_source</span>():</span></span><br><span class="line">    <span class="built_in">print</span> yellow(<span class="string">&quot;Creating source package...&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> lcd(env.project_dev_source):</span><br><span class="line">        local(<span class="string">&quot;tar -czf %s.tar.gz.&quot;</span> % (env.project_tar_source + env.project_pack_name))</span><br><span class="line">        <span class="built_in">print</span> green(<span class="string">&quot;Creating source package success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_packages</span>():</span> <span class="comment">#上传任务函数</span></span><br><span class="line">    <span class="built_in">print</span> yellow(<span class="string">&quot;Start put package...&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> settings(warn_only=<span class="literal">True</span>):</span><br><span class="line">        <span class="keyword">with</span> cd(env.deploy_project_root+env.deploy_release_dir):</span><br><span class="line">            run(<span class="string">&quot;mkdir %s&quot;</span> % (env.deploy_version))</span><br><span class="line">    env.deploy_full_path = env.deploy_project_root + env.deploy_release_dir + <span class="string">&quot;/&quot;</span> + env.deploy_version</span><br><span class="line">    <span class="keyword">with</span> setting(warn_only=<span class="literal">True</span>):</span><br><span class="line">        result = put(env.project_tar_source + env.project_pack_name + <span class="string">&quot;.tar.gz&quot;</span>, env.deploy_full_path)</span><br><span class="line">    <span class="keyword">if</span> result.failed <span class="keyword">and</span> <span class="keyword">not</span>(<span class="string">&quot;put file failed, Continue[Y/N]?&quot;</span>):</span><br><span class="line">        abort(<span class="string">&quot;Aborting file put task!&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> cd(env.deploy_full_path):</span><br><span class="line">        run(<span class="string">&quot;tar -zxvf %s.tar.gz&quot;</span> % (env.project_pack_name))</span><br><span class="line">        run(<span class="string">&quot;rm -rf %s.tar.gz&quot;</span> % (env.project_pack_name))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> green(<span class="string">&quot;Put &amp; untar packages success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_symlink</span>():</span>   <span class="comment">#为当前版本目录做软链接</span></span><br><span class="line">    <span class="built_in">print</span> yellow(<span class="string">&quot;update current sylink&quot;</span>)</span><br><span class="line">    env.deploy_full_path = env.deploy_project_root + env.deploy_release_dir + <span class="string">&quot;/&quot;</span> +env.deploy_version</span><br><span class="line">    <span class="keyword">with</span> settings(warn_only=<span class="literal">True</span>): <span class="comment">#删除软链接，重新创建并指定软链接源目录，新版本生效</span></span><br><span class="line">        run(<span class="string">&quot;rm -rf %s&quot;</span> % (env.deploy_project_root + env.deploy_current_dir))</span><br><span class="line">        run(<span class="string">&quot;ls -s %s %s&quot;</span> % (env.deploy_full_path, env.deploy_project_root + env.deploy_current_dir))</span><br><span class="line">    <span class="built_in">print</span> green(<span class="string">&quot;make symlink success!&quot;</span>)</span><br><span class="line"><span class="meta">@task </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rollback</span>():</span>  <span class="comment">#版本回滚任务函数</span></span><br><span class="line">    <span class="built_in">print</span> yellow(<span class="string">&quot;rollback project version&quot;</span>)</span><br><span class="line">    versionid= input_versionid()</span><br><span class="line">    <span class="keyword">if</span> versionod==<span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        abort(<span class="string">&quot;Project version ID error,abort!&quot;</span>)</span><br><span class="line">    env.deploy_full_path=env.deploy_project_root + env.deploy_release_dir + <span class="string">&quot;/&quot;</span> +versionid</span><br><span class="line">    run(<span class="string">&quot;rm -f %s&quot;</span> % env.deploy_project_root +env.deploy_current_dir)</span><br><span class="line">    run(<span class="string">&quot;ln -s %s %s&quot;</span> % (env.deploy_full_path, env.deploy_project_root + env.deploy_current_dir))</span><br><span class="line"><span class="comment">#删除软链接,重新创建并指定软链接源目录，新版本生效</span></span><br><span class="line">    <span class="built_in">print</span> green(<span class="string">&quot;rollback success!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span>():</span></span><br><span class="line">    tar_source()</span><br><span class="line">    put_packages()</span><br><span class="line">    make_symlink()</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
        <tag>program</tag>
      </tags>
  </entry>
  <entry>
    <title>当我年轻的时候</title>
    <url>/2017/11/20/%E5%BD%93%E6%88%91%E5%B9%B4%E8%BD%BB%E7%9A%84%E6%97%B6%E5%80%99/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="当我年轻的时候"><a href="#当我年轻的时候" class="headerlink" title="当我年轻的时候"></a>当我年轻的时候</h2><p><img src="/images/ssjinyao.jpg" class="lazyload" data-srcset="/images/ssjinyao.jpg" srcset="data:image/png;base64,666" alt=""></p>
<p>当我年轻的时候，我的想象力从没有受过限制，我梦想改变这个世界;<br>当我成熟之后，我发现我不能够改变这个世界，我将目光缩短了些，决定只改变我的国家;<br>当我进入暮年以后，我发现我不能够改变我的国家，我最后愿望仅仅是改变一下我的家庭。但是这也不可能;<br>当我现在躺在床上，行将就木时，我突然意识到: 如果一开始我仅仅去改变我自己，然后作为一个榜样;<br>我可能改变我的家庭;在家人的帮助和鼓励下，我可能为国家做一些事情;<br>然而，谁知道呢 ？ 我甚至可能改变这个世界;  </p>
<h2 id="言不由衷"><a href="#言不由衷" class="headerlink" title="言不由衷"></a>言不由衷</h2><ol>
<li>莎莎姐: 引领自己进入IT行业，提供Linux信息资料让自己在大学学习，提供初到北京经济上2w的支持。引导就业与学习方向;</li>
<li>海生哥: 推荐华图就业机会，帮助学习技术知识，辅导学习Linux运维工程师经验;</li>
<li>娜娜:  帮着学习高数，鼓励Linux 发展之路;</li>
<li>阿狗: 最美的年华鼓励与相伴，互望发达之心的朋友;</li>
<li>红兵哥:  帮着看房，一起学习专业知识，共享专业领域的成就与新的技术经验分享。</li>
</ol>
<h2 id="不可多得的挚友"><a href="#不可多得的挚友" class="headerlink" title="不可多得的挚友"></a>不可多得的挚友</h2><h3 id="心照不宣"><a href="#心照不宣" class="headerlink" title="心照不宣"></a>心照不宣</h3><p>杨中xin、 梁hao 、 壮miao</p>
<h3 id="刎颈之交"><a href="#刎颈之交" class="headerlink" title="刎颈之交"></a>刎颈之交</h3><p> 海tuan  、董san 、狗jiang 、勇gang、振xin 、光光</p>
<h3 id="细水长流"><a href="#细水长流" class="headerlink" title="细水长流"></a>细水长流</h3><p> 芳mei </p>
<h3 id="不期而遇"><a href="#不期而遇" class="headerlink" title="不期而遇"></a>不期而遇</h3><p>云珍、庆朋、方舟、熙兵、绪郭、信倡、东宇、李林、未子杰</p>
<h2 id="引领一生的恩师"><a href="#引领一生的恩师" class="headerlink" title="引领一生的恩师"></a>引领一生的恩师</h2><p>许立宽、 王春兰、崔忘名、雷丽琴、马永亮、王晓春</p>
<h2 id="励志语"><a href="#励志语" class="headerlink" title="励志语"></a>励志语</h2><ol>
<li>有智而性缓者思大智、有才而气和者为大才;</li>
<li>我不能把这个世界让给我所鄙视的人，冬严寒、夏酷暑、春秋亦不死吾心，心有所向，将有所成;</li>
<li>不管走到哪里，都要相信自己的勇敢和毅力，不管遇到什么事情都不要击垮自己的心态;</li>
</ol>
<h2 id="高中语录"><a href="#高中语录" class="headerlink" title="高中语录"></a>高中语录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">烈 火 </span><br><span class="line">逝水锦遥</span><br><span class="line">赛者奔于道中央，只为尖峰生烈火。</span><br><span class="line">观者立于路两傍，求得为此来鼓掌。</span><br><span class="line">风吹烈火火似箭，强压烈火火冲天。</span><br><span class="line">热血青春度无悔，谁人此生如烈火？</span><br><span class="line">不视前方渺我者，无须再品人生味。</span><br><span class="line">烈火怒冲人生路，央草留于我芳香。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 堂 弟 </span><br><span class="line">逝水锦遥</span><br><span class="line">同堂坠地过七秋，伴我同度千百日。</span><br><span class="line">堂弟乱入游戏网，悔于当初我沉沦。</span><br><span class="line">赛道忙于瞄峰标，专于技艺终不回。</span><br><span class="line">游戏人生抛涯底，堂弟基石忙打紧。</span><br><span class="line">与其相隔虽遥远，回乡之日挤时间。</span><br><span class="line">断落各行千百事，常立天地永不衰。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 淡霞追忆</span><br><span class="line">逝水锦遥</span><br><span class="line">星划一颗泄万里，光洒暗夜暖一心。</span><br><span class="line">双亲似有离别意，子若心弦弦拉紧。</span><br><span class="line">今日家和万事兴，天间空留淡霞忆。</span><br><span class="line">静观庭台花落去，动听泪雨灌秋田。</span><br><span class="line">遥望前程花与锦，追忆淡霞留我情。</span><br><span class="line">笑看世间路险义，痛绝此生冬眠人。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">锦遥求佳季 </span><br><span class="line">逝水锦遥</span><br><span class="line">又是一年冬季 </span><br><span class="line">愿同度青春的朋友们</span><br><span class="line">外美如花，内秀如竹</span><br><span class="line">让我们的心灵</span><br><span class="line">山高水阔，天地澄明</span><br><span class="line">真正的自己</span><br><span class="line">没有左右天气的能力</span><br><span class="line">没有力挽狂澜的魄力</span><br><span class="line">没有两肋插刀的勇气</span><br><span class="line">但却有一颗心</span><br><span class="line">有情有义</span><br><span class="line">在这个寒冷的冬季里</span><br><span class="line">愿同度青春的朋友们</span><br><span class="line">如在春天过的美丽</span><br><span class="line">如在夏天过的温暖</span><br><span class="line">如在秋天过的充实</span><br><span class="line">同在冬天过的迷人</span><br><span class="line">我有我的自我芬芳</span><br><span class="line">我有我的热血内心</span><br><span class="line">与朋友同享冬季</span><br><span class="line">有寒而降不知寒冷</span><br><span class="line">有难同度不感痛苦</span><br><span class="line">有泪可落不觉悲凉</span><br><span class="line">愿同度青春的朋友</span><br><span class="line">一切都好</span><br><span class="line">一切都好！</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">赤子佳人</span><br><span class="line">逝水锦遥</span><br><span class="line">看大地山河之秀   </span><br><span class="line">品锦瑟年华之盛</span><br><span class="line">愿与尔同度四季</span><br><span class="line">春赏花</span><br><span class="line">夏观瀑</span><br><span class="line">秋采红叶</span><br><span class="line">冬踏雪</span><br><span class="line">闲适的自己</span><br><span class="line">浪漫的佳人</span><br><span class="line">一闪一星光</span><br><span class="line">一锦一人生</span><br><span class="line">望前程如海之茫</span><br><span class="line">定峰标力求猛进</span><br><span class="line">愿与尔同度青春</span><br><span class="line">喜听歌</span><br><span class="line">怒绽放</span><br><span class="line">哀鸣鸟乐</span><br><span class="line">乐开怀</span><br><span class="line">激扬的热血</span><br><span class="line">舞动的青春</span><br><span class="line">满月满斜阳</span><br><span class="line">落地落芬芳</span><br><span class="line">视天长地久之人</span><br><span class="line">留余生余世之爱</span><br><span class="line">愿与尔同度余生</span><br><span class="line">青学习</span><br><span class="line">长积蓄</span><br><span class="line">年立事业</span><br><span class="line">老扶子</span><br><span class="line">聚集的烦恼</span><br><span class="line">无尽的忧愁</span><br><span class="line">共苦共欢乐</span><br><span class="line">共涯共此生</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">逝水人生录</span><br><span class="line">逝水锦遥</span><br><span class="line">曾忆旧时光，千百曲悲歌唱响；</span><br><span class="line">时人多思苦楚，无奈哀伤闭双目。</span><br><span class="line">回荡人生路，多少次争锋敌对；</span><br><span class="line">朝阳冷于寒光，忠于仁义存善良。</span><br><span class="line">力挽家幸福，无数尝日夜难眠；</span><br><span class="line">双子恐忧父母，有家不和天地乱。</span><br><span class="line">停留他人言，听不尽丑闻诽语；</span><br><span class="line">关门极力净心，空留锦遥有情人。</span><br><span class="line"></span><br><span class="line">天不予以我家和，独立其身修自强。</span><br><span class="line">自幼至今无健体，唯有一颗傲骨心。</span><br><span class="line">家乡如冰无温情，星光照我留暖忆。</span><br><span class="line">爱意受冷冰我心，孤友久播关爱种。</span><br><span class="line">学习不进技不成，信心百成剩两成。</span><br><span class="line">愿寻大学心追求，柔情重返人世间。</span><br><span class="line">勿忘朋友情，关怀解难雪送碳。</span><br><span class="line">勿忘恩师育，立宽春兰崔忘名。</span><br><span class="line">勿忘母亲泪，吸烟喝酒不争气。</span><br><span class="line">勿忘锦遥魂，刚毅倔强扬斗志。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">醉无温意</span><br><span class="line">逝水锦遥</span><br><span class="line">哪认吹来布谷鸟，无意牵起家乡情。</span><br><span class="line">为得路人一回眸，无力消我家乡愁。</span><br><span class="line">晨陪花瓣瓣留露，暗夜无星星点缀。</span><br><span class="line">抱负存心志在天，战场一战炮打响。</span><br><span class="line">穿肠烈酒无温意，丽人如花酒为愁。  </span><br></pre></td></tr></table></figure>
<h2 id="离别后"><a href="#离别后" class="headerlink" title="离别后"></a>离别后</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">逝水人生录 </span><br><span class="line">逝水锦遥 </span><br><span class="line">曾念旧相识，一面欢快一面愁。</span><br><span class="line">时人有梦立大志，各奔前程自拼搏。</span><br><span class="line">回荡人生路，多少次日夜相伴。</span><br><span class="line">身负你我未来梦，拾起坚强不怕痛。</span><br><span class="line">轻拂心中伤，拥抱一时不哭泣。</span><br><span class="line">爱忧恨忧不挂心，牵手相伴风雨中。</span><br><span class="line">美好终逝往，劳燕分飞可回首？</span><br><span class="line">相信技艺不相远，何必急于工作忙。</span><br><span class="line">重重思绪绕梦萦，悄然钻入沉寂里。</span><br><span class="line">匆匆时光尽逝水，一时低落思过往。</span><br><span class="line">吵吵闹闹一三九，快乐和好下一秒。</span><br><span class="line">影影相伴不曾怕，信仰不死立心头。</span><br><span class="line">言言相随好爱人，杂念停留乱我心。</span><br><span class="line">若若欣阳笑归来，无解无思大神在。</span><br><span class="line">勿忘往日游，故宫华门似神龟。</span><br><span class="line">勿忘淡开放，不晓心思河边乱。</span><br><span class="line">勿忘朝日伴，誓言梦想俱痴狂。</span><br><span class="line">勿忘别时痛，你我泪别北京南。</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>renjin</tag>
      </tags>
  </entry>
  <entry>
    <title>kvm之快照管理</title>
    <url>/2017/10/30/kvm%E4%B9%8B%E5%BF%AB%E7%85%A7%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="kvm之快照管理"><a href="#kvm之快照管理" class="headerlink" title="kvm之快照管理"></a>kvm之快照管理</h1><h3 id="使用kvm快照，磁盘则必需要使用qcow2的格式"><a href="#使用kvm快照，磁盘则必需要使用qcow2的格式" class="headerlink" title="使用kvm快照，磁盘则必需要使用qcow2的格式"></a>使用kvm快照，磁盘则必需要使用qcow2的格式</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># qemu-img info centos6.test-x86_64.raw </span></span><br><span class="line">image: centos6.test-x86_64.raw</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 80G (85899345920 bytes)</span><br><span class="line">disk size: 1.2G</span><br><span class="line"><span class="comment"># </span></span><br></pre></td></tr></table></figure>
<h3 id="关闭虚拟机并改变磁盘的格式"><a href="#关闭虚拟机并改变磁盘的格式" class="headerlink" title="关闭虚拟机并改变磁盘的格式"></a>关闭虚拟机并改变磁盘的格式</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh list</span></span><br><span class="line"> Id    名称                         状态</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 2     ubuntu-14.4-n1                 running</span><br><span class="line"> 14    ubuntu-14.4-113-pycharm        running</span><br><span class="line"> 16    ubuntu-14.4-n2                 running</span><br><span class="line"> 20    centos-6.8-grafana             running</span><br><span class="line"> 22    centos-6.8-data                running</span><br><span class="line"> 24    centos-6.8-test                running</span><br><span class="line"><span class="comment"># virsh destroy centos-6.8-test</span></span><br><span class="line">域 centos-6.8-test 被删除</span><br><span class="line"><span class="comment"># virsh  list --all</span></span><br><span class="line"> Id    名称                         状态</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 2     ubuntu-14.4-n1                 running</span><br><span class="line"> 14    ubuntu-14.4-113-pycharm        running</span><br><span class="line"> 16    ubuntu-14.4-n2                 running</span><br><span class="line"> 20    centos-6.8-grafana             running</span><br><span class="line"> 22    centos-6.8-data                running</span><br><span class="line"> -     centos-6.8-n1                  关闭</span><br><span class="line"> -     centos-6.8-test                关闭</span><br><span class="line"> -     renjin-scripts                 关闭</span><br><span class="line"> -     ubuntu-14.4-n3                 关闭</span><br><span class="line"><span class="comment"># qemu-img convert -f raw -O qcow2 centos6.test-x86_64.raw centos6.test-x86_64.qcow2</span></span><br><span class="line"><span class="comment"># virsh edit centos-6.8-test</span></span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/media/67cbdcec-6419-4571-9632-c605b3e2b910/data/centos6.test-x86_64.qcow2&#x27;</span>/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="查看管理快照的命令有哪些"><a href="#查看管理快照的命令有哪些" class="headerlink" title="查看管理快照的命令有哪些"></a>查看管理快照的命令有哪些</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh --help | grep snap</span></span><br><span class="line">  iface-begin                    create a snapshot of current interfaces settings, <span class="built_in">which</span> can be later committed (iface-commit) or restored (iface-rollback)</span><br><span class="line"> Snapshot (<span class="built_in">help</span> keyword <span class="string">&#x27;snapshot&#x27;</span>)</span><br><span class="line">    snapshot-create                Create a snapshot from XML</span><br><span class="line">    snapshot-create-as             Create a snapshot from a <span class="built_in">set</span> of args</span><br><span class="line">    snapshot-current               Get or <span class="built_in">set</span> the current snapshot</span><br><span class="line">    snapshot-delete                Delete a domain snapshot</span><br><span class="line">    snapshot-dumpxml               Dump XML <span class="keyword">for</span> a domain snapshot</span><br><span class="line">    snapshot-edit                  edit XML <span class="keyword">for</span> a snapshot</span><br><span class="line">    snapshot-info                  snapshot information</span><br><span class="line">    snapshot-list                  List snapshots <span class="keyword">for</span> a domain</span><br><span class="line">    snapshot-parent                Get the name of the parent of a snapshot</span><br><span class="line">    snapshot-revert                Revert a domain to a snapshot</span><br></pre></td></tr></table></figure>
<h3 id="创建快照"><a href="#创建快照" class="headerlink" title="创建快照"></a>创建快照</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh snapshot-create centos-6.8-test</span></span><br><span class="line"><span class="comment"># virsh snapshot-list centos-6.8-test</span></span><br><span class="line"> 名称               Creation Time             状态</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> 1509359245           2017-10-30 18:27:25 +0800 shutoff</span><br><span class="line"><span class="comment"># 其中快照配置文件放到了/var/lib/libvirt/qemu/snapshot/ </span></span><br></pre></td></tr></table></figure>
<h3 id="快照恢复"><a href="#快照恢复" class="headerlink" title="快照恢复"></a>快照恢复</h3><h4 id="查看哪些快照需要恢复"><a href="#查看哪些快照需要恢复" class="headerlink" title="查看哪些快照需要恢复"></a>查看哪些快照需要恢复</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh  list --all</span></span><br><span class="line"> Id    名称                         状态</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 2     ubuntu-14.4-n1                 running</span><br><span class="line"> 14    ubuntu-14.4-113-pycharm        running</span><br><span class="line"> 16    ubuntu-14.4-n2                 running</span><br><span class="line"> 20    centos-6.8-grafana             running</span><br><span class="line"> 22    centos-6.8-data                running</span><br><span class="line"> 25    centos-6.8-test                running</span><br><span class="line"> -     centos-6.8-n1                  关闭</span><br><span class="line"> -     renjin-scripts                 关闭</span><br><span class="line"> -     ubuntu-14.4-n3                 关闭</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh snapshot-list centos-6.8-test</span></span><br><span class="line"> 名称               Creation Time             状态</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> 1509359245           2017-10-30 18:27:25 +0800 shutoff</span><br><span class="line"> <span class="comment"># virsh destroy centos-6.8-test</span></span><br><span class="line">域 centos-6.8-test 被删除</span><br><span class="line"><span class="comment"># virsh  snapshot-revert centos-6.8-test 1509359245</span></span><br><span class="line"><span class="comment"># virsh snapshot-current centos-6.8-test</span></span><br><span class="line"><span class="comment"># virsh start centos-6.8-test</span></span><br><span class="line"><span class="comment">#至此，已经恢复完成</span></span><br></pre></td></tr></table></figure>
<h3 id="快照的删除"><a href="#快照的删除" class="headerlink" title="快照的删除"></a>快照的删除</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh snapshot-list centos-6.8-test</span></span><br><span class="line"> 名称               Creation Time             状态</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> 1509359245           2017-10-30 18:27:25 +0800 shutoff</span><br><span class="line"></span><br><span class="line"><span class="comment"># virsh snapshot-delete centos-6.8-test  1509359245</span></span><br></pre></td></tr></table></figure>
<h3 id="补充-在宿主机关机后，启动kvm遇以下问题"><a href="#补充-在宿主机关机后，启动kvm遇以下问题" class="headerlink" title="补充:在宿主机关机后，启动kvm遇以下问题:"></a>补充:在宿主机关机后，启动kvm遇以下问题:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># virsh start  centos-7.2-xxxxxxxx</span><br><span class="line">错误：开始域 centos-7.2-xxxxxxx失败</span><br><span class="line">错误：Unable to read from monitor: Connection reset by peer</span><br><span class="line"># virsh managedsave-remove centos-6.8-grafana</span><br><span class="line"># virsh start centos-7.2-xxxxxxxxx </span><br><span class="line">域 centos-7.2-xxxxxxxxx 已开始</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>linux 系统优化</title>
    <url>/2017/10/29/linux-%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<p>[toc]</p>
<h2 id="进程调度"><a href="#进程调度" class="headerlink" title="进程调度"></a>进程调度</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OS:硬件抽象，虚拟计算机</span><br><span class="line">	system call </span><br><span class="line">CPU: time slice</span><br><span class="line">	获得CPU权限的优先级，有些进程的优先级是可以被提高的</span><br><span class="line">调度器(本身也是个程序): CFS Big O</span><br><span class="line">		O(1) 一个算法的时间复杂度</span><br><span class="line">		0-139</span><br><span class="line">		0-99</span><br><span class="line">		100-139:</span><br><span class="line">			nice</span><br><span class="line">Memory:</span><br><span class="line">	虚拟地址空间</span><br><span class="line">	PAE：物理地址扩 32bits，寻址的物理空间是4G，4bits是额外引入的，所以被称为PAE技术(64G)</span><br><span class="line">	也就是说它的线性地址空间依然为4G </span><br><span class="line">	</span><br><span class="line">	MySQL:单进程多线程</span><br><span class="line">		可以使用2.7G左右，因此使用PAE技术对MySQL没有技术，因此使用MySQL服务时，建议使用64位的</span><br><span class="line">	page frame: 分页技术 </span><br><span class="line">	物理地址中的内存空间，被划分成了多个页面空间，都被组织成为多个页面形势</span><br><span class="line">	从页面到页框完成映射的</span><br><span class="line">    一个进程读取数据时，首先需要把数据载入到内存中。遇到经常被调用的数据时，可以配置缓存</span><br><span class="line">    如果缓存不断的命中，则说明性能可以不断的提高，将频繁被访问数据放到CPU缓存中</span><br><span class="line">    对于CPU来说，CPU的缓存对提高CPU的性能是至关重要的</span><br><span class="line">    缓存空间通常是按倍相差的</span><br><span class="line">    TLB 转换后元缓存器</span><br><span class="line">	 page frame:</span><br><span class="line">	 huge page: 使用大页，来提升TLB的命中率</span><br><span class="line">	 0000</span><br><span class="line">	 0001</span><br><span class="line">	 0101</span><br><span class="line">	 1111</span><br><span class="line">	 cpu 1,3</span><br><span class="line">	 </span><br><span class="line">	 两中拆中方法，拿时间换空间，拿空间换时间 </span><br><span class="line">	 较专业的服务器上会有NUMA的结构，非一致内存访问，NUMA结构的前题是，要有多颗CPU </span><br><span class="line">	 将进程和CPU完成亲和性绑定，进程命中CPU缓存的命中率，将会变的很高</span><br></pre></td></tr></table></figure>
<h2 id="CPU调优操作"><a href="#CPU调优操作" class="headerlink" title="CPU调优操作"></a>CPU调优操作</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查看当前进和运行在哪颗CPU</span><br><span class="line"># ps axo psr,comm,pid</span><br><span class="line"># cat &#x2F;proc&#x2F;cpuinfo</span><br><span class="line"># 定义进程号为 11215的进程绑定在第四颗CPU上</span><br><span class="line"># taskset -p -c 3 11215 (为个命令的格式比较诡异) </span><br><span class="line"># taskset -p cpu1,cpu2,... pid </span><br><span class="line"># vim &#x2F;boot&#x2F;grup&#x2F;grub.conf kernel 行加上 isol &#x3D; 2,3</span><br><span class="line"># cat &#x2F;proc&#x2F;interrupts # 通常应该把0号隔离出来，离给内核使用</span><br><span class="line"># ls &#x2F;proc&#x2F;irq&#x2F;0&#x2F;</span><br><span class="line"># cat &#x2F;proc&#x2F;irq&#x2F;0&#x2F;smp_affinity </span><br><span class="line">ffffffff,ffffffff  表示任意CPU</span><br><span class="line"></span><br><span class="line"># echo 1 &gt; &#x2F;proc&#x2F;irq&#x2F;32&#x2F;smp_affinity</span><br><span class="line"># cat &#x2F;proc&#x2F;irq&#x2F;32&#x2F;smp_affinity</span><br><span class="line"># cat </span><br><span class="line"># 对于生产来说，越简单，越标准会好</span><br><span class="line"># 压榨系统资源，会造成系统不稳定的，不到万不得已，不建议这样做的</span><br><span class="line"># nice, renice 经常用到的进程优先级的调整</span><br></pre></td></tr></table></figure>
<h2 id="定义中断-smp-affinityy"><a href="#定义中断-smp-affinityy" class="headerlink" title="定义中断 smp affinityy:"></a>定义中断 smp affinityy:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo cpunumber ,.. &gt; /proc/irq/#/smp_affinity</span></span><br><span class="line"><span class="comment"># 这里使用的cpu应该为isoicpus中定义CPU集合之外的其它CPU</span></span><br><span class="line"><span class="comment"># numa,numactl,numad 尽可能把进程绑定在单颗CPU上</span></span><br><span class="line"><span class="comment"># 对同一个进程来讲，可能适用的调度器有多个，有其优先级较高的调度来器来调度</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># SCHED_FIFO [1-99] </span></span><br><span class="line">	chrt -f [1-99] /path/to/program arguments</span><br><span class="line"><span class="comment"># SCHED_RR  </span></span><br><span class="line">	chrt -f [1-99] /path/to/program arguments</span><br><span class="line"><span class="comment"># SCHED_NORMAL (100-139)</span></span><br><span class="line">进程的调度类别: </span><br><span class="line">	SCHEd_FIFO, SCHED_RR:real-time </span><br><span class="line"></span><br><span class="line">	SCHED_NORMAL, SCHED_OTHER: 100-139</span><br><span class="line">		nice,renice (对于已启动的进程使用renice启动)</span><br><span class="line">建议使用CPU Utilization工具:</span><br><span class="line">	htop,dstat,glances,sar</span><br><span class="line">	w,uptime, vmstat 1 5  </span><br><span class="line"><span class="comment"># sar -P all 1</span></span><br><span class="line"><span class="comment"># iostat -c 1 2 </span></span><br><span class="line"><span class="comment"># sysdig</span></span><br><span class="line">/proc,/sys</span><br><span class="line"></span><br><span class="line">DMA: 直接内存访问</span><br><span class="line"></span><br><span class="line">CPU跟外部IO设备交互的方式:</span><br><span class="line">	poll:轮询，忙等待</span><br><span class="line">	中断:</span><br><span class="line">CPU: 调优</span><br><span class="line">	cpu affinity </span><br><span class="line">	优先级调整</span><br><span class="line">		cgroups,</span><br><span class="line">内存:</span><br><span class="line">	overcommit_memory</span><br><span class="line">	msg </span><br><span class="line">	shm</span><br></pre></td></tr></table></figure>
<h2 id="补充nginx-优化加速"><a href="#补充nginx-优化加速" class="headerlink" title="补充nginx 优化加速"></a>补充nginx 优化加速</h2><blockquote>
<p>给Nginx上 ngx_http_gzip_module 这个模块;<br>用 nginx -V 命令查看 configure arguments 是否有<br>没有的话需要编译加载这个模块</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/local/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 在 httpd 段中加入以下内容</span></span><br><span class="line">gzip on;</span><br><span class="line"><span class="comment">#该指令用于开启或关闭gzip模块(on/off)</span></span><br><span class="line"></span><br><span class="line">gzip_buffers 16 8k;</span><br><span class="line"><span class="comment">#设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流。16 8k代表以8k为单位，安装原始数据大小以8k为单位的16倍申请内存</span></span><br><span class="line"></span><br><span class="line">gzip_comp_level 6;</span><br><span class="line"><span class="comment">#gzip压缩比，数值范围是1-9，1压缩比最小但处理速度最快，9压缩比最大但处理速度最慢</span></span><br><span class="line"></span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line"><span class="comment">#识别http的协议版本</span></span><br><span class="line"></span><br><span class="line">gzip_min_length 256;</span><br><span class="line"><span class="comment">#设置允许压缩的页面最小字节数，页面字节数从header头得content-length中进行获取。默认值是0，不管页面多大都压缩。这里我设置了为256</span></span><br><span class="line"></span><br><span class="line">gzip_proxied any;</span><br><span class="line"><span class="comment">#这里设置无论header头是怎么样，都是无条件启用压缩</span></span><br><span class="line"></span><br><span class="line">gzip_vary on;</span><br><span class="line"><span class="comment">#在http header中添加Vary: Accept-Encoding ,给代理服务器用的</span></span><br><span class="line"></span><br><span class="line">gzip_types</span><br><span class="line">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">    text/javascript application/javascript application/x-javascript</span><br><span class="line">    text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">    text/css text/plain text/x-component</span><br><span class="line">    font/opentype font/ttf application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">    image/x-icon;</span><br><span class="line"><span class="comment">#进行压缩的文件类型,这里特别添加了对字体的文件类型</span></span><br><span class="line"></span><br><span class="line">gzip_disable <span class="string">&quot;MSIE [1-6]\.(?!.*SV1)&quot;</span>;</span><br><span class="line"><span class="comment">#禁用IE 6 gzip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vim /etc/nginx/conf.d/ssjinyao.conf </span></span><br><span class="line"><span class="comment"># 在虚拟主机server 段中加入以下内容</span></span><br><span class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$ &#123;</span><br><span class="line">    expires 30d;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ .*\.(eot|ttf|otf|woff|svg)$ &#123;</span><br><span class="line">    expires 30d;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ .*\.(js|css)?$ &#123;</span><br><span class="line">    expires 7d;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>docker初步使用</title>
    <url>/2017/10/27/docker%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="Docker初步使用"><a href="#Docker初步使用" class="headerlink" title="Docker初步使用"></a>Docker初步使用</h1><h2 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h2><blockquote>
<p>lxc linux container,openvz;<br>容器中各虚拟机只有一个内核，而是多个用户空间;<br>在库中完成虚拟化，比如wine 或者在windows中运行bash;<br>在应用程序的运行级别提供虚拟化，比如jvm;<br>pstree , pid 为1 的进程  这个进程是直接和内核来打交道的;<br>容器之间，和虚拟机之间隔离的技术;<br>容器之间的隔离相对比较困难;<br>NameSpace,（名称空间);</p>
</blockquote>
<h3 id="内核级别，环境隔离"><a href="#内核级别，环境隔离" class="headerlink" title="内核级别，环境隔离"></a>内核级别，环境隔离</h3><ul>
<li>PID NameSpace: 用于隔离pid号的 Linux 2.6.24  PID隔离;</li>
<li>Network NameSpace : Linux 2.6.29 网络名称空间的隔离  网络设备、网络栈、端口等网络设备隔离;</li>
<li>User NameSpace: Linux 用户空间的隔离  Linux 3.8 甚至 3.10之后 用户和用户组资源隔离;</li>
<li>IPC NameSpace: 进程间通信技术  Linux 2.6.19  signal 信号量、消息队列和共享内存的隔离;</li>
<li>UTS NameSpace: Linux 2.6.19 ， 主机名和域名的隔离；</li>
<li>Mount NameSpace: Linux 2.4.19 挂载点（文件系统 ）隔离；</li>
<li>API:clone()实现线程系统调用，用来创建新线程;</li>
<li>setns()设定一个新的属性,将某(进程|或设备)加入到新的NameSpace中去的;</li>
<li>unshare()非共享机制，脱离NameSpace，而关联至新NameSpace;</li>
<li>将NameSpace隔离开来没有问题，而问题在于，恶意用户强行调用资源，一个用户完全可以将系统资源耗尽，cpu占用至100%;</li>
<li>因此带来了另一种机制的出现；</li>
<li>CGroup: Linux Control Group,控制组 Linux 2.6.24被收入进内核</li>
<li>内核级别，限制、控制与一个进程组群的资源；</li>
<li>资源：CPU,内存，IO 级别来进行定义</li>
<li>google工程师：2006开始此技术，命令为进程容器而后命令为CGroup</li>
</ul>
<h3 id="功能："><a href="#功能：" class="headerlink" title="功能："></a>功能：</h3><ul>
<li>Resource limitation:资源限制；</li>
<li>Prioritization:优先级控制；</li>
<li>Accounting:审计和统计，主要为计费；</li>
<li>Contorl:挂起进程，恢复进程；</li>
<li>CGroup 基于单根倒树状结构来实现</li>
<li>在CentOS7 中可以用mount 命令来查看其资源组的隔离技术已经被使用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> /sys/fs/cgroup</span><br><span class="line"> <span class="comment"># mount</span></span><br><span class="line"> <span class="comment"># lssubsys -m </span></span><br><span class="line">``` </span><br><span class="line"><span class="comment">### CGroup的子系统:</span></span><br><span class="line">* blkio:设定块设备的IO限制，而设定的子系统；</span><br><span class="line">* cpu:设定CPU的限制；</span><br><span class="line">* cpuacct:报告cgroup中所使用的CPU资源；</span><br><span class="line">* cpuset:为cgroup中的任务分配 CPU和内存资源 ；</span><br><span class="line">* memory:设定内存的使用限制；</span><br><span class="line">* devices:控制cgroup中的任务对设备的访问能务；</span><br><span class="line">* freezer: 挂起和恢复cgroup中的任务；      </span><br><span class="line">* net_cls:(classid) ，使用等级级别标识符来标记网络数据包；</span><br><span class="line">* tc: 流量整形命令 ；</span><br><span class="line">* perf_event:对用户空间中任务，对用户空间产生的进程进行分类；</span><br><span class="line">* 使用后使cgrup中的任务可以进行统一的性能测试；  </span><br><span class="line">* hugetlb:转换后元缓冲区，对HugeTLB子系统进行限制；</span><br><span class="line"><span class="comment">### CGroup中的术语：</span></span><br><span class="line">* task(任务)：进程或线程；</span><br><span class="line">* cgroup:一个独立的资源控制单位，可以包含一个或多个子系统；</span><br><span class="line">* subsystem:子系统，</span><br><span class="line">* hierarchy:层级</span><br><span class="line">* AUFS:UnionFS：</span><br><span class="line">* UnionFS：把不同的物理位置的目录合并到同一个目录中。</span><br><span class="line">* Another UFS,Alternative UFS,Adanced UFS 几乎完全重写了unix FS </span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># tc  </span></span><br><span class="line"><span class="comment"># lssubsys -m</span></span><br></pre></td></tr></table></figure>
<h3 id="Device-mapper"><a href="#Device-mapper" class="headerlink" title="Device mapper:"></a>Device mapper:</h3><ul>
<li>linux 2.6内核引入的最重要的技术之一，用于在内核中支持逻辑卷管理的通用设备映射技术；</li>
<li>Mapped Device</li>
<li>Mapping Table</li>
<li>Target Device</li>
<li>在内核空间只能开启一个端，但是可以映射至其它的用户空间</li>
</ul>
<h3 id="Device-mapper-1"><a href="#Device-mapper-1" class="headerlink" title="Device mapper:"></a>Device mapper:</h3><ul>
<li>Linux2.6 内核引入的最重要的技术之一，用于在内核 中支持逻辑卷管理的通用设备映射机制；</li>
<li>Mapped Device</li>
<li>Mapping Table</li>
<li>Target Device</li>
</ul>
<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul>
<li>2013,GO,Apache 2.0,dotCloud<h4 id="C-S"><a href="#C-S" class="headerlink" title="C/S:"></a>C/S:</h4></li>
<li>Docker Client:发起docker相关的请求</li>
<li>Docker Server:窗口运行的节点；</li>
<li>Containers 容器</li>
<li>images  docker映像文件 –&gt; 存于仓库之中</li>
<li>启动docker容器需要加载镜像文件 –&gt; docker仓库上的镜像加载进来</li>
<li>docker允许我们创建私有仓库</li>
<li>比较难的，如何创建映像文件</li>
<li>dockerfile:</li>
<li>namespace cgroup</li>
</ul>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><blockquote>
<p>lxc,openvz<br>lxc,linux container<br>libcontainer<br>Host OS –&gt; hypervisor –&gt; Guest OS<br>Host OS –&gt; hpervisor –&gt; user space（n个）</p>
</blockquote>
<h3 id="核心组件："><a href="#核心组件：" class="headerlink" title="核心组件："></a>核心组件：</h3><blockquote>
<p>docker client：docker的客户端工具，是用户使用docker的主要接口，docker client 与docker daemon通信并将结果返回给用户<br>docker deamon:运行于宿主机上，Docker守护进程 ，用户可通过docker client其交互<br>image:镜像文件是只读的；用来创建container,一个镜像可以运行多个container<br>镜像文件可以通Dockerfile文件来创建，可以从docker hub/registry下载；</p>
</blockquote>
<h3 id="repository"><a href="#repository" class="headerlink" title="repository"></a>repository</h3><blockquote>
<p>公共仓库:Docker hub/registry<br>私有仓库:docker registry<br>仓库可以存有:nginx image httpd image tomcat image<br>docker container: docker的运行实例，容器是一个隔离环境；  </p>
</blockquote>
<h3 id="另外两个重要组件："><a href="#另外两个重要组件：" class="headerlink" title="另外两个重要组件："></a>另外两个重要组件：</h3><blockquote>
<p>  docker link: 各docker容器这间能够通信<br>  docker volume:</p>
</blockquote>
<h2 id="二、Docker-YUM源的安装配置"><a href="#二、Docker-YUM源的安装配置" class="headerlink" title="二、Docker YUM源的安装配置"></a>二、Docker YUM源的安装配置</h2><h3 id="安装使用docker-通过使用epel源来实现，-CentOS7-自带的就有了"><a href="#安装使用docker-通过使用epel源来实现，-CentOS7-自带的就有了" class="headerlink" title="安装使用docker 通过使用epel源来实现， CentOS7 自带的就有了"></a>安装使用docker 通过使用epel源来实现， CentOS7 自带的就有了</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dockerfile </span><br><span class="line"> 自定义的docker 源 </span><br><span class="line"> [root@node1 ~]<span class="comment"># vim /etc/yum.repos.d/docker.repo </span></span><br><span class="line"> [dockerrepo]</span><br><span class="line"> name=Docker Repository</span><br><span class="line"> baseurl=https://yum.dockerproject.org/repo/main/centos/<span class="variable">$releasever</span>/</span><br><span class="line"> gpgcheck=1</span><br><span class="line"> gpgkey=https://yum.dockerproject.org/gpg</span><br><span class="line"> </span><br><span class="line">  [jin]</span><br><span class="line">  name=renjin2</span><br><span class="line">  baseurl=https://mirrors.aliyun.com/centos/7/os/x86_64/</span><br><span class="line">  gpgcheck=0</span><br><span class="line">  enabled=1</span><br><span class="line">  [extra]</span><br><span class="line">  name=renjin3</span><br><span class="line">  baseurl=https://mirrors.aliyun.com/centos/7/extras/x86_64/</span><br><span class="line">  gpgcheck=0</span><br><span class="line">  enabled=1</span><br><span class="line">  [epel]</span><br><span class="line">  name=renji4</span><br><span class="line">  baseurl=https://mirrors.aliyun.com/epel/7Server/x86_64/</span><br><span class="line">  gpgcheck=0</span><br><span class="line">  enabled=1</span><br><span class="line"> 或者可以使用自带的源 https://mirrors.aliyun.com/centos/7.2.1511/extras/x86_64</span><br><span class="line"> 查看docker版本的详细信息</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum info docker-engine</span></span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Installed Packages</span><br><span class="line">Name        : docker-engine</span><br><span class="line">Arch        : x86_64</span><br><span class="line">Version     : 17.04.0.ce</span><br><span class="line">Release     : 1.el7.centos</span><br><span class="line">Size        : 63 M</span><br><span class="line">Repo        : installed</span><br><span class="line">From repo   : dockerrepo</span><br><span class="line">Summary     : The open-source application container engine</span><br><span class="line">URL         : https://dockerproject.org</span><br><span class="line">License     : ASL 2.0</span><br><span class="line">Description : Docker is an open <span class="built_in">source</span> project to build, ship and run any application as a</span><br><span class="line">   : lightweight container.</span><br><span class="line">   : </span><br><span class="line">   : Docker containers are both hardware-agnostic and platform-agnostic. This means</span><br><span class="line">   : they can run anywhere, from your laptop to the largest EC2 compute instance and</span><br><span class="line">   : everything <span class="keyword">in</span> between - and they don<span class="string">&#x27;t require you to use a particular</span></span><br><span class="line"><span class="string">   : language, framework or packaging system. That makes them great building blocks</span></span><br><span class="line"><span class="string">   : for deploying and scaling web apps, databases, and backend services without</span></span><br><span class="line"><span class="string">   : depending on a particular stack or provider.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># yum -y install docker-engine</span></span><br><span class="line">[root@node1 ~]<span class="comment"># systemctl start docker.service </span></span><br></pre></td></tr></table></figure>
<h1 id="三、Dcoker-的简单测试及使用"><a href="#三、Dcoker-的简单测试及使用" class="headerlink" title="三、Dcoker 的简单测试及使用"></a>三、Dcoker 的简单测试及使用</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># docker images </span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">[root@node1 ~]<span class="comment"># docker search centos</span></span><br><span class="line">NAME                                   DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">centos                                 The official build of CentOS.                   3239      [OK]       </span><br><span class="line">jdeathe/centos-ssh                     CentOS-6 6.8 x86_64 / CentOS-7 7.3.1611 x8...   63                   [OK]</span><br><span class="line">jdeathe/centos-ssh-apache-php          CentOS-6 6.8 x86_64 - Apache / PHP-FPM / P...   25                   [OK]</span><br><span class="line">consol/centos-xfce-vnc                 Centos container with <span class="string">&quot;headless&quot;</span> VNC sessi...   24                   [OK]</span><br><span class="line">nimmis/java-centos                     This is docker images of CentOS 7 with dif...   24                   [OK]</span><br><span class="line">gluster/gluster-centos                 Official GlusterFS Image [ CentOS-7 +  Glu...   18                   [OK]</span><br><span class="line">million12/centos-supervisor            Base CentOS-7 with supervisord launcher, h...   15                   [OK]</span><br><span class="line">torusware/speedus-centos               Always updated official CentOS docker imag...   8                    [OK]</span><br><span class="line">egyptianbman/docker-centos-nginx-php   A simple and highly configurable docker co...   6                    [OK]</span><br><span class="line">nathonfowlie/centos-jre                Latest CentOS image with the JRE pre-insta...   5                    [OK]</span><br><span class="line">centos/mariadb55-centos7                                                               4                    [OK]</span><br><span class="line">centos/redis                           Redis built <span class="keyword">for</span> CentOS                          2                    [OK]</span><br><span class="line">harisekhon/centos-java                 Java on CentOS (OpenJDK, tags jre/jdk7-8)       2                    [OK]</span><br><span class="line">harisekhon/centos-scala                Scala + CentOS (OpenJDK tags 2.10-jre7 - 2...   2                    [OK]</span><br><span class="line">blacklabelops/centos                   CentOS Base Image! Built and Updates Daily!     1                    [OK]</span><br><span class="line">darksheer/centos                       Base Centos Image -- Updated hourly             1                    [OK]</span><br><span class="line">freenas/centos                         Simple CentOS Linux interactive container       1                    [OK]</span><br><span class="line">timhughes/centos                       Centos with systemd installed and running       1                    [OK]</span><br><span class="line">januswel/centos                        yum update-ed CentOS image                      0                    [OK]</span><br><span class="line">kz8s/centos                            Official CentOS plus epel-release               0                    [OK]</span><br><span class="line">grayzone/centos                        auto build <span class="keyword">for</span> centos.                          0                    [OK]</span><br><span class="line">repositoryjp/centos                    Docker Image <span class="keyword">for</span> CentOS.                        0                    [OK]</span><br><span class="line">otagoweb/centos                        Apache (with PHP7), built on CentOS 7           0                    [OK]</span><br><span class="line">vcatechnology/centos                   A CentOS Image <span class="built_in">which</span> is updated daily           0                    [OK]</span><br><span class="line">grossws/centos                         CentOS 6 and 7 base images with gosu and l...   0                    [OK]</span><br></pre></td></tr></table></figure>
<h3 id="之所以能搜索出来，是因为别人给我们做了公开的使用"><a href="#之所以能搜索出来，是因为别人给我们做了公开的使用" class="headerlink" title="之所以能搜索出来，是因为别人给我们做了公开的使用"></a>之所以能搜索出来，是因为别人给我们做了公开的使用</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># docker search busybox</span></span><br><span class="line">NAME                            DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">busybox                         Busybox base image.                             973       [OK]       </span><br><span class="line">progrium/busybox                                                                65                   [OK]</span><br><span class="line">radial/busyboxplus              Full-chain, Internet enabled, busybox made...   12                   [OK]</span><br><span class="line">container4armhf/armhf-busybox   Automated build of Busybox <span class="keyword">for</span> armhf devic...   6                    [OK]</span><br><span class="line">odise/busybox-python                                                            4                    [OK]</span><br><span class="line">multiarch/busybox               multiarch ports of ubuntu-debootstrap           2                    [OK]</span><br><span class="line">azukiapp/busybox                This image is meant to be used as the base...   2                    [OK]</span><br><span class="line">ofayau/busybox-jvm              Prepare busybox to install a 32 bits JVM.       2                    [OK]</span><br><span class="line">zanner/busybox                  https://github.com/sergej-kucharev/zanner-...   1                    [OK]</span><br><span class="line">ofayau/busybox-libc32           Busybox with 32 bits (and 64 bits) libs         1                    [OK]</span><br><span class="line">elektritter/busybox-teamspeak   Leightweight teamspeak3 container based on...   1                    [OK]</span><br><span class="line">getblank/busybox                Docker container busybox <span class="keyword">for</span> Blank              1                    [OK]</span><br><span class="line">prom/busybox                    Prometheus Busybox Docker base images           1                    [OK]</span><br><span class="line">skomma/busybox-data             Docker image suitable <span class="keyword">for</span> data volume cont...   1                    [OK]</span><br><span class="line">odise/busybox-curl                                                              1                    [OK]</span><br><span class="line">jahroots/busybox                Busybox containers                              0                    [OK]</span><br><span class="line">ggtools/busybox-ubuntu          Busybox ubuntu version with extra goodies       0                    [OK]</span><br><span class="line">cucy/busybox                    aouto  build busybox                            0                    [OK]</span><br><span class="line">freenas/busybox                 Simple Busybox interactive Linux container      0                    [OK]</span><br><span class="line">sdurrheimer/prom-busybox        Moved to https://hub.docker.com/r/prom/bus...   0                    [OK]</span><br><span class="line">jiangshouzhuang/busybox         busybox                                         0                    [OK]</span><br><span class="line">padcom/busybox-java             Oracle Java on BusyBox                          0                    [OK]</span><br><span class="line">futurenda/busybox               Mini busybox                                    0                    [OK]</span><br><span class="line">hongtao12310/busybox            <span class="keyword">for</span> busybox image based on the gcr.io/goog...   0                    [OK]</span><br><span class="line">ddn0/busybox                    fork of official busybox                        0                    [OK]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> [root@node1 ~]<span class="comment"># docker pull buxybox</span></span><br><span class="line"> [root@node1 ~]<span class="comment"># docker pull busybox</span></span><br><span class="line"> Using default tag: latest</span><br><span class="line"> latest: Pulling from library/busybox</span><br><span class="line"> 7520415ce762: Pull complete </span><br><span class="line"> Digest: sha256:32f093055929dbc23dec4d03e09dfe971f5973a9ca5cf059cbfb644c206aa83f 校验码 </span><br><span class="line"> Status: Downloaded newer image <span class="keyword">for</span> busybox:latest</span><br><span class="line">[root@node1 ~]<span class="comment"># docker pull hub.magedu.com:5000/busybox ##指定到哪台服务器上获取busybox [root@node1 ~]# docker images </span></span><br><span class="line"> REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"> busybox             latest              00f017a8c2a6        3 weeks ago         1.11MB</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># docker run -it busybox:latest /bin/sh ##启动一台虚拟机的实例 </span></span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br><span class="line">[root@node1 ~]<span class="comment"># docker ps ##查看正在运行的主机</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">7090d8fd9861        busybox:latest      <span class="string">&quot;/bin/sh&quot;</span>           2 minutes ago       Up 2 minutes                            boring_archimedes</span><br></pre></td></tr></table></figure>
<h1 id="四、-docker的常用命令总结"><a href="#四、-docker的常用命令总结" class="headerlink" title="四、 docker的常用命令总结"></a>四、 docker的常用命令总结</h1><h3 id="环境信息相关："><a href="#环境信息相关：" class="headerlink" title="环境信息相关："></a>环境信息相关：</h3><ul>
<li>info </li>
<li>version </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># docker info ##查看docker的环境信息</span></span><br><span class="line">[root@node1 ~]<span class="comment"># docker version ##查看docker的版本号 </span></span><br></pre></td></tr></table></figure>
<h3 id="系统维护相关："><a href="#系统维护相关：" class="headerlink" title="系统维护相关："></a>系统维护相关：</h3><ul>
<li>images</li>
<li>inspect</li>
<li>build 创建映像文件</li>
<li>commint 基于运行中的容器创建映像文件</li>
<li>pause/unpause</li>
<li>ps</li>
<li>rm</li>
<li>rmi</li>
<li>run</li>
<li>start/stop/restart</li>
<li>top</li>
<li>kill</li>
</ul>
<h3 id="日志信息相关："><a href="#日志信息相关：" class="headerlink" title="日志信息相关："></a>日志信息相关：</h3><ul>
<li>events</li>
<li>history</li>
<li>logs</li>
<li>Docer hub服务相关</li>
<li>login</li>
<li>logout</li>
<li>pull</li>
<li>push</li>
<li>search</li>
</ul>
<h3 id="基本操作："><a href="#基本操作：" class="headerlink" title="基本操作："></a>基本操作：</h3><ul>
<li>获取映像:pull </li>
<li>启动容器:run </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> [root@node1 ~]<span class="comment"># docker ps </span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"> 7090d8fd9861        busybox:latest      <span class="string">&quot;/bin/sh&quot;</span>           17 minutes ago      Up 17 minutes                           boring_archimedes</span><br><span class="line"> [root@node1 ~]<span class="comment"># docker kill 7090d8fd9861</span></span><br><span class="line"> 7090d8fd9861</span><br><span class="line"> [root@node1 ~]<span class="comment"># docker ps #结束一个docker进程 </span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"> [root@node1 ~]<span class="comment"># docker ps  -a #但不会删除容器</span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES</span><br><span class="line"> 7090d8fd9861        busybox:latest      <span class="string">&quot;/bin/sh&quot;</span>           20 minutes ago      Exited (137) 3 minutes ago                       boring_archimedes</span><br><span class="line"> [root@node1 ~]<span class="comment"># docker rm 7090d8fd9861 #此时会删除container</span></span><br><span class="line"> 7090d8fd9861</span><br><span class="line"> [root@node1 ~]<span class="comment"># docker ps  -a </span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"> [root@node1 ~]<span class="comment"># docker ps </span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line"> 2bca1aa3d38d        busybox:latest      <span class="string">&quot;/bin/sh&quot;</span>           4 minutes ago       Up 4 minutes                            naughty_goldberg</span><br><span class="line">[root@node1 ~]<span class="comment"># docker</span></span><br><span class="line"> docker                  docker-containerd-ctr   dockerd                 docker-proxy</span><br><span class="line"> docker-containerd       docker-containerd-shim  docker-init             docker-runc</span><br><span class="line">[root@node1 ~]<span class="comment"># docker commit 2bca1aa3d38d centos:newuser</span></span><br><span class="line"> sha256:08d1d05a6e490c31b0e4e3ffb9532a25bb3d9e8f588b30990338f1ae64b34286</span><br><span class="line">[root@node1 ~]<span class="comment"># docker</span></span><br><span class="line"> docker                  docker-containerd-ctr   dockerd                 docker-proxy</span><br><span class="line"> docker-containerd       docker-containerd-shim  docker-init             docker-runc</span><br><span class="line">[root@node1 ~]<span class="comment"># docker images</span></span><br><span class="line"> REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"> centos              newuser             08d1d05a6e49        9 seconds ago       1.11MB</span><br><span class="line"> busybox             latest              00f017a8c2a6        3 weeks ago         1.11MB</span><br><span class="line">[root@node1 ~]<span class="comment"># docker run -it --rm centos:newuser /bin/sh</span></span><br><span class="line"> / <span class="comment"># </span></span><br><span class="line">[root@node1 ~]<span class="comment"># docker kill fee1da85d418</span></span><br><span class="line"> fee1da85d418</span><br><span class="line">[root@node1 ~]<span class="comment"># docker ps -a </span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br></pre></td></tr></table></figure>
<ul>
<li>linux Kernel –&gt; libcontainer –&gt; (execdriver、networkdriver)–&gt; Docker Daemon (GraphDB) –&gt; API server –&gt; 用户<br>在docker 之外有个重要存储还需要GraphDB GraphDB也称为图式数据库</li>
</ul>
<h2 id="Docker应用："><a href="#Docker应用：" class="headerlink" title="Docker应用："></a>Docker应用：</h2><ul>
<li>镜像：包含了启动Docker容器所需要的文件系统层给及其内容；</li>
<li>基于UninFS采用分层结构实现;<br>  bootfs,rootfs;</li>
<li>registry:用于保存镜像的元数据,保存docker镜像层次结构和元数据；</li>
<li>reposistory:由具有某个功能的镜像的所有相关版本构建成的集合；</li>
<li>index:管理用户的账号、访问权限、镜像及镜像标签等等相关的;</li>
<li>graph:从registry中下载的Docker镜像需要保存在本地，此功能即由graph完成；</li>
<li>/var/lib/docker/graph;</li>
</ul>
<p>##与镜像相关的命令：</p>
<ul>
<li>docker images  列出本地的镜像</li>
<li>docker search   搜索</li>
<li>docker pull  下载镜像</li>
<li>docker push   上传镜像</li>
<li>docker login   登录</li>
<li>docker logout  登出</li>
</ul>
<h2 id="创建镜像：commint-build"><a href="#创建镜像：commint-build" class="headerlink" title="创建镜像：commint,build"></a>创建镜像：commint,build</h2><ul>
<li>删除本地镜像: rmi</li>
<li>容器：也可以想象成一个虚拟机</li>
<li>独立运行的一个或一组应用，以及它们运行的环境</li>
</ul>
<h2 id="命令："><a href="#命令：" class="headerlink" title="命令："></a>命令：</h2><ul>
<li>run,kill,stop,start,restart ,log,export,import</li>
</ul>
<h2 id="启动方法"><a href="#启动方法" class="headerlink" title="启动方法:"></a>启动方法:</h2><ul>
<li>通过镜像创建一个新的容器: run</li>
<li>启动一个处于停止状态的容器: start</li>
</ul>
<h2 id="容器本来就是应用的，当应用结束时，程序也会结束的；"><a href="#容器本来就是应用的，当应用结束时，程序也会结束的；" class="headerlink" title="容器本来就是应用的，当应用结束时，程序也会结束的；"></a>容器本来就是应用的，当应用结束时，程序也会结束的；</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># docker run busybox:latest /bin/echo &quot;hello world&quot;</span></span><br><span class="line"> hello world</span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># docker run -it --name=busybox busybox:latest /bin/sh</span></span><br><span class="line">[root@node1 ~]<span class="comment"># docker stop busybox ##正常停止一个容器，相当于正常关机</span></span><br><span class="line"> busybox</span><br></pre></td></tr></table></figure>
<h2 id="run命令"><a href="#run命令" class="headerlink" title="run命令:"></a>run命令:</h2><blockquote>
<p> –name= Assign a name to the container<br>-i,–interactive=false Keep STDIN open even if not attached<br>it,-tty=false Alocate a pseudo-TTY<br>–net=default Set the Network for the container</p>
</blockquote>
<h2 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h2><blockquote>
<p>检查本地是否存在指定的镜像，不存在则从registry下载；<br>利用镜像启动容器<br>分配一个文件系统，并且在只读的镜像层之外，挂载一个可读写层；<br>从宿主机配置的网桥口中，桥接一个虚拟接口给此容器;<br>从地址池中分配一个地址容器；<br>执行用户指定的应用程序；<br>程序执行完成后，容器即终止；<br>logs命令:获取一个容器的日志，获取其输出信息;<br>对于交互式模式启动的容器，终止可以使用exit 命令或ctrl+d组合键;</p>
</blockquote>
<h2 id="attach-附加至一个运行中的容器；"><a href="#attach-附加至一个运行中的容器；" class="headerlink" title="attach  附加至一个运行中的容器；"></a>attach  附加至一个运行中的容器；</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># docker start 31a67d66b2c2</span></span><br><span class="line">[root@node1 ~]<span class="comment"># docker attach busybox</span></span><br><span class="line">[root@node1 ~]<span class="comment"># docker run busybox:latest /bin/echo &quot;hello world&quot;</span></span><br><span class="line">[root@node1 ~]<span class="comment"># docker ps -a </span></span><br><span class="line"> CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES</span><br><span class="line"> d35a2673722e        busybox:latest      <span class="string">&quot;/bin/echo &#x27;hello ...&quot;</span>   13 seconds ago      Exited (0) 12 seconds </span><br><span class="line">[root@node1 ~]<span class="comment"># docker start d35a2673722e  </span></span><br><span class="line"> d35a2673722e</span><br><span class="line">[root@node1 ~]<span class="comment"># docker logs  cabd0e52f8f8 ##可以查看执行命令后的输出信息</span></span><br><span class="line"> hello world</span><br><span class="line"> hello world</span><br><span class="line"> hello world</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> / <span class="comment"># exit 终止当前容器  或者ctrl +d </span></span><br><span class="line"> attach </span><br><span class="line"> [root@node1 ~]<span class="comment"># docker start -i busybox  ##启动一个交互式一个接口</span></span><br><span class="line"> [root@node1 ~]<span class="comment"># docker start busybox </span></span><br><span class="line"> [root@node1 ~]<span class="comment"># docker attach busybox   ##附加至一个运行中的容器；</span></span><br><span class="line"> / <span class="comment"># </span></span><br><span class="line">```  </span><br><span class="line">  </span><br><span class="line"><span class="comment">## Docker Hub  </span></span><br><span class="line"></span><br><span class="line">* registry有两种</span><br><span class="line">* docker hub</span><br><span class="line">* private registry</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"> <span class="comment"># docker login</span></span><br><span class="line"> <span class="comment"># docker push busybox:latest</span></span><br><span class="line"> [root@node2 yum.repos.d]<span class="comment"># yum -y install docker-registry</span></span><br><span class="line"> 上条命令实质上安装的是另外的一个包</span><br><span class="line"> [root@node2 yum.repos.d]<span class="comment"># yum -y installdocker-distribution-2.6.0-1.el7.x86_64</span></span><br><span class="line"> [root@node1 yum.repos.d]<span class="comment"># systemctl start docker-distribution.service </span></span><br><span class="line"> [root@node1 yum.repos.d]<span class="comment"># ss -tnl | grep 5000</span></span><br><span class="line"> LISTEN     0      128         :::5000                    :::* </span><br><span class="line"> [root@node1 yum.repos.d]<span class="comment"># docker images </span></span><br><span class="line"> REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"> centos              newuser             08d1d05a6e49        2 weeks ago         1.11MB</span><br><span class="line"> centos              latest              98d35105a391        5 weeks ago         192MB</span><br><span class="line"> busybox             latest              00f017a8c2a6        6 weeks ago         1.11MB</span><br><span class="line"> [root@node1 yum.repos.d]<span class="comment"># </span></span><br><span class="line"> [root@node1 yum.repos.d]<span class="comment"># docker tag 08d1d05a6e49  192.168.99.15:5000/centos:1.2.1 给一个镜像打标签 </span></span><br><span class="line"> [root@node1 yum.repos.d]<span class="comment"># docker push 192.168.99.15:5000/centos:1.2.1</span></span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>ldirectord+ipvsadm之nat/dr模型的实现</title>
    <url>/2017/10/26/ldirectord-ipvsadm%E4%B9%8Bnat-dr%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="ldirectord-结合ipvsadm-配置nat-dr模型"><a href="#ldirectord-结合ipvsadm-配置nat-dr模型" class="headerlink" title="ldirectord 结合ipvsadm 配置nat,dr模型"></a>ldirectord 结合ipvsadm 配置nat,dr模型</h1><h2 id="一、nat模型"><a href="#一、nat模型" class="headerlink" title="一、nat模型"></a>一、nat模型</h2><ul>
<li>drector  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget ftp://172.16.0.1/pub/Sources/7.x86_64/crmsh/ldirectord-3.9.6-0rc1.1.1.x86_64.rpm</span></span><br><span class="line"><span class="comment"># yum -y install nginx (同时用于做为sorry主机)</span></span><br><span class="line"><span class="comment"># yum -y install ldirectord-3.9.6-0rc1.1.1.x86_64.rpm</span></span><br><span class="line"><span class="comment"># echo “sorry, the service is down for maintenance, is recovering” &gt; /usr/share/nginx/html/index.html </span></span><br></pre></td></tr></table></figure>
<h3 id="主机为两块网卡，-一个是桥接，一个仅主机-其中仅主机的配置静态地址为192-16-0-5"><a href="#主机为两块网卡，-一个是桥接，一个仅主机-其中仅主机的配置静态地址为192-16-0-5" class="headerlink" title="主机为两块网卡， 一个是桥接，一个仅主机 (其中仅主机的配置静态地址为192.16.0.5)"></a>主机为两块网卡， 一个是桥接，一个仅主机 (其中仅主机的配置静态地址为192.16.0.5)</h3><ul>
<li>开启核心转发功能 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward </span></span><br><span class="line">nodeff1</span><br><span class="line"><span class="comment"># yum -y install httpd </span></span><br><span class="line"><span class="comment"># echo “&lt;h1&gt;RS1&lt;/h1&gt;” &gt; /var/www/html/index.html  </span></span><br></pre></td></tr></table></figure>
<h3 id="主机为一块网卡，仅主机（配置静态地址为192-16-0-2）"><a href="#主机为一块网卡，仅主机（配置静态地址为192-16-0-2）" class="headerlink" title="主机为一块网卡，仅主机（配置静态地址为192.16.0.2）"></a>主机为一块网卡，仅主机（配置静态地址为192.16.0.2）</h3><h3 id="网关指向-192-16-0-5"><a href="#网关指向-192-16-0-5" class="headerlink" title="网关指向 192.16.0.5"></a>网关指向 192.16.0.5</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># route add default gw 192.16.0.5 </span></span><br><span class="line">node2   </span><br><span class="line"><span class="comment"># yum -y install nginx </span></span><br><span class="line"><span class="comment"># echo “&lt;h1&gt;RS2&lt;/h1&gt;” &gt; /var/www/html/index.html </span></span><br></pre></td></tr></table></figure>
<h3 id="主机为一块网卡，仅主机（配置静态地址为192-16-0-3）"><a href="#主机为一块网卡，仅主机（配置静态地址为192-16-0-3）" class="headerlink" title="主机为一块网卡，仅主机（配置静态地址为192.16.0.3）"></a>主机为一块网卡，仅主机（配置静态地址为192.16.0.3）</h3><h3 id="网关指向-192-16-0-5-1"><a href="#网关指向-192-16-0-5-1" class="headerlink" title="网关指向 192.16.0.5"></a>网关指向 192.16.0.5</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># route add default gw 192.16.0.5 </span></span><br></pre></td></tr></table></figure>
<h3 id="directory-此时-可以在drector主机上进行测试，"><a href="#directory-此时-可以在drector主机上进行测试，" class="headerlink" title="directory 此时:可以在drector主机上进行测试，"></a>directory 此时:可以在drector主机上进行测试，</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl 192.16.0.2 返回RS1 </span></span><br><span class="line"><span class="comment"># curl 192.16.0.3 返回RS2 </span></span><br></pre></td></tr></table></figure>
<h3 id="directory-使用ipvsadm指定调度算法及调度主机；"><a href="#directory-使用ipvsadm指定调度算法及调度主机；" class="headerlink" title="directory 使用ipvsadm指定调度算法及调度主机；"></a>directory 使用ipvsadm指定调度算法及调度主机；</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ipvsadm -A -t 172.16.250.89:80 -wrr </span></span><br><span class="line"><span class="comment"># ipvsadm -a -t 172.16.250.89:80 -r 192.16.0.2:80 -m -w 3 </span></span><br><span class="line"><span class="comment"># ipvsadm -a -t 172.16.250.89:80 -r 192.16.0.3:80 -m -w 1</span></span><br></pre></td></tr></table></figure>
<h3 id="在别的主机中测试结果"><a href="#在别的主机中测试结果" class="headerlink" title="在别的主机中测试结果"></a>在别的主机中测试结果</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..4&#125; ; do curl 172.16.250.89; done </span></span><br><span class="line">&lt;h1&gt;RS1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h1&gt;</span><br><span class="line"><span class="comment"># 将规则保存 ipvsadm -S &gt; /etc/sysconfig/ipvsadm </span></span><br></pre></td></tr></table></figure>
<ul>
<li>directory 配置ldirectord </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp /usr/share/doc/ldirectord-3.9.6/ldirectord.cf /etc/ha.d/ldirectord.cf </span></span><br><span class="line"><span class="comment"># vim /etc/ha.d/ldirectord.cf </span></span><br><span class="line">checktimeout=3</span><br><span class="line">checkinterval=1</span><br><span class="line">fallback=127.0.0.1:80</span><br><span class="line">autoreload=yes</span><br><span class="line">logfile=”/var/<span class="built_in">log</span>/ldirectord.log”</span><br><span class="line">quiescent=no</span><br><span class="line">virtual=172.16.250.89:80 </span><br><span class="line">real=192.16.0.2:80 masq 1</span><br><span class="line">real=192.16.0.3:80 masq 3</span><br><span class="line">fallback=127.0.0.1:80 masq</span><br><span class="line">service=http</span><br><span class="line">scheduler=wrr</span><br><span class="line">protocol=tcp</span><br><span class="line">checktype=negotiate</span><br><span class="line">checkport=80</span><br></pre></td></tr></table></figure>
<h3 id="注：virtual-172-16-250-89-80-，后面需要指定端口，否则protocol-tcp指定启动时会报错"><a href="#注：virtual-172-16-250-89-80-，后面需要指定端口，否则protocol-tcp指定启动时会报错" class="headerlink" title="注：virtual:172.16.250.89:80 ，后面需要指定端口，否则protocol=tcp指定启动时会报错"></a>注：virtual:172.16.250.89:80 ，后面需要指定端口，否则protocol=tcp指定启动时会报错</h3><h3 id="real-192-16-0-2-80-masq-因为上面配置的为nat模型，所以此处使用masq"><a href="#real-192-16-0-2-80-masq-因为上面配置的为nat模型，所以此处使用masq" class="headerlink" title="real=192.16.0.2:80 masq  因为上面配置的为nat模型，所以此处使用masq"></a>real=192.16.0.2:80 masq  因为上面配置的为nat模型，所以此处使用masq</h3><h3 id="fallback-172-0-0-1-80-此处便是nginx的sorry-server-但所有结点都停掉时，会向用户提供一个sorry-server"><a href="#fallback-172-0-0-1-80-此处便是nginx的sorry-server-但所有结点都停掉时，会向用户提供一个sorry-server" class="headerlink" title="fallback=172.0.0.1:80 此处便是nginx的sorry server,但所有结点都停掉时，会向用户提供一个sorry server"></a>fallback=172.0.0.1:80 此处便是nginx的sorry server,但所有结点都停掉时，会向用户提供一个sorry server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start ldirectord </span></span><br><span class="line"><span class="comment"># ipvsadm -Ln 查看结点 </span></span><br><span class="line">在别的主机中测试 </span><br><span class="line"><span class="comment">#for i in &#123;1..4&#125; ; do curl 172.16.250.89; done </span></span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">node1,node2 将两个结点手动停掉</span><br><span class="line"><span class="comment"># systemctl stop httpd  在测试主机中会返回sorry信息</span></span><br></pre></td></tr></table></figure>
<h1 id="二、dr-模型"><a href="#二、dr-模型" class="headerlink" title="二、dr 模型"></a>二、dr 模型</h1><ul>
<li>directory ,node1 ,node2 三台主机都是一块网块， 并且网卡都为桥接，且node1,nod2，不需要指定网关<h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#vim setkp.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line">vip=172.16.252.166</span><br><span class="line">mask=255.255.255.255</span><br><span class="line">interface=’lo:0′</span><br><span class="line">eth=’eno16777736:0′ </span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </span><br><span class="line">start) </span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">ifconfig <span class="variable">$interface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up </span><br><span class="line">route add -host <span class="variable">$vip</span> dev <span class="variable">$interface</span> </span><br><span class="line">;; </span><br><span class="line">dstart) </span><br><span class="line">ifconfig <span class="variable">$eth</span> <span class="variable">$vip</span>/32 netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up</span><br><span class="line">;;</span><br><span class="line">dstop)</span><br><span class="line">ifconfig <span class="variable">$eth</span> down</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">ifconfig <span class="variable">$interface</span> down </span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">;; </span><br><span class="line">status) </span><br><span class="line">ifconfig </span><br><span class="line">cat /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">cat /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">cat /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">cat /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">;; </span><br><span class="line">*)</span><br><span class="line"><span class="built_in">echo</span> “Usage: $(basename <span class="variable">$0</span>) &#123;dstart|dstop|start|stop&#125;”</span><br><span class="line"><span class="built_in">exit</span> 1 </span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<h3 id="在director主机中执行"><a href="#在director主机中执行" class="headerlink" title="在director主机中执行"></a>在director主机中执行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sh setkp.sh dstart </span></span><br><span class="line"><span class="comment"># sh setkp.sh status 查看状态</span></span><br><span class="line"><span class="comment"># scp setkp.sh 172.16.251.232:/root</span></span><br><span class="line"><span class="comment"># scp setkp.sh 172.16.251.191:/root </span></span><br><span class="line"><span class="comment"># ipvsadm -A -t 172.16.252.166:http -s wrr</span></span><br><span class="line"><span class="comment"># ipvsadm -a -t 172.16.252.166:http -r 172.16.251.232:http -g -w 1</span></span><br><span class="line"><span class="comment"># ipvsadm -a -t 172.16.252.166:http -r 172.16.251.191:http -g -w 3</span></span><br><span class="line"><span class="comment"># systemctl start nginx </span></span><br><span class="line"><span class="comment"># echo “Sorry Page” &gt; /usr/share/nginx/html/index.html </span></span><br></pre></td></tr></table></figure>
<h3 id="在node1主机中执行"><a href="#在node1主机中执行" class="headerlink" title="在node1主机中执行"></a>在node1主机中执行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sh setkp.sh start </span></span><br><span class="line"><span class="comment"># sh setkp.sh status </span></span><br><span class="line"><span class="comment"># systemctl start httpd </span></span><br><span class="line"><span class="built_in">echo</span> “&lt;h1&gt;NODE1&lt;/h1&gt;” &gt; /var/www/html/index.html </span><br></pre></td></tr></table></figure>
<h3 id="在node2主机中执行"><a href="#在node2主机中执行" class="headerlink" title="在node2主机中执行"></a>在node2主机中执行</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sh setkp.sh start</span></span><br><span class="line"><span class="comment"># sh setkp.sh status </span></span><br><span class="line"><span class="comment"># systemctl start httpd </span></span><br><span class="line"><span class="built_in">echo</span> “&lt;h2&gt;NODE2&lt;/h2&gt;” &gt; /var/www/html/index.html  </span><br></pre></td></tr></table></figure>
<h3 id="在其它主机中进行测试"><a href="#在其它主机中进行测试" class="headerlink" title="在其它主机中进行测试"></a>在其它主机中进行测试</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#for i in &#123;1..4&#125; ; do curl 172.16.252.166; done </span><br><span class="line">&lt;h1&gt;RS1&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;&#x2F;h2&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>ldirectord配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat /etc/ha.d/ldirectord.cf | grep -v  “^[[:space:]]*#” | grep -v “^[[:space:]]*$” </span></span><br><span class="line"><span class="comment"># vim /etc/ha.d/ldirectord.cf </span></span><br><span class="line">checktimeout=3</span><br><span class="line">checkinterval=1</span><br><span class="line">fallback=127.0.0.1:80</span><br><span class="line">autoreload=yes</span><br><span class="line">logfile=”/var/<span class="built_in">log</span>/ldirectord.log”</span><br><span class="line">quiescent=no</span><br><span class="line">virtual=172.16.252.166:80</span><br><span class="line">real=172.16.251.191:80 gate 1</span><br><span class="line">real=172.16.251.232:80 gate 3</span><br><span class="line">fallback=127.0.0.1:80 gate</span><br><span class="line">service=http</span><br><span class="line">scheduler=wrr</span><br><span class="line">protocol=tcp</span><br><span class="line">checktype=negotiate</span><br><span class="line">checkport=80</span><br><span class="line"><span class="comment"># systemctl start ldirectord </span></span><br></pre></td></tr></table></figure>
<h3 id="在其它主机中进行测试-1"><a href="#在其它主机中进行测试-1" class="headerlink" title="在其它主机中进行测试"></a>在其它主机中进行测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..4&#125; ; do curl 172.16.252.166; done </span></span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">当主机所有结点都停止服务时 （node1,node2）</span><br><span class="line"><span class="comment"># systemctl stop httpd </span></span><br><span class="line"><span class="comment"># for i in &#123;1..4&#125; ; do curl 172.16.252.166; done </span></span><br><span class="line">Sorry Page</span><br><span class="line">Sorry Page</span><br><span class="line">Sorry Page</span><br><span class="line">Sorry Page</span><br></pre></td></tr></table></figure>
<ul>
<li>借助防火墙标记来分类报文,而后标记定义集群服务，这样不同的服务可以使用一个集群进行调度,并启用持久连接 </li>
<li>将两台node结点启动 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start httpd </span></span><br></pre></td></tr></table></figure>
<h3 id="在director主机中配置"><a href="#在director主机中配置" class="headerlink" title="在director主机中配置"></a>在director主机中配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.252.166 -p tcp -m multiport –dport 80,443 -j MARK –set-mark 10 为端口打标记 </span></span><br><span class="line"><span class="comment"># ipvsadm -A -f 10 -s rr -p 360</span></span><br><span class="line"><span class="comment"># ipvsadm -a -f 10 -r 172.16.251.191:0 -g -w 1</span></span><br><span class="line"><span class="comment"># ipvsadm -a -f 10 -r 172.16.251.232:0 -g -w 1</span></span><br></pre></td></tr></table></figure>
<h3 id="在其它主机中进行测试-2"><a href="#在其它主机中进行测试-2" class="headerlink" title="在其它主机中进行测试"></a>在其它主机中进行测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..5&#125; ; do curl 172.16.252.166; done </span></span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br></pre></td></tr></table></figure>
<h3 id="在两台node结点上建立https服务"><a href="#在两台node结点上建立https服务" class="headerlink" title="在两台node结点上建立https服务"></a>在两台node结点上建立https服务</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nod1 </span><br><span class="line"><span class="comment"># mkdir /etc/httpd/cacert </span></span><br><span class="line"><span class="comment"># cd /etc/httpd/cacert </span></span><br><span class="line"><span class="comment"># (umask 066;openssl genrsa -out httpd.key 1024)</span></span><br><span class="line"><span class="comment"># openssl req -new -key httpd.key  -out httpd.crt -days 7200</span></span><br><span class="line"><span class="comment"># scp httpd.csr 172.16.252.162:/root</span></span><br></pre></td></tr></table></figure>
<h3 id="在director主机中生成自签证书"><a href="#在director主机中生成自签证书" class="headerlink" title="在director主机中生成自签证书"></a>在director主机中生成自签证书</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo 01 &gt; /etc/pki/CA/serial</span></span><br><span class="line"><span class="comment"># touch /etc/pki/CA/index.txt </span></span><br><span class="line"><span class="comment"># cd /etc/pki/CA/</span></span><br><span class="line"><span class="comment"># (umask 077; openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)</span></span><br><span class="line"><span class="comment"># openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</span></span><br><span class="line"><span class="comment"># openssl ca -in /root/httpd.csr  -out /tmp/httpd.crt</span></span><br><span class="line"><span class="comment"># scp /tmp/httpd.crt  172.16.251.232:/root</span></span><br><span class="line"><span class="comment"># scp /etc/pki/CA/cacert.pem  172.16.250.69:/root</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node2  </span><br><span class="line"><span class="comment"># mkdir /etc/httpd/cacert</span></span><br><span class="line">node1  </span><br><span class="line"><span class="comment"># cd /etc/httpd/cacert/ &amp;&amp; scp * 172.16.251.191:/etc/httpd/cacert/ </span></span><br><span class="line">nod1,node1 </span><br><span class="line"><span class="comment"># vim /etc/httpd/conf.d/ssl.conf  </span></span><br><span class="line">修改 : SSLCertificateFile /etc/httpd/cacert/httpd.crt</span><br><span class="line">SSLCertificateKeyFile /etc/httpd/cacert/httpd.key </span><br><span class="line"><span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure>
<h3 id="在其它主机中进行测试-3"><a href="#在其它主机中进行测试-3" class="headerlink" title="在其它主机中进行测试:"></a>在其它主机中进行测试:</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/hosts </span></span><br><span class="line">加入 : 172.16.252.166  www.rj.com </span><br></pre></td></tr></table></figure>
<h3 id="测试https与http的持久连接"><a href="#测试https与http的持久连接" class="headerlink" title="测试https与http的持久连接"></a>测试https与http的持久连接</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..4&#125; ;do curl –cacert /root/cacert.pem https://www.rj.com &amp;&amp; curl http://www.rj.com ; done </span></span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br></pre></td></tr></table></figure>
<h3 id="在-ldirectord-中实现"><a href="#在-ldirectord-中实现" class="headerlink" title="在 ldirectord 中实现"></a>在 ldirectord 中实现</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">driector  </span><br><span class="line"><span class="comment"># vim /etc/ha.d/ldirectord.cf </span></span><br><span class="line">checktimeout=3</span><br><span class="line">checkinterval=1</span><br><span class="line">fallback=127.0.0.1:80</span><br><span class="line">autoreload=yes</span><br><span class="line">logfile=”/var/<span class="built_in">log</span>/ldirectord.log”</span><br><span class="line">quiescent=no</span><br><span class="line">virtual=10</span><br><span class="line">real=172.16.251.191:80 gate 1</span><br><span class="line">real=172.16.251.232:80 gate 3</span><br><span class="line">fallback=127.0.0.1:80 gate</span><br><span class="line">service=http</span><br><span class="line">scheduler=wrr</span><br><span class="line">checktype=negotiate</span><br><span class="line">checkport=80</span><br><span class="line"><span class="comment"># systemctl start ldirectord</span></span><br><span class="line"><span class="comment"># ipvsadm -Ln </span></span><br></pre></td></tr></table></figure>
<h3 id="在其它主机中进行测试-4"><a href="#在其它主机中进行测试-4" class="headerlink" title="在其它主机中进行测试"></a>在其它主机中进行测试</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># for i in &#123;1..4&#125; ;do curl –cacert /root/cacert.pem https://www.rj.com &amp;&amp; curl http://www.rj.com ; done </span></span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS2&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br><span class="line">&lt;h1&gt;RS1&lt;/h2&gt;</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>笔记之--bash基础特性</title>
    <url>/2017/10/19/%E7%AC%94%E8%AE%B0%E4%B9%8B-bash%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="bash-基础特性"><a href="#bash-基础特性" class="headerlink" title="bash 基础特性"></a>bash 基础特性</h1><h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><p>systemctl set-default multi-user.target  </p>
<h3 id="图形模式"><a href="#图形模式" class="headerlink" title="图形模式"></a>图形模式</h3><p>systemctl set-default graphical.target  </p>
<h3 id="ipython安装使用"><a href="#ipython安装使用" class="headerlink" title="ipython安装使用"></a>ipython安装使用</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># python ipython </span><br><span class="line"># tar -xvf pip-8.1.2.tar.gz</span><br><span class="line"># tar -xvf setuptools-28.2.0.tar.gz</span><br><span class="line"># tar -xvf ipython-5.1.0</span><br><span class="line"># cd 到其各个目录中  python setup.py build &amp;&amp; pyton setup.py install </span><br><span class="line"># pip install traitlets</span><br><span class="line"># pip install pygments</span><br><span class="line"># pip install simplegeneric</span><br><span class="line"># pip install --upgrade setuptools pi</span><br><span class="line"># pip unistall ipython</span><br><span class="line"># pip uninstall ipython</span><br><span class="line"># pip install ipython</span><br><span class="line"># pip install jupyter</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jupyter-notebook --ip 0.0.0.0 --port 46  启动jupyter </span><br><span class="line">jupyter-nbconvert --to html filename.ipynb</span><br><span class="line">ipython nbconvert --to python &lt;YourNotebook&gt;.ipynb</span><br></pre></td></tr></table></figure>
<ul>
<li>历史记录的使用格式  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export HISTTIMEFORMAT&#x3D;&quot;&#96;whoami&#96;:%F%T&quot; </span><br></pre></td></tr></table></figure>
<ul>
<li>定义历史命令的格式  </li>
<li>HISTSIZE=1000000 定义命令的数量  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># rmdir [OPTION]...DIRECTORY... </span><br><span class="line">     -p:删除某录后，如果其父目录为空，则一并删除之</span><br><span class="line">     -v:显示过程</span><br><span class="line"># mkdir -pv &#x2F;tmp&#x2F;x&#123;y1&#x2F;&#123;a,b&#125;,y2&#125;</span><br><span class="line"># mkdir -v &#123;a,b&#125;_&#123;c,d&#125;</span><br><span class="line"># mkdir -pv &#x2F;tmp&#x2F;mysysroot&#x2F;&#123;bin,sbin,etc&#x2F;sysconfig&#x2F;network-scripts,usr&#x2F;</span><br><span class="line">  &#123;bin,sbin,local&#x2F;&#123;bin,sbin,etc,lib&#125;,lib,lib64&#125;,var&#x2F;&#123;cache,log,run&#125;&#125;</span><br><span class="line"># tree -L level指定显示层级</span><br></pre></td></tr></table></figure>
<ul>
<li>bash的基础特性：命令的执行状态结果  </li>
<li>命令执行的状态结果  </li>
<li>bash通过状态返回值来输出此结果  </li>
<li>成功0  失败1-255  </li>
<li>命令执行完成之后，其状态返回值保存在bash的特殊变量$?中  </li>
<li>命令正常执行时，有的还回有命令返回值  </li>
<li>根据命令及其功能不同，结果各不相同  </li>
<li>引用命令的执行结果；$(COMMAND)或<code>COMMAND</code>  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir $(date +%H-%M-%S)</span><br></pre></td></tr></table></figure>
<ul>
<li>bash 快捷键  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl +a ：跳转到命令行首</span><br><span class="line">ctrl +e ：跳转到命令行尾</span><br><span class="line">ctrl +u ：删除行首到光标所在处之间的所有字符</span><br><span class="line">ctrl +k ：删除光标所在处到行尾的所有字符</span><br><span class="line">ctrl +l ：清屏，相当于clear</span><br></pre></td></tr></table></figure>
<ul>
<li>文件查看类命令：cat,tac,head,tail,more,less  </li>
<li>分屏查看命令：more less  </li>
<li>more命令  </li>
<li>more　FILE　特点：翻屏至文件尾后自动退出  </li>
<li>less命令   </li>
<li>less  FILE</li>
<li>head命令</li>
<li>查看文件的前n行： head [options] FILE</li>
<li>-n # or -#</li>
<li>tail命令：</li>
<li>查看文件的后n行：tail [options] FILE </li>
<li>-n # or -#</li>
<li>注 -f ：output appended data as the file grows</li>
<li>查看内容后不退出，用来查看文件内的新增内容</li>
</ul>
<blockquote>
<p>stat /tmp/functions 用来显示文件的状态<br>stat FILE…   文件：两类数据  元数所：metadata   据数：data<br>时间戳 access time<br>       modify time<br>       change time    </p>
</blockquote>
<blockquote>
<p>touch 摸一个不存在的文件时，会创建空文件<br>      touch - change file timestamps<br>      touch [OPTION]…FILE…<br>      -c:指定的文件不存在时不予创建；<br>      -a:仅修改access time;<br>      -m:仅修改modify time;<br>      -t STAMP [[CC]YY]MMDDhhmm[-ss].  </p>
</blockquote>
<h2 id="bash基础特性"><a href="#bash基础特性" class="headerlink" title="bash基础特性"></a>bash基础特性</h2><ul>
<li>globbing:文件名通配(整体文件名匹配，而非部分)</li>
<li>*：匹配任意长度的任意字符</li>
<li>pa*所有以pa开头的文件</li>
<li><em>pa</em> <em>pa </em>p<em>a</em></li>
<li>?：匹配任意单个字符</li>
<li>pa?  paa ??pa p?a  p?a?</li>
<li>[]:匹配指定范围内的任意单个字符</li>
<li>有几种特殊格式 [ a-z],[A-Z],[a-z,0-9]</li>
<li>pa[0-9][0-9],2[0-9][0-9]</li>
</ul>
<h2 id="nmtui-NetworkManager"><a href="#nmtui-NetworkManager" class="headerlink" title="nmtui  NetworkManager"></a>nmtui  NetworkManager</h2><ul>
<li>root用户不一直是管理员，原因：管理员是可以更改的</li>
<li>tty命令查看终端类型：物理终端，伪终端，pts  虚拟终端tty 图形终端</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># echo $SHELL</span><br><span class="line"># cat &#x2F;etc&#x2F;shells</span><br><span class="line"># type pwd builtin(内置)  内置命令在&#x2F;bin&#x2F;bash 中</span><br><span class="line"># type ls 别名</span><br><span class="line">#     hashed(外置命令)</span><br><span class="line">#	 hash 显示命令缓存，作用提高系统查找命令的速度</span><br><span class="line">#	 hash -d  tty 指定删除 （注：指定别名时直接删除别名）</span><br><span class="line">#	 hash -r  全清空</span><br><span class="line">#	 hash -l 显示缓存</span><br><span class="line">#	 hash -p &#x2F;usr&#x2F;bin&#x2F;tty newtty 给缓存的命令起一个别名</span><br><span class="line">#	 hash -t 查看命令对应路径</span><br></pre></td></tr></table></figure>
<ul>
<li><p>alias </p>
<blockquote>
<p>eg ce7 grep 有别名   alias grep=’grep –color=auto’ 而ce6的grep没有<br>alias 别名要想生效要定义到 .bashrc中<br>别名比内部优先级高，内部命令比外部命令优先级高<br>alias  内部  外部  </p>
</blockquote>
</li>
<li><p>hashed 比PATH中定义的要高  </p>
</li>
<li>which -a cat  强置搜索cat所在的所有目录（注，如果命令有多个的话）  </li>
<li>which –skip-alias ls  查找ls所在目录时，跳过别名  </li>
<li>unalias  取消别名 -a 取消所有别名 同样只对当前终端生效  </li>
<li>注：bash自身是一个外部的命令  </li>
<li>查找内部命令的时候man 文档打开的相当于 man bash  </li>
<li><p>注：直接键入help时候，可以直接列出所有的内部命令  </p>
</li>
<li><p>enalbe -n pwd  临时禁用pwd命令 -a 启用</p>
</li>
<li>echo $[RANDOMM%80] 随机数的生成</li>
<li>注pwd 有外部命令</li>
<li><p>注只要是能只接man查到的命令，它都有外部命令</p>
</li>
<li><p>注PS1=\e[31m     \e[0m用来截止颜色 PS1=’\033[31m[\u@\h\W]\$\033[0m’</p>
</li>
<li><p>ascii 7 位 2^7=128字符</p>
</li>
<li><p>unicode（他可以把世界全部的文字都录入进来） 表 utf-8就是其中的一种</p>
</li>
<li><p>bc计算器  ibase=8 指定进制为八 ibase=16  指定进制为16   obase=8 指定输出为八进制</p>
</li>
<li><p>总结：alias nano bc enable (管理内部命令) -n</p>
</li>
<li><p>hash -d -r -l  type help which  man unalias</p>
</li>
<li><p>whereis     查看命令比which 更详细</p>
</li>
<li>hostname 查看主机名</li>
<li>仅对当前用户生效： ~/.bashrc</li>
<li><p>对所有用户生交： /etc/bashrc中</p>
</li>
<li><p>使用vmare 前期要有快照    可将vmware 下的文件复制出来</p>
</li>
<li><p>source 和 .  是等价的   eg source .bashrc   . .bashrc (注中间有空格)</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">假如有别名之后，要用它的真实名  &#x2F;bin&#x2F;grep   root &#x2F;etc&#x2F;passwd</span><br><span class="line">\grep   root &#x2F;etc&#x2F;passwd</span><br><span class="line">&#39;grep&#39;   root &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>命令  选项  参数<br>ls -la 短格式   –all短格式<br>区别：短格式可以简写连在一起而短的不能<br>还有的不须要 -    eg : ps a<br>pwd;ls;hostname   多个命令可以用;隔开<br>命令太过长时可加\<br>ls -l (意思为list)<br>-rw——-. 1 root root    1537 Oct  4 01:52 anaconda-ks.cfg<br>什么时候修改的  </p>
<ul>
<li>d  b(block) l s(sock) c（chararter）<br>-p (pip)    注在本机内部的两个程序通信时借助于socket文件    </li>
</ul>
</blockquote>
<blockquote>
<p>硬盘IDE SCSI SATA SAS (用于服务器面)<br>/dev/hd(IDE)  /dev/sd(除IDE之外的) /dev/vd(虚拟的)<br>lsblk 显示块文件<br>随机访问：可以直接去访问那个文件<br>c (c………………hararter) 须要顺序访问 ll /dev/zero<br>df  可查看分区的利用率<br>mount 挂载，映射<br>/dev/sda1  ==mount==&gt; (映射到) /boot (C:) 挂载点<br>把一个设备mount dir(挂载点)<br>dd if（输入文件）=/dev/zero of=f1 count=1<br>hexdump -v -C f1  可查看二进制文件<br>od  也可以<br>cat 用于看文本<br>/dev/null（空）系统黑洞<br>dd if=/dev/sda of=/dev/null<br>nano /etc/DIR_COLORS 可更改系统文件的颜色<br>ctrl +D 正常退出（退出当前进程）  ctrl +C 强行退出<br>date -u 其它区的时间 </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[11:54:27root@clu~]# cal 9 1752</span><br><span class="line">                         September 1752   </span><br><span class="line">                       Su Mo Tu We Th Fr Sa</span><br><span class="line">                              1  2 14 15 16</span><br><span class="line">                       17 18 19 20 21 22 23</span><br><span class="line">                       24 25 26 27 28 29 30</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：cd /misc/cd  df  ？？？？？<br>screen -S （session）renjin    创建会话  screen -x 加入会话   exit 退出  ctrl +a,d 剥离当前会话<br>screen -ls显示当前会话  screen -r 还原会话<br>补screen -S some_name -X quit<br>mount /dev/sr0  /mnt/yum mount /dev/cdrom  /mnt/yum<br>步骤 当前机器 screen -S renjin    另一台机器screen -x  renjin<br>echo  -n 不换行<br>-e 可开启\特性（\a发声\c不换行\n强制再换行\t tab \b退格x\r光标移到行首，但不换行<br>\033[43(背景色);33m   \033[0m   \HH 十六进投影  \e “\x#”打印ascii \onnn八进制asciic &lt; </p>
</blockquote>
<blockquote>
<p>echo ‘只任字符串（强）’                           eg echo -e “a\nb”<br>echo <code>命令和引用都能实别</code><br>echo “处于中间状态（弱）”<br>命令调用另一个命令，被调用的命令用的反向单引号<code>touch `date +%F`.log  
touch `hostname`.txt  $() 与</code>是等价的<br>linux ls 列出的顺序尊重ascii码的顺序 大写字母在小写字母前  Aa Bb<br>touch f{a,b,c}.{txt,log} touch f{a,b,c}.{txt,log}<br>echo {000（初始数，定义了位的0）..30（0到30）..2(每次递增2)}<br>echo {a-z}</p>
</blockquote>
]]></content>
  </entry>
  <entry>
    <title>GIT简单使用及服务器日常错误处理</title>
    <url>/2017/10/18/GIT%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="git-简单使用"><a href="#git-简单使用" class="headerlink" title="git 简单使用"></a>git 简单使用</h1><ul>
<li>gitlab 新建项目<br><a href="http://10.180.55.111:8088/dashboard/projects/">gitlab 本地新建地址</a><br> <a href="http://10.180.55.111:8088/dashboard/projects/">http://10.180.55.111:8088/dashboard/projects/</a><br> 点击  New Project —&gt; RenJin  /   You project name —&gt; Create Project</li>
<li>终端中的配置  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># git config --global user.name &quot;Jin.Ren&quot;</span><br><span class="line"># git config --global user.emal &quot;renjin@transfereasy.com&quot;</span><br><span class="line">查看本机的密钥，添加至gitlab中</span><br><span class="line"># cat ~&#x2F;.ssh&#x2F;id_rsa.pub</span><br></pre></td></tr></table></figure>
<ul>
<li><p>复制密钥至  </p>
<p>   gitlab 点击左下脚的用户名 —&gt; Profile Settings –&gt;SSH Keys —&gt; (key) —&gt; Add key  </p>
</li>
<li><p>git本地新项目上传  </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mkdir deplay-test</span><br><span class="line"># git init </span><br><span class="line"># vim secruity.sh</span><br><span class="line"># vim rolbask.sh </span><br><span class="line"># chmod +x *.sh</span><br><span class="line"># git commit -m &quot;security scripts&quot;</span><br><span class="line"># git remote add origin git@10.180.55.111:Jin.Ren&#x2F;deplay-test.git</span><br><span class="line"># git push -u origin master  </span><br></pre></td></tr></table></figure>
<ul>
<li>git上传已经存在的repository</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cd old-deplay </span><br><span class="line"># git remote add origin git@10.180.55.111:Jin.Ren&#x2F;deplay-test.git</span><br><span class="line"># git push -u origin master</span><br></pre></td></tr></table></figure>
<ul>
<li>git 上传已经存在的repository  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># git checkout -b seq</span><br><span class="line"># git branch </span><br><span class="line"># git checkout master  </span><br><span class="line">可以切换回master分支</span><br></pre></td></tr></table></figure>
<ul>
<li>补充mysql数据的导入导出</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mysqldump -uuser -ppasswd -hhost --databases data &gt; &#x2F;tmp&#x2F;database.sql</span><br></pre></td></tr></table></figure>
<h1 id="mongo生产报错总结"><a href="#mongo生产报错总结" class="headerlink" title="mongo生产报错总结"></a>mongo生产报错总结</h1><ul>
<li>python 记入mongo时会报错 2.x 与 3.x 使用的加密方式不同<br>ubuntu升级mongo2.x到3.x </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># sudo apt-key adv --keyserver hkp:&#x2F;&#x2F;keyserver.ubuntu.com:80 --recv 7F0CEB10</span><br><span class="line"># echo &quot;deb http:&#x2F;&#x2F;repo.mongodb.org&#x2F;apt&#x2F;ubuntu &quot;$(lsb_release -sc)&quot;&#x2F;mongodb-org&#x2F;3.0 multiverse&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;mongodb-org-3.0.list</span><br><span class="line"># sudo apt-get update</span><br><span class="line"># sudo apt-get install -y mongodb-org&#x3D;3.0.1 mongodb-org-server&#x3D;3.0.1 mongodb-org-shell&#x3D;3.0.1 mongodb-org-mongos&#x3D;3.0.1 mongodb-org-tools&#x3D;3.0.1</span><br><span class="line"># su - root -c &quot;echo &#39;never&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&quot;</span><br><span class="line"># su - root -c &quot;echo &#39;never&#39; &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;defrag&quot;</span><br><span class="line"># sudo &#x2F;etc&#x2F;init.d&#x2F;mongodb start</span><br><span class="line"># mogon #此处便可以看到版本号了</span><br><span class="line"># mogodb默认是没有密码的，需要在配置文件中将认证开启（但在此之前配置好用户有名和密码）</span><br><span class="line"># mogon</span><br><span class="line">&#123; user: &quot;&lt;name&gt;&quot;,  </span><br><span class="line">  pwd: &quot;&lt;cleartext password&gt;&quot;,</span><br><span class="line">  customData: &#123; &lt;any information&gt; &#125;, # 任意的数据,一般是用于描述用户管理员的信息</span><br><span class="line">  roles: [</span><br><span class="line">    &#123; role: &quot;&lt;role&gt;&quot;, db: &quot;&lt;database&gt;&quot; &#125; | &quot;&lt;role&gt;&quot;, # 如果是role就是直接指定了角色,并作用于当前的数据库</span><br><span class="line">    ...</span><br><span class="line">  ] # roles是必传项,但是可以指定空数组,为空就是不指定任何权限</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">use products # mongoDB的权限设置是以库为单位的,必选要先选择库</span><br><span class="line">db.createUser( </span><br><span class="line">&#123; &quot;user&quot; : &quot;accountAdmin01&quot;, </span><br><span class="line"> &quot;pwd&quot;: &quot;cleartext password&quot;,</span><br><span class="line"> &quot;customData&quot; : &#123; employeeId: 12345 &#125;,</span><br><span class="line"> &quot;roles&quot; : [ &#123; role: &quot;clusterAdmin&quot;, db: &quot;admin&quot; &#125;, </span><br><span class="line">             &#123; role: &quot;readAnyDatabase&quot;, db: &quot;admin&quot; &#125;,</span><br><span class="line">             &quot;readWrite&quot; </span><br><span class="line">             ] &#125;,</span><br><span class="line">&#123; w: &quot;majority&quot; , wtimeout: 5000 &#125; ) # readWrite 适用于products库,clusterAdmin与readAnyDatabase角色适用于admin库</span><br></pre></td></tr></table></figure>
<h2 id="mac测试环境多版本php添加mongo报错-php-h-file-not-fond"><a href="#mac测试环境多版本php添加mongo报错-php-h-file-not-fond" class="headerlink" title="mac测试环境多版本php添加mongo报错 php.h file not fond"></a>mac测试环境多版本php添加mongo报错 php.h file not fond</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp -r /Library/Developer/Command LineTools/SDKs/MacOSX10.12.sdk/usr/i nclude /Applications/MAMP/bin/php/ph p5.6.10/  </span></span><br><span class="line"><span class="comment"># brew install pcre</span><span class="comment"># sudo ./pecl install mongodb</span></span><br></pre></td></tr></table></figure>
<h2 id="nginx-重写443全局生效的两种方式"><a href="#nginx-重写443全局生效的两种方式" class="headerlink" title="nginx 重写443全局生效的两种方式"></a>nginx 重写443全局生效的两种方式</h2><h3 id="在server中新开起一个000-http2https-conf虚拟主机"><a href="#在server中新开起一个000-http2https-conf虚拟主机" class="headerlink" title="在server中新开起一个000-http2https.conf虚拟主机"></a>在server中新开起一个000-http2https.conf虚拟主机</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  80;</span><br><span class="line">    server_name _;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$HOST</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#server &#123;</span></span><br><span class="line"><span class="comment">#    listen 80;</span></span><br><span class="line"><span class="comment">#    server_name test.com;</span></span><br><span class="line"><span class="comment">#   rewrite ^(.*)$  https://$host$1 permanent;  </span></span><br><span class="line"><span class="comment">#    </span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="nginx-临时返回一个值或一个地址"><a href="#nginx-临时返回一个值或一个地址" class="headerlink" title="nginx 临时返回一个值或一个地址"></a>nginx 临时返回一个值或一个地址</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    location &#x2F;rjyy &#123;</span><br><span class="line">    return &#39;https:&#x2F;&#x2F;rjyy.ssjinyao.com&#39; ;</span><br><span class="line">&#125;</span><br><span class="line">    location &#x2F;nene &#123;</span><br><span class="line">    return &#39;https:&#x2F;&#x2F;nene.ssjinyao.com&#39; ;</span><br><span class="line">&#125;</span><br><span class="line">    location &#x2F;sange.html &#123;</span><br><span class="line">    return 200 &#39;&lt;h1&gt;mei tou nao a&lt;&#x2F;h1&gt;&#39; ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ssh不能key登录"><a href="#ssh不能key登录" class="headerlink" title="ssh不能key登录"></a>ssh不能key登录</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">查看.ssh 与 authorized_keys的权限</span><br><span class="line">查看/etc/ssh配置问题</span><br><span class="line">AuthorizedKeysFile	%h/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<h2 id="允许HTTP上传文件，并设定大小"><a href="#允许HTTP上传文件，并设定大小" class="headerlink" title="允许HTTP上传文件，并设定大小"></a>允许HTTP上传文件，并设定大小</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;php.ini</span><br><span class="line">file_uploads &#x3D; on; 是否允许通过HTTP上传文件的开关。默认为ON即是开;</span><br><span class="line">upload_tmp_dir;  文件上传至服务器上存储临时文件的地方，如果没指定就会用系统默认的临时文件夹;</span><br><span class="line">post_max_filesize &#x3D; 8m;  允许上传文件大小的最大值。默认为2M; </span><br><span class="line">post_max_size 8m; 指通过表单POST给PHP的所能接收的最大值，包括表单里的所有值。默认为8M; </span><br></pre></td></tr></table></figure>
<h2 id="gitlab-ci-持续化发布平台"><a href="#gitlab-ci-持续化发布平台" class="headerlink" title="gitlab-ci 持续化发布平台"></a>gitlab-ci 持续化发布平台</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># gitlab-ci 认证是一坑，版本不兼容的话一直会认证失败的,gitlab-ci 与gilab 可以不在同一台服务器; </span><br><span class="line"># 但是可以堡垒机放在同一台服务器上;</span><br><span class="line"># apt-get install  gitlab-ci-multi-runner&#x3D;1.10.2</span><br><span class="line"># gitlab-ci-multi-runner register</span><br><span class="line">http:&#x2F;&#x2F;xxx.xx.xxx.xxx:8080&#x2F;ci</span><br><span class="line">如果是建立公共runner，则需要以root登录gitlab --&gt; root --&gt; Admin Area --&gt; Ruuners -&gt; 可以查看到变红的koen </span><br><span class="line">deploy</span><br><span class="line">shell</span><br><span class="line">shell</span><br></pre></td></tr></table></figure>
<p>便可以添加上了</p>
<p>在指定分支中添加.gitlab-ci.yml ，如test分支</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">before_script:</span><br><span class="line">    - cd &#x2F;xxxxx&#x2F;xxxx&#x2F;deploy_ci</span><br><span class="line">job:</span><br><span class="line">    only: </span><br><span class="line">        - test</span><br><span class="line">    tags:</span><br><span class="line">        - inner</span><br><span class="line">    script:</span><br><span class="line">        - &#x2F;usr&#x2F;bin&#x2F;fab -f xx-deploy.py xxxxxx:test,0</span><br></pre></td></tr></table></figure>
<h3 id="关于python-部署的坑"><a href="#关于python-部署的坑" class="headerlink" title="关于python 部署的坑"></a>关于python 部署的坑</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 项目目录 &#x2F;root&#x2F;text&#x2F;</span><br><span class="line"># 需要执行的代码  &#x2F;root&#x2F;text&#x2F;poor&#x2F;fober.py</span><br><span class="line"># config 配置文件 &#x2F;root&#x2F;text&#x2F;config&#x2F;config.py</span><br><span class="line">共两种解决方式</span><br><span class="line">1. 添加v.pth 在ENV中 </span><br><span class="line"># virtualenv &#x2F;root&#x2F;text&#x2F;ENV</span><br><span class="line"># vim &#x2F;root&#x2F;text&#x2F;ENV&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;v.pth</span><br><span class="line">&#x2F;root&#x2F;text</span><br><span class="line">2. 在调用config前，定义好目录</span><br><span class="line"># sys.path.append(&#39;&#x2F;root&#x2F;text&#x2F;&#39;)</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
</search>
