<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>python ä¼ä¸šå¾®ä¿¡-å¾®ä¿¡ä¿¡æ¯å‘é€</title>
      <link href="/2020/05/13/python%20%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1-%E5%BE%AE%E4%BF%A1%E4%BF%A1%E6%81%AF%E5%8F%91%E9%80%81/"/>
      <url>/2020/05/13/python%20%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1-%E5%BE%AE%E4%BF%A1%E4%BF%A1%E6%81%AF%E5%8F%91%E9%80%81/</url>
      <content type="html"><![CDATA[<h1 id="python-ä¼ä¸šå¾®ä¿¡-å¾®ä¿¡ä¿¡æ¯å‘é€"><a href="#python-ä¼ä¸šå¾®ä¿¡-å¾®ä¿¡ä¿¡æ¯å‘é€" class="headerlink" title="python ä¼ä¸šå¾®ä¿¡-å¾®ä¿¡ä¿¡æ¯å‘é€"></a>python ä¼ä¸šå¾®ä¿¡-å¾®ä¿¡ä¿¡æ¯å‘é€</h1><p><img src="/images/qiyeweixin-python.jpg" alt=""></p><p>ä¸»è¦ç”¨åˆ°çš„æ¨¡å— urllib,json,simplejson,requests,bs4 </p><ul><li>urllib: urllibçš„requestæ¨¡å—å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æŠ“å–URLå†…å®¹ï¼Œä¹Ÿå°±æ˜¯å‘é€ä¸€ä¸ªGETè¯·æ±‚åˆ°æŒ‡å®šçš„é¡µé¢ï¼Œç„¶åè¿”å›HTTPçš„å“åº”;</li><li>json: JSON(JavaScript Object Notation) æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ã€‚æ˜“äºäººé˜…è¯»å’Œç¼–å†™ã€‚åŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆ;</li><li>simplesjon: simplejson æ˜¯ json æ ‡å‡†æ¨¡å—çš„æ‰©å±•ï¼ˆåŸºç¡€åŠŸèƒ½ç›¸åŒï¼‰ï¼Œæ˜¯ pypi æä¾›çš„æ‹“å±•æ¨¡å—ï¼Œéœ€è¦å¦è¡Œå®‰è£…ã€‚ä¸è¿‡å¯ä»¥ä½¿ç”¨ python è‡ªå¸¦çš„ json åº“ï¼ŒåŸºæœ¬æ˜¯ç›¸åŒçš„ä½¿ç”¨æ–¹æ³•(æä¾›çš„æ¥å£åŠŸèƒ½åŸºæœ¬ä¸€è‡´)ã€‚åœ¨ python çš„ library æ–‡æ¡£ä¸­å°† JSON å½’ä¸ºç½‘ç»œæ•°æ®æ§åˆ¶ç±»ï¼Œå¾ˆå¥½çš„è¯´æ˜äº†ä»–ä»¬çš„ç”¨é€”ï¼Œä¸»è¦ç”¨äºç½‘ç»œæ•°æ®æ§åˆ¶ï¼Œç¼–è§£ç ç­‰ã€‚ä½†æ˜¯ä¹Ÿå…·æœ‰å…¶ä»–çš„ç”¨é€”ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥ä½œä¸ºé…ç½®æ–‡ä»¶çš„è¯»å†™æ¨¡å—ï¼Œç®€å•çš„æ–‡ä»¶æ“ä½œç­‰;</li><li>requests: python HTTPåº“ï¼Œä¸€èˆ¬ç”¨äºçˆ¬è™«;</li><li>Beautiful Soupæä¾›ä¸€äº›ç®€å•çš„ã€pythonå¼çš„å‡½æ•°ç”¨æ¥å¤„ç†å¯¼èˆªã€æœç´¢ã€ä¿®æ”¹åˆ†ææ ‘ç­‰åŠŸèƒ½ã€‚å®ƒæ˜¯ä¸€ä¸ªå·¥å…·ç®±ï¼Œé€šè¿‡è§£ææ–‡æ¡£ä¸ºç”¨æˆ·æä¾›éœ€è¦æŠ“å–çš„æ•°æ®ï¼Œå› ä¸ºç®€å•ï¼Œæ‰€ä»¥ä¸éœ€è¦å¤šå°‘ä»£ç å°±å¯ä»¥å†™å‡ºä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åº;</li></ul><h2 id="åˆ›å»ºä¼ä¸šå¾®ä¿¡ç”¨åº”ç”¨"><a href="#åˆ›å»ºä¼ä¸šå¾®ä¿¡ç”¨åº”ç”¨" class="headerlink" title="åˆ›å»ºä¼ä¸šå¾®ä¿¡ç”¨åº”ç”¨"></a>åˆ›å»ºä¼ä¸šå¾®ä¿¡ç”¨åº”ç”¨</h2><p>æ³¨: è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ä¸ªäººæ³¨å†Œçš„ä¼ä¸šå¾®ä¿¡ï¼Œå› ä¸ºéœ€è¦ç®¡ç†å‘˜çš„æƒé™</p><p>ç”¨ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜ç™»å½•åï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºç”¨äºé€é€šçŸ¥ä¿¡æ¯</p><p><img src="/images/qiyeweixing.png" alt=""></p><p>æˆ‘è¿™é‡Œå·²ç»æ–°å»ºå¥½äº†ä¸“ç”¨åº”ç”¨ï¼Œç‚¹è¿›å»åæ·»åŠ å¯è§åº”ç”¨çš„äººã€‚ä¹Ÿå°±æ˜¯æ‰€è°“çš„åº”ç”¨æˆæƒã€‚</p><p><img src="/images/qiyeweixin-user.png" alt=""></p><p>åœ¨è¿™é‡Œè¦è®°å½•ä¸‹ <strong>Agentid</strong>  å’Œ <strong>Secert</strong> ç”¨äºå‘é€é€šæ—¶çš„è®¤è¯å£ä»¤</p><p><img src="/images/weixintongzhi-qiyeid.png" alt=""><br>ç‚¹å‡»æˆ‘çš„ä¼ä¸š â€“&gt;ä¼ä¸šä¿¡æ¯ ï¼Œåœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°<strong>ä¼ä¸šID</strong>, ä¹Ÿç”¨äºä»£ç ä¸­é…ç½®çš„é€šçŸ¥idç”¨</p><p>å¥½äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å†™ä»£ç äº†ï¼Œåœ¨æ­¤ï¼Œæˆ‘è¦å‘é€çš„ä¿¡æ¯æ˜¯<strong>å¤©æ°”ä¿¡æ¯</strong>ï¼Œ<strong>æ¯æ—¥é‡‘å¥</strong>ï¼Œå’Œ<strong>é€šçŸ¥ä¸“é¡¹</strong>ç­‰ä¿¡æ¯</p><h2 id="ç¬¬ä¸‰æ–¹ç½‘ç«™ã€æ¥å£"><a href="#ç¬¬ä¸‰æ–¹ç½‘ç«™ã€æ¥å£" class="headerlink" title="ç¬¬ä¸‰æ–¹ç½‘ç«™ã€æ¥å£"></a>ç¬¬ä¸‰æ–¹ç½‘ç«™ã€æ¥å£</h2><p>ä¸­å›½å¤©æ°”ç½‘  <a href="http://www.weather.com.cn/weather/101100201.shtml" target="_blank" rel="external">å¤©æ°”ä¿¡æ¯</a><br>åœ¨è¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯å¤§åŒçš„å¤©æ°”é¡µé¢<br><img src="/images/weixintongzhi-tianqi.png" alt=""></p><p><a href="https://v1.hitokoto.cn/" target="_blank" rel="external">ä¸€è¨€æ¥å£</a><br><a href="https://developer.hitokoto.cn/sentence" target="_blank" rel="external">ä¸€è¨€æ¥å£ä½¿ç”¨æ–‡æ¡£</a></p><p>æ¥å£ä¿¡æ¯å¦‚ä¸‹</p><p><img src="/images/weixintongzhi-yiyan.png" alt=""></p><h2 id="python-çˆ¬å–å¤©æ°”â€“-gt-è°ƒç”¨ä¸€è¨€æ¥å£â€“-gt-ä¸“é¡¹é€šçŸ¥"><a href="#python-çˆ¬å–å¤©æ°”â€“-gt-è°ƒç”¨ä¸€è¨€æ¥å£â€“-gt-ä¸“é¡¹é€šçŸ¥" class="headerlink" title="python çˆ¬å–å¤©æ°”â€“&gt;è°ƒç”¨ä¸€è¨€æ¥å£â€“&gt;ä¸“é¡¹é€šçŸ¥"></a>python çˆ¬å–å¤©æ°”â€“&gt;è°ƒç”¨ä¸€è¨€æ¥å£â€“&gt;ä¸“é¡¹é€šçŸ¥</h2><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ç™»å½•ä¸ªäººæœåŠ¡å™¨ï¼Œsource python3 ç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># alias mp3='source  ~/mypython/py3_env/bin/activate &amp;&amp; cd ~/mypython/python3'</span></div><div class="line">~]<span class="comment"># mp3</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> urllib</div><div class="line"><span class="keyword">import</span> urllib.request <span class="keyword">as</span> urllib2</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> simplejson</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"></div><div class="line"><span class="comment"># reload(sys)</span></div><div class="line"><span class="comment"># sys.setdefaultencoding('utf-8')</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gettoken</span><span class="params">(corpid,corpsecret)</span>:</span></div><div class="line">    gettoken_url = <span class="string">'https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid='</span> + corpid + <span class="string">'&amp;corpsecret='</span> + corpsecret</div><div class="line">    print(gettoken_url)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        token_file = urllib2.urlopen(gettoken_url)</div><div class="line">    <span class="keyword">except</span> urllib2.HTTPError <span class="keyword">as</span> e:</div><div class="line">        print(e.code)</div><div class="line">        print(e.read().decode(<span class="string">"utf8"</span>))</div><div class="line">        sys.exit()</div><div class="line">    token_data = token_file.read().decode(<span class="string">'utf-8'</span>)</div><div class="line">    token_json = json.loads(token_data)</div><div class="line">    token_json.keys()</div><div class="line">    token = token_json[<span class="string">'access_token'</span>]</div><div class="line">    <span class="keyword">return</span> token</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">senddata</span><span class="params">(access_token,user,subject,content)</span>:</span></div><div class="line"></div><div class="line">    send_url = <span class="string">'https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token='</span> + access_token</div><div class="line">    send_values = &#123;</div><div class="line">        <span class="string">"touser"</span>: user,   <span class="comment">#ä¼ä¸šå·ä¸­çš„ç”¨æˆ·å¸å·ï¼Œå¦‚æœé…ç½®ä¸æ­£å¸¸ï¼Œå°†æŒ‰éƒ¨é—¨å‘é€ã€‚</span></div><div class="line">        <span class="string">"toparty"</span>:<span class="string">"2"</span>,        <span class="comment">#ä¼ä¸šå·ä¸­çš„éƒ¨é—¨idã€‚</span></div><div class="line">        <span class="string">"msgtype"</span>:<span class="string">"text"</span>,     <span class="comment">#æ¶ˆæ¯ç±»å‹ã€‚</span></div><div class="line">        <span class="string">"agentid"</span>:<span class="string">"100xxxxx"</span>,  <span class="comment">#ä¼ä¸šå·ä¸­çš„åº”ç”¨idã€‚</span></div><div class="line">        <span class="string">"text"</span>:&#123;</div><div class="line">            <span class="string">"content"</span>:subject + <span class="string">'\n'</span> + content</div><div class="line">           &#125;,</div><div class="line">        <span class="string">"safe"</span>:<span class="string">"0"</span></div><div class="line">        &#125;</div><div class="line"><span class="comment">#    send_data = json.dumps(send_values, ensure_ascii=False)</span></div><div class="line">    send_data = simplejson.dumps(send_values, ensure_ascii=<span class="keyword">False</span>).encode(<span class="string">'utf-8'</span>)</div><div class="line">    send_request = urllib2.Request(send_url, send_data)</div><div class="line">    response = json.loads(urllib2.urlopen(send_request).read())</div><div class="line">    print(str(response))</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">def</span>  <span class="title">get_tianqi</span><span class="params">(url, data=None)</span>:</span>  <span class="comment"># ç”¨æ¥è·å–å¤©æ°”ç½‘é¡µä¿¡æ¯</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        r = requests.get(url,timeout=<span class="number">30</span>)</div><div class="line">        r.raise_for_status()</div><div class="line">        r.encoding = r.apparent_encoding</div><div class="line">        <span class="keyword">return</span>  r.text</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">'äº§ç”Ÿå¼‚å¸¸'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_qitian_data</span><span class="params">(html,city)</span>:</span> <span class="comment"># å¤„ç†ç½‘é¡µä¿¡æ¯æå–è¿‘ä¸ƒå¤©çš„æƒ…å†µ</span></div><div class="line">    tianqi_list = []</div><div class="line">    soup = BeautifulSoup(html, <span class="string">'html.parser'</span>)</div><div class="line">    body = soup.body</div><div class="line">    data = body.find(<span class="string">'div'</span>,&#123;<span class="string">'id'</span>: <span class="string">'7d'</span>&#125;)</div><div class="line">    ul = data.find(<span class="string">'ul'</span>)</div><div class="line">    list1 = ul.find_all(<span class="string">'li'</span>)</div><div class="line">    <span class="keyword">for</span> day <span class="keyword">in</span> list1:</div><div class="line">        temp_list = [city]</div><div class="line">        date = day.find(<span class="string">'h1'</span>).string</div><div class="line">        temp_list.append(date)</div><div class="line">        info = day.find_all(<span class="string">'p'</span>)</div><div class="line">        temp_list.append(info[<span class="number">0</span>].string)</div><div class="line">        <span class="keyword">if</span> info[<span class="number">1</span>].find(<span class="string">'span'</span>) <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            temperature_highest = <span class="string">' '</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            temperature_highest = info[<span class="number">1</span>].find(<span class="string">'span'</span>).string</div><div class="line">        <span class="keyword">if</span> info[<span class="number">1</span>].find(<span class="string">'i'</span>) <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            temperature_lowest = <span class="string">' '</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            temperature_lowest = info[<span class="number">1</span>].find(<span class="string">'i'</span>).string</div><div class="line">        temp_list.append(temperature_highest)</div><div class="line">        temp_list.append(temperature_lowest)</div><div class="line">        wind_scale = info[<span class="number">2</span>].find(<span class="string">'i'</span>).string</div><div class="line">        temp_list.append(wind_scale)</div><div class="line">        tianqi_list.append(temp_list)</div><div class="line">    <span class="keyword">return</span> tianqi_list</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span>  <span class="title">save_tianqi_data</span><span class="params">(data,filename)</span>:</span> <span class="comment"># å°†è¿‘ä¸ƒå¤©çš„å¤©æ°”ä¿¡æ¯å­˜æ”¾åœ¨æ–‡ä»¶ä¸­</span></div><div class="line">    f=open(filename,<span class="string">"wt"</span>)</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data:</div><div class="line">        f.write(str(line)+<span class="string">'\n'</span>)</div><div class="line">    f.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hitokoto</span><span class="params">(get_url)</span>:</span></div><div class="line">    f = requests.get(get_url)</div><div class="line">    hitokoto_message = f.json()</div><div class="line">    hitokoto_message_data = <span class="string">'å—¨:  '</span> + hitokoto_message[<span class="string">'hitokoto'</span>]</div><div class="line">    hitokoto_message_data = hitokoto_message_data.replace(<span class="string">"ï¼Œ"</span>,<span class="string">"ï¼Œ\n"</span>).replace(<span class="string">","</span>,<span class="string">",\n"</span>)</div><div class="line">    hitokoto_message_from = <span class="string">'æ¥è‡ª:  '</span> + hitokoto_message[<span class="string">'from'</span>]</div><div class="line">    <span class="keyword">return</span> [hitokoto_message_data,hitokoto_message_from]</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">postrsg</span><span class="params">(filename,get_url,zhuanxiang_file)</span>:</span> <span class="comment">#å–å‡ºä¿¡æ¯å¹¶ä¸”ç”¨æœºå™¨äººå‘æ¶ˆæ¯</span></div><div class="line">    hitokoto_memssage_print = get_hitokoto(get_url)</div><div class="line">    <span class="keyword">with</span> open(filename,<span class="string">'r'</span>) <span class="keyword">as</span> f:</div><div class="line">        lines = f.readlines()</div><div class="line"></div><div class="line">        first = lines[<span class="number">0</span>].rstrip(<span class="string">"\n"</span>)</div><div class="line">        first = first.replace(<span class="string">"['"</span>,<span class="string">''</span>).replace(<span class="string">"']"</span>,<span class="string">''</span>).replace(<span class="string">"'"</span>,<span class="string">""</span>).replace(<span class="string">"ï¼ˆä»Šå¤©ï¼‰"</span>,<span class="string">""</span>)</div><div class="line">        </div><div class="line">        first1 = first.split(<span class="string">','</span>,<span class="number">2</span>)[<span class="number">0</span>:<span class="number">2</span>]</div><div class="line">        str_first1 = <span class="string">""</span>.join(first1).replace(<span class="string">" "</span>,<span class="string">""</span>)</div><div class="line"></div><div class="line">        first2 = first.split(<span class="string">','</span>,<span class="number">2</span>)[<span class="number">-1</span>]</div><div class="line">        str_first2 = <span class="string">""</span>.join(first2).replace(<span class="string">" "</span>,<span class="string">""</span>)</div><div class="line"></div><div class="line">        sec = lines[<span class="number">1</span>].rstrip(<span class="string">"\n"</span>)</div><div class="line">        sec = sec.replace(<span class="string">"['"</span>,<span class="string">''</span>).replace(<span class="string">"']"</span>,<span class="string">''</span>).replace(<span class="string">"'"</span>,<span class="string">""</span>).replace(<span class="string">"ï¼ˆæ˜å¤©ï¼‰"</span>,<span class="string">""</span>)</div><div class="line">        sec1 = sec.split(<span class="string">','</span>,<span class="number">2</span>)[<span class="number">0</span>:<span class="number">2</span>]</div><div class="line">        str_sec1 = <span class="string">""</span>.join(sec1).replace(<span class="string">" "</span>,<span class="string">""</span>)</div><div class="line"></div><div class="line">        sec2 = sec.split(<span class="string">','</span>,<span class="number">2</span>)[<span class="number">-1</span>]</div><div class="line">        str_sec2 = <span class="string">""</span>.join(sec2).replace(<span class="string">" "</span>,<span class="string">""</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">with</span> open(zhuanxiang_file,<span class="string">'r'</span>) <span class="keyword">as</span> f:</div><div class="line">            zhuanxiang_data = f.readlines()</div><div class="line">            zhuanxiang_data = <span class="string">""</span>.join(zhuanxiang_data)</div><div class="line">        <span class="comment"># tianqi_head = 'å¤©æ´¥å¤©æ°”ä¿¡æ¯'</span></div><div class="line"></div><div class="line">        <span class="comment"># formate_box = 'â˜€ï¸' * 12 + '\n'</span></div><div class="line">        <span class="comment"># formate_head = '&#123;:&lt;1&#125;&#123;:^36&#125;&#123;:&gt;1&#125;'.format('â˜€ï¸' * 1, tianqi_head, 'â˜€ï¸' * 1) + '\n'</span></div><div class="line">        <span class="comment"># formate_first = '&#123;:&lt;1&#125;&#123;:^36&#125;&#123;:&gt;1&#125;'.format('' * 1, str_first1, '' * 1) + '\n'</span></div><div class="line">        <span class="comment"># formae_sec = '&#123;:&lt;2&#125;&#123;:^26&#125;&#123;:&gt;2&#125;'.format('*' * 2, str_first2, '*' * 2) + '\n'</span></div><div class="line">        <span class="comment"># formate_box_end = '*' * 30</span></div><div class="line">        <span class="keyword">if</span>   <span class="string">'æ™´'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather = <span class="string">'â˜€ï¸'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'é›¨'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather = <span class="string">'â˜‚'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'é›ª'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather = <span class="string">'â„ï¸'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'äº‘'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather = <span class="string">'â›…ï¸'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'é˜´'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather = <span class="string">'ğŸŒ‘'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            weather = <span class="string">'*'</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> <span class="string">'æ™´'</span> <span class="keyword">in</span> str_sec2:</div><div class="line">            weather_2 = <span class="string">'â˜€ï¸'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'é›¨'</span> <span class="keyword">in</span> str_sec2:</div><div class="line">            weather_2 = <span class="string">'â˜‚'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'é›ª'</span> <span class="keyword">in</span> str_sec2:</div><div class="line">            weather_2 = <span class="string">'â„ï¸'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'äº‘'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather_2 = <span class="string">'â›…ï¸'</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'é˜´'</span> <span class="keyword">in</span> str_first2:</div><div class="line">            weather_2 = <span class="string">'ğŸŒ‘'</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            weather_2 = <span class="string">'*'</span></div><div class="line">    message_subject = <span class="string">'''&lt;-----------ä»»é”¦ä¸“ç”¨----------&gt;'''</span></div><div class="line">    message_content = <span class="string">'''&lt;-----------ä»Šæ—¥å¤©æ°”----------&gt;</span></div><div class="line"><span class="string">    &#123;&#125;</span></div><div class="line"><span class="string">    *&#123;&#125;</span></div><div class="line"><span class="string">&lt;-----------æ˜æ—¥å¤©æ°”----------&gt;</span></div><div class="line"><span class="string">    &#123;&#125;</span></div><div class="line"><span class="string">    #&#123;&#125;</span></div><div class="line"><span class="string">&lt;-----------æ¯æ—¥é‡‘å¥----------&gt;</span></div><div class="line"><span class="string">    &#123;&#125;</span></div><div class="line"><span class="string">    &#123;&#125;</span></div><div class="line"><span class="string">&lt;-----------æç¤ºä¸“é¡¹----------&gt;</span></div><div class="line"><span class="string">    &#123;&#125;                        '''</span>.format(str_first1, str_first2, str_sec1, str_sec2,</div><div class="line">               hitokoto_memssage_print[<span class="number">0</span>], hitokoto_memssage_print[<span class="number">1</span>],</div><div class="line">               zhuanxiang_data).replace(<span class="string">'*'</span>, weather).replace(<span class="string">'#'</span>, weather_2)</div><div class="line">    <span class="keyword">return</span> [message_subject,message_content]</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    zhuanxiang_file = <span class="string">'/var/www/liuxxxx/liuxxxx_put.txt'</span></div><div class="line">    tianqi_url = <span class="string">'http://www.weather.com.cn/weather/101100201.shtml'</span></div><div class="line">    html = get_tianqi(tianqi_url)</div><div class="line">    result = get_qitian_data(html, <span class="string">'å±±è¥¿: å¤§åŒ'</span>)</div><div class="line">    filename = <span class="string">'./liuxxxx.message'</span></div><div class="line">    save_tianqi_data(result, filename)</div><div class="line">    get_url = <span class="string">'https://v1.hitokoto.cn/'</span></div><div class="line">    postrsg_message = postrsg(filename,get_url,zhuanxiang_file)</div><div class="line">    user = str(<span class="string">'RenJin'</span>)</div><div class="line">    subject = str(postrsg_message[<span class="number">0</span>])  <span class="comment"># å‘é€çš„æ ‡é¢˜ä¿¡æ¯</span></div><div class="line">    content = str(postrsg_message[<span class="number">1</span>]) <span class="comment"># å‘é€çš„ä¸»ä½“ä¿¡æ¯</span></div><div class="line">    corpid =  <span class="string">'ww3xxxxxxxxxxxxxxxxx'</span>     <span class="comment">#ä¼ä¸šå·çš„id</span></div><div class="line">    corpsecret = <span class="string">'OF-nuSt6xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>    <span class="comment">#ç®¡ç†ç»„å‡­è¯å¯†é’¥</span></div><div class="line">    accesstoken = gettoken(corpid,corpsecret)</div><div class="line">    senddata(accesstoken,user,subject,content)</div></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æ‰§è¡Œå°±å¯ä»¥åœ¨ä¼ä¸šå¾®ä¿¡ä¸Šæ”¶åˆ°ä¿¡æ¯äº†</p><p><img src="/images/weixintongzhi-qiye-one.png" alt=""></p><p>ä¼ä¸šå¾®ä¿¡èƒ½æ”¶åˆ°é€šçŸ¥åï¼Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹å¾®ä¿¡ç«¯çš„æ”¶ä¿¡</p><p><strong>åœ¨æ­¤è¡¥å……ä¸€ä¸‹ï¼Œå¦‚æœæƒ³åœ¨å¾®ä¿¡ç«¯æ”¶åˆ°é€šçŸ¥ä¿¡æ¯ï¼Œåœ¨æ”¶ä¿¡æ¯çš„äººå…³æ³¨å¾®ä¿¡å·å°±å¯ä»¥äº†</strong></p><p>åœ¨ä¼ä¸šå¾®ä¿¡é¡µé¢ç‚¹å‡»æˆ‘çš„ä¼ä¸š â€“&gt; å¾®ä¿¡æ’ä»¶ â€“&gt; é‚€è¯·å…³æ³¨</p><p><img src="/images/weixintongzhi-guanzhu.png" alt=""></p><p>å…³æ³¨åï¼Œå†å‘é€å°±ä¼šæ”¶åˆ°å¦‚ä¸‹ä¿¡æ¯</p><p><img src="/images/weixingtongzhi-weixintest.png" alt=""></p><h2 id="ä¸“é¡¹é€šçŸ¥å®ç°"><a href="#ä¸“é¡¹é€šçŸ¥å®ç°" class="headerlink" title="ä¸“é¡¹é€šçŸ¥å®ç°"></a>ä¸“é¡¹é€šçŸ¥å®ç°</h2><p>è¿›å…¥nginx  ç«™ç‚¹æ ¹ç›®å½•ï¼Œè¿™é‡Œéœ€è¦æœ‰nginxç¯å¢ƒ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># cd /var/www/liuxxxx/</span></div></pre></td></tr></table></figure><h3 id="html-webè¾“å…¥æ¡†"><a href="#html-webè¾“å…¥æ¡†" class="headerlink" title="html webè¾“å…¥æ¡†"></a>html webè¾“å…¥æ¡†</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>åˆ˜xxxxæç¤ºä¸“é¡¹<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"./index.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">    æç¤ºå†…å®¹1: <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">"width:150px; height:50px;color:8B0000"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"ts1"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">    æç¤ºå†…å®¹2: <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">"width:150px; height:50px;color:8B000"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"ts2"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">    æç¤ºå†…å®¹3: <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">"width:150px; height:50px;color:1F099"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"ts3"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">"width:90px; height:50px;float:160px;color:8B0012"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"æœ¬ç²ç¡®è®¤æäº¤"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="php-æé†’å¹¶å†™å…¥æ–‡ä»¶"><a href="#php-æé†’å¹¶å†™å…¥æ–‡ä»¶" class="headerlink" title="php æé†’å¹¶å†™å…¥æ–‡ä»¶"></a>php æé†’å¹¶å†™å…¥æ–‡ä»¶</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;h1&gt; å†™å…¥æ–°æç¤ºè®¡åˆ’&lt;/h1&gt;</div><div class="line">æç¤ºé€šçŸ¥<span class="number">1</span>çš„å†…å®¹æ˜¯    <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">"ts1"</span>];<span class="meta">?&gt;</span>&lt;br&gt;</div><div class="line">æç¤ºé€šçŸ¥<span class="number">2</span>çš„å†…å®¹æ˜¯    <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">"ts2"</span>];<span class="meta">?&gt;</span>&lt;br&gt;</div><div class="line">æç¤ºé€šçŸ¥<span class="number">3</span>çš„å†…å®¹æ˜¯    <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">"ts3"</span>];<span class="meta">?&gt;</span>&lt;br&gt;</div><div class="line">&lt;h1&gt; æ¸…ç©ºäº†æ—§æç¤ºè®¡åˆ’&lt;/h1&gt;</div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">   <span class="keyword">echo</span> <span class="string">'æ¸…ç©ºid'</span>;</div><div class="line">   file_put_contents(<span class="string">'liuxxxx_put.txt'</span>, <span class="string">""</span>);</div><div class="line">   $file = fopen(<span class="string">"liuxxxx_put.txt"</span>,<span class="string">"w+"</span>);</div><div class="line">   <span class="keyword">echo</span> fwrite($file,$_POST[<span class="string">"ts1"</span>].<span class="string">"\n"</span>);</div><div class="line">   <span class="keyword">echo</span> fwrite($file,<span class="string">"    "</span>.$_POST[<span class="string">"ts2"</span>].<span class="string">"\n"</span>);</div><div class="line">   <span class="keyword">echo</span> fwrite($file,<span class="string">"    "</span>.$_POST[<span class="string">"ts3"</span>]);</div><div class="line">fclose($file);</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure><h3 id="ç¼–è¾‘ç°æœ‰çš„nginxè™šæ‹Ÿä¸»æœº"><a href="#ç¼–è¾‘ç°æœ‰çš„nginxè™šæ‹Ÿä¸»æœº" class="headerlink" title="ç¼–è¾‘ç°æœ‰çš„nginxè™šæ‹Ÿä¸»æœº"></a>ç¼–è¾‘ç°æœ‰çš„nginxè™šæ‹Ÿä¸»æœº</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">location /liuxxxx &#123;</div><div class="line">    auth_basic <span class="string">"Auth Base For Liuxxxx"</span>;  <span class="comment">#</span></div><div class="line">    auth_basic_user_file /etc/nginx/conf.d/ssjinyao.db; <span class="comment"># è¿™é‡Œç”¨htpasswd  å†™äº†ä¸€ä¸ªç”¨æˆ·å’Œå¯†ç ä¿å­˜åœ¨ ssjinyao.db ä¸­</span></div><div class="line">    <span class="comment">#error_page 405 =200 $uri;</span></div><div class="line">    alias /var/www/liuxxxx;</div><div class="line">    <span class="keyword">index</span> <span class="keyword">index</span> index.htm index.html php index.php;</div><div class="line">        location ~ <span class="regexp">/liuxxxx/</span>(.*)\.php(.*)$ &#123;</div><div class="line">        <span class="comment">#default_type text/html;</span></div><div class="line">        <span class="comment">#add_header Content-Type 'text/html; charset=utf-8';</span></div><div class="line">        <span class="comment">#return 200 "$document_root  , $fastcgi_script_name";</span></div><div class="line">        alias /var/www;</div><div class="line">        fastcgi_split_path_info ^(.+\.php)(.*)$;</div><div class="line">        <span class="comment">#fastcgi_param PATH_INFO $fastcgi_path_info;</span></div><div class="line">        fastcgi_pass   <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">9000</span>;</div><div class="line">        fastcgi_index  index.php;</div><div class="line">        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</div><div class="line">        include        fastcgi_params;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>nginx ç”Ÿæ•ˆåï¼Œè®¿é—®å¹¶é¡µé¢å†™å…¥ä¸“é¡¹é€šçŸ¥<br><img src="/images/weixintongzhi-zhuanxiang-push.png" alt=""></p><h2 id="åŠ å…¥å®šæ—¶ä»»åŠ¡è®¡åˆ’"><a href="#åŠ å…¥å®šæ—¶ä»»åŠ¡è®¡åˆ’" class="headerlink" title="åŠ å…¥å®šæ—¶ä»»åŠ¡è®¡åˆ’"></a>åŠ å…¥å®šæ—¶ä»»åŠ¡è®¡åˆ’</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 7,12 * * * <span class="built_in">source</span> /root/mypython/py3_env/bin/activate &amp;&amp; <span class="built_in">cd</span> /root/mypython/python3 &amp;&amp; python liuxxx.py</div></pre></td></tr></table></figure><p>æœ€åçš„æ•ˆæœ</p><p><img src="/images/weixintongzhi-crontab.png" alt=""></p><p>å…¶å®ƒè¯´æ˜ï¼Œè¿™ä¸ªpythonè„šæœ¬å¯ä»¥æŠŠæ”¶ä¿¡æ¯çš„å˜é‡æ”¹ä¸ºä½ç½®å˜é‡åšzabbix prometehus æŠ¥è­¦é€šçŸ¥æ¥ç”¨</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>pythonè¡¨æ ¼æ“ä½œ</title>
      <link href="/2020/04/22/python%20excel%E8%A1%A8%E6%A0%BC%E6%93%8D%E4%BD%9C/"/>
      <url>/2020/04/22/python%20excel%E8%A1%A8%E6%A0%BC%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<h1 id="python-è¡¨æ ¼æ“ä½œ"><a href="#python-è¡¨æ ¼æ“ä½œ" class="headerlink" title="python è¡¨æ ¼æ“ä½œ"></a>python è¡¨æ ¼æ“ä½œ</h1><h2 id="å°†awkç”Ÿæˆçš„æ•°æ®å¯¼å…¥è¡¨æ ¼"><a href="#å°†awkç”Ÿæˆçš„æ•°æ®å¯¼å…¥è¡¨æ ¼" class="headerlink" title="å°†awkç”Ÿæˆçš„æ•°æ®å¯¼å…¥è¡¨æ ¼"></a>å°†awkç”Ÿæˆçš„æ•°æ®å¯¼å…¥è¡¨æ ¼</h2><p><img src="/images/python-pandas1.png" alt=""><br>pandas ï¼špannel data analysisï¼ˆé¢æ¿æ•°æ®åˆ†æï¼‰ã€‚pandasæ˜¯åŸºäºnumpyæ„å»ºçš„ï¼Œä¸ºæ—¶é—´åºåˆ—åˆ†ææä¾›äº†å¾ˆå¥½çš„æ”¯æŒã€‚pandasä¸­æœ‰ä¸¤ä¸ªä¸»è¦çš„æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªæ˜¯Seriesï¼Œå¦ä¸€ä¸ªæ˜¯DataFrameã€‚</p><p>Series ç±»ä¼¼äºä¸€ç»´æ•°ç»„ä¸å­—å…¸(map)æ•°æ®ç»“æ„çš„ç»“åˆã€‚å®ƒç”±ä¸€ç»„æ•°æ®å’Œä¸€ç»„ä¸æ•°æ®ç›¸å¯¹åº”çš„æ•°æ®æ ‡ç­¾ï¼ˆç´¢å¼•indexï¼‰ç»„æˆã€‚è¿™ç»„æ•°æ®å’Œç´¢å¼•æ ‡ç­¾çš„åŸºç¡€éƒ½æ˜¯ä¸€ä¸ªä¸€ç»´ndarrayæ•°ç»„ã€‚å¯å°†indexç´¢å¼•ç†è§£ä¸ºè¡Œç´¢å¼•ã€‚ Seriesçš„è¡¨ç°å½¢å¼ä¸ºï¼šç´¢å¼•åœ¨å·¦ï¼Œæ•°æ®åœ¨å³ã€‚</p><p>DataFrameæ˜¯ä¸€ä¸ªç±»ä¼¼è¡¨æ ¼çš„æ•°æ®ç»“æ„ï¼Œç´¢å¼•åŒ…æ‹¬åˆ—ç´¢å¼•å’Œè¡Œç´¢å¼•ï¼ŒåŒ…å«æœ‰ä¸€ç»„æœ‰åºçš„åˆ—ï¼Œæ¯åˆ—å¯ä»¥æ˜¯ä¸åŒçš„å€¼ç±»å‹ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ç­‰ï¼‰ã€‚DataFrameçš„æ¯ä¸€è¡Œå’Œæ¯ä¸€åˆ—éƒ½æ˜¯ä¸€ä¸ªSeriesï¼Œè¿™ä¸ªSeriesçš„nameå±æ€§ä¸ºå½“å‰çš„è¡Œç´¢å¼•å/åˆ—ç´¢å¼•åã€‚</p><p><img src="/images/python-pandas1.png" alt="python-pandas1"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> openpyxl <span class="keyword">as</span> xl</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line">cycle=<span class="number">38</span></div><div class="line">time_year_month_day = str(datetime.date.today()-datetime.timedelta(days=cycle))</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">proj_xls_to_xlsx</span><span class="params">(file_path,sheet_name,save_name,tableTitle=None)</span>:</span></div><div class="line">    <span class="keyword">with</span> open(file_path) <span class="keyword">as</span> f:</div><div class="line">        data = f.readlines()</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(save_name):</div><div class="line">        wb = xl.Workbook()</div><div class="line">        wb.save(save_name)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        wb = xl.load_workbook(save_name)</div><div class="line">    ws1 = wb.create_sheet(<span class="number">0</span>)</div><div class="line">    ws1.title = sheet_name</div><div class="line">    <span class="keyword">if</span> tableTitle != <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> range(len(tableTitle)):</div><div class="line">            c = n + <span class="number">1</span></div><div class="line">            ws1.cell(row=<span class="number">1</span>, column=c).value = tableTitle[n]</div><div class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> data:</div><div class="line">        value = d.split(<span class="string">'\t'</span>)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line"></div><div class="line">           <span class="comment"># print(value)</span></div><div class="line">            value[<span class="number">5</span>]=float(value[<span class="number">5</span>])</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        ws1.append(value)</div><div class="line">    wb.save(save_name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">crate_shuju_toushi</span><span class="params">(save_name,sheet_name,sheet_name2,index_name,values_name,department_name,new_department_name,personnel_name)</span>:</span></div><div class="line">    f = pd.read_excel(io=save_name,sheet_name=sheet_name)</div><div class="line">    res = pd.pivot_table(f,index=[index_name],values=[values_name],aggfunc=np.sum, margins=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    wb = xl.load_workbook(save_name)</div><div class="line">    old_title = wb.worksheets[<span class="number">0</span>]</div><div class="line">    old_title.title = sheet_name2</div><div class="line"></div><div class="line">    all_xinxi_title=list(zip(list((res.index)),list(res[values_name])))</div><div class="line">    department_personnel = list(zip(f[department_name],f[index_name]))</div><div class="line">    department_personnel_size_list = []</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_xinxi_title:</div><div class="line">         <span class="keyword">for</span> department_personnel_list <span class="keyword">in</span> department_personnel:</div><div class="line">             <span class="keyword">if</span> user[<span class="number">0</span>] <span class="keyword">in</span> department_personnel_list:</div><div class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">'-'</span>:</div><div class="line">                     <span class="keyword">continue</span></div><div class="line">                 <span class="keyword">if</span> user[<span class="number">0</span>] == <span class="string">' '</span>:</div><div class="line">                     <span class="keyword">continue</span></div><div class="line">                 department_personnel_size_list.append((department_personnel_list[<span class="number">0</span>],user[<span class="number">0</span>],user[<span class="number">1</span>]))</div><div class="line"></div><div class="line">    end_department_personnel_size_list = sorted(list(set(department_personnel_size_list)), key=<span class="keyword">lambda</span> x:x[<span class="number">2</span>] ,reverse=<span class="keyword">True</span>)</div><div class="line">    all_xinxi_title_end = all_xinxi_title[<span class="number">-1</span>]</div><div class="line">    all_xinxi_title_end = list(all_xinxi_title_end)</div><div class="line">    all_xinxi_title_end.insert(<span class="number">0</span>,<span class="string">''</span>)</div><div class="line">    end_department_personnel_size_list.append(all_xinxi_title_end)</div><div class="line">    end_department_personnel_size_list.insert(<span class="number">0</span>,[new_department_name,personnel_name,values_name])</div><div class="line">    end_department_personnel_size_list.pop()</div><div class="line"></div><div class="line">    user_volue = []</div><div class="line">    <span class="keyword">for</span> user2 <span class="keyword">in</span> end_department_personnel_size_list:</div><div class="line">        user2 = list(user2)</div><div class="line">        <span class="keyword">if</span> user2[<span class="number">1</span>] == user_volue:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        user_volue = user2[<span class="number">1</span>]</div><div class="line">        old_title.append(user2)</div><div class="line">    wb.save(save_name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_space_toushi</span><span class="params">(save_name,sheet_name,sheet_name2,department_num,sum_name,data_total,index_name,values_name)</span>:</span></div><div class="line">    f = pd.read_excel(io=save_name,sheet_name=sheet_name,dtype=&#123;<span class="string">'ä¸šåŠ¡XXåˆ©æ¶¦ç¼–å·'</span>:str&#125;)</div><div class="line">    res = pd.pivot_table(f,index=index_name,values=values_name,aggfunc=np.sum,margins=<span class="keyword">True</span>)</div><div class="line">    all_list = list(zip(list(res.index),list(res[values_name])))</div><div class="line"></div><div class="line">    wb = xl.load_workbook(save_name)</div><div class="line">    sheet = wb.create_sheet(sheet_name2)</div><div class="line"></div><div class="line">    space_list = []</div><div class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> all_list:</div><div class="line">        user2 = list(user)[<span class="number">1</span>]</div><div class="line">        user3 = list(list(user)[<span class="number">0</span>])</div><div class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">'-'</span>:</div><div class="line">            space_list.append((user3[<span class="number">1</span>],user2))</div><div class="line">        <span class="keyword">if</span> user3[<span class="number">0</span>] == <span class="string">' '</span>:</div><div class="line">            space_list.append((user3[<span class="number">1</span>],user2))</div><div class="line">    sum_list = []</div><div class="line">    <span class="keyword">for</span> slist <span class="keyword">in</span> space_list:</div><div class="line">        sum_list.append(slist[<span class="number">1</span>])</div><div class="line">    sum_list=sum(sum_list)</div><div class="line">    sort_space_list = sorted(list(set(space_list)), key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>] ,reverse=<span class="keyword">True</span>)</div><div class="line">    sort_space_list.append((sum_name, sum_list))</div><div class="line">    sort_space_list.insert(<span class="number">0</span>,(department_num,data_total))</div><div class="line">    <span class="keyword">for</span> all_space_list <span class="keyword">in</span> sort_space_list:</div><div class="line">        sheet.append(all_space_list)</div><div class="line">    wb.save(save_name)</div><div class="line">    </div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">    sheet_name = <span class="string">'XXXè¯¦æƒ…'</span></div><div class="line">    save_name = <span class="string">'TJ-XJ-DATASHOW-'</span> + time_year_month_day + <span class="string">'.xlsx'</span></div><div class="line">    save_name = <span class="string">'TJ-XJ-DATASHOW-'</span> + time_year_month_day + <span class="string">'.xlsx'</span></div><div class="line">    file_path = <span class="string">'./able.'</span> + time_year_month_day +<span class="string">'.lib.xls'</span></div><div class="line">    proj_xls_to_xlsx(file_path=file_path,</div><div class="line">                     sheet_name=sheet_name,</div><div class="line">                     save_name=save_name)</div><div class="line">                     </div><div class="line">    sheet_name = <span class="string">'XXXæ€»ä½“æƒ…å†µ'</span></div><div class="line">    save_name = <span class="string">'TJ-XJ-DATASHOW-'</span> +  time_year_month_day + <span class="string">'.xlsx'</span></div><div class="line">    file_path = <span class="string">'./'</span> + time_year_month_day + <span class="string">'.ProjInfo.XJpath.xls'</span></div><div class="line">    table_title = [<span class="string">'ä¸šåŠ¡XXåç§°'</span>,<span class="string">'ä¸šåŠ¡XXåˆ©æ¶¦ç¼–å·'</span>,</div><div class="line">                   <span class="string">'è¿è¥ç»ç†'</span>,<span class="string">'ä¿¡æ¯åˆ†æ'</span>,<span class="string">'æ¶‰åŠé¡¹ç›®æ•°'</span>,</div><div class="line">                   <span class="string">'æ¶‰åŠæ•°æ®é‡å¤§å°ï¼ˆGï¼‰'</span>,<span class="string">'é¡¹ç›®ç¼–å·1'</span>,</div><div class="line">                   <span class="string">'é¡¹ç›®åç§°1'</span>,<span class="string">'æ•°æ®é‡(G)1'</span>,</div><div class="line">                   <span class="string">'æ–‡åº“ç¼–å·1'</span>,<span class="string">'é¡¹ç›®ç¼–å·2'</span>,</div><div class="line">                   <span class="string">'é¡¹ç›®åç§°2'</span>,<span class="string">'æ•°æ®é‡(G)2'</span>,</div><div class="line">                   <span class="string">'æ–‡åº“ç¼–å·2'</span>,<span class="string">'é¡¹ç›®ç¼–å·3'</span>,</div><div class="line">                   <span class="string">'é¡¹ç›®åç§°3'</span>,<span class="string">'æ•°æ®é‡(G)3'</span>,</div><div class="line">                   <span class="string">'æ–‡åº“ç¼–å·3'</span>,<span class="string">'é¡¹ç›®ç¼–å·4'</span>,</div><div class="line">                   <span class="string">'é¡¹ç›®åç§°4   æ•°æ®é‡(G)4'</span>,<span class="string">'æ–‡åº“ç¼–å·4'</span>,]</div><div class="line">    proj_xls_to_xlsx(file_path=file_path,</div><div class="line">                     sheet_name=sheet_name,</div><div class="line">                     tableTitle=table_title,</div><div class="line">                     save_name=save_name)</div><div class="line"></div><div class="line">    save_name = <span class="string">'TJ-XJ-DATASHOW-'</span> + time_year_month_day + <span class="string">'.xlsx'</span></div><div class="line">    sheet_name = <span class="string">'XXXæ€»ä½“æƒ…å†µ'</span></div><div class="line">    sheet_name2 = <span class="string">'XXXæ¦‚å†µ'</span></div><div class="line">    index_name = <span class="string">'ä¿¡æ¯åˆ†æ'</span></div><div class="line">    values_name = <span class="string">'æ¶‰åŠæ•°æ®é‡å¤§å°ï¼ˆGï¼‰'</span></div><div class="line">    department_name = <span class="string">'ä¸šåŠ¡XXåç§°'</span></div><div class="line">    new_department_name = <span class="string">'XX'</span></div><div class="line">    personnel_name = <span class="string">'äººå‘˜'</span></div><div class="line">    crate_shuju_toushi(save_name=save_name,</div><div class="line">                       sheet_name=sheet_name,</div><div class="line">                       sheet_name2=sheet_name2,</div><div class="line">                       index_name=index_name,</div><div class="line">                       values_name=values_name,</div><div class="line">                       department_name=department_name,</div><div class="line">                       new_department_name=new_department_name,</div><div class="line">                       personnel_name=personnel_name)</div><div class="line"></div><div class="line">    index_name = [<span class="string">'ä¿¡æ¯åˆ†æ'</span>,<span class="string">'ä¸šåŠ¡XXåˆ©æ¶¦ç¼–å·'</span>]</div><div class="line">    save_name = <span class="string">'TJ-XJ-DATASHOW-'</span> + time_year_month_day + <span class="string">'.xlsx'</span></div><div class="line">    sheet_name = <span class="string">'XXXæ€»ä½“æƒ…å†µ'</span></div><div class="line">    department_num = <span class="string">'XXç¼–å·'</span></div><div class="line">    data_total = <span class="string">'æ•°æ®é‡ï¼ˆGï¼‰'</span></div><div class="line">    values_name = <span class="string">'æ¶‰åŠæ•°æ®é‡å¤§å°ï¼ˆGï¼‰'</span></div><div class="line">    sheet_name2 = <span class="string">'æœªåŒ¹é…äººå‘˜æ•°æ®é‡'</span></div><div class="line">    sum_name = <span class="string">'ALL'</span></div><div class="line">    create_space_toushi(index_name=index_name,</div><div class="line">                        save_name=save_name,</div><div class="line">                        sheet_name=sheet_name,</div><div class="line">                        department_num=department_num,</div><div class="line">                        data_total=data_total,</div><div class="line">                        values_name=values_name,</div><div class="line">                        sheet_name2=sheet_name2,</div><div class="line">                        sum_name=sum_name,)</div></pre></td></tr></table></figure><h2 id="å®Œæˆæ•°æ®é€è§†"><a href="#å®Œæˆæ•°æ®é€è§†" class="headerlink" title="å®Œæˆæ•°æ®é€è§†,"></a>å®Œæˆæ•°æ®é€è§†,</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> openpyxl <span class="keyword">as</span> xl</div><div class="line"></div><div class="line"><span class="keyword">import</span> datetime</div><div class="line">difference_cycle=<span class="number">33</span></div><div class="line">time_year_month_day = str(datetime.date.today()-datetime.timedelta(days=difference_cycle))</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_last_excel</span><span class="params">(old_sheet,new_sheet,gaikuang)</span>:</span></div><div class="line">    pd01 = pd.read_excel(old_sheet,sheet_name=gaikuang,encoding=<span class="string">'utf-8'</span>)</div><div class="line">    pd02 = pd.read_excel(new_sheet,sheet_name=gaikuang,encoding=<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">    pd11 = pd.read_excel(old_sheet,sheet_name=<span class="string">'æœªåŒ¹é…äººå‘˜æ•°æ®é‡'</span>,encoding=<span class="string">'utf-8'</span>)</div><div class="line">    pd12 = pd.read_excel(new_sheet,sheet_name=<span class="string">'æœªåŒ¹é…äººå‘˜æ•°æ®é‡'</span>,encoding=<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line"></div><div class="line">    result = pd.merge(pd01,pd02[[<span class="string">'äººå‘˜'</span>,<span class="string">'æ¶‰åŠæ•°æ®é‡å¤§å°ï¼ˆGï¼‰'</span>]],on=<span class="string">'äººå‘˜'</span>)</div><div class="line">    result_list = list(zip(list((result[<span class="string">'XXX'</span>])),list((result[<span class="string">'äººå‘˜'</span>])),list((result[<span class="string">'æ¶‰åŠæ•°æ®é‡å¤§å°ï¼ˆGï¼‰_x'</span>])),list((result[<span class="string">'æ¶‰åŠæ•°æ®é‡å¤§å°ï¼ˆGï¼‰_y'</span>]))))</div><div class="line"></div><div class="line">    not_match = pd.merge(pd11,pd12[[<span class="string">'XXXç¼–å·'</span>,<span class="string">'æ•°æ®é‡ï¼ˆGï¼‰'</span>]],left_on=<span class="string">'XXXç¼–å·'</span>,right_on=<span class="string">'XXXç¼–å·'</span>)</div><div class="line">    print(not_match)</div><div class="line">    not_match_list = list(zip(list((not_match[<span class="string">'XXXç¼–å·'</span>])),list((not_match[<span class="string">'æ•°æ®é‡ï¼ˆGï¼‰_x'</span>])),list((not_match[<span class="string">'æ•°æ®é‡ï¼ˆGï¼‰_y'</span>]))))</div><div class="line"></div><div class="line">    wb2 = xl.load_workbook(new_sheet)</div><div class="line">    remove_sheet1 = wb2[gaikuang]</div><div class="line">    remove_sheet2 = wb2[<span class="string">'æœªåŒ¹é…äººå‘˜æ•°æ®é‡'</span>]</div><div class="line">    wb2.remove(remove_sheet1)</div><div class="line">    wb2.remove(remove_sheet2)</div><div class="line">    wb2.save(new_sheet)</div><div class="line"></div><div class="line">    wb2 = xl.load_workbook(new_sheet)</div><div class="line">    sheet21 = wb2.create_sheet(gaikuang,<span class="number">0</span>)</div><div class="line">    sheet22 = wb2.create_sheet(<span class="string">'æœªåŒ¹é…äººå‘˜æ•°æ®é‡'</span>)</div><div class="line"></div><div class="line">    result_head = [<span class="string">'XXX'</span>,<span class="string">'äººå‘˜'</span>,<span class="string">'æ¶‰åŠæ•°æ®é‡ï¼ˆGï¼‰'</span>,<span class="string">'ç¬¬äºŒæ¬¡æ¶‰åŠæ•°æ®é‡ï¼ˆGï¼‰'</span>,<span class="string">'ä»»åŠ¡é¢å·®'</span>]</div><div class="line">    result_list.insert(<span class="number">0</span>,result_head)</div><div class="line">    result_for_num = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result_list:</div><div class="line">        result_i = list(i)</div><div class="line">        <span class="keyword">if</span> result_for_num != <span class="number">1</span>:</div><div class="line">            result_chae=i[<span class="number">2</span>]-i[<span class="number">3</span>]-i[<span class="number">2</span>]*<span class="number">0.2</span></div><div class="line">            result_i.append(float(<span class="string">'%.2f'</span>% result_chae))</div><div class="line">        result_for_num = result_for_num + <span class="number">1</span></div><div class="line">        sheet21.append(result_i)</div><div class="line"></div><div class="line">    not_match_head = [<span class="string">'XXXç¼–å·'</span>,<span class="string">'æ•°æ®é‡ï¼ˆGï¼‰'</span>,<span class="string">'ç¬¬äºŒæ¬¡æ•°æ®é‡ï¼ˆGï¼‰'</span>,<span class="string">'ä»»åŠ¡é¢å·®'</span>]</div><div class="line">    not_match_list.insert(<span class="number">0</span>,not_match_head)</div><div class="line">    not_match_for_num = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span>  not_match_list:</div><div class="line">        not_match_j = list(j)</div><div class="line">        <span class="keyword">if</span> not_match_for_num != <span class="number">1</span>:</div><div class="line">            not_match_chae=j[<span class="number">1</span>]-j[<span class="number">2</span>]-j[<span class="number">1</span>]*<span class="number">0.2</span></div><div class="line">            not_match_j.append(float(<span class="string">'%.2f'</span>% not_match_chae))</div><div class="line">        not_match_for_num = not_match_for_num + <span class="number">1</span></div><div class="line">        sheet22.append(not_match_j)</div><div class="line">    wb2.save(new_sheet)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    old_sheet=<span class="string">'TJ-XJ-DATASHOW-'</span> + time_year_month_day + <span class="string">'-old.xlsx'</span></div><div class="line">    new_sheet=<span class="string">'TJ-XJ-DATASHOW-'</span> + time_year_month_day + <span class="string">'.xlsx'</span></div><div class="line">    gaikuang=<span class="string">'XXXæ¦‚å†µ'</span></div><div class="line">    add_last_excel(old_sheet=old_sheet,new_sheet=new_sheet,gaikuang=gaikuang)</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>é«˜å¯ç”¨gitlabæœåŠ¡å™¨æ­å»º</title>
      <link href="/2020/03/26/%E9%AB%98%E5%8F%AF%E7%94%A8gitlab%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"/>
      <url>/2020/03/26/%E9%AB%98%E5%8F%AF%E7%94%A8gitlab%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<h1 id="é«˜å¯ç”¨gitlabæœåŠ¡å™¨æ­å»º"><a href="#é«˜å¯ç”¨gitlabæœåŠ¡å™¨æ­å»º" class="headerlink" title="é«˜å¯ç”¨gitlabæœåŠ¡å™¨æ­å»º"></a>é«˜å¯ç”¨gitlabæœåŠ¡å™¨æ­å»º</h1><p><img src="/images/gitlab.jpg" alt=""></p><h2 id="ç¯å¢ƒå‡†å¤‡-å•èŠ‚ç‚¹éƒ¨ç½²"><a href="#ç¯å¢ƒå‡†å¤‡-å•èŠ‚ç‚¹éƒ¨ç½²" class="headerlink" title="ç¯å¢ƒå‡†å¤‡,å•èŠ‚ç‚¹éƒ¨ç½²"></a>ç¯å¢ƒå‡†å¤‡,å•èŠ‚ç‚¹éƒ¨ç½²</h2><table><thead><tr><th>CentOS7.4</th><th>64C</th><th>192G</th></tr></thead><tbody><tr><td>CentOS7.4</td><td>64C</td><td>192G</td></tr></tbody></table><h3 id="æœåŠ¡å™¨æ—¶é—´åŒæ­¥"><a href="#æœåŠ¡å™¨æ—¶é—´åŒæ­¥" class="headerlink" title="æœåŠ¡å™¨æ—¶é—´åŒæ­¥"></a>æœåŠ¡å™¨æ—¶é—´åŒæ­¥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~]# ntpdate ntp.aliyun.com</div></pre></td></tr></table></figure><h3 id="ç¡®ä¿SELinux-æ˜¯å…³é—­çš„"><a href="#ç¡®ä¿SELinux-æ˜¯å…³é—­çš„" class="headerlink" title="ç¡®ä¿SELinux æ˜¯å…³é—­çš„"></a>ç¡®ä¿SELinux æ˜¯å…³é—­çš„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~]# getenforce </div><div class="line">Disabled</div></pre></td></tr></table></figure><h3 id="é…ç½®postfix"><a href="#é…ç½®postfix" class="headerlink" title="é…ç½®postfix"></a>é…ç½®postfix</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~]# yum -y install postfix</div><div class="line">~]# sed -i &apos;s/inet_interfaces = localhost/inet_interfaces = all/g&apos; /etc/postfix/main.cf</div><div class="line">~]# systemctl start postfix</div><div class="line">~]# systemctl restart postfix</div></pre></td></tr></table></figure><h3 id="é…ç½®gitlab-ce-yumæºå¹¶å®‰è£…"><a href="#é…ç½®gitlab-ce-yumæºå¹¶å®‰è£…" class="headerlink" title="é…ç½®gitlab-ce yumæºå¹¶å®‰è£…"></a>é…ç½®gitlab-ce yumæºå¹¶å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~]# vim /etc/yum.repos.d/gitlab-ce.repo</div><div class="line">[gitlab-ce]</div><div class="line">name=Gitlab CE Repository</div><div class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/</div><div class="line">gpgcheck=0</div><div class="line">enabled=1</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~]# yum clean all</div><div class="line">~]# yum makecache </div><div class="line">~]# yum -y install gitlab-ce</div></pre></td></tr></table></figure><h3 id="gitlab-é…ç½®"><a href="#gitlab-é…ç½®" class="headerlink" title="gitlab é…ç½®"></a>gitlab é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~]# cd /etc/gitlab/</div><div class="line">~]# cp gitlab.rb&#123;,.bak&#125;</div></pre></td></tr></table></figure><h3 id="gitlab-é…ç½®æ–‡ä»¶"><a href="#gitlab-é…ç½®æ–‡ä»¶" class="headerlink" title="gitlab é…ç½®æ–‡ä»¶"></a>gitlab é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># åœ°å€é…ç½®</span></div><div class="line">external_url <span class="string">'https://gitdb.novogene.com'</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ldap ADåŸŸé…ç½®</span></div><div class="line">gitlab_rails[<span class="string">'ldap_enabled'</span>] = <span class="literal">true</span></div><div class="line">gitlab_rails[<span class="string">'ldap_servers'</span>] = YAML.load &lt;&lt;-<span class="string">'EOS'</span></div><div class="line">  main:</div><div class="line">    label: <span class="string">'è¯ºç¦¾AD'</span></div><div class="line">    host: <span class="string">'xx.xxx.xx.xxx'</span></div><div class="line">    port: 3xx</div><div class="line">    uid: <span class="string">'sAMAccountName'</span></div><div class="line">    method: <span class="string">'plain'</span></div><div class="line">    bind_dn: <span class="string">'CN=xxx,OU=xxx,DC=xxx,DC=xxx'</span></div><div class="line">    password: <span class="string">'xxxxxxxx'</span></div><div class="line">    active_directory: <span class="literal">true</span></div><div class="line">    allow_username_or_email_login: ture</div><div class="line">    block_auto_created_users: <span class="literal">false</span></div><div class="line">    base: <span class="string">'OU=xxx,DC=xxx,DC=xxx'</span></div><div class="line">    user_filter: <span class="string">''</span></div><div class="line">EOS</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># gitlab é‚®ä»¶é…ç½®</span></div><div class="line">gitlab_rails[<span class="string">'smtp_enable'</span>] = <span class="literal">true</span>;</div><div class="line">gitlab_rails[<span class="string">'smtp_address'</span>] = <span class="string">'smtp.exmail.qq.com'</span>;</div><div class="line">gitlab_rails[<span class="string">'smtp_port'</span>] = 465;</div><div class="line">gitlab_rails[<span class="string">'smtp_user_name'</span>] = <span class="string">"xx@xxxxx.com"</span></div><div class="line">gitlab_rails[<span class="string">'smtp_password'</span>] = <span class="string">"xxxxxxx"</span></div><div class="line">gitlab_rails[<span class="string">'smtp_domain'</span>] = <span class="string">'smtp.exmail.qq.com'</span>;</div><div class="line">gitlab_rails[<span class="string">'smtp_authentication'</span>] = <span class="string">"login"</span></div><div class="line">gitlab_rails[<span class="string">'smtp_enable_starttls_auto'</span>] = <span class="literal">true</span></div><div class="line">gitlab_rails[<span class="string">'smtp_tls'</span>] = <span class="literal">true</span></div><div class="line">gitlab_rails[<span class="string">'gitlab_email_from'</span>] = <span class="string">'xxx@xxxxxx.com'</span></div><div class="line">nginx[<span class="string">'redirect_http_to_https'</span>] = <span class="literal">true</span></div><div class="line">nginx[<span class="string">'ssl_certificate'</span>] = <span class="string">"/etc/gitlab/ssl/gitdb.pem"</span></div><div class="line">nginx[<span class="string">'ssl_certificate_key'</span>] = <span class="string">"/etc/gitlab/ssl/gitdb.key"</span></div><div class="line">nginx[<span class="string">'redirect_http_to_https_port'</span>] = 80</div><div class="line">nginx[<span class="string">'listen_port'</span>] = 443</div></pre></td></tr></table></figure><h2 id="gitlabæœåŠ¡å¯åŠ¨"><a href="#gitlabæœåŠ¡å¯åŠ¨" class="headerlink" title="gitlabæœåŠ¡å¯åŠ¨"></a>gitlabæœåŠ¡å¯åŠ¨</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~]# gitlab-ctl start</div></pre></td></tr></table></figure><h2 id="lsyncd-ä¸»ä»åŒæ­¥é…ç½®"><a href="#lsyncd-ä¸»ä»åŒæ­¥é…ç½®" class="headerlink" title="lsyncd ä¸»ä»åŒæ­¥é…ç½®"></a>lsyncd ä¸»ä»åŒæ­¥é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment">#  /etc/lsyncd.conf </span></div><div class="line">settings &#123;</div><div class="line">    logfile =<span class="string">"/var/log/lsyncd/lsyncd.log"</span>,</div><div class="line">    statusFile =<span class="string">"/var/log/lsyncd/lsyncd.status"</span>,</div><div class="line">    inotifyMode = <span class="string">"Modify"</span>,</div><div class="line">    maxProcesses = 20,</div><div class="line">    &#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">sync &#123;</div><div class="line">    default.rsync,</div><div class="line">    <span class="built_in">source</span>    = <span class="string">"/var/opt/gitlab"</span>,</div><div class="line">    target    = <span class="string">"root@172.30.1.17:/var/opt/gitlab/"</span>,</div><div class="line">    exclude = &#123; <span class="string">"backups"</span>, <span class="string">"gitlab-ci"</span>, <span class="string">"sockets"</span>,<span class="string">"gitlab.yml"</span>,<span class="string">"redis"</span>,<span class="string">"postmaster.pid "</span>&#125;,</div><div class="line">    maxDelays = 5,</div><div class="line">    delay = 30,</div><div class="line">    -- init = <span class="literal">true</span>,</div><div class="line">    rsync     = &#123;</div><div class="line">        binary = <span class="string">"/usr/bin/rsync"</span>,</div><div class="line">        archive = <span class="literal">true</span>,</div><div class="line">        compress = <span class="literal">true</span>,</div><div class="line">        bwlimit   = 2000</div><div class="line">        -- rsh = <span class="string">"/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">sync &#123;</div><div class="line">    default.rsync,</div><div class="line">    <span class="built_in">source</span>    = <span class="string">"/etc/gitlab/"</span>,</div><div class="line">    target    = <span class="string">"root@172.30.1.17:/etc/gitlab/"</span>,</div><div class="line">    maxDelays = 5,</div><div class="line">    delay = 30,</div><div class="line">    -- init = <span class="literal">true</span>,</div><div class="line">    rsync     = &#123;</div><div class="line">        binary = <span class="string">"/usr/bin/rsync"</span>,</div><div class="line">        archive = <span class="literal">true</span>,</div><div class="line">        compress = <span class="literal">true</span>,</div><div class="line">        bwlimit   = 2000</div><div class="line">        -- rsh = <span class="string">"/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">! Configuration File <span class="keyword">for</span> keepalived</div><div class="line">global_defs &#123;</div><div class="line">   notification_email &#123;</div><div class="line">     root@localhost</div><div class="line">   &#125;</div><div class="line">   notification_email_from Alexandre.Cassen@firewall.loc</div><div class="line">   smtp_server 127.0.0.1</div><div class="line">   smtp_connect_timeout 30</div><div class="line">   router_id node1</div><div class="line">   &#125;</div><div class="line">vrrp_script chk_gitlab &#123;</div><div class="line">    script <span class="string">"/bin/bash /usr/local/keepalived/etc/keepalived/check_gitlab.sh"</span></div><div class="line">    interval 5</div><div class="line">    weight -20</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">    state BACKUP</div><div class="line">    interface em1</div><div class="line">    virtual_router_id 55</div><div class="line">    priority 100</div><div class="line">    nopreempt</div><div class="line">    advert_int 1</div><div class="line">    notify_master <span class="string">"/usr/local/keepalived/etc/keepalived/message.sh  master"</span></div><div class="line">    notify_backup <span class="string">"/usr/local/keepalived/etc/keepalived/message.sh  backup"</span></div><div class="line">    notify_fault  <span class="string">"/usr/local/keepalived/etc/keepalived/message.sh  fault"</span></div><div class="line">    unicast_src_ip 172.30.1.16</div><div class="line">    unicast_peer &#123;</div><div class="line">     172.30.1.17</div><div class="line">    &#125;</div><div class="line">    track_script &#123;</div><div class="line">       chk_gitlab</div><div class="line">    &#125;</div><div class="line">    authentication &#123;</div><div class="line">        auth_type PASS</div><div class="line">        auth_pass xxxxxxxx</div><div class="line">    &#125;</div><div class="line">    virtual_ipaddress &#123;</div><div class="line">        172.30.1.20</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="keepalived-æ£€æµ‹è„šæœ¬"><a href="#keepalived-æ£€æµ‹è„šæœ¬" class="headerlink" title="keepalived æ£€æµ‹è„šæœ¬"></a>keepalived æ£€æµ‹è„šæœ¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="function"><span class="title">package</span></span>() &#123;</div><div class="line">    rpm -qf /usr/bin/curl &amp;&gt; /dev/null || yum -y install curl &amp;&gt; /dev/null</div><div class="line">&#125;</div><div class="line">package</div><div class="line"><span class="function"><span class="title">gitlab_state</span></span> () &#123; </div><div class="line">    /usr/bin/curl -s  https://gitdb.novogene.com/users/sign_in | grep <span class="string">"Username"</span> &amp;&gt; /dev/null</div><div class="line">&#125;</div><div class="line">gitlab_state ; gitlab_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state_num</span></div><div class="line"><span class="function"><span class="title">gitlab_state2</span></span> () &#123;</div><div class="line">   /usr/bin/curl -s  https://gitdb.novogene.com/users/sign_in | grep <span class="string">"Password"</span> &amp;&gt; /dev/null</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">kill_keepalived</span></span> () &#123;</div><div class="line">      <span class="built_in">kill</span> -9 `cat /var/run/keepalived.pid`</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$gitlab_state_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">   <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` gitlab_status_one_check problem "</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log</div><div class="line">   gitlab_state2 ; gitlab_state2_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state2_num</span> </div><div class="line">   <span class="keyword">if</span> [ <span class="variable">$gitlab_state2_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"`  gitlab_status2_one_check problem"</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log     </div><div class="line">        sleep 1</div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">gitlab_state ; gitlab_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state_num</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$gitlab_state_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` gitlab_status_two_check problem "</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log</div><div class="line">    gitlab_state2 ; gitlab_state2_num=$? ; <span class="built_in">echo</span> <span class="variable">$gitlab_state2_num</span> </div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$gitlab_state2_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` gitlab_status2_two_check problem "</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_gitlab.log</div><div class="line">        <span class="built_in">echo</span> <span class="string">"gitdb jiqun change node1"</span> | mutt -s <span class="string">"gitdb.novogene.com"</span> renjin@novogene.com</div><div class="line">        kill_keepalived</div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure><h2 id="git-å®¢æˆ·ç«¯å¸¸ç”¨å‘½ä»¤"><a href="#git-å®¢æˆ·ç«¯å¸¸ç”¨å‘½ä»¤" class="headerlink" title="git å®¢æˆ·ç«¯å¸¸ç”¨å‘½ä»¤"></a>git å®¢æˆ·ç«¯å¸¸ç”¨å‘½ä»¤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># git config --global user.name &quot;name&quot; #è®¾ç½®å…¨å±€ç”¨æˆ·å</div><div class="line"># git config --global user.email  xxx@novogene.com # è®¾ç½®å…¨å±€é‚®ç®±</div><div class="line"># git config --global --list #åˆ—å‡ºç”¨æˆ·å…¨å±€è®¾ç½®</div><div class="line"># git add index.html / . #æ·»åŠ æŒ‡å®šæ–‡ä»¶ã€ç›®å½•æˆ–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ•°æ®åˆ°æš‚å­˜åŒº</div><div class="line"># git commit -m &quot;xx&quot; #æäº¤æ–‡ä»¶åˆ°å·¥ä½œåŒº</div><div class="line"># git status #æŸ¥çœ‹å·¥ä½œåŒºçš„çŠ¶æ€</div><div class="line"># git push #æäº¤ä»£ç åˆ°æœåŠ¡å™¨</div><div class="line"># git pull # è·å–ä»£ç åˆ°æœ¬åœ°</div><div class="line"># git log # æŸ¥çœ‹æ“ä½œæ—¥å¿—</div><div class="line"># vim .gitignore  # å®šä¹‰å¿½ç•¥æ–‡ä»¶</div><div class="line"># git rest --hard HEAD^^ # gitç‰ˆæœ¬å›æ»šï¼ŒHEADä¸ºå½“å‰ç‰ˆæœ¬ï¼ŒåŠ ä¸€ä¸ª^ä¸ºä¸Šä¸€ä¸ªï¼Œ^^ä¸ºä¸Šä¸Šä¸€ä¸ªç‰ˆæœ¬</div><div class="line"># git reflog # è·å–æ¯æ¬¡æäº¤çš„ID,å¯ä»¥ä½¿ç”¨--hardæ ¹æ®æäº¤çš„IDè¿›è¡Œç‰ˆæœ¬å›é€€</div><div class="line"># git reset --hard 5ae4b06 #å›é€€åˆ°æŒ‡å®šidçš„ç‰ˆæœ¬</div><div class="line"># git branch # æŸ¥çœ‹å½“å‰æ‰€å¤„çš„åˆ†æ”¯</div><div class="line"># git checkout -b develop # åˆ›å»ºå¹¶åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°åˆ†æ”¯</div><div class="line"># git checkout  develop #åˆ‡æ¢åˆ†æ”¯</div></pre></td></tr></table></figure><h2 id="gitç¼“å­˜åŒºä¸å·¥ä½œåŒºç­‰æ¦‚å¿µ"><a href="#gitç¼“å­˜åŒºä¸å·¥ä½œåŒºç­‰æ¦‚å¿µ" class="headerlink" title="gitç¼“å­˜åŒºä¸å·¥ä½œåŒºç­‰æ¦‚å¿µ"></a>gitç¼“å­˜åŒºä¸å·¥ä½œåŒºç­‰æ¦‚å¿µ</h2><ul><li>å·¥ä½œåŒº: clone çš„ä»£ç æˆ–è€…å¼€å‘è‡ªå·±ç¼–å†™çš„ä»£ç æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ä»£ç æ‰€åœ¨çš„ä¸€ä¸ªæœåŠ¡çš„ç›®å½•åç§°;</li></ul><ul><li><p>æš‚å­˜åŒº: ç”¨äºå­˜å‚¨åœ¨å·¥ä½œåŒºä¸­å¯¹ä»£ç è¿›è¡Œä¿®æ”¹åçš„æ–‡ä»¶æ‰€ä¿å­˜çš„åœ°æ–¹ï¼Œä½¿ç”¨git addæ·»åŠ ;</p></li><li><p>æœ¬åœ°ä»“åº“: ç”¨äºæäº¤å­˜å‚¨åœ¨å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­æ”¹è¿‡çš„æ–‡ä»¶åœ°æ–¹ï¼Œä½¿ç”¨git commitæäº¤;</p></li><li><p>è¿œç¨‹ä»“åº“: å¤šä¸ªå¼€å‘å…±åŒåä½œæäº¤ä»£ç çš„ä»“åº“ï¼Œå³gitlabæˆ–githubæœåŠ¡å™¨ã€‚</p></li></ul><h2 id="macos-å®‰è£…-git"><a href="#macos-å®‰è£…-git" class="headerlink" title="macos å®‰è£… git"></a>macos å®‰è£… git</h2><p>æœªå®‰è£… Homebrew çš„éœ€è¦å…ˆå®‰è£…Homebrew</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /usr/bin/ruby -e \ </span></div><div class="line"><span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></div></pre></td></tr></table></figure><p>å®‰è£…git</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># brew install git</div></pre></td></tr></table></figure><h2 id="CentOS-å®‰è£…-git"><a href="#CentOS-å®‰è£…-git" class="headerlink" title="CentOS å®‰è£… git"></a>CentOS å®‰è£… git</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum -y install git</div></pre></td></tr></table></figure><h2 id="Ubuntu-å®‰è£…-git"><a href="#Ubuntu-å®‰è£…-git" class="headerlink" title="Ubuntu å®‰è£… git"></a>Ubuntu å®‰è£… git</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># apt-get install git</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>æ€»ç»“glibcçš„å‡çº§æ“ä½œ</title>
      <link href="/2020/03/11/glibc%20%E5%8D%87%E7%BA%A7%E5%A4%84%E7%90%86/"/>
      <url>/2020/03/11/glibc%20%E5%8D%87%E7%BA%A7%E5%A4%84%E7%90%86/</url>
      <content type="html"><![CDATA[<h1 id="æ€»ç»“glibcçš„å‡çº§æ“ä½œ"><a href="#æ€»ç»“glibcçš„å‡çº§æ“ä½œ" class="headerlink" title="æ€»ç»“glibcçš„å‡çº§æ“ä½œ"></a>æ€»ç»“glibcçš„å‡çº§æ“ä½œ</h1><p><img src="/images/glibc.png" alt=""></p><h2 id="é‡åˆ°çš„æ‰§è¡Œç¨‹åºæŠ¥é”™"><a href="#é‡åˆ°çš„æ‰§è¡Œç¨‹åºæŠ¥é”™" class="headerlink" title="é‡åˆ°çš„æ‰§è¡Œç¨‹åºæŠ¥é”™"></a>é‡åˆ°çš„æ‰§è¡Œç¨‹åºæŠ¥é”™</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">fastp.sh çš„æ—¶å€™æŠ¥ä¸‹é¢çš„é”™ï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½æ²¡é—®é¢˜</div><div class="line">fastp: /lib64/libc.so.6: version `GLIBC_2.14&apos; not found (required by fastp)</div><div class="line">fastp: /lib64/libc.so.6: version `GLIBC_2.14&apos; not found (required by /zlib/lib/libz.so.1)</div></pre></td></tr></table></figure><p>åœ¨æ“ä½œä¹‹å‰æœ€å¥½å…ˆå¤‡ä»½ <code>/lib64/libc.so.6</code> å’Œå®ƒå¯¹åº”æŒ‡å‘çš„é“¾æ¥æ–‡ä»¶</p><h2 id="å¤„ç†è¿‡ç¨‹"><a href="#å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¤„ç†è¿‡ç¨‹"></a>å¤„ç†è¿‡ç¨‹</h2><p><code>æ³¨: æ“ä½œæœåŠ¡å™¨çš„æ—¶å€™ï¼Œä¸€å®šè¦æŠŠè¿™ä¸ªèŠ‚ç‚¹ä»é›†ç¾¤ä¸­å»é™¤ã€‚ç¡®ä¿ä¸å½±å“ä¸šåŠ¡çš„ä½¿ç”¨</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># cat /etc/redhat-release </div><div class="line">CentOS release 6.5 (Final)</div><div class="line"># strings /lib64/libc.so.6 |grep GLIBC_ </div><div class="line">GLIBC_2.2.5</div><div class="line">GLIBC_2.2.6</div><div class="line">GLIBC_2.3</div><div class="line">GLIBC_2.3.2</div><div class="line">GLIBC_2.3.3</div><div class="line">GLIBC_2.3.4</div><div class="line">GLIBC_2.4</div><div class="line">GLIBC_2.5</div><div class="line">GLIBC_2.6</div><div class="line">GLIBC_2.7</div><div class="line">GLIBC_2.8</div><div class="line">GLIBC_2.9</div><div class="line">GLIBC_2.10</div><div class="line">GLIBC_2.11</div><div class="line">GLIBC_2.12</div><div class="line">GLIBC_PRIVATE</div></pre></td></tr></table></figure></p><p>ç”±ä¸Šé¢çš„ä¿¡æ¯å¯ä»¥çœ‹å‡ºç³»ç»Ÿæ˜¯CentOS 6.5ï¼Œæœ€é«˜æ”¯æŒglibcçš„ç‰ˆæœ¬ä¸º2.12ï¼Œè€Œç ”å‘ç¨‹åºè¦2.14ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦å‡çº§ã€‚</p><h2 id="ä¸‹è½½è½¯ä»¶å¹¶å‡çº§"><a href="#ä¸‹è½½è½¯ä»¶å¹¶å‡çº§" class="headerlink" title="ä¸‹è½½è½¯ä»¶å¹¶å‡çº§"></a>ä¸‹è½½è½¯ä»¶å¹¶å‡çº§</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># wget http://ftp.gnu.org/gnu/glibc/glibc-2.14.tar.gz </div><div class="line"># wget http://ftp.gnu.org/gnu/glibc/glibc-ports-2.14.tar.gz </div><div class="line"># tar -xvf  glibc-2.14.tar.gz </div><div class="line"># tar -xvf  glibc-ports-2.14.tar.gz</div><div class="line"># mv glibc-ports-2.14 glibc-2.14/ports</div><div class="line"># mkdir glibc-2.14/build</div><div class="line"># cd glibc-2.14/build </div><div class="line"># ../configure  --prefix=/usr --disable-profile --enable-add-ons --with-headers=/usr/include --with-binutils=/usr/bin</div><div class="line"># make</div><div class="line"># make install</div></pre></td></tr></table></figure><h2 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h2><p><code>è¿™ä¸ªæ—¶å€™å¯èƒ½é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼Œåƒä¸‡ä¸è¦æ–­å¼€ssh æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œè¡¥æ•‘</code><br><img src="/images/glibc-not.jpeg" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># LD_PRELOAD=/lib64/libc-2.14.so </div><div class="line"># rm -f /lib64/libc.so.6</div><div class="line"># ln -s /lib64/libc-2.14.so /lib64/libc.so.6</div></pre></td></tr></table></figure><p>è¿™æ—¶å€™å†çœ‹çœ‹ç³»ç»Ÿå‘½ä»¤è¿˜èƒ½å¦éƒ½æ­£å¸¸ä½¿ç”¨</p><h2 id="å¦‚æœæ–­å¼€äº†ssh-çš„æƒ…å†µä¸‹"><a href="#å¦‚æœæ–­å¼€äº†ssh-çš„æƒ…å†µä¸‹" class="headerlink" title="å¦‚æœæ–­å¼€äº†ssh çš„æƒ…å†µä¸‹"></a>å¦‚æœæ–­å¼€äº†ssh çš„æƒ…å†µä¸‹</h2><p>å¦‚æœæ–­å¼€äº†ssh åªèƒ½è¿›ç³»ç»Ÿæ•‘æ´æ¨¡å¼è¿›è¡Œè¡¥æ•‘äº†;<br>é‡å¯ï¼Œ(single/1)å•ç”¨æˆ·æ¨¡å¼ï¼Œ/bin/bashï¼Œenforcing=0,selinux=0 éƒ½æ˜¯æ— æµäºäº‹çš„ï¼Œå› ä¸ºå®ƒæ¶‰åŠçš„åº“æ˜¯<code>libc.so.6</code>å¿…éœ€çš„ï¼Œé‡å¯åä¼šæŠ¥å†…æ ¸ææ…Œ<code>Kernel panic â€“ not syncing: Attempted to kill init</code>;<br>å› æ­¤è¿›å…¥æ•‘æ´æ¨¡å¼è¿›è¡Œè¡¥æ•‘ã€‚</p><ol><li>è¿æ¥dellæœåŠ¡å™¨è¿œç¨‹æ§åˆ¶å°ï¼Œæ˜ å°„æœ¬åœ°é•œåƒæ–‡ä»¶åˆ°dellæœåŠ¡å™¨;</li><li>å¯åŠ¨é¡¹é»˜è®¤è°ƒæ•´ä¸ºå…‰ç›˜é•œåƒå¯åŠ¨;</li><li>è¿›å…¥æ•‘æ´æ¨¡å¼<code>Rescue installed system</code>;</li><li>é€‰æ‹©è¯­è¨€å’Œé”®ç›˜ç”¨Englishã€ us;</li><li>å‡ºç°ç½‘ç»œè®¾ç½®ä¸éœ€è¦é…ç½®;</li><li>æŒ‚è½½/mnt/sysimage é€‰ç”¨Continue;</li><li>å‘ç°ç£ç›˜ï¼Œé€‰æ‹©yes;</li><li>å¯ç”¨shellç™»å½•;</li><li>cd /mnt/sysimage ç›®å½•;</li><li><code>rm -f /lib64/libc.so.6</code> <code>cd /lib64 &amp;&amp; ln -s libc-2.14.so libc.so.6</code>;</li><li><code>chroot /mnt/sysimage</code> åˆ‡æ¢æ ¹ç›®å½•æµ‹è¯•ç³»ç»Ÿæ˜¯å¦æ— è¯¯;</li><li>é‡æ–°å¯åŠ¨ç³»ç»Ÿã€‚</li></ol>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ç½‘ç»œç»æµä¸ä¼ä¸šç®¡ç†(ä¸€)</title>
      <link href="/2020/03/01/zikao/%E7%BD%91%E7%BB%9C%E7%BB%8F%E6%B5%8E%E4%B8%8E%E7%AE%A1%E7%90%86/"/>
      <url>/2020/03/01/zikao/%E7%BD%91%E7%BB%9C%E7%BB%8F%E6%B5%8E%E4%B8%8E%E7%AE%A1%E7%90%86/</url>
      <content type="html"><![CDATA[<h1 id="ç½‘ç»œç»æµä¸ä¼ä¸šç®¡ç†-ä¸€"><a href="#ç½‘ç»œç»æµä¸ä¼ä¸šç®¡ç†-ä¸€" class="headerlink" title="ç½‘ç»œç»æµä¸ä¼ä¸šç®¡ç†(ä¸€)"></a>ç½‘ç»œç»æµä¸ä¼ä¸šç®¡ç†(ä¸€)</h1><p><img src="/images/wangluojinjiyuguanli.jpg" alt=""></p><h2 id="ä¼ä¸šåŠå…¶å½¢å¼"><a href="#ä¼ä¸šåŠå…¶å½¢å¼" class="headerlink" title="ä¼ä¸šåŠå…¶å½¢å¼"></a>ä¼ä¸šåŠå…¶å½¢å¼</h2><ol><li>ä¼ä¸šæ˜¯ä»¥<strong>å¸‚åœº</strong> ä¸ºå¯¼å‘ä»äº‹å•†å“ç”Ÿäº§å’Œæµé€šçš„ç»æµç»„ç»‡;</li><li>ä¼ä¸šæ˜¯ä»¥<strong>ä»·å€¼å¢å€¼</strong>ä½œä¸ºå…¶ç»æµæ´»åŠ¨çš„ç›®çš„;</li><li>ä¼ä¸šè¿›è¡Œ<strong>è‡ªä¸»ç»è¥</strong> <strong>è‡ªè´Ÿç›ˆäº</strong>å’Œ<strong>ç‹¬ç«‹æ ¸ç®—</strong>ã€‚ç‹¬ç«‹æ ¸ç®—</li></ol><p>é€‰æ‹©é¢˜</p><p><strong>å·¥å‚åˆ¶åº¦</strong>çš„å»ºç«‹ï¼Œæ ‡å¿—ç€ä¼ä¸šçš„çœŸæ­£å½¢æˆã€‚</p><p>å¤šé€‰ï¼Œç°ä»£ä¼ä¸šç”Ÿäº§æ—¶æœŸçš„ç‰¹å¾</p><ol><li><strong>æ‹¥æœ‰ç°ä»£æŠ€æœ¯</strong></li><li><strong>æ‹¥æœ‰ç°ä»£åŒ–ç®¡ç†</strong></li><li><strong>æ‰€æœ‰è€…ä¸ç»è¥è€…ç›¸åˆ†ç¦»</strong></li></ol><h2 id="ç®¡ç†æ–¹é¢"><a href="#ç®¡ç†æ–¹é¢" class="headerlink" title="ç®¡ç†æ–¹é¢"></a>ç®¡ç†æ–¹é¢</h2><ol><li>æ‹¥æœ‰ç°ä»£åŒ–ç®¡ç†</li><li>æ‰€æœ‰è€…ä¸ç»è¥è€…ç›¸åˆ†ç¦»</li></ol><h2 id="ç”Ÿäº§æŠ€æœ¯"><a href="#ç”Ÿäº§æŠ€æœ¯" class="headerlink" title="ç”Ÿäº§æŠ€æœ¯"></a>ç”Ÿäº§æŠ€æœ¯</h2><ol><li>æ‹¥æœ‰ç°ä»£æŠ€æœ¯</li><li>ç”Ÿäº§è§„æ¨¡ç©ºå‰æ‰©å¤§ï¼Œäº§ç”Ÿäº†å„æ–­ç»„ç»‡</li><li>åŠ³åŠ¨åˆ†å·¥è¶Šæ¥æˆªæ­¢ç²¾ç»†ï¼Œåä½œå…³ç³»å¤æ‚ã€ä¸¥å¯†</li></ol><h2 id="ç«äº‰"><a href="#ç«äº‰" class="headerlink" title="ç«äº‰"></a>ç«äº‰</h2><ol><li>ä¼ä¸šä¹‹é—´çš„ç«äº‰æ¿€çƒˆ</li></ol><h2 id="ç¤¾ä¼šè´£ä»»"><a href="#ç¤¾ä¼šè´£ä»»" class="headerlink" title="ç¤¾ä¼šè´£ä»»"></a>ç¤¾ä¼šè´£ä»»</h2><ol><li>ä¼ä¸šçš„ç¤¾ä¼šè´£ä»»æ”¹å˜</li></ol><h2 id="ä¼ä¸šç±»å‹"><a href="#ä¼ä¸šç±»å‹" class="headerlink" title="ä¼ä¸šç±»å‹"></a>ä¼ä¸šç±»å‹</h2><p>æ ¹æ®ä¼ä¸šæ‰€å±çš„ç»æµéƒ¨(å†œä¸šä¼ä¸šã€å·¥ä¸šä¼ä¸šã€é‡‘èä¼ä¸šã€å•†ä¸šä¼ä¸š)<br>æ ¹æ®ç”Ÿäº§åŠ›è¦ç´ æ¯”é‡(åŠ³åŠ¨å¯†é›†å‹ä¼ä¸šã€æŠ€æœ¯å¯†é›†å‹ä¼ä¸šã€çŸ¥è¯†å¯†é›†å‹ä¼ä¸šã€èµ„æºå¯†é›†å‹ä¼ä¸š)<br>æ ¹æ®ä¼ä¸šç»è¥è§„æ¨¡(å¤§å‹ä¼ä¸šï¼Œä¸­å‹ä¼ä¸šï¼Œå°å‹ä¼ä¸š)<br>æ ¹æ®ä¼ä¸šè´¢äº§æ„æˆå’Œæ‰€è´Ÿæ³•å¾‹è´£ä»»:<br>1ã€ä¸ªä½“ä¼ä¸š<br>åˆå«ç‹¬èµ„ä¼ä¸šï¼Œæ˜¯<strong>ç”±ä¸šä¸»ä¸ªäººå‡ºèµ„å…´åŠ</strong>ï¼Œç”±ä¸šä¸»è‡ªå·±ç»è¥ã€‚åœ¨å›½å¤–ï¼Œè®¸å¤šé›¶å”®å•†ä¸šã€æ‰‹å·¥ä¸šã€å®¶åº­å·¥ä¸šã€å†œä¸šç­‰å¤šé‡‡ç”¨ä¸ªä½“ä¼ä¸šã€‚<br>2ã€ åˆä¼™ä¼ä¸š<br>ç”±ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ä¸ªäººå…±åŒå‡ºèµ„ï¼Œé€šè¿‡ç­¾è®¢åè®®è”åˆç»è¥ã€‚<br>3ã€å…¬å¸åˆ¶ä¼ä¸š(å¦‚æœ‰é™è´£ä»»å…¬å¸å’Œè‚¡ä»½æœ‰é™å…¬å¸)<br>ç”±ä¸¤ä¸ªä»¥ä¸Šçš„å‡ºèµ„è€…å…±åŒå‡ºèµ„ã€ä¾æ³•ç»„å»ºï¼Œ<strong>ä»¥ç›ˆåˆ©ä¸ºç›®çš„çš„ä¼ä¸šæ³•äºº</strong>ï¼Œæ˜¯è”åˆç»è¥çš„ä¼ä¸šç»„ç»‡å½¢å¼ã€‚</p><h2 id="å…¬å¸åˆ¶ä¼ä¸šçš„ç‰¹ç‚¹"><a href="#å…¬å¸åˆ¶ä¼ä¸šçš„ç‰¹ç‚¹" class="headerlink" title="å…¬å¸åˆ¶ä¼ä¸šçš„ç‰¹ç‚¹"></a>å…¬å¸åˆ¶ä¼ä¸šçš„ç‰¹ç‚¹</h2><p>å…¬å¸åˆ¶ä¼ä¸šæ˜¯æ³•äººã€‚<br>å…¬å¸åˆ¶ä¼ä¸šå®è¡Œæœ‰é™è´£ä»»åˆ¶åº¦ã€‚<br>å…¬å¸åˆ¶ä¼ä¸šçš„æ‰€æœ‰æƒå’Œç»è¥æƒç›¸åˆ†ç¦»ã€‚</p><h2 id="çœŸé¢˜"><a href="#çœŸé¢˜" class="headerlink" title="çœŸé¢˜"></a>çœŸé¢˜</h2><p>1ã€ä¼ä¸šä¸ºäº†æ»¡è¶³ç¤¾ä¼š</p><h2 id="ç®¡ç†"><a href="#ç®¡ç†" class="headerlink" title="ç®¡ç†"></a>ç®¡ç†</h2><p>1ã€ç®¡ç†æ˜¯ä¸€ä¸ªåŠ¨æ€è¿‡ç¨‹;<br>2ã€ç®¡ç†çš„ç¯æŠ±æ˜¯è¾¾åˆ°ç»„ç»‡çš„é¢„å®šç›®æ ‡;<br>3ã€ç®¡ç†çš„è½½ä½“æ˜¯ç»„ç»‡;<br>4ã€ç®¡ç†çš„æ ¸å¿ƒæ˜¯å¯¹èµ„æºçš„åˆç†é…ç½®å’Œæœ‰æ•ˆæ•´åˆã€‚</p><h2 id="ç®¡ç†æ´»åŠ¨æ‰€å…·å¤‡çš„æ¡ä»¶"><a href="#ç®¡ç†æ´»åŠ¨æ‰€å…·å¤‡çš„æ¡ä»¶" class="headerlink" title="ç®¡ç†æ´»åŠ¨æ‰€å…·å¤‡çš„æ¡ä»¶"></a>ç®¡ç†æ´»åŠ¨æ‰€å…·å¤‡çš„æ¡ä»¶</h2><p>ç®¡ç†çš„ä¸»ä½“(è°æ¥ç®¡) ã€ ç®¡ç†çš„å®¢ä½“(ç®¡ç†è°)ã€ ç®¡ç†çš„ç›®çš„(ä¸ºå•¥ç®¡)</p><h2 id="äº”èŒèƒ½è®º"><a href="#äº”èŒèƒ½è®º" class="headerlink" title="äº”èŒèƒ½è®º"></a>äº”èŒèƒ½è®º</h2><p>æ³•çº¦å°”è®¤ä¸ºï¼Œä¼ä¸šçš„ç®¡ç†æ´»åŠ¨å°±æ˜¯ç”±<strong>è®¡åˆ’</strong>ã€<strong>ç»„ç»‡</strong>ã€<strong>æŒ‡æŒ¥</strong>ã€<strong>åè°ƒ</strong>ã€<strong>æ§åˆ¶</strong> è¿™äº”ç§èŒèƒ½çº§æˆçš„ã€‚ <strong>è®¡åˆ’</strong> æ˜¯ç®¡ç†èŒèƒ½ä¸­çš„é¦–è¦èŒèƒ½ â€“&gt;</p><h2 id="ç®¡ç†-çš„è®¡åˆ’èŒèƒ½"><a href="#ç®¡ç†-çš„è®¡åˆ’èŒèƒ½" class="headerlink" title="ç®¡ç† çš„è®¡åˆ’èŒèƒ½"></a>ç®¡ç† çš„è®¡åˆ’èŒèƒ½</h2><p><strong>è®¡åˆ’</strong>ã€<strong>ç»„ç»‡</strong>ã€<strong>é¢†å¯¼</strong>ã€<strong>æ§åˆ¶</strong> æ˜¯ç®¡ç†å­¦æ´¾æ™®é€šçš„å…¬è®¤çš„èŒèƒ½ã€‚ é¦–è¦çš„èŒèƒ½<br><strong>è®¡åˆ’èŒèƒ½</strong> æ˜¯å¯¹<strong>å³å®šçš„ç›®æ ‡</strong>è¿›è¡Œå…·ä½“å®‰æ’ï¼Œä½œä¸ºå…¨ä½“å‘˜å·¥åœ¨ä¸€å®šæ—¶æœŸçš„è¡ŒåŠ¨çº²é¢†ï¼Œ<br>å¹¶è§„å®šå®ç°ç›®æ ‡çš„é€”å¾„ã€æ–¹æ³•çš„ç®¡ç†æ´»æ´»åŠ¨ã€‚<br>1 å¹´ä»¥å†…æ˜¯çŸ­æœŸè®¡åˆ’ï¼Œ 1-5 æ˜¯ä¸­æœŸè®¡åˆ’ ï¼Œ5å¹´åæ˜¯é•¿æœŸè®¡åˆ’</p><h2 id="ç»„ç»‡å·¥ä½œçš„åŸºæœ¬åŸåˆ™-ç®€ç­”"><a href="#ç»„ç»‡å·¥ä½œçš„åŸºæœ¬åŸåˆ™-ç®€ç­”" class="headerlink" title="ç»„ç»‡å·¥ä½œçš„åŸºæœ¬åŸåˆ™(ç®€ç­”)"></a>ç»„ç»‡å·¥ä½œçš„åŸºæœ¬åŸåˆ™(ç®€ç­”)</h2><p>æœ‰æ•ˆæ€§åŸåˆ™: èƒ½é«˜æ•ˆåœ°å®Œæˆå·¥ä½œï¼›æœºæ„è®¾ç½®å’Œäººå‘˜é…å¤‡åˆ°ç²¾ç®€ã€‚ç²¾ç®€äººå‘˜å®ç°ä»»åŠ¡å’Œè´£ä»»åˆ°äººï¼Œæœ‰æ•ˆåœ°é¿å…äº†æ¨è¯¿å’Œæ‰¯çš®ç°è±¡ã€‚<br>ç»Ÿä¸€æŒ‡æŒ¥åŸåˆ™: åœ¨æŒ‡æŒ¥å’Œå‘½ä»¤ï¼Œä¸¥æ ¼æ‰§è¡Œâ€ä¸€å…ƒåŒ–â€ç®¡ç†ã€‚<br>è´£æƒåˆ©ç›¸ä¸€è‡´åˆ™:ä¸ºæ¯ä¸€ä¸ªå±‚æ¬¡å’Œç¯èŠ‚éƒ½è§„å®šè´£ï¼ŒåŒæ—¶èµ‹äºˆæ‰€å¿…é¡»çš„èŒæƒã€‚<br>é›†æƒå’Œåˆ†æƒç›¸ç»“åˆåŸåˆ™: å¯¹é‡å¤§å†³ç­–å’Œå…¨å±€æ€§ç®¡ç†å®è¡Œé›†æƒï¼Œå¯¹æ—¥å¸¸ç®¡ç†å®è¡Œåˆ†æƒã€‚<br>å¼¹æ€§åŸåˆ™: è®¾è®¡ç»„ç»‡ç»“æ„æ—¶è¦ç•™æœ‰ä½™åœ°ï¼Œåˆ¶å®šä¸€äº›å¸¦æœ‰ä¼¸ç¼©æ€§çš„ç»„ç»‡è§„åˆ™ã€‚<br>åè°ƒåŸåˆ™: ç»„ç»‡çš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯ â€œæ•´ä½“åŠŸèƒ½å¤§äºéƒ¨åˆ†åŠŸèƒ½ä¹‹å’Œâ€</p><h2 id="é¢†å¯¼çš„æ´»åŠ¨å†…å®¹"><a href="#é¢†å¯¼çš„æ´»åŠ¨å†…å®¹" class="headerlink" title="é¢†å¯¼çš„æ´»åŠ¨å†…å®¹"></a>é¢†å¯¼çš„æ´»åŠ¨å†…å®¹</h2><p>1ã€æƒåŠ›çš„å½¢æˆå’Œè¿ç”¨<br>2ã€æŒ‡å¯¼<br>3ã€æ¿€åŠ±<br>4ã€æ²Ÿé€š<br>5ã€åè°ƒ<br>6ã€è¥é€ ç»„ç»‡æ°”æ°›ï¼Œå»ºè®¾ç»„ç»‡æ–‡åŒ–</p><h2 id="æ§åˆ¶çš„æ–¹å¼-é€‰æ‹©"><a href="#æ§åˆ¶çš„æ–¹å¼-é€‰æ‹©" class="headerlink" title="æ§åˆ¶çš„æ–¹å¼(é€‰æ‹©)"></a>æ§åˆ¶çš„æ–¹å¼(é€‰æ‹©)</h2><p>é¢„å…ˆæ§åˆ¶:æ˜¯é¢å‘æœªæ¥çš„æ§åˆ¶ï¼Œåˆç§°<strong>å‰é¦ˆæ§åˆ¶</strong>ã€‚<br>ç°åœºæ§åˆ¶:æŒ‡åœ¨å®æ–½è®¡åˆ’è¿‡ç¨‹ä¸­ï¼Œå……åˆ†ä½“ç®¡ç†æ§åˆ¶çš„é‚£ä¸€éƒ¨åˆ†å·¥ä½œï¼Œåˆç§°<strong>é€‚æ—¶æ§åˆ¶</strong>ï¼Œæ˜¯<strong>æœ€åŸºæœ¬çš„æ§åˆ¶æ–¹å¼</strong><br>åé¦ˆæ§åˆ¶: ä¹Ÿç§°<strong>è¿‡åè¡Œä¸ºæ§åˆ¶æˆ–äº‹åæ§åˆ¶</strong></p><p>ä¼ä¸šæ˜¯ä»¥<strong>ä»·å€¼å¢å€¼</strong>ä½œä¸ºå…¶ç»æµæ´»åŠ¨çš„ç›®çš„<br>ä¼ä¸šç®¡ç†çš„ç›®æ ‡æ˜¯å®ç°ä¼ä¸š<strong>ä»·å€¼çš„æœ€å¤§åŒ–</strong></p><h2 id="çœŸé¢˜-1"><a href="#çœŸé¢˜-1" class="headerlink" title="çœŸé¢˜"></a>çœŸé¢˜</h2><p>å½¢æˆä¸€é¡¹ç®¡ç†æ´»åŠ¨å¿…é¡»å…·å¤‡çš„æ¡ä»¶ï¼ŒåŒ…æ‹¬ <strong>æœ‰æ•ˆç®¡ç†çš„ä¸»ä½“</strong> ï¼Œ<strong>æœ‰æ•ˆç®¡ç†çš„å®¢ä½“</strong>  ï¼Œ<strong>æœ‰æ•ˆç®¡ç†çš„ç›®çš„</strong></p><p>ç®¡ç†çš„é¦–è¦èŒèƒ½æ˜¯<strong>è®¡åˆ’</strong></p><p>ä¸­æœŸè®¡åˆ’çš„æ—¶é—´ä¸€èˆ¬æ˜¯<strong>ä¸€åˆ°äº”å¹´ä»¥å†…</strong></p><p>è¿ç­¹å¸·å¹„ä¹‹ä¸­ï¼Œå†³èƒœåƒé‡Œä¹‹å¤–ï¼Œè¿™é‡Œè¿ç­¹å¸·å¹„ååº”äº†ç®¡ç†çš„å“ªä¸€ä¸ªèŒèƒ½ <strong>è®¡åˆ’èŒèƒ½</strong></p><p>æ³•çº¦å°”çš„ä¼ä¸šç®¡ç†æ´»åŠ¨â€œäº”èŒèƒ½è®ºâ€ åŒ…æ‹¬è®¡åˆ’ã€ç»„ç»‡ã€æŒ‡æŒ¥åŠ<strong>è°ƒåä¸æ§åˆ¶</strong></p><p>ç²¾ç®€äººå‘˜å®ç°ä»»åŠ¡å’Œè´£ä»»åˆ°äººï¼Œæœ‰æ•ˆåœ°é¿å…äº†æ¨è¯¿å’Œæ‰¯çš®çš„ç°è±¡ï¼Œè¿™ä½“ç°äº†ç»„ç»‡å·¥ä½œçš„å“ªé¡¹åŸåˆ™ <strong>æœ‰æ•ˆæ€§åŸåˆ™</strong></p><p>æŒ‰ç…§æ§åˆ¶æ–¹å¼çš„ä¸åŒï¼Œä¸€èˆ¬æŠŠæ§åˆ¶åˆ†ä¸º <strong>é¢„å…ˆæ§åˆ¶ï¼Œç°åœºæ§åˆ¶ï¼Œåé¦ˆæ§åˆ¶</strong></p><p>ç°åœºæ§åˆ¶ï¼Œåˆç§°<strong>é€‚æ—¶æ§åˆ¶</strong></p><p>å¯¹æ—¢å®šçš„ç›®æ ‡è¿›è¡Œå…·ä½“å®‰æ’ï¼Œä½œä¸ºå…¨ä½“å‘˜å·¥åœ¨ä¸€æ—¶æ—¶æœŸå†…çš„è¡ŒåŠ¨çº²é¢†ï¼Œå¹¶è§„å®šå®ç°ç›®æ ‡çš„é€”å¾„ï¼Œæ–¹æ³•çš„ç®¡ç†çš„ <strong>è®¡åˆ’èŒèƒ½</strong></p><h2 id="ä¼ä¸šç®¡ç†çš„ç›®æ ‡"><a href="#ä¼ä¸šç®¡ç†çš„ç›®æ ‡" class="headerlink" title="ä¼ä¸šç®¡ç†çš„ç›®æ ‡"></a>ä¼ä¸šç®¡ç†çš„ç›®æ ‡</h2><p>åˆ©ç›Šç›¸å…³ç€(èµ„æœ¬æ‰€æœ‰è€…ã€å€ºæƒäººã€å®¢æˆ·ã€ä¾›åº”å•†ã€æ”¿åºœå’Œç¤¾ä¼š)</p><h2 id="ä¼ä¸šç®¡ç†ç†è®ºä¸å®è·µçš„äº§ç”Ÿä¸å‘å±•"><a href="#ä¼ä¸šç®¡ç†ç†è®ºä¸å®è·µçš„äº§ç”Ÿä¸å‘å±•" class="headerlink" title="ä¼ä¸šç®¡ç†ç†è®ºä¸å®è·µçš„äº§ç”Ÿä¸å‘å±•"></a>ä¼ä¸šç®¡ç†ç†è®ºä¸å®è·µçš„äº§ç”Ÿä¸å‘å±•</h2><p>æ³°ç½— ã€Šç§‘å­¦ç®¡ç†åŸç†ã€‹ è¢«ç§°ä¸ºç§‘å­¦ç®¡ç†ä¹‹çˆ¶<br>æ³•çº¦å°”ã€Šå·¥ä¸šç®¡ç†å’Œä¸€èˆ¬ç®¡ç†ã€‹ ç®¡ç†è¿‡ç¨‹ç†è®ºä¹‹çˆ¶<br>éŸ¦ä¼¯ã€Šç¤¾ä¼šå’Œç»æµç†è®ºã€‹ è¢«ç§°ä¸ºç»„ç»‡ç®¡ç†ä¹‹çˆ¶</p><p>è¡Œä¸ºç§‘å­¦ç†è®ºï¼Œ20ä¸–çºªåˆ°30å¹´ä»£åˆ°60å¹´ä»£</p><table><thead><tr><th>å§“å</th><th>ç†è®º</th></tr></thead><tbody><tr><td>é©¬æ–¯æ´›</td><td>éœ€æ±‚å±‚æ¬¡ç†è®º</td></tr><tr><td>èµ«èŒ¨ä¼¯æ ¼</td><td>åŒå› ç´ ç†è®º</td></tr><tr><td>éº¦å…‹åˆ©å…°</td><td>æ¿€åŠ±éœ€æ±‚ç†è®º</td></tr><tr><td>éº¦æ ¼é›·æˆˆ</td><td>Xç†è®º-Yç†è®º</td></tr></tbody></table><h3 id="ç®¡ç†ç†è®ºä¸›æ—"><a href="#ç®¡ç†ç†è®ºä¸›æ—" class="headerlink" title="ç®¡ç†ç†è®ºä¸›æ—"></a>ç®¡ç†ç†è®ºä¸›æ—</h3><table><thead><tr><th>å§“å</th><th>å­¦æ´¾</th></tr></thead><tbody><tr><td>å·´çº³å¾·</td><td>ç¤¾ä¼šç³»ç»Ÿå­¦æ´¾</td></tr><tr><td>è¥¿è’™</td><td>å†³ç­–å­¦æ´¾</td></tr><tr><td>å¾·é²å…‹</td><td>ç»éªŒ(æ¡ˆä¾‹) å­¦æ´¾</td></tr></tbody></table><h3 id="æˆ˜ç•¥ç®¡ç†ä¸å®è·µçš„äº§ç”Ÿå’Œå‘å±•"><a href="#æˆ˜ç•¥ç®¡ç†ä¸å®è·µçš„äº§ç”Ÿå’Œå‘å±•" class="headerlink" title="æˆ˜ç•¥ç®¡ç†ä¸å®è·µçš„äº§ç”Ÿå’Œå‘å±•"></a>æˆ˜ç•¥ç®¡ç†ä¸å®è·µçš„äº§ç”Ÿå’Œå‘å±•</h3><p>20 ä¸–çºª60å¹´ä»£ä¸­åæœŸåˆ°80å¹´ä»£åˆï¼Œä¼ä¸šç®¡ç†å­¦ç•Œå¼€å§‹é‡ç‚¹ç ”ç©¶<strong>æˆ˜ç•¥ç®¡ç†ç†è®º</strong><br>20 ä¸–çºªå…­ä¸ƒåå¹´ä»£ï¼Œæ—¥æœ¬å¼•è¿›ç¾å›½è´¨é‡ç®¡ç†ä¸“å®¶æˆ´æ˜å’Œæœ±å…°çš„<strong>å…¨é¢è´¨é‡ç®¡ç†</strong>çš„æ€æƒ³<br><strong>ä¼ä¸šæ–‡åŒ–</strong>æˆä¸º80å¹´ä¼ä¸šç®¡ç†ç ”ç©¶çš„é‡ç‚¹</p><table><thead><tr><th>æ—¶é—´</th><th>ä»£è¡¨äººç‰©</th><th>ç†è®º</th></tr></thead><tbody><tr><td>20ä¸–çºª80å¹´ä»£åæœŸ</td><td>å“ˆé»˜&amp;é’±çš®</td><td>ä¼ä¸šå†é€ ç†è®º</td></tr><tr><td>20ä¸–çºª90å¹´ä»£åæœŸ</td><td>å½¼å¾·&amp;åœ£å‰</td><td>ç¬¬5é¡¹ä¿®ç‚¼-ä¼ä¸šå”¯ä¸€æŒä¹…çš„ç«äº‰ä¼˜åŠ¿æºäºæ¯”ç«äº‰å¯¹æ‰‹å­¦å¾—æ›´å¿«ã€æ›´å¥½çš„èƒ½åŠ›</td></tr></tbody></table><h2 id="çœŸé¢˜-2"><a href="#çœŸé¢˜-2" class="headerlink" title="çœŸé¢˜"></a>çœŸé¢˜</h2><ol><li>ç®€è¿°å¤å…¸ç®¡ç†ç†è®ºä¸‰ä½ä¸»è¦ä»£è¡¨ä»£äººç‰©åŠå…¶è´¡çŒ®<br>aã€æ³°ç½—çš„ç§‘å­¦ç®¡ç†ç†è®ºï¼Œé‡ç‚¹ç ”ç©¶äº†åœ¨å·¥å‚ç®¡ç†ä¸­å¦‚ä½•æé«˜æ•ˆç‡ï¼Œå€¡å¯¼è¦ç”¨ç§‘å­¦æ€æƒ³ï¼Œç§‘å­¦æ–¹æ³•å¤„ç†å’Œè§£å†³ä¼ä¸šç®¡ç†é—®é¢˜ã€‚<br>bã€æ³•çº¦å°”çš„ç®¡ç†è¿‡ç¨‹ç†è®ºï¼Œå¯¹ç»„ç»‡ç®¡ç†è¿›è¡Œäº†ç³»ç»Ÿçš„ã€ç‹¬åˆ›çš„ç ”ç©¶ï¼Œæå‡ºäº†ç®¡ç†å…·æœ‰è®¡åˆ’ã€ç»„ç»‡ã€æŒ‡æŒ¥ã€åè°ƒå’Œæ§åˆ¶5å¤§èŒèƒ½å’Œ14æ¡ç®¡ç†åŸåˆ™ã€‚<br>cã€é©¬å…‹æ–¯.éŸ¦ä¼¯çš„ç®¡ç†ç»„ç»‡ç†è®ºï¼Œæå‡ºäº†ç†æƒ³è¡Œæ”¿ç»„ç»‡ä½“ç³»ç†è®ºã€‚</li></ol><ol><li><p>è¢«ç§°ä¸ºâ€ç§‘å­¦ç®¡ç†ä¹‹çˆ¶â€çš„æ˜¯<strong>æ³°ç½—</strong></p></li><li><p>é©¬æ–¯æ´›çš„ä»£è¡¨æ€§ç†è®ºæˆæœæ˜¯<strong>éœ€æ±‚å±‚æ¬¡ç†è®º</strong></p></li><li><p>ç»éªŒ(æ¡ˆä¾‹)å­¦æ´¾çš„äººç‰©æ˜¯<strong>å·´çº³å¾·</strong></p></li><li><p>20ä¸–çºª60-70å¹´ä»£æ—¥æœ¬å¼•å…¥äº†ç¾å›½è´¨é‡ç®¡ç†ä¸“å®¶æˆ´æ˜å’Œæœ±å…°çš„<strong>å…¨é¢è´¨é‡ç®¡ç†æ€æƒ³</strong></p></li><li><p>æ³•çº¦å°”è®¤ä¸ºï¼Œä¼ä¸šç®¡ç†ç†æ´»åŠ¨çš„èŒèƒ½åŒ…æ‹¬è®¡åˆ’ã€ç»„ç»‡å’Œ <strong>æŒ‡æŒ¥ã€åè°ƒå’Œæ§åˆ¶</strong></p></li><li><p>è¢«èª‰ä¸ºâ€ç»„ç»‡ç®¡ç†ä¹‹çˆ¶â€çš„æ˜¯ <strong>éŸ¦ä¼¯</strong></p></li><li><p>è¢«èª‰ä¸ºâ€ç®¡ç†è¿‡ç¨‹ç†è®ºä¹‹çˆ¶â€æ˜¯ <strong>æ³•çº¦å°”</strong></p></li><li><p>èµ«èŒ¨ä¼¯æ ¼æå‡ºäº†è‘—åçš„<strong>åŒå› ç´ ç†è®º</strong> </p></li></ol><p>9.éº¦æ ¼é›·æˆˆæå‡ºäº†è‘—åçš„ <strong>Xç†è®º-Yç†è®º</strong></p><ol><li>ä¼ä¸šå”¯ä¸€æŒä¹…çš„ç«äº‰ä¼˜åŠ¿æºäºæ¯”ç«äº‰å¯¹æ‰‹å­¦å¾—æ›´å¿«ã€æ›´å¥½çš„èƒ½åŠ›ï¼Œæ˜¯å“ªä½ç®¡ç†å­¦è€…çš„è§‚ç‚¹ <strong>å½¼å¾·.åœ£å‰</strong></li></ol><h2 id="ç½‘ç»œæ—¶ä»£çš„ä¼ä¸šç¯å¢ƒ"><a href="#ç½‘ç»œæ—¶ä»£çš„ä¼ä¸šç¯å¢ƒ" class="headerlink" title="ç½‘ç»œæ—¶ä»£çš„ä¼ä¸šç¯å¢ƒ"></a>ç½‘ç»œæ—¶ä»£çš„ä¼ä¸šç¯å¢ƒ</h2><h3 id="ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æœºé‡"><a href="#ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æœºé‡" class="headerlink" title="ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æœºé‡"></a>ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æœºé‡</h3><ol><li>ä¼ä¸šå¯ä»¥æ›´å¥½åœ°æ»¡è¶³é¡¾å®¢çš„ä¸ªæ€§åŒ–éœ€æ±‚ï¼›</li><li>ä¼ä¸šå¯ä»¥é™ä½äº¤æ˜“æˆæœ¬;</li><li>ä¼ä¸šå¯ä»¥å‡å°‘åº“å­˜;</li><li>ä¼ä¸šå¯ä»¥ä½¿åˆä½œç«äº‰æˆ˜ç•¥æ›´ä¾¿åˆ©åœ°å®æ–½;</li><li>æé«˜è·å–çŸ¥è¯†ã€åº”ç”¨çŸ¥è¯†çš„èƒ½åŠ›ã€‚</li></ol><h3 id="ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æŒ‘æˆ˜"><a href="#ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æŒ‘æˆ˜" class="headerlink" title="ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æŒ‘æˆ˜"></a>ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æŒ‘æˆ˜</h3><ol><li>ä¼ä¸šé¢ä¸´æ—¥ç›Šæ¿€çƒˆçš„ç«äº‰ï¼›</li><li>é¡¾å®¢çš„æƒåŠ›å¤§å¢åŠ ;</li><li>ä¼ä¸šçš„æ•´ä½“ç›ˆåˆ©æ°´å¹³å°†ä¼šé™ä½;</li><li>ä¼ä¸šå…³é”®çš„æˆåŠŸå› ç´ å°†ä¼šæ”¹å˜;</li><li>ä¼ä¸šèµ„æºé…ç½®çš„æ–¹å¼å’Œç•Œé™å°†ä¼šå‘ç”Ÿé‡å¤§å˜åŒ–ã€‚</li></ol><h2 id="ç½‘ç»œæ—¶ä»£ä¼ä¸šç®¡ç†çš„å˜é©"><a href="#ç½‘ç»œæ—¶ä»£ä¼ä¸šç®¡ç†çš„å˜é©" class="headerlink" title="ç½‘ç»œæ—¶ä»£ä¼ä¸šç®¡ç†çš„å˜é©"></a>ç½‘ç»œæ—¶ä»£ä¼ä¸šç®¡ç†çš„å˜é©</h2><h3 id="ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›"><a href="#ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›" class="headerlink" title="ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›"></a>ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›</h3><p>ç½‘ç»œä¼ä¸šä¸å®ä½“ä¼ä¸šç›¸æ¯”æœ‰å¦‚ä¸‹ç‰¹ç‚¹:<br>aã€ç½‘ç»œä¼ä¸šæ‰€å çš„å®ç°ç©ºé—´éå¸¸æœ‰é™ï¼Œä¸åƒç”Ÿäº§ä¼ä¸šå’Œé”€å”®ä¼ä¸šé‚£æ ·å æœ‰å¤§é¢ç§¯çš„å®ç°ç©ºé—´è¿›è¡Œäº§å“ç”Ÿäº§å’Œäº§å“å­˜å‚¨;<br>bã€ç½‘ç»œä¼ä¸šæ˜¯è®¡ç®—æœºåŒ–å’Œç½‘ç»œåŒ–çš„ä¼ä¸š;<br>cã€ç½‘ç»œä¼ä¸šæ˜¯å…¨å¤©å€™è¿è¥çš„ä¼ä¸š;<br>dã€ç½‘ç»œä¼ä¸šæ˜¯ä¿¡æ¯æŠ€æœ¯å’Œä¿¡æ¯äº§å“åº”ç”¨å‹çš„ä¼ä¸š;<br>eã€ç½‘ç»œä¼ä¸šæ˜¯é«˜çŸ¥è¯†å¼€å‹çš„æ¾æ•£ä¼ä¸šã€‚</p><h3 id="ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›-1"><a href="#ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›-1" class="headerlink" title="ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›"></a>ä¼ä¸šç®¡ç†æ‹“å±•çš„èŒƒå›´æœ‰å“ªäº›</h3><p>aã€ç½‘ç»œä¼ä¸šç®¡ç†;<br>bã€ä¼ä¸šçš„ç½‘ç»œåŒ–ç®¡ç†;<br>cã€æ›´åŠ é‡è§†ä»¥çŸ¥è¯†èµ„æœ¬ä¸ºæ ¸å¿ƒçš„æ— å½¢èµ„æœ¬çš„ç®¡ç†ï¼›<br>dã€ä¼ä¸šç®¡ç†çš„èŒƒå›´æ‹“å±•åˆ°æ•´ä¸ªä¾›åº”é“¾ã€‚</p><h3 id="ä¼ä¸šç®¡ç†åˆ›æ–°çš„å†…å®¹æœ‰å“ªäº›"><a href="#ä¼ä¸šç®¡ç†åˆ›æ–°çš„å†…å®¹æœ‰å“ªäº›" class="headerlink" title="ä¼ä¸šç®¡ç†åˆ›æ–°çš„å†…å®¹æœ‰å“ªäº›"></a>ä¼ä¸šç®¡ç†åˆ›æ–°çš„å†…å®¹æœ‰å“ªäº›</h3><ol><li>ä¼ä¸šæˆ˜ç•¥ç®¡ç†çš„åˆ›æ–°;</li><li>ä¼ä¸šç»„ç»‡ç®¡ç†çš„åˆ›æ–°;</li><li>ç½‘ç»œè¥é”€æˆä¸ºè¥é”€ç®¡ç†çš„é‡è¦å†…å®¹;</li><li>æ•æ·åˆ¶é€ æˆä¸ºä¼ä¸šç”Ÿäº§è¿ä½œç®¡ç†æœ€é‡è¦çš„æ–¹å¼;</li><li>ä¼ä¸šç®¡ç†å°†å‘æˆ˜ç•¥å‹ï¼Œé›†æˆåŒ–æ–¹å‘å‘å±•;</li><li>å›å½’äººæœ¬ç®¡ç†ï¼Œé‡è§†äººåŠ›èµ„æºç®¡ç†;</li><li>çŸ¥è¯†ç®¡ç†æˆä¸ºä¼ä¸šç®¡ç†çš„é‡è¦å†…å®¹;</li><li>æ›´åŠ é‡è§†æ–‡åŒ–ç®¡ç†ã€‚</li></ol><h3 id="ä¼ä¸šæˆ˜ç•¥ç®¡ç†çš„å˜é©"><a href="#ä¼ä¸šæˆ˜ç•¥ç®¡ç†çš„å˜é©" class="headerlink" title="ä¼ä¸šæˆ˜ç•¥ç®¡ç†çš„å˜é©"></a>ä¼ä¸šæˆ˜ç•¥ç®¡ç†çš„å˜é©</h3><p><strong>å¼€å‘å’ŒåŸ¹è‚²æ ¸å¿ƒèƒ½åŠ›</strong>æˆä¸ºä¼ä¸šæˆ˜ç•¥ç®¡ç†é‡ç‚¹ã€‚</p><h3 id="ä¼ä¸šç»„ç»‡ç»“æ„å˜é©çš„æ–¹å‘"><a href="#ä¼ä¸šç»„ç»‡ç»“æ„å˜é©çš„æ–¹å‘" class="headerlink" title="ä¼ä¸šç»„ç»‡ç»“æ„å˜é©çš„æ–¹å‘"></a>ä¼ä¸šç»„ç»‡ç»“æ„å˜é©çš„æ–¹å‘</h3><p>å››ä¸ªç°ä»£åŒ–(æ‰å¹³åŒ–â€“&gt; è™šæ‹ŸåŒ– â€“&gt; æŸ”æ€§åŒ– â€“&gt; ç½‘ç»œåŒ–)</p><h3 id="ä¼ä¸šç®¡ç†æ–¹æ³•å’Œæ‰‹æ®µçš„åˆ›æ–°"><a href="#ä¼ä¸šç®¡ç†æ–¹æ³•å’Œæ‰‹æ®µçš„åˆ›æ–°" class="headerlink" title="ä¼ä¸šç®¡ç†æ–¹æ³•å’Œæ‰‹æ®µçš„åˆ›æ–°"></a>ä¼ä¸šç®¡ç†æ–¹æ³•å’Œæ‰‹æ®µçš„åˆ›æ–°</h3><table><thead><tr><th>å‡†æ—¶åˆ¶</th><th>JIT</th><th>Just In Time</th><th>åœ¨éœ€è¦çš„æ—¶å€™ï¼ŒæŒ‰éœ€è¦çš„é‡ï¼Œç”Ÿäº§æ‰€éœ€çš„äº§å“: é›¶åºŸå“ï¼Œé›¶åº“å­˜ï¼Œé›¶å‡†å¤‡æ—¶é—´</th></tr></thead><tbody><tr><td>åˆ¶é€ èµ„æºè®¡åˆ’</td><td>MRP</td><td>Manufacturing Resources Planning</td><td>ç¡®ä¿ä¼ä¸šè¿ç»­ã€å‡è¡¡åœ°ç”Ÿäº§ï¼Œå®ç°ä¿¡æ¯æµã€ç‰©æµä¸èµ„é‡‘æµçš„æœ‰æœºé›†æˆï¼Œä»¥è®¡åˆ’çš„ä¸æ§åˆ¶ä¸ºä¸»çº¿</td></tr><tr><td>ä¼ä¸šèµ„æºè®¡åˆ’</td><td>ERP</td><td>Enterprise Resources Planning</td><td>ä»¥å®¢æˆ·éœ€æ±‚ä¸ºå¯¼å‘ï¼Œå®è¡Œä¼ä¸šå†…å¤–èµ„æºä¼˜åŒ–é…ç½®ï¼Œæ¶ˆé™¤ç”Ÿäº§ç»è¥è¿‡ç¨‹ä¸­ä¸€åˆ‡æ— æ•ˆçš„åŠ³åŠ¨å’Œèµ„æº</td></tr><tr><td>ç”µå­æ•°æ®äº¤æ¢</td><td>EDI</td><td>Electronic Data Interchange</td></tr><tr><td>å¹¶è¡Œå·¥ç¨‹</td><td>CE</td><td>Concurrent Engineering</td><td>éœ€è¦äº§å“å¼€å‘äººå‘˜ä»è®¾è®¡å¼€å§‹è®¾è®¡å°±è€ƒè™‘äº§å“æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ‰€æœ‰å› ç´ </td></tr><tr><td>è®¡ç®—æœºé›†æˆåˆ¶é€ ç³»ç»Ÿ</td><td>CIMS</td><td>Computer Intergrated Manufacturing System</td></tr><tr><td>åˆ†é”€èµ„æºè®¡åˆ’</td><td>DRP</td><td>Distribution Resource Planning</td><td>ä½¿ä¼ä¸šå…·æœ‰å¯¹å®šå•å’Œä¾›è´§å…·æœ‰å¿«é€Ÿååº”å’ŒæŒç»­è¡¥å……åº“å­˜çš„èƒ½åŠ›</td></tr><tr><td>ä¼ä¸šå†…éƒ¨ç½‘å’Œäº’è”ç½‘</td><td></td><td>Intranetï¼Œ Internet</td></tr></tbody></table><h2 id="çœŸé¢˜-3"><a href="#çœŸé¢˜-3" class="headerlink" title="çœŸé¢˜"></a>çœŸé¢˜</h2><ol><li>è¯·é˜è¿°ä¼ä¸šåœ¨ç½‘ç»œæ—¶ä»£ä¼šé¢å¯¹å“ªäº›æœºé‡å’ŒæŒ‘æˆ˜ï¼Ÿ</li></ol><table><thead><tr><th>ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æœºé‡</th><th>ç½‘ç»œæ—¶ä»£ä¼ä¸šé¢å¯¹çš„æŒ‘æˆ˜</th></tr></thead><tbody><tr><td>ä¼ä¸šå¯ä»¥æ›´å¥½åœ°æ»¡è¶³é¡¾å®¢çš„ä¸ªæ€§åŒ–éœ€æ±‚</td><td>é¡¾å®¢çš„æƒåŠ›å¤§å¤§å¢åŠ </td></tr><tr><td>ä¼ä¸šå¯ä»¥é™åº•äº¤æ˜“æˆæœ¬</td><td>ä¼ä¸šçš„æ•´ä½“ç›ˆåŠ›æ°´å¹³å°†ä¼šä»¥é™ä½</td></tr><tr><td>ä¼ä¸šå¯ä»¥å‡å°‘åº“å­˜</td><td>ä¼ä¸šèµ„æºçš„é…ç½®æ–¹å¼å’Œç•Œé™å°†ä¼šå‘ç”Ÿé‡å¤§å˜åŒ–</td></tr><tr><td>ä¼ä¸šå¯ä»¥ä½¿ç«äº‰æˆ˜ç•¥æ›´åˆ©åœ°å®æ–½</td><td>ä¼ä¸šé¢ä¸´æ—¥ç›Šæ¿€çƒˆçš„ç«äº‰</td></tr><tr><td>æé«˜è·å–çŸ¥è¯†ï¼Œåº”ç”¨çŸ¥è¯†çš„èƒ½åŠ›</td><td>ä¼ä¸šå…³é”®çš„æˆåŠŸå› ç´ å°†ä¼šæ”¹å˜</td></tr></tbody></table><ol><li>ä¼ä¸šæˆ˜ç•¥ç®¡ç†çš„é‡ç‚¹æ˜¯<strong>å¼€å‘å’ŒåŸ¹è‚²æ ¸å¿ƒèƒ½åŠ›</strong></li><li>ä½œä¸ºåº”å¯¹ç½‘ç»œç»æµçš„æŒ‘æˆ˜ï¼Œä¼ä¸šç»„ç»‡ç»“æ„å˜é©çš„æ–¹å‘æœ‰<strong>æŸ”æ€§åŒ–ã€è™šæ‹ŸåŒ–ã€ç½‘ç»œåŒ–ã€æ‰å¹³åŒ–</strong></li><li>å“ªç§ç®¡ç†æ–¹æ³•çš„ç›®æ ‡æ˜¯é€šè¿‡ç®¡ç†ï¼Œå°½å¯èƒ½åšåˆ°â€é›¶åºŸå“â€ã€â€é›¶åº“å­˜â€å’Œâ€é›¶å‡†å¤‡æ—¶é—´â€ <strong>JIT</strong></li><li>ä½“ç°äº†ä»¥å®¢æˆ·éœ€æ±‚ä¸ºå¯¼å‘ï¼Œæ¶ˆé™¤ç”Ÿäº§ç»è¥è¿‡ç¨‹ä¸­ä¸€åˆ‡æ— æ•ˆçš„åŠ³åŠ¨å’Œèµ„æºçš„ç®¡ç†æ€æƒ³æ˜¯<strong>ERP</strong></li><li>ä¼ä¸šèµ„æºè®¡åˆ’ç®€ç§°<strong>ERP</strong></li><li>ä¼ä¸šåˆ¶é€ èµ„æºè®¡åˆ’æ˜¯æŒ‡ <strong>MRP</strong></li><li>å‡†æ—¶åˆ¶ç®€ç§° <strong>JIT</strong></li><li>ç½‘ç»œç»æµæ—¶ä»£ï¼Œä¼ä¸šç»è¥æˆ˜ç•¥å°†å›´ç»•ä¸‹åˆ—å“ªä¸€é¡¹æ¥åˆ¶è®¢<strong>ä¼ä¸šæ ¸å¿ƒä¸šåŠ¡å’Œæ ¸å¿ƒç«äº‰åŠ›</strong></li></ol>]]></content>
      
      
        <tags>
            
            <tag> zikao </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>python ç®—æ³•</title>
      <link href="/2019/12/15/python%20%E7%AE%97%E6%B3%95/"/>
      <url>/2019/12/15/python%20%E7%AE%97%E6%B3%95/</url>
      <content type="html"><![CDATA[<h1 id="python-ç®—æ³•"><a href="#python-ç®—æ³•" class="headerlink" title="python ç®—æ³•"></a>python ç®—æ³•</h1><p><img src="/images/python.jpg" alt=""></p><h2 id="å‘½åå…ƒç»„namedtuple"><a href="#å‘½åå…ƒç»„namedtuple" class="headerlink" title="å‘½åå…ƒç»„namedtuple"></a>å‘½åå…ƒç»„namedtuple</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line">In [<span class="number">2</span>]: Point = namedtuple(<span class="string">'P'</span>,<span class="string">'x,y'</span>)</div><div class="line">In [<span class="number">3</span>]: type(Point)</div><div class="line">Out[<span class="number">3</span>]: type</div><div class="line">In [<span class="number">4</span>]: p1 = Point(<span class="number">1</span>,<span class="number">10</span>)</div><div class="line">In [<span class="number">5</span>]: p1</div><div class="line">Out[<span class="number">5</span>]: P(x=<span class="number">1</span>, y=<span class="number">10</span>)</div><div class="line">In [<span class="number">6</span>]: p1.x</div><div class="line">Out[<span class="number">6</span>]: <span class="number">1</span></div><div class="line">In [<span class="number">7</span>]: p1.y</div><div class="line">Out[<span class="number">7</span>]: <span class="number">10</span></div><div class="line">In [<span class="number">8</span>]: p1.x + p1.y</div><div class="line">Out[<span class="number">8</span>]: <span class="number">11</span></div></pre></td></tr></table></figure><p>æ’åº </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(py3_env) [root@ssjinyao:~/mypython/python3]<span class="comment"># cat sort.py</span></div><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line">nums = []</div><div class="line">out = <span class="keyword">None</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</div><div class="line">    nums.append(int(input(<span class="string">'&#123;&#125;: '</span>.format(i))))</div><div class="line">nums.sort()</div><div class="line">print(nums)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line">nums = []</div><div class="line">out = <span class="keyword">None</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</div><div class="line">    nums.append(int(input(<span class="string">'&#123;&#125;: '</span>.format(i))))</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    cur = min(nums)</div><div class="line">    print(cur)</div><div class="line">    nums.remove(cur)</div><div class="line">    <span class="keyword">if</span> len(nums) == <span class="number">1</span>:</div><div class="line">        print(nums[<span class="number">0</span>])</div><div class="line">        <span class="keyword">break</span></div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">nums = []</div><div class="line">out = None</div><div class="line">for i in range(3):</div><div class="line">    nums.append(int(input(&apos;&#123;&#125;:&apos;.format(i))))</div><div class="line"></div><div class="line">nums.sort()</div><div class="line">print(nums)</div></pre></td></tr></table></figure><h2 id="å†’æ³¡æ³•ä»£ç å®ç°-ä¸€"><a href="#å†’æ³¡æ³•ä»£ç å®ç°-ä¸€" class="headerlink" title="å†’æ³¡æ³•ä»£ç å®ç°(ä¸€)"></a>å†’æ³¡æ³•ä»£ç å®ç°(ä¸€)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">num_list = [</div><div class="line">        [<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],</div><div class="line">        [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],</div><div class="line">]</div><div class="line">nums = num_list[<span class="number">0</span>]</div><div class="line">print(nums)</div><div class="line">length = len(nums)</div><div class="line">count_swap = <span class="number">0</span></div><div class="line">count = <span class="number">0</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(length):</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(length-i<span class="number">-1</span>):</div><div class="line">        count += <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> nums[j] &gt; nums [j+<span class="number">1</span>]:</div><div class="line">            tmp = nums[j]</div><div class="line">            nums[j] = nums [j+<span class="number">1</span>]</div><div class="line">            nums[j+<span class="number">1</span>] = tmp</div><div class="line">            count_swap +=<span class="number">1</span></div><div class="line">print(nums, count_swap, count)</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[1, 9, 8, 5, 6, 7, 4, 3, 2]</div><div class="line">[1, 2, 3, 4, 5, 6, 7, 8, 9] 25 36</div></pre></td></tr></table></figure><h2 id="å†’æ³¡æ³•ä»£ç å®ç°-äºŒ"><a href="#å†’æ³¡æ³•ä»£ç å®ç°-äºŒ" class="headerlink" title="å†’æ³¡æ³•ä»£ç å®ç°(äºŒ)"></a>å†’æ³¡æ³•ä»£ç å®ç°(äºŒ)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">num_list = [</div><div class="line">    [<span class="number">1</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>],</div><div class="line">    [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]</div><div class="line">]</div><div class="line"></div><div class="line">nums = num_list[<span class="number">0</span>]</div><div class="line">print(nums)</div><div class="line">length = len(nums)</div><div class="line">flag = <span class="keyword">False</span></div><div class="line">count_swap = <span class="number">0</span></div><div class="line">count = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(length):</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(length-i<span class="number">-1</span>):</div><div class="line">        count += <span class="number">1</span></div><div class="line">        <span class="keyword">if</span> nums[j] &gt; nums[j+<span class="number">1</span>]:</div><div class="line">            tmp = nums[j]</div><div class="line">            nums[j] = nums[j+<span class="number">1</span>]</div><div class="line">            nums[j+<span class="number">1</span>] = tmp</div><div class="line">            flag = <span class="keyword">True</span></div><div class="line">            count_swap += <span class="number">1</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> flag:</div><div class="line">        <span class="keyword">break</span></div><div class="line">print(nums,count_swap,count)</div><div class="line">``` </div><div class="line"></div><div class="line"><span class="comment">## å­—ç¬¦ä¸²ä¿®æ”¹</span></div><div class="line"></div><div class="line">```python</div><div class="line">s = <span class="string">"I am very very very sorry   "</span></div><div class="line">s.strip()</div><div class="line">Out[<span class="number">4</span>]: <span class="string">'I am very very very sorry'</span></div></pre></td></tr></table></figure><h2 id="å­—ç¬¦ä¸²æŸ¥æ‰¾"><a href="#å­—ç¬¦ä¸²æŸ¥æ‰¾" class="headerlink" title="å­—ç¬¦ä¸²æŸ¥æ‰¾"></a>å­—ç¬¦ä¸²æŸ¥æ‰¾</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find(sub,[,start[end]]) -&gt; int</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: s = <span class="string">"I am very very very sorry "</span></div><div class="line">In [<span class="number">2</span>]: s.find(<span class="string">"very"</span>)</div><div class="line">Out[<span class="number">2</span>]: <span class="number">5</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">14</span>]: s = <span class="string">'I am very very very sorry'</span></div><div class="line">In [<span class="number">15</span>]: i = <span class="number">0</span></div><div class="line">In [<span class="number">16</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> s:</div><div class="line">    ...:     print(str(i)+x,end=<span class="string">" "</span>)</div><div class="line">    ...:     i +=<span class="number">1</span></div><div class="line">    ...:</div><div class="line"><span class="number">0</span>I <span class="number">1</span>  <span class="number">2</span>a <span class="number">3</span>m <span class="number">4</span>  <span class="number">5</span>v <span class="number">6</span>e <span class="number">7</span>r <span class="number">8</span>y <span class="number">9</span>  <span class="number">10</span>v <span class="number">11</span>e <span class="number">12</span>r <span class="number">13</span>y <span class="number">14</span>  <span class="number">15</span>v <span class="number">16</span>e <span class="number">17</span>r <span class="number">18</span>y <span class="number">19</span>  <span class="number">20</span>s <span class="number">21</span>o <span class="number">22</span>r <span class="number">23</span>r <span class="number">24</span>y</div></pre></td></tr></table></figure><h2 id="å­—ç¬¦ä¸²æ ¼å¼åŒ–"><a href="#å­—ç¬¦ä¸²æ ¼å¼åŒ–" class="headerlink" title="å­—ç¬¦ä¸²æ ¼å¼åŒ–"></a>å­—ç¬¦ä¸²æ ¼å¼åŒ–</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">15</span>]: t = (<span class="string">'asjin'</span>,<span class="string">'.com'</span>)</div><div class="line">In [<span class="number">16</span>]: <span class="string">"&#123;&#125;,&#123;&#125;"</span>.format(t[<span class="number">0</span>],t[<span class="number">1</span>])</div><div class="line">Out[<span class="number">16</span>]: <span class="string">'asjin,.com'</span></div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [18]: &quot;&#123;0&#125;,&#123;0&#125;&quot;.format(t[0])</div><div class="line">Out[18]: &apos;asjin,asjin&apos;</div><div class="line"></div><div class="line">In [19]: &quot;&#123;&#125;&quot;.format([1,2])</div><div class="line">Out[19]: &apos;[1, 2]&apos;</div></pre></td></tr></table></figure><p>ä½¿ç”¨ collections çš„  namedtuple æ¨¡å—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">20</span>]: <span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line">In [<span class="number">21</span>]: Point = namedtuple(<span class="string">'_Point'</span>,<span class="string">'x,y'</span>)</div><div class="line">In [<span class="number">22</span>]: p1 = Point(<span class="number">5</span>,<span class="number">6</span>)</div><div class="line">In [<span class="number">23</span>]: p1.x</div><div class="line">Out[<span class="number">23</span>]: <span class="number">5</span></div><div class="line">In [<span class="number">24</span>]: p1.y</div><div class="line">Out[<span class="number">24</span>]: <span class="number">6</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">27</span>]: <span class="string">"Point = (&#123;&#123;&#123;0.x&#125;,&#123;0.y&#125;&#125;&#125;)"</span>.format(p1)</div><div class="line">Out[<span class="number">27</span>]: <span class="string">'Point = (&#123;5,6&#125;)'</span></div></pre></td></tr></table></figure><h2 id="å¯¹é½"><a href="#å¯¹é½" class="headerlink" title="å¯¹é½"></a>å¯¹é½</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">28</span>]: <span class="string">'&#123;0&#125;*&#123;1&#125;=&#123;2:&gt;02&#125;'</span>.format(<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>*<span class="number">3</span>)</div><div class="line">Out[<span class="number">28</span>]: <span class="string">'3*2=06'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">29</span>]: <span class="string">'&#123;:^30&#125;'</span>.format(<span class="string">'asjin.com'</span>)</div><div class="line">Out[<span class="number">29</span>]: <span class="string">'          asjin.com           '</span></div><div class="line">In [<span class="number">30</span>]: <span class="string">'&#123;:#^30&#125;'</span>.format(<span class="string">'asjin.com'</span>)</div><div class="line">Out[<span class="number">30</span>]: <span class="string">'##########asjin.com###########'</span></div></pre></td></tr></table></figure><h2 id="è¿›åˆ¶è½¬æ¢"><a href="#è¿›åˆ¶è½¬æ¢" class="headerlink" title="è¿›åˆ¶è½¬æ¢"></a>è¿›åˆ¶è½¬æ¢</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">41</span>]: <span class="string">"int: &#123;0:d&#125;; hex: &#123;0:#x&#125;; oct: &#123;0:o&#125;: bin: &#123;0:b&#125;"</span>.format(<span class="number">25</span>)</div><div class="line">Out[<span class="number">41</span>]: <span class="string">'int: 25; hex: 0x19; oct: 31: bin: 11001'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">47</span>]: octets = [<span class="number">192</span>, <span class="number">168</span> , <span class="number">1</span> , <span class="number">1</span>]</div><div class="line">In [<span class="number">48</span>]: <span class="string">'&#123;:02X&#125;&#123;:02X&#125;&#123;:02X&#125;&#123;:02X&#125;'</span>.format(*octets)</div><div class="line">Out[<span class="number">48</span>]: <span class="string">'C0A80101'</span></div><div class="line">In [<span class="number">49</span>]: <span class="string">'&#123;:02x&#125;&#123;:02x&#125;&#123;:02x&#125;&#123;:02x&#125;'</span>.format(*octets)</div><div class="line">Out[<span class="number">49</span>]: <span class="string">'c0a80101'</span></div><div class="line">In [<span class="number">50</span>]: <span class="string">'&#123;:02d&#125;&#123;:02d&#125;&#123;:02d&#125;&#123;:02d&#125;'</span>.format(*octets)</div><div class="line">Out[<span class="number">50</span>]: <span class="string">'1921680101'</span></div></pre></td></tr></table></figure><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><p>è®©ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ•°ï¼Œä»åå¾€å‰æ‰“å°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*-coding: utf-8 -*-</span></div><div class="line">m = input(<span class="string">"&gt;&gt;&gt;"</span>).strip().lstrip(<span class="string">'0'</span>)</div><div class="line">print(<span class="string">"è¿™æ˜¯&#123;&#125;ä½æ•°"</span>.format(len(m)))</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(m)):</div><div class="line">    print(<span class="string">"&#123;&#125;'s count = &#123;&#125;"</span>.format(m[i],m.count(m[i])))</div><div class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(len(m)):</div><div class="line">    n=m[-j<span class="number">-1</span>]</div><div class="line">    print(n)</div><div class="line">print(m)</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">num = <span class="string">""</span></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    num = input(<span class="string">"Please input a interger: "</span>).strip()</div><div class="line">    num = int(num)</div><div class="line">    num = str(num)</div><div class="line">    <span class="keyword">if</span> num.isdigit():</div><div class="line">        <span class="keyword">break</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(<span class="string">"Bad number"</span>)</div><div class="line"></div><div class="line">count = [<span class="number">0</span>]*<span class="number">10</span> <span class="comment"># 0~9</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    count[i] = num.count(str(i))</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    <span class="keyword">if</span> count[i]:</div><div class="line">        print(i,count[i])</div><div class="line"></div><div class="line">lst = list(num)</div><div class="line">lst.reverse()</div><div class="line">print(lst)</div></pre></td></tr></table></figure><h2 id="è¾“å…¥5ä¸ªæ•°å­—ï¼Œæ‰“å°æ¯ä¸ªæ•°å­—çš„ä½æ•°ï¼Œ-å°†è¿™äº›æ•°å­—æ’åºæ‰“å°ï¼Œè¦æ±‚å‡åºæ‰“å°"><a href="#è¾“å…¥5ä¸ªæ•°å­—ï¼Œæ‰“å°æ¯ä¸ªæ•°å­—çš„ä½æ•°ï¼Œ-å°†è¿™äº›æ•°å­—æ’åºæ‰“å°ï¼Œè¦æ±‚å‡åºæ‰“å°" class="headerlink" title="è¾“å…¥5ä¸ªæ•°å­—ï¼Œæ‰“å°æ¯ä¸ªæ•°å­—çš„ä½æ•°ï¼Œ å°†è¿™äº›æ•°å­—æ’åºæ‰“å°ï¼Œè¦æ±‚å‡åºæ‰“å°"></a>è¾“å…¥5ä¸ªæ•°å­—ï¼Œæ‰“å°æ¯ä¸ªæ•°å­—çš„ä½æ•°ï¼Œ å°†è¿™äº›æ•°å­—æ’åºæ‰“å°ï¼Œè¦æ±‚å‡åºæ‰“å°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">lst = []</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">    m = input(<span class="string">"&gt;&gt;&gt; "</span>).strip().lstrip(<span class="string">"0"</span>)</div><div class="line">    print(<span class="string">"è¿™æ˜¯&#123;&#125;ä½æ•°"</span>.format(len(m)))</div><div class="line">    lst.append(int(m))</div><div class="line">print(sorted(lst))</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>sge linuxé«˜æ€§èƒ½é›†ç¾¤çš„æ­å»ºä¸ä½¿ç”¨</title>
      <link href="/2019/11/12/sge%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/11/12/sge%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<h1 id="sgeé«˜æ€§èƒ½é›†ç¾¤çš„æ­å»ºä¸ä½¿ç”¨"><a href="#sgeé«˜æ€§èƒ½é›†ç¾¤çš„æ­å»ºä¸ä½¿ç”¨" class="headerlink" title="sgeé«˜æ€§èƒ½é›†ç¾¤çš„æ­å»ºä¸ä½¿ç”¨"></a>sgeé«˜æ€§èƒ½é›†ç¾¤çš„æ­å»ºä¸ä½¿ç”¨</h1><p><img src="/images/sge.jpg" alt=""></p><h2 id="é›†ç¾¤ç¯å¢ƒçš„å‡†å¤‡"><a href="#é›†ç¾¤ç¯å¢ƒçš„å‡†å¤‡" class="headerlink" title="é›†ç¾¤ç¯å¢ƒçš„å‡†å¤‡"></a>é›†ç¾¤ç¯å¢ƒçš„å‡†å¤‡</h2><table><thead><tr><th>Node1(master)</th><th>CentOS7.4</th><th>iptables/selinux(off)</th><th>IP:10.180.66.11</th><th>hostname:node1</th><th>ali yumæº</th></tr></thead><tbody><tr><td>Node2(slave)</td><td>CentOS7.4</td><td>iptables/selinux(off)</td><td>IP:10.180.66.12</td><td>hostname:node2</td><td>ali yumæº</td></tr><tr><td>Node3(slave)</td><td>CentOS7.4</td><td>iptables/selinux(off)</td><td>IP:10.180.66.13</td><td>hostname:node3</td><td>ali yumæº</td></tr><tr><td>Node4(slave)</td><td>CentOS7.4</td><td>iptables/selinux(off)</td><td>IP:10.180.66.14</td><td>hostname:node4</td><td>ali yumæº</td></tr><tr><td>Node5(slave)</td><td>CentOS7.4</td><td>iptables/selinux(off)</td><td>IP:10.180.66.15</td><td>hostname:node5</td><td>ali yumæº</td></tr></tbody></table><h2 id="master-èŠ‚ç‚¹å®‰è£…"><a href="#master-èŠ‚ç‚¹å®‰è£…" class="headerlink" title="master èŠ‚ç‚¹å®‰è£…"></a>master èŠ‚ç‚¹å®‰è£…</h2><h3 id="å®‰è£…ç›¸å…³ä¾èµ–åŒ…"><a href="#å®‰è£…ç›¸å…³ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…ç›¸å…³ä¾èµ–åŒ…"></a>å®‰è£…ç›¸å…³ä¾èµ–åŒ…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum -y install jemalloc-devel openssl-devel ncurses-devel pam-devel libXmu-devel hwloc-devel hwloc hwloc-libs java-devel javacc ant-junit libdb-devel motif-devel csh ksh xterm db4-utils perl-XML-Simple perl-Env xorg-x11-fonts-ISO8859-1-100dpi xorg-x11-fonts-ISO8859-1-75dpi</div></pre></td></tr></table></figure><h3 id="æ–°å»ºsgeç®¡ç†å‘˜ç”¨æˆ·"><a href="#æ–°å»ºsgeç®¡ç†å‘˜ç”¨æˆ·" class="headerlink" title="æ–°å»ºsgeç®¡ç†å‘˜ç”¨æˆ·"></a>æ–°å»ºsgeç®¡ç†å‘˜ç”¨æˆ·</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#  groupadd -g 490 sgeadmin</div><div class="line"># useradd -u 495 -g 490 -r -m  -d /home/sgeadmin -s /bin/bash -c &quot;SGE Admin&quot; sgeadmin</div><div class="line"># sed -i &apos;/^%wheel/a\%sgeadmin       ALL=(ALL)       NOPASSWD: ALL&apos; /etc/sudoers</div></pre></td></tr></table></figure><h3 id="å®‰è£…sge"><a href="#å®‰è£…sge" class="headerlink" title="å®‰è£…sge"></a>å®‰è£…sge</h3><p><a href="https://pan.baidu.com/s/1GDxo7sKDrr1BcIdERgNU1w" target="_blank" rel="external">sge é“¾æ¥</a>  å¯†ç :c7hy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /usr/local/src/</span></div><div class="line"><span class="comment"># tar -xvf ge2011.11.tar.gz</span></div><div class="line"><span class="comment"># mkdir -pv /data</span></div><div class="line"><span class="comment"># cp -a ge2011.11 /data/sge</span></div><div class="line"><span class="comment"># chown sgeadmin.sgeadmin /data/sge</span></div></pre></td></tr></table></figure><p><strong> qmaster å®‰è£…è‡ªåŠ¨å›ç­”è„šæœ¬ï¼Œä¾èµ–è½¯ä»¶åŒ…<code>expect</code>, æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å®‰è£… </strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /data/sge/</span></div><div class="line"><span class="comment"># vim master.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">user=<span class="string">"sgeadmin"</span></div><div class="line">/usr/bin/expect &lt;&lt;-EOF</div><div class="line">spawn ./install_qmaster</div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"y</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"n</span></div><div class="line"><span class="string">"</span></div><div class="line"></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect eof</div><div class="line">EOF</div><div class="line"><span class="comment"># sh  master.sh</span></div></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸»èŠ‚ç‚¹ç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># export SGE_ROOT=/data/sge</span></div><div class="line"><span class="comment"># echo 'export SGE_ROOT=/data/sge' &gt;&gt; ~/.bashrc</span></div><div class="line"><span class="comment"># echo 'PATH=$PATH:/data/sge/bin/linux-x64/:/data/sge/bin/' &gt;&gt; ~/.bashrc</span></div><div class="line"><span class="comment"># cp /data/sge/default/common/settings.sh  /etc/profile.d/</span></div><div class="line"><span class="comment"># sh /etc/profile.d/settings.sh</span></div><div class="line"><span class="comment"># source  /etc/profile</span></div></pre></td></tr></table></figure><p>æ·»åŠ èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># qconf -ah node1</span></div><div class="line"><span class="comment"># qconf -ah node2</span></div><div class="line"><span class="comment"># qconf -ah node3</span></div><div class="line"><span class="comment"># qconf -ah node4</span></div><div class="line"><span class="comment"># qconf -ah node5</span></div></pre></td></tr></table></figure><h3 id="master-æœåŠ¡å™¨æ­å»º-nfs-æœåŠ¡"><a href="#master-æœåŠ¡å™¨æ­å»º-nfs-æœåŠ¡" class="headerlink" title="master æœåŠ¡å™¨æ­å»º nfs æœåŠ¡"></a>master æœåŠ¡å™¨æ­å»º nfs æœåŠ¡</h3><p>æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å®‰è£…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum -y install nfs-utils</span></div></pre></td></tr></table></figure></p><p>masterèŠ‚ç‚¹æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/exports</span></div><div class="line">/data/sge 10.180.66.0/24(rw,sync)</div><div class="line"><span class="comment"># systemctl restart nfs</span></div></pre></td></tr></table></figure><h3 id="slave-èŠ‚ç‚¹æŒ‚è½½"><a href="#slave-èŠ‚ç‚¹æŒ‚è½½" class="headerlink" title="slave èŠ‚ç‚¹æŒ‚è½½"></a>slave èŠ‚ç‚¹æŒ‚è½½</h3><p>(node2,node3,node4,node5)æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir  /data/sge -pv</span></div><div class="line"><span class="comment"># mount -t nfs 10.180.66.11:/data/sge /data/sge/</span></div><div class="line"><span class="comment"># chown sgeadmin.sgeadmin /data/</span></div></pre></td></tr></table></figure><h3 id="slave-æœåŠ¡å™¨å®‰è£…sgeexecd"><a href="#slave-æœåŠ¡å™¨å®‰è£…sgeexecd" class="headerlink" title="slave æœåŠ¡å™¨å®‰è£…sgeexecd"></a>slave æœåŠ¡å™¨å®‰è£…sgeexecd</h3><p>(node2,node3,node4,node5) æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum -y install hwloc-devel</span></div><div class="line"><span class="comment"># useradd -u 495 -g 490 -r -m  -d /home/sgeadmin -s /bin/bash -c "SGE Admin" sgeadmin</span></div><div class="line"><span class="comment"># sed -i '/^%wheel/a\%sgeadmin       ALL=(ALL)       NOPASSWD: ALL' /etc/sudoers</span></div></pre></td></tr></table></figure><p>ç”Ÿæ•ˆç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo 'export SGE_ROOT=/data/sge' &gt;&gt; ~/.bashrc</span></div><div class="line"><span class="comment"># echo 'PATH=$PATH:/data/sge/bin/linux-x64/:/data/sge/bin/' &gt;&gt; ~/.bashrc</span></div><div class="line"><span class="comment"># echo 'export SGE_CELL=default' &gt;&gt; ~/.bashrc</span></div><div class="line"><span class="comment"># cp /data/sge/default/common/settings.sh /etc/profile.d/ -a</span></div><div class="line"><span class="comment"># source ~/.bashrc</span></div><div class="line"><span class="comment"># source /etc/profile</span></div></pre></td></tr></table></figure><p>è¿›è¡Œå®‰è£…ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ‰§è¡Œæ­¤è„šæœ¬<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim slave.sh</span></div><div class="line"><span class="comment"># cat slave.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">user=<span class="string">"sgeadmin"</span></div><div class="line">/usr/bin/expect &lt;&lt;-EOF</div><div class="line">spawn  ./install_execd</div><div class="line"></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect <span class="string">"*&gt;&gt;"</span></div><div class="line">send <span class="string">"</span></div><div class="line"><span class="string">"</span></div><div class="line">expect eof</div><div class="line">EOF</div><div class="line"><span class="comment"># sh slave.sh</span></div></pre></td></tr></table></figure></p><h2 id="å®Œæˆé›†ç¾¤æ­å»º"><a href="#å®Œæˆé›†ç¾¤æ­å»º" class="headerlink" title="å®Œæˆé›†ç¾¤æ­å»º"></a>å®Œæˆé›†ç¾¤æ­å»º</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># qhost</span></div><div class="line">HOSTNAME                ARCH         NCPU  LOAD  MEMTOT  MEMUSE  SWAPTO  SWAPUS</div><div class="line">-------------------------------------------------------------------------------</div><div class="line">global                  -               -     -       -       -       -       -</div><div class="line">node1                   linux-x64       1  0.01  968.3M  193.0M    2.0G   64.0K</div><div class="line">node2                   linux-x64       1  0.01  976.3M  151.0M    2.0G     0.0</div><div class="line">node3                   linux-x64       1  0.02  978.3M  152.2M    2.0G   84.0K</div><div class="line">node4                   linux-x64       1  0.02  976.3M  155.4M    2.0G     0.0</div><div class="line">node5                   linux-x64       1  0.01  978.3M  148.5M    2.0G   84.0K</div></pre></td></tr></table></figure><h1 id="sgeé›†ç¾¤çš„ä½¿ç”¨"><a href="#sgeé›†ç¾¤çš„ä½¿ç”¨" class="headerlink" title="sgeé›†ç¾¤çš„ä½¿ç”¨"></a>sgeé›†ç¾¤çš„ä½¿ç”¨</h1>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kvmå­¦ä¹ ç¬”è®°</title>
      <link href="/2019/08/28/kvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
      <url>/2019/08/28/kvm%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h1 id="kvm-å­¦ä¹ ç¬”è®°"><a href="#kvm-å­¦ä¹ ç¬”è®°" class="headerlink" title="kvm å­¦ä¹ ç¬”è®°"></a>kvm å­¦ä¹ ç¬”è®°</h1><p><img src="/images/kvm_study.png" alt=""></p><h2 id="kvmç›¸å…³çŸ¥è¯†æ¢³ç†"><a href="#kvmç›¸å…³çŸ¥è¯†æ¢³ç†" class="headerlink" title="kvmç›¸å…³çŸ¥è¯†æ¢³ç†"></a>kvmç›¸å…³çŸ¥è¯†æ¢³ç†</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">KVM: kernel-based Virtual Machine, Qumranet å…¬å¸ï¼Œä¾èµ–äºHVM: Intel VT-x, ADM  ADM-V:</div><div class="line">KVMæ¨¡å—è½½å…¥åçš„ç³»ç»Ÿçš„è¿è¡Œæ¨¡å¼:</div><div class="line">    å†…æ ¸æ¨¡å¼: GuestOSæ‰§è¡ŒI/Oç±»æ“ä½œï¼Œæˆ–å…¶å®ƒçš„ç‰¹æ®ŠæŒ‡ä»¤çš„æ“ä½œï¼šç§°ä½œâ€œæ¥å®¾-å†…æ ¸â€æ¨¡å¼;</div><div class="line">    ç”¨æˆ·æ¨¡å¼: ä»£è¡¨GuestOSè¯·æ±‚I/Oç±»æ“ä½œï¼Œå®¿ä¸»æœºç”¨æˆ·æ¨¡å¼;</div><div class="line">    æ¥å®¾æ¨¡å¼: GuestOSçš„éI/Oç±»æ“ä½œï¼›äº‹å®ä¸Šï¼Œå®ƒè¢«ç§°ä¸ºâ€œæ¥å®¾-ç”¨æˆ·â€æ¨¡å¼ã€‚</div><div class="line">    kvm hypervisor:</div><div class="line">KVMçš„ç»„ä»¶:</div><div class="line">    /dev/kvm: å·¥ä½œäºhypervisor,åœ¨ç”¨æˆ·ç©ºé—´ï¼Œå¯é€šè¿‡ioctl()ç³»ç»Ÿè°ƒç”¨æ¥å®ŒæˆVMåˆ›å»ºã€å¯åŠ¨ç®¡ç†åŠŸèƒ½ï¼›å®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ï¼ŒåŠŸèƒ½: åˆ›å»ºVMã€ä¸ºVMåˆ†é…å†…å­˜ã€è¯»å†™VCPUçš„å¯„å­˜å™¨ã€å‘VCPUæ³¨å…¥ä¸­æ–­ã€è¿è¡ŒVCPUç­‰ç­‰;</div><div class="line">    qemuè¿›ç¨‹: å·¥ä½œäºç”¨æˆ·ç©ºé—´ï¼Œä¸»è¦ç”¨äºå®ç°æ¨¡æ‹ŸPCæœºçš„IOè®¾å¤‡;</div><div class="line">KVMç‰¹æ€§:</div><div class="line">    å†…å­˜ç®¡ç†: </div><div class="line">    å°†åˆ†é…ç»™VMçš„å†…å­˜äº¤æ¢è‡³SWAP;</div><div class="line">    æ”¯æŒä½¿ç”¨Huge Page;</div><div class="line">    æ”¯æŒä½¿ç”¨Intel EPTæˆ–AMD RVIæŠ€æœ¯å®Œæˆå†…å­˜åœ°å€æ˜ å°„; GVA--&gt; GPA --&gt;HPA</div><div class="line">    æ”¯æŒKSM(Kernel Same-page Merging)</div><div class="line">ç¡¬ä»¶æ”¯æŒ: </div><div class="line">    å–å†³äºLinuxå†…æ ¸</div><div class="line">å­˜å‚¨:</div><div class="line">    æœ¬åœ°å­˜å‚¨:</div><div class="line">    ç½‘ç»œé™„åŠ å­˜å‚¨:</div><div class="line">    å­˜å‚¨åŒºåŸŸåç½‘ç»œ</div><div class="line">    åˆ†å¸ƒå¼å­˜å‚¨: ä¾‹å¦‚GlustFS</div><div class="line">å®æ—¶è¿ç§»:</div><div class="line">    å®æ—¶è¿ç§»:</div><div class="line">    æ”¯æŒçš„GuestOS:</div><div class="line">        Linux, Windows, OpenBSD, FreeBSD, OpenSolaris;</div><div class="line">    è®¾å¤‡é©±åŠ¨ï¼š</div><div class="line">        IOè®¾å¤‡çš„å®Œå…¨è™šæ‹ŸåŒ–: æ¨¡æ‹Ÿç¡¬ä»¶</div><div class="line">        IOè®¾å¤‡çš„åŠè™šæ‹ŸåŒ–: åœ¨GuestOSä¸­å®‰è£…é©±åŠ¨: virtio </div><div class="line">            virtio-blk, virtio-net, virtio-pci,virtio-console, virtio-ballon</div><div class="line">KVMå±€é™æ€§:</div><div class="line">    ä¸€èˆ¬å±€é™æ€§:</div><div class="line">             CPU overcommit</div><div class="line">            æ—¶é—´è®°å½•éš¾ä»¥ç²¾ç¡®ï¼Œä¾èµ–äºæ—¶é—´åŒæ­¥æœºåˆ¶</div><div class="line">    MACåœ°å€:</div><div class="line">            VMé‡ç‰¹åˆ«å¤§æ—¶ï¼Œå­˜åœ¨å†²çªçš„å¯èƒ½æ€§;</div><div class="line">            å®æ—¶è¿ç§»:</div><div class="line">            æ€§èƒ½å±€é™æ€§:</div><div class="line">KVMçš„å·¥å…·æ ˆ</div><div class="line">    qemu:</div><div class="line">        qemu-kvm</div><div class="line">        qemu-img</div><div class="line">    libvirt</div><div class="line">        GUI: virt-manager, virt-viewer</div><div class="line">        CLI: virt-install, virsh </div><div class="line">    QEMUä¸»è¦ç”¨åˆ°ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</div><div class="line">        å¤„ç†å™¨æ¨¡æ‹Ÿå™¨</div><div class="line">        ä»¿çœŸIOè®¾å¤‡</div><div class="line">        å…³è”æ¨¡æ‹Ÿçš„è®¾å¤‡è‡³çœŸå®è®¾å¤‡;</div><div class="line">        è°ƒè¯•å™¨</div><div class="line">        ä¸æ¨¡æ‹Ÿå™¨äº¤äº’çš„ç”¨æˆ·æ¥å£</div></pre></td></tr></table></figure><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>1ã€ç¡®ä¿CPUæ”¯æŒHVM<br>    <code># grep -E --color=auto &quot;(vmx|svm)&quot; /proc/cpuinfo</code><br>2ã€è£…è½½æ¨¡å—<br>    <code># modeprobe kvm</code><br>    <code># modeprobe kvm-intel</code><br>3ã€éªŒè¯ <code>/dev/kvm</code></p><h2 id="ç®¡ç†å·¥å…·æ ˆ"><a href="#ç®¡ç†å·¥å…·æ ˆ" class="headerlink" title="ç®¡ç†å·¥å…·æ ˆ"></a>ç®¡ç†å·¥å…·æ ˆ</h2><p>qemu-kvm<br>libvirt<br>ç®¡ç†kvmè™šæ‹Ÿçš„æ–¹æ¡ˆ:<br>    <code>qemu: /usr/libexec/</code><br>    å®‰è£…å·¥å…·:<br>    <code>libvirt: virt-install virt-manager</code><br>    ç®¡ç†å·¥å…·:<br>    <code>virsh virt-manager virt-viewer  VM Platform</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># yum install qemu-kvm</div><div class="line"># ln -sv /usr/libexec/qemu-kvm  /usr/bin/</div><div class="line">å‘½ä»¤é€‰é¡¹ </div><div class="line">    æ ‡å‡†é€‰é¡¹:</div><div class="line">    æ˜¾ç¤ºé€‰é¡¹:</div><div class="line">    å—è®¾å¤‡é€‰é¡¹:</div><div class="line">    i386å¹³å°ä¸“ç”¨é€‰é¡¹:</div><div class="line">    å­—ç¬¦è®¾å¤‡é€‰é¡¹:</div><div class="line">    è“ç‰™è®¾å¤‡é€‰é¡¹:</div><div class="line">    Linux å¯åŠ¨ä¸“ç”¨é€‰é¡¹:</div><div class="line">    è°ƒè¯•/ä¸“å®¶æ¨¡å¼é€‰é¡¹:</div></pre></td></tr></table></figure></p><hr><p>è¡¥å……èµ„æ–™: KVMå†…å­˜ç®¡ç†<br>KVMç»§æ‰¿äº†Linuxç³»ç»Ÿç®¡ç†å†…å­˜çš„è¯¸å¤šç‰¹æ€§ï¼Œæ¯”å¦‚ï¼Œåˆ†é…ç»™è™šæ‹Ÿä½¿ç”¨çš„å†…å­˜å¯ä»¥è¢«äº¤æ¢è‡³äº¤æ¢ç©ºé—´ã€èƒ½å¤Ÿä½¿ç”¨å¤§å†…å­˜é¡µä»¥å®ç°æ›´çš„å¥½çš„æ€§èƒ½ï¼Œä»¥åŠå¯¹NUMAçš„æ”¯æŒèƒ½å¤Ÿè®©è™šæ‹Ÿæœºé«˜æ•ˆè®¿é—®æ›´å¤§çš„å†…å­˜ç©ºé—´ç­‰ã€‚  </p><p>KVMåŸºäºIntelçš„EPT(Extended Page Table) æˆ–AMDçš„ RVI(Rapid Virtualization Indexing) æŠ€æœ¯å¯ä»¥æ”¯æŒæ›´æ–°çš„å†…å­˜è™šæ‹ŸåŠŸèƒ½ï¼Œè¿™å¯ä»¥é™ä½CPUçš„å ç”¨ç‡ï¼Œå¹¶æä¾›è¾ƒå¥½çš„ååé‡ã€‚</p><p>æ­¤å¤–ï¼ŒKVMè¿˜å€ŸåŠ©äºKSM(kernel Same-page Merging) è¿™ä¸ªå†…æ ¸ç‰¹æ€§å®ç°äº†å†…å­˜é¡µé¢å…±äº«ï¼ŒKSMé€šè¿‡æ‰«ææ¯ä¸ªè™šæ‹Ÿæœºçš„å†…å­˜æŸ¥æ‰¾å„è™šæ‹Ÿæœºé—´ç›¸åŒçš„é¡µé¢ï¼Œå¹¶å°†è¿™äº›å†…å­˜é¡µåˆå¹¶ä¸ºä¸€ä¸ªè¢«å„ç›¸å…³è™šæ‹Ÿæœºå…±äº«çš„å•ç‹¬é¡µé¢ã€‚åœ¨æŸè™šæ‹Ÿæœºè¯•å›¾ä¿®æ”¹æ­¤é¡µé¢ä¸­çš„æ•°æ®æ—¶ï¼ŒKSMä¼šé‡æ–°ä¸ºå…¶æä¾› ä¸€ä¸ªæ–°çš„é¡µé¢å‰¯æœ¬ã€‚å®è·µä¸­ï¼Œè¿è¡ŒäºåŒä¸€ä¸ªç‰©ç†ä¸»æœºçš„å…·æœ‰ç›¸åŒGuestOSçš„è™šæ‹Ÿæœºä¹‹é—´å‡ºç°ç›¸åŒå†…å­˜é¡µé¢çš„æ¦‚ç‡æ˜¯å¾ˆé«˜çš„ï¼Œæ¯”å¦‚å…±äº«åº“ï¼Œå†…æ ¸æˆ–å…¶å®ƒå†…å­˜å¯¹è±¡ç­‰éƒ½æœ‰å¯èƒ½è¡¨ç°ä¸ºæœºåŒçš„é¡µé¢ï¼Œå› æ­¤ï¼ŒKSMæŠ€æœ¯å¯ä»¥é™ä½å†…å­˜å ç”¨è¿›è€Œæé«˜æ•´ä½“æ€§èƒ½ã€‚</p><hr><p>è¡¥å……èµ„æ–™:<br>    VMM: å¯¹IOçš„é©±åŠ¨æœ‰ä¸‰ç§æ¨¡å¼:<br>        è‡ªä¸»VMM: VMM è‡ªè¡Œæä¾›é©±åŠ¨å’Œæ§åˆ¶å°;<br>        æ··åˆVMM: å€ŸåŠ©äºOSæä¾›é©±åŠ¨;<br>            ä¾èµ–äºå¤–éƒ¨OSå®ç°ç‰¹æƒåŸŸ<br>            è‡ªæˆ‘æä¾›ç‰¹æƒåŸŸ<br>        å¯„å®¿å¼VMM:<br>    IOè™šæ‹ŸåŒ–æ¨¡å‹:<br>        æ¨¡æ‹Ÿ<br>        åŠè™šæ‹ŸåŒ–<br>        é€ä¼ </p><p>KVMï¼šhvm<br>    kvm,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">    # modinfo kvm</div><div class="line">    # lsmod | grep kvm</div><div class="line">kvm_intel             170086  0</div><div class="line">kvm                   566340  1 kvm_intel</div><div class="line">irqbypass              13503  1 kvm</div></pre></td></tr></table></figure><h2 id="å¯åŠ¨ä½¿ç”¨å¾®ç¼©ç‰ˆLinux"><a href="#å¯åŠ¨ä½¿ç”¨å¾®ç¼©ç‰ˆLinux" class="headerlink" title="å¯åŠ¨ä½¿ç”¨å¾®ç¼©ç‰ˆLinux"></a>å¯åŠ¨ä½¿ç”¨å¾®ç¼©ç‰ˆLinux</h2><p>cirros project : ä¸ºcloud ç¯å¢ƒæµ‹è¯•vmæä¾›çš„å¾®ç¼©ç‰ˆLinux:<br>å¯åŠ¨ç¬¬ä¸€ä¸ªè™šæ‹Ÿæœº:</p><p><a href="https://launchpad.net/cirros" target="_blank" rel="external">cirros</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -m 128 -smp 2 -name &quot;test&quot; -hda /images/kvm/cirros-0.3.4-x86_64-disk.img</div><div class="line">VNC server running on `::1:5900&apos;</div></pre></td></tr></table></figure></p><p>å®‰è£…tigervnc </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum -y install tigervnc</div></pre></td></tr></table></figure><p><img src="/images/qemu-kvm-cirros.png" alt=""></p><p>ç”¨-driveæŒ‡å®šç£ç›˜æ˜ åƒæ–‡ä»¶ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#   qemu-kvm -m 128 -name test -smp 2 -drive  file=/images/kvm/cirros-0.3.4-x86_64-disk.img,if=virtio,media=disk,cache=writeback,fromat=qcow2</div></pre></td></tr></table></figure><p>é€šè¿‡cdromå¯åŠ¨winxpçš„å®‰è£…:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -name winxp -smp 4, sockets=1,cores=2,threads=2 -m 512 -drive file=/images/kvm/winxp.img,if=ide,media=disk,cache=writeback,format=qcow2 -drive file=/root/winxp_ghost.iso,media=cdrom</div></pre></td></tr></table></figure><p>æŒ‡å®šä½¿ç”¨æ ¼æ‹‰ç½‘ç»œæ¥å£:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -m 128 -name test -smp 2 -drive file= /images/kvm/cirros-0.3.4-x86_64-disk.img</div><div class="line">,if=virtio,media=disk,cache=writeback,format=qcow2 -net nic -net tap,script=/etc/if-up,downscript=no -nographic</div></pre></td></tr></table></figure><hr><p>qemu-kvmç®¡ç†KVMè™šæ‹Ÿæœº<br>Qemuæ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„å¼€æºè®¡ç®—æœºä»¿çœŸå™¨å’Œè™šæ‹Ÿæœºã€‚å½“ä½œä¸ºä»¿çœŸå™¨æ—¶ï¼Œå¯ä»¥åœ¨ä¸€ç§æ¶æ„(å¦‚PCæœº)ä¸‹è¿è¡Œå¦ä¸€ä¸ªæ¶æ„(å¦‚ARM)ä¸‹çš„æ“ä½œç³»ç»Ÿå’Œç¨‹åºï¼Œè€Œé€šè¿‡åŠ¨æ€è½¬åŒ–ï¼Œå…¶å¯ä»¥è·å–å¾ˆé«˜çš„è¿è¡Œæ•ˆç‡ã€‚å½“ä½œä¸ºä¸€ä¸ªè™šæ‹Ÿæœºæ—¶ï¼Œqemuå¯ä»¥é€šè¿‡ç›´æ¥ä½¿ç”¨çœŸæœºçš„ç³»ç»Ÿèµ„æºï¼Œè®©è™šæ‹Ÿç³»ç»Ÿèƒ½å¤Ÿè·å¾—æ¥è¿‘äºç‰©ç†æœºçš„æ€§èƒ½è¡¨ç°ã€‚qemuæ”¯æŒxenæˆ–è€…kvmæ¨¡å¼ä¸‹çš„è™šæ‹ŸåŒ–ã€‚å½“ç”¨kvmæ—¶ï¼Œqemuå¯ä»¥è™šæ‹Ÿx86ã€æœåŠ¡å™¨å’ŒåµŒå…¥å¼powerpcï¼Œä»¥åŠs390ç³»ç»Ÿã€‚</p><p>QEMU å½“è¿è¡Œä¸ä¸»æœºæ¶æ„ç›¸åŒçš„ç›®æ ‡æ¶æ„æ—¶å¯ä»¥ä½¿ç”¨KVMä¾‹å¦‚ï¼Œå½“åœ¨ä¸€ä¸ªx86å…¼å®¹å¤„ç†å™¨ä¸Šè¿è¡Œ qemu-system-x86æ—¶ï¼Œå¯ä»¥åˆ©KVMåŠ é€Ÿä¸€ä¸ºå®¿ä¸»æœºå’Œå®¢æˆ·æœºæä¾›æ›´å¥½çš„æ€§èƒ½ã€‚</p><p>Qemu æœ‰å¦‚ä¸‹å‡ ä¸ªéƒ¨ç»„æˆ:</p><ul><li>å¤„ç†å™¨æ¨¡æ‹Ÿå™¨(x86ã€PowerPCå’ŒSparc)</li><li>ä»¿çœŸè®¾å¤‡(æ˜¾å¡ã€ç½‘å¡ã€ç¡¬ç›˜ã€é¼ æ ‡ç­‰)</li><li>ç”¨äºå°†ä»¿çœŸè®¾å¤‡è¿æ¥è‡³ä¸»æœºè®¾å¤‡(çœŸå®è®¾å¤‡)çš„é€šç”¨è®¾å¤‡;</li><li>è™šæ‹Ÿæœºçš„æè¿°ä¿¡æ¯;</li><li>è°ƒè¯•å™¨ï¼›</li><li>ä¸æ¨¡æ‹Ÿå™¨äº¤äº’çš„ç”¨æˆ·æ¥å£ã€‚</li></ul><p>ä½¿ç”¨qemu-kvmå®‰è£…Guest<br>åŸºäºlibvirt çš„å·¥å…·å¦‚virt-managerå’Œvirt-installæä¾›äº†éå¸¸ä¾¿æ·çš„è™šæ‹Ÿæœºç®¡ç†æ¥å£ï¼Œä½†å®ƒä»¬äº‹å®ä¸Šå·²ç»ç¬¬äºŒæ¬¡å¼€å‘ååˆå°è£…äº†qemu-kvmçš„å·¥å…·ã€‚å› æ­¤ï¼Œç›´æ¥ä½¿ç”¨qemu-vkmå‘½ä»¤ä¹Ÿèƒ½å¤Ÿå®Œæˆæ­¤å‰çš„ä»»åŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -m 128 -cpu host -smp 2 -name &quot;test&quot; -drive file=/images/kvm/cirros-0.3.4-x86_64-disk.img,if=virtio,media=disk,format=qcow2,cache=writeback</div><div class="line"># qemu-img create -o size=20G,preallocation=metadata -f qcow2 /images/winxp.qcow2</div><div class="line"># qemu-kvm -m 512 -smp 2 -cpu  host -drive file=/images/windows/winxp.qcow2,media=disk -drive file=/root/winxp_ghost.iso,media=cdrom --boot order=dc, once=d</div></pre></td></tr></table></figure><p>æŒ‡å®švnc æ¡Œé¢ï¼Œå¦‚æŒ‡å®šæ¡Œé¢å·ä¸º1 åˆ™å¯ç”¨ç«¯å£ä¸º5901, è‹¥æŒ‡å®šæ¡Œé¢å·ä¸º0ï¼Œåˆ™å¯ç”¨ç«¯å£ä¸º5900</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -m 128 -cpu host -smp 2 -name &quot;test&quot; -drive file=/images/kvm/cirros-0.3.4-x86_64-disk.img,if=virtio,media=disk,format=qcow2,cache=writeback -vnc 0.0.0.0:1</div></pre></td></tr></table></figure><p><img src="/images/qemu-kvm-vnc-all-port.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">qemu-kvmå‘½ä»¤</div><div class="line"></div><div class="line">åœ¨RHEL6ä¸Šï¼Œqemu-kvmä½äº/usr/libexecç›®å½•ä¸­ã€‚ç”±äºæ­¤ç›®å½•ä¸å±äºPATHç¯å¢ƒå˜é‡ï¼Œæ•…æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œè¿™æ ·ä¹Ÿé˜»æ­¢äº†å¯ä»¥ç›´æ¥ä½¿ç”¨qemuä½œä¸ºåˆ›å»ºå¹¶ç®¡ç†è™šæ‹Ÿæœºã€‚å¦‚è‹¥æƒ³ä½¿ç”¨qemuè™šæ‹Ÿæœºï¼Œå¯ä»¥é€šè¿‡å°†/usr/libexec/qemu-kvmé“¾æ¥ä¸º/usr/bin/qemuå®ç°ã€‚</div><div class="line"></div><div class="line"># ln  -sv  /usr/lib/exec/qemu-kvm  /usr/bin/qemu-kvm</div><div class="line"></div><div class="line">qemu-kvmå‘½ä»¤ä½¿ç”¨æ ¼å¼ä¸ºâ€œqemu-kvm  [options]  [disk_image]â€ï¼Œå…¶é€‰é¡¹éå¸¸å¤šï¼Œä¸è¿‡ï¼Œå¤§è‡´å¯åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ã€‚</div><div class="line"></div><div class="line">ğŸ‘‰ğŸ¾æ ‡å‡†é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾USBé€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾æ˜¾ç¤ºé€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾i386å¹³å°ä¸“ç”¨é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾ç½‘ç»œé€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾å­—ç¬¦è®¾å¤‡é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾è“ç‰™ç›¸å…³é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾Linuxç³»ç»Ÿå¼•å¯¼ä¸“ç”¨é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾è°ƒè¯•/ä¸“å®¶æ¨¡å¼é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾PowerPCä¸“ç”¨é€‰é¡¹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾Sparc32ä¸“ç”¨é€‰é¡¹ï¼›</div><div class="line"></div><div class="line">è€ƒè™‘åˆ°ç¯‡å¹…åŠä½¿ç”¨éœ€è¦ï¼Œè¿™é‡Œä»‹ç»çš„é€‰é¡¹ä¸»è¦æ¶‰åŠåˆ°æ ‡å‡†é€‰é¡¹ã€æ˜¾ç¤ºé€‰é¡¹ã€i386å¹³å°ä¸“ç”¨é€‰é¡¹åŠLinuxç³»ç»Ÿå¼•å¯¼ä¸“ç”¨é€‰é¡¹ç­‰ç›¸å…³çš„é€‰é¡¹ã€‚</div><div class="line"></div><div class="line">qemu-kvmçš„æ ‡å‡†é€‰é¡¹</div><div class="line"></div><div class="line">qemu-kvmçš„æ ‡å‡†é€‰é¡¹ä¸»è¦æ¶‰åŠæŒ‡å®šä¸»æœºç±»å‹ã€CPUæ¨¡å¼ã€NUMAã€è½¯é©±è®¾å¤‡ã€å…‰é©±è®¾å¤‡åŠç¡¬ä»¶è®¾å¤‡ç­‰ã€‚</div><div class="line">ğŸ‘‰ğŸ¾-name nameï¼šè®¾å®šè™šæ‹Ÿæœºåç§°ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-M machineï¼šæŒ‡å®šè¦æ¨¡æ‹Ÿçš„ä¸»æœºç±»å‹ï¼Œå¦‚Standard PCã€ISA-only PCæˆ–Intel-Macç­‰ï¼Œå¯ä»¥ä½¿ç”¨â€œqemu-kvm -M ?â€è·å–æ‰€æ”¯æŒçš„æ‰€æœ‰ç±»å‹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-m megsï¼šè®¾å®šè™šæ‹Ÿæœºçš„RAMå¤§å°ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-cpu modelï¼šè®¾å®šCPUæ¨¡å‹ï¼Œå¦‚coreduoã€qemu64ç­‰ï¼Œå¯ä»¥ä½¿ç”¨â€œqemu-kvm -cpu ?â€è·å–æ‰€æ”¯æŒçš„æ‰€æœ‰æ¨¡å‹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-smp n[,cores=cores][,threads=threads][,sockets=sockets][,maxcpus=maxcpus]ï¼šè®¾å®šæ¨¡æ‹Ÿçš„SMPæ¶æ„ä¸­CPUçš„ä¸ªæ•°ç­‰ã€æ¯ä¸ªCPUçš„æ ¸å¿ƒæ•°åŠCPUçš„socketæ•°ç›®ç­‰ï¼›PCæœºä¸Šæœ€å¤šå¯ä»¥æ¨¡æ‹Ÿ255é¢—CPUï¼›maxcpusç”¨äºæŒ‡å®šçƒ­æ’å…¥çš„CPUä¸ªæ•°ä¸Šé™ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-numa optsï¼šæŒ‡å®šæ¨¡æ‹Ÿå¤šèŠ‚ç‚¹çš„numaè®¾å¤‡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-fda file</div><div class="line">ğŸ‘‰ğŸ¾-fdb fileï¼šä½¿ç”¨æŒ‡å®šæ–‡ä»¶(file)ä½œä¸ºè½¯ç›˜é•œåƒï¼Œfileä¸º/dev/fd0è¡¨ç¤ºä½¿ç”¨ç‰©ç†è½¯é©±ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-hda file</div><div class="line">ğŸ‘‰ğŸ¾-hdb file</div><div class="line">ğŸ‘‰ğŸ¾-hdc file</div><div class="line">ğŸ‘‰ğŸ¾-hdd fileï¼šä½¿ç”¨æŒ‡å®šfileä½œä¸ºç¡¬ç›˜é•œåƒï¼›</div><div class="line">ğŸ‘‰ğŸ¾-cdrom fileï¼šä½¿ç”¨æŒ‡å®šfileä½œä¸ºCD-ROMé•œåƒï¼Œéœ€è¦æ³¨æ„çš„æ˜¯-cdromå’Œ-hdcä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼›å°†fileæŒ‡å®šä¸º/dev/cdromå¯ä»¥ç›´æ¥ä½¿ç”¨ç‰©ç†å…‰é©±ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-drive option[,option[,option[,...]]]ï¼šå®šä¹‰ä¸€ä¸ªç¡¬ç›˜è®¾å¤‡ï¼›å¯ç”¨å­é€‰é¡¹æœ‰å¾ˆå¤šã€‚</div><div class="line">ğŸ‘‰ğŸ¾file=/path/to/somefileï¼šç¡¬ä»¶æ˜ åƒæ–‡ä»¶è·¯å¾„ï¼›</div><div class="line">ğŸ‘‰ğŸ¾if=interfaceï¼šæŒ‡å®šç¡¬ç›˜è®¾å¤‡æ‰€è¿æ¥çš„æ¥å£ç±»å‹ï¼Œå³æ§åˆ¶å™¨ç±»å‹ï¼Œå¦‚ideã€scsiã€sdã€mtdã€floppyã€pflashåŠvirtioç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾index=indexï¼šè®¾å®šåŒä¸€ç§æ§åˆ¶å™¨ç±»å‹ä¸­ä¸åŒè®¾å¤‡çš„ç´¢å¼•å·ï¼Œå³æ ‡è¯†å·ï¼›</div><div class="line">ğŸ‘‰ğŸ¾media=mediaï¼šå®šä¹‰ä»‹è´¨ç±»å‹ä¸ºç¡¬ç›˜(disk)è¿˜æ˜¯å…‰ç›˜(cdrom)ï¼›</div><div class="line">ğŸ‘‰ğŸ¾snapshot=snapshotï¼šæŒ‡å®šå½“å‰ç¡¬ç›˜è®¾å¤‡æ˜¯å¦æ”¯æŒå¿«ç…§åŠŸèƒ½ï¼šonæˆ–offï¼›</div><div class="line">ğŸ‘‰ğŸ¾cache=cacheï¼šå®šä¹‰å¦‚ä½•ä½¿ç”¨ç‰©ç†æœºç¼“å­˜æ¥è®¿é—®å—æ•°æ®ï¼Œå…¶å¯ç”¨å€¼æœ‰noneã€writebackã€unsafeå’Œwritethroughå››ä¸ªï¼›</div><div class="line">ğŸ‘‰ğŸ¾format=formatï¼šæŒ‡å®šæ˜ åƒæ–‡ä»¶çš„æ ¼å¼ï¼Œå…·ä½“æ ¼å¼å¯å‚è§qemu-imgå‘½ä»¤ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-boot [order=drives][,once=drives][,menu=on|off]ï¼šå®šä¹‰å¯åŠ¨è®¾å¤‡çš„å¼•å¯¼æ¬¡åºï¼Œæ¯ç§è®¾å¤‡ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦è¡¨ç¤ºï¼›ä¸åŒçš„æ¶æ„æ‰€æ”¯æŒçš„è®¾å¤‡åŠå…¶è¡¨ç¤ºå­—ç¬¦ä¸å°½ç›¸åŒï¼Œåœ¨x86 PCæ¶æ„ä¸Šï¼Œaã€bè¡¨ç¤ºè½¯é©±ã€cè¡¨ç¤ºç¬¬ä¸€å—ç¡¬ç›˜ï¼Œdè¡¨ç¤ºç¬¬ä¸€ä¸ªå…‰é©±è®¾å¤‡ï¼Œn-pè¡¨ç¤ºç½‘ç»œé€‚é…å™¨ï¼›é»˜è®¤ä¸ºç¡¬ç›˜è®¾å¤‡ï¼›</div><div class="line">-boot order=dc,once=d</div><div class="line"></div><div class="line">qemu-kvmçš„æ˜¾ç¤ºé€‰é¡¹</div><div class="line"></div><div class="line">æ˜¾ç¤ºé€‰é¡¹ç”¨äºå®šä¹‰è™šæ‹Ÿæœºå¯åŠ¨åçš„æ˜¾ç¤ºæ¥å£ç›¸å…³ç±»å‹åŠå±æ€§ç­‰ã€‚</div><div class="line"></div><div class="line">ğŸ‘‰ğŸ¾-nographicï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œqemuä½¿ç”¨SDLæ¥æ˜¾ç¤ºVGAè¾“å‡ºï¼›è€Œæ­¤é€‰é¡¹ç”¨äºç¦æ­¢å›¾å½¢æ¥å£ï¼Œæ­¤æ—¶,qemuç±»ä¼¼ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºï¼Œå…¶ä»¿çœŸä¸²å£è®¾å¤‡å°†è¢«é‡å®šå‘åˆ°æ§åˆ¶å°ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-cursesï¼šç¦æ­¢å›¾å½¢æ¥å£ï¼Œå¹¶ä½¿ç”¨curses/ncursesä½œä¸ºäº¤äº’æ¥å£ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-alt-grabï¼šä½¿ç”¨Ctrl+Alt+Shiftç»„åˆé”®é‡Šæ”¾é¼ æ ‡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-ctrl-grabï¼šä½¿ç”¨å³Ctrlé”®é‡Šæ”¾é¼ æ ‡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-sdlï¼šå¯ç”¨SDLï¼›</div><div class="line">ğŸ‘‰ğŸ¾-spice option[,option[,...]]ï¼šå¯ç”¨spiceè¿œç¨‹æ¡Œé¢åè®®ï¼›å…¶æœ‰è®¸å¤šå­é€‰é¡¹ï¼Œå…·ä½“è¯·å‚ç…§qemu-kvmçš„æ‰‹å†Œï¼›</div><div class="line">ğŸ‘‰ğŸ¾-vga typeï¼šæŒ‡å®šè¦ä»¿çœŸçš„VGAæ¥å£ç±»å‹ï¼Œå¸¸è§ç±»å‹æœ‰ï¼š</div><div class="line">ğŸ‘‰ğŸ¾cirrusï¼šCirrus Logic GD5446æ˜¾ç¤ºå¡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾stdï¼šå¸¦æœ‰Bochs VBIæ‰©å±•çš„æ ‡å‡†VGAæ˜¾ç¤ºå¡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾vmwareï¼šVMWare SVGA-IIå…¼å®¹çš„æ˜¾ç¤ºé€‚é…å™¨ï¼›</div><div class="line">ğŸ‘‰ğŸ¾qxlï¼šQXLåŠè™šæ‹ŸåŒ–æ˜¾ç¤ºå¡ï¼›ä¸VGAå…¼å®¹ï¼›åœ¨Guestä¸­å®‰è£…qxlé©±åŠ¨åèƒ½ä»¥å¾ˆå¥½çš„æ–¹å¼å·¥ä½œï¼Œåœ¨ä½¿ç”¨spiceåè®®æ—¶æ¨èä½¿ç”¨æ­¤ç±»å‹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾noneï¼šç¦ç”¨VGAå¡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-vnc display[,option[,option[,...]]]ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œqemuä½¿ç”¨SDLæ˜¾ç¤ºVGAè¾“å‡ºï¼›ä½¿ç”¨-vncé€‰é¡¹ï¼Œå¯ä»¥è®©qemuç›‘å¬åœ¨VNCä¸Šï¼Œå¹¶å°†VGAè¾“å‡ºé‡å®šå‘è‡³VNCä¼šè¯ï¼›ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œå¿…é¡»ä½¿ç”¨-ké€‰é¡¹æŒ‡å®šé”®ç›˜å¸ƒå±€ç±»å‹ï¼›å…¶æœ‰è®¸å¤šå­é€‰é¡¹ï¼Œå…·ä½“è¯·å‚ç…§qemu-kvmçš„æ‰‹å†Œï¼›</div><div class="line"></div><div class="line">display:</div><div class="line">ï¼ˆ1ï¼‰host:N</div><div class="line">172.16.100.7:1, ç›‘å¬äº172.16.100.7ä¸»çš„5900+Nçš„ç«¯å£ä¸Š</div><div class="line">(2) unix:/path/to/socket_file</div><div class="line">(3) none</div><div class="line">options:</div><div class="line">password: è¿æ¥æ—¶éœ€è¦éªŒæ­£å¯†ç ï¼›è®¾å®šå¯†ç é€šè¿‡monitoræ¥å£ä½¿ç”¨change</div><div class="line">reverse: â€œåå‘â€è¿æ¥è‡³æŸå¤„äºç›‘å¬çŠ¶æ€çš„vncviewä¸Šï¼›</div><div class="line">-monitor stdioï¼šè¡¨ç¤ºåœ¨æ ‡å‡†è¾“å…¥è¾“å‡ºä¸Šæ˜¾ç¤ºmonitorç•Œé¢</div><div class="line">-nographic</div><div class="line">Ctrl-a, c: åœ¨consoleå’Œmonitorä¹‹é—´åˆ‡æ¢</div><div class="line">Ctrl-a, h: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</div><div class="line">SDL: Simple Directmedia Layer</div><div class="line">VNC: Virtual Network Computingï¼ŒåŸºäºRFB</div></pre></td></tr></table></figure><p><code># rpm -ql bridge-utils</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># brctl addbr br0</div><div class="line"># brctl stp br0 off</div><div class="line"># brctl delbr br0</div><div class="line"># brctl show</div><div class="line"># ip link set dev br0 down</div><div class="line"># ip link set dev br0 up</div><div class="line"># ip link show</div><div class="line"># ä¸´æ—¶ç”Ÿæ•ˆ</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># nmtui</div><div class="line"># nmcli</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -net nic,model=?</div><div class="line">qemu: Supported NIC models: ne2k_pci,i82551,i82557b,i82559er,rtl8139,e1000,pcnet,virtio</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ç½‘ç»œå±æ€§ç›¸å…³é€‰é¡¹</div><div class="line"></div><div class="line">ç½‘ç»œå±æ€§ç›¸å…³é€‰é¡¹ç”¨äºå®šä¹‰ç½‘ç»œè®¾å¤‡æ¥å£ç±»å‹åŠå…¶ç›¸å…³çš„å„å±æ€§ç­‰ä¿¡æ¯ã€‚è¿™é‡Œåªä»‹ç»nicã€tapå’Œuserä¸‰ç§ç±»å‹ç½‘ç»œæ¥å£çš„å±æ€§ï¼Œå…¶å®ƒç±»å‹è¯·å‚ç…§qemu-kvmæ‰‹å†Œã€‚</div><div class="line"></div><div class="line">ğŸ‘‰ğŸ¾-net nic[,vlan=n][,macaddr=mac][,model=type][,name=name][,addr=addr][,vectors=v]ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘å¡è®¾å¤‡å¹¶è¿æ¥è‡³vlan nä¸­ï¼›PCæ¶æ„ä¸Šé»˜è®¤çš„NICä¸ºe1000ï¼Œmacaddrç”¨äºä¸ºå…¶æŒ‡å®šMACåœ°å€ï¼Œnameç”¨äºæŒ‡å®šä¸€ä¸ªåœ¨ç›‘æ§æ—¶æ˜¾ç¤ºçš„ç½‘ä¸Šè®¾å¤‡åç§°ï¼›emuå¯ä»¥æ¨¡æ‹Ÿå¤šä¸ªç±»å‹çš„ç½‘å¡è®¾å¤‡ï¼Œå¦‚virtioã€i82551ã€i82557bã€i82559erã€ne2k_isaã€pcnetã€rtl8139ã€e1000ã€smc91c111ã€lanceåŠmcf_fecç­‰ï¼›ä¸è¿‡ï¼Œä¸åŒå¹³å°æ¶æ„ä¸Šï¼Œå…¶æ”¯æŒçš„ç±»å‹å¯èƒ½åªåŒ…å«å‰è¿°åˆ—è¡¨çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ä½¿ç”¨â€œqemu-kvm -net nic,model=?â€æ¥è·å–å½“å‰å¹³å°æ”¯æŒçš„ç±»å‹ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-net tap[,vlan=n][,name=name][,fd=h][,ifname=name][,script=file][,downscript=dfile]ï¼šé€šè¿‡ç‰©ç†æœºçš„TAPç½‘ç»œæ¥å£è¿æ¥è‡³vlan nä¸­ï¼Œä½¿ç”¨script=fileæŒ‡å®šçš„è„šæœ¬(é»˜è®¤ä¸º/etc/qemu-ifup)æ¥é…ç½®å½“å‰ç½‘ç»œæ¥å£ï¼Œå¹¶ä½¿ç”¨downscript=fileæŒ‡å®šçš„è„šæœ¬(é»˜è®¤ä¸º/etc/qemu-ifdown)æ¥æ’¤æ¶ˆæ¥å£é…ç½®ï¼›ä½¿ç”¨script=noå’Œdownscript=noå¯åˆ†åˆ«ç”¨æ¥ç¦æ­¢æ‰§è¡Œè„šæœ¬ï¼›</div><div class="line">æ³¨æ„: é»˜è®¤mac åœ°å€å‡ä¸º: 52:54:00:12:34:56ï¼Œä½¿ç”¨ä¸­éœ€è¦æ‰‹åŠ¨æŒ‡å®šã€‚</div><div class="line">ğŸ‘‰ğŸ¾-net user[,option][,option][,...]ï¼šåœ¨ç”¨æˆ·æ¨¡å¼é…ç½®ç½‘ç»œæ ˆï¼Œå…¶ä¸ä¾èµ–äºç®¡ç†æƒé™ï¼›æœ‰æ•ˆé€‰é¡¹æœ‰ï¼š</div><div class="line">ğŸ‘‰ğŸ¾vlan=nï¼šè¿æ¥è‡³vlan nï¼Œé»˜è®¤n=0ï¼›</div><div class="line">ğŸ‘‰ğŸ¾name=nameï¼šæŒ‡å®šæ¥å£çš„æ˜¾ç¤ºåç§°ï¼Œå¸¸ç”¨äºç›‘æ§æ¨¡å¼ä¸­ï¼›</div><div class="line">ğŸ‘‰ğŸ¾net=addr[/mask]ï¼šè®¾å®šGuestOSå¯è§çš„IPç½‘ç»œï¼Œæ©ç å¯é€‰ï¼Œé»˜è®¤ä¸º10.0.2.0/8ï¼›</div><div class="line">ğŸ‘‰ğŸ¾host=addrï¼šæŒ‡å®šGuestOSä¸­çœ‹åˆ°çš„ç‰©ç†æœºçš„IPåœ°å€ï¼Œé»˜è®¤ä¸ºæŒ‡å®šç½‘ç»œä¸­çš„ç¬¬äºŒä¸ªï¼Œå³x.x.x.2ï¼›</div><div class="line">ğŸ‘‰ğŸ¾dhcpstart=addrï¼šæŒ‡å®šDHCPæœåŠ¡åœ°å€æ± ä¸­16ä¸ªåœ°å€çš„èµ·å§‹IPï¼Œé»˜è®¤ä¸ºç¬¬16ä¸ªè‡³ç¬¬31ä¸ªï¼Œå³x.x.x.16-x.x.x.31ï¼›</div><div class="line">ğŸ‘‰ğŸ¾dns=addrï¼šæŒ‡å®šGuestOSå¯è§çš„dnsæœåŠ¡å™¨åœ°å€ï¼›é»˜è®¤ä¸ºGuestOSç½‘ç»œä¸­çš„ç¬¬ä¸‰ä¸ªåœ°å€ï¼Œå³x.x.x.3ï¼›</div><div class="line">ğŸ‘‰ğŸ¾tftp=dirï¼šæ¿€æ´»å†…ç½®çš„tftpæœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šçš„dirä½œä¸ºtftpæœåŠ¡å™¨çš„é»˜è®¤æ ¹ç›®å½•ï¼›</div><div class="line">ğŸ‘‰ğŸ¾bootfile=fileï¼šBOOTPæ–‡ä»¶åç§°ï¼Œç”¨äºå®ç°ç½‘ç»œå¼•å¯¼GuestOSï¼›å¦‚ï¼šqemu -hda linux.img -boot n -net user,tftp=/tftpserver/pub,bootfile=/pxelinux.0</div><div class="line"></div><div class="line">brctl addbr br0</div><div class="line">brctl addif br0 eth0</div><div class="line"></div><div class="line">brctl addbr br1</div></pre></td></tr></table></figure><p>kvmçš„ç½‘ç»œæ¨¡å‹:</p><p>1ã€éš”ç¦»æ¨¡å‹: åœ¨host åˆ›å»ºä¸€ä¸ªvswitch (bridge device): æ¯ä¸ªè™šæ‹Ÿæœºçš„tapè®¾å¤‡ç›´æ¥æ·»åŠ è‡³vswitchä¸Š;<br>2ã€è·¯ç”±æ¨¡å‹:æ¿€æ´»tap,å¹¶å°†å…¶åŠ å…¥åˆ°æŒ‡å®šçš„bridge,ç»™è™šæ‹Ÿçš„brigeæ·»åŠ åœ°å€ï¼Œæ‰“å¼€æ ¸å¿ƒè½¬å‘;<br>3ã€NATæ¨¡å‹:æ¿€æ´»tap,å¹¶å°†å…¶åŠ å…¥åˆ°æŒ‡å®šçš„bridge; é¢å¤–: æ‰“å¼€æ ¸å¿ƒè½¬å‘ï¼Œå¹¶æ·»åŠ åˆ°natè§„åˆ™;<br>4ã€æ¡¥æ¥æ¨¡å‹:æ¿€æ´»tap,å¹¶å°†å…¶åŠ å…¥åˆ°æŒ‡å®šçš„bridge;</p><p>å®‰è£…ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># qemu-kvm -name &quot;rhel5.8&quot; -m 512 \</div><div class="line">-smp 2 -boot d \</div><div class="line">-drive file=/VM/images/rhel5.8/hda,if=virtio,index=0,media=disk,format=qcow2 \</div><div class="line">-drive file=/isos/rhel-5.8.iso,index=1,media=cdrom \</div><div class="line">-net nic,model=virtio,macaddr=52:54:00:A5:41:1E \</div><div class="line">-vga cirrus -balloon virtio</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># qemu-img create /images/centos/centos6.img -o size=120G, preallocation=metadata -f qcow2</div><div class="line"># qemu-kvm -m 512 -smp 2 -name centos -drive file=/images/centos/centos6.img,media=disk,if=virtio  -net nic,model=virtio,macaddr=52:54:00:55:31:18 -net tap,ifname=centos6.0,script=/etc/qemu-ifup -boot order=nc, once=n</div></pre></td></tr></table></figure><h2 id="libvirt-å·¥å…·æ ˆ"><a href="#libvirt-å·¥å…·æ ˆ" class="headerlink" title="libvirt å·¥å…·æ ˆ"></a>libvirt å·¥å…·æ ˆ</h2><p>æ”¯æŒçš„è™šæ‹ŸåŒ–æŠ€æœ¯: KVM, XEN, VMAWARE, Qemu, LXC, OpenVZ;</p><p>å®‰è£…:<br>CentOS6<br><code>yum install libvirt libvirt-client python-virtinst virt-manager</code><br>CentOS7<br><code>yum install libvirt libvirt-client virt-install virt-manager</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">libvirt: å·¥å…·å®ç°è™šæ‹Ÿæœºç®¡ç†ï¼š</div><div class="line">è£…ç³»ç»Ÿï¼švirt-manager, virt-install, virsh</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">ä½¿ç”¨virt-installåˆ›å»ºè™šæ‹Ÿæœºå¹¶å®‰è£…GuestOS</div><div class="line">virt-installæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒèƒ½å¤Ÿä¸ºKVMã€Xenæˆ–å…¶å®ƒæ”¯æŒlibvrit APIçš„hypervisoråˆ›å»ºè™šæ‹Ÿæœºå¹¶å®ŒæˆGuestOSå®‰è£…ï¼›æ­¤å¤–ï¼Œå®ƒèƒ½å¤ŸåŸºäºä¸²è¡Œæ§åˆ¶å°ã€VNCæˆ–SDLæ”¯æŒæ–‡æœ¬æˆ–å›¾å½¢å®‰è£…ç•Œé¢ã€‚å®‰è£…è¿‡ç¨‹å¯ä»¥ä½¿ç”¨æœ¬åœ°çš„å®‰è£…ä»‹è´¨å¦‚CDROMï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç½‘ç»œæ–¹å¼å¦‚NFSã€HTTPæˆ–FTPæœåŠ¡å®ç°ã€‚å¯¹äºé€šè¿‡ç½‘ç»œå®‰è£…çš„æ–¹å¼ï¼Œvirt-installå¯ä»¥è‡ªåŠ¨åŠ è½½å¿…è¦çš„æ–‡ä»¶ä»¥å¯åŠ¨å®‰è£…è¿‡ç¨‹è€Œæ— é¡»é¢å¤–æä¾›å¼•å¯¼å·¥å…·ã€‚å½“ç„¶ï¼Œvirt-installä¹Ÿæ”¯æŒPXEæ–¹å¼çš„å®‰è£…è¿‡ç¨‹ï¼Œä¹Ÿèƒ½å¤Ÿç›´æ¥ä½¿ç”¨ç°æœ‰çš„ç£ç›˜æ˜ åƒç›´æ¥å¯åŠ¨å®‰è£…è¿‡ç¨‹ã€‚</div><div class="line">virt-installå‘½ä»¤æœ‰è®¸å¤šé€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹å¤§ä½“å¯åˆ†ä¸ºä¸‹é¢å‡ å¤§ç±»ï¼ŒåŒæ—¶å¯¹æ¯ç±»ä¸­çš„å¸¸ç”¨é€‰é¡¹ä¹Ÿåšå‡ºç®€å•è¯´æ˜ã€‚</div><div class="line">ğŸ‘‰ğŸ¾ä¸€èˆ¬é€‰é¡¹ï¼šæŒ‡å®šè™šæ‹Ÿæœºçš„åç§°ã€å†…å­˜å¤§å°ã€VCPUä¸ªæ•°åŠç‰¹æ€§ç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-n NAME, --name=NAMEï¼šè™šæ‹Ÿæœºåç§°ï¼Œéœ€å…¨å±€æƒŸä¸€ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-r MEMORY, --ram=MEMORYï¼šè™šæ‹Ÿæœºå†…åœ¨å¤§å°ï¼Œå•ä½ä¸ºMBï¼›</div><div class="line">ğŸ‘‰ğŸ¾ --vcpus=VCPUS[,maxvcpus=MAX][,sockets=#][,cores=#][,threads=#]ï¼šVCPUä¸ªæ•°åŠç›¸å…³é…ç½®ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--cpu=CPUï¼šCPUæ¨¡å¼åŠç‰¹æ€§ï¼Œå¦‚coreduoç­‰ï¼›å¯ä»¥ä½¿ç”¨qemu-kvm -cpu ?æ¥è·å–æ”¯æŒçš„CPUæ¨¡å¼ï¼›</div><div class="line">ğŸ‘‰ğŸ¾å®‰è£…æ–¹æ³•ï¼šæŒ‡å®šå®‰è£…æ–¹æ³•ã€GuestOSç±»å‹ç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾ -c CDROM, --cdrom=CDROMï¼šå…‰ç›˜å®‰è£…ä»‹è´¨ï¼›</div><div class="line">ğŸ‘‰ğŸ¾ -l LOCATION, --location=LOCATIONï¼šå®‰è£…æºURLï¼Œæ”¯æŒFTPã€HTTPåŠNFSç­‰ï¼Œå¦‚ftp://172.16.0.1/pubï¼›</div><div class="line">ğŸ‘‰ğŸ¾--pxeï¼šåŸºäºPXEå®Œæˆå®‰è£…ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--livecd: æŠŠå…‰ç›˜å½“ä½œLiveCDï¼›</div><div class="line">ğŸ‘‰ğŸ¾--os-type=DISTRO_TYPEï¼šæ“ä½œç³»ç»Ÿç±»å‹ï¼Œå¦‚linuxã€unixæˆ–windowsç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--os-variant=DISTRO_VARIANTï¼šæŸç±»å‹æ“ä½œç³»ç»Ÿçš„å˜ä½“ï¼Œå¦‚rhel5ã€fedora8ç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-x EXTRA, --extra-args=EXTRAï¼šæ ¹æ®--locationæŒ‡å®šçš„æ–¹å¼å®‰è£…GuestOSæ—¶ï¼Œç”¨äºä¼ é€’ç»™å†…æ ¸çš„é¢å¤–é€‰é¡¹ï¼Œä¾‹å¦‚æŒ‡å®škickstartæ–‡ä»¶çš„ä½ç½®ï¼Œ--extra-args &quot;ks=http://172.16.0.1/class.cfg&quot;</div><div class="line">ğŸ‘‰ğŸ¾--boot=BOOTOPTSï¼šæŒ‡å®šå®‰è£…è¿‡ç¨‹å®Œæˆåçš„é…ç½®é€‰é¡¹ï¼Œå¦‚æŒ‡å®šå¼•å¯¼è®¾å¤‡æ¬¡åºã€ä½¿ç”¨æŒ‡å®šçš„è€Œéå®‰è£…çš„kernel/initrdæ¥å¼•å¯¼ç³»ç»Ÿå¯åŠ¨ç­‰ ï¼›ä¾‹å¦‚ï¼š</div><div class="line">ğŸ‘‰ğŸ¾--boot  cdrom,hd,networkï¼šæŒ‡å®šå¼•å¯¼æ¬¡åºï¼›</div><div class="line">ğŸ‘‰ğŸ¾--boot kernel=KERNEL,initrd=INITRD,kernel_args=â€console=/dev/ttyS0â€ï¼šæŒ‡å®šå¯åŠ¨ç³»ç»Ÿçš„å†…æ ¸åŠinitrdæ–‡ä»¶ï¼›</div><div class="line">ğŸ‘‰ğŸ¾å­˜å‚¨é…ç½®ï¼šæŒ‡å®šå­˜å‚¨ç±»å‹ã€ä½ç½®åŠå±æ€§ç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--disk=DISKOPTSï¼šæŒ‡å®šå­˜å‚¨è®¾å¤‡åŠå…¶å±æ€§ï¼›æ ¼å¼ä¸º--disk /some/storage/path,opt1=val1ï¼Œopt2=val2ç­‰ï¼›å¸¸ç”¨çš„é€‰é¡¹æœ‰ï¼š</div><div class="line">ğŸ‘‰ğŸ¾deviceï¼šè®¾å¤‡ç±»å‹ï¼Œå¦‚cdromã€diskæˆ–floppyç­‰ï¼Œé»˜è®¤ä¸ºdiskï¼›</div><div class="line">ğŸ‘‰ğŸ¾busï¼šç£ç›˜æ€»ç»“ç±»å‹ï¼Œå…¶å€¼å¯ä»¥ä¸ºideã€scsiã€usbã€virtioæˆ–xenï¼›</div><div class="line">ğŸ‘‰ğŸ¾permsï¼šè®¿é—®æƒé™ï¼Œå¦‚rwã€roæˆ–shï¼ˆå…±äº«çš„å¯è¯»å†™ï¼‰ï¼Œé»˜è®¤ä¸ºrwï¼›</div><div class="line">ğŸ‘‰ğŸ¾sizeï¼šæ–°å»ºç£ç›˜æ˜ åƒçš„å¤§å°ï¼Œå•ä½ä¸ºGBï¼›</div><div class="line">ğŸ‘‰ğŸ¾cacheï¼šç¼“å­˜æ¨¡å‹ï¼Œå…¶å€¼æœ‰noneã€writethrouthï¼ˆç¼“å­˜è¯»ï¼‰åŠwritebackï¼ˆç¼“å­˜è¯»å†™ï¼‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾formatï¼šç£ç›˜æ˜ åƒæ ¼å¼ï¼Œå¦‚rawã€qcow2ã€vmdkç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾sparseï¼šç£ç›˜æ˜ åƒä½¿ç”¨ç¨€ç–æ ¼å¼ï¼Œå³ä¸ç«‹å³åˆ†é…æŒ‡å®šå¤§å°çš„ç©ºé—´ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--nodisksï¼šä¸ä½¿ç”¨æœ¬åœ°ç£ç›˜ï¼Œåœ¨LiveCDæ¨¡å¼ä¸­å¸¸ç”¨ï¼›</div><div class="line">ğŸ‘‰ğŸ¾ç½‘ç»œé…ç½®ï¼šæŒ‡å®šç½‘ç»œæ¥å£çš„ç½‘ç»œç±»å‹åŠæ¥å£å±æ€§å¦‚MACåœ°å€ã€é©±åŠ¨æ¨¡å¼ç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-w NETWORK, --network=NETWORK,opt1=val1,opt2=val2ï¼šå°†è™šæ‹Ÿæœºè¿å…¥å®¿ä¸»æœºçš„ç½‘ç»œä¸­ï¼Œå…¶ä¸­NETWORKå¯ä»¥ä¸ºï¼š</div><div class="line">ğŸ‘‰ğŸ¾bridge=BRIDGEï¼šè¿æ¥è‡³åä¸ºâ€œBRIDEGâ€çš„æ¡¥è®¾å¤‡ï¼›</div><div class="line">ğŸ‘‰ğŸ¾network=NAMEï¼šè¿æ¥è‡³åä¸ºâ€œNAMEâ€çš„ç½‘ç»œï¼›</div><div class="line">å…¶å®ƒå¸¸ç”¨çš„é€‰é¡¹è¿˜æœ‰ï¼š</div><div class="line">ğŸ‘‰ğŸ¾modelï¼šGuestOSä¸­çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡å‹å·ï¼Œå¦‚e1000ã€rtl8139æˆ–virtioç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾macï¼šå›ºå®šçš„MACåœ°å€ï¼›çœç•¥æ­¤é€‰é¡¹æ—¶å°†ä½¿ç”¨éšæœºåœ°å€ï¼Œä½†æ— è®ºä½•ç§æ–¹å¼ï¼Œå¯¹äºKVMæ¥è¯´ï¼Œå…¶å‰ä¸‰æ®µå¿…é¡»ä¸º52:54:00ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--nonetworksï¼šè™šæ‹Ÿæœºä¸ä½¿ç”¨ç½‘ç»œåŠŸèƒ½ï¼›</div><div class="line">ğŸ‘‰ğŸ¾å›¾å½¢é…ç½®ï¼šå®šä¹‰è™šæ‹Ÿæœºæ˜¾ç¤ºåŠŸèƒ½ç›¸å…³çš„é…ç½®ï¼Œå¦‚VNCç›¸å…³é…ç½®ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--graphics TYPE,opt1=val1,opt2=val2ï¼šæŒ‡å®šå›¾å½¢æ˜¾ç¤ºç›¸å…³çš„é…ç½®ï¼Œæ­¤é€‰é¡¹ä¸ä¼šé…ç½®ä»»ä½•æ˜¾ç¤ºç¡¬ä»¶ï¼ˆå¦‚æ˜¾å¡ï¼‰ï¼Œè€Œæ˜¯ä»…æŒ‡å®šè™šæ‹Ÿæœºå¯åŠ¨åå¯¹å…¶è¿›è¡Œè®¿é—®çš„æ¥å£ï¼›</div><div class="line">ğŸ‘‰ğŸ¾TYPEï¼šæŒ‡å®šæ˜¾ç¤ºç±»å‹ï¼Œå¯ä»¥ä¸ºvncã€sdlã€spiceæˆ–noneç­‰ï¼Œé»˜è®¤ä¸ºvncï¼›</div><div class="line">ğŸ‘‰ğŸ¾portï¼šTYPEä¸ºvncæˆ–spiceæ—¶å…¶ç›‘å¬çš„ç«¯å£ï¼›</div><div class="line">ğŸ‘‰ğŸ¾listenï¼šTYPEä¸ºvncæˆ–spiceæ—¶æ‰€ç›‘å¬çš„IPåœ°å€ï¼Œé»˜è®¤ä¸º127.0.0.1ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹/etc/libvirt/qemu.confå®šä¹‰æ–°çš„é»˜è®¤å€¼ï¼›</div><div class="line">ğŸ‘‰ğŸ¾passwordï¼šTYPEä¸ºvncæˆ–spiceæ—¶ï¼Œä¸ºè¿œç¨‹è®¿é—®ç›‘å¬çš„æœåŠ¡è¿›æŒ‡å®šè®¤è¯å¯†ç ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--noautoconsoleï¼šç¦æ­¢è‡ªåŠ¨è¿æ¥è‡³è™šæ‹Ÿæœºçš„æ§åˆ¶å°ï¼›</div><div class="line">ğŸ‘‰ğŸ¾è®¾å¤‡é€‰é¡¹ï¼šæŒ‡å®šæ–‡æœ¬æ§åˆ¶å°ã€å£°éŸ³è®¾å¤‡ã€ä¸²è¡Œæ¥å£ã€å¹¶è¡Œæ¥å£ã€æ˜¾ç¤ºæ¥å£ç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--serial=CHAROPTSï¼šé™„åŠ ä¸€ä¸ªä¸²è¡Œè®¾å¤‡è‡³å½“å‰è™šæ‹Ÿæœºï¼Œæ ¹æ®è®¾å¤‡ç±»å‹çš„ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„é€‰é¡¹ï¼Œæ ¼å¼ä¸ºâ€œ--serial type,opt1=val1,opt2=val2,...â€ï¼Œä¾‹å¦‚ï¼š</div><div class="line">ğŸ‘‰ğŸ¾--serial ptyï¼šåˆ›å»ºä¼ªç»ˆç«¯ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--serial dev,path=HOSTPATHï¼šé™„åŠ ä¸»æœºè®¾å¤‡è‡³æ­¤è™šæ‹Ÿæœºï¼›</div><div class="line">ğŸ‘‰ğŸ¾--video=VIDEOï¼šæŒ‡å®šæ˜¾å¡è®¾å¤‡æ¨¡å‹ï¼Œå¯ç”¨å–å€¼ä¸ºcirrusã€vgaã€qxlæˆ–vmvgaï¼›</div><div class="line"></div><div class="line">ğŸ‘‰ğŸ¾è™šæ‹ŸåŒ–å¹³å°ï¼šè™šæ‹ŸåŒ–æ¨¡å‹ï¼ˆhvmæˆ–paravirtï¼‰ã€æ¨¡æ‹Ÿçš„CPUå¹³å°ç±»å‹ã€æ¨¡æ‹Ÿçš„ä¸»æœºç±»å‹ã€hypervisorç±»å‹ï¼ˆå¦‚kvmã€xenæˆ–qemuç­‰ï¼‰ä»¥åŠå½“å‰è™šæ‹Ÿæœºçš„UUIDç­‰ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-v, --hvmï¼šå½“ç‰©ç†æœºåŒæ—¶æ”¯æŒå®Œå…¨è™šæ‹ŸåŒ–å’ŒåŠè™šæ‹ŸåŒ–æ—¶ï¼ŒæŒ‡å®šä½¿ç”¨å®Œå…¨è™šæ‹ŸåŒ–ï¼›</div><div class="line">ğŸ‘‰ğŸ¾-p, --paravirtï¼šæŒ‡å®šä½¿ç”¨åŠè™šæ‹ŸåŒ–ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--virt-typeï¼šä½¿ç”¨çš„hypervisorï¼Œå¦‚kvmã€qemuã€xenç­‰ï¼›æ‰€æœ‰å¯ç”¨å€¼å¯ä»¥ä½¿ç”¨â€™virsh capabilitiesâ€™å‘½ä»¤è·å–ï¼›</div><div class="line">ğŸ‘‰ğŸ¾å…¶å®ƒï¼š</div><div class="line">ğŸ‘‰ğŸ¾--autostartï¼šæŒ‡å®šè™šæ‹Ÿæœºæ˜¯å¦åœ¨ç‰©ç†å¯åŠ¨åè‡ªåŠ¨å¯åŠ¨ï¼›</div><div class="line">ğŸ‘‰ğŸ¾--print-xmlï¼šå¦‚æœè™šæ‹Ÿæœºä¸éœ€è¦å®‰è£…è¿‡ç¨‹(--importã€--boot)ï¼Œåˆ™æ˜¾ç¤ºç”Ÿæˆçš„XMLè€Œä¸æ˜¯åˆ›å»ºæ­¤è™šæ‹Ÿæœºï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤é€‰é¡¹ä»ä¼šåˆ›å»ºç£ç›˜æ˜ åƒï¼›</div><div class="line">ğŸ‘‰ğŸ¾--forceï¼šç¦æ­¢å‘½ä»¤è¿›å…¥äº¤äº’å¼æ¨¡å¼ï¼Œå¦‚æœæœ‰éœ€è¦å›ç­”yesæˆ–noé€‰é¡¹ï¼Œåˆ™è‡ªåŠ¨å›ç­”ä¸ºyesï¼›</div><div class="line">ğŸ‘‰ğŸ¾--dry-runï¼šæ‰§è¡Œåˆ›å»ºè™šæ‹Ÿæœºçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä½†ä¸çœŸæ­£åˆ›å»ºè™šæ‹Ÿæœºã€æ”¹å˜ä¸»æœºä¸Šçš„è®¾å¤‡é…ç½®ä¿¡æ¯åŠå°†å…¶åˆ›å»ºçš„éœ€æ±‚é€šçŸ¥ç»™libvirtï¼›</div><div class="line">ğŸ‘‰ğŸ¾-d, --debugï¼šæ˜¾ç¤ºdebugä¿¡æ¯ï¼›</div><div class="line"></div><div class="line">å°½ç®¡virt-installå‘½ä»¤æœ‰ç€ç±»ä¼¼ä¸Šè¿°çš„ä¼—å¤šé€‰é¡¹ï¼Œä½†å®é™…ä½¿ç”¨ä¸­ï¼Œå…¶å¿…é¡»æä¾›çš„é€‰é¡¹ä»…åŒ…æ‹¬--nameã€--ramã€--diskï¼ˆä¹Ÿå¯æ˜¯--nodisksï¼‰åŠå®‰è£…è¿‡ç¨‹ç›¸å…³çš„é€‰é¡¹ã€‚æ­¤å¤–ï¼Œæœ‰æ—¶è¿˜éœ€è¦ä½¿ç”¨æ‹¬--connect=CONNCTé€‰é¡¹æ¥æŒ‡å®šè¿æ¥è‡³ä¸€ä¸ªéé»˜è®¤çš„hypervisorã€‚</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># virt-install -n centos6.7 -r 512 -vcpus=2, maxvcpus=4 --pxe --disk /images/centos/centos6.7.qcow2,size=120,format=qcow2,bus=virtio,spare=yes --network bridge=br0,model-virtio --force</div></pre></td></tr></table></figure><p>ç”Ÿäº§ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virt-install --name testwinserver  --memory 6144 --vcpus 2 --disk device=cdrom,path=/kvmiso/cn_windows_server_2016_x64_dvd_9718765.iso --disk device=cdrom,path=/usr/share/virtio-win/virtio-win.iso --disk path=/kvmdata/testwinserver.img,size=300,bus=virtio --network bridge=br-ext,model=virtio --noautoconsole --accelerate --hvm --graphics vnc,listen=0.0.0.0 --video vga --input tablet,bus=usb --os-type=windows --check path_in_use=off</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(ä¸ƒ)</title>
      <link href="/2019/06/15/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%957/"/>
      <url>/2019/06/15/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%957/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•ä¸ƒ"><a href="#kubernetes-æ“ä½œè®°å½•ä¸ƒ" class="headerlink" title="kubernetes æ“ä½œè®°å½•ä¸ƒ"></a>kubernetes æ“ä½œè®°å½•ä¸ƒ</h1><p><img src="/images/docker_kubernetes.png" alt=""></p><h2 id="èµ„æºæŒ‡æ ‡APIåŠè‡ªå®šä¹‰æŒ‡æ ‡API"><a href="#èµ„æºæŒ‡æ ‡APIåŠè‡ªå®šä¹‰æŒ‡æ ‡API" class="headerlink" title="èµ„æºæŒ‡æ ‡APIåŠè‡ªå®šä¹‰æŒ‡æ ‡API"></a>èµ„æºæŒ‡æ ‡APIåŠè‡ªå®šä¹‰æŒ‡æ ‡API</h2><p>èµ„æºæŒ‡æ ‡: metrics-server<br>è‡ªå®šä¹‰æŒ‡æ ‡: prometheus, k8s-prometheus-adapter</p><p>æ–°ä¸€ä»£æ¶æ„:<br>    æ ¸å¿ƒæŒ‡æ ‡æµæ°´çº¿ï¼šç”±kubeletã€metrics-server ä»¥åŠç”±API server æä¾›çš„apiç»„æˆ;CPUã€å†…å­˜å®æ—¶ä½¿ç”¨ç‡ã€Podçš„èµ„æºå ç”¨ç‡åŠçª—å£çš„ç£ç›˜å ç”¨ç‡;<br>    ç›‘æ§æµæ°´çº¿: ç”¨äºä»ç³»ç»Ÿæ”¶é›†å„ç§æŒ‡æ ‡æ•°æ®å¹¶æä¾›ç»ˆç«¯ç”¨æˆ·ã€å­˜å‚¨ç³»ç»Ÿä»¥åŠHPAã€‚å®ƒä»¬åŒ…å«æ ¸å¿ƒæŒ‡æ ‡åŠè®¸å¤šéæ ¸å¿ƒæŒ‡æ ‡ã€‚éæ ¸å¿ƒæŒ‡æ ‡æœ¬èº«ä¸èƒ½è¢«k8sæ‰€è§£æ;<br>    metrics-server: API server </p><hr><h3 id="éƒ¨ç½²-metrics-server"><a href="#éƒ¨ç½²-metrics-server" class="headerlink" title="éƒ¨ç½² metrics-server"></a>éƒ¨ç½² metrics-server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir metrics-server</span></div><div class="line"><span class="comment"># wget https://github.com/kubernetes-incubator/metrics-server/archive/v0.3.1.zip  </span></div><div class="line"><span class="comment"># cd metrics-server/metrics-server-0.3.1/deploy/1.8+/</span></div><div class="line"><span class="comment"># mv * ../../../</span></div></pre></td></tr></table></figure><p>é—®é¢˜ä¿®æ­£ </p><ul><li><p>é—®é¢˜1ï¼šmetrics-serveré»˜è®¤ä½¿ç”¨èŠ‚ç‚¹hostnameé€šè¿‡kubelet 10250ç«¯å£è·å–æ•°æ®ï¼Œä½†æ˜¯corednsé‡Œé¢æ²¡æœ‰è¯¥æ•°æ®æ— æ³•è§£æ(10.96.0.10:53)ï¼Œå¯ä»¥åœ¨metrics serverå¯åŠ¨å‘½ä»¤æ·»åŠ å‚æ•° â€“kubelet-preferred-address-types=InternalIP ç›´æ¥ä½¿ç”¨èŠ‚ç‚¹IPåœ°å€è·å–æ•°æ®</p></li><li><p>é—®é¢˜2ï¼škubelet çš„10250ç«¯å£ä½¿ç”¨çš„æ˜¯httpsåè®®ï¼Œè¿æ¥éœ€è¦éªŒè¯tlsè¯ä¹¦ã€‚å¯ä»¥åœ¨metrics serverå¯åŠ¨å‘½ä»¤æ·»åŠ å‚æ•°â€“kubelet-insecure-tlsä¸éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦</p></li><li><p>é—®é¢˜3ï¼šyamlæ–‡ä»¶ä¸­çš„imageåœ°å€k8s.gcr.io/metrics-server-amd64:v0.3.0 éœ€è¦æ¢¯å­ï¼Œéœ€è¦æ”¹æˆä¸­å›½å¯ä»¥è®¿é—®çš„imageåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨aliyunçš„ <code>registry.cn-hangzhou.aliyuncs.com/google_containers/</code></p></li></ul><p>ä¿®æ”¹ä»¥ä¸‹å†…å®¹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="attr">containers:</span></div><div class="line"><span class="attr">     - name:</span> <span class="string">metrics-server</span></div><div class="line">       <span class="comment">#image: k8s.gcr.io/metrics-server-amd64:v0.3.0</span></div><div class="line"><span class="attr">       image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.0</span></div><div class="line"><span class="attr">       imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">       command:</span></div><div class="line"><span class="bullet">       -</span> <span class="string">/metrics-server</span></div><div class="line"><span class="bullet">       -</span> <span class="bullet">--metric-resolution=30s</span></div><div class="line"><span class="bullet">       -</span> <span class="bullet">--kubelet-insecure-tls</span></div><div class="line"><span class="bullet">       -</span> <span class="bullet">--kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span></div><div class="line"><span class="attr">       volumeMounts:</span></div><div class="line"><span class="attr">       - name:</span> <span class="string">tmp-dir</span></div><div class="line"><span class="attr">         mountPath:</span> <span class="string">/tmp</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl api-versions | grep metrics</span></div><div class="line">metrics.k8s.io/v1beta1</div></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># curl  http://localhost:8080/apis/metrics.k8s.io/v1beta1</div><div class="line">&#123;</div><div class="line">  <span class="attr">"kind"</span>: <span class="string">"APIResourceList"</span>,</div><div class="line">  <span class="attr">"apiVersion"</span>: <span class="string">"v1"</span>,</div><div class="line">  <span class="attr">"groupVersion"</span>: <span class="string">"metrics.k8s.io/v1beta1"</span>,</div><div class="line">  <span class="attr">"resources"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"nodes"</span>,</div><div class="line">      <span class="attr">"singularName"</span>: <span class="string">""</span>,</div><div class="line">      <span class="attr">"namespaced"</span>: <span class="literal">false</span>,</div><div class="line">      <span class="attr">"kind"</span>: <span class="string">"NodeMetrics"</span>,</div><div class="line">      <span class="attr">"verbs"</span>: [</div><div class="line">        <span class="string">"get"</span>,</div><div class="line">        <span class="string">"list"</span></div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"pods"</span>,</div><div class="line">      <span class="attr">"singularName"</span>: <span class="string">""</span>,</div><div class="line">      <span class="attr">"namespaced"</span>: <span class="literal">true</span>,</div><div class="line">      <span class="attr">"kind"</span>: <span class="string">"PodMetrics"</span>,</div><div class="line">      <span class="attr">"verbs"</span>: [</div><div class="line">        <span class="string">"get"</span>,</div><div class="line">        <span class="string">"list"</span></div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>é”™è¯¯æ—¥å¿—æ’æŸ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl logs -f metrics-server-68cdb458db-rgjtr -c metrics-server -n kube-system</span></div></pre></td></tr></table></figure><p>ä¸»è¦æä¾›node  å’ŒPodçš„ç›‘æ§æ•°æ®;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">kubectl  top nodes</div><div class="line">NAME                   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</div><div class="line">node01                  94m          4%     1574Mi          42%</div><div class="line">node02                  92m          4%     1901Mi          51%</div><div class="line">node03                  108m         5%     1803Mi          48%</div><div class="line">master                  238m         11%    1879Mi          50%</div></pre></td></tr></table></figure><h3 id="prometheus-éƒ¨ç½²"><a href="#prometheus-éƒ¨ç½²" class="headerlink" title="prometheus éƒ¨ç½²"></a>prometheus éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># git clone https://github.com/iKubernetes/k8s-prom.git</span></div><div class="line"><span class="comment"># cd k8s-prom</span></div><div class="line"><span class="comment"># kubectl  apply -f namespace.yaml</span></div><div class="line"><span class="comment"># cd node_exporter/</span></div><div class="line"><span class="comment"># kubectl  apply -f ./</span></div><div class="line"><span class="comment"># kubectl get pods -n prom</span></div><div class="line">NAME                             READY   STATUS    RESTARTS   AGE</div><div class="line">prometheus-node-exporter-2xrqp   1/1     Running   0          47s</div><div class="line">prometheus-node-exporter-cgkp7   1/1     Running   0          47s</div><div class="line">prometheus-node-exporter-t7vh7   1/1     Running   0          47s</div><div class="line">prometheus-node-exporter-vrw89   1/1     Running   0          46s</div><div class="line"><span class="comment"># cd ../prometheus/</span></div><div class="line"><span class="comment"># kubectl apply -f ./</span></div></pre></td></tr></table></figure><p><img src="/images/kubernetes-prometheus-deploy.png" alt=""></p><p>æ³¨: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè‡³å°‘è¦ç”¨pvå­˜å‚¨ï¼Œä¸ç„¶å½“Podåˆ é™¤æ—¶ï¼Œæ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤; </p><h3 id="å®‰è£…-kube-state-metrics"><a href="#å®‰è£…-kube-state-metrics" class="headerlink" title="å®‰è£…  kube-state-metrics"></a>å®‰è£…  kube-state-metrics</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd ../kube-state-metrics/</span></div><div class="line"><span class="comment"># vim kube-state-metrics-deploy.yaml # ä¿®æ”¹imageé•œåƒæº</span></div><div class="line">image: quay.io/coreos/kube-state-metrics:v1.3.1</div><div class="line"><span class="comment"># kubectl  apply -f ./</span></div><div class="line"><span class="comment"># kubectl  get all -n prom</span></div></pre></td></tr></table></figure><h3 id="å®‰è£…-k8s-prometheus-adapter"><a href="#å®‰è£…-k8s-prometheus-adapter" class="headerlink" title="å®‰è£… k8s-prometheus-adapter"></a>å®‰è£… k8s-prometheus-adapter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># /etc/kubernetes/pki/</div><div class="line"># (umask 077; openssl genrsa -out serving.key 2048)</div><div class="line"># openssl req -new -key serving.key -out serving.csr -subj &quot;/CN=serving&quot;</div><div class="line"># openssl x509 -req -in serving.csr  -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -out serving.crt -days 36500</div><div class="line"># kubectl create generic cm-adapter-serving-certs --from-file=serving.crt --from-file=serving.key</div><div class="line"># kubectl create secret  generic cm-adapter-serving-certs --from-file=serving.crt --from-file=serving.key -n prom</div><div class="line"># cd manifests/metrics/k8s-prom/k8s-prometheus-adapter</div><div class="line"># kubectl apply -f ./</div></pre></td></tr></table></figure><p>å‘ç°<code>k8s-prometheus-adapter</code>ä¸­çš„<code>custom-metrics-apiserver-deployment.yaml</code> é…ç½®å˜äº†ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ®åŸæœ‰å†…å®¹ <code>image: directxman12/k8s-prometheus-adapter-amd64</code> googleæœç´¢<code>directxman12</code><a href="https://github.com/DirectXMan12/k8s-prometheus-adapter/tree/master/deploy/manifests" target="_blank" rel="external">æ›´æ–°</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mv custom-metrics-apiserver-deployment.yaml&#123;,.bak&#125;</span></div><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/DirectXMan12/k8s-prometheus-adapter/master/deploy/manifests/custom-metrics-apiserver-deployment.yaml</span></div><div class="line"><span class="comment"># vim custom-metrics-apiserver-deployment.yaml # æ”¹namespace: prom </span></div><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/DirectXMan12/k8s-prometheus-adapter/master/deploy/manifests/custom-metrics-config-map.yaml</span></div><div class="line"><span class="comment"># vim custom-metrics-config-map.yaml  # æ”¹namespace: prom</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get all -n prom</span></div><div class="line">NAME                                            READY   STATUS    RESTARTS   AGE</div><div class="line">pod/custom-metrics-apiserver-667fd4fffd-qs2zk   1/1     Running   0          3m18s</div><div class="line">pod/kube-state-metrics-6697d66bbb-w7k4d         1/1     Running   0          20m</div><div class="line">pod/prometheus-node-exporter-2xrqp              1/1     Running   0          71m</div><div class="line">pod/prometheus-node-exporter-cgkp7              1/1     Running   0          71m</div><div class="line">pod/prometheus-node-exporter-t7vh7              1/1     Running   0          71m</div><div class="line">pod/prometheus-node-exporter-vrw89              1/1     Running   0          71m</div><div class="line">pod/prometheus-server-75cf46bdbc-kpgzs          1/1     Running   0          69m</div></pre></td></tr></table></figure><p>è¡¥å……kubelet å¯åŠ¨å¤±è´¥ <code>swapoff -a</code><br>æ–°å…¥æ–°èŠ‚ç‚¹æ—¶å¡ä½ <code>kubeadm token create</code>  <code>kubeadm token list</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl http://localhost:8080/apis/custom.metrics.k8s.io/v1beta1</span></div></pre></td></tr></table></figure><h3 id="å®‰è£…-grafana"><a href="#å®‰è£…-grafana" class="headerlink" title="å®‰è£… grafana"></a>å®‰è£… grafana</h3><p>æ”¹åŸgrafana é…ç½®æ–‡ä»¶ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">monitoring-grafana</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">prom</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      task:</span> <span class="string">monitoring</span></div><div class="line"><span class="attr">      k8s-app:</span> <span class="string">grafana</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        task:</span> <span class="string">monitoring</span></div><div class="line"><span class="attr">        k8s-app:</span> <span class="string">grafana</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">grafana</span></div><div class="line"><span class="attr">        image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-grafana-amd64:v5.0.4</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">3000</span></div><div class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></div><div class="line"><span class="attr">        volumeMounts:</span></div><div class="line"><span class="attr">        - mountPath:</span> <span class="string">/etc/ssl/certs</span></div><div class="line"><span class="attr">          name:</span> <span class="string">ca-certificates</span></div><div class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        - mountPath:</span> <span class="string">/var</span></div><div class="line"><span class="attr">          name:</span> <span class="string">grafana-storage</span></div><div class="line"><span class="attr">        env:</span></div><div class="line">        <span class="comment">#- name: INFLUXDB_HOST</span></div><div class="line">        <span class="comment">#  value: monitoring-influxdb</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">GF_SERVER_HTTP_PORT</span></div><div class="line"><span class="attr">          value:</span> <span class="string">"3000"</span></div><div class="line">          <span class="comment"># The following env variables are required to make Grafana accessible via</span></div><div class="line">          <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></div><div class="line">          <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></div><div class="line">          <span class="comment"># service using a LoadBalancer or a public IP.</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></div><div class="line"><span class="attr">          value:</span> <span class="string">"false"</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></div><div class="line"><span class="attr">          value:</span> <span class="string">"true"</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">GF_AUTH_ANONYMOUS_ORG_ROLE</span></div><div class="line"><span class="attr">          value:</span> <span class="string">Admin</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">GF_SERVER_ROOT_URL</span></div><div class="line">          <span class="comment"># If you're only using the API Server proxy, set this value instead:</span></div><div class="line">          <span class="comment"># value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span></div><div class="line"><span class="attr">          value:</span> <span class="string">/</span></div><div class="line"><span class="attr">      volumes:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">ca-certificates</span></div><div class="line"><span class="attr">        hostPath:</span></div><div class="line"><span class="attr">          path:</span> <span class="string">/etc/ssl/certs</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">grafana-storage</span></div><div class="line"><span class="attr">        emptyDir:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line">    <span class="comment"># For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span></div><div class="line">    <span class="comment"># If you are NOT using this as an addon, you should comment out this line.</span></div><div class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">'true'</span></div><div class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">monitoring-grafana</span></div><div class="line"><span class="attr">  name:</span> <span class="string">monitoring-grafana</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">prom</span></div><div class="line"><span class="attr">spec:</span></div><div class="line">  <span class="comment"># In a production setup, we recommend accessing Grafana through an external Loadbalancer</span></div><div class="line">  <span class="comment"># or through a public IP.</span></div><div class="line">  <span class="comment"># type: LoadBalancer</span></div><div class="line">  <span class="comment"># You could also use NodePort to expose the service at a randomly-generated port</span></div><div class="line">  <span class="comment"># type: NodePort</span></div><div class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">3000</span></div><div class="line"><span class="attr">    nodePort:</span> <span class="number">30098</span></div><div class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    k8s-app:</span> <span class="string">grafana</span></div><div class="line"><span class="comment"># kubectl apply -f grafana.yaml</span></div></pre></td></tr></table></figure><p><img src="/images/kubernetes-prometheus-grafana.png" alt=""><br><img src="/images/kubernetes-prometheus-datasources.png" alt=""></p><p>ä¸‹è½½å¹¶å¯¼å…¥<a href="https://grafana.com/dashboards/" target="_blank" rel="external">æ¨¡ç‰ˆ</a><br><img src="/images/kubernetest-prometheus-dashboard.png" alt=""></p><h2 id="èµ„æºé™åˆ¶ä¸ä¼¸ç¼©"><a href="#èµ„æºé™åˆ¶ä¸ä¼¸ç¼©" class="headerlink" title="èµ„æºé™åˆ¶ä¸ä¼¸ç¼©"></a>èµ„æºé™åˆ¶ä¸ä¼¸ç¼©</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=0 --requests='cpu=50m,memory=256Mi' --limits='cpu=50m,memory=256Mi' --labels='app=myapp' --expose --port=80</span></div><div class="line"><span class="comment"># kubectl autoscale deployment myapp --min=1 --max=8 --cpu-percent=60</span></div><div class="line">horizontalpodautoscaler.autoscaling/myapp autoscaled</div><div class="line"><span class="comment">#  kubectl get hpa</span></div><div class="line">NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</div><div class="line">myapp   Deployment/myapp   0%/60%    1         8         1          22s</div><div class="line"><span class="comment"># kubectl patch svc myapp -p '&#123;"spec":&#123;"type": "NodePort"&#125;&#125;'</span></div><div class="line">service/myapp patched</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ssjinyao â¤ ab -c 100 -n 50000 http://xx.x.xx.xx:31257/index.html</span></div></pre></td></tr></table></figure><p>å½“å‹æµ‹ï¼ŒCPU å†…å­˜èµ„æºè¶…å‡ºæ—¶ï¼Œä¼šæ‰©å±•Podæ•°ç›®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp-hpa-v2</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  scaleTargetRef:</span></div><div class="line"><span class="attr">    apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">    name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  minReplicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  maxReplicas:</span> <span class="number">10</span></div><div class="line"><span class="attr">  metrics:</span></div><div class="line"><span class="attr">  - type:</span> <span class="string">Resource</span></div><div class="line"><span class="attr">    resource:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">cpu</span></div><div class="line"><span class="attr">      targetAverageUtilization:</span> <span class="number">55</span></div><div class="line"><span class="attr">  - type:</span> <span class="string">Resource</span></div><div class="line"><span class="attr">    resource:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">memory</span></div><div class="line"><span class="attr">      targetAverageValue:</span> <span class="number">50</span><span class="string">Mi</span></div></pre></td></tr></table></figure><p>æ ¹æ®è¯·æ±‚æ•°å‡Podæ•°</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp-hpa-v2</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  scaleTargetRef:</span></div><div class="line"><span class="attr">    apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">    kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">    name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  minReplicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  maxReplicas:</span> <span class="number">10</span></div><div class="line"><span class="attr">  metrics:</span></div><div class="line"><span class="attr">  - type:</span> <span class="string">Pods</span></div><div class="line"><span class="attr">    pods:</span></div><div class="line"><span class="attr">      metricName:</span> <span class="string">http_requests</span></div><div class="line"><span class="attr">      targetAverageValue:</span> <span class="number">800</span><span class="string">m</span></div></pre></td></tr></table></figure><h2 id="helm-å…¥é—¨"><a href="#helm-å…¥é—¨" class="headerlink" title="helm å…¥é—¨"></a>helm å…¥é—¨</h2><p>æ ¸å¿ƒæœ¯è¯­:<br>    Chart: ä¸€ä¸ªhelmç¨‹åºåŒ…;<br>    Repository: Chartsä»“åº“,https/httpæœåŠ¡å™¨;<br>    Release:ç‰¹å®šçš„Chartéƒ¨ç½²äºç›®æ ‡é›†ç¾¤ä¸Šçš„ä¸€ä¸ªå®ä¾‹;<br>    Chart -&gt; Config -&gt; Release<br>ç¨‹åºæ¶æ„:<br>    helmï¼šå®¢æˆ·ç«¯ï¼Œç®¡ç†æœ¬åœ°çš„Chartä»“åº“ï¼Œç®¡ç†Chartï¼Œä¸TilleræœåŠ¡å™¨äº¤äº’ï¼Œå‘é€Chart,å®ä¾‹å®‰è£…ã€æŸ¥è¯¢ã€å¸è½½ç­‰æ“ä½œ<br>    Tiller:  æœåŠ¡ç«¯ ï¼Œæ¥æ”¶helmå‘æ¥çš„Chartä¸Config,åˆå¹¶ç”Ÿæˆrelease;<br> <a href="https://github.com/helm/helm" target="_blank" rel="external">helm githubå®˜ç½‘</a></p><hr><h3 id="å®‰è£…helm"><a href="#å®‰è£…helm" class="headerlink" title="å®‰è£…helm"></a>å®‰è£…helm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://get.helm.sh/helm-v2.9.1-linux-amd64.tar.gz</span></div><div class="line"><span class="comment"># mv linux-amd64/helm  /usr/sbin/</span></div><div class="line"><span class="comment"># helm</span></div></pre></td></tr></table></figure><p>è¦ä½¿ç”¨helm è¿˜éœ€è¦å®‰è£… Tiller<br>helm ä¼šè¯†åˆ« <code>.kube/config</code> æ‰®æ¼”æˆkubectl å®¢æˆ·ç«¯å»è¿æ¥è‡³kubernetesé›†ç¾¤ </p><h3 id="å®‰è£…-Tiller"><a href="#å®‰è£…-Tiller" class="headerlink" title="å®‰è£… Tiller"></a>å®‰è£… Tiller</h3><p><a href="https://github.com/helm/helm/blob/master/docs/rbac.md" target="_blank" rel="external">ClusterRoleBinding RBACé…ç½®æ–‡ä»¶</a></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir helm</span></div><div class="line"><span class="comment"># cd helm/</span></div><div class="line"><span class="comment"># vim tiller-rbac.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">tiller</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">tiller</span></div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></div><div class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></div><div class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></div><div class="line"><span class="attr">    name:</span> <span class="string">tiller</span></div><div class="line"><span class="attr">    namespace:</span> <span class="string">kube-system</span></div><div class="line"><span class="comment"># kubectl apply -f tiller-rbac.yaml</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm init --service-account tiller</span></div></pre></td></tr></table></figure><p>æŠ¥é”™ä¸å¤„ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm init --service-account tiller</span></div><div class="line">Creating /root/.helm</div><div class="line">Creating /root/.helm/repository</div><div class="line">Creating /root/.helm/repository/cache</div><div class="line">Creating /root/.helm/repository/<span class="built_in">local</span></div><div class="line">Creating /root/.helm/plugins</div><div class="line">Creating /root/.helm/starters</div><div class="line">Creating /root/.helm/cache/archive</div><div class="line">Creating /root/.helm/repository/repositories.yaml</div><div class="line">Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com</div><div class="line">Error: Looks like <span class="string">"https://kubernetes-charts.storage.googleapis.com"</span> is not a valid chart repository or cannot be reached: Get https://kubernetes-charts.storage.googleapis.com/index.yaml: <span class="built_in">read</span> tcp 10.1.87.80:41084-&gt;172.217.163.240:443: <span class="built_in">read</span>: connection reset by peer</div></pre></td></tr></table></figure><p>æ·»åŠ å›½å†…æº </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm init --client-only --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span></div></pre></td></tr></table></figure><p>å¦‚æœæŠ¥å¦‚ä¸‹é”™è¯¯ï¼Œè¯·æŒ‰ç…§ä¸‹é¢è§£å†³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Error: Couldn<span class="string">'t load repositories file (/home/docker/.helm/repository/repositories.yaml).</span></div><div class="line"><span class="string">You might need to run `helm init` (or `helm init --client-only` if tiller is already installed)</span></div></pre></td></tr></table></figure><p>è§£å†³åŠæ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">helm init --client-only --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</div></pre></td></tr></table></figure><p>â€“stable-repo-url æŒ‡å®šä¸‹è½½è½¯ä»¶ä»é‚£ä¸ªæºä¸‹è½½ï¼Œé»˜è®¤çš„æ˜¯ä»googleä¸‹è½½ï¼Œå›½å†…ä¸‹è½½ä¸ä¸‹æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬æŒ‡å®šæºä¸ºé˜¿é‡Œäº‘çš„æºã€‚</p><p>ä¸‹è½½å®Œä¹‹åæˆ‘ä»¬è¿˜æŠŠæºæ›´æ¢å›æ¥ï¼Œè¦ä¸ç„¶åé¢ä¼šæŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm init --service-account tiller --tiller-image \</span></div><div class="line">registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.12.3 \</div><div class="line">--stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</div></pre></td></tr></table></figure><p>æ›´æ–° helm æº </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm repo update</span></div><div class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</div><div class="line">...Skip <span class="built_in">local</span> chart repository</div><div class="line">...Successfully got an update from the <span class="string">"stable"</span> chart repository</div><div class="line">...Successfully got an update from the <span class="string">"rancher-stable"</span> chart repository</div><div class="line">Update Complete. âˆ Happy Helming!âˆ</div></pre></td></tr></table></figure><p>helm å®˜æ–¹å¯ç”¨çš„<a href="https://hub.kubeapps.com/" target="_blank" rel="external">Chartåˆ—è¡¨</a> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm search jenkins  # æœç´¢åº”ç”¨</span></div><div class="line"><span class="comment"># helm inspect stable/jenkins  # æŸ¥çœ‹ä½¿ç”¨é…ç½®ä¿¡æ¯</span></div><div class="line"><span class="comment"># helm install --name mem1 stable/memcached # å®‰è£…Memcached</span></div><div class="line"><span class="comment"># kubectl get pods --namespace default -l "app=mem1-memcached" -o jsonpath="&#123;.items[0].metadata.name&#125;" mem1-memcached-0 #éªŒè¯</span></div></pre></td></tr></table></figure><h3 id="helm-å¸¸ç”¨å‘½ä»¤"><a href="#helm-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="helm å¸¸ç”¨å‘½ä»¤"></a>helm å¸¸ç”¨å‘½ä»¤</h3><p>release ç®¡ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">insstall</div><div class="line">delete</div><div class="line">upgrade/rollback</div><div class="line">list</div><div class="line"><span class="built_in">history</span></div><div class="line">status è·å–release çŠ¶æ€ä¿¡æ¯</div></pre></td></tr></table></figure><p>chart ç®¡ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">crate</div><div class="line">fetch </div><div class="line">get </div><div class="line">inspect</div><div class="line">package</div><div class="line">verify</div></pre></td></tr></table></figure><p>chart get åˆ°æœ¬åœ°è·¯å¾„ <code>/root/.helm/cache/archive</code></p><p>æ ¹æ®è‡ªå®šä¹‰å˜é‡åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm install --name redis1 -f values.yaml stable/redis</span></div><div class="line"><span class="comment"># helm status redis1 # å†æ¬¡æ˜¾ç¤ºNOTES</span></div></pre></td></tr></table></figure><h2 id="éƒ¨ç½²EFK-æ—¥å¿—ç³»ç»Ÿ"><a href="#éƒ¨ç½²EFK-æ—¥å¿—ç³»ç»Ÿ" class="headerlink" title="éƒ¨ç½²EFK æ—¥å¿—ç³»ç»Ÿ"></a>éƒ¨ç½²EFK æ—¥å¿—ç³»ç»Ÿ</h2><h3 id="éƒ¨ç½²elasticsearch"><a href="#éƒ¨ç½²elasticsearch" class="headerlink" title="éƒ¨ç½²elasticsearch"></a>éƒ¨ç½²elasticsearch</h3><p>EFK: Fluentd </p><p>åœ¨å®¹å™¨é›†ç¾¤å²©è°ƒï¼Œå†æ¥å…¥PodæŸ¥è¯¢æ—¥å¿—æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥å¿…è¦çš„æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿ;<br>ä¸€ä¸ªå®Œæ•´çš„kubernetesç³»ç»Ÿåº”è¯¥æœ‰:kubedns or coredns ,ingress-contraler,heapster or metracs server prometheus  , dashboard ã€‚è€ŒEFKæ˜¯ä¸€ä¸ªkubernetesåŸºæœ¬ä¸Šéœ€è¦æä¾›çš„å®Œæ•´ç»„ä»¶;</p><p>æ·»åŠ helmæº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm repo add extra https://burdenbear.github.io/kube-charts-mirror/</span></div><div class="line"><span class="comment"># helm repo add stable http://mirror.azure.cn/kubernetes/charts/ </span></div><div class="line"><span class="comment"># helm repo add incubator http://mirror.azure.cn/kubernetes/charts-incubator/</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  helm fetch stable/elasticsearch</span></div><div class="line"><span class="comment"># helm fetch stable/fluentd-elasticsearch</span></div><div class="line"><span class="comment">#  helm fetch stable/kibana</span></div><div class="line"><span class="comment"># tar -xvf elasticsearch-1.28.5.tgz</span></div><div class="line"><span class="comment">#  tar -xvf fluentd-elasticsearch-2.0.7.tgz</span></div><div class="line"><span class="comment">#  tar -xvf kibana-3.1.0.tgz</span></div><div class="line"><span class="comment"># cd elasticsearch</span></div><div class="line"><span class="comment">#  vim values.yaml # ä¿®æ”¹ä»¥ä¸‹å†…å®¹ </span></div><div class="line">  pullPolicy: <span class="string">"IfNotPresent"</span></div><div class="line">    persistence:</div><div class="line">    enabled: <span class="literal">false</span></div><div class="line"><span class="comment"># kubectl create namespace efk</span></div><div class="line"><span class="comment"># helm package elasticsearch/</span></div><div class="line"><span class="comment"># æ–°å¼€å¯ä¸€ä¸ªç»ˆç«¯</span></div><div class="line"><span class="comment"># helm serve</span></div><div class="line">Regenerating index. This may take a moment.</div><div class="line">Now serving you on 127.0.0.1:8879</div><div class="line"></div><div class="line"><span class="comment"># helm install --name els1 --namespace=efk  local/elasticsearch</span></div></pre></td></tr></table></figure><p>æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl run cirror-$RANDOM --rm -it --image=cirros -- /bin/sh</span></div><div class="line">/ <span class="comment"># nslookup els1-elasticsearch-client.efk.svc</span></div><div class="line">Server:    10.96.0.10</div><div class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</div><div class="line"></div><div class="line">Name:      els1-elasticsearch-client.efk.svc</div><div class="line">Address 1: 10.111.159.57 els1-elasticsearch-client.efk.svc.cluster.local</div><div class="line">curl els1-elasticsearch-client.efk.svc.cluster.local:9200</div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span> : <span class="string">"els1-elasticsearch-client-787568fb55-9zd9k"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"_na_"</span>,</div><div class="line">  <span class="string">"version"</span> : &#123;</div><div class="line">    <span class="string">"number"</span> : <span class="string">"6.4.3"</span>,</div><div class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</div><div class="line">    <span class="string">"build_type"</span> : <span class="string">"tar"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"fe40335"</span>,</div><div class="line">    <span class="string">"build_date"</span> : <span class="string">"2018-10-30T23:17:19.084789Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"7.4.0"</span>,</div><div class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"5.6.0"</span>,</div><div class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"5.0.0"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div><div class="line">/ <span class="comment"># curl els1-elasticsearch-client.efk.svc.cluster.local:9200/_cat/nodes</span></div><div class="line">10.244.1.215 15 90 7 0.12 0.36 0.35 di - els1-elasticsearch-data-1</div><div class="line">10.244.2.132 19 60 2 0.09 0.23 0.19 di - els1-elasticsearch-data-0</div><div class="line">10.244.1.213 22 90 7 0.12 0.36 0.35 i  - els1-elasticsearch-client-787568fb55-9zd9k</div><div class="line">10.244.2.131 26 60 2 0.09 0.23 0.19 i  - els1-elasticsearch-client-787568fb55-sxhhp</div><div class="line">10.244.1.214 44 90 7 0.12 0.36 0.35 mi * els1-elasticsearch-master-0</div></pre></td></tr></table></figure><h3 id="éƒ¨ç½²-fluentd"><a href="#éƒ¨ç½²-fluentd" class="headerlink" title="éƒ¨ç½² fluentd"></a>éƒ¨ç½² fluentd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># cd fluentd-elasticsearch/ </span></div><div class="line"><span class="comment"># vim values.yaml</span></div><div class="line">image:</div><div class="line">  repository: registry.cn-hangzhou.aliyuncs.com/google_containers/fluentd-elasticsearch</div><div class="line">elasticsearch:</div><div class="line">  host: <span class="string">'els1-elasticsearch-client.efk.svc.cluster.local'</span></div><div class="line">  port: 9200</div><div class="line">  scheme: <span class="string">'http'</span></div><div class="line">  ssl_version: TLSv1_2</div><div class="line">  buffer_chunk_limit: 2M</div><div class="line">  buffer_queue_limit: 8</div><div class="line">  logstash_prefix: <span class="string">'logstash'</span></div><div class="line">tolerations:</div><div class="line">   - key: node-role.kubernetes.io/master</div><div class="line">     operator: Exists</div><div class="line">     effect: NoSchedule</div><div class="line">podAnnotations:</div><div class="line">   prometheus.io/scrape: <span class="string">"true"</span></div><div class="line">   prometheus.io/port: <span class="string">"24231"</span></div><div class="line">service:</div><div class="line">   <span class="built_in">type</span>: ClusterIP</div><div class="line">   ports:</div><div class="line">     - name: <span class="string">"monitor-agent"</span></div><div class="line">       port: 24231</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># helm package ../fluentd-elasticsearch/</span></div><div class="line"><span class="comment"># helm install --name flu1 --namespace=efk local/fluentd-elasticsearch</span></div></pre></td></tr></table></figure><h3 id="å®‰è£…-kibana"><a href="#å®‰è£…-kibana" class="headerlink" title="å®‰è£… kibana"></a>å®‰è£… kibana</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd kibana</span></div><div class="line"><span class="comment"># vim values.yaml # ä¿®æ”¹ä»¥ä¸‹å†…å®¹  </span></div><div class="line">    elasticsearch.hosts: http://els1-elasticsearch-client.efk.svc.cluster.local:9200</div><div class="line">    service:</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line"><span class="comment"># helm package ../kibana/</span></div><div class="line"><span class="comment"># helm  install --name kibana1 --namespace=efk local/kibana</span></div><div class="line"><span class="comment"># kubectl get pods -n efk</span></div><div class="line">NAME                                         READY   STATUS    RESTARTS   AGE</div><div class="line">els1-elasticsearch-client-6b4b8c7485-7grbt   1/1     Running   0          96m</div><div class="line">els1-elasticsearch-client-6b4b8c7485-sqgtl   1/1     Running   0          96m</div><div class="line">els1-elasticsearch-data-0                    1/1     Running   0          96m</div><div class="line">els1-elasticsearch-data-1                    1/1     Running   0          78m</div><div class="line">els1-elasticsearch-master-0                  1/1     Running   0          96m</div><div class="line">els1-elasticsearch-master-1                  1/1     Running   0          93m</div><div class="line">els1-elasticsearch-master-2                  1/1     Running   0          78m</div><div class="line">flu1-fluentd-elasticsearch-95b95             1/1     Running   0          26m</div><div class="line">flu1-fluentd-elasticsearch-vpcsg             1/1     Running   0          26m</div><div class="line">flu1-fluentd-elasticsearch-w5wjj             1/1     Running   0          26m</div><div class="line">flu1-fluentd-elasticsearch-xkpv2             1/1     Running   0          26m</div><div class="line">kibana1-5dcf5f5d47-rsmqb                     1/1     Running   0          21m</div><div class="line"><span class="comment"># kubectl  get svc -n efk</span></div><div class="line">NAME                           TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</div><div class="line">els1-elasticsearch-client      ClusterIP   10.98.8.75    &lt;none&gt;        9200/TCP        97m</div><div class="line">els1-elasticsearch-discovery   ClusterIP   None          &lt;none&gt;        9300/TCP        97m</div><div class="line">kibana1                        NodePort    10.96.230.3   &lt;none&gt;        443:31746/TCP   21m</div></pre></td></tr></table></figure><h3 id="docker-pull-æŠ¥é”™ä¿¡æ¯æ€»ç»“"><a href="#docker-pull-æŠ¥é”™ä¿¡æ¯æ€»ç»“" class="headerlink" title="docker pull æŠ¥é”™ä¿¡æ¯æ€»ç»“"></a>docker pull æŠ¥é”™ä¿¡æ¯æ€»ç»“</h3><p><code>error pulling image configuration</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># echo &quot;DOCKER_OPTS=\&quot;\$DOCKER_OPTS --registry-mirror=http://f2d6cb40.m.daocloud.io\&quot;&quot; | tee -a /etc/default/docker</div><div class="line"># æˆ–è€… vim /etc/default/docker æ›´æ”¹ä»¥ä¸‹ä¿¡æ¯</div><div class="line">DOCKER_OPTS=&quot;$&#123;DOCKER_OPTS&#125; --registry-mirror=https://mirror.gcr.io&quot;</div><div class="line"># systemctl restart docker</div></pre></td></tr></table></figure><h3 id="é…ç½®å¹¶è®¿é—®kibana"><a href="#é…ç½®å¹¶è®¿é—®kibana" class="headerlink" title="é…ç½®å¹¶è®¿é—®kibana"></a>é…ç½®å¹¶è®¿é—®kibana</h3><p><img src="/images/kubernetes-helm-efk-kibana.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(å…­)</title>
      <link href="/2019/05/30/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%956/"/>
      <url>/2019/05/30/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%956/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•å…­"><a href="#kubernetes-æ“ä½œè®°å½•å…­" class="headerlink" title="kubernetes æ“ä½œè®°å½•å…­"></a>kubernetes æ“ä½œè®°å½•å…­</h1><p><img src="/images/docker_kubernetes.png" alt=""></p><h2 id="è°ƒåº¦å™¨ã€é¢„é€‰ç­–ç•¥åŠä¼˜é€‰å‡½æ•°"><a href="#è°ƒåº¦å™¨ã€é¢„é€‰ç­–ç•¥åŠä¼˜é€‰å‡½æ•°" class="headerlink" title="è°ƒåº¦å™¨ã€é¢„é€‰ç­–ç•¥åŠä¼˜é€‰å‡½æ•°"></a>è°ƒåº¦å™¨ã€é¢„é€‰ç­–ç•¥åŠä¼˜é€‰å‡½æ•°</h2><p>æ•´ä¸ªè°ƒåº¦å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹: Predicate(é¢„å…ˆ) â€“&gt; Priority(ä¼˜é€‰) â€“&gt; Select(é€‰å®š)</p><hr><p>è°ƒåº¦å™¨:<br>    é¢„é€‰ç­–ç•¥:<br>        CheckNodeCondition: æ£€æŸ¥èŠ‚ç‚¹æœ¬èº«æ˜¯å¦æ­£å¸¸;<br>        GeneralPredicates:<br>            HostName:  æ£€æŸ¥Podå¯¹è±¡æ˜¯å¦å®šä¹‰äº† pod.spec.hostname,<br>            PodFitsHostPorts:pods.spec.containers.ports.hostPort<br>            MatchNodeSelector: pods.sepc.nodeSelector<br>            PodFitsResources: æ£€æŸ¥Podçš„èµ„æºéœ€æ±‚æ˜¯å¦èƒ½è¢«èŠ‚ç‚¹çš„éœ€æ±‚æ‰€æ»¡è¶³<br>        NoDiskConflicts:æ£€æŸ¥Podä¾èµ–çš„å­˜å‚¨å·æ˜¯å¦èƒ½æ»¡è¶³éœ€æ±‚;<br>        PodToleratesNodeTaints: æ£€æŸ¥Podä¸Šçš„spec.tolerationså¯å®¹å¿çš„æ±¡ç‚¹æ˜¯å¦å®Œå…¨åŒ…å«èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹;<br>        PodToleratesNodeNoExecuteTaints:  ä¸èƒ½æ‰§è¡Œçš„æ±¡ç‚¹,è¿™ä¸ªé¢„é€‰ç­–ç•¥é»˜è®¤æ˜¯ä¸æ£€æŸ¥çš„;<br>        CheckNodeLabelPresence: æ£€æŸ¥èŠ‚ç‚¹æŒ‡å®šæ ‡ç­¾çš„å­˜åœ¨æ€§;<br>        CheckServiceAffinity: æŠŠè¿™ä¸ªPodè°ƒåº¦åˆ°å®ƒæ‰€å±çš„Service,å·²ç»è°ƒåº¦å®Œæˆå…¶å®ƒPodæ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šå»;<br>        MaxEBSVolumeCount:<br>        MaxGCEPDVolumeCount:<br>        MaxAzureDiskVolumeCount:<br>        CheckVolumeBinding:<br>        NoVolumeZoneConflict:<br>        CheckNodeMemoryPressure:æ£€æŸ¥èŠ‚ç‚¹å†…å­˜èµ„æºæ˜¯å¦å¤„äºå‹åŠ›è¿‡å¤§çš„çŠ¶æ€;<br>        CheckNodePidPressure:æ£€æŸ¥PIdçŠ¶æ€æ˜¯å¦ç´§ç¼º;<br>        CheckNodeDiskPressure:<br>        MatchInterPodAffity:</p><hr><p>ä¼˜é€‰å‡½æ•°<br>    LeastRequested:<br>        (cpu(capacity-sum(requested))*10/capacity)+memory((capacity-sum(requested))*10/capacity))/2<br>    BalancedResourceAllocation:<br>        CPUå’Œå†…å­˜èµ„æºè¢«å ç”¨ç‡ç›¸è¿‘çš„èƒœå‡º;<br>    NodePreferAvoidPods:<br>        èŠ‚ç‚¹æ³¨è§£ä¿¡æ¯â€scheduler .alpha.kubernetes.io/preferAvoidPodsâ€<br>    TaintToleration: å°†Podå¯¹è±¡çš„spec.tolerationsåˆ—è¡¨é¡¹ä¸èŠ‚ç‚¹çš„taintsåˆ—è¡¨é¡¹è¿›è¡ŒåŒ¹é…åº¦æ£€æŸ¥ï¼ŒåŒ¹é…æ¡ç›®è¶Šå¤šï¼Œå¾—åˆ†è¶Šä½;<br>    SelectorSpreading: æ ‡ç­¾é€‰æ‹©å™¨çš„åˆ†æ•£åº¦ï¼Œä¸å½“å‰Podå¯¹è±¡åŒå±çš„æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹©é€‚é…çš„å…¶å®ƒPodçš„å¯¹è±¡æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œè¶Šå¤šçš„ï¼Œå¾—åˆ†è¶Šåº•ï¼Œå¦åˆ™å¾—åˆ†è¶Šé«˜;<br>    InterPodAffinity: éå†Podçš„äº²å’Œæ€§æ¡ç›®ï¼Œå¹¶å°†é‚£äº›èƒ½å¤ŸåŒ¹é…åˆ°ç»™å®šèŠ‚ç‚¹çš„æ¡ç›®ç›¸åŠ ï¼Œç»“æœå€¼è¶Šå¤§ï¼Œå¾—åˆ†è¶Šä½;<br>    NodeAffinity:  æ ¹æ®NodeSelecterè¿›è¡ŒåŒ¹é…åº¦æ£€æŸ¥ï¼Œèƒ½æˆåŠŸåŒ¹é…çš„è¶Šå¤šï¼Œå¾—åˆ†å°±è¶Šé«˜;<br>    MostRequested:  ç©ºé—²é‡è¶Šå°çš„ï¼Œå¾—åˆ†è¶Šå¤§ã€‚ä»–ä¼šå°½é‡æŠŠä¸€ä¸ªèŠ‚ç‚¹çš„èµ„æºå…ˆç”¨å®Œ;<br>    NodeLabel: æ ‡ç­¾è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜;<br>    ImageLocality: æ­¤èŠ‚ç‚¹æ˜¯å¦æœ‰æ­¤Pod æ‰€éœ€è¦çš„é•œåƒï¼Œæ‹¥æœ‰é•œåƒè¶Šå¤šçš„ï¼Œå¾—åˆ†è¶Šé«˜ï¼Œè€Œå®ƒæ˜¯æ ¹æ®é•œåƒä½“ç§¯å¤§å°ä¹‹å’Œæ¥è®¡ç®—çš„;</p><hr><h2 id="kubernetes-é«˜çº§è°ƒåº¦æ–¹å¼"><a href="#kubernetes-é«˜çº§è°ƒåº¦æ–¹å¼" class="headerlink" title="kubernetes é«˜çº§è°ƒåº¦æ–¹å¼"></a>kubernetes é«˜çº§è°ƒåº¦æ–¹å¼</h2><p>èŠ‚ç‚¹é€‰æ‹©å™¨: nodeSelector, nodeName<br>èŠ‚ç‚¹äº²å’Œæ€§è°ƒåº¦: nodeAffinity</p><p>æ³¨: å½“è°ƒåº¦é€‰æ‹©å™¨é€‰æ‹©äº†ä¸å­˜çš„æ ‡ç­¾æ—¶ï¼ŒPod ä¼šæˆä¸ºPendingçŠ¶æ€<br>  nodeSelector:<br>    disktype: harddisk</p><p>   èŠ‚ç‚¹äº²å’Œæ€§è°ƒåº¦;</p><p>   ç¡¬äº²å’Œ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-nodeaffinity-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-node-affinity-demo</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">  affinity:</span></div><div class="line"><span class="attr">    nodeAffinity:</span></div><div class="line"><span class="attr">      requiredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line"><span class="attr">        nodeSelectorTerms:</span></div><div class="line"><span class="attr">        - matchExpressions:</span></div><div class="line"><span class="attr">          - key:</span> <span class="string">zone</span></div><div class="line"><span class="attr">            operator:</span> <span class="string">In</span></div><div class="line"><span class="attr">            values:</span></div><div class="line"><span class="bullet">            -</span> <span class="string">foo</span></div><div class="line"><span class="bullet">            -</span> <span class="string">bar</span></div></pre></td></tr></table></figure><p>è½¯äº²å’Œ</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vIm  pod-nodeaffinity-demo-2.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-node-affinity-demo-2</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">  affinity:</span></div><div class="line"><span class="attr">    nodeAffinity:</span></div><div class="line"><span class="attr">      preferredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line"><span class="attr">      - preference:</span></div><div class="line"><span class="attr">          matchExpressions:</span></div><div class="line"><span class="attr">          - key:</span> <span class="string">zone</span></div><div class="line"><span class="attr">            operator:</span> <span class="string">In</span></div><div class="line"><span class="attr">            values:</span></div><div class="line"><span class="bullet">            -</span> <span class="string">foo</span></div><div class="line"><span class="bullet">            -</span> <span class="string">bar</span></div><div class="line"><span class="attr">        weight:</span> <span class="number">60</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-required-affinity-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-first</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-second</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">backend</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">db</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></div><div class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    command:</span> <span class="string">["sh","-c","sleep</span> <span class="number">3600</span><span class="string">"]</span></div><div class="line"><span class="string">  affinity:</span></div><div class="line"><span class="string">    podAffinity:</span></div><div class="line"><span class="string">      requiredDuringSchedulingIgnoredDuringExecution:</span></div><div class="line"><span class="string">      - labelSelector:</span></div><div class="line"><span class="string">          matchExpressions:</span></div><div class="line"><span class="string">          - &#123;key: app, operator: In, values: ["</span><span class="string">myapp"]&#125;</span></div><div class="line"><span class="attr">        topologyKey:</span> <span class="string">kubernetes.io/hostname</span></div></pre></td></tr></table></figure><p>æ³¨: <code>podAntiAffinity</code>  ä¸€å®šä¸ä¼šè°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹ä¸Š </p><p>taint çš„effectå®šä¹‰å¯¹Podæ’æ–¥æ•ˆæœ:<br>    NoSchedule:  ä»…å½±å“è°ƒåº¦è¿‡ç¨‹ï¼Œå¯¹ç°å­˜çš„Podå¯¹è±¡ä¸äº§ç”Ÿå½±å“;<br>    NoExecute: æ—¢å½±å“è°ƒåº¦è¿‡ç¨‹ï¼Œä¹Ÿå½±å“ç°å­˜çš„Podå¯¹è±¡; ä¸å®¹å¿çš„Podå¯¹è±¡å°†è¢«é©±é€;<br>    PreferNoSchedule: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl taint node node01 node-type=production:NoSchedule</span></div><div class="line"><span class="comment"># kubectl  taint node  node02 node-type=dev:NoExecute</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp-deploy</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">5</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">      release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        image:</span> <span class="string">ikubernetes/myapp:v2</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">      tolerations:</span></div><div class="line"><span class="attr">      - key:</span> <span class="string">"node-type"</span></div><div class="line"><span class="attr">        operator:</span> <span class="string">"Equal"</span></div><div class="line"><span class="attr">        value:</span> <span class="string">"production"</span> </div><div class="line"><span class="attr">        effect:</span> <span class="string">"NoSchedule"</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">tolerations:</span></div><div class="line"><span class="attr">- key:</span> <span class="string">"node-type"</span></div><div class="line"><span class="attr">  operator:</span> <span class="string">"Equal"</span></div><div class="line"><span class="attr">  value:</span> <span class="string">"production"</span> </div><div class="line"><span class="attr">  effect:</span> <span class="string">"NoExecute"</span></div><div class="line"><span class="attr">  tolerationSeconds:</span> <span class="number">3600</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">tolerations:</span></div><div class="line"><span class="attr">- key:</span> <span class="string">"node-type"</span></div><div class="line"><span class="attr">  operator:</span> <span class="string">"Exists"</span></div><div class="line"><span class="attr">  value:</span> <span class="string">""</span></div><div class="line"><span class="attr">  effect:</span> <span class="string">"NoExecute"</span></div></pre></td></tr></table></figure><h2 id="å®¹å™¨èµ„æºéœ€æ±‚ã€é™åˆ¶ã€åŠHeapSter"><a href="#å®¹å™¨èµ„æºéœ€æ±‚ã€é™åˆ¶ã€åŠHeapSter" class="headerlink" title="å®¹å™¨èµ„æºéœ€æ±‚ã€é™åˆ¶ã€åŠHeapSter"></a>å®¹å™¨èµ„æºéœ€æ±‚ã€é™åˆ¶ã€åŠHeapSter</h2><p>requests: éœ€æ±‚ï¼Œæœ€ä½ä¿éšœ;<br>limits: é™åˆ¶ï¼Œç¡¬é™åˆ¶;<br>limits ä¸€èˆ¬å¤§äºç­‰äº requests</p><p>CPU:  1é¢—é€»è¾‘CPU<br>           1é€»è¾‘æ ¸å¿ƒ=1000,millicores<br>                     500m = 0.5CPU<br>å†…å­˜:<br>        Eã€Pã€Tã€Gã€Mã€K<br>        Eiã€Pi</p><p>å–æ¶ˆèŠ‚ç‚¹æ±¡ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl taint node node01  node-type-</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-demo</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">renjin</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/stress-ng</span></div><div class="line"><span class="attr">    command:</span> <span class="string">["/usr/bin/stress-ng",</span> <span class="string">"-c 1"</span><span class="string">,</span> <span class="string">"--metrics-brief"</span><span class="string">]</span></div><div class="line"><span class="attr">    resources:</span></div><div class="line"><span class="attr">      requests:</span></div><div class="line"><span class="attr">        cpu:</span> <span class="string">"500m"</span></div><div class="line"><span class="attr">        memory:</span> <span class="string">"128Mi"</span></div><div class="line"><span class="attr">      limits:</span></div><div class="line"><span class="attr">        cpu:</span> <span class="string">"500m"</span></div><div class="line"><span class="attr">        memory:</span> <span class="string">"512Mi"</span></div></pre></td></tr></table></figure><p>QoS:<br>    Guranteed: æ¯ä¸ªå®¹å™¨åŒæ—¶è®¾ç½®CPUå’Œå†…åœ¨çš„requestså’Œlimits,<br>    cpu.limits=cpu.requests memory.limits=memory.request<br>    Burstable:è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨è®¾ç½®CPUæˆ–å†…å­˜èµ„æºçš„requests<br>    BestEffort:  æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå®¹å™¨è®¾ç½®äº†requestsæˆ–limitså±æ€§;æœ€ä½ä¼˜å…ˆçº§åˆ«; æ˜¯è‡ªåŠ¨é…ç½®çš„;</p><h3 id="é…ç½®influxdb"><a href="#é…ç½®influxdb" class="headerlink" title="é…ç½®influxdb"></a>é…ç½®influxdb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">    <span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/influxdb/influxdb.yaml</span></div><div class="line">   <span class="comment"># æ›´æ”¹ä»¥ä¸‹å†…å®¹</span></div><div class="line">   apiVersion: apps/v1</div><div class="line">   </div><div class="line">   spec:</div><div class="line">  replicas: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      task: monitoring</div><div class="line">      k8s-app: influxdb   </div><div class="line">        </div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: influxdb</div><div class="line">        image: registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-influxdb-amd64:v1.5.2</div><div class="line"><span class="comment">#  kubectl apply -f influxdb.yaml</span></div></pre></td></tr></table></figure><h3 id="é…ç½®heapster-rbac"><a href="#é…ç½®heapster-rbac" class="headerlink" title="é…ç½®heapster-rbac"></a>é…ç½®heapster-rbac</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml</span></div><div class="line"><span class="comment"># kubectl  apply -f heapster-rbac.yaml</span></div></pre></td></tr></table></figure><h3 id="é…ç½®heapster"><a href="#é…ç½®heapster" class="headerlink" title="é…ç½®heapster"></a>é…ç½®heapster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/influxdb/heapster.yaml</span></div><div class="line"><span class="comment"># ä¿®æ”¹ä»¥ä¸‹å†…å®¹</span></div><div class="line">apiVersion: apps/v1</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      task: monitoring</div><div class="line">      k8s-app: heapster</div><div class="line">image: registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-amd64:v1.5.4</div><div class="line">spec:</div><div class="line">  ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 8082</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line"><span class="comment"># kubectl  apply -f heapster.yaml</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get svc -n kube-system</span></div><div class="line">NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE</div><div class="line">heapster               NodePort    10.101.89.141   &lt;none&gt;        80:31261/TCP             63s</div><div class="line">kube-dns               ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   48d</div><div class="line">kubernetes-dashboard   NodePort    10.103.25.80    &lt;none&gt;        443:30660/TCP            21d</div><div class="line">monitoring-influxdb    ClusterIP   10.103.131.36   &lt;none&gt;        8086/TCP                 153m</div></pre></td></tr></table></figure><p>çœ‹ä¸‹å›¾è¯´æ˜ï¼Œheapsteræ­¤æ—¶å¯ä»¥è°ƒé€š</p><p><img src="/images/kubernetes-heapster-404.png" alt=""></p><h3 id="grafanaé…ç½®"><a href="#grafanaé…ç½®" class="headerlink" title="grafanaé…ç½®"></a>grafanaé…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes-retired/heapster/master/deploy/kube-config/influxdb/grafana.yaml</span></div><div class="line"><span class="comment"># vim grafana.yaml # ä¿®æ”¹ä»¥ä¸‹å†…å®¹</span></div><div class="line">apiVersion: apps/v1</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      task: monitoring</div><div class="line">      k8s-app: grafana</div><div class="line">      image: registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-grafana-amd64:v5.0.4</div><div class="line">        ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 3000</div><div class="line">  <span class="built_in">type</span>: NodePort</div><div class="line"><span class="comment"># kubectl apply -f grafana.yaml</span></div></pre></td></tr></table></figure><p><img src="/images/kubernetes-grafana-test.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(äº”)</title>
      <link href="/2019/05/24/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%955/"/>
      <url>/2019/05/24/kubernetes%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%955/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•äº”"><a href="#kubernetes-æ“ä½œè®°å½•äº”" class="headerlink" title="kubernetes æ“ä½œè®°å½•äº”"></a>kubernetes æ“ä½œè®°å½•äº”</h1><p><img src="/images/docker_kubernetes.png" alt=""></p><h2 id="é…ç½®ç½‘ç»œæ’ä»¶flannel"><a href="#é…ç½®ç½‘ç»œæ’ä»¶flannel" class="headerlink" title="é…ç½®ç½‘ç»œæ’ä»¶flannel"></a>é…ç½®ç½‘ç»œæ’ä»¶flannel</h2><p>åœ¨Kubernetesé›†ç¾¤ä¸­è¦è§£å†³å››ç§é€šä¿¡çš„é—®é¢˜;<br>Kubernetesç½‘ç»œé€šä¿¡:<br>   (1) å®¹å™¨é—´é€šä¿¡: åŒä¸€ä¸ªPodå†…çš„å¤šä¸ªå®¹å™¨é—´çš„é€šä¿¡ï¼Œlo<br>   (2) Podé€šä¿¡: Pod IP &lt;â€“&gt; Pod IP<br>   (3) Podä¸ Serviceé€šä¿¡: PodIP &lt;â€“&gt; ClusterIP,ä¸åœ¨åŒä¸€ç½‘æ®µï¼Œé€šè¿‡iptablesè§„åˆ™å®ç°é€šä¿¡<br>   (4) Service ä¸é›†ç¾¤å¤–éƒ¨å®¢æˆ·ç«¯çš„é€šä¿¡;<br>CNI: (Container Network Interface)<br>      flannel,calico,canel,kube-router â€¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get configmap kube-proxy -n kube-system -o yaml</span></div><div class="line">mode: <span class="string">""</span> <span class="comment"># æ”¹ä¸ºipvs å°±å¯ä»¥äº†</span></div></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆ:<br>    è™šæ‹Ÿç½‘æ¡¥:  çº¯è½¯ä»¶çš„æ–¹å¼ï¼Œå®ç°ä¸€ä¸ªè™šæ‹Ÿç½‘å¡æ¥åˆ°ç½‘æ¡¥ä¸Šå»;<br>    å¤šè·¯å¤ç”¨: MacVlAN é…ç½®å¤šä¸ªMacç‰©ç†åœ°å€ï¼Œä½¿å¾—ä¸€ä¸ªç‰©ç†ç½‘å¡ï¼Œå¯ä»¥æ‰¿è½½å¤šä¸ªå®¹å™¨å»ä½¿ç”¨;<br>    ç¡¬ä»¶äº¤æ¢: SR-IOV å•æ ¹IOè™šæ‹ŸåŒ–;<br>    kubelet, /etc/cin/net.d/</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># cat /etc/cni/net.d/10-flannel.conflist</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;cbr0&quot;,</div><div class="line">  &quot;plugins&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;type&quot;: &quot;flannel&quot;,</div><div class="line">      &quot;delegate&quot;: &#123;</div><div class="line">        &quot;hairpinMode&quot;: true,</div><div class="line">        &quot;isDefaultGateway&quot;: true</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;type&quot;: &quot;portmap&quot;,</div><div class="line">      &quot;capabilities&quot;: &#123;</div><div class="line">        &quot;portMappings&quot;: true</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>flannel:<br>    æ”¯æŒå¤šç§åç«¯<br>        VxLAN<br>        host-gw: Host Gateway</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get daemonset -n kube-system</span></div><div class="line">NAME                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                     AGE</div><div class="line">kube-flannel-ds           3         3         3       3            3           beta.kubernetes.io/arch=amd64     31d</div><div class="line">kube-flannel-ds-amd64     4         4         4       4            4           beta.kubernetes.io/arch=amd64     31d</div><div class="line">kube-flannel-ds-arm       0         0         0       0            0           beta.kubernetes.io/arch=arm       31d</div><div class="line">kube-flannel-ds-arm64     0         0         0       0            0           beta.kubernetes.io/arch=arm64     31d</div><div class="line">kube-flannel-ds-ppc64le   0         0         0       0            0           beta.kubernetes.io/arch=ppc64le   31d</div><div class="line">kube-flannel-ds-s390x     0         0         0       0            0           beta.kubernetes.io/arch=s390x     31d</div><div class="line">kube-proxy                4         4         4       4            4           &lt;none&gt;                            31d</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get pods -n kube-system -o wide | grep "flannel"</span></div><div class="line">kube-flannel-ds-amd64-45rhc                  1/1     Running   2          31d    10.1.87.80     bj-zb-vm-ops-test5     &lt;none&gt;           &lt;none&gt;</div><div class="line">kube-flannel-ds-amd64-4cs6r                  1/1     Running   0          31d    10.1.87.83     node03   &lt;none&gt;           &lt;none&gt;</div><div class="line">kube-flannel-ds-amd64-bst7g                  1/1     Running   0          31d    10.1.87.81     node01   &lt;none&gt;           &lt;none&gt;</div><div class="line">kube-flannel-ds-amd64-gqvz2                  1/1     Running   0          31d    10.1.87.82     node02   &lt;none&gt;           &lt;none&gt;</div><div class="line">kube-flannel-ds-brzp7                        2/2     Running   0          31d    10.1.87.83     node03   &lt;none&gt;           &lt;none&gt;</div><div class="line">kube-flannel-ds-khpr5                        2/2     Running   2          31d    10.1.87.82     node02   &lt;none&gt;           &lt;none&gt;</div><div class="line">kube-flannel-ds-q6z65                        2/2     Running   0          31d    10.1.87.81     node01</div></pre></td></tr></table></figure><p>kube-flannel-cfg ç”¨æ¥é…ç½®ä»¥ä¸Šflannel Podæ˜¯å¦‚ä½•è¿è¡Œçš„;</p><p>flannelçš„é…ç½®å‚æ•°:<br>    Network: flannelä½¿ç”¨çš„CIDRæ ¼å¼çš„ç½‘ç»œåœ°å€ï¼Œç”¨äºä¸ºPodçš„é…ç½®ç½‘ç»œåŠŸèƒ½;<br>          10.244.0.0/16 -&gt;<br>                      master: 10.244.0.0/24<br>                      node01:10.244.1.0/24<br>                      â€¦<br>                    node255: 10.244.255.0./24<br>    SubnetLen: æŠŠNetworkåˆ‡åˆ†å­ç½‘ä¾›å„èŠ‚ç‚¹ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨å¤šé•¿çš„æ©ç è¿›è¡Œåˆ‡åˆ†ï¼Œé»˜è®¤ä¸º24ä½;<br>    SubnetMin: 10.244.10.0/24 æŒ‡å®šå­ç½‘ä½¿ç”¨èµ·å§‹ï¼Œä»å“ªé‡Œå¼€å§‹;<br>    SubnetMax: 10.244.10.0/24 æŒ‡å®šå­ç½‘ä½¿ç”¨æœ€å¤§é™åˆ¶;<br>    Backend: å„Podé€šä¿¡æ—¶ä½¿ç”¨ä»€ä¹ˆæ–¹å¼è¿›è¡Œé€šä¿¡: vxlan, host-gw , udp</p><hr><p>æµ‹è¯•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># kubectl get pods -o wide</div><div class="line"># kubectl  get pods -o wide | grep &quot;myapp-deploy&quot;</div><div class="line">myapp-deploy-675558bfc5-947g6    1/1     Running   0          4d1h    10.244.1.173   node01   &lt;none&gt;           &lt;none&gt;</div><div class="line">myapp-deploy-675558bfc5-9xfdm    1/1     Running   0          4d6h    10.244.3.176   node03   &lt;none&gt;           &lt;none&gt;</div><div class="line">myapp-deploy-675558bfc5-qhl4w    1/1     Running   0          5h41m   10.244.2.195   node02   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure><p>æ¥å…¥ä¸€ä¸ªå®¹å™¨pingå¦ä¸€å®¹å™¨çš„ip</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl exec -it myapp-deploy-675558bfc5-947g6 -- /bin/sh</span></div><div class="line">/ <span class="comment"># ping 10.244.2.195</span></div><div class="line">PING 10.244.2.195 (10.244.2.195): 56 data bytes</div><div class="line">64 bytes from 10.244.2.195: seq=0 ttl=62 time=0.871 ms</div><div class="line">64 bytes from 10.244.2.195: seq=1 ttl=62 time=0.925 ms</div><div class="line">64 bytes from 10.244.2.195: seq=2 ttl=62 time=0.886 ms</div><div class="line">64 bytes from 10.244.2.195: seq=3 ttl=62 time=1.171 ms</div></pre></td></tr></table></figure><p>åœ¨å®¹å™¨æ‰€åœ¨çš„ç‰©ç†æœåŠ¡å™¨ä¸ŠæŠ“åŒ…,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tcpdump -i cni0 -nn icmp</span></div><div class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</div><div class="line">listening on cni0, link-type EN10MB (Ethernet), capture size 262144 bytes</div><div class="line">16:52:45.457148 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 0, length 64</div><div class="line">16:52:45.457743 IP 10.244.2.195 &gt; 10.244.1.173: ICMP <span class="built_in">echo</span> reply, id 3328, seq 0, length 64</div><div class="line">16:52:46.457445 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 1, length 64</div><div class="line">16:52:46.457948 IP 10.244.2.195 &gt; 10.244.1.173: ICMP <span class="built_in">echo</span> reply, id 3328, seq 1, length 64</div><div class="line">16:52:47.457722 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 2, length 64</div><div class="line">16:52:47.458313 IP 10.244.2.195 &gt; 10.244.1.173: ICMP <span class="built_in">echo</span> reply, id 3328, seq 2, length 64</div><div class="line">16:52:48.458036 IP 10.244.1.173 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3328, seq 3, length 64</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tcpdump -i flannel.1 -nn</span></div><div class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</div><div class="line">listening on flannel.1, link-type EN10MB (Ethernet), capture size 262144 bytes</div><div class="line">17:01:13.757750 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 37, length 64</div><div class="line">17:01:13.758396 IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 2, seq 37, length 64</div><div class="line">17:01:14.758058 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 38, length 64</div><div class="line">17:01:14.758791 IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 2, seq 38, length 64</div><div class="line">17:01:15.758376 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 39, length 64</div><div class="line">17:01:15.759072 IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 2, seq 39, length 64</div><div class="line">17:01:16.758661 IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 2, seq 40, length 64</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tcpdump -i eth0 -nn host 10.1.87.82</span></div><div class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</div><div class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</div><div class="line">17:03:44.145010 IP 10.1.87.81.44247 &gt; 10.1.87.82.8472: OTV, flags [I] (0x08), overlay 0, instance 1</div><div class="line">IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3, seq 0, length 64</div><div class="line">17:03:44.145551 IP 10.1.87.82.8942 &gt; 10.1.87.81.8472: OTV, flags [I] (0x08), overlay 0, instance 1</div><div class="line">IP 10.244.2.195 &gt; 10.244.1.0: ICMP <span class="built_in">echo</span> reply, id 3, seq 0, length 64</div><div class="line">17:03:45.145300 IP 10.1.87.81.44247 &gt; 10.1.87.82.8472: OTV, flags [I] (0x08), overlay 0, instance 1</div><div class="line">IP 10.244.1.0 &gt; 10.244.2.195: ICMP <span class="built_in">echo</span> request, id 3, seq 1, length 64</div><div class="line">17:03:45.145854 IP 10.1.87.82.8942 &gt; 10.1.87.81.8472: OTV, flags [I] (0x08), overlay 0, instance 1</div></pre></td></tr></table></figure><h2 id="Flannel-VxLANçš„Direct-routingæ¨¡å¼é…ç½®"><a href="#Flannel-VxLANçš„Direct-routingæ¨¡å¼é…ç½®" class="headerlink" title="Flannel VxLANçš„Direct routingæ¨¡å¼é…ç½®"></a>Flannel VxLANçš„Direct routingæ¨¡å¼é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></div><div class="line"><span class="comment"># vim  kube-flannel.yml   </span></div><div class="line">net-conf.json: |</div><div class="line">    &#123;</div><div class="line">      <span class="string">"Network"</span>: <span class="string">"10.244.0.0/16"</span>,</div><div class="line">      <span class="string">"Backend"</span>: &#123;</div><div class="line">        <span class="string">"Type"</span>: <span class="string">"vxlan"</span>,</div><div class="line">        <span class="string">"Directrouting"</span>: <span class="literal">true</span>  <span class="comment"># æ·»åŠ å­—æ®µ</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"><span class="comment"># kubectl delete -f kube-flannel.yml</span></div><div class="line"><span class="comment"># kubectl apply -f kube-flannel.yml</span></div><div class="line"><span class="comment"># ip route show</span></div><div class="line">default via 10.1.87.1 dev eth0</div><div class="line">10.1.87.0/24 dev eth0 proto kernel scope link src 10.1.87.80</div><div class="line">10.244.0.0/24 dev cni0 proto kernel scope link src 10.244.0.1</div><div class="line">10.244.1.0/24 via 10.1.87.81 dev eth0</div><div class="line">10.244.2.0/24 via 10.1.87.82 dev eth0</div><div class="line">10.244.3.0/24 via 10.1.87.83 dev eth0</div></pre></td></tr></table></figure><p>æ³¨: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å¯ä»¥è¿™ä¹ˆåšï¼Œä¼šå½±å“åˆ°Podçš„ç½‘ç»œç¯å¢ƒã€‚ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬åœ¨ä½¿ç”¨å‰ä¼šè€ƒè™‘å¹¶åˆå§‹åŒ–å¥½ç½‘ç»œç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆä¿®æ”¹ flannel æ‰å¼€å§‹ä½¿ç”¨åˆ›å»ºPod;</p><hr><h2 id="calico-å®‰è£…ä½¿ç”¨"><a href="#calico-å®‰è£…ä½¿ç”¨" class="headerlink" title="calico å®‰è£…ä½¿ç”¨"></a>calico å®‰è£…ä½¿ç”¨</h2><p><a href="https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/canal/" target="_blank" rel="external">Canal/flannel Hosted Install å®˜æ–¹æ–‡æ¡£</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/canal/rbac.yaml</span></div><div class="line"><span class="comment"># kubectl apply -f https://docs.projectcalico.org/v3.0/getting-started/kubernetes/installation/hosted/canal/canal.yaml</span></div></pre></td></tr></table></figure><p>åˆ›å»ºåç§°ç©ºé—´<br>podSelector: {} ä¸ºç©ºæ—¶ï¼Œä»£è¡¨æ‰€æœ‰Pod<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create namespace dev</span></div><div class="line">namespace/dev created</div><div class="line"><span class="comment"># kubectl create namespace prod</span></div><div class="line">namespace/prod created</div><div class="line"><span class="comment"># vim ingress-def.yaml</span></div><div class="line">apiVersion: networking.k8s.io/v1</div><div class="line">kind: NetworkPolicy</div><div class="line">metadata:</div><div class="line">  name: deny-all-ingress</div><div class="line">spec:</div><div class="line">  podSelector: &#123;&#125;</div><div class="line">  policyTypes:</div><div class="line">  - Ingress</div><div class="line"><span class="comment"># kubectl apply -f ingress-def.yaml  -n dev</span></div><div class="line"><span class="comment"># kubectl  get netpol -n dev</span></div><div class="line">NAME               POD-SELECTOR   AGE</div><div class="line">deny-all-ingress   &lt;none&gt;         93s</div></pre></td></tr></table></figure></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-a.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod1</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="comment"># kubectl apply -f pod-a.yaml -n dev</span></div><div class="line"><span class="comment"># kubectl get pods -n dev -o wide</span></div><div class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></div><div class="line"><span class="string">pod1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">54</span><span class="string">s</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.2</span>   <span class="string">node03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></div></pre></td></tr></table></figure><p>è¿™æ˜¯è¯·æ±‚10.244.3.2  å‘ç°æ˜¯è¯·æ±‚ä¸é€šçš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl  10.244.3.2</span></div><div class="line">curl: (7) Failed connect to 10.244.3.2:80; Connection timed out</div></pre></td></tr></table></figure><p>è€ŒæŠŠ  pod-a.yaml åˆ›å»ºåœ¨prod åç§°ç©ºé—´ï¼Œæ­¤æ—¶prodåç§°ç©ºé—´æ˜¯æ²¡æœ‰å®šä¹‰çš„</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  apply -f pod-a.yaml -n prod</span></div><div class="line"><span class="string">pod/pod1</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl get pods -n prod -o wide</span></div><div class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></div><div class="line"><span class="string">pod1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">17</span><span class="string">s</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.3</span>   <span class="string">node03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;node</span></div></pre></td></tr></table></figure><p>è¯·æ±‚10.244.3.3åç§°ç©ºé—´çš„å¯ä»¥è¯·æ±‚é€š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># curl 10.244.3.3</div><div class="line">Hello MyApp | Version: v1 | &lt;a href=&quot;hostname.html&quot;&gt;Pod Name&lt;/a&gt;</div></pre></td></tr></table></figure><p>å½“å…è®¸devåç§°ç©ºé—´çš„Pod éƒ½å¯ä»¥è®¿é—®æ—¶ï¼Œåªéœ€åŠ    <code>ingress:   - {}</code> å°±å¯ä»¥äº†</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">deny-all-ingress</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  podSelector:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">  ingress:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">  policyTypes:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">Ingress</span></div><div class="line"><span class="comment"># kubectl apply -f ingress-def.yaml  -n dev</span></div><div class="line"><span class="comment"># curl  10.244.3.2</span></div><div class="line"><span class="string">Hello</span> <span class="string">MyApp</span> <span class="string">| Version: v1 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</span></div></pre></td></tr></table></figure><p>å®šä¹‰å…è®¸è®¿é—®ä¸€ç»„Pod,ä½¿ç”¨æ ‡ç­¾æ¥å®ç° </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl label pods pod1 app=myapp -n dev</span></div><div class="line"><span class="string">pod/pod1</span> <span class="string">labeled</span></div></pre></td></tr></table></figure><p>è¿˜åŸingress-def ä¸ºé»˜è®¤ï¼Œæ‹’ç»æ‰€æœ‰dev åç§°ç©ºé—´æ‰€æœ‰Podçš„è®¿é—® </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim ingress-def.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">deny-all-ingress</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  podSelector:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">  policyTypes:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">Ingress</span></div><div class="line"><span class="comment"># kubectl apply -f ingress-def.yaml  -n dev</span></div><div class="line"><span class="comment"># curl  10.244.3.2</span></div><div class="line"><span class="attr">curl:</span> <span class="string">(7)</span> <span class="string">Failed</span> <span class="string">connect</span> <span class="string">to</span> <span class="number">10.244</span><span class="number">.3</span><span class="number">.2</span><span class="string">:80;</span> <span class="string">Connection</span> <span class="string">timed</span> <span class="string">out</span></div></pre></td></tr></table></figure><p>é…ç½®æµ‹ç•¥ï¼Œå…è®¸æŸç½‘æ®µå…è®¸è®¿é—®æŒ‡å®šç­–ç•¥</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim allow-netpol-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">allow-myapp-ingress</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  podSelector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  ingress:</span></div><div class="line"><span class="attr">  - from:</span></div><div class="line"><span class="attr">    - ipBlock:</span></div><div class="line"><span class="attr">        cidr:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></div><div class="line"><span class="attr">        except:</span></div><div class="line"><span class="bullet">        -</span> <span class="number">10.244</span><span class="number">.1</span><span class="number">.2</span><span class="string">/32</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - protocol:</span> <span class="string">TCP</span></div><div class="line"><span class="attr">      port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    - protocol:</span> <span class="string">TCP</span></div><div class="line"><span class="attr">      port:</span> <span class="number">443</span></div><div class="line"><span class="comment"># kubectl apply -f allow-netpol-demo.yaml -n dev</span></div><div class="line"><span class="comment"># kubectl get netpol -n dev</span></div><div class="line"><span class="string">NAME</span>                  <span class="string">POD-SELECTOR</span>   <span class="string">AGE</span></div><div class="line"><span class="string">allow-myapp-ingress</span>   <span class="string">app=myapp</span>      <span class="number">2</span><span class="string">m</span></div><div class="line"><span class="string">deny-all-ingress</span>      <span class="string">&lt;none&gt;</span>         <span class="number">34</span><span class="string">m</span></div><div class="line"><span class="comment"># curl  10.244.3.2:80</span></div><div class="line"><span class="string">Hello</span> <span class="string">MyApp</span> <span class="string">| Version: v1 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</span></div></pre></td></tr></table></figure><p>ç®¡æ§å‡ºç«™æµé‡çš„æ–¹å¼</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim egress-def.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">deny-all-egress</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  podSelector:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">  policyTypes:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">Egress</span></div><div class="line"><span class="comment"># kubectl  apply -f egress-def.yaml -n prod</span></div><div class="line"><span class="string">networkpolicy.networking.k8s.io/deny-all-egress</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl apply -f pod-a.yaml -n prod # å°†ä¹‹å‰çš„pod-a.yaml åˆ›å»ºåˆ°prodåç§°ç©ºé—´</span></div><div class="line"><span class="string">pod/pod1</span> <span class="string">unchanged</span></div><div class="line"><span class="comment"># kubectl get pods -n prod -o wide</span></div><div class="line"><span class="string">NAME</span>   <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>           <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></div><div class="line"><span class="string">pod1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">34</span><span class="string">m</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.3</span>   <span class="string">node03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;node</span></div><div class="line"><span class="comment"># kubectl exec pod1 -it -n prod -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># ping 10.1.87.81</span></div><div class="line"><span class="string">PING</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">(10.1.87.81):</span> <span class="number">56</span> <span class="string">data</span> <span class="string">bytes</span></div><div class="line"><span class="string">^C</span></div><div class="line"><span class="bullet">-</span><span class="bullet">--</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">ping</span> <span class="string">statistics</span> <span class="meta">---</span></div><div class="line"><span class="number">4</span> <span class="string">packets</span> <span class="string">transmitted,</span> <span class="number">0</span> <span class="string">packets</span> <span class="string">received,</span> <span class="number">100</span><span class="string">%</span> <span class="string">packet</span> <span class="string">loss</span></div><div class="line"><span class="string">/</span> <span class="comment">#</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim egress-def.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">deny-all-egress</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  podSelector:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">  egress:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">  policyTypes:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">Egress</span></div><div class="line"><span class="comment"># kubectl  apply -f egress-def.yaml -n prod</span></div><div class="line"><span class="comment"># kubectl exec pod1 -it -n prod -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># ping 10.1.87.81</span></div><div class="line"><span class="string">PING</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">(10.1.87.81):</span> <span class="number">56</span> <span class="string">data</span> <span class="string">bytes</span></div><div class="line"><span class="number">64</span> <span class="string">bytes</span> <span class="string">from</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span><span class="string">:</span> <span class="string">seq=0</span> <span class="string">ttl=63</span> <span class="string">time=0.660</span> <span class="string">ms</span></div><div class="line"><span class="number">64</span> <span class="string">bytes</span> <span class="string">from</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span><span class="string">:</span> <span class="string">seq=1</span> <span class="string">ttl=63</span> <span class="string">time=0.564</span> <span class="string">ms</span></div><div class="line"><span class="string">^C</span></div><div class="line"><span class="bullet">-</span><span class="bullet">--</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.81</span> <span class="string">ping</span> <span class="string">statistics</span> <span class="meta">---</span></div><div class="line"><span class="number">2</span> <span class="string">packets</span> <span class="string">transmitted,</span> <span class="number">2</span> <span class="string">packets</span> <span class="string">received,</span> <span class="number">0</span><span class="string">%</span> <span class="string">packet</span> <span class="string">loss</span></div><div class="line"><span class="string">round-trip</span> <span class="string">min/avg/max</span> <span class="string">=</span> <span class="number">0.564</span><span class="string">/0.612/0.660</span> <span class="string">ms</span></div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ”¾è¡Œæ‰€æœ‰Podå‡ºç«™è§„åˆ™,ç½‘ç»œæ˜¯é€šçš„;</p><p>ç½‘ç»œç­–ç•¥:<br>    åç§°ç©ºé—´:<br>        æ‹’ç»æ‰€æœ‰å‡ºç«™ï¼Œå…¥ç«™;<br>        æ”¾è¡Œæ‰€æœ‰å‡ºç«™ç›®æ ‡æœ¬åç§°ç©ºé—´å†…çš„æ‰€æœ‰Pod;</p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(å››)</title>
      <link href="/2019/05/22/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%954/"/>
      <url>/2019/05/22/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%954/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•å››"><a href="#kubernetes-æ“ä½œè®°å½•å››" class="headerlink" title="kubernetes æ“ä½œè®°å½•å››"></a>kubernetes æ“ä½œè®°å½•å››</h1><p><img src="/images/docker_kubernetes.png" alt=""></p><h2 id="kubernetesè®¤è¯åŠService-Account"><a href="#kubernetesè®¤è¯åŠService-Account" class="headerlink" title="kubernetesè®¤è¯åŠService Account"></a>kubernetesè®¤è¯åŠService Account</h2><p>åœ¨masteræœåŠ¡å™¨ä¸Šå¯åŠ¨ proxy å¹¶ç›‘å¬è‡³8080</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  proxy --port=8080 &amp;</span></div><div class="line"><span class="comment"># curl http://localhost:8080/api/v1/namespaces</span></div></pre></td></tr></table></figure><p>ä»…æœ‰æƒé™è·å–å½“å‰Podè‡ªèº«çš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get secret -n ingress-nginx</span></div><div class="line">NAME                                       TYPE                                  DATA   AGE</div><div class="line">default-token-t54dl                        kubernetes.io/service-account-token   3      5d23h</div><div class="line">nginx-ingress-serviceaccount-token-5dwv4   kubernetes.io/service-account-token   3      5d23h</div></pre></td></tr></table></figure><p>ç”Ÿæˆyamlæ¡†æ¶ï¼Œå¿«é€Ÿç¼–å†™æ¸…å•</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create serviceaccount mysa -o yaml --dry-run</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  name:</span> <span class="string">mysa</span></div><div class="line"><span class="comment"># kubectl get pods myapp-deploy-675558bfc5-2rfrs -o  yaml --export</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create serviceaccount admin</span></div><div class="line"></div><div class="line"><span class="comment"># kubectl describe sa admin</span></div><div class="line">Name:                admin</div><div class="line">Namespace:           default</div><div class="line">Labels:              &lt;none&gt;</div><div class="line">Annotations:         &lt;none&gt;</div><div class="line">Image pull secrets:  &lt;none&gt;</div><div class="line">Mountable secrets:   admin-token-hxqqf</div><div class="line">Tokens:              admin-token-hxqqf</div><div class="line">Events:              &lt;none&gt;</div><div class="line"><span class="comment"># kubectl get secret</span></div><div class="line">NAME                    TYPE                                  DATA   AGE</div><div class="line">admin-token-hxqqf       kubernetes.io/service-account-token   3      66s</div><div class="line">default-token-2sgn5     kubernetes.io/service-account-token   3      26d</div><div class="line">mysql-root-password     Opaque                                1      45h</div><div class="line">tomcat-ingress-secret   kubernetes.io/tls                     2      5d22h</div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim  pod-sa-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-sa-demo</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">  serviceAccountName:</span> <span class="string">admin</span></div><div class="line"><span class="comment"># kubectl apply -f pod-sa-demo.yaml</span></div><div class="line"><span class="comment"># kubectl describe pods  pod-sa-demo | grep 'SecretName'</span></div><div class="line"><span class="attr">    SecretName:</span>  <span class="string">admin-token-hxqqf</span></div></pre></td></tr></table></figure><p>kubernetes é›†ç¾¤æœ‰ä¸¤ç±»è®¤è¯æ—¶çš„ç”¨æˆ·è´¦å·<br>useraccount,æˆ‘ä»¬ç§°ä¹‹ä¸ºç”¨æˆ·è´¦å·ï¼Œé€šå¸¸å®šä¹‰çš„æ˜¯äººä½¿ç”¨çš„è´¦å·<br>servicecacount,  æœåŠ¡è´¦å·ï¼ŒæŒ‡podä¸­åº”ç”¨çš„åº”ç”¨ç¨‹åºè¿è¡Œåœ¨kubernetes ï¼Œæƒ³è®¿é—®apiserveræ—¶ç”¨çš„è®¤è¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå¯†ç ç­‰ç­‰;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl config view</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">clusters:</span></div><div class="line"><span class="attr">- cluster:</span></div><div class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></div><div class="line"><span class="attr">    server:</span> <span class="attr">https://10.1.87.80:6443</span></div><div class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></div><div class="line"><span class="attr">contexts:</span></div><div class="line"><span class="attr">- context:</span></div><div class="line"><span class="attr">    cluster:</span> <span class="string">kubernetes</span></div><div class="line"><span class="attr">    user:</span> <span class="string">kubernetes-admin</span></div><div class="line"><span class="attr">  name:</span> <span class="string">kubernetes-admin@kubernetes</span></div><div class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Config</span></div><div class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">users:</span></div><div class="line"><span class="attr">- name:</span> <span class="string">kubernetes-admin</span></div><div class="line"><span class="attr">  user:</span></div><div class="line"><span class="attr">    client-certificate-data:</span> <span class="string">REDACTED</span></div><div class="line"><span class="attr">    client-key-data:</span> <span class="string">REDACTED</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/etc/kubernetes/pki</div><div class="line"><span class="comment"># (umask 077; openssl genrsa -out  ssjinyao.key 2048)</span></div><div class="line"><span class="comment"># openssl req -new -key ssjinyao.key  -out ssjinyao.csr -subj "/CN=ssjinyao"</span></div><div class="line"><span class="comment"># openssl x509 -req -in ssjinyao.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out ssjinyao.crt -days 36500</span></div><div class="line">Signature ok</div><div class="line">subject=/CN=ssjinyao</div><div class="line">Getting CA Private Key</div><div class="line"><span class="comment"># openssl x509 -in ssjinyao.crt -text -noout</span></div><div class="line">Certificate:</div><div class="line">    Data:</div><div class="line">        Version: 1 (0x0)</div><div class="line">        Serial Number:</div><div class="line">            f3:fe:ff:e5:0e:0b:37:e2</div><div class="line">    Signature Algorithm: sha256WithRSAEncryption</div><div class="line">        Issuer: CN=kubernetes</div><div class="line">        Validity</div><div class="line">            Not Before: May 22 07:57:01 2019 GMT</div><div class="line">            Not After : Apr 28 07:57:01 2119 GMT</div><div class="line">        Subject: CN=ssjinyao</div><div class="line">        Subject Public Key Info:</div><div class="line">            Public Key Algorithm: rsaEncryption</div><div class="line">                Public-Key: (2048 bit)</div></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æŠŠç”¨æˆ·è´¦å·ä¿¡æ¯æ·»åŠ åˆ°è¿æ¥kubernetes çš„é…ç½®ä¿¡æ¯</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl config set-credentials ssjinyao  --client-certificate=./ssjinyao.crt --client-key=./ssjinyao.key --embed-certs=true</span></div><div class="line"><span class="string">User</span> <span class="string">"ssjinyao"</span> <span class="string">set.</span></div><div class="line"><span class="comment"># kubectl config view</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">clusters:</span></div><div class="line"><span class="attr">- cluster:</span></div><div class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></div><div class="line"><span class="attr">    server:</span> <span class="attr">https://10.1.87.80:6443</span></div><div class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></div><div class="line"><span class="attr">contexts:</span></div><div class="line"><span class="attr">- context:</span></div><div class="line"><span class="attr">    cluster:</span> <span class="string">kubernetes</span></div><div class="line"><span class="attr">    user:</span> <span class="string">kubernetes-admin</span></div><div class="line"><span class="attr">  name:</span> <span class="string">kubernetes-admin@kubernetes</span></div><div class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Config</span></div><div class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">users:</span></div><div class="line"><span class="attr">- name:</span> <span class="string">kubernetes-admin</span></div><div class="line"><span class="attr">  user:</span></div><div class="line"><span class="attr">    client-certificate-data:</span> <span class="string">REDACTED</span></div><div class="line"><span class="attr">    client-key-data:</span> <span class="string">REDACTED</span></div><div class="line"><span class="attr">- name:</span> <span class="string">ssjinyao</span></div><div class="line"><span class="attr">  user:</span></div><div class="line"><span class="attr">    client-certificate:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.crt</span></div><div class="line"><span class="attr">    client-key:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.key</span></div><div class="line"><span class="comment"># kubectl config set-context ssjinyao@kubernetes --cluster=kueberntes --user=ssjinyao</span></div><div class="line"><span class="string">Context</span> <span class="string">"ssjinyao@kubernetes"</span> <span class="string">created.</span></div><div class="line"><span class="comment"># kubectl config view</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">clusters:</span></div><div class="line"><span class="attr">- cluster:</span></div><div class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">DATA+OMITTED</span></div><div class="line"><span class="attr">    server:</span> <span class="attr">https://10.1.87.80:6443</span></div><div class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></div><div class="line"><span class="attr">contexts:</span></div><div class="line"><span class="attr">- context:</span></div><div class="line"><span class="attr">    cluster:</span> <span class="string">kubernetes</span></div><div class="line"><span class="attr">    user:</span> <span class="string">kubernetes-admin</span></div><div class="line"><span class="attr">  name:</span> <span class="string">kubernetes-admin@kubernetes</span></div><div class="line"><span class="attr">- context:</span></div><div class="line"><span class="attr">    cluster:</span> <span class="string">kueberntes</span></div><div class="line"><span class="attr">    user:</span> <span class="string">ssjinyao</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ssjinyao@kubernetes</span></div><div class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Config</span></div><div class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="attr">users:</span></div><div class="line"><span class="attr">- name:</span> <span class="string">kubernetes-admin</span></div><div class="line"><span class="attr">  user:</span></div><div class="line"><span class="attr">    client-certificate-data:</span> <span class="string">REDACTED</span></div><div class="line"><span class="attr">    client-key-data:</span> <span class="string">REDACTED</span></div><div class="line"><span class="attr">- name:</span> <span class="string">ssjinyao</span></div><div class="line"><span class="attr">  user:</span></div><div class="line"><span class="attr">    client-certificate:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.crt</span></div><div class="line"><span class="attr">    client-key:</span> <span class="string">/etc/kubernetes/pki/ssjinyao.key</span></div></pre></td></tr></table></figure><p>è¿™æ—¶å€™å¤šäº†ä¸€ä¸ªcontext, å¯åˆ‡æ¢ç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># kubectl config use-context ssjinyao@kubernetes</div><div class="line">Switched to context &quot;ssjinyao@kubernetes&quot;.</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># kubectl config set-cluster mycluster --kubeconfig=/tmp/test.conf --server=&quot;https://10.1.87.80:6443&quot; --certificate-authority=/etc/kubernetes/pki/ca.crt  --embed-certs=true</div><div class="line">Cluster &quot;mycluster&quot; set.</div><div class="line"># kubectl config view --kubeconfig=/tmp/test.conf</div><div class="line">apiVersion: v1</div><div class="line">clusters:</div><div class="line">- cluster:</div><div class="line">    certificate-authority-data: DATA+OMITTED</div><div class="line">    server: https://10.1.87.80:6443</div><div class="line">  name: mycluster</div><div class="line">contexts: []</div><div class="line">current-context: &quot;&quot;</div><div class="line">kind: Config</div><div class="line">preferences: &#123;&#125;</div><div class="line">users: []</div></pre></td></tr></table></figure><h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><p>æˆæƒæ’ä»¶: Node, ABAC,RBAC,Webhook(åŸºäºhttpçš„å›è°ƒæ¥å®ç°)<br>RBAC: Role-based AC</p><p>è§’è‰²  (role)<br>è®¸å¯ (permission)</p><p>role: operations,objects<br>rolebinding: user account OR service account  , role<br>clusterrole: clusterrolebinding</p><p>æ“ä½œ: GET HEAD PUT PUST PATCH DELETE</p><p>role bindingå®šä¹‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml  &gt; role-demo.yaml</span></div><div class="line"><span class="comment"># vim role-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Role</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pods-reader</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">rules:</span></div><div class="line"><span class="attr">- apiGroups:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">""</span></div><div class="line"><span class="attr">  resources:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">pods</span></div><div class="line"><span class="attr">  verbs:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">get</span></div><div class="line"><span class="bullet">  -</span> <span class="string">list</span></div><div class="line"><span class="bullet">  -</span> <span class="string">watch</span></div><div class="line"><span class="comment"># kubectl apply -f role-demo.yaml</span></div><div class="line"><span class="comment"># kubectl describe role pods-reader</span></div><div class="line"><span class="attr">Name:</span>         <span class="string">pods-reader</span></div><div class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></div><div class="line"><span class="attr">Annotations:</span>  <span class="string">kubectl.kubernetes.io/last-applied-configuration:</span></div><div class="line">                <span class="string">&#123;"apiVersion":"rbac.authorization.k8s.io/v1","kind":"Role","metadata":&#123;"annotations":&#123;&#125;,"creationTimestamp":null,"name":"pods-reader","nam...</span></div><div class="line"><span class="attr">PolicyRule:</span></div><div class="line">  <span class="string">Resources</span>  <span class="string">Non-Resource</span> <span class="string">URLs</span>  <span class="string">Resource</span> <span class="string">Names</span>  <span class="string">Verbs</span></div><div class="line"><span class="bullet">  -</span><span class="bullet">--------</span>  <span class="bullet">-----------------</span>  <span class="bullet">--------------</span>  <span class="bullet">-----</span></div><div class="line">  <span class="string">pods</span>       <span class="string">[]</span>                 <span class="string">[]</span>              <span class="string">[get</span> <span class="string">list</span> <span class="string">watch]</span></div><div class="line"><span class="comment"># kubectl create rolebinding ssjinyao-read-pods --role=pods-reader --user=ssjinyao --dry-run -o yaml &gt; rolebinding-demo.yaml</span></div><div class="line"><span class="comment"># vim rolebinding-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ssjinyao-read-pods</span></div><div class="line"><span class="attr">roleRef:</span></div><div class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></div><div class="line"><span class="attr">  kind:</span> <span class="string">Role</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pods-reader</span></div><div class="line"><span class="attr">subjects:</span></div><div class="line"><span class="attr">- apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></div><div class="line"><span class="attr">  kind:</span> <span class="string">User</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ssjinyao</span></div></pre></td></tr></table></figure><p>clusterrole  binding å®šä¹‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># useradd ik8s</span></div><div class="line"><span class="comment"># cp -a  .kube/  /home/ik8s/</span></div><div class="line"><span class="comment"># chown -R ik8s.ik8s /home/ik8s/</span></div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl config use-context kubernetes-admin@kubernetes</span></div><div class="line"><span class="comment"># kubectl  create clusterrole cluster-reader  --verb=get,list,watch --resource=pods -o yaml --dry-run  &gt; clusterrole-demo.yaml</span></div><div class="line"><span class="comment"># vim clusterrole-demo.yaml </span></div><div class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">cluster-reader</span></div><div class="line"><span class="attr">rules:</span></div><div class="line"><span class="attr">- apiGroups:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">""</span></div><div class="line"><span class="attr">  resources:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">pods</span></div><div class="line"><span class="attr">  verbs:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">get</span></div><div class="line"><span class="bullet">  -</span> <span class="string">list</span></div><div class="line"><span class="bullet">  -</span> <span class="string">watch</span></div><div class="line"><span class="comment"># kubectl apply -f clusterrole-demo.yaml</span></div><div class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/cluster-reader</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl create clusterrolebinding ssjinyao-read-all-pods --clusterrole=cluster-reader --user=ssjinyao --dry-run -o yaml  &gt; clusterrolebind-demo.yaml</span></div></pre></td></tr></table></figure><p>cluster-role è¢«  rolebinding ä¼šä½¿çš„cluster è¢«é™çº§</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create rolebinding ssjinyao-read-pods --clusterrole=cluster-reader --user=ssjinayo --dry-run -o yaml  &gt; rolebinding-clusterrole-demo.yaml</span></div></pre></td></tr></table></figure><p>æŸ¥çœ‹ç³»ç»Ÿé»˜è®¤çš„æˆæƒ<br>å¼•ç”¨æˆæƒ</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get clusterrole admin -o yaml</span></div><div class="line"><span class="comment"># kubectl create rolebinding default-ns-admin --clusterrole=admin --user=ssjinyao</span></div><div class="line"><span class="string">rolebinding.rbac.authorization.k8s.io/default-ns-admin</span> <span class="string">created</span></div></pre></td></tr></table></figure><h2 id="dashboard-åŠè®¤è¯åˆ†çº§æˆæƒ"><a href="#dashboard-åŠè®¤è¯åˆ†çº§æˆæƒ" class="headerlink" title="dashboard åŠè®¤è¯åˆ†çº§æˆæƒ"></a>dashboard åŠè®¤è¯åˆ†çº§æˆæƒ</h2><p>éƒ¨ç½² dashboard</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span></div></pre></td></tr></table></figure><p>éƒ¨ç½²æ—¶ä¸‹è½½é•œåƒå‡ºé”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  kubectl describe pods -n kube-system kubernetes-dashboard-5f7b999d65-jpmhs</span></div><div class="line">Events:</div><div class="line">  Type     Reason     Age                 From                           Message</div><div class="line">  ----     ------     ----                ----                           -------</div><div class="line">  Normal   Scheduled  113s                default-scheduler              Successfully assigned kube-system/kubernetes-dashboard-5f7b999d65-jpmhs to node01</div><div class="line">  Warning  Failed     53s (x3 over 105s)  kubelet, node01  Failed to pull image <span class="string">"k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1"</span>: rpc error: code = Unknown desc = Error response from daemon: Get https://k8s.gcr.io/v2/: dial tcp 74.125.203.82:443: connect: connection timed out</div><div class="line">  Warning  Failed     53s (x3 over 105s)  kubelet, node01  Error: ErrImagePull</div><div class="line">  Normal   BackOff    15s (x5 over 105s)  kubelet, node01  Back-off pulling image <span class="string">"k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1"</span></div><div class="line">  Warning  Failed     15s (x5 over 105s)  kubelet, node01  Error: ImagePullBackOff</div><div class="line">  Normal   Pulling    2s (x4 over 112s)   kubelet, 01  Pulling image <span class="string">"k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1"</span></div></pre></td></tr></table></figure><p>ç”¨æ‰‹åŠ¨ä¸‹è½½çš„æ–¹æ³•è¿›è¡Œè§£å†³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim docker_install_dashboard.sh</span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1</div><div class="line">docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</div><div class="line">docker rmi mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1</div><div class="line"><span class="comment"># sh docker_install_dashboard.sh</span></div></pre></td></tr></table></figure><p>ç„¶åå†æ‰§è¡Œä»¥ä¸‹éƒ¨ç½²æ¸…å•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</div><div class="line"> <span class="comment"># kubectl  get pods -n kube-system  | grep dash</span></div><div class="line">kubernetes-dashboard-5f7b999d65-fcb28        1/1     Running   0          71s</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°kubernetes-dashbroad å·²ç»è¿è¡Œ </p><p>é»˜è®¤æœåŠ¡æš´éœ²ä¸ºClusterIPç±»å‹çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ”¹ä¸ºNodePort ç±»å‹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl patch svc kubernetes-dashboard -p '&#123;"spec":&#123;"type":"NodePort"&#125;&#125;' -n kube-system</span></div><div class="line"><span class="comment"># kubectl get svc -n kube-system</span></div><div class="line">\NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</div><div class="line">kube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   27d</div><div class="line">kubernetes-dashboard   NodePort    10.109.190.204   &lt;none&gt;        443:31984/TCP            3m41s</div></pre></td></tr></table></figure></p><p>è¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹åˆ°ç™»å½•ç•Œé¢<br><img src="/images/kubernetes-dashboard-login.png" alt=""></p><h3 id="ä½¿ç”¨ç”¨tokenå®ç°è®¤è¯ç™»å½•"><a href="#ä½¿ç”¨ç”¨tokenå®ç°è®¤è¯ç™»å½•" class="headerlink" title="ä½¿ç”¨ç”¨tokenå®ç°è®¤è¯ç™»å½•"></a>ä½¿ç”¨ç”¨tokenå®ç°è®¤è¯ç™»å½•</h3><p>è¿™é‡Œç™»å½•éœ€è¦çš„æ˜¯serviceaccountç”¨æˆ·ï¼Œ æ‰€ä»¥è¿™é‡Œåˆ›å»º serviceaccount</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create serviceaccount dashboard-admin -n kube-system</span></div><div class="line">serviceaccount/dashboard-admin created </div><div class="line"><span class="comment"># kubectl  get sa -n kube-system  |  grep dash</span></div><div class="line">dashboard-admin                      1         6m33s</div></pre></td></tr></table></figure><p>serviceaccount åˆ›å»ºå¥½åï¼Œ éœ€è¦å°†serviceaccountç»‘å®šclusterè¿™ä¸ªè§’è‰²ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span></div><div class="line">clusterrolebinding.rbac.authorization.k8s.io/dashboard-cluster-admin created</div><div class="line"><span class="comment"># kubectl get secret -n kube-system | grep dash</span></div><div class="line">dashboard-admin-token-grj84                      kubernetes.io/service-account-token   3      5m46s</div></pre></td></tr></table></figure><p>ç»‘å®šå¥½ cluster åï¼Œ æŸ¥çœ‹tokenä¿¡æ¯ï¼Œå¹¶æ‹¿tokenè¿›è¡Œç™»å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl describe secret -n kube-system dashboard-admin-token-grj84</span></div></pre></td></tr></table></figure><p>ç™»å½•åï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªkubernetesé›†ç¾¤çš„æ¦‚å†µ</p><p><img src="/images/kubernetes-dashboard-loging-token.png" alt=""></p><p>å»ºç«‹ä¸“ç”¨dashboradç”¨æˆ·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /etc/kubernetes/pki/</span></div><div class="line"><span class="comment"># (umask 077; openssl genrsa -out dashboard.key 2048)</span></div><div class="line"><span class="comment"># openssl req -new -key dashboard.key -out dashboard.csr -subj "/O=ssjinyao/CN=dashboard"</span></div><div class="line"><span class="comment"># openssl x509 -req -in dashboard.csr  -CA ca.crt -CAkey ca.key  -CAcreateserial -out dashboard.crt -days 3650</span></div><div class="line">Signature ok</div><div class="line">subject=/O=ssjinyao/CN=dashboard</div><div class="line">Getting CA Private Key</div><div class="line"><span class="comment"># kubectl create secret generic dashboard-cert  -n kube-system --from-file=dashboard.crt=./dashboard.crt --from-file=dashboard.key=./dashboard.key</span></div><div class="line">secret/dashboard-cert created</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create serviceaccount def-ns-admin -n default</span></div><div class="line">serviceaccount/def-ns-admin created</div></pre></td></tr></table></figure><p>role binding åˆ° default  åç§°ç©ºé—´ï¼Œåªå…è®¸è®¿é—®default åç§°ç©ºé—´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin</span></div><div class="line">rolebinding.rbac.authorization.k8s.io/def-ns-admin created</div><div class="line"><span class="comment"># kubectl describe secret admin-token-hxqqf # æŸ¥çœ‹ tokenä¿¡æ¯ç™»å½•</span></div></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é…ç½®kube config æ–‡ä»¶è®¤è¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=./ca.crt  --server="https://10.1.87.80:6443" --embed-certs=true --kubeconfig=/root/def-ns-admin.conf</span></div><div class="line">Cluster <span class="string">"kubernetes"</span> <span class="built_in">set</span>.</div><div class="line"><span class="comment"># kubectl config view --kubeconfig=/root/def-ns-admin.conf</span></div><div class="line">apiVersion: v1</div><div class="line">clusters:</div><div class="line">- cluster:</div><div class="line">    certificate-authority-data: DATA+OMITTED</div><div class="line">    server: https://10.1.87.80:6443</div><div class="line">  name: kubernetes</div><div class="line">contexts: []</div><div class="line">current-context: <span class="string">""</span></div><div class="line">kind: Config</div><div class="line">preferences: &#123;&#125;</div><div class="line">users: []</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># CLUSTER_ADMIN_TOKEN=$(kubectl get secret -n kube-system dashboard-admin-token-grj84   -o jsonpath=&#123;.data.token&#125; | base64 -d )</span></div><div class="line"><span class="comment"># kubectl config  set-credentials  dashboard-cluster-admin --token=$CLUSTER_ADMIN_TOKEN --kubeconfig=/root/def-ns-admin.conf</span></div><div class="line">User <span class="string">"dashboard-cluster-admin"</span> <span class="built_in">set</span>.</div><div class="line"><span class="comment"># kubectl config set-context dashboard-cluster-admin@kubernetes --cluster=kubernetes --user=dashboard-cluster-admin --kubeconfig=/root/def-ns-admin.conf</span></div><div class="line"><span class="comment"># kubectl config use-context dashboard-cluster-admin@kubernetes --kubeconfig=/root/def-ns-admin.conf</span></div></pre></td></tr></table></figure><p>å°†ç”Ÿæˆçš„confæ–‡ä»¶è¿œç¨‹å¤åˆ¶åˆ°æ¡Œé¢ä¸Š </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssjinyao â¤ scp root@10.1.87.80:/root/def-ns-admin.conf ~/Desktop</div></pre></td></tr></table></figure><p>æ­¤æ—¶ä½¿ç”¨å¯ä»¥ç”¨ kubeconfig æ¥ç™»å½•dashboard äº†</p><p><img src="/images/kubernetes-dashborad-loging-kubeconfig.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(ä¸‰)</title>
      <link href="/2019/05/17/kubernets%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%953/"/>
      <url>/2019/05/17/kubernets%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%953/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•ä¸‰"><a href="#kubernetes-æ“ä½œè®°å½•ä¸‰" class="headerlink" title="kubernetes æ“ä½œè®°å½•ä¸‰"></a>kubernetes æ“ä½œè®°å½•ä¸‰</h1><p><img src="/images/docker_kubernetes.png" alt=""></p><h2 id="å­˜å‚¨å·"><a href="#å­˜å‚¨å·" class="headerlink" title="å­˜å‚¨å·"></a>å­˜å‚¨å·</h2><h3 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-vol-demo.yaml </span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-demo</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/data/www/html</span></div><div class="line"><span class="attr">    command:</span> <span class="string">["/bin/sh"]</span></div><div class="line"><span class="attr">    args:</span> <span class="string">["-c"</span> <span class="string">,</span>  <span class="string">"httpd -h /data/www/html &amp;&amp; sleep 300000"</span><span class="string">]</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></div><div class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/data/</span></div><div class="line"><span class="attr">    command:</span> <span class="string">["/bin/sh"]</span></div><div class="line"><span class="attr">    args:</span> <span class="string">[</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"while sleep 2 ; do echo $(date) &gt;&gt; /data/index.html; done"</span><span class="string">]</span></div><div class="line"><span class="attr">  volumes:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">    emptyDir:</span> <span class="string">&#123;&#125;</span></div><div class="line"><span class="comment"># kubectl exec -it pod-demo -c busybox -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># echo $(date) &gt;&gt; /data/index.html</span></div><div class="line"><span class="string">/</span> <span class="comment"># cat /data/index.html</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">06</span><span class="string">:59:59</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="comment"># kubectl exec -it pod-demo -c myapp  -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># ls /data/web/html/index.html</span></div><div class="line"><span class="string">/data/web/html/index.html</span></div><div class="line"><span class="string">/</span> <span class="comment"># cat /data/web/html/index.html</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">06</span><span class="string">:59:59</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="comment"># curl  10.244.2.183</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:24</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:26</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:28</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:30</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:32</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:34</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:36</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:38</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:40</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:42</span> <span class="string">UTC</span> <span class="number">2019</span></div><div class="line"><span class="string">Fri</span> <span class="string">May</span> <span class="number">17</span> <span class="number">07</span><span class="string">:33:44</span> <span class="string">UTC</span> <span class="number">2019</span></div></pre></td></tr></table></figure><h3 id="hostPathæŒ‚è½½ä½¿ç”¨"><a href="#hostPathæŒ‚è½½ä½¿ç”¨" class="headerlink" title="hostPathæŒ‚è½½ä½¿ç”¨"></a>hostPathæŒ‚è½½ä½¿ç”¨</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-hostpath-vol.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-vol-hostpath</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernets/myapp:v1</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/usr/share/nginx/html/</span></div><div class="line"><span class="attr">  volumes:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">    hostPath:</span></div><div class="line"><span class="attr">      path:</span> <span class="string">/data/pod/volume1</span></div><div class="line"><span class="attr">      type:</span> <span class="string">DirectoryOrCreate</span></div><div class="line"><span class="comment"># kubectl apply -f pod-hostpath-vol.yaml</span></div></pre></td></tr></table></figure><p>node1,node2,node3 åˆ†åˆ«åˆ›å»ºä»¥ä¸‹ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p /data/pod/volume1/ #æ³¨ä¸‰ä¸ªèŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ</span></div><div class="line"><span class="comment"># echo "node1.ssjinyao.com" &gt;&gt; /data/pod/volume1/index.html</span></div><div class="line"><span class="comment"># echo "node2.ssjinyao.com" &gt;&gt; /data/pod/volume1/index.html</span></div><div class="line"><span class="comment"># echo "node3.ssjinyao.com" &gt;&gt; /data/pod/volume1/index.html</span></div><div class="line"><span class="comment"># curl 10.244.1.155</span></div><div class="line">node1.ssjinyao.com</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºå½“å‰è¿è¡Œåœ¨node1èŠ‚ç‚¹ä¸Š</p><h3 id="nfs-å·æŒ‚è½½ä½¿ç”¨"><a href="#nfs-å·æŒ‚è½½ä½¿ç”¨" class="headerlink" title="nfs å·æŒ‚è½½ä½¿ç”¨"></a>nfs å·æŒ‚è½½ä½¿ç”¨</h3><p>é€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œå®‰è£…å¹¶å¼€å¯nfs æœåŠ¡ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -pv /data/volumes</span></div><div class="line"><span class="comment"># yum -y install nfs nfs-utils </span></div><div class="line"><span class="comment"># vim /etc/exports</span></div><div class="line">/data/volumes  10.1.87.83/24(rw,no_root_squash)</div><div class="line"><span class="comment"># systemctl start nfs</span></div></pre></td></tr></table></figure><p>æ³¨: å…¶å®ƒèŠ‚ç‚¹ä¹Ÿéœ€è¦å®‰è£… nfs-utils  ä¸ç„¶podé©±åŠ¨ä¸äº†</p><p>åœ¨node02ä¸Šæ‰‹åŠ¨æµ‹è¯•æŒ‚è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mount -t nfs node03:/data/volumes/ /mnt</span></div></pre></td></tr></table></figure><p>åœ¨kubernetes é›†ç¾¤ä¸­ä½¿ç”¨nfs volumes</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-vol-nfs</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/usr/share/nginx/html/</span></div><div class="line"><span class="attr">  volumes:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">    nfs:</span></div><div class="line"><span class="attr">      path:</span> <span class="string">/data/volumes</span></div><div class="line"><span class="attr">      server:</span> <span class="string">node03</span></div><div class="line"><span class="comment"># kubectl apply -f pod-vol-nfs.yaml</span></div></pre></td></tr></table></figure><p>åœ¨nfsæœåŠ¡å™¨ä¸Šå†™å…¥æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo "&lt;h1&gt;nfs.ssjinyao.com&lt;/h1&gt;" &gt;&gt; /data/volumes/index.html</span></div></pre></td></tr></table></figure><p>å°è¯•è®¿é—®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl  10.244.2.185</span></div><div class="line">&lt;h1&gt;nfs.ssjinyao.com&lt;/h1&gt;</div></pre></td></tr></table></figure><h2 id="pv-pvc-çš„ä½¿ç”¨"><a href="#pv-pvc-çš„ä½¿ç”¨" class="headerlink" title="pv, pvc çš„ä½¿ç”¨"></a>pv, pvc çš„ä½¿ç”¨</h2><p>nfs æœåŠ¡å™¨ä¸Šåˆ›å»ºå¤šä¸ªç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir /data/volumes/v&#123;1,2,3,4,5&#125;</span></div><div class="line"><span class="comment"># vim /etc/exports</span></div><div class="line">/data/volumes/v1 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v2 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v3 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v4 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v5 10.1.87.83/24(rw,no_root_squash)</div><div class="line"><span class="comment"># exportfs -arv</span></div><div class="line">exporting 10.1.87.83/24:/data/volumes/v5</div><div class="line">exporting 10.1.87.83/24:/data/volumes/v4</div><div class="line">exporting 10.1.87.83/24:/data/volumes/v3</div><div class="line">exporting 10.1.87.83/24:/data/volumes/v2</div><div class="line">exporting 10.1.87.83/24:/data/volumes/v1</div><div class="line"><span class="comment"># systemctl restart nfs</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pv-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv01</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv001</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v1</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv02</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv002</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v2</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv03</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv003</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v3</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">20</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv04</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv004</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v4</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv05</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv005</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v5</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment"># kubectl get pv</span></div><div class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></div><div class="line"><span class="string">pv01</span>   <span class="number">5</span><span class="string">Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="number">74</span><span class="string">s</span></div><div class="line"><span class="string">pv02</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="number">74</span><span class="string">s</span></div><div class="line"><span class="string">pv03</span>   <span class="number">20</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="number">74</span><span class="string">s</span></div><div class="line"><span class="string">pv04</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="number">74</span><span class="string">s</span></div><div class="line"><span class="string">pv05</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="number">74</span><span class="string">s</span></div></pre></td></tr></table></figure><p>pvc ç»‘å®š pv </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat pod-vol-pvc.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">mypvc</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany"]</span></div><div class="line"><span class="attr">  resources:</span></div><div class="line"><span class="attr">    requests:</span></div><div class="line"><span class="attr">      storage:</span> <span class="number">11</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-vol-pvc</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/usr/share/nginx/html/</span></div><div class="line"><span class="attr">  volumes:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">html</span></div><div class="line"><span class="attr">    persistentVolumeClaim:</span></div><div class="line"><span class="attr">      claimName:</span> <span class="string">mypvc</span></div><div class="line"><span class="comment"># kubectl apply -f pod-vol-pvc.yaml</span></div><div class="line"><span class="comment"># kubectl get pv</span></div><div class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>           <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></div><div class="line"><span class="string">pv01</span>   <span class="number">5</span><span class="string">Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="number">40</span><span class="string">m</span></div><div class="line"><span class="string">pv02</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="number">40</span><span class="string">m</span></div><div class="line"><span class="string">pv03</span>   <span class="number">20</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/mypvc</span>                           <span class="number">40</span><span class="string">m</span></div><div class="line"><span class="string">pv04</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="number">40</span><span class="string">m</span></div><div class="line"><span class="string">pv05</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                           <span class="number">40</span><span class="string">m</span></div><div class="line"><span class="comment">#  kubectl  get pvc</span></div><div class="line"><span class="string">NAME</span>    <span class="string">STATUS</span>   <span class="string">VOLUME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">mypvc</span>   <span class="string">Bound</span>    <span class="string">pv03</span>     <span class="number">20</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>                       <span class="number">8</span><span class="string">s</span></div></pre></td></tr></table></figure><h2 id="configmap-çš„ä½¿ç”¨"><a href="#configmap-çš„ä½¿ç”¨" class="headerlink" title="configmap çš„ä½¿ç”¨"></a>configmap çš„ä½¿ç”¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=myapp.ssjinyao.com</span></div><div class="line">configmap/nginx-config created</div><div class="line"><span class="comment"># kubectl  get cm</span></div><div class="line">NAME           DATA   AGE</div><div class="line">nginx-config   2      25s</div><div class="line"><span class="comment"># kubectl describe cm nginx-config</span></div><div class="line">Name:         nginx-config</div><div class="line">Namespace:    default</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  &lt;none&gt;</div><div class="line"></div><div class="line">Data</div><div class="line">====</div><div class="line">nginx_port:</div><div class="line">----</div><div class="line">80</div><div class="line">server_name:</div><div class="line">----</div><div class="line">myapp.ssjinyao.com</div><div class="line">Events:  &lt;none&gt;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir configmap</span></div><div class="line"><span class="comment"># cd configmap/</span></div><div class="line"><span class="comment"># vim www.conf</span></div><div class="line">server &#123;</div><div class="line">server_name myapp.ssjinyao.com;</div><div class="line">        listen 80;</div><div class="line">        root /data/web/html/;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="comment"># kubectl create configmap nginx-www --from-file=./www.conf</span></div><div class="line"><span class="comment"># kubectl get cm</span></div><div class="line">NAME           DATA   AGE</div><div class="line">nginx-config   2      4m4s</div><div class="line">nginx-www      1      3s</div><div class="line"><span class="comment"># kubectl  get cm nginx-www -o yaml</span></div><div class="line">apiVersion: v1</div><div class="line">data:</div><div class="line">  www.conf: <span class="string">"server &#123;\n\tserver_name myapp.ssjinyao.com;\n        listen 80;\n        root</span></div><div class="line"><span class="string">    /data/web/html/;\n\n&#125;\n"</span></div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  creationTimestamp: <span class="string">"2019-05-20T08:17:37Z"</span></div><div class="line">  name: nginx-www</div><div class="line">  namespace: default</div><div class="line">  resourceVersion: <span class="string">"3462936"</span></div><div class="line">  selfLink: /api/v1/namespaces/default/configmaps/nginx-www</div><div class="line">  uid: ba1625a7-7ad7-11e9-8902-525400c45563</div></pre></td></tr></table></figure><p>Pod å¼•ç”¨ configmap ï¼Œç¯å¢ƒå˜é‡æ–¹å¼</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-configmap.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-cm-1</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    env:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">NGINX_SERVER_PORT</span></div><div class="line"><span class="attr">      valueFrom:</span></div><div class="line"><span class="attr">        configMapKeyRef:</span></div><div class="line"><span class="attr">          name:</span> <span class="string">nginx-config</span></div><div class="line"><span class="attr">          key:</span> <span class="string">nginx_port</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">NGINX_SERVER_NAME</span></div><div class="line"><span class="attr">      valueFrom:</span></div><div class="line"><span class="attr">        configMapKeyRef:</span></div><div class="line"><span class="attr">          name:</span> <span class="string">nginx-config</span></div><div class="line"><span class="attr">          key:</span> <span class="string">server_name</span></div><div class="line"><span class="comment"># kubectl  apply -f pod-configmap.yaml</span></div><div class="line"><span class="string">pod/pod-cm-1</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl  exec pod-cm-1 -it -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># printenv | grep NGINX_SERVER</span></div><div class="line"><span class="string">NGINX_SERVER_PORT=80</span></div><div class="line"><span class="string">NGINX_SERVER_NAME=myapp.ssjinyao.com</span></div></pre></td></tr></table></figure><p>å½“ç¯å¢ƒå˜é‡è·å–æ—¶ï¼Œå®¹å™¨çš„å˜é‡ä¸æ˜¯å®æ—¶æ›´æ–°çš„ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl edit cm nginx-config</span></div><div class="line"><span class="string">configmap/nginx-config</span> <span class="string">edited</span></div><div class="line"><span class="comment"># å°†nginx_port: "80" æ”¹å˜ nginx_port: "8080"</span></div><div class="line"><span class="comment"># å¯ä»¥çœ‹åˆ°configmap æ˜¯å®æ—¶ç”Ÿæ•ˆçš„</span></div><div class="line"><span class="comment"># kubectl describe cm nginx-config</span></div><div class="line"><span class="attr">Name:</span>         <span class="string">nginx-config</span></div><div class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></div><div class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></div><div class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></div><div class="line"></div><div class="line"><span class="string">Data</span></div><div class="line"><span class="string">====</span></div><div class="line"><span class="attr">nginx_port:</span></div><div class="line"><span class="bullet">-</span><span class="meta">---</span></div><div class="line"><span class="number">8080</span></div><div class="line"><span class="attr">server_name:</span></div><div class="line"><span class="bullet">-</span><span class="meta">---</span></div><div class="line"><span class="string">myapp.ssjinyao.com</span></div><div class="line"><span class="attr">Events:</span>  <span class="string">&lt;none&gt;</span></div><div class="line"><span class="comment"># è€Œå®¹å™¨ä¸­åˆ™ä¸ä¼šæ—¶å®æ›´æ–°å˜é‡</span></div><div class="line"><span class="comment"># kubectl  exec pod-cm-1 -it -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># printenv | grep NGINX_SERVER</span></div><div class="line"><span class="string">NGINX_SERVER_PORT=80</span></div><div class="line"><span class="string">NGINX_SERVER_NAME=myapp.ssjinyao.com</span></div></pre></td></tr></table></figure><p>å­˜å‚¨å·æŒ‚è½½æ–¹å¼</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-configmap2.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-cm-2</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">nginxconf</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/etc/nginx/config.d/</span></div><div class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  volumes:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">nginxconf</span></div><div class="line"><span class="attr">    configMap:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">nginx-config</span></div><div class="line"><span class="comment"># kubectl apply -f pod-configmap2.yaml</span></div><div class="line"><span class="string">pod/pod-cm-2</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl exec pod-cm-2 -it -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/conf</span></div><div class="line"><span class="string">conf.d/</span>    <span class="string">config.d/</span></div><div class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/config.d/</span></div><div class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># ls</span></div><div class="line"><span class="string">nginx_port</span>   <span class="string">server_name</span></div><div class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># cat nginx_port</span></div><div class="line"><span class="number">8080</span><span class="string">/etc/nginx/config.d</span> <span class="comment">#</span></div><div class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># cat server_name</span></div><div class="line"><span class="string">myapp.ssjinyao.com/etc/nginx/config.d</span> <span class="comment">#</span></div><div class="line"><span class="comment"># kubectl edit cm nginx-config</span></div><div class="line"><span class="string">configmap/nginx-config</span> <span class="string">edited</span></div><div class="line"><span class="comment"># å°†nginx_port: "8080" æ”¹ä¸º nginx_port: "8088" </span></div><div class="line"><span class="comment"># ç¨ç­‰ç‰‡åˆ»åï¼Œæ¥å…¥å®¹å™¨å‘ç°nginx_portå€¼å®æ—¶æ›´æ–°</span></div><div class="line"><span class="comment"># kubectl edit cm nginx-config</span></div><div class="line"><span class="string">Edit</span> <span class="string">cancelled,</span> <span class="literal">no</span> <span class="string">changes</span> <span class="string">made.</span></div><div class="line"><span class="string">[root@bj-zb-vm-ops-test5</span> <span class="string">configmap]#</span> <span class="string">kubectl</span> <span class="string">exec</span> <span class="string">pod-cm-2</span> <span class="bullet">-it</span> <span class="bullet">--</span> <span class="string">/bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/config.d/</span></div><div class="line"><span class="string">/etc/nginx/config.d</span> <span class="comment"># cat nginx_port</span></div><div class="line"><span class="number">8088</span><span class="string">/etc/nginx/config.d</span> <span class="comment">#</span></div></pre></td></tr></table></figure><p>æ¡ˆä¾‹,é…ç½®æ–‡ä»¶ç„™è¿›é•œåƒ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-configmap3.yaml</span></div><div class="line"><span class="comment"># kubectl apply -f pod-configmap3.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-cm-3</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    volumeMounts:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">nginxconf</span></div><div class="line"><span class="attr">      mountPath:</span> <span class="string">/etc/nginx/conf.d/</span></div><div class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  volumes:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">nginxconf</span></div><div class="line"><span class="attr">    configMap:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">nginx-www</span></div><div class="line"><span class="comment"># kubectl exec pod-cm-3 -it -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/conf.d/</span></div><div class="line"><span class="string">/etc/nginx/conf.d</span> <span class="comment"># cat www.conf</span></div><div class="line"><span class="string">server</span> <span class="string">&#123;</span></div><div class="line"><span class="string">server_name</span> <span class="string">myapp.ssjinyao.com;</span></div><div class="line">        <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></div><div class="line">        <span class="string">root</span> <span class="string">/data/web/html/;</span></div><div class="line"></div><div class="line"><span class="string">&#125;</span></div><div class="line"><span class="comment"># kubectl edit cm nginx-www</span></div><div class="line"><span class="string">configmap/nginx-www</span> <span class="string">edited</span></div><div class="line"><span class="comment"># å°† listen 80 æ”¹ä¸º listen 8080ï¼Œç¨ç­‰ç‰‡åˆ»åæ¥å…¥å®¹å™¨æŸ¥çœ‹é…ç½®</span></div><div class="line"><span class="comment"># kubectl exec pod-cm-3 -it -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># cd /etc/nginx/conf.d/</span></div><div class="line"><span class="string">/etc/nginx/conf.d</span> <span class="comment"># cat www.conf</span></div><div class="line"><span class="string">server</span> <span class="string">&#123;</span></div><div class="line"><span class="string">server_name</span> <span class="string">myapp.ssjinyao.com;</span></div><div class="line">        <span class="string">listen</span> <span class="number">8080</span><span class="string">;</span></div><div class="line">        <span class="string">root</span> <span class="string">/data/web/html/;</span></div><div class="line"></div><div class="line"><span class="string">&#125;</span></div><div class="line"><span class="comment"># echo "&lt;h1&gt; Nginx Server Configured by CM &lt;/h1&gt;" &gt; /data/web/html/index.html</span></div><div class="line"><span class="comment"># è¯´æ˜é…ç½®æ–‡ä»¶ç„™è¿›é•œåƒçš„æ–¹å¼æ˜¯å¯ä»¥å®æ—¶æ›´æ–°çš„;å½“ç„¶é…ç½®æ–‡ä»¶ç”Ÿæ•ˆï¼Œéœ€è¦nginx -s reload</span></div><div class="line"><span class="comment"># vim /etc/hosts  åŠ å…¥æœ¬åœ°è§£æè‡³Pod ip</span></div><div class="line"><span class="number">10.244</span><span class="number">.1</span><span class="number">.158</span> <span class="string">myapp.ssjinyao.com</span></div><div class="line"><span class="comment"># curl  http://myapp.ssjinyao.com:8080</span></div><div class="line"><span class="string">&lt;h1&gt;</span> <span class="string">Nginx</span> <span class="string">Server</span> <span class="string">Configured</span> <span class="string">by</span> <span class="string">CM</span> <span class="string">&lt;/h1&gt;</span></div></pre></td></tr></table></figure><h2 id="secret-çš„ä½¿ç”¨"><a href="#secret-çš„ä½¿ç”¨" class="headerlink" title="secret çš„ä½¿ç”¨"></a>secret çš„ä½¿ç”¨</h2><p>configmap éƒ½æ˜¯æ˜æ–‡å­˜æ•°æ®çš„ï¼Œç§é’¥å’Œè¯ä¹¦è¦æ”¾åœ¨secretä¸­ï¼Œå¯†ç è¦å†™æˆdns secret è€Œéconfigamp </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create secret generic mysql-root-password   --from-literal=passwod=H@ndih3</span></div><div class="line"><span class="string">secret/mysql-root-password</span> <span class="string">created</span></div><div class="line"><span class="comment"># kubectl  get secret</span></div><div class="line"><span class="string">NAME</span>                    <span class="string">TYPE</span>                                  <span class="string">DATA</span>   <span class="string">AGE</span></div><div class="line"><span class="string">default-token-2sgn5</span>     <span class="string">kubernetes.io/service-account-token</span>   <span class="number">3</span>      <span class="number">24</span><span class="string">d</span></div><div class="line"><span class="string">mysql-root-password</span>     <span class="string">Opaque</span>                                <span class="number">1</span>      <span class="number">45</span><span class="string">s</span></div><div class="line"><span class="string">tomcat-ingress-secret</span>   <span class="string">kubernetes.io/tls</span>                     <span class="number">2</span>      <span class="number">4</span><span class="string">d</span></div><div class="line"><span class="comment"># kubectl describe secret mysql-root-password</span></div><div class="line"><span class="attr">Name:</span>         <span class="string">mysql-root-password</span></div><div class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></div><div class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></div><div class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></div><div class="line"></div><div class="line"><span class="attr">Type:</span>  <span class="string">Opaque</span></div><div class="line"></div><div class="line"><span class="string">Data</span></div><div class="line"><span class="string">====</span></div><div class="line"><span class="attr">passwod:</span>  <span class="number">7</span> <span class="string">bytes</span></div><div class="line"><span class="comment"># å¯¹æ¯”configmap  çš„Dataæ•°æ®ï¼Œsecret å€¼æ˜¯ä¸æ˜¾ç¤ºçš„</span></div><div class="line"><span class="comment"># kubectl describe configmap nginx-www</span></div><div class="line"><span class="attr">Name:</span>         <span class="string">nginx-www</span></div><div class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></div><div class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></div><div class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></div><div class="line"></div><div class="line"><span class="string">Data</span></div><div class="line"><span class="string">====</span></div><div class="line"><span class="string">www.conf:</span></div><div class="line"><span class="bullet">-</span><span class="meta">---</span></div><div class="line"><span class="string">server</span> <span class="string">&#123;</span></div><div class="line">  <span class="string">server_name</span> <span class="string">myapp.ssjinyao.com;</span></div><div class="line">        <span class="string">listen</span> <span class="number">8080</span><span class="string">;</span></div><div class="line">        <span class="string">root</span> <span class="string">/data/web/html/;</span></div><div class="line"></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="attr">Events:</span>  <span class="string">&lt;none&gt;</span></div><div class="line"><span class="comment"># è€Œ configmap  Dataçš„å€¼æ˜¯æ˜¾ç¤ºçš„</span></div><div class="line"><span class="comment"># æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·çœ‹</span></div><div class="line"></div><div class="line"><span class="comment"># kubectl  get secret mysql-root-password -o yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">data:</span></div><div class="line"><span class="attr">  passwod:</span> <span class="string">SEBuZGloMw==</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Secret</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  creationTimestamp:</span> <span class="string">"2019-05-20T09:20:53Z"</span></div><div class="line"><span class="attr">  name:</span> <span class="string">mysql-root-password</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  resourceVersion:</span> <span class="string">"3469600"</span></div><div class="line"><span class="attr">  selfLink:</span> <span class="string">/api/v1/namespaces/default/secrets/mysql-root-password</span></div><div class="line"><span class="attr">  uid:</span> <span class="number">90</span><span class="string">cd9aaa-7ae0-11e9-8902-525400c45563</span></div><div class="line"><span class="attr">type:</span> <span class="string">Opaqueã€</span></div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ•°æ®è¿˜æ˜¯æœ‰çš„ï¼Œå› æ­¤å®‰å…¨æ²¡æœ‰é‚£å¥½ï¼Œä¹Ÿæ²¡æœ‰åŠ å¯†ç çš„æ„ä¹‰<br>å¯ä»¥ç›´æ¥ç”¨ base64 -d è¿›è¡Œè§£å¯†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># echo SEBuZGloMw== | base64 -d</div><div class="line">H@ndih3</div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim  pod-secret-1.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-secret-1</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    env:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></div><div class="line"><span class="attr">      valueFrom:</span></div><div class="line"><span class="attr">        secretKeyRef:</span></div><div class="line"><span class="attr">          name:</span> <span class="string">mysql-root-password</span></div><div class="line"><span class="attr">          key:</span> <span class="string">passwod</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl exec  pod-secret-1 -- printenv | grep MYSQL</span></div><div class="line">MYSQL_ROOT_PASSWORD=H@ndih3</div></pre></td></tr></table></figure><h2 id="statefulset-çš„ä½¿ç”¨"><a href="#statefulset-çš„ä½¿ç”¨" class="headerlink" title="statefulset çš„ä½¿ç”¨"></a>statefulset çš„ä½¿ç”¨</h2><p>nfsæœåŠ¡å™¨è¿˜æ˜¯åœ¨node3  ä¸Šï¼Œé…ç½®ä¿¡æ¯å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/exports</span></div><div class="line">/data/volumes/v1 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v2 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v3 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v4 10.1.87.83/24(rw,no_root_squash)</div><div class="line">/data/volumes/v5 10.1.87.83/24(rw,no_root_squash)</div></pre></td></tr></table></figure><p>æ³¨ï¼šç¡®ä¿ä¸‰å°nodeæœåŠ¡å™¨éƒ½å®‰è£…äº† nfs-utils</p><p>pvæ”¹åŠ¨åŠåˆ›å»º </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat volumes/pv-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv01</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv001</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v1</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv02</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv002</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v2</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv03</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv003</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v3</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">5</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv04</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv004</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v4</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pv05</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">pv005</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  nfs:</span></div><div class="line"><span class="attr">    path:</span> <span class="string">/data/volumes/v5</span></div><div class="line"><span class="attr">    server:</span> <span class="string">node03</span></div><div class="line"><span class="attr">  accessModes:</span> <span class="string">["ReadWriteMany","ReadWriteOnce"]</span></div><div class="line"><span class="attr">  capacity:</span></div><div class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment"># kubectl apply -f volumes/pv-demo.yaml</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim stateful-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    name:</span> <span class="string">web</span></div><div class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp-pod</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  serviceName:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">3</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">myapp-pod</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">myapp-pod</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">          name:</span> <span class="string">web</span></div><div class="line"><span class="attr">        volumeMounts:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">myappdata</span></div><div class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/nginx/html</span></div><div class="line"><span class="attr">  volumeClaimTemplates:</span></div><div class="line"><span class="attr">  - metadata:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">myappdata</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      accessModes:</span> <span class="string">["ReadWriteOnce"]</span></div><div class="line"><span class="attr">      resources:</span></div><div class="line"><span class="attr">        requests:</span></div><div class="line"><span class="attr">          storage:</span> <span class="number">5</span><span class="string">Gi</span></div><div class="line"><span class="comment"># kubectl get pods</span></div><div class="line"><span class="string">NAME</span>                             <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">client</span>                           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">23</span><span class="string">d</span></div><div class="line"><span class="string">myapp-0</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">7</span><span class="string">m10s</span></div><div class="line"><span class="string">myapp-1</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">7</span><span class="string">m5s</span></div><div class="line"><span class="string">myapp-2</span>                          <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">7</span><span class="string">m1s</span></div><div class="line"><span class="comment"># kubectl get sts</span></div><div class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">AGE</span></div><div class="line"><span class="string">myapp</span>   <span class="number">3</span><span class="string">/3</span>     <span class="number">7</span><span class="string">m32s</span></div><div class="line"><span class="comment"># kubectl get pv</span></div><div class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>                       <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></div><div class="line"><span class="string">pv01</span>   <span class="number">5</span><span class="string">Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/myappdata-myapp-1</span>                           <span class="number">8</span><span class="string">m12s</span></div><div class="line"><span class="string">pv02</span>   <span class="number">5</span><span class="string">Gi</span>        <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/myappdata-myapp-0</span>                           <span class="number">8</span><span class="string">m12s</span></div><div class="line"><span class="string">pv03</span>   <span class="number">5</span><span class="string">Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/myappdata-myapp-2</span>                           <span class="number">8</span><span class="string">m12s</span></div><div class="line"><span class="string">pv04</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                                       <span class="number">8</span><span class="string">m12s</span></div><div class="line"><span class="string">pv05</span>   <span class="number">10</span><span class="string">Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                                       <span class="number">8</span><span class="string">m12s</span></div><div class="line"><span class="comment"># kubectl exec -it myapp-0 -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># nslookup myapp-0.myapp.default.svc.cluster.local</span></div><div class="line"><span class="attr">nslookup:</span> <span class="string">can't</span> <span class="string">resolve</span> <span class="string">'(null)'</span><span class="string">:</span> <span class="string">Name</span> <span class="string">does</span> <span class="string">not</span> <span class="string">resolve</span></div><div class="line"></div><div class="line"><span class="attr">Name:</span>      <span class="string">myapp-0.myapp.default.svc.cluster.local</span></div><div class="line"><span class="string">Address</span> <span class="number">1</span><span class="string">:</span> <span class="number">10.244</span><span class="number">.1</span><span class="number">.162</span> <span class="string">myapp-0.myapp.default.svc.cluster.local</span></div><div class="line"><span class="string">/</span> <span class="comment"># nslookup myapp-1.myapp.default.svc.cluster.local</span></div><div class="line"><span class="attr">nslookup:</span> <span class="string">can't</span> <span class="string">resolve</span> <span class="string">'(null)'</span><span class="string">:</span> <span class="string">Name</span> <span class="string">does</span> <span class="string">not</span> <span class="string">resolve</span></div><div class="line"></div><div class="line"><span class="attr">Name:</span>      <span class="string">myapp-1.myapp.default.svc.cluster.local</span></div><div class="line"><span class="string">Address</span> <span class="number">1</span><span class="string">:</span> <span class="number">10.244</span><span class="number">.2</span><span class="number">.192</span> <span class="string">myapp-1.myapp.default.svc.cluster.local</span></div><div class="line"><span class="string">/</span> <span class="comment"># nslookup myapp-2.myapp.default.svc.cluster.local</span></div><div class="line"><span class="attr">nslookup:</span> <span class="string">can't</span> <span class="string">resolve</span> <span class="string">'(null)'</span><span class="string">:</span> <span class="string">Name</span> <span class="string">does</span> <span class="string">not</span> <span class="string">resolve</span></div><div class="line"></div><div class="line"><span class="attr">Name:</span>      <span class="string">myapp-2.myapp.default.svc.cluster.local</span></div><div class="line"><span class="string">Address</span> <span class="number">1</span><span class="string">:</span> <span class="number">10.244</span><span class="number">.3</span><span class="number">.172</span> <span class="string">myapp-2.myapp.default.svc.cluster.local</span></div></pre></td></tr></table></figure><p>pod æ•°é‡æ‰©å±•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl scale sts myapp --replicas=5</span></div><div class="line">statefulset.apps/myapp scaled</div><div class="line"><span class="comment"># kubectl patch sts myapp -p '&#123;"spec":&#123;"replicas":2&#125;&#125;'</span></div><div class="line">statefulset.apps/myapp patched</div><div class="line"><span class="comment"># kubectl patch sts myapp -p '&#123;"spec":&#123;"updateStrategy":&#123;"rollingUpdate":&#123;"partition":4&#125;&#125;&#125;&#125;'</span></div><div class="line">statefulset.apps/myapp patched</div><div class="line"><span class="comment"># kubectl set image sts/myapp myapp=ikubernetes/myapp:v2</span></div><div class="line">statefulset.apps/myapp image updated</div><div class="line"><span class="comment"># kubectl get sts -o wide</span></div><div class="line">NAME    READY   AGE   CONTAINERS   IMAGES</div><div class="line">myapp   2/2     53m   myapp        ikubernetes/myapp:v2</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(äºŒ)</title>
      <link href="/2019/05/10/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%952/"/>
      <url>/2019/05/10/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%952/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•äºŒ"><a href="#kubernetes-æ“ä½œè®°å½•äºŒ" class="headerlink" title="kubernetes æ“ä½œè®°å½•äºŒ"></a>kubernetes æ“ä½œè®°å½•äºŒ</h1><p><img src="/images/docker_kubernetes.png" alt=""></p><h2 id="Kubernetes-Pod-æ§åˆ¶å™¨"><a href="#Kubernetes-Pod-æ§åˆ¶å™¨" class="headerlink" title="Kubernetes Pod æ§åˆ¶å™¨"></a>Kubernetes Pod æ§åˆ¶å™¨</h2><h3 id="Replica-Set-RS-kubernetes-æ–°ä¸€ä»£çš„Pod-controller"><a href="#Replica-Set-RS-kubernetes-æ–°ä¸€ä»£çš„Pod-controller" class="headerlink" title="Replica Set(RS) kubernetes æ–°ä¸€ä»£çš„Pod controller"></a>Replica Set(RS) kubernetes æ–°ä¸€ä»£çš„Pod controller</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim rs-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">    replicas:</span> <span class="number">2</span></div><div class="line"><span class="attr">    selector:</span></div><div class="line"><span class="attr">        matchLabels:</span></div><div class="line"><span class="attr">            app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">            release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">    template:</span></div><div class="line"><span class="attr">        metadata:</span></div><div class="line"><span class="attr">            name:</span> <span class="string">myapp-pod</span></div><div class="line"><span class="attr">            labels:</span></div><div class="line"><span class="attr">                app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">                release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">                environment:</span> <span class="string">qa</span></div><div class="line"><span class="attr">        spec:</span></div><div class="line"><span class="attr">            containers:</span></div><div class="line"><span class="attr">            - name:</span> <span class="string">myapp-container</span></div><div class="line"><span class="attr">              image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">              ports:</span></div><div class="line"><span class="attr">              - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">                containerPort:</span> <span class="number">80</span></div><div class="line"><span class="comment">#  kubectl get rs</span></div><div class="line"><span class="string">NAME</span>                     <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></div><div class="line"><span class="string">myapp</span>                    <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="number">6</span><span class="string">m51s</span></div><div class="line"><span class="comment"># kubectl get pods</span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">myapp-5xbwq</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">7</span><span class="string">m17s</span></div><div class="line"><span class="string">myapp-jdzph</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">7</span><span class="string">m17s</span></div><div class="line"><span class="comment"># curl 10.244.3.157</span></div><div class="line"><span class="string">Hello</span> <span class="string">MyApp</span> <span class="string">| Version: v1 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</span></div><div class="line"><span class="string"># kubectl  delete pods myapp-5xbwq </span></div><div class="line"><span class="string"># kubectl get pods</span></div><div class="line"><span class="string">NAME                           READY   STATUS    RESTARTS   AGE</span></div><div class="line"><span class="string">myapp-jdzph                    1/1     Running   0          10m</span></div><div class="line"><span class="string">myapp-xg9mm                    1/1     Running   0          16s</span></div><div class="line"><span class="string"># kubectl label pods pod-demo release=canary</span></div><div class="line"><span class="string"># kubectl get pods --show-labels</span></div><div class="line"><span class="string">NAME                           READY   STATUS    RESTARTS   AGE   LABELS</span></div><div class="line"><span class="string">myapp-jdzph                    1/1     Running   0          31m   app=myapp,environment=qa,release=canary</span></div></pre></td></tr></table></figure><p>ç²¾ç¡®æ»¡è¶³ç”¨æˆ·æœŸæœ›</p><h3 id="apply-f-å£°æ˜å¼æ›´æ–°ï¼Œå³å¯ä»¥åˆ›å»ºï¼Œä¹Ÿå¯ä»¥æ›´æ–°"><a href="#apply-f-å£°æ˜å¼æ›´æ–°ï¼Œå³å¯ä»¥åˆ›å»ºï¼Œä¹Ÿå¯ä»¥æ›´æ–°" class="headerlink" title="apply -f å£°æ˜å¼æ›´æ–°ï¼Œå³å¯ä»¥åˆ›å»ºï¼Œä¹Ÿå¯ä»¥æ›´æ–°"></a>apply -f å£°æ˜å¼æ›´æ–°ï¼Œå³å¯ä»¥åˆ›å»ºï¼Œä¹Ÿå¯ä»¥æ›´æ–°</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim deploy-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp-deploy</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">2</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">      release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">        image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">          containerPort:</span> <span class="number">80</span></div><div class="line"><span class="comment"># kubectl apply -f deploy-demo.yaml</span></div><div class="line"><span class="comment"># kubectl get deploy</span></div><div class="line"><span class="string">NAME</span>           <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></div><div class="line"><span class="string">myapp-deploy</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="number">115</span><span class="string">s</span></div><div class="line"><span class="comment"># kubectl  get pods</span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">myapp-deploy-67b6dfcd8-6q725</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">4</span><span class="string">m39s</span></div><div class="line"><span class="string">myapp-deploy-67b6dfcd8-mshw8</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">4</span><span class="string">m39s</span></div><div class="line"><span class="comment"># vim deploy-demo.yaml</span></div><div class="line"><span class="string">å°†</span> <span class="attr">replicas:</span> <span class="number">2</span> <span class="string">æ”¹ä¸º</span> <span class="attr">replicas:</span> <span class="number">3</span></div><div class="line"><span class="comment"># kubectl apply -f deploy-demo.yaml</span></div><div class="line"><span class="comment"># kubectl  get pods</span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">myapp-deploy-67b6dfcd8-6q725</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">6</span><span class="string">m34s</span></div><div class="line"><span class="string">myapp-deploy-67b6dfcd8-gltjz</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">58</span><span class="string">s</span></div><div class="line"><span class="string">myapp-deploy-67b6dfcd8-mshw8</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">6</span><span class="string">m34s</span></div></pre></td></tr></table></figure><h3 id="å®ç°æµåŠ¨æ›´æ–°"><a href="#å®ç°æµåŠ¨æ›´æ–°" class="headerlink" title="å®ç°æµåŠ¨æ›´æ–°"></a>å®ç°æµåŠ¨æ›´æ–°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim deploy-demo.yaml</span></div><div class="line">image: ikubernetes/myapp:v1  æ”¹ä¸º image: ikubernetes/myapp:v2</div><div class="line"><span class="comment"># kubcetl  apply -f deploy-demo.yaml</span></div><div class="line"><span class="comment"># kubectl  get pods -l app=myapp -w</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">myapp-deploy-67b6dfcd8-6q725   1/1     Running   0          3h23m</div><div class="line">myapp-deploy-67b6dfcd8-gltjz   1/1     Running   0          3h18m</div><div class="line">myapp-deploy-67b6dfcd8-mshw8   1/1     Running   0          3h23m</div><div class="line">myapp-deploy-675558bfc5-89nc7   0/1     Pending   0          0s</div><div class="line">myapp-deploy-675558bfc5-89nc7   0/1     Pending   0          0s</div><div class="line">myapp-deploy-675558bfc5-89nc7   0/1     ContainerCreating   0          0s</div><div class="line">myapp-deploy-675558bfc5-89nc7   1/1     Running             0          2s</div><div class="line">myapp-deploy-67b6dfcd8-gltjz    1/1     Terminating         0          3h18m</div><div class="line">myapp-deploy-675558bfc5-7zht2   0/1     Pending             0          0s</div><div class="line">myapp-deploy-675558bfc5-7zht2   0/1     Pending             0          0s</div><div class="line">myapp-deploy-675558bfc5-7zht2   0/1     ContainerCreating   0          0s</div><div class="line">myapp-deploy-67b6dfcd8-gltjz    0/1     Terminating         0          3h18m</div><div class="line">myapp-deploy-675558bfc5-7zht2   1/1     Running             0          3s</div><div class="line">myapp-deploy-67b6dfcd8-6q725    1/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-675558bfc5-xjq9z   0/1     Pending             0          0s</div><div class="line">myapp-deploy-675558bfc5-xjq9z   0/1     Pending             0          0s</div><div class="line">myapp-deploy-675558bfc5-xjq9z   0/1     ContainerCreating   0          0s</div><div class="line">myapp-deploy-67b6dfcd8-gltjz    0/1     Terminating         0          3h18m</div><div class="line">myapp-deploy-67b6dfcd8-gltjz    0/1     Terminating         0          3h18m</div><div class="line">myapp-deploy-67b6dfcd8-6q725    0/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-675558bfc5-xjq9z   1/1     Running             0          2s</div><div class="line">myapp-deploy-67b6dfcd8-mshw8    1/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-67b6dfcd8-6q725    0/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-67b6dfcd8-6q725    0/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-67b6dfcd8-mshw8    0/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-67b6dfcd8-mshw8    0/1     Terminating         0          3h24m</div><div class="line">myapp-deploy-67b6dfcd8-mshw8    0/1     Terminating         0          3h24m</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„replica-set"><a href="#æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„replica-set" class="headerlink" title="æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„replica set"></a>æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„replica set</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get rs -o wide</span></div><div class="line">NAME                      DESIRED   CURRENT   READY   AGE     CONTAINERS     IMAGES                 SELECTOR</div><div class="line">myapp-deploy-675558bfc5   3         3         3       3m19s   myapp          ikubernetes/myapp:v2   app=myapp,pod-template-hash=675558bfc5,release=canary</div><div class="line">myapp-deploy-67b6dfcd8    0         0         0       3h27m   myapp          ikubernetes/myapp:v1   app=myapp,pod-template-hash=67b6dfcd8,release=canary</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹å†å²æ»šåŠ¨ä¿¡æ¯"><a href="#æŸ¥çœ‹å†å²æ»šåŠ¨ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹å†å²æ»šåŠ¨ä¿¡æ¯"></a>æŸ¥çœ‹å†å²æ»šåŠ¨ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl rollout history deployment myapp-deploy</span></div><div class="line">deployment.extensions/myapp-deploy</div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">1         &lt;none&gt;</div><div class="line">2         &lt;none&gt;</div></pre></td></tr></table></figure><h3 id="å®šä¹‰ä¸€ä¸ªè¡¥ä¸"><a href="#å®šä¹‰ä¸€ä¸ªè¡¥ä¸" class="headerlink" title="å®šä¹‰ä¸€ä¸ªè¡¥ä¸"></a>å®šä¹‰ä¸€ä¸ªè¡¥ä¸</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl patch deployment myapp-deploy -p '&#123;"spec":&#123;"replicas":5&#125;&#125;'</span></div><div class="line"><span class="comment"># kubectl  get pods</span></div><div class="line">NAME                            READY   STATUS    RESTARTS   AGE</div><div class="line">myapp-deploy-675558bfc5-7zht2   1/1     Running   0          11m</div><div class="line">myapp-deploy-675558bfc5-89nc7   1/1     Running   0          11m</div><div class="line">myapp-deploy-675558bfc5-9nkk4   1/1     Running   0          33s</div><div class="line">myapp-deploy-675558bfc5-rbs4d   1/1     Running   0          33s</div><div class="line">myapp-deploy-675558bfc5-xjq9z   1/1     Running   0          11m</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl patch deployment myapp-deploy -p '&#123;"spec":&#123;"strategy":&#123;"rollingUpdate":&#123;"maxSurge":1,"maxUnavailable":0&#125;&#125;&#125;&#125;'</span></div><div class="line">deployment.extensions/myapp-deploy patched</div><div class="line"><span class="comment"># kubectl  describe deployment myapp-deploy</span></div><div class="line">RollingUpdateStrategy:  0 max unavailable, 1 max surge</div></pre></td></tr></table></figure><h3 id="é‡‘ä¸é›€æ›´æ–°å‘å¸ƒ"><a href="#é‡‘ä¸é›€æ›´æ–°å‘å¸ƒ" class="headerlink" title="é‡‘ä¸é›€æ›´æ–°å‘å¸ƒ"></a>é‡‘ä¸é›€æ›´æ–°å‘å¸ƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl set image deployment myapp-deploy myapp=ikubernetes/myapp:v3 &amp;&amp; kubectl rollout pause deployment myapp-deploy  # æ›´æ–°å¹¶ä¸”æš‚åœæ›´æ–°</span></div><div class="line">deployment.extensions/myapp-deploy image updated</div><div class="line">deployment.extensions/myapp-deploy paused</div><div class="line"><span class="comment"># kubectl  get pods -l app=myapp -w</span></div><div class="line">NAME                            READY   STATUS    RESTARTS   AGE</div><div class="line">myapp-deploy-675558bfc5-7zht2   1/1     Running   0          27m</div><div class="line">myapp-deploy-675558bfc5-89nc7   1/1     Running   0          27m</div><div class="line">myapp-deploy-675558bfc5-9nkk4   1/1     Running   0          17m</div><div class="line">myapp-deploy-675558bfc5-rbs4d   1/1     Running   0          17m</div><div class="line">myapp-deploy-675558bfc5-xjq9z   1/1     Running   0          27m</div><div class="line">myapp-deploy-7f577979c8-92tj8   0/1     Pending   0          0s</div><div class="line">myapp-deploy-7f577979c8-92tj8   0/1     Pending   0          0s</div><div class="line">myapp-deploy-7f577979c8-92tj8   0/1     ContainerCreating   0          0s</div><div class="line">myapp-deploy-7f577979c8-92tj8   1/1     Running             0          14s</div></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç›‘æ§æ›´æ–°"><a href="#ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç›‘æ§æ›´æ–°" class="headerlink" title="ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç›‘æ§æ›´æ–°"></a>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç›‘æ§æ›´æ–°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  rollout status deployment myapp-deploy</span></div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 1 out of 5 new replicas have been updated...</div></pre></td></tr></table></figure><p>è‹¥å‘ç°æ²¡æœ‰é—®é¢˜åç»§ç»­æ›´æ–°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl rollout resume deployment myapp-deploy</span></div><div class="line">deployment.extensions/myapp-deploy resumed</div><div class="line"><span class="comment"># kubectl  rollout status deployment myapp-deploy</span></div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 1 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment spec update to be observed...</div><div class="line">Waiting <span class="keyword">for</span> deployment spec update to be observed...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 1 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 1 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 2 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 2 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 2 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 3 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 4 out of 5 new replicas have been updated...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 1 old replicas are pending termination...</div><div class="line">Waiting <span class="keyword">for</span> deployment <span class="string">"myapp-deploy"</span> rollout to finish: 1 old replicas are pending termination...</div><div class="line">deployment <span class="string">"myapp-deploy"</span> successfully rolled out</div></pre></td></tr></table></figure><h3 id="è‹¥æ›´æ–°æ—¶å‘ç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå›æ»š"><a href="#è‹¥æ›´æ–°æ—¶å‘ç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå›æ»š" class="headerlink" title="è‹¥æ›´æ–°æ—¶å‘ç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå›æ»š"></a>è‹¥æ›´æ–°æ—¶å‘ç°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå›æ»š</h3><p>æŸ¥çœ‹å¯ä»¥å›æ»šçš„ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl rollout history deployment myapp-deploy</span></div><div class="line">deployment.extensions/myapp-deploy</div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">1         &lt;none&gt;</div><div class="line">2         &lt;none&gt;</div><div class="line">3         &lt;none&gt;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  rollout undo deployment myapp-deploy --to-revision=1</span></div><div class="line">deployment.extensions/myapp-deploy rolled back</div><div class="line"><span class="comment"># kubectl rollout history deployment myapp-deploy</span></div><div class="line">deployment.extensions/myapp-deploy</div><div class="line">REVISION  CHANGE-CAUSE</div><div class="line">2         &lt;none&gt;</div><div class="line">3         &lt;none&gt;</div><div class="line">4         &lt;none&gt;</div></pre></td></tr></table></figure><p>è¿™æ—¶ç¬¬ä¸€ç‰ˆå·²ç»å›æ»šæˆç¬¬ä¸€ç‰ˆäº† </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get rs -o wide</span></div><div class="line">NAME                      DESIRED   CURRENT   READY   AGE    CONTAINERS     IMAGES                 SELECTOR</div><div class="line">myapp-deploy-675558bfc5   0         0         0       42m    myapp          ikubernetes/myapp:v2   app=myapp,pod-template-hash=675558bfc5,release=canary</div><div class="line">myapp-deploy-67b6dfcd8    5         5         5       4h6m   myapp          ikubernetes/myapp:v1   app=myapp,pod-template-hash=67b6dfcd8,release=canary</div></pre></td></tr></table></figure><h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><p>DaemonSet åœ¨æ•´ä¸ªé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šåªè¿è¡ŒæŒ‡å®šPodçš„ä¸€ä¸ªå‰¯æœ¬ï¼Œç”¨äºç³»ç»Ÿçº§çš„ç®¡ç†åŠŸèƒ½<br>æ¯”å¦‚filebeatï¼Œæ”¶é›†æ—¥å¿—çš„æœåŠ¡</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim ds-demo.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">redis</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">1</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">redis</span></div><div class="line"><span class="attr">      role:</span> <span class="string">logstor</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">redis</span></div><div class="line"><span class="attr">        role:</span> <span class="string">logstor</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">redis</span></div><div class="line"><span class="attr">        image:</span> <span class="attr">redis:4.0-alpine</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">redis</span></div><div class="line"><span class="attr">          containerPort:</span> <span class="number">6379</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">filebeat-ds</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">filebeat</span></div><div class="line"><span class="attr">      release:</span> <span class="string">stable</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">filebeat</span></div><div class="line"><span class="attr">        release:</span> <span class="string">stable</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">filebeat</span></div><div class="line"><span class="attr">        image:</span> <span class="string">ikubernetes/filebeat:5.6.5-alpine</span></div><div class="line"><span class="attr">        env:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">REDIS_HOST</span></div><div class="line"><span class="attr">          value:</span> <span class="string">redis.default.svc.cluster.local</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">REDIS_LOG_LEVEL</span></div><div class="line"><span class="attr">          value:</span> <span class="string">info</span></div><div class="line"><span class="comment"># kubectl apply -f ds-demo.yaml</span></div><div class="line"><span class="comment"># kubectl expose deployment redis --port=6379</span></div><div class="line"><span class="string">service/redis</span> <span class="string">exposed</span></div><div class="line"><span class="comment"># kubectl set image daemonsets filebeat-ds filebeat=ikubernetes/filebeat:5.6.6-alpine</span></div><div class="line"><span class="string">daemonset.extensions/filebeat-ds</span> <span class="string">image</span> <span class="string">updated</span></div></pre></td></tr></table></figure><h2 id="Kubernetes-Service"><a href="#Kubernetes-Service" class="headerlink" title="Kubernetes Service"></a>Kubernetes Service</h2><p>ExternalName, ClusterIP, NodePort, and LoadBalancer</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim redis-svc.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">redis</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">redis</span></div><div class="line"><span class="attr">    role:</span> <span class="string">logstor</span></div><div class="line"><span class="attr">  clusterIP:</span> <span class="number">10.96</span><span class="number">.88</span><span class="number">.88</span></div><div class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">6339</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">6379</span></div></pre></td></tr></table></figure><p>èµ„æºè®°å½•<br>SVC_NAME.NS_NAME.DOMAIN.LTD.<br>svc.cluster.local<br>redis.default.svc.cluster.local</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim myapp-svc.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  clusterIP:</span> <span class="number">10.99</span><span class="number">.99</span><span class="number">.99</span></div><div class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    nodePort:</span> <span class="number">30080</span></div><div class="line"><span class="comment"># kubectl get svc myapp</span></div><div class="line"><span class="string">NAME</span>    <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>    <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>        <span class="string">AGE</span></div><div class="line"><span class="string">myapp</span>   <span class="string">NodePort</span>   <span class="number">10.99</span><span class="number">.99</span><span class="number">.99</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30080/TCP</span>   <span class="number">4</span><span class="string">m50s</span></div><div class="line"><span class="string">ssjinyao</span> <span class="string">â¤</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span>  <span class="string">curl</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.82</span><span class="string">:30080/hostname.html</span> <span class="string">;</span> <span class="string">sleep</span> <span class="number">1</span> <span class="string">;</span> <span class="string">done</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span></div><div class="line"><span class="comment"># æ¥è‡ªåŒä¸Šå®¢æˆ·ç«¯çš„è¯·æ±‚å‘å¾€åŒä¸€Pod</span></div><div class="line"><span class="comment"># kubectl patch svc myapp -p '&#123;"spec":&#123;"sessionAffinity":"ClientIP"&#125;&#125;'</span></div><div class="line"><span class="string">service/myapp</span> <span class="string">patched</span></div><div class="line"><span class="comment"># kubectl  describe svc myapp</span></div><div class="line"><span class="attr">Name:</span>                     <span class="string">myapp</span></div><div class="line"><span class="attr">Namespace:</span>                <span class="string">default</span></div><div class="line"><span class="attr">Labels:</span>                   <span class="string">&lt;none&gt;</span></div><div class="line"><span class="attr">Annotations:</span>              <span class="string">kubectl.kubernetes.io/last-applied-configuration:</span></div><div class="line">                            <span class="string">&#123;"apiVersion":"v1","kind":"Service","metadata":&#123;"annotations":&#123;&#125;,"name":"myapp","namespace":"default"&#125;,"spec":&#123;"clusterIP":"10.99.99.99","...</span></div><div class="line"><span class="attr">Selector:</span>                 <span class="string">app=myapp,release=canary</span></div><div class="line"><span class="attr">Type:</span>                     <span class="string">NodePort</span></div><div class="line"><span class="attr">IP:</span>                       <span class="number">10.99</span><span class="number">.99</span><span class="number">.99</span></div><div class="line"><span class="attr">Port:</span>                     <span class="string">&lt;unset&gt;</span>  <span class="number">80</span><span class="string">/TCP</span></div><div class="line"><span class="attr">TargetPort:</span>               <span class="number">80</span><span class="string">/TCP</span></div><div class="line"><span class="attr">NodePort:</span>                 <span class="string">&lt;unset&gt;</span>  <span class="number">30080</span><span class="string">/TCP</span></div><div class="line"><span class="attr">Endpoints:</span>                <span class="number">10.244</span><span class="number">.1</span><span class="number">.150</span><span class="string">:80,10.244.2.166:80,10.244.3.167:80</span></div><div class="line"><span class="string">Session</span> <span class="attr">Affinity:</span>         <span class="string">ClientIP</span></div><div class="line"><span class="string">External</span> <span class="string">Traffic</span> <span class="attr">Policy:</span>  <span class="string">Cluster</span></div><div class="line"><span class="attr">Events:</span>                   <span class="string">&lt;none&gt;</span></div><div class="line"><span class="string">ssjinyao</span> <span class="string">â¤</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span>  <span class="string">curl</span> <span class="number">10.1</span><span class="number">.87</span><span class="number">.82</span><span class="string">:30080/hostname.html</span> <span class="string">;</span> <span class="string">sleep</span> <span class="number">1</span> <span class="string">;</span> <span class="string">done</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span></div></pre></td></tr></table></figure><p>æ— å¤´æœåŠ¡</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim myapp-svc-headless.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">myapp-svc</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">80</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></div><div class="line"></div><div class="line"><span class="comment"># kubectl apply -f myapp-svc-headless.yaml</span></div><div class="line"><span class="string">service/myapp-svc</span> <span class="string">created</span></div><div class="line"><span class="comment"># dig -t A myapp-svc.default.svc.cluster.local. @10.96.0.10</span></div><div class="line"></div><div class="line"><span class="string">;</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">DiG</span> <span class="number">9.9</span><span class="number">.4</span><span class="bullet">-RedHat-9.9.4-73.el7_6</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="bullet">-t</span> <span class="string">A</span> <span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="string">@10.96.0.10</span></div><div class="line"><span class="string">;;</span> <span class="string">global</span> <span class="attr">options:</span> <span class="string">+cmd</span></div><div class="line"><span class="string">;;</span> <span class="string">Got</span> <span class="attr">answer:</span></div><div class="line"><span class="string">;;</span> <span class="bullet">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="attr">opcode:</span> <span class="string">QUERY,</span> <span class="attr">status:</span> <span class="string">NOERROR,</span> <span class="attr">id:</span> <span class="number">38590</span></div><div class="line"><span class="string">;;</span> <span class="attr">flags:</span> <span class="string">qr</span> <span class="string">aa</span> <span class="string">rd;</span> <span class="attr">QUERY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ANSWER:</span> <span class="number">3</span><span class="string">,</span> <span class="attr">AUTHORITY:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">ADDITIONAL:</span> <span class="number">1</span></div><div class="line"><span class="string">;;</span> <span class="attr">WARNING:</span> <span class="string">recursion</span> <span class="string">requested</span> <span class="string">but</span> <span class="string">not</span> <span class="string">available</span></div><div class="line"></div><div class="line"><span class="string">;;</span> <span class="string">OPT</span> <span class="attr">PSEUDOSECTION:</span></div><div class="line"><span class="string">;</span> <span class="attr">EDNS:</span> <span class="attr">version:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">flags:;</span> <span class="attr">udp:</span> <span class="number">4096</span></div><div class="line"><span class="string">;;</span> <span class="string">QUESTION</span> <span class="attr">SECTION:</span></div><div class="line"><span class="string">;myapp-svc.default.svc.cluster.local.</span> <span class="string">IN</span><span class="string">A</span></div><div class="line"></div><div class="line"><span class="string">;;</span> <span class="string">ANSWER</span> <span class="attr">SECTION:</span></div><div class="line"><span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="number">5</span> <span class="string">IN</span> <span class="string">A</span><span class="number">10.244</span><span class="number">.3</span><span class="number">.167</span></div><div class="line"><span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="number">5</span> <span class="string">IN</span> <span class="string">A</span><span class="number">10.244</span><span class="number">.1</span><span class="number">.150</span></div><div class="line"><span class="string">myapp-svc.default.svc.cluster.local.</span> <span class="number">5</span> <span class="string">IN</span> <span class="string">A</span><span class="number">10.244</span><span class="number">.2</span><span class="number">.166</span></div><div class="line"></div><div class="line"><span class="string">;;</span> <span class="string">Query</span> <span class="attr">time:</span> <span class="number">0</span> <span class="string">msec</span></div><div class="line"><span class="string">;;</span> <span class="attr">SERVER:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span><span class="comment">#53(10.96.0.10)</span></div><div class="line"><span class="string">;;</span> <span class="attr">WHEN:</span> <span class="string">Thu</span> <span class="string">May</span> <span class="number">16</span> <span class="number">10</span><span class="string">:59:03</span> <span class="string">CST</span> <span class="number">2019</span></div><div class="line"><span class="string">;;</span> <span class="string">MSG</span> <span class="string">SIZE</span>  <span class="attr">rcvd:</span> <span class="number">217</span></div><div class="line"><span class="comment"># kubectl get svc -n kube-system</span></div><div class="line"><span class="string">NAME</span>       <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>   <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                  <span class="string">AGE</span></div><div class="line"><span class="string">kube-dns</span>   <span class="string">ClusterIP</span>   <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span>   <span class="string">&lt;none&gt;</span>        <span class="number">53</span><span class="string">/UDP,53/TCP,9153/TCP</span>   <span class="number">20</span><span class="string">d</span></div><div class="line"><span class="comment"># kubectl get pods -o wide -l app=myapp</span></div><div class="line"><span class="string">NAME</span>                            <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>             <span class="string">NODE</span>                   <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-5c8hn</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">42</span><span class="string">h</span>   <span class="number">10.244</span><span class="number">.1</span><span class="number">.150</span>   <span class="string">bj-gzf-vm-ops-test01</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qgps7</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">42</span><span class="string">h</span>   <span class="number">10.244</span><span class="number">.2</span><span class="number">.166</span>   <span class="string">bj-gzf-vm-ops-test02</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></div><div class="line"><span class="string">myapp-deploy-675558bfc5-qtlqf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">42</span><span class="string">h</span>   <span class="number">10.244</span><span class="number">.3</span><span class="number">.167</span>   <span class="string">bj-gzf-vm-ops-test03</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></div></pre></td></tr></table></figure><h2 id="ingress-åŠ-ingress-controller"><a href="#ingress-åŠ-ingress-controller" class="headerlink" title="ingress åŠ ingress controller"></a>ingress åŠ ingress controller</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir ingress-nginx</span></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> configmap.yaml mandatory.yaml namespace.yaml rbac.yaml  with-rbac.yaml  ; <span class="keyword">do</span> wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/<span class="variable">$file</span> ; <span class="keyword">done</span></div><div class="line"><span class="comment"># kubectl apply -f ./</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat deploy-demo.yaml</span></div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: myapp</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    app: myapp</div><div class="line">    release: canary</div><div class="line">  ports:</div><div class="line">  - name: httpd</div><div class="line">    targetPort: 80</div><div class="line">    port: 80</div><div class="line"></div><div class="line">---</div><div class="line">apiVersion: apps/v1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: myapp-deploy</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  replicas: 3</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: myapp</div><div class="line">      release: canary</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: myapp</div><div class="line">        release: canary</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: myapp</div><div class="line">        image: ikubernetes/myapp:v2</div><div class="line">        ports:</div><div class="line">        - name: http</div><div class="line">          containerPort: 80</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/provider/baremetal/service-nodeport.yaml</span></div><div class="line"><span class="comment"># pwd</span></div><div class="line">/root/ingress-nginx</div><div class="line"><span class="comment"># ls</span></div><div class="line">configmap.yaml  mandatory.yaml  namespace.yaml  rbac.yaml  service-nodeport.yaml  with-rbac.yaml</div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim service-nodeport.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ingress-nginx</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></div><div class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      port:</span> <span class="number">80</span></div><div class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></div><div class="line"><span class="attr">      nodePort:</span> <span class="number">30080</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">https</span></div><div class="line"><span class="attr">      port:</span> <span class="number">443</span></div><div class="line"><span class="attr">      targetPort:</span> <span class="number">443</span></div><div class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></div><div class="line"><span class="attr">      nodePort:</span> <span class="number">30443</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></div><div class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment"># kubectl apply -f ./</span></div><div class="line"><span class="comment"># kubectl get svc -n ingress-nginx</span></div><div class="line"><span class="string">NAME</span>            <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>     <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>                      <span class="string">AGE</span></div><div class="line"><span class="string">ingress-nginx</span>   <span class="string">NodePort</span>   <span class="number">10.96</span><span class="number">.59</span><span class="number">.169</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30080/TCP,443:30443/TCP</span>   <span class="number">2</span><span class="string">m35s</span></div></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥å°è¯•è®¿é—®</p><p><img src="/images/ingress-nginx-404.png" alt=""></p><p>æŸ¥çœ‹è®¿é—®apiVersion </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl explain ingress</span></div><div class="line">KIND:     Ingress</div><div class="line">VERSION:  extensions/v1beta1</div><div class="line"><span class="comment"># kubectl explain ingress.spec.rules.http.paths</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim ingress-myapp.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ingress-myapp</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  rules:</span></div><div class="line"><span class="attr">  - host:</span> <span class="string">myapp.ssjinyao.com</span></div><div class="line"><span class="attr">    http:</span></div><div class="line"><span class="attr">      paths:</span></div><div class="line"><span class="attr">      - path:</span></div><div class="line"><span class="attr">        backend:</span></div><div class="line"><span class="attr">          serviceName:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl describe ingress ingress-myapp</span></div><div class="line">Name:             ingress-myapp</div><div class="line">Namespace:        default</div><div class="line">Address:</div><div class="line">Default backend:  default-http-backend:80 (&lt;none&gt;)</div><div class="line">Rules:</div><div class="line">  Host                Path  Backends</div><div class="line">  ----                ----  --------</div><div class="line">  myapp.ssjinyao.com</div><div class="line">                         myapp:80 (10.244.1.150:80,10.244.2.166:80,10.244.3.167:80)</div><div class="line">Annotations:</div><div class="line">  kubectl.kubernetes.io/last-applied-configuration:  &#123;<span class="string">"apiVersion"</span>:<span class="string">"extensions/v1beta1"</span>,<span class="string">"kind"</span>:<span class="string">"Ingress"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;<span class="string">"kubernetes.io/ingress.class"</span>:<span class="string">"nginx"</span>&#125;,<span class="string">"name"</span>:<span class="string">"ingress-myapp"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"rules"</span>:[&#123;<span class="string">"host"</span>:<span class="string">"myapp.ssjinyao.com"</span>,<span class="string">"http"</span>:&#123;<span class="string">"paths"</span>:[&#123;<span class="string">"backend"</span>:&#123;<span class="string">"serviceName"</span>:<span class="string">"myapp"</span>,<span class="string">"servicePort"</span>:80&#125;,<span class="string">"path"</span>:null&#125;]&#125;&#125;]&#125;&#125;</div><div class="line"></div><div class="line">  kubernetes.io/ingress.class:  nginx</div><div class="line">Events:</div><div class="line">  Type    Reason  Age   From                      Message</div><div class="line">  ----    ------  ----  ----                      -------</div><div class="line">  Normal  CREATE  18s   nginx-ingress-controller  Ingress default/ingress-myapp</div><div class="line"><span class="comment"># kubectl exec -n ingress-nginx  nginx-ingress-controller-5694ccb578-xkgkx  -it -- /bin/sh</span></div></pre></td></tr></table></figure><p>è¿™æ—¶å†è®¿é—® </p><p><img src="/images/ingress-nginx-pod.png" alt=""></p><p>tomcat ä¸ƒå±‚è´Ÿè½½åˆ›å»º</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim tomcat-deploy.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Service</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">    release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">httpd</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">8080</span></div><div class="line"><span class="attr">    port:</span> <span class="number">8080</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">ajp</span></div><div class="line"><span class="attr">    targetPort:</span> <span class="number">8009</span></div><div class="line"><span class="attr">    port:</span> <span class="number">8009</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">tomcat-deploy</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">3</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    matchLabels:</span></div><div class="line"><span class="attr">      app:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">      release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">        release:</span> <span class="string">canary</span></div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">        image:</span> <span class="attr">tomcat:8.5.32-jre8-alpine</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">          containerPort:</span> <span class="number">8080</span></div><div class="line"><span class="attr">        - name:</span> <span class="string">ajp</span></div><div class="line"><span class="attr">          containerPort:</span> <span class="number">8009</span></div><div class="line"><span class="comment"># kubectl apply -f tomcat-deploy.yaml</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim ingress-tomcat.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ingress-tomcat</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  rules:</span></div><div class="line"><span class="attr">  - host:</span> <span class="string">tomcat.ssjinyao.com</span></div><div class="line"><span class="attr">    http:</span></div><div class="line"><span class="attr">      paths:</span></div><div class="line"><span class="attr">      - path:</span></div><div class="line"><span class="attr">        backend:</span></div><div class="line"><span class="attr">          serviceName:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></div><div class="line"><span class="comment"># kubectl apply -f ingress-tomcat.yaml</span></div></pre></td></tr></table></figure><p><img src="/images/ingress-nginx-tomcat.png" alt=""></p><p>secret åˆ›å»ºä¸ä½¿ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create secret tls tomcat-ingress-secret --cert=2214184_tomcat.ssjinyao.com.pem --key=2214184_tomcat.ssjinyao.com.key</span></div><div class="line">secret/tomcat-ingress-secret created</div><div class="line"><span class="comment"># kubectl describe secret tomcat-ingress-secret</span></div><div class="line">Name:         tomcat-ingress-secret</div><div class="line">Namespace:    default</div><div class="line">Labels:       &lt;none&gt;</div><div class="line">Annotations:  &lt;none&gt;</div><div class="line"></div><div class="line">Type:  kubernetes.io/tls</div><div class="line"></div><div class="line">Data</div><div class="line">====</div><div class="line">tls.crt:  3659 bytes</div><div class="line">tls.key:  1675 bytes</div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim ingress-tomcat-tls.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">ingress-tomcat-tls</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  tls:</span></div><div class="line"><span class="attr">  - hosts:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">tomcat.ssjinyao.com</span></div><div class="line"><span class="attr">    secretName:</span> <span class="string">tomcat-ingress-secret</span></div><div class="line"><span class="attr">  rules:</span></div><div class="line"><span class="attr">  - host:</span> <span class="string">tomcat.ssjinyao.com</span></div><div class="line"><span class="attr">    http:</span></div><div class="line"><span class="attr">      paths:</span></div><div class="line"><span class="attr">      - path:</span></div><div class="line"><span class="attr">        backend:</span></div><div class="line"><span class="attr">          serviceName:</span> <span class="string">tomcat</span></div><div class="line"><span class="attr">          servicePort:</span> <span class="number">8080</span></div><div class="line"><span class="comment"># kubectl apply -f ingress-tomcat-tls.yaml</span></div><div class="line"><span class="comment">#  kubectl get ingress</span></div><div class="line"><span class="string">NAME</span>                 <span class="string">HOSTS</span>                 <span class="string">ADDRESS</span>   <span class="string">PORTS</span>     <span class="string">AGE</span></div><div class="line"><span class="string">ingress-tomcat</span>       <span class="string">tomcat.ssjinyao.com</span>             <span class="number">80</span>        <span class="number">39</span><span class="string">m</span></div><div class="line"><span class="string">ingress-tomcat-tls</span>   <span class="string">tomcat.ssjinyao.com</span>             <span class="number">80</span><span class="string">,</span> <span class="number">443</span>   <span class="number">93</span><span class="string">s</span></div><div class="line"><span class="comment"># kubectl describe ingress ingress-tomcat-tls</span></div><div class="line"><span class="attr">Name:</span>             <span class="string">ingress-tomcat-tls</span></div><div class="line"><span class="attr">Namespace:</span>        <span class="string">default</span></div><div class="line"><span class="attr">Address:</span></div><div class="line"><span class="string">Default</span> <span class="attr">backend:</span>  <span class="attr">default-http-backend:80</span> <span class="string">(&lt;none&gt;)</span></div><div class="line"><span class="attr">TLS:</span></div><div class="line">  <span class="string">tomcat-ingress-secret</span> <span class="string">terminates</span> <span class="string">tomcat.ssjinyao.com</span></div><div class="line"><span class="attr">Rules:</span></div><div class="line">  <span class="string">Host</span>                 <span class="string">Path</span>  <span class="string">Backends</span></div><div class="line"><span class="bullet">  -</span><span class="meta">---</span>                 <span class="bullet">----</span>  <span class="bullet">--------</span></div><div class="line">  <span class="string">tomcat.ssjinyao.com</span></div><div class="line"><span class="attr">                          tomcat:</span><span class="number">8080</span> <span class="string">(10.244.1.153:8080,10.244.2.171:8080,10.244.3.170:8080)</span></div><div class="line"><span class="attr">Annotations:</span></div><div class="line">  <span class="string">kubectl.kubernetes.io/last-applied-configuration:</span>  <span class="string">&#123;"apiVersion":"extensions/v1beta1","kind":"Ingress","metadata":&#123;"annotations":&#123;"kubernetes.io/ingress.class":"nginx"&#125;,"name":"ingress-tomcat-tls","namespace":"default"&#125;,"spec":&#123;"rules":[&#123;"host":"tomcat.ssjinyao.com","http":&#123;"paths":[&#123;"backend":&#123;"serviceName":"tomcat","servicePort":8080&#125;,"path":null&#125;]&#125;&#125;],"tls":[&#123;"hosts":["tomcat.ssjinyao.com"],"secretName":"tomcat-ingress-secret"&#125;]&#125;&#125;</span></div><div class="line"></div><div class="line">  <span class="string">kubernetes.io/ingress.class:</span>  <span class="string">nginx</span></div><div class="line"><span class="attr">Events:</span></div><div class="line">  <span class="string">Type</span>    <span class="string">Reason</span>  <span class="string">Age</span>    <span class="string">From</span>                      <span class="string">Message</span></div><div class="line"><span class="bullet">  -</span><span class="meta">---</span>    <span class="bullet">------</span>  <span class="bullet">----</span>   <span class="bullet">----</span>                      <span class="bullet">-------</span></div><div class="line">  <span class="string">Normal</span>  <span class="string">CREATE</span>  <span class="number">2</span><span class="string">m29s</span>  <span class="string">nginx-ingress-controller</span>  <span class="string">Ingress</span> <span class="string">default/ingress-tomcat-tls</span></div></pre></td></tr></table></figure><p><img src="/images/ingress-nginx-tomcat-https.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesæ“ä½œè®°å½•(ä¸€)</title>
      <link href="/2019/04/25/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%951/"/>
      <url>/2019/04/25/kubernetes%E5%AE%9E%E6%93%8D%E8%AE%B0%E5%BD%951/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-æ“ä½œè®°å½•-ä¸€"><a href="#kubernetes-æ“ä½œè®°å½•-ä¸€" class="headerlink" title="kubernetes æ“ä½œè®°å½•(ä¸€)"></a>kubernetes æ“ä½œè®°å½•(ä¸€)</h1><p><img src="/images/docker_kubernetes.png" alt=""><br>kubernetes æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œå…¶ä¸­ä¸€ç§æ–¹å¼æ˜¯å°†kubernetes æ¯ä¸ªç»„ä»¶éƒ½ä»¥ç³»ç»Ÿè¿›ç¨‹çš„æ–¹å¼è¿è¡Œæˆç³»ç»Ÿå±‚é¢çš„æœåŠ¡;è¿™æ ·çš„éƒ¨ç½²ç¹çè€Œå¤æ‚ï¼Œå½“ç„¶ä¹Ÿå¯ç”¨åˆ«äººå†™çš„ansibleè‡ªåŠ¨åŒ–å·¥å…·æ¨é€ä¸€æ¬¡;<br>å¦å¤–ä¸€éƒ¨ç½²éƒ¨ç½²æ–¹å¼æ˜¯å°±æ˜¯ç”¨ kubeadm å°† Kuberntes æ¯ä¸ªç»„ä»¶éƒ½Podå½¢åŠ¿è¿›è¡Œéƒ¨ç½²;</p><h2 id="ä½¿ç”¨-kubeadm-é›†ç¾¤éƒ¨ç½²-kubernetes"><a href="#ä½¿ç”¨-kubeadm-é›†ç¾¤éƒ¨ç½²-kubernetes" class="headerlink" title="ä½¿ç”¨ kubeadm é›†ç¾¤éƒ¨ç½²  kubernetes"></a>ä½¿ç”¨ kubeadm é›†ç¾¤éƒ¨ç½²  kubernetes</h2><ol><li>èŠ‚ç‚¹ç½‘ç»œ 10.1.87.0/24</li><li>Podç½‘ç»œ 10.244.0.0/16</li><li>Serviceç½‘ç»œ 10.96.0.0/12</li></ol><h3 id="éƒ¨ç½²å‡†å¤‡"><a href="#éƒ¨ç½²å‡†å¤‡" class="headerlink" title="éƒ¨ç½²å‡†å¤‡"></a>éƒ¨ç½²å‡†å¤‡</h3><p>kubeadm éœ€è¦æ¯ä¸ªèŠ‚ç‚¹éƒ½å®‰è£…  kubelte,docker  è€ŒæŠŠå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹åˆå§‹åŒ–ä¸ºmaster;<br>å…¶kuberntes è‡ªå·±çš„å„ä¸ªç»„ä»¶éƒ½è¿è¡Œä¸ºPodï¼Œå…¶ä¸­çš„è¿™äº›Podéƒ½æ˜¯é™æ€Pod;</p><p>kubeadm<br>1ã€ master,nodes: å®‰è£…kubelet,kubeadm,docker<br>2ã€ master: kubeadm init<br>3ã€ nodes: kubeadm join<br>        <a href="https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.10.md" target="_blank" rel="external">https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.10.md</a></p><p>èŠ‚ç‚¹æœåŠ¡å™¨å…±å››å°ï¼Œ/etc/hostsé…ç½®ä¿¡æ¯å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10.1.87.80  master</div><div class="line">10.1.87.81  node01</div><div class="line">10.1.87.82  node02</div><div class="line">10.1.87.83  node03</div></pre></td></tr></table></figure><p>æ³¨: å››å°èŠ‚ç‚¹æœåŠ¡å™¨æ—¶é—´éœ€è¦åŒæ­¥</p><h3 id="é…ç½®-kubernetes-åŠ-docker-çš„Yumæº"><a href="#é…ç½®-kubernetes-åŠ-docker-çš„Yumæº" class="headerlink" title="é…ç½® kubernetes åŠ docker çš„Yumæº"></a>é…ç½® kubernetes åŠ docker çš„Yumæº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Master:é…ç½®</div><div class="line"><span class="comment"># vim /etc/yum.repos.d/kubernetes.repo</span></div><div class="line">[kubernetes]</div><div class="line">name=kebernetes</div><div class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</div><div class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</div><div class="line">gpgcheck=1</div><div class="line">enabled=1</div><div class="line"><span class="comment"># cd /etc/yum.repos.d/ &amp;&amp; wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></div><div class="line"><span class="comment"># yum clean all &amp;&amp; yum makecache</span></div><div class="line">åŒæ­¥Yumé…ç½®åˆ°å…¶å®ƒèŠ‚ç‚¹ </div><div class="line"><span class="comment"># for i in &#123;1..3&#125; ;do  scp docker-ce.repo kubernetes.repo node0$i:/etc/yum.repos.d/ ; done</span></div></pre></td></tr></table></figure><p>å››å°æœåŠ¡å™¨å®‰è£…ä»¥ä¸‹è½¯ä»¶åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum -y install docker-ce kubelet kubeadm kubectl</span></div><div class="line">å‡ºç°gpgkeyé—®é¢˜ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³</div><div class="line"><span class="comment"># wget https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg </span></div><div class="line"><span class="comment"># rpm --import rpm-package-key.gpg</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">master</div><div class="line"><span class="comment"># vim /usr/lib/systemd/system/docker.service</span></div><div class="line">åœ¨[service]ä¸‹æ·»åŠ ä»¥ä¸‹å†…å®¹</div><div class="line">Environment=<span class="string">"HTTPS_PROXY=http://www.ik8s.io:10080"</span></div><div class="line">Environment=<span class="string">"NO_PROXY=127.0.0.0/8, 10.1.87.0/24"</span></div><div class="line"><span class="comment"># systemctl daemon-reload</span></div><div class="line"><span class="comment"># systemctl restart docker</span></div><div class="line"><span class="comment"># docker info</span></div></pre></td></tr></table></figure><p>ç¡®ä¿ä»¥ä¸‹ä¸¤ä¸ªå†…æ ¸å‚æ•°éƒ½æ˜¯å¼€å¯çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /proc/sys/net/bridge/bridge-nf-call-ip6tables</span></div><div class="line">1</div><div class="line"><span class="comment"># cat /proc/sys/net/bridge/bridge-nf-call-iptables</span></div><div class="line">1</div></pre></td></tr></table></figure><p>æŸ¥çœ‹kubelet æ‰€ç”Ÿæˆçš„æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># rpm -ql kubelet</span></div><div class="line">/etc/kubernetes/manifests</div><div class="line">/etc/sysconfig/kubelet</div><div class="line">/usr/bin/kubelet</div><div class="line">/usr/lib/systemd/system/kubelet.service</div><div class="line"><span class="comment"># systemctl enable kubelet</span></div><div class="line"><span class="comment"># systemctl enable docker</span></div></pre></td></tr></table></figure><p>æˆ–è€…ç”¨è„šæœ¬ä¸‹è½½ï¼Œå¹¶ä¿®æ”¹æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim docker_install_kubelet_image.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0 k8s.gcr.io/kube-apiserver:v1.14.0</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0 k8s.gcr.io/kube-controller-manager:v1.14.0</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1</div></pre></td></tr></table></figure><p>æŸ¥çœ‹ kubeadm init åˆå§‹åŒ–é›†ç¾¤çš„å¸®åŠ©ä¿¡æ¯ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubeadm init --help</span></div></pre></td></tr></table></figure><h3 id="kubernetes-åˆå§‹åŒ–"><a href="#kubernetes-åˆå§‹åŒ–" class="headerlink" title="kubernetes åˆå§‹åŒ–"></a>kubernetes åˆå§‹åŒ–</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim  /etc/sysconfig/kubelet</span></div><div class="line">KUBELET_EXTRA_ARGS=<span class="string">"--fail-swap-on=false"</span></div><div class="line"><span class="comment"># kubeadm  init --kubernetes-version=v1.14.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=swap</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir -p $HOME/.kube</span></div><div class="line"><span class="comment"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></div><div class="line"><span class="comment"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></div><div class="line">kubeadm join 10.1.87.80:6443 --token 7pr4nt.q2vfoir7qia0vrcd \</div><div class="line">    --discovery-token-ca-cert-hash sha256:7e38f83642e4633a48efa1bd2bdc3cd2523e83736091b38ead58c88530758bdc</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get cs (componentstatus)</span></div><div class="line">NAME                 STATUS    MESSAGE             ERROR</div><div class="line">scheduler            Healthy   ok</div><div class="line">controller-manager   Healthy   ok</div><div class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get nodes</span></div><div class="line">NAME                 STATUS     ROLES    AGE   VERSION</div><div class="line">master   NotReady   master   23m   v1.14.1</div></pre></td></tr></table></figure><p>éƒ¨ç½²flannel</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></div></pre></td></tr></table></figure><p>è¿™æ—¶å†çœ‹kubernetesé›†ç¾¤å·²ç»è¿è¡Œèµ·æ¥äº† </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get nodes</span></div><div class="line">NAME                 STATUS   ROLES    AGE   VERSION</div><div class="line">master   Ready    master   27m   v1.14.1</div></pre></td></tr></table></figure><p>æŸ¥çœ‹Kubernetesçš„åç§°ç©ºé—´ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get ns</span></div><div class="line">NAME              STATUS   AGE</div><div class="line">default           Active   28m</div><div class="line">kube-node-lease   Active   28m</div><div class="line">kube-public       Active   28m</div><div class="line">kube-system       Active   28m</div></pre></td></tr></table></figure><h3 id="å…¶å®ƒnode-1-3-èŠ‚ç‚¹åŠ å…¥kubernetes-é›†ç¾¤"><a href="#å…¶å®ƒnode-1-3-èŠ‚ç‚¹åŠ å…¥kubernetes-é›†ç¾¤" class="headerlink" title="å…¶å®ƒnode{1..3}èŠ‚ç‚¹åŠ å…¥kubernetes é›†ç¾¤"></a>å…¶å®ƒnode{1..3}èŠ‚ç‚¹åŠ å…¥kubernetes é›†ç¾¤</h3><p>åœ¨node{1..3} åˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl start docker  &amp;&amp; systemctl enable docker &amp;&amp; systemctl enable kubelet</span></div><div class="line"><span class="comment"># kubeadm join 10.1.87.80:6443 --token 7pr4nt.q2vfoir7qia0vrcd     --discovery-token-ca-cert-hash sha256:7e38f83642e4633a48efa1bd2bdc3cd2523e83736091b38ead58c88530758bdc --ignore-preflight-errors=swap</span></div></pre></td></tr></table></figure><p>æ³¨: è¿™é‡Œéœ€è¦æ‰‹åŠ¨å»ä¸‹è½½æŒ‡å®šçš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim  docker_install_join_kublet_image.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</div><div class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0</div><div class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0</div></pre></td></tr></table></figure><p>å°†è¿™ä¸ªè„šæœ¬åŒæ­¥åˆ°å…¶å®ƒæ‰€æœ‰ä»æœåŠ¡å™¨å¹¶æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># scp docker_install_join_kublet_image.sh  node02:/root/</span></div><div class="line"><span class="comment"># scp docker_install_join_kublet_image.sh  node03:/root/</span></div><div class="line"><span class="comment"># å…¶ä½™èŠ‚ç‚¹æ‰§è¡Œ</span></div><div class="line"><span class="comment"># sh docker_install_join_kublet_image.sh</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get nodes</span></div><div class="line">NAME                   STATUS   ROLES    AGE   VERSION</div><div class="line">node01   Ready    &lt;none&gt;   74m   v1.14.1</div><div class="line">node02   Ready    &lt;none&gt;   74m   v1.14.1</div><div class="line">node03   Ready    &lt;none&gt;   71m   v1.14.1</div><div class="line">master   Ready    master   16h   v1.14.</div></pre></td></tr></table></figure><p>è‡³æ­¤kubernetes é›†ç¾¤å·²ç»åˆå§‹åŒ–å®Œæˆ</p><h2 id="kubernetes-åº”ç”¨å¿«é€Ÿå…¥é—¨"><a href="#kubernetes-åº”ç”¨å¿«é€Ÿå…¥é—¨" class="headerlink" title="kubernetes åº”ç”¨å¿«é€Ÿå…¥é—¨"></a>kubernetes åº”ç”¨å¿«é€Ÿå…¥é—¨</h2><p>æè¿°ä¸€ä¸ªèŠ‚ç‚¹ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl describe node node01</span></div></pre></td></tr></table></figure><p>æŸ¥çœ‹kubernetes é›†ç¾¤ä¿¡æ¯ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl version</span></div><div class="line"><span class="comment"># kubectl cluster-info</span></div></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªnginx Pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1</span></div></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># curl 10.244.3.2</div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">    body &#123;</span></div><div class="line"><span class="undefined">        width: 35em;</span></div><div class="line"><span class="undefined">        margin: 0 auto;</span></div><div class="line"><span class="undefined">        font-family: Tahoma, Verdana, Arial, sans-serif;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</div><div class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.org/"</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">Commercial support is available at</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.com/"</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><p>å½“æŠŠpod æ‰‹åŠ¨åˆ é™¤æ—¶ï¼Œä¼šé‡æ–°åˆ›å»ºï¼Œå› ä¸ºé¦–æ¬¡åˆ›å»ºpod æ—¶æŒ‡å®šäº† replicas=1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl delete pod nginx-deploy-55d8d67cf-qwlc2</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get pods  -o wide</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE     IP           NODE                   NOMINATED NODE   READINESS GATES</div><div class="line">nginx-deploy-55d8d67cf-qj9z8   1/1     Running   0          5m44s   10.244.1.2   node01                 &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure><p>æš´éœ²æœåŠ¡ç«¯å£ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl expose deployment nginx-deploy --name=nginx --port=80 --target-port=80 --protocol=TCP</span></div><div class="line">service/nginx exposed</div><div class="line"><span class="comment"># kubectl get svc</span></div><div class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   2d16h</div><div class="line">nginx        ClusterIP   10.96.181.70   &lt;none&gt;        80/TCP    52s</div></pre></td></tr></table></figure><p>åœ¨é›†ç¾¤å†…éƒ¨è®¿é—® 10.96.181.70 </p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"># curl 10.96.181.70</div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">    body &#123;</span></div><div class="line"><span class="undefined">        width: 35em;</span></div><div class="line"><span class="undefined">        margin: 0 auto;</span></div><div class="line"><span class="undefined">        font-family: Tahoma, Verdana, Arial, sans-serif;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</div><div class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.org/"</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">Commercial support is available at</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.com/"</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div><div class="line">You have new mail in /var/spool/mail/root</div></pre></td></tr></table></figure><p>æŸ¥çœ‹ kube-system (kube-dns) çš„CLUSTER-IP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get svc -n kube-system</span></div><div class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</div><div class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   2d16h</div></pre></td></tr></table></figure><p>åˆ›å»ºå®¢æˆ·ç«¯ Pod </p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"># kubectl run client --image=busybox --replicas=1 -it --restart=Never</div><div class="line">/ # cat /etc/resolv.conf</div><div class="line">nameserver 10.96.0.10</div><div class="line">search default.svc.cluster.local svc.cluster.local cluster.local localdomain</div><div class="line">options ndots:5</div><div class="line"># dig -t A  nginx.default.svc.cluster.local @10.96.0.10</div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-73.el7_6 &lt;&lt;&gt;&gt; -t A nginx.default.svc.cluster.local @10.96.0.10</div><div class="line">;; global options: +cmd</div><div class="line">;; Got answer:</div><div class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 19937</div><div class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</div><div class="line">;; WARNING: recursion requested but not available</div><div class="line"></div><div class="line">;; OPT PSEUDOSECTION:</div><div class="line">; EDNS: version: 0, flags:; udp: 4096</div><div class="line">;; QUESTION SECTION:</div><div class="line">;nginx.default.svc.cluster.local. INA</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">nginx.default.svc.cluster.local. 5 INA10.96.181.70</div><div class="line"></div><div class="line">;; Query time: 1 msec</div><div class="line">;; SERVER: 10.96.0.10#53(10.96.0.10)</div><div class="line">;; WHEN: Sun Apr 28 10:41:56 CST 2019</div><div class="line">;; MSG SIZE  rcvd: 107</div><div class="line"></div><div class="line">/ # wget -O - -q nginx</div><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">    body &#123;</span></div><div class="line"><span class="undefined">        width: 35em;</span></div><div class="line"><span class="undefined">        margin: 0 auto;</span></div><div class="line"><span class="undefined">        font-family: Tahoma, Verdana, Arial, sans-serif;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to nginx!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and</div><div class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.org/"</span>&gt;</span>nginx.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">Commercial support is available at</div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://nginx.com/"</span>&gt;</span>nginx.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for using nginx.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=2</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get deployment -w</span></div><div class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</div><div class="line">myapp          1/2     2            1           70s</div><div class="line">nginx-deploy   1/1     1            1           60m</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl expose deployment myapp --name=myapp --port=80</span></div></pre></td></tr></table></figure><p>ä¸¤ä¸ªpod ä¹‹é—´éšæœºè°ƒåº¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/ <span class="comment"># wget -O - -q myapp</span></div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-fhf7w</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-fhf7w</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-fhf7w</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-fhf7w</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-fhf7w</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-xnslk</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-xnslk</div><div class="line">/ <span class="comment"># wget -O - -q myapp/hostname.html</span></div><div class="line">myapp-5bc569c47d-fhf7w</div></pre></td></tr></table></figure><p>ä¿®æ”¹podæ•°é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl scale --replicas=5 deployment myapp</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get pods</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">client                         1/1     Running   0          35m</div><div class="line">myapp-5bc569c47d-fhf7w         1/1     Running   0          22m</div><div class="line">myapp-5bc569c47d-mqzdc         1/1     Running   0          112s</div><div class="line">myapp-5bc569c47d-w55fb         1/1     Running   0          13m</div><div class="line">myapp-5bc569c47d-xkk2x         1/1     Running   0          112s</div><div class="line">myapp-5bc569c47d-xnslk         1/1     Running   0          22m</div><div class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          32m</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># while sleep 1 ; do wget -O - -q myapp/hostname.html ;done</span></div><div class="line">myapp-5bc569c47d-mqzdc</div><div class="line">myapp-5bc569c47d-mqzdc</div><div class="line">myapp-5bc569c47d-xkk2x</div><div class="line">myapp-5bc569c47d-xnslk</div><div class="line">myapp-5bc569c47d-w55fb</div><div class="line">myapp-5bc569c47d-mqzdc</div><div class="line">myapp-5bc569c47d-w55fb</div><div class="line">myapp-5bc569c47d-fhf7w</div><div class="line">myapp-5bc569c47d-xnslk</div><div class="line">myapp-5bc569c47d-xkk2x</div><div class="line">myapp-5bc569c47d-xnslk</div></pre></td></tr></table></figure><p>æ»šåŠ¨æ›´æ–° </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl set image deployment myapp myapp=ikubernetes/myapp:v2</span></div><div class="line">deployment.extensions/myapp image updated</div></pre></td></tr></table></figure><p>å®æ—¶ç›‘æ§æ»šåŠ¨æ›´æ–°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl rollout status deployment myapp</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># while sleep 1 ; do wget -O - -q myapp ;done</span></div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v2 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div></pre></td></tr></table></figure><p>å›æ»šæ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl rollout undo deployment myapp</span></div><div class="line">deployment.extensions/myapp rolled back</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/ <span class="comment"># while sleep 1 ; do wget -O - -q myapp ;done</span></div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div><div class="line">Hello MyApp | Version: v1 | &lt;a href=<span class="string">"hostname.html"</span>&gt;Pod Name&lt;/a&gt;</div></pre></td></tr></table></figure><p>ä»¥myapp ä¸ºä¾‹ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨è¿›è¡Œè®¿é—®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl edit svc myapp</span></div><div class="line"><span class="built_in">type</span>: ClusterIp æ”¹ä¸ºä»¥ä¸‹</div><div class="line"><span class="built_in">type</span>: NodePort</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get svc</span></div><div class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</div><div class="line">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        2d17h</div><div class="line">myapp        NodePort    10.100.210.54   &lt;none&gt;        80:32672/TCP   46m</div><div class="line">nginx        ClusterIP   10.96.181.70    &lt;none&gt;        80/TCP         77m</div></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯å¤–éƒ¨è®¿é—®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~ â¤ <span class="keyword">while</span> sleep 1 ; <span class="keyword">do</span> curl http://10.1.87.80:32672/hostname.html ; <span class="keyword">done</span></div><div class="line">myapp-86984b4c7c-2vpjq</div><div class="line">myapp-86984b4c7c-2vpjq</div><div class="line">myapp-86984b4c7c-vw5md</div><div class="line">myapp-86984b4c7c-vj7qm</div><div class="line">myapp-86984b4c7c-vj7qm</div><div class="line">myapp-86984b4c7c-2vpjq</div></pre></td></tr></table></figure><p>æ­¤æ—¶ä¾¿å¯ä»¥ä½¿ç”¨keepalived + nginx(æˆ–haproxy)ç­‰å®ç°è´Ÿè½½å‡è¡¡</p><h2 id="èµ„æºå®šä¹‰æ¸…å•å…¥é—¨"><a href="#èµ„æºå®šä¹‰æ¸…å•å…¥é—¨" class="headerlink" title="èµ„æºå®šä¹‰æ¸…å•å…¥é—¨"></a>èµ„æºå®šä¹‰æ¸…å•å…¥é—¨</h2><p>å®šä¹‰ä¸€ä¸ªç®€å•çš„èµ„æºæ¸…å• </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim pod-demo.yaml</span></div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-demo</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">    app: myapp</div><div class="line">    tier: frontend</div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: myapp</div><div class="line">    image: ikubernetes/myapp:v1</div><div class="line">  - name: busybox</div><div class="line">    image: busybox:latest</div><div class="line">    <span class="built_in">command</span>:</div><div class="line">    - <span class="string">"/bin/sh"</span></div><div class="line">    - <span class="string">"-c"</span></div><div class="line">    - <span class="string">"sleep 5000"</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create -f pod-demo.yaml</span></div><div class="line"><span class="comment"># kubectl get pods -o wide</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE     IP             NODE                   NOMINATED NODE   READINESS GATE</div><div class="line">pod-demo                       1/2     Running   5          4m19s   10.244.3.124   node03                 &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure><p>æŸ¥çœ‹ç›¸å…³Podç›¸å…³ä¿¡æ¯ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl describe pod-demo</span></div></pre></td></tr></table></figure><h2 id="Podæ§åˆ¶å™¨åº”ç”¨è¿›é˜¶"><a href="#Podæ§åˆ¶å™¨åº”ç”¨è¿›é˜¶" class="headerlink" title="Podæ§åˆ¶å™¨åº”ç”¨è¿›é˜¶"></a>Podæ§åˆ¶å™¨åº”ç”¨è¿›é˜¶</h2><p>-L é€‰é¡¹ ç”¨äºæŒ‡å®šæ˜¾ç¤ºæŒ‡å®šèµ„æºå¯¹è±¡ç±»åˆ«æ‰€æœ‰èµ„æºå¯¹åº”æ ‡ç­¾çš„å€¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get pods -L app</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE    APP</div><div class="line">client                         1/1     Running   0          8d</div><div class="line">myapp-86984b4c7c-rf4lz         1/1     Running   0          27h</div><div class="line">myapp-86984b4c7c-wss2h         1/1     Running   0          28h</div><div class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</div><div class="line">pod-demo                       2/2     Running   121        7d2h   myapp</div></pre></td></tr></table></figure><p>-l è·å–æ ‡ç­¾ï¼Œåšæ ‡ç­¾è¿‡æ»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get pods -l app --show-labels</span></div><div class="line">NAME       READY   STATUS    RESTARTS   AGE    LABELS</div><div class="line">pod-demo   2/2     Running   121        7d2h   app=myapp,tier=frontend</div></pre></td></tr></table></figure><p>æ˜¾ç¤ºå¤šä¸ªæ ‡ç­¾çš„æ ‡ç­¾å€¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get pods -L app,run</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE    APP     RUN</div><div class="line">client                         1/1     Running   0          8d             client</div><div class="line">myapp-86984b4c7c-rf4lz         1/1     Running   0          27h            myapp</div><div class="line">myapp-86984b4c7c-wss2h         1/1     Running   0          28h            myapp</div><div class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d             nginx-deploy</div><div class="line">pod-demo                       2/2     Running   121        7d2h   myapp</div></pre></td></tr></table></figure><p>pod-demo å†æ¬¡æ‰“æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl label pods pod-demo release=canary</span></div><div class="line">pod/pod-demo labeled</div><div class="line"><span class="comment"># kubectl  get  pods -l app --show-labels;</span></div><div class="line">NAME       READY   STATUS    RESTARTS   AGE    LABELS</div><div class="line">pod-demo   2/2     Running   121        7d2h   app=myapp,release=canary,tier=frontend</div></pre></td></tr></table></figure><p>å¦‚æœå·²æœ‰æ ‡ç­¾å¼ºè¡Œæ‰“æ ‡çš„è¯ä¼šæŠ¥é”™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl label pods pod-demo release=stable</span></div><div class="line">error: <span class="string">'release'</span> already has a value (canary), and --overwrite is <span class="literal">false</span></div></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™éœ€è¦åŠ ä¸Š â€“overwrite </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl label pods pod-demo release=stable --overwrite</span></div><div class="line">pod/pod-demo labeled</div></pre></td></tr></table></figure><p>æŸ¥çœ‹æ—¢æœ‰releaseæ ‡ç­¾çš„åˆæœ‰appæ ‡ç­¾çš„Pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get pods -l release,app</span></div><div class="line">NAME       READY   STATUS    RESTARTS   AGE</div><div class="line">pod-demo   2/2     Running   121        7d2h</div></pre></td></tr></table></figure><p>ç»™nginx-deploy Podæ‰“æ ‡ç­¾ release=canary</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl label pods nginx-deploy-55d8d67cf-v85hb release=canary</span></div><div class="line">pod/nginx-deploy-55d8d67cf-v85hb labeled</div></pre></td></tr></table></figure><p>æŸ¥çœ‹ æ ‡ç­¾release=canaryçš„Pod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get pods -l release</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</div><div class="line">pod-demo                       2/2     Running   121        7d3h</div><div class="line"><span class="comment"># kubectl  get pods -l release=canary</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div></pre></td></tr></table></figure><p>æ ‡ç­¾é€‰æ‹©å™¨å¤šæ¡ä»¶é€‰æ‹©</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get pods -l release=stable,app=myapp</span></div><div class="line">NAME       READY   STATUS    RESTARTS   AGE</div><div class="line">pod-demo   2/2     Running   121        7d3h</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get pods -l release!=stable</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">client                         1/1     Running   0          8d</div><div class="line">myapp-86984b4c7c-rf4lz         1/1     Running   0          27h</div><div class="line">myapp-86984b4c7c-wss2h         1/1     Running   0          28h</div><div class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl get pods -l "release in (canary,beta,alpha)"</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">nginx-deploy-55d8d67cf-v85hb   1/1     Running   0          8d</div><div class="line"><span class="comment"># kubectl get pods -l "release notin (canary,beta,alpha)"</span></div><div class="line">NAME                     READY   STATUS    RESTARTS   AGE</div><div class="line">client                   1/1     Running   0          8d</div><div class="line">myapp-86984b4c7c-rf4lz   1/1     Running   0          27h</div><div class="line">myapp-86984b4c7c-wss2h   1/1     Running   0          28h</div><div class="line">pod-demo                 2/2     Running   121        7d3h</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl  get nodes --show-labels</span></div><div class="line">NAME                   STATUS   ROLES    AGE   VERSION   LABELS</div><div class="line">node01                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node01,kubernetes.io/os=linux</div><div class="line">node02                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node02,kubernetes.io/os=linux</div><div class="line">node03                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node03,kubernetes.io/os=linux</div><div class="line">master                 Ready    master   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master,kubernetes.io/os=linux,node-role.kubernetes.io/master=</div></pre></td></tr></table></figure><p>ç»™node01 æ‰“é¢å¤–æ ‡ç­¾ï¼Œç£ç›˜ç±»å‹æœ‰å›ºæ€ç¡¬ç›˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl label nodes node01  disktype=ssd</span></div><div class="line"><span class="comment"># kubectl get nodes node01  --show-labels</span></div><div class="line">NAME                   STATUS   ROLES    AGE   VERSION   LABELS</div><div class="line">node01                 Ready    &lt;none&gt;   10d   v1.14.1   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=node01,kubernetes.io/os=linux</div></pre></td></tr></table></figure><p>è¿™æ ·åšçš„å¥½å¤„: å½“èŠ‚ç‚¹æœ‰æ ‡ç­¾åï¼Œéšåæ·»åŠ èµ„æºæ—¶å°±å¯ä»¥å¯¹èŠ‚ç‚¹æœ‰å€¾å‘æ€§</p><p>å¦‚ä¸‹ï¼Œåˆ›å»ºPodæ—¶æŒ‡å®šnodeSelector</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-demo</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">https</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">443</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></div><div class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    command:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"/bin/sh"</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"-c"</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"sleep 5000"</span></div><div class="line"><span class="attr">  nodeSelector:</span></div><div class="line"><span class="attr">    disktype:</span> <span class="string">ssd</span></div></pre></td></tr></table></figure><p>nodeSelector disktype: ssd<br>nodeName æŒ‡å®šç›´æ¥è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl describe pods pod-demo</span></div><div class="line">å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹ä¿¡æ¯ï¼Œç¡®å®špod-demo è¿è¡Œåœ¨node01ä¸Šé¢ </div><div class="line">  Type    Reason     Age    From                           Message</div><div class="line">  ----    ------     ----   ----                           -------</div><div class="line">  Normal  Scheduled  2m46s  default-scheduler              Successfully assigned default/pod-demo to node01</div></pre></td></tr></table></figure><p>annotations æ·»åŠ æ³¨è§£</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">pod-demo</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></div><div class="line"><span class="attr">  annotations:</span></div><div class="line">    <span class="string">ssjinyao.com/create-by:</span> <span class="string">"cluster admin"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">myapp</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">https</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">443</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></div><div class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    command:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"/bin/sh"</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"-c"</span></div><div class="line"><span class="bullet">    -</span> <span class="string">"sleep 5000"</span></div><div class="line"><span class="attr">  nodeSelector:</span></div><div class="line"><span class="attr">    disktype:</span> <span class="string">ssd</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl create -f pod-demo.yaml</span></div><div class="line"><span class="comment"># kubectl describe  pods pod-demo</span></div><div class="line">Annotations:        ssjinyao.com/create-by: cluster admin</div></pre></td></tr></table></figure><p>ExecAction ç”¨è‡ªå®šä¹‰çš„å‘½ä»¤å­˜æ´»æ€§æ¢æµ‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim liveness-exec.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">liveness-exec-pod</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">liveness-exec-container</span></div><div class="line"><span class="attr">    image:</span> <span class="attr">busybox:latest</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    command:</span> <span class="string">["/bin/sh"</span> <span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 3600"</span><span class="string">]</span></div><div class="line"><span class="attr">    livenessProbe:</span></div><div class="line"><span class="attr">      exec:</span></div><div class="line"><span class="attr">        command:</span> <span class="string">["test","-e","/tmp/healthy"]</span></div><div class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">      periodSeconds:</span> <span class="number">3</span></div><div class="line"><span class="comment"># kubectl create -f liveness-exec.yaml</span></div><div class="line"><span class="comment"># kubectl get pods -w</span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">client</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">10</span><span class="string">d</span></div><div class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">47</span><span class="string">s</span></div><div class="line"><span class="string">myapp-86984b4c7c-rf4lz</span>         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">3</span><span class="string">d4h</span></div><div class="line"><span class="string">myapp-86984b4c7c-wss2h</span>         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">3</span><span class="string">d5h</span></div><div class="line"><span class="string">nginx-deploy-55d8d67cf-v85hb</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">10</span><span class="string">d</span></div><div class="line"><span class="string">pod-demo</span>                       <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">34</span>         <span class="number">2</span><span class="string">d</span></div><div class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">1</span>          <span class="number">69</span><span class="string">s</span></div><div class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span>          <span class="number">2</span><span class="string">m19s</span></div><div class="line"><span class="string">liveness-exec-pod</span>              <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">3</span>          <span class="number">3</span><span class="string">m28s</span></div></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™liveness-exec-pod ä¼šä¸æ–­å› å­˜æ´»æ€§æ¢æµ‹è€Œé‡å¯</p><p>åŸºäºHTTPGetActionæ¢æµ‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim liveness-httpget.yaml</span></div><div class="line"><span class="comment"># cat liveness-httpget.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">liveness-httpget-pod</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">liveness-httpget-container</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    livenessProbe:</span></div><div class="line"><span class="attr">      httpGet:</span></div><div class="line"><span class="attr">        port:</span> <span class="string">http</span></div><div class="line"><span class="attr">        path:</span> <span class="string">/index.html</span></div><div class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">      periodSeconds:</span> <span class="number">3</span></div><div class="line"><span class="comment"># kubectl create -f liveness-httpget.yaml</span></div><div class="line"><span class="comment"># kubectl  exec liveness-httpget-pod -it -- /bin/sh</span></div><div class="line"><span class="comment"># rm -f /usr/share/nginx/html/index.html</span></div><div class="line"><span class="comment"># kubectl  get pods</span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">client</span>                         <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">10</span><span class="string">d</span></div><div class="line"><span class="string">liveness-httpget-pod</span>           <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">2</span>          <span class="number">6</span><span class="string">m31s</span></div></pre></td></tr></table></figure><p>å°±ç»­çŠ¶æ€æ£€æŸ¥ï¼Œå¦‚æœpodä¸å°±ç»­åˆ™ä¸å‘å¤–æä¾›æœåŠ¡</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim readiness-httpget.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">readiness-httpget-pod</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  containers:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">readiness-httpget-container</span></div><div class="line"><span class="attr">    image:</span> <span class="string">ikubernetes/myapp:v1</span></div><div class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">http</span></div><div class="line"><span class="attr">      containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">    readinessProbe:</span></div><div class="line"><span class="attr">      httpGet:</span></div><div class="line"><span class="attr">        port:</span> <span class="string">http</span></div><div class="line"><span class="attr">        path:</span> <span class="string">/index.html</span></div><div class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">1</span></div><div class="line"><span class="attr">      periodSeconds:</span> <span class="number">3</span></div><div class="line"><span class="comment"># kubectl exec readiness-httpget-pod -it -- /bin/sh</span></div><div class="line"><span class="string">/</span> <span class="comment"># rm -f /usr/share/nginx/html/index.html</span></div><div class="line"><span class="comment"># kubectl  get pods</span></div><div class="line"><span class="string">NAME</span>                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></div><div class="line"><span class="string">readiness-httpget-pod</span>          <span class="number">0</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="number">2</span><span class="string">m52s</span></div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°readinss-httpget-pod æ˜¯ä¸å°±ç»­çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kubectl exec readiness-httpget-pod -it -- /bin/sh</span></div><div class="line">/ <span class="comment"># echo "test html" &gt; /usr/share/nginx/html/index.html</span></div><div class="line"><span class="comment"># kubectl  get pods</span></div><div class="line">NAME                           READY   STATUS    RESTARTS   AGE</div><div class="line">readiness-httpget-pod          1/1     Running   0          4m30s</div></pre></td></tr></table></figure><p>å½“åˆ›å»ºå°±ç»ªæ¢æµ‹HTTPGeté¡µé¢æ–‡ä»¶æ—¶ï¼Œ pod å°±ç»ªçŠ¶æ€ç«‹é©¬æ¢å¤; </p><p>Podç”Ÿå‘½å‘¨æœŸè¡Œä¸ºï¼Œå¯åŠ¨å‰é’©å­ï¼Œç»ˆæ­¢å‰é’©å­ lifecycle postStart postStop;</p><p><code>æ³¨: å¯åŠ¨å®¹å™¨æ—¶å…ˆæ‰§è¡Œcommand å†æ‰§è¡ŒpostStartå› æ­¤ commandå‘½ä»¤ä¸èƒ½å¼ºä¾èµ–äºpostStartæ‰§è¡Œç»“æœ;</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim poststart-pod.yaml</span></div><div class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Pod</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">poststart-pod</span></div><div class="line"><span class="attr">    namespace:</span> <span class="string">default</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">    containers:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">busybox-httpd</span></div><div class="line"><span class="attr">      image:</span> <span class="attr">busybox:latest</span></div><div class="line"><span class="attr">      ports:</span></div><div class="line"><span class="attr">      - containerPort:</span> <span class="number">80</span></div><div class="line"><span class="attr">      imagePullPolicy:</span> <span class="string">IfNotPresent</span></div><div class="line"><span class="attr">      lifecycle:</span></div><div class="line"><span class="attr">        postStart:</span></div><div class="line"><span class="attr">          exec:</span></div><div class="line"><span class="attr">            command:</span> <span class="string">["/bin/sh","-c","echo</span> <span class="string">'welcome www.ssjinyao.com'</span> <span class="string">&gt;  /tmp/index.html"]</span></div><div class="line"><span class="string"></span><span class="attr">      command:</span> <span class="string">["/bin/sh"]</span></div><div class="line"><span class="attr">      args:</span> <span class="string">["-c","httpd</span> <span class="bullet">-h</span> <span class="string">/tmp</span>  <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="number">300000</span><span class="string">" ]</span></div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>fabricè‡ªåŠ¨åŒ–ä¹‹kvmç§æœ‰äº‘æœåŠ¡å™¨å¿«é€Ÿå¼€é€šä¸äº¤ä»˜</title>
      <link href="/2019/03/20/fabric%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bkvm%E7%A7%81%E6%9C%89%E4%BA%91%E5%BF%AB%E9%80%9F%E5%BC%80%E9%80%9A/"/>
      <url>/2019/03/20/fabric%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bkvm%E7%A7%81%E6%9C%89%E4%BA%91%E5%BF%AB%E9%80%9F%E5%BC%80%E9%80%9A/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€å…ˆæ¥çœ‹çœ‹éœ€æ±‚åŠå¯¹åº”çš„è®¾è®¡å›¾"><a href="#ä¸€ã€å…ˆæ¥çœ‹çœ‹éœ€æ±‚åŠå¯¹åº”çš„è®¾è®¡å›¾" class="headerlink" title="ä¸€ã€å…ˆæ¥çœ‹çœ‹éœ€æ±‚åŠå¯¹åº”çš„è®¾è®¡å›¾"></a>ä¸€ã€å…ˆæ¥çœ‹çœ‹éœ€æ±‚åŠå¯¹åº”çš„è®¾è®¡å›¾</h2><p><img src="/images/kvm-automation.png" alt=""></p><ul><li><p>ä»€ä¹ˆæ˜¯Fabric<br>Fabricæ˜¯ä¸€ä¸ªPythonçš„åº“ï¼Œæä¾›äº†ä¸°å¯Œçš„åŒSSHäº¤äº’çš„æ¥å£ï¼Œå¯ä»¥ç”¨æ¥åœ¨æœ¬åœ°æˆ–è¿œç¨‹æœºå™¨ä¸Šè‡ªåŠ¨åŒ–ã€æµæ°´åŒ–åœ°æ‰§è¡ŒShellå‘½ä»¤ã€‚<br>éå¸¸é€‚åˆç”¨æ¥åšåº”ç”¨çš„è¿œç¨‹éƒ¨ç½²åŠç³»ç»Ÿç»´æŠ¤ã€‚ç®€å•æ˜“ç”¨ï¼Œåªéœ€æ‡‚å¾—åŸºæœ¬çš„Shellå‘½ä»¤ã€‚</p></li><li><p>ç‰ˆæœ¬åŒºåˆ†<br>Fabricï¼šå®˜æ–¹Fabricï¼Œå…¼å®¹ Python 2 &amp; Python 3ï¼Œä½†ä¸å…¼å®¹Fabric 1.xçš„fabfileï¼›<br>fabric2ï¼š ä¸Fabricç›¸åŒï¼Œä»…ä½œä¸ºå¹³æ»‘è¿ç§»ï¼ˆä½¿ç”¨FabricåŒ…å®‰è£…1.x ç‰ˆæœ¬ï¼Œä½¿ç”¨Fabric2åŒ…å®‰è£…2.xç‰ˆæœ¬ï¼Œæ¥å®ç°1.xå’Œ2.xçš„å…±å­˜ï¼‰ï¼›<br>Fabric3ï¼šæ˜¯ä¸€ä¸ªåŸºäºFabric 1.x çš„forkï¼Œå…¼å®¹Python2 &amp; Python3ï¼Œå…¼å®¹ Fabric1.x çš„ fabfileï¼›</p></li></ul><h2 id="äºŒã€é¡¹ç›®ç»“æ„"><a href="#äºŒã€é¡¹ç›®ç»“æ„" class="headerlink" title="äºŒã€é¡¹ç›®ç»“æ„"></a>äºŒã€é¡¹ç›®ç»“æ„</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">kvm_create/</div><div class="line">â”œâ”€â”€ application</div><div class="line">â”‚Â Â  â”œâ”€â”€ appcreate.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ kvmcreate.py</div><div class="line">â”œâ”€â”€ config</div><div class="line">â”‚Â Â  â”œâ”€â”€ hosts.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ messages.py</div><div class="line">â”‚Â Â  â””â”€â”€ test</div><div class="line">â”‚Â Â      â”œâ”€â”€ __init__.py</div><div class="line">â”‚Â Â      â”œâ”€â”€ kvm_config.py</div><div class="line">â”œâ”€â”€ files</div><div class="line">â”‚Â Â  â”œâ”€â”€ adminset_agent.tar.gz</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxxxx</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ backup.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ init_backup.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ lepus_slowquery.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql-x.x.xx-linux-glibcx.xx-x86_64.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ percona-toolkit_x.x.xx-x.tar.gz</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxxxx</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ backup.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ init_backup.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ lepus_slowquery.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql-x.xx.xx-linux-glibcx.xx-86_64.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ percona-toolkit_x.x.xx-x.tar.gz</div><div class="line">â”‚Â Â  â”œâ”€â”€ nginx</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nginx-1.xx.x.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx-1.xx.x.tar.gz</div><div class="line">â”‚Â Â  â”œâ”€â”€ node_exporter</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LICENSE</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ node_exporter</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ NOTICE</div><div class="line">â”‚Â Â  â”œâ”€â”€ php</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-x.x.xx.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-x.x.xx.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-x.x.xx.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-x.x.xx.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-x.x.xx.tar.gz</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ php.ini</div><div class="line">â”‚Â Â  â”œâ”€â”€ redis</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ redis-x.x.x.tar.gz</div><div class="line">â”‚Â Â  â””â”€â”€ zabbix</div><div class="line">â”‚Â Â      â””â”€â”€ zabbix-x.x.x.tar.gz</div><div class="line">â”œâ”€â”€ kernel</div><div class="line">â”‚Â Â  â”œâ”€â”€ clone.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ last.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxxxx.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxx.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ nginx.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ php.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ redis.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ standard.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ start.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ yum.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ zabbix_agent.py</div><div class="line">â”œâ”€â”€ kvm.py</div><div class="line">â”œâ”€â”€ local</div><div class="line">â”‚Â Â  â”œâ”€â”€ __init__.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ localall.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxxxxreplace.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxxreplace.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ nginxreplace.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ phpreplace.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ redisreplace.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ replacetemp.py</div><div class="line">â”‚Â Â  â”œâ”€â”€ zabbixreplace.py</div><div class="line">â”œâ”€â”€ templates</div><div class="line">â”‚Â Â  â”œâ”€â”€ hosts</div><div class="line">â”‚Â Â  â”œâ”€â”€ ifcfg-eth0</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxx</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ my.cnf</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql_install.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql.service</div><div class="line">â”‚Â Â  â”œâ”€â”€ mysqlxxxx</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ my.cnf</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql_install.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql.service</div><div class="line">â”‚Â Â  â”œâ”€â”€ nginx</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nginx.conf</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nginx_install.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nginx.service</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ vhost.conf</div><div class="line">â”‚Â Â  â”œâ”€â”€ php</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-fpm.conf</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php-fpm.service</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ php_install.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ www.conf</div><div class="line">â”‚Â Â  â”œâ”€â”€ redis</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ redis.conf</div><div class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ redis_install.sh</div><div class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ redis.service</div><div class="line">â”‚Â Â  â””â”€â”€ zabbix</div><div class="line">â”‚Â Â      â”œâ”€â”€ zabbix_agentd</div><div class="line">â”‚Â Â      â”œâ”€â”€ zabbix_agentd.conf</div><div class="line">â”‚Â Â      â””â”€â”€ zabbixagent_install.sh</div><div class="line">â”œâ”€â”€ tmp_cache</div><div class="line">â””â”€â”€ vars</div><div class="line">    â”œâ”€â”€ __init__.py</div><div class="line">    â”œâ”€â”€ kvmvar.py</div><div class="line">    â”œâ”€â”€ mysqlxxxx.py</div><div class="line">    â”œâ”€â”€ mysqlxxxx.py</div><div class="line">    â”œâ”€â”€ nginxvar.py</div><div class="line">    â”œâ”€â”€ phpvar.py</div><div class="line">    â”œâ”€â”€ redisvar.py</div><div class="line">    â””â”€â”€ zabbix_agentvar.py</div></pre></td></tr></table></figure><h2 id="ä¸‰ã€kernel-ç›®å½•ä¸‹çš„åŠŸèƒ½æ¨¡å—"><a href="#ä¸‰ã€kernel-ç›®å½•ä¸‹çš„åŠŸèƒ½æ¨¡å—" class="headerlink" title="ä¸‰ã€kernel ç›®å½•ä¸‹çš„åŠŸèƒ½æ¨¡å—"></a>ä¸‰ã€kernel ç›®å½•ä¸‹çš„åŠŸèƒ½æ¨¡å—</h2><h3 id="kvmæœåŠ¡å™¨é•œåƒclone-åŒæ­¥ã€kvm-xml-é…ç½®æ¨¡æ¿çš„ç”ŸæˆåŒæ­¥ï¼Œç½‘å¡é…ç½®æ–‡ä»¶æ•´åˆkvmæ–°æœåŠ¡å™¨"><a href="#kvmæœåŠ¡å™¨é•œåƒclone-åŒæ­¥ã€kvm-xml-é…ç½®æ¨¡æ¿çš„ç”ŸæˆåŒæ­¥ï¼Œç½‘å¡é…ç½®æ–‡ä»¶æ•´åˆkvmæ–°æœåŠ¡å™¨" class="headerlink" title="kvmæœåŠ¡å™¨é•œåƒclone åŒæ­¥ã€kvm xml é…ç½®æ¨¡æ¿çš„ç”ŸæˆåŒæ­¥ï¼Œç½‘å¡é…ç½®æ–‡ä»¶æ•´åˆkvmæ–°æœåŠ¡å™¨;"></a>kvmæœåŠ¡å™¨é•œåƒclone åŒæ­¥ã€kvm xml é…ç½®æ¨¡æ¿çš„ç”ŸæˆåŒæ­¥ï¼Œç½‘å¡é…ç½®æ–‡ä»¶æ•´åˆkvmæ–°æœåŠ¡å™¨;</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> local.replacetemp <span class="keyword">import</span> *</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">generate_kvmimg</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clone_cevsxx</span><span class="params">(self)</span>:</span></div><div class="line"></div><div class="line">        run(<span class="string">' [ -d'</span> + <span class="string">' '</span> + kvmtmpdir + <span class="string">' '</span> +<span class="string">']'</span> + <span class="string">' '</span> + <span class="string">'||'</span>  + <span class="string">' '</span> + <span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + kvmtmpdir)</div><div class="line">        run(<span class="string">'virt-clone -o '</span> + kvmce7name + <span class="string">' '</span> + <span class="string">'-n'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME + <span class="string">' '</span> + <span class="string">'-f'</span> + <span class="string">' '</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">'.img'</span>)</div><div class="line">      <span class="comment">#  run('mv' + ' ' + kvmdata + KVM_IP_HOSTNAME + '.img' + ' ' + kvmtmpdir)</span></div><div class="line">        run(<span class="string">'sed -i'</span> + <span class="string">' '</span>  + <span class="string">'"s'</span> + <span class="string">'#'</span> +  kvmtmpdir + <span class="string">'#'</span> + kvmdata + <span class="string">'#g"'</span> + <span class="string">' '</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">'.xml'</span> )</div><div class="line">        run(<span class="string">'cp'</span> + <span class="string">' '</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">'.xml'</span> + <span class="string">' '</span> + kvmtmpdir)</div><div class="line">        run(<span class="string">'virsh undefine'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_imgip</span><span class="params">(self)</span>:</span></div><div class="line">        rekvmeth = replace_tmp_file()</div><div class="line">        rekvmeth.kvm_eth0()</div><div class="line">        put(local_write_eth0 , kvmtmpdir)</div><div class="line">        rekvmeth.kvm_eth0_local_remove()</div><div class="line">        <span class="keyword">with</span> cd(kvmtmpdir):</div><div class="line">            run(<span class="string">'virt-copy-in'</span> + <span class="string">' '</span> + <span class="string">'ifcfg-eth0'</span> + <span class="string">' '</span> + <span class="string">'-a'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME + <span class="string">'.img'</span> + <span class="string">' '</span> + kvm_eth0_dir + <span class="string">'/'</span>)</div><div class="line">            run(<span class="string">'rm -f'</span> + <span class="string">' '</span> + kvmtmpdir  + <span class="string">'ifcfg-eth0'</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_imgxml_cpu</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(kvmtmpdir):</div><div class="line">            run(<span class="string">'sed -i \"s\\current=\'2\'\\current=\''</span> + KVM_CPU +<span class="string">'\'\\g\"'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME + <span class="string">'.xml'</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_imgxml_mem</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(kvmtmpdir):</div><div class="line">            run(<span class="string">'sed -i \"s\\4194304\\'</span> + KVM_MEM + <span class="string">'\\g\"'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME + <span class="string">'.xml'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scp_cloned_img</span><span class="params">(self)</span>:</span></div><div class="line">            run(<span class="string">'scp'</span> + <span class="string">' '</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">'.img'</span> + <span class="string">' '</span> + <span class="string">'root@'</span> + TARGETS_HOST + <span class="string">':'</span> + kvmdata)</div><div class="line">            <span class="comment">#run('scp' + ' '  + '-l 25000' + ' ' + kvmtmpdir + KVM_IP_HOSTNAME + '.img' + ' ' + 'root@' + TARGETS_HOST + ':' + kvmdata)</span></div><div class="line">            run(<span class="string">'rm -f'</span> + <span class="string">' '</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">'.img'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scp_cloned_xml</span><span class="params">(self)</span>:</span></div><div class="line">            run(<span class="string">'scp'</span> + <span class="string">' '</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">'.xml'</span> + <span class="string">' '</span> + <span class="string">'root@'</span> + TARGETS_HOST + <span class="string">':'</span> + kvmqemu)</div><div class="line">            run(<span class="string">'rm -f'</span> + <span class="string">' '</span> + kvmtmpdir + KVM_IP_HOSTNAME + <span class="string">'.xml'</span>)</div></pre></td></tr></table></figure><p>çªç ´ <code>virt-copy-in å‘½ä»¤å¯ä»¥å°†å·²ç”Ÿæˆçš„ç½‘å¡é…ç½®æ–‡ä»¶ç„™è¿›é•œåƒï¼Œä¾èµ–å·¥å…·åŒ…libguestfs-tools-c è¿™æ ·è™šæ‹ŸæœåŠ¡å™¨å¼€æœºåå°±å¯ä»¥ç›´æ¥åˆ†é…æŒ‡å®šçš„ip</code> </p><h3 id="æ“ä½œç›®æ ‡æœåŠ¡å™¨ï¼Œå°†å·²ç»åŒæ­¥xmlé…ç½®å®šä¹‰ä¸ºè™šæ‹Ÿæœºï¼Œæ‰©å±•ç›¸åº”ç£ç›˜ã€å¹¶å¼€å¯è™šæ‹ŸæœåŠ¡å™¨"><a href="#æ“ä½œç›®æ ‡æœåŠ¡å™¨ï¼Œå°†å·²ç»åŒæ­¥xmlé…ç½®å®šä¹‰ä¸ºè™šæ‹Ÿæœºï¼Œæ‰©å±•ç›¸åº”ç£ç›˜ã€å¹¶å¼€å¯è™šæ‹ŸæœåŠ¡å™¨" class="headerlink" title="æ“ä½œç›®æ ‡æœåŠ¡å™¨ï¼Œå°†å·²ç»åŒæ­¥xmlé…ç½®å®šä¹‰ä¸ºè™šæ‹Ÿæœºï¼Œæ‰©å±•ç›¸åº”ç£ç›˜ã€å¹¶å¼€å¯è™šæ‹ŸæœåŠ¡å™¨;"></a>æ“ä½œç›®æ ‡æœåŠ¡å™¨ï¼Œå°†å·²ç»åŒæ­¥xmlé…ç½®å®šä¹‰ä¸ºè™šæ‹Ÿæœºï¼Œæ‰©å±•ç›¸åº”ç£ç›˜ã€å¹¶å¼€å¯è™šæ‹ŸæœåŠ¡å™¨;</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_kvm</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">define_kvm</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'virsh define'</span> + <span class="string">' '</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">'.xml'</span>)</div><div class="line">        run(<span class="string">' [ -d'</span> + <span class="string">' '</span> + kvmtmpdir + <span class="string">' '</span> + <span class="string">']'</span> + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + kvmtmpdir)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_kvm</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'virsh start'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">extend_disk</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'qemu-img create -f qcow2'</span> + <span class="string">' '</span> + kvmdata + KVM_IP_HOSTNAME + <span class="string">'-data1.img'</span> + <span class="string">' '</span> + KVM_DISK)</div><div class="line">        run(<span class="string">'virsh attach-disk'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME + <span class="string">' '</span> + kvmdata + KVM_IP_HOSTNAME + <span class="string">'-data1.img'</span> + <span class="string">' '</span> + <span class="string">'vdc --subdriver=qcow2'</span>)</div><div class="line">        run(<span class="string">'virsh dumpxml'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME + <span class="string">' '</span> + <span class="string">'&gt;'</span> + <span class="string">' '</span> + kvmqemu + KVM_IP_HOSTNAME + <span class="string">'.xml'</span>)</div><div class="line">        run(<span class="string">'virsh destroy'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME )</div><div class="line">        run(<span class="string">'virsh define'</span> + <span class="string">' '</span> + kvmqemu  + KVM_IP_HOSTNAME + <span class="string">'.xml'</span>)</div><div class="line">        run(<span class="string">'virsh start'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME)</div></pre></td></tr></table></figure><h3 id="è™šæ‹ŸæœåŠ¡å™¨å¼€æœºåå®Œæˆç›¸åº”çš„è¡¥å……æ“ä½œ"><a href="#è™šæ‹ŸæœåŠ¡å™¨å¼€æœºåå®Œæˆç›¸åº”çš„è¡¥å……æ“ä½œ" class="headerlink" title="è™šæ‹ŸæœåŠ¡å™¨å¼€æœºåå®Œæˆç›¸åº”çš„è¡¥å……æ“ä½œ"></a>è™šæ‹ŸæœåŠ¡å™¨å¼€æœºåå®Œæˆç›¸åº”çš„è¡¥å……æ“ä½œ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> localsrc,kvmsrc,kvm_install_local</div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> LOGING_USER</div><div class="line"><span class="keyword">from</span> local.replacetemp <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> *</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">standard_kvm</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">site_kvm_hosts</span><span class="params">(self)</span>:</span></div><div class="line">        kvm_host_init  = replace_tmp_file()</div><div class="line">        kvm_host_init.kvm_hosts()</div><div class="line">        put(local_write_hosts,<span class="string">'/etc'</span>)</div><div class="line">        local(<span class="string">'rm -f'</span> + <span class="string">' '</span> + local_write_hosts)</div><div class="line">        run(<span class="string">'hostnamectl set-hostname'</span> + <span class="string">' '</span> + KVM_IP_HOSTNAME)</div><div class="line">        run(<span class="string">'mkfs.xfs /dev/vdb'</span>)</div><div class="line">        run(<span class="string">'ls -l /data &amp;&gt;/dev/null || mkdir /data'</span>)</div><div class="line">        fstab_shell_list = <span class="string">'''</span></div><div class="line"><span class="string">            cat /etc/fstab | grep data &gt; /dev/null || \\</span></div><div class="line"><span class="string">            for i in `ls -l  /dev/disk/by-uuid/  | grep vdb  | awk '&#123;print $9&#125;'` ; \\</span></div><div class="line"><span class="string">            do echo "UUID=$i  /data                   xfs     defaults        0 0" &gt;&gt; /etc/fstab; \\</span></div><div class="line"><span class="string">            done</span></div><div class="line"><span class="string">            </span></div><div class="line"><span class="string">            '''</span></div><div class="line">        run(fstab_shell_list)</div><div class="line">        run(<span class="string">'mount -a'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_kvm_adminsetd</span><span class="params">(self)</span>:</span></div><div class="line">        put(localsrc + <span class="string">'/'</span> + <span class="string">'adminset_agent.tar.gz'</span>,kvmsrc)</div><div class="line">        run(<span class="string">'yum clean all'</span>)</div><div class="line">        yum_clean_wait = command(<span class="number">25</span>)</div><div class="line">        yum_clean_wait.wait_sleep()</div><div class="line">        <span class="keyword">with</span> cd(kvmsrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">' '</span> + <span class="string">'adminset_agent.tar.gz'</span>)</div><div class="line">        <span class="keyword">with</span> cd(kvmsrc +<span class="string">'/'</span> + <span class="string">'adminset_agent'</span>):</div><div class="line">            run(<span class="string">'sh install.sh'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_node_exporter</span><span class="params">(self)</span>:</span></div><div class="line">        put(localsrc + <span class="string">'/'</span> + <span class="string">'node_exporter'</span>, kvm_install_local) </div><div class="line">        run(<span class="string">'chmod +x /usr/local/node_exporter/node_exporter'</span>)</div><div class="line">        run(<span class="string">'echo \" nohup /usr/local/node_exporter/node_exporter &amp;&gt; /dev/null &amp; \" &gt;&gt; /etc/rc.local'</span>)</div><div class="line">        run(<span class="string">'nohup /usr/local/node_exporter/node_exporter &amp;&gt; /dev/null &amp;'</span>)</div><div class="line">        run(<span class="string">'hwclock --systohc'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_kvm_passwd</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'echo'</span> + <span class="string">' '</span> + <span class="string">'\"'</span> + new_pass  + <span class="string">'\"'</span> + <span class="string">' '</span> + <span class="string">'| passwd --stdin'</span> + <span class="string">' '</span> + LOGING_USER)</div></pre></td></tr></table></figure><h3 id="mysqlxx-è¡¥å……æ¨¡å—-å®ç°åŠŸèƒ½ä¸ansible-playbook-roles-ç±»ä¼¼ï¼Œç°æ•´åˆåœ¨kvmè‡ªåŠ¨åŒ–ä¸­"><a href="#mysqlxx-è¡¥å……æ¨¡å—-å®ç°åŠŸèƒ½ä¸ansible-playbook-roles-ç±»ä¼¼ï¼Œç°æ•´åˆåœ¨kvmè‡ªåŠ¨åŒ–ä¸­" class="headerlink" title="mysqlxx è¡¥å……æ¨¡å—, å®ç°åŠŸèƒ½ä¸ansible-playbook roles ç±»ä¼¼ï¼Œç°æ•´åˆåœ¨kvmè‡ªåŠ¨åŒ–ä¸­"></a>mysqlxx è¡¥å……æ¨¡å—, å®ç°åŠŸèƒ½ä¸ansible-playbook roles ç±»ä¼¼ï¼Œç°æ•´åˆåœ¨kvmè‡ªåŠ¨åŒ–ä¸­</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> vars.mysqlxx <span class="keyword">import</span>  *</div><div class="line"><span class="keyword">from</span> local.mysqlxxreplace <span class="keyword">import</span> replace_mysqlxx_tmp</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span>  tmp_cache, systemd</div><div class="line">replace_mysqlxx = replace_mysqlxx_tmp()</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysqlxx_kvm</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'rm -f /etc/my.cnf'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'rm -rf /etc/my.cnf'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span><span class="params">(self)</span>:</span></div><div class="line">        put(mysqlfile + <span class="string">'mysql-'</span> + mysqlversion + <span class="string">'.tar.gz'</span>, datasrc)</div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">' '</span> <span class="string">'mysql-'</span> + mysqlversion + <span class="string">'.tar.gz'</span> + <span class="string">' '</span> + <span class="string">'-C /usr/local'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_mysql_conf</span><span class="params">(self)</span>:</span></div><div class="line">        put(mysqltemp + <span class="string">'my.cnf'</span>, <span class="string">'/etc/'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_install_sh</span><span class="params">(self)</span>:</span></div><div class="line">        replace_mysqlxx.mysql_install_sh()</div><div class="line">        put(tmp_cache + <span class="string">'mysql_install.sh'</span>, datasrc)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_user_and_group</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'id -g'</span> + <span class="string">' '</span> + mysqlgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'groupadd'</span> + <span class="string">' '</span> + mysqlgroup)</div><div class="line">        run(<span class="string">'id -u'</span> + <span class="string">' '</span> + mysqluser + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'useradd -r'</span> + <span class="string">' '</span> + mysqluser + <span class="string">' '</span> + <span class="string">'-g'</span> + <span class="string">' '</span> + mysqluser + <span class="string">' '</span> + <span class="string">'-s'</span> + <span class="string">' '</span> + <span class="string">'/sbin/nologin'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_related_directories</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqldatapath )</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqlbinlogpath)</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqlslowlogpath)</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqltmppath)</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqlerrlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqldatapath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqlbinlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqlslowlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqltmppath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqlerrlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqldatapath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlbinlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlslowlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqltmppath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlerrlogpath)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_slowlog_file</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'touch'</span> + <span class="string">' '</span> + mysqlslowlogpath + <span class="string">'slowquery.log'</span>)</div><div class="line">        run(<span class="string">'chmod 644'</span> + <span class="string">' '</span> + mysqlslowlogpath + <span class="string">'slowquery.log'</span>)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlslowlogpath + <span class="string">'slowquery.log'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_mysql</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'/bin/bash'</span> + <span class="string">' '</span> + <span class="string">'mysql_install.sh'</span> + <span class="string">' '</span> + <span class="string">'&amp;&amp; touch /tmp/mysql_installed'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_to_PATH</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'echo \'export PATH=$PATH:'</span> + mysqlinstallpath + <span class="string">'bin\' &gt;&gt; /etc/profile &amp;&amp; touch /tmp/mysql_addtopath'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_service_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_mysqlxx.mysql_service()</div><div class="line">        put(tmp_cache + <span class="string">'mysql.service'</span>, systemd)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_mysqlxx.clean_mysqlxx_tmp_cache()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_mysql_and_enable_it_onboot</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'systemctl daemon-reload'</span>)</div><div class="line">        run(<span class="string">'systemctl start mysql'</span>)</div><div class="line">        run(<span class="string">'systemctl enable mysql'</span>)</div><div class="line">        run(<span class="string">'pip install MySQL-python'</span>)</div><div class="line">        run(<span class="string">'ln -s /data/mysqltmp/mysql.sock /tmp/mysql.sock'</span>)</div><div class="line">        run(<span class="string">'ln -s /usr/local/mysql-x.x.xx-linux-glibcx.xx-x86_64/lib/libmysqlclient.so.20 /usr/lib64/libmysqlclient.so.20'</span>)</div><div class="line">        run(<span class="string">'ln -s /usr/local/mysql-x.x.xx-linux-glibcx.xx-x86_64/ /usr/local/mysql'</span>)</div><div class="line">        run(<span class="string">'[ -d /data/scripts/ ] || mkdir /data/scripts/'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'backup.sh'</span>, <span class="string">'/data/scripts'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'lepus_slowquery.sh'</span>, <span class="string">'/data/scripts'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'percona-toolkit_x.x.xx-x.tar.gz'</span>, <span class="string">'/data/scripts'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'init_backup.sh'</span>, <span class="string">'/data/scripts'</span>)</div></pre></td></tr></table></figure><h3 id="mysqlxxxx-åŒä¸Šï¼Œå®ç°å¤šç‰ˆæœ¬å¹¶å­˜"><a href="#mysqlxxxx-åŒä¸Šï¼Œå®ç°å¤šç‰ˆæœ¬å¹¶å­˜" class="headerlink" title="mysqlxxxx åŒä¸Šï¼Œå®ç°å¤šç‰ˆæœ¬å¹¶å­˜"></a>mysqlxxxx åŒä¸Šï¼Œå®ç°å¤šç‰ˆæœ¬å¹¶å­˜</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> vars.mysqlxxxx <span class="keyword">import</span>  *</div><div class="line"><span class="keyword">from</span> local.mysqlxxxxreplace <span class="keyword">import</span> replace_mysqlxx13_tmp</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span>  tmp_cache, systemd</div><div class="line">replace_mysqlxxxx = replace_mysqlxxxx_tmp()</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysqlxxxx_kvm</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'rm -f /etc/my.cnf'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_old_conf_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'rm -rf /etc/my.cnf'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span><span class="params">(self)</span>:</span></div><div class="line">        put(mysqlfile + <span class="string">'mysql-'</span> + mysqlversion + <span class="string">'.tar.gz'</span>, datasrc)</div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">' '</span> <span class="string">'mysql-'</span> + mysqlversion + <span class="string">'.tar.gz'</span> + <span class="string">' '</span> + <span class="string">'-C /usr/local'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_mysql_conf</span><span class="params">(self)</span>:</span></div><div class="line">        put(mysqltemp + <span class="string">'my.cnf'</span>, <span class="string">'/etc/'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_install_sh</span><span class="params">(self)</span>:</span></div><div class="line">        replace_mysqlxxxx.mysql_install_sh()</div><div class="line">        put(tmp_cache + <span class="string">'mysql_install.sh'</span>, datasrc)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_user_and_group</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'id -g'</span> + <span class="string">' '</span> + mysqlgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'groupadd'</span> + <span class="string">' '</span> + mysqlgroup)</div><div class="line">        run(<span class="string">'id -u'</span> + <span class="string">' '</span> + mysqluser + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'useradd -r'</span> + <span class="string">' '</span> + mysqluser + <span class="string">' '</span> + <span class="string">'-g'</span> + <span class="string">' '</span> + mysqluser + <span class="string">' '</span> + <span class="string">'-s'</span> + <span class="string">' '</span> + <span class="string">'/sbin/nologin'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_related_directories</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqldatapath )</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqlbinlogpath)</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqlslowlogpath)</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqltmppath)</div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + mysqlerrlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqldatapath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqlbinlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqlslowlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqltmppath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + mysqlerrlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqldatapath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlbinlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlslowlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqltmppath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlerrlogpath)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_slowlog_file</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'touch'</span> + <span class="string">' '</span> + mysqlslowlogpath + <span class="string">'slowquery.log'</span>)</div><div class="line">        run(<span class="string">'chmod 644'</span> + <span class="string">' '</span> + mysqlslowlogpath + <span class="string">'slowquery.log'</span>)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + mysqluser + <span class="string">':'</span> + mysqlgroup + <span class="string">' '</span> + mysqlslowlogpath + <span class="string">'slowquery.log'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_mysql</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'/bin/bash'</span> + <span class="string">' '</span> + <span class="string">'mysql_install.sh'</span> + <span class="string">' '</span> + <span class="string">'&amp;&amp; touch /tmp/mysql_installed'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_mysql_to_PATH</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'echo \'export PATH=$PATH:'</span> + mysqlinstallpath + <span class="string">'bin\' &gt;&gt; /etc/profile &amp;&amp; touch /tmp/mysql_addtopath'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_mysql_service_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_mysqlxxxx.mysql_service()</div><div class="line">        put(tmp_cache + <span class="string">'mysql.service'</span>, systemd)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_mysqlxxxx.clean_mysqlxxxx_tmp_cache()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_mysql_and_enable_it_onboot</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'systemctl daemon-reload'</span>)</div><div class="line">        run(<span class="string">'systemctl start mysql'</span>)</div><div class="line">        run(<span class="string">'systemctl enable mysql'</span>)</div><div class="line">        run(<span class="string">'pip install MySQL-python'</span>)</div><div class="line">        run(<span class="string">'ln -s /data/mysqltmp/mysql.sock /tmp/mysql.sock'</span>)</div><div class="line">        run(<span class="string">'ln -s /usr/local/mysql-x.x.xx-linux-glibc2.5-x86_64/lib/libmysqlclient.so.20 /usr/lib64/libmysqlclient.so.20'</span>)</div><div class="line">        run(<span class="string">'ln -s /usr/local/mysql-x.x.xx-linux-glibc2.5-x86_64/ /usr/local/mysql'</span>)</div><div class="line">        run(<span class="string">'[ -d /data/scripts/ ] || mkdir /data/scripts/'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'backup.sh'</span>, <span class="string">'/data/scripts'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'lepus_slowquery.sh'</span>, <span class="string">'/data/scripts'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'percona-toolkit_x.x.xx-1.tar.gz'</span>, <span class="string">'/data/scripts'</span>)</div><div class="line">        put(mysqlfile + <span class="string">'init_backup.sh'</span>, <span class="string">'/data/scripts'</span>)</div></pre></td></tr></table></figure><h3 id="kvm-æ•´åˆ-rediså®‰è£…è‡ªåŠ¨åŒ–"><a href="#kvm-æ•´åˆ-rediså®‰è£…è‡ªåŠ¨åŒ–" class="headerlink" title="kvm æ•´åˆ rediså®‰è£…è‡ªåŠ¨åŒ–"></a>kvm æ•´åˆ rediså®‰è£…è‡ªåŠ¨åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> local.redisreplace <span class="keyword">import</span>  replace_redis_tmp</div><div class="line"><span class="keyword">from</span> vars.redisvar <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> tmp_cache, systemd</div><div class="line">replace_redis = replace_redis_tmp()</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">redis_kvm</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span><span class="params">(self)</span>:</span></div><div class="line">        put(redisfile + <span class="string">'redis-'</span> + redisversion + <span class="string">'.tar.gz'</span>, datasrc)</div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">' '</span> + <span class="string">'redis-'</span> + redisversion + <span class="string">'.tar.gz'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_redis_install_shell</span><span class="params">(self)</span>:</span></div><div class="line">        replace_redis.redis_install_sh()</div><div class="line">        put(tmp_cache + <span class="string">'redis_install.sh'</span>, datasrc)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_redis_group_and_user</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'id -g'</span> + <span class="string">' '</span> + redisgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'groupadd'</span> + <span class="string">' '</span> + redisgroup)</div><div class="line">        run(<span class="string">'id -u'</span> + <span class="string">' '</span> + redisgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'useradd -r'</span> + <span class="string">' '</span> + redisuser + <span class="string">' '</span> + <span class="string">'-g'</span> + <span class="string">' '</span> + redisgroup + <span class="string">' '</span> + <span class="string">'-s'</span> + <span class="string">' '</span> + <span class="string">'/sbin/nologin'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_redis</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'/bin/bash'</span> + <span class="string">' '</span> + datasrc + <span class="string">'redis_install.sh'</span> + <span class="string">' '</span> + <span class="string">'&amp;&amp; touch /tmp/redis_installed'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_redis_log_file</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'touch'</span> + <span class="string">' '</span> + redislogpath)</div><div class="line">        run(<span class="string">'chmod 644'</span> + <span class="string">' '</span> + redislogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + redisuser + <span class="string">':'</span> + redisgroup + <span class="string">' '</span> + redislogpath)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crate_redis_data_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + redisdatapath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + redisdatapath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + redisuser + <span class="string">':'</span> + redisgroup + <span class="string">' '</span> + redisdatapath)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_redis_config</span><span class="params">(self)</span>:</span></div><div class="line">        replace_redis.redis_conf()</div><div class="line">        put(tmp_cache + <span class="string">'redis.conf'</span>, redisdatapath + <span class="string">'redis'</span> + redisport + <span class="string">'.conf'</span>)</div><div class="line">        run(<span class="string">'chmod 644'</span> + <span class="string">' '</span> + redisdatapath + <span class="string">'redis'</span> + redisport + <span class="string">'.conf'</span>)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + redisuser + <span class="string">':'</span> + redisgroup + <span class="string">' '</span> + redisdatapath + <span class="string">'redis'</span> + redisport + <span class="string">'.conf'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_redis_service_config</span><span class="params">(self)</span>:</span></div><div class="line">        replace_redis.redis_service()</div><div class="line">        put(tmp_cache + <span class="string">'redis.service'</span>, systemd + <span class="string">'redis'</span> + redisport + <span class="string">'.service'</span>)</div><div class="line">        run(<span class="string">'systemctl daemon-reload'</span>)</div><div class="line">        run(<span class="string">'systemctl start'</span> + <span class="string">' '</span> + <span class="string">'redis'</span> + redisport)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_redis.clean_redis_tmp_cache()</div><div class="line">        run(<span class="string">'echo \'export PATH=$PATH:/usr/local/src/redis-'</span> + redisversion + <span class="string">'/src/'</span> + <span class="string">'\' &gt;&gt; /etc/profile'</span>)</div></pre></td></tr></table></figure><h3 id="kvmæ•´åˆnginx-å®‰è£…è‡ªåŠ¨åŒ–"><a href="#kvmæ•´åˆnginx-å®‰è£…è‡ªåŠ¨åŒ–" class="headerlink" title="kvmæ•´åˆnginx å®‰è£…è‡ªåŠ¨åŒ–"></a>kvmæ•´åˆnginx å®‰è£…è‡ªåŠ¨åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> local.nginxreplace <span class="keyword">import</span> replace_nginx_tmp</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.nginxvar <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> kvmsrc,tmp_cache,systemd</div><div class="line">replace_nginx = replace_nginx_tmp()</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">nginx_kvm</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_source</span><span class="params">(self)</span>:</span></div><div class="line">        put(nginxfile + <span class="string">'nginx-'</span> + nginxversion + <span class="string">'.tar.gz'</span> , kvmsrc)</div><div class="line">        <span class="keyword">with</span> cd(kvmsrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">' '</span> + <span class="string">'nginx-'</span> + nginxversion + <span class="string">'.tar.gz'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_nginx_install_shell</span><span class="params">(self)</span>:</span></div><div class="line">        replace_nginx.nginx_install_sh()</div><div class="line">        put(tmp_cache + <span class="string">'nginx_install.sh'</span>, kvmsrc)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_nginx_log_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + nginxlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + nginxlogpath)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_nginx_group_and_user</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'id -g'</span> + <span class="string">' '</span> + nginxgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'groupadd'</span> + <span class="string">' '</span> + nginxgroup)</div><div class="line">        run(<span class="string">'id -u'</span> + <span class="string">' '</span> + nginxuser + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'useradd -r'</span> + <span class="string">' '</span> + nginxuser + <span class="string">' '</span> + <span class="string">'-g'</span> + <span class="string">' '</span> + nginxgroup + <span class="string">' '</span> + <span class="string">'-s'</span> + <span class="string">' '</span> + <span class="string">'/sbin/nologin'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_nginx</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(kvmsrc):</div><div class="line">            run(<span class="string">'/bin/bash'</span> + <span class="string">' '</span> + <span class="string">'nginx_install.sh'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_nginx_vhosts_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + nginxinstallpath + <span class="string">'conf/vhost'</span>)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + nginxinstallpath + <span class="string">'conf/vhost'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_main_template_config_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_nginx.nginx_conf()</div><div class="line">      <span class="comment">#  run('mv' + ' ' + nginxinstallpath + 'conf/nginx.conf&#123;,.bak&#125;')</span></div><div class="line">        put(tmp_cache + <span class="string">'nginx.conf'</span>, nginxinstallpath + <span class="string">'conf/nginx.conf'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_vhost_template_config_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_nginx.nginx_vhost()</div><div class="line">        put(tmp_cache + <span class="string">'vhost.conf'</span>, nginxinstallpath + <span class="string">'conf/vhost'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_nginx.clean_nginx_tmp_cache()</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_service_config_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_nginx.nginx_service()</div><div class="line">        put(tmp_cache + <span class="string">'nginx.service'</span>,systemd)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_nginx</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'systemctl daemon-reload'</span>)</div><div class="line">        run(<span class="string">'systemctl start nginx'</span>)</div></pre></td></tr></table></figure><h3 id="kvm-æ•´åˆphp-è‡ªåŠ¨åŒ–"><a href="#kvm-æ•´åˆphp-è‡ªåŠ¨åŒ–" class="headerlink" title="kvm æ•´åˆphp è‡ªåŠ¨åŒ–"></a>kvm æ•´åˆphp è‡ªåŠ¨åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">!/usr/bin/env python2</div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> local.phpreplace <span class="keyword">import</span> replace_php_tmp</div><div class="line"><span class="keyword">from</span> vars.phpvar <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> kvmsrc, tmp_cache, systemd</div><div class="line">replace_php = replace_php_tmp()</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">php_kvm</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span><span class="params">(self)</span>:</span></div><div class="line">        put(phpfile + <span class="string">'php-'</span> + phpversion + <span class="string">'.tar.gz'</span>, kvmsrc)</div><div class="line">        <span class="keyword">with</span> cd(kvmsrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">'php-'</span> + phpversion + <span class="string">'.tar.gz'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_install_shell</span><span class="params">(self)</span>:</span></div><div class="line">        replace_php.php_install_sh()</div><div class="line">        put(tmp_cache + <span class="string">'php_install.sh'</span>, kvmsrc)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_php_group_and_user</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'id -g'</span> + <span class="string">' '</span> + phpgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'groupadd'</span> + <span class="string">' '</span> + phpgroup)</div><div class="line">        run(<span class="string">'id -u'</span> + <span class="string">' '</span> + phpuser + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'useradd -r'</span> + <span class="string">' '</span> + phpuser + <span class="string">' '</span> + <span class="string">'-g'</span> + <span class="string">' '</span> + phpgroup + <span class="string">' '</span> + <span class="string">'-s'</span> + <span class="string">' '</span> + <span class="string">'/sbin/nologin'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_php_log_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + phplogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + phplogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + phpuser + <span class="string">':'</span> + phpgroup + <span class="string">' '</span> + phplogpath)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_php_error_log_file</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'touch'</span> + <span class="string">' '</span> + phplogpath + <span class="string">'php_errors.log'</span>)</div><div class="line">        run(<span class="string">'chmod 644'</span> + <span class="string">' '</span> + phplogpath + <span class="string">'php_errors.log'</span>)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + phpuser + <span class="string">':'</span> + phpgroup + <span class="string">' '</span> + phplogpath + <span class="string">'php_errors.log'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_php</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(kvmsrc):</div><div class="line">            run(<span class="string">'/bin/bash'</span> + <span class="string">' '</span> + <span class="string">'php_install.sh'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_main_phpini_config</span><span class="params">(self)</span>:</span></div><div class="line">        put(phpfile + <span class="string">'php.ini'</span>, phpinstallpath + <span class="string">'etc/'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_www_conf_config</span><span class="params">(self)</span>:</span></div><div class="line">        replace_php.php_www()</div><div class="line">        put(tmp_cache + <span class="string">'www.conf'</span>, phpinstallpath + <span class="string">'etc/php-fpm.d/'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_php_fpm_config</span><span class="params">(self)</span>:</span></div><div class="line">        replace_php.php_conf()</div><div class="line">        put(tmp_cache + <span class="string">'php-fpm.conf'</span>, phpinstallpath + <span class="string">'etc/'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_php_php_fpm_service</span><span class="params">(self)</span>:</span></div><div class="line">        replace_php.php_service()</div><div class="line">        put(tmp_cache + <span class="string">'php-fpm.service'</span>, systemd)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_php</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'systemctl daemon-reload'</span>)</div><div class="line">        run(<span class="string">'systemctl start php-fpm || ss -tnl | grep 9000'</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_files</span><span class="params">(self)</span>:</span></div><div class="line">        replace_php.clean_php_tmp_cache()</div></pre></td></tr></table></figure><h3 id="kvm-æ•´åˆzabbix-agentè‡ªåŠ¨åŒ–"><a href="#kvm-æ•´åˆzabbix-agentè‡ªåŠ¨åŒ–" class="headerlink" title="kvm æ•´åˆzabbix_agentè‡ªåŠ¨åŒ–"></a>kvm æ•´åˆzabbix_agentè‡ªåŠ¨åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> vars.zabbix_agentvar <span class="keyword">import</span>  *</div><div class="line"><span class="keyword">from</span> local.zabbixreplace <span class="keyword">import</span>  replace_zabbix_tmp</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> kvmsrc, tmp_cache, systemd</div><div class="line">replace_zabbix_agent = replace_zabbix_tmp()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">zabbix_agent_kvm</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_source</span><span class="params">(self)</span>:</span></div><div class="line">        put(zabbixfile + <span class="string">'zabbix-'</span> + zabbixagentversion + <span class="string">'.tar.gz'</span> , datasrc)</div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'tar -xvf'</span> + <span class="string">' '</span> + <span class="string">'zabbix-'</span> + zabbixagentversion + <span class="string">'.tar.gz'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cp_zabbix_agent_install_shell</span><span class="params">(self)</span>:</span></div><div class="line">        replace_zabbix_agent.zabbix_agent_install_sh()</div><div class="line">        put(tmp_cache + <span class="string">'zabbixagent_install.sh'</span>, datasrc)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_zabbix_group_and_user</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'id -g'</span> + <span class="string">' '</span> + zabbixagentgroup + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'groupadd'</span> + <span class="string">' '</span> + zabbixagentgroup)</div><div class="line">        run(<span class="string">'id -u'</span> + <span class="string">' '</span> + zabbixagentuser + <span class="string">' '</span> + <span class="string">'||'</span> + <span class="string">' '</span> + <span class="string">'useradd -r'</span> + <span class="string">' '</span> + zabbixagentuser + <span class="string">' '</span> + <span class="string">'-g'</span> + <span class="string">' '</span> + zabbixagentgroup + <span class="string">' '</span> + <span class="string">'-s'</span> + <span class="string">' '</span> + <span class="string">'/sbin/nologin'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_zabbix_agent_log_dir</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'mkdir -pv'</span> + <span class="string">' '</span> + zabbixagentlogpath)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + zabbixagentlogpath)</div><div class="line">        run(<span class="string">'chown'</span> + <span class="string">' '</span> + zabbixagentuser + <span class="string">':'</span> + zabbixagentgroup + <span class="string">' '</span> + zabbixagentlogpath)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_zabbix_agent</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">with</span> cd(datasrc):</div><div class="line">            run(<span class="string">'/bin/bash'</span> + <span class="string">' '</span> + <span class="string">'zabbixagent_install.sh'</span> + <span class="string">' '</span> + <span class="string">'touch /tmp/zabbixagent_installed'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_zabbix_agent_config_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_zabbix_agent.zabbix_agent_conf()</div><div class="line">        put(tmp_cache + <span class="string">'zabbix_agentd.conf'</span>, zabbixagentinstallpath + <span class="string">'/etc/'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_zabbix_agent_init_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_zabbix_agent.zabbix_agent_service()</div><div class="line">        put(tmp_cache + <span class="string">'zabbix_agentd'</span>, <span class="string">'/etc/init.d/'</span>)</div><div class="line">        run(<span class="string">'chmod 755'</span> + <span class="string">' '</span> + <span class="string">'/etc/init.d/zabbix_agentd'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_local_tmp_cache_file</span><span class="params">(self)</span>:</span></div><div class="line">        replace_zabbix_agent.clean_zabbix_tmp_cache()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_zabbix_agent_init</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'chkconfig --add zabbix_agentd'</span>)</div><div class="line">        run(<span class="string">'chkconfig zabbix_agentd on'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_zabbix_agentd</span><span class="params">(self)</span>:</span></div><div class="line">        run(<span class="string">'service zabbix_agentd start'</span>)</div></pre></td></tr></table></figure><h3 id="yum-å®‰è£…ç›¸å…³ä¾èµ–åŒ…"><a href="#yum-å®‰è£…ç›¸å…³ä¾èµ–åŒ…" class="headerlink" title="yum å®‰è£…ç›¸å…³ä¾èµ–åŒ…"></a>yum å®‰è£…ç›¸å…³ä¾èµ–åŒ…</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> yum_install_require_packages,yum_install_jdk_packages</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">yum_install_packages</span><span class="params">()</span>:</span></div><div class="line">    run(<span class="string">'yum -y install'</span> + <span class="string">'\\'</span> + yum_install_require_packages)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">yum_install_jdk</span><span class="params">()</span>:</span></div><div class="line">    run(<span class="string">'yum -y install'</span> + <span class="string">'\\'</span> + yum_install_jdk_packages)</div></pre></td></tr></table></figure><h3 id="è¾“å…¥è¾“å‡ºä¿¡æ¯æ‰“å°"><a href="#è¾“å…¥è¾“å‡ºä¿¡æ¯æ‰“å°" class="headerlink" title="è¾“å…¥è¾“å‡ºä¿¡æ¯æ‰“å°"></a>è¾“å…¥è¾“å‡ºä¿¡æ¯æ‰“å°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> red</div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> TARGETS_HOST, KVM_IP_HOSTNAME, KVM_IP_HOST, KVM_IP_GATEWAY, KVM_IP_NETMASK, ENV, APP, KVM_CPU, KVM_MEM ,KVM_DISK,KVM_IP_PASSWD</div><div class="line"><span class="keyword">from</span> config.messages <span class="keyword">import</span> MESSAGE_INFO</div><div class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> new_pass, common_first</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">last</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_start_kvm_message</span><span class="params">(self)</span>:</span></div><div class="line">        app_list = str(APP)</div><div class="line">        app_list = app_list.replace(<span class="string">"'"</span>,<span class="string">""</span>)</div><div class="line">        app_list = app_list.replace(<span class="string">"["</span>,<span class="string">""</span>)</div><div class="line">        app_list = app_list.replace(<span class="string">"]"</span>,<span class="string">""</span>)</div><div class="line">        app_list = app_list.replace(<span class="string">","</span>,<span class="string">""</span>)</div><div class="line">        first_print = common_first(MESSAGE_INFO[<span class="string">'env'</span>] + ENV, MESSAGE_INFO[<span class="string">'name'</span>] + KVM_IP_HOSTNAME,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'ip'</span>] + KVM_IP_HOST, MESSAGE_INFO[<span class="string">'target'</span>] +TARGETS_HOST,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'gateway'</span>] + KVM_IP_GATEWAY, MESSAGE_INFO[<span class="string">'netmask'</span>] + KVM_IP_NETMASK,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'app'</span>] + app_list, MESSAGE_INFO[<span class="string">'cpu'</span>] + KVM_CPU,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'memory'</span>] + KVM_MEM, MESSAGE_INFO[<span class="string">'disk'</span>] + KVM_DISK,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'passwd'</span>] + KVM_IP_PASSWD)</div><div class="line">        first_print.message_all()</div><div class="line">        user_choice = raw_input(red(<span class="string">'If the information is incorrect, please input no: '</span>))</div><div class="line">        <span class="keyword">if</span> user_choice == <span class="string">"N"</span> <span class="keyword">or</span> user_choice == <span class="string">"n"</span> <span class="keyword">or</span> user_choice == <span class="string">"no"</span> <span class="keyword">or</span> user_choice == <span class="string">"No"</span> <span class="keyword">or</span> user_choice == <span class="string">"NO"</span>:</div><div class="line">            <span class="keyword">print</span></div><div class="line">            print(red(<span class="string">'User check configuration is incorrect. Please rewrite configuration!'</span>))</div><div class="line">            <span class="keyword">print</span></div><div class="line">            exit(<span class="number">1000</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_kvm_message</span><span class="params">(self)</span>:</span></div><div class="line">        app_list = str(APP)</div><div class="line">        app_list = app_list.replace(<span class="string">"'"</span>,<span class="string">""</span>)</div><div class="line">        app_list = app_list.replace(<span class="string">"["</span>,<span class="string">""</span>)</div><div class="line">        app_list = app_list.replace(<span class="string">"]"</span>,<span class="string">""</span>)</div><div class="line">        app_list = app_list.replace(<span class="string">","</span>,<span class="string">""</span>)</div><div class="line">        last_print = common_first(MESSAGE_INFO[<span class="string">'env'</span>] + ENV, MESSAGE_INFO[<span class="string">'name'</span>] + KVM_IP_HOSTNAME,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'ip'</span>] + KVM_IP_HOST, MESSAGE_INFO[<span class="string">'target'</span>] + TARGETS_HOST,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'gateway'</span>] + KVM_IP_GATEWAY, MESSAGE_INFO[<span class="string">'netmask'</span>] + KVM_IP_NETMASK,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'app'</span>] + app_list, MESSAGE_INFO[<span class="string">'cpu'</span>] + KVM_CPU,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'memory'</span>] + KVM_MEM, MESSAGE_INFO[<span class="string">'disk'</span>] + KVM_DISK,</div><div class="line">                                   MESSAGE_INFO[<span class="string">'passwd'</span>] + new_pass)</div><div class="line">        last_print.last_message_all()</div></pre></td></tr></table></figure><h2 id="local-å®ç°é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸æ›¿æ¢"><a href="#local-å®ç°é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸æ›¿æ¢" class="headerlink" title="local å®ç°é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸æ›¿æ¢"></a>local å®ç°é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸æ›¿æ¢</h2><p>ä¾‹ifcfg-eth0</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> vars.kvmvar <span class="keyword">import</span> local_read_eth0,local_write_eth0,local_read_hosts,local_write_hosts,tmp_cache</div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> KVM_IP_HOST,KVM_IP_NETMASK,KVM_IP_GATEWAY,KVM_IP_STATUE,KVM_IP_HOSTNAME</div><div class="line"><span class="keyword">import</span> re</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">replace_tmp_file</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_eth0</span><span class="params">(self)</span>:</span></div><div class="line">        network_file_read = open(local_read_eth0,<span class="string">"r"</span>)</div><div class="line">        network_file_write = open(local_write_eth0,<span class="string">"w"</span>)</div><div class="line"></div><div class="line">        <span class="keyword">with</span> network_file_read <span class="keyword">as</span> f:</div><div class="line">            data = f.read()</div><div class="line">            data = data.replace(<span class="string">'$NETWORK_STATUS$'</span>,KVM_IP_STATUE)</div><div class="line">            data = data.replace(<span class="string">'$NETWORK_IPADDR$'</span>,KVM_IP_HOST)</div><div class="line">            data = data.replace(<span class="string">'$NETWORK_NETMASK$'</span>,KVM_IP_NETMASK)</div><div class="line">            data = data.replace(<span class="string">'$NETWORK_GATEWAY$'</span>,KVM_IP_GATEWAY)</div><div class="line">        <span class="keyword">with</span> network_file_write <span class="keyword">as</span> f:</div><div class="line">            f.write(data)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_eth0_local_remove</span><span class="params">(self)</span>:</span></div><div class="line">        local(<span class="string">'rm -f'</span> + <span class="string">' '</span> + local_write_eth0)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_hosts</span><span class="params">(self)</span>:</span></div><div class="line">        hosts_file_read = open(local_read_hosts,<span class="string">"r"</span>)</div><div class="line">        hosts_file_write = open(local_write_hosts,<span class="string">"w"</span>)</div><div class="line"></div><div class="line">        <span class="keyword">with</span> hosts_file_read <span class="keyword">as</span> f:</div><div class="line">            hosts = f.read()</div><div class="line">            hosts = hosts.replace(<span class="string">'$HOSTSIP$'</span>, KVM_IP_HOST)</div><div class="line">            hosts = hosts.replace(<span class="string">'$HOSTNAME$'</span>, KVM_IP_HOSTNAME)</div><div class="line">        <span class="keyword">with</span> hosts_file_write <span class="keyword">as</span> f:</div><div class="line">            f.write(hosts)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kvm_hosts_remove</span><span class="params">(self)</span>:</span></div><div class="line">        local(<span class="string">'rm -f'</span> + <span class="string">' '</span> + local_write_eth0)</div></pre></td></tr></table></figure><p>å…¶å®ƒåŠŸç›¸å…³è°ƒç”¨ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> string</div><div class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">command</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,info)</span>:</span></div><div class="line">        self.info = info</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_sleep</span><span class="params">(self)</span>:</span></div><div class="line">        sleep(self.info)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_pass</span><span class="params">(self,chars=string.ascii_uppercase+string.ascii_lowercase+string.digits)</span>:</span></div><div class="line"><span class="comment">#string.punctuation</span></div><div class="line">        <span class="keyword">return</span> <span class="string">''</span>.join([random.choice(chars) <span class="keyword">for</span> i <span class="keyword">in</span> range(self.info)])</div><div class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">common</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,info)</span>:</span></div><div class="line">        self.info = info</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> waits <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">2</span>):</div><div class="line">            sleep(waits)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_green</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> green(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span> green(<span class="string">'&#123;:&lt;10&#125;&#123;:^80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, self.info , <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> green(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_blue</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> blue(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span> blue(<span class="string">'&#123;:&lt;10&#125;&#123;:^80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, self.info , <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> blue(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_orange</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> yellow(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span> yellow(<span class="string">'&#123;:&lt;10&#125;&#123;:^80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, self.info , <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> yellow(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">common_first</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, env, name, ip, target, gateway, netmask, app, cpu, memory, disk ,passwd)</span>:</span></div><div class="line">        self.env = env</div><div class="line">        self.name = name</div><div class="line">        self.ip = ip</div><div class="line">        self.target = target</div><div class="line">        self.gateway = gateway</div><div class="line">        self.netmask = netmask</div><div class="line">        self.app = app</div><div class="line">        self.cpu = cpu</div><div class="line">        self.memory = memory</div><div class="line">        self.disk = disk</div><div class="line">        self.passwd = passwd</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">message_all</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.env, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.name, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.ip, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.target, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.gateway, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.netmask, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.app, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.cpu, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.memory, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.disk, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.passwd, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> magenta(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">last_message_all</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.env, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.name, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.ip, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.target, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.gateway, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.netmask, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.app, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.cpu, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.memory, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.disk, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'&#123;:&lt;10&#125;&#123;:&lt;80&#125;&#123;:&gt;10&#125;'</span>.format(<span class="string">'*'</span> * <span class="number">10</span>, <span class="string">'  '</span> + self.passwd, <span class="string">'*'</span> * <span class="number">10</span>))</div><div class="line">        <span class="keyword">print</span> cyan(<span class="string">'**'</span> * <span class="number">50</span>)</div><div class="line">        <span class="keyword">print</span></div><div class="line">newpasswd = command(<span class="number">12</span>)</div><div class="line">new_pass = newpasswd.create_pass()</div></pre></td></tr></table></figure><h3 id="config-ç›®å½•å­˜æ”¾é…ç½®ç›¸å…³çš„ä¿¡æ¯"><a href="#config-ç›®å½•å­˜æ”¾é…ç½®ç›¸å…³çš„ä¿¡æ¯" class="headerlink" title="config ç›®å½•å­˜æ”¾é…ç½®ç›¸å…³çš„ä¿¡æ¯"></a>config ç›®å½•å­˜æ”¾é…ç½®ç›¸å…³çš„ä¿¡æ¯</h3><p>message.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python2</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line">from config import ENV</div><div class="line">MESSAGE_INFO = &#123;</div><div class="line">    &apos;start_kvm_site&apos;: &apos;Now Start KVM Create&apos;,</div><div class="line">    &apos;app_clone&apos;: &apos;App Clone Genreate CentOS74&apos;,</div><div class="line">    &apos;site_image_ip&apos;: &apos;Source Hosts Site Image IP&apos;,</div><div class="line">    &apos;site_imgxml_cpu&apos;: &apos;Sources Hosts Site Image XML CPU&apos;,</div><div class="line">    &apos;site_imgxml_mem&apos;: &apos;Sources Hosts Site Image XML Memory&apos;,</div><div class="line">    &apos;scp_cloned_img&apos;: &apos;Sources Hosts Scp Cloned Image To Targets hosts&apos;,</div><div class="line">    &apos;scp_cloned_xml&apos;: &apos;Sources Hosts Scp Cloned XML To Targets hosts&apos;,</div><div class="line">    &apos;define_kvm&apos;: &apos;Targets Hosts Define Kvm Hosts&apos;,</div><div class="line">    &apos;start_kvm&apos;: &apos;Targets Hosts Start Kvm Hosts&apos;,</div><div class="line">    &apos;extend_disk&apos;: &apos;Targets Hosts Extend Kvm Disk&apos;,</div><div class="line">    &apos;wait_sleep&apos;: &apos;Sleep 60s For Wait Start Kvm Hosts&apos;,</div><div class="line">    &apos;site_kvm_hosts&apos;: &apos;KVM Site KVM Hosts&apos;,</div><div class="line">    &apos;install_kvm_adminsetd&apos;: &apos;KVM Install  Adminsetd And Node_exporter&apos;,</div><div class="line">    &apos;start_yum_tools_install&apos;: &apos;Now Start Yum Tools Install&apos;,</div><div class="line">    &apos;start_nginx_install&apos;: &apos;Now Start Nginx Install&apos;,</div><div class="line">    &apos;nginx_copy&apos;: &apos;Nginx Copy Source File&apos;,</div><div class="line">    &apos;copy_nginx_install_shell&apos;: &apos;Nginx Copy Install Shell&apos;,</div><div class="line">    &apos;create_nginx_log_dir&apos;: &apos;Nginx Create Log Dir&apos;,</div><div class="line">    &apos;create_nginx_group_and_user&apos;: &apos;Nginx Create Group And User&apos;,</div><div class="line">    &apos;install_nginx&apos;: &apos;Nginx Install&apos;,</div><div class="line">    &apos;create_nginx_vhosts_dir&apos;: &apos;Nginx Create Vhosts Dir&apos;,</div><div class="line">    &apos;copy_main_template_config_file&apos;: &apos;Nginx Main Template Config File&apos;,</div><div class="line">    &apos;copy_vhost_template_config_file&apos;: &apos;Nginx Copy Vhost Template Config File&apos;,</div><div class="line">    &apos;copy_service_config_file&apos;: &apos;Nginx Copy Service Config File&apos;,</div><div class="line">    &apos;start_nginx&apos;: &apos;Nginx Start&apos;,</div><div class="line">    &apos;nginx_clean_local_tmp_cache_file&apos;: &apos;Nginx Clean local Tmp Cache File&apos;,</div><div class="line">    &apos;start_php_install&apos;: &apos;Now Start PHP Install&apos;,</div><div class="line">    &apos;php_copy&apos;: &apos;PHP Copy Source File&apos;,</div><div class="line">    &apos;cp_php_install_shell&apos;: &apos;PHP Copy Install Shell&apos;,</div><div class="line">    &apos;create_php_group_and_user&apos;: &apos;PHP Create Group And User&apos;,</div><div class="line">    &apos;create_php_log_dir&apos;: &apos;PHP Create Log Dir&apos;,</div><div class="line">    &apos;create_php_error_log_file&apos;: &apos;PHP Create Error Log File&apos;,</div><div class="line">    &apos;install_php&apos;: &apos;PHP Install&apos;,</div><div class="line">    &apos;cp_main_phpini_config&apos;: &apos;PHP Copy Phpini Config&apos;,</div><div class="line">    &apos;cp_php_www_conf_config&apos;: &apos;PHP Copy PHP WWW Config&apos;,</div><div class="line">    &apos;cp_php_php_fpm_config&apos;: &apos;PHP Copy php-fpm Config&apos;,</div><div class="line">    &apos;cp_php_php_fpm_service&apos;: &apos;PHP Copy php-fpm Service&apos;,</div><div class="line">    &apos;start_php&apos;: &apos;PHP Start&apos;,</div><div class="line">    &apos;php_clean_local_tmp_cache_files&apos;: &apos;PHP Clean local Tmp Cache File&apos;,</div><div class="line">    &apos;start_redis_install&apos;: &apos;Now Start Reids Install&apos;,</div><div class="line">    &apos;redis_copy&apos;: &apos;Redis Copy Source File&apos;,</div><div class="line">    &apos;cp_redis_install_shell&apos;: &apos;Redis Copy Install Shell&apos;,</div><div class="line">    &apos;create_redis_group_and_user&apos;: &apos;Redis Create Grup And User&apos;,</div><div class="line">    &apos;install_redis&apos;: &apos;Redis Install&apos;,</div><div class="line">    &apos;create_redis_log_file&apos;: &apos;Redis Create Redis Log File&apos;,</div><div class="line">    &apos;crate_redis_data_dir&apos;: &apos;Redis Create Data Dir&apos;,</div><div class="line">    &apos;copy_redis_config&apos;: &apos;Redis Copy Config&apos;,</div><div class="line">    &apos;copy_redis_service_config&apos;: &apos;Redis Copy Service Config&apos;,</div><div class="line">    &apos;redis_clean_local_tmp_cache_file&apos;: &apos;Redis Clean Local Tmp Cache File&apos;,</div><div class="line">    &apos;start_jdk_install&apos;: &apos;Now Start Install JDK&apos;,</div><div class="line">    &apos;yum_install_jdk&apos;: &apos;JDK Yum Install&apos;,</div><div class="line">    &apos;start_zabbix_agentd_install&apos;: &apos;Now Start Zabbix Agent Install&apos;,</div><div class="line">    &apos;zabbix_copy&apos;: &apos;Zabbix Copy Source File&apos;,</div><div class="line">    &apos;cp_zabbix_agent_install_shell&apos;: &apos;Zabbix Copy Agent Install Shell&apos;,</div><div class="line">    &apos;create_zabbix_group_and_user&apos;: &apos;Zabbix Create Zabbix Group And User&apos;,</div><div class="line">    &apos;create_zabbix_agent_log_dir&apos;: &apos;Zabbix Create Agent Log Dir&apos;,</div><div class="line">    &apos;install_zabbix_agent&apos;: &apos;Zabbix Install Agent&apos;,</div><div class="line">    &apos;copy_zabbix_agent_config_file&apos;: &apos;Zabbix Copy Zabbix Agent Config&apos;,</div><div class="line">    &apos;copy_zabbix_agent_init_file&apos;: &apos;Zabbix Copy Zabbix Agent init&apos;,</div><div class="line">    &apos;add_zabbix_agent_init&apos;: &apos;Zabbix Agent init&apos;,</div><div class="line">    &apos;start_zabbix_agentd&apos;: &apos;Zabbix Agent start&apos;,</div><div class="line">    &apos;zabbix_clean_local_tmp_cache_file&apos;: &apos;Zabbix Clean Local Tmp Cache File&apos;,</div><div class="line">    &apos;start_mysqlxx_install&apos;: &apos;Now Start Mysqlxx Install&apos;,</div><div class="line">    &apos;deletexx_old_conf&apos;: &apos;MySQLxx Delete Old Conf&apos;,</div><div class="line">    &apos;deletexx_old_conf_dir&apos;: &apos;MySQLxx Delete Old Conf Dir&apos;,</div><div class="line">    &apos;mysqlxx_source&apos;: &apos;MySQLxx Copy Source File&apos;,</div><div class="line">    &apos;cp_mysqlxx_conf&apos;: &apos;MySQLxx Copy Conf&apos;,</div><div class="line">    &apos;copy_mysqlxx_install_sh&apos;: &apos;MySQLxx Copy Install Shell&apos;,</div><div class="line">    &apos;add_mysqlxx_user_and_group&apos;: &apos;MySQLxx Add User And Group&apos;,</div><div class="line">    &apos;createxx_related_directories&apos;: &apos;MySQlxx Create Related Directories&apos;,</div><div class="line">    &apos;createxx_slowlog_file&apos;: &apos;MySQLxx Create Slowlog File&apos;,</div><div class="line">    &apos;install_mysqlxx&apos;: &apos;MySQLxx Install&apos;,</div><div class="line">    &apos;add_mysqlxx_to_PATH&apos;: &apos;MySQLxx Add To PATH&apos;,</div><div class="line">    &apos;cleanxx_local_tmp_cache_file&apos;: &quot;MySQLxx Clean Local Tmp Cache File&quot;,</div><div class="line">    &apos;copy_mysqlxx_service_file&apos;: &quot;MySQLxx Copy Service File&quot;,</div><div class="line">    &apos;start_mysqlxx_and_enable_it_onboot&apos;: &apos;MySQLxx start And Enable Onboot&apos;,</div><div class="line">    &apos;start_mysqlxx13_install&apos;: &apos;Now Start Mysqlxx13 Install&apos;,</div><div class="line">    &apos;deletexx13_old_conf&apos;: &apos;MySQLxx13 Delete Old Conf&apos;,</div><div class="line">    &apos;deletexx13_old_conf_dir&apos;: &apos;MySQLxx13 Delete Old Conf Dir&apos;,</div><div class="line">    &apos;mysqlxx13_source&apos;: &apos;MySQLxx13 Copy Source File&apos;,</div><div class="line">    &apos;cp_mysqlxx13_conf&apos;: &apos;MySQLxx13 Copy Conf&apos;,</div><div class="line">    &apos;copy_mysqlxx13_install_sh&apos;: &apos;MySQLxx13 Copy Install Shell&apos;,</div><div class="line">    &apos;add_mysqlxx13_user_and_group&apos;: &apos;MySQLxx13 Add User And Group&apos;,</div><div class="line">    &apos;createxx13_related_directories&apos;: &apos;MySQlxx13 Create Related Directories&apos;,</div><div class="line">    &apos;createxx13_slowlog_file&apos;: &apos;MySQLxx13 Create Slowlog File&apos;,</div><div class="line">    &apos;install_mysqlxx13&apos;: &apos;MySQLxx13 Install&apos;,</div><div class="line">    &apos;add_mysqlxx13_to_PATH&apos;: &apos;MySQLxx13 Add To PATH&apos;,</div><div class="line">    &apos;cleanxx13_local_tmp_cache_file&apos;: &quot;MySQLxx13 Clean Local Tmp Cache File&quot;,</div><div class="line">    &apos;copy_mysqlxx13_service_file&apos;: &quot;MySQLxx13 Copy Service File&quot;,</div><div class="line">    &apos;start_mysqlxx13_and_enable_it_onboot&apos;: &apos;MySQLxx13 Start And Enable Onboot&apos;,</div><div class="line">    &apos;set_kvm_passwd&apos;: &apos;KVM Set root passwd&apos;,</div><div class="line">    &apos;env&apos;: &apos;KVM ENV Is: &apos;,</div><div class="line">    &apos;name&apos;: &apos;KVM Host Name Is: &apos;,</div><div class="line">    &apos;ip&apos;: &apos;KVM IP Is: &apos;,</div><div class="line">    &apos;target&apos;: &apos;TARGET IP Is: &apos;,</div><div class="line">    &apos;gateway&apos;: &apos;KVM Gateway Is: &apos;,</div><div class="line">    &apos;netmask&apos;: &apos;KVM Netmask Is: &apos;,</div><div class="line">    &apos;app&apos;: &apos;KVM APP Is: &apos;,</div><div class="line">    &apos;cpu&apos;: &apos;KVM CPU Is: &apos;,</div><div class="line">    &apos;memory&apos;: &apos;KVM Memory Is: &apos;,</div><div class="line">    &apos;disk&apos;: &apos;KVM Disk Is: &apos;,</div><div class="line">    &apos;passwd&apos;: &apos;KVM Passwd IS: &apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>host.py å¼€é€šæœåŠ¡å™¨æ‰€è¦æ“æ§çš„ä¸‰å°æœåŠ¡å™¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</div><div class="line">SOURCES_HOSTS = [</div><div class="line">    LOGING_USER + <span class="string">'@'</span> + SOURCES_HOST</div><div class="line">]</div><div class="line"></div><div class="line">TARGETS_HOSTS = [</div><div class="line">    LOGING_USER + <span class="string">'@'</span> + TARGETS_HOST</div><div class="line">]</div><div class="line"></div><div class="line">KVM_HOSTS = [</div><div class="line">    LOGING_USER + <span class="string">'@'</span> + KVM_IP_HOST</div><div class="line">]</div></pre></td></tr></table></figure><p><strong>init</strong>.py ç”Ÿäº§ä¸ç”Ÿäº§ç¯å¢ƒé…ç½®çš„å¼€å…³</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#from config.prod.kvm_config import *</span></div><div class="line"><span class="keyword">from</span> config.test.kvm_config <span class="keyword">import</span> *</div></pre></td></tr></table></figure><p>kvm_create.py æ¯æ¬¡å¼€é€šæœåŠ¡å™¨æ‰€éœ€è¦çš„é…ç½®ä¿¡æ¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> env</div><div class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> newpasswd</div><div class="line"></div><div class="line"><span class="comment">########################################### ä»¥ä¸‹ä¸ºé€šå¸¸ä¸å˜çš„ä¿¡æ¯ ########################################</span></div><div class="line"></div><div class="line"><span class="comment">## ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºroot</span></div><div class="line">ENV = <span class="string">'prod'</span></div><div class="line">LOGING_USER = <span class="string">'root'</span></div><div class="line"><span class="comment">## ç”Ÿäº§ç¯å¢ƒç½‘å…³ä¿¡æ¯,ç”Ÿäº§ç½‘å…³é»˜è®¤ä¸å˜</span></div><div class="line">KVM_IP_GATEWAY = <span class="string">'xxx.xx.xx.xx'</span></div><div class="line"><span class="comment">## kvmæœåŠ¡å™¨å¯†ç ä¿¡æ¯kvmæœåŠ¡å™¨ä¸­çš„æ¨¡æ¿ï¼Œä¸€èˆ¬ä¸å˜</span></div><div class="line">KVM_IP_PASSWD = <span class="string">'xxxxxxxxXXXX'</span></div><div class="line"><span class="comment">## æºæœåŠ¡å™¨ä¿¡æ¯ï¼Œä¸€èˆ¬ä»ç‰©ç†æœåŠ¡å™¨(xxx.xx.xx.xx)è¿›è¡Œå…‹éš†</span></div><div class="line">SOURCES_HOST = <span class="string">'xxx.xx.xx.xx'</span></div><div class="line">SOURCES_PASS = <span class="string">'xxxxxxxxxxxxxxxxxxxxxxx'</span></div><div class="line"></div><div class="line"><span class="comment">## kvmè™šæ‹Ÿæœºå¯åŠ¨åç½‘å¡çš„å¼€å¯çŠ¶æ€ï¼Œä¸€èˆ¬ä¸å˜</span></div><div class="line">KVM_IP_STATUE = <span class="string">'yes'</span></div><div class="line"></div><div class="line"><span class="comment">########################################## ä»¥ä¸‹ä¸ºé€šå¸¸æ”¹å˜çš„ä¿¡æ¯ #########################################</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">### ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯(åˆ‡è®°æ”¹å˜é…ç½®ä¿¡æ¯)</span></div><div class="line"><span class="comment">#TARGETS_HOST = 'xxx.xx.xxx.xx'</span></div><div class="line"><span class="comment">#TARGETS_PASS = 'xxxxxxxxxxxxxxxxxxxxxxxx'</span></div><div class="line"><span class="comment">### kvmæœåŠ¡å™¨ä¿¡æ¯(åˆ‡è®°æ”¹å˜é…ç½®ä¿¡æ¯)</span></div><div class="line"><span class="comment">#KVM_IP_HOSTNAME = 'xx-xxxx-xx-xxx-xxxx-xxxx'</span></div><div class="line"><span class="comment">#KVM_IP_HOST = '172.30.70.'</span></div><div class="line"><span class="comment">#KVM_IP_NETMASK = '255.255.192.0'</span></div><div class="line"><span class="comment">#KVM_CPU = '2'</span></div><div class="line"><span class="comment">#KVM_DISK = '100G'</span></div><div class="line"><span class="comment">##KVM_MEM = '10xx144'</span></div><div class="line"><span class="comment">##KVM_MEM = '2114288'</span></div><div class="line"><span class="comment">##KVM_MEM = '2097152'</span></div><div class="line"><span class="comment">##KVM_MEM = '4194304'</span></div><div class="line"><span class="comment">##KVM_MEM = '6291456'</span></div><div class="line"><span class="comment">#KVM_MEM = '8388608'</span></div><div class="line"><span class="comment">##KVM_MEM = '1048xx60'</span></div><div class="line"><span class="comment">##KVM_MEM = '12582912'</span></div><div class="line"><span class="comment">##KVM_MEM = '14680064'</span></div><div class="line"><span class="comment">##KVM_MEM = '16777216'</span></div><div class="line"><span class="comment">##KVM_MEM = '20971520'</span></div><div class="line"><span class="comment">##KVM_MEM = '25165824'</span></div><div class="line"><span class="comment">#APP = ['zabbix_agent', 'jdk']</span></div><div class="line"><span class="comment">##APP = ['zabbix_agent', 'nginx', 'php', 'redis', 'jdk', 'mysql_xx', 'mysql_xx13']</span></div><div class="line"><span class="comment">############################################# ä»¥ä¸‹ä¸ºä»£æ›¿çš„æ‰§è¡Œç™»å½•ä¿¡æ¯ ####################################</span></div><div class="line">env.passwords[LOGING_USER + <span class="string">'@'</span> + SOURCES_HOST + <span class="string">':22'</span>] = SOURCES_PASS</div><div class="line">env.passwords[LOGING_USER + <span class="string">'@'</span> + TARGETS_HOST + <span class="string">':22'</span>] = TARGETS_PASS</div><div class="line">env.passwords[LOGING_USER + <span class="string">'@'</span> + KVM_IP_HOST + <span class="string">':22'</span>] = KVM_IP_PASSWD</div></pre></td></tr></table></figure><h2 id="application-å®šä¹‰è‡ªåŠ¨åŒ–æ‰§è¡Œæµç¨‹"><a href="#application-å®šä¹‰è‡ªåŠ¨åŒ–æ‰§è¡Œæµç¨‹" class="headerlink" title="application å®šä¹‰è‡ªåŠ¨åŒ–æ‰§è¡Œæµç¨‹"></a>application å®šä¹‰è‡ªåŠ¨åŒ–æ‰§è¡Œæµç¨‹</h2><p> kvmcreate.py å®šä¹‰kvm è‡ªåŠ¨éƒ¨ç½²æµç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> KVM_CPU,KVM_MEM,KVM_DISK</div><div class="line"><span class="keyword">from</span> config.messages <span class="keyword">import</span> MESSAGE_INFO</div><div class="line"><span class="keyword">from</span> kernel.clone <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> kernel.start <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> kernel.standard <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> kernel.last <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> common</div><div class="line">app_clone_generate = generate_kvmimg()</div><div class="line">app_targets_hosts_start = start_kvm()</div><div class="line">app_kvm_hosts_start_site = standard_kvm()</div><div class="line">app_kvm_hosts_start_print = last()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_create</span><span class="params">()</span>:</span></div><div class="line">    print_first_message = last()</div><div class="line">    print_first_message.print_start_kvm_message()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'start_kvm_site'</span>])</div><div class="line">    print_kvm_message.message_blue()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'app_clone'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_clone_generate.clone_cevs74()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'site_image_ip'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_clone_generate.site_imgip()</div><div class="line">    <span class="keyword">if</span> KVM_CPU != <span class="string">'2'</span> <span class="keyword">and</span> KVM_MEM != <span class="string">'4194304'</span>:</div><div class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">'site_imgxml_cpu'</span>])</div><div class="line">        print_kvm_message.message_green()</div><div class="line">        app_clone_generate.site_imgxml_cpu()</div><div class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">'site_imgxml_mem'</span>])</div><div class="line">        print_kvm_message.message_green()</div><div class="line">        app_clone_generate.site_imgxml_mem()</div><div class="line">    <span class="keyword">if</span> KVM_CPU != <span class="string">'2'</span> <span class="keyword">and</span> KVM_MEM == <span class="string">'4194304'</span>:</div><div class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">'site_imgxml_cpu'</span>])</div><div class="line">        print_kvm_message.message_green()</div><div class="line">        app_clone_generate.site_imgxml_cpu()</div><div class="line">    <span class="keyword">if</span> KVM_MEM != <span class="string">'4194304'</span> <span class="keyword">and</span> KVM_CPU == <span class="string">'2'</span>:</div><div class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">'site_imgxml_mem'</span>])</div><div class="line">        print_kvm_message.message_green()</div><div class="line">        app_clone_generate.site_imgxml_mem()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'scp_cloned_img'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_clone_generate.scp_cloned_img()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'scp_cloned_xml'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_clone_generate.scp_cloned_xml()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">targets_hosts_start_kvm</span><span class="params">()</span>:</span></div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'define_kvm'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_targets_hosts_start.define_kvm()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'start_kvm'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_targets_hosts_start.start_kvm()</div><div class="line">    <span class="keyword">if</span> KVM_DISK <span class="keyword">is</span> <span class="keyword">not</span> <span class="string">''</span>:</div><div class="line">        print_kvm_message = common(MESSAGE_INFO[<span class="string">'extend_disk'</span>])</div><div class="line">        print_kvm_message.message_green()</div><div class="line">        app_targets_hosts_start.extend_disk()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'wait_sleep'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    time_sleep_wait_start = command(<span class="number">60</span>)</div><div class="line">    time_sleep_wait_start.wait_sleep()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_virture_hosts_site</span><span class="params">()</span>:</span></div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'site_kvm_hosts'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_kvm_hosts_start_site.site_kvm_hosts()</div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'install_kvm_adminsetd'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_kvm_hosts_start_site.install_kvm_adminsetd()</div><div class="line">    app_kvm_hosts_start_site.install_node_exporter()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_tirture_hosts_site_passwd</span><span class="params">()</span>:</span></div><div class="line">    print_kvm_message = common(MESSAGE_INFO[<span class="string">'set_kvm_passwd'</span>])</div><div class="line">    print_kvm_message.message_green()</div><div class="line">    app_kvm_hosts_start_site.set_kvm_passwd()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_virture_hosts_print</span><span class="params">()</span>:</span></div><div class="line">    app_kvm_hosts_start_print.print_kvm_message()</div></pre></td></tr></table></figure><p>appcreate.py ç”¨äºå®šä¹‰åº”ç”¨ç¨‹åºçš„éƒ¨ç½²æµç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> config.messages <span class="keyword">import</span> MESSAGE_INFO</div><div class="line"><span class="keyword">from</span> local.localall <span class="keyword">import</span> common</div><div class="line"><span class="keyword">from</span> kernel.yum <span class="keyword">import</span> yum_install_packages, yum_install_jdk</div><div class="line"><span class="keyword">from</span> kernel.nginx <span class="keyword">import</span> nginx_kvm</div><div class="line"><span class="keyword">from</span> kernel.php <span class="keyword">import</span> php_kvm</div><div class="line"><span class="keyword">from</span> kernel.redis <span class="keyword">import</span> redis_kvm</div><div class="line"><span class="keyword">from</span> kernel.zabbix_agent <span class="keyword">import</span> zabbix_agent_kvm</div><div class="line"><span class="keyword">from</span> kernel.mysqlxx <span class="keyword">import</span>  mysqlxx_kvm</div><div class="line"><span class="keyword">from</span> kernel.mysqlxxxx <span class="keyword">import</span> mysqlxxxx_kvm</div><div class="line"><span class="keyword">from</span> config <span class="keyword">import</span> APP</div><div class="line"></div><div class="line">nginx_install = nginx_kvm()</div><div class="line">php_install = php_kvm()</div><div class="line">redis_install = redis_kvm()</div><div class="line">zabbix_agent_install = zabbix_agent_kvm()</div><div class="line">mysqlxx_install = mysqlxx_kvm()</div><div class="line">mysqlxxxx_install = mysqlxxxx_kvm()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_yum_install</span><span class="params">()</span>:</span></div><div class="line">    yum_install_packages()</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_nginx</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'nginx_copy'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.copy_source()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_nginx_install_shell'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.copy_nginx_install_shell()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_nginx_log_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.create_nginx_log_dir()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_nginx_group_and_user'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.create_nginx_group_and_user()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'install_nginx'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.install_nginx()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_nginx_vhosts_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.create_nginx_vhosts_dir()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_main_template_config_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.copy_main_template_config_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_vhost_template_config_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.copy_vhost_template_config_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_service_config_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.copy_service_config_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'start_nginx'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.start_nginx()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'nginx_clean_local_tmp_cache_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    nginx_install.clean_local_tmp_cache_file()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_php</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'php_copy'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.cp_source()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_php_install_shell'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.cp_php_install_shell()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_php_group_and_user'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.create_php_group_and_user()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_php_log_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.create_php_log_dir()</div><div class="line"></div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_php_error_log_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.create_php_error_log_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'install_php'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.install_php()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_main_phpini_config'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.cp_main_phpini_config()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_php_www_conf_config'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.cp_php_www_conf_config()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_php_php_fpm_config'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.cp_php_php_fpm_config()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_php_php_fpm_service'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.cp_php_php_fpm_service()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'start_php'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.start_php()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'php_clean_local_tmp_cache_files'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    php_install.clean_local_tmp_cache_files()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_redis</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'redis_copy'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.cp_source()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_redis_install_shell'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.cp_redis_install_shell()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_redis_group_and_user'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.create_redis_group_and_user()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'install_redis'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.install_redis()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_redis_log_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.create_redis_log_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'crate_redis_data_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.crate_redis_data_dir()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_redis_config'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.copy_redis_config()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_redis_service_config'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.copy_redis_service_config()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'redis_clean_local_tmp_cache_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    redis_install.clean_local_tmp_cache_file()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_jdk</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'yum_install_jdk'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    yum_install_jdk()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_zabbix_agent</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'zabbix_copy'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.cp_source()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_zabbix_agent_install_shell'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.cp_zabbix_agent_install_shell()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_zabbix_group_and_user'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.create_zabbix_group_and_user()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'create_zabbix_agent_log_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.create_zabbix_agent_log_dir()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'install_zabbix_agent'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.install_zabbix_agent()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_zabbix_agent_config_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.copy_zabbix_agent_config_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_zabbix_agent_init_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.copy_zabbix_agent_init_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'zabbix_clean_local_tmp_cache_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.clean_local_tmp_cache_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'add_zabbix_agent_init'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.add_zabbix_agent_init()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'start_zabbix_agentd'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    zabbix_agent_install.start_zabbix_agentd()</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_mysqlxx</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'deletexx_old_conf'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.delete_old_conf()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'deletexx_old_conf_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.delete_old_conf_dir()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'mysqlxx_source'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.cp_source()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_mysqlxx_conf'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.cp_mysql_conf()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_mysqlxx_install_sh'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.copy_mysql_install_sh()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'add_mysqlxx_user_and_group'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.add_mysql_user_and_group()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'createxx_related_directories'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.create_related_directories()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'createxx_slowlog_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.create_slowlog_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'install_mysqlxx'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.install_mysql()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'add_mysqlxx_to_PATH'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.add_mysql_to_PATH()</div><div class="line"></div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_mysqlxx_service_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.copy_mysql_service_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cleanxx_local_tmp_cache_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.clean_local_tmp_cache_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'start_mysqlxx_and_enable_it_onboot'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx_install.start_mysql_and_enable_it_onboot()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_mysqlxx13</span><span class="params">()</span>:</span></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'deletexx13_old_conf'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.delete_old_conf()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'deletexx13_old_conf_dir'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.delete_old_conf_dir()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'mysqlxx13_source'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.cp_source()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cp_mysqlxx13_conf'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.cp_mysql_conf()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_mysqlxx13_install_sh'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.copy_mysql_install_sh()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'add_mysqlxx13_user_and_group'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.add_mysql_user_and_group()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'createxx13_related_directories'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.create_related_directories()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'createxx13_slowlog_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.create_slowlog_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'install_mysqlxx13'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.install_mysql()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'add_mysqlxx13_to_PATH'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.add_mysql_to_PATH()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'copy_mysqlxx13_service_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.copy_mysql_service_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'cleanxx13_local_tmp_cache_file'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.clean_local_tmp_cache_file()</div><div class="line"></div><div class="line">    print_application_message = common(MESSAGE_INFO[<span class="string">'start_mysqlxx13_and_enable_it_onboot'</span>])</div><div class="line">    print_application_message.message_green()</div><div class="line">    mysqlxx13_install.start_mysql_and_enable_it_onboot()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_all_application_package</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> len(APP) != (<span class="number">0</span>):</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_yum_tools_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_yum_install()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'nginx'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_nginx_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_nginx()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'php'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_php_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_php()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'redis'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_redis_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_redis()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'jdk'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_jdk_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_jdk()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'zabbix_agent'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_zabbix_agentd_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_zabbix_agent()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'mysql_xx'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_mysqlxx_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_mysqlxx()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'mysql_xx13'</span> <span class="keyword">in</span> APP:</div><div class="line">        print_application_message = common(MESSAGE_INFO[<span class="string">'start_mysqlxx13_install'</span>])</div><div class="line">        print_application_message.message_blue()</div><div class="line">        run_install_mysqlxx13()</div></pre></td></tr></table></figure><h2 id="å®šä¹‰å…¥å£æ–‡ä»¶"><a href="#å®šä¹‰å…¥å£æ–‡ä»¶" class="headerlink" title="å®šä¹‰å…¥å£æ–‡ä»¶"></a>å®šä¹‰å…¥å£æ–‡ä»¶</h2><p>kvm.py æ˜¯æ‰€æœ‰ç¨‹åºæ‰§è¡Œçš„å…¥å£æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> PrettyTable</div><div class="line"><span class="keyword">from</span> config.hosts <span class="keyword">import</span> SOURCES_HOSTS,TARGETS_HOSTS,KVM_HOSTS</div><div class="line"><span class="keyword">from</span> fabric.contrib.files <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> application.kvmcreate <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> application.appcreate <span class="keyword">import</span> *</div><div class="line"><span class="meta">@hosts(SOURCES_HOSTS)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_sources_clone_scp</span><span class="params">()</span>:</span></div><div class="line">    kvm_create()</div><div class="line"><span class="meta">@hosts(TARGETS_HOSTS)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_targets_site</span><span class="params">()</span>:</span></div><div class="line">    targets_hosts_start_kvm()</div><div class="line"><span class="meta">@hosts(KVM_HOSTS)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kvm_virture_host_start_site</span><span class="params">()</span>:</span></div><div class="line">    kvm_virture_hosts_site()</div><div class="line">    run_install_all_application_package()</div><div class="line">    kvm_tirture_hosts_site_passwd()</div><div class="line">    kvm_virture_hosts_print()</div><div class="line"><span class="meta">@task(name='install')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_all</span><span class="params">()</span>:</span></div><div class="line">    execute(kvm_sources_clone_scp)</div><div class="line">    execute(kvm_targets_site)</div><div class="line">    execute(kvm_virture_host_start_site)</div><div class="line"><span class="meta">@task(name='help')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">deploy_help</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> green(<span class="string">"KVMäº§å“åŠCentOS7åº”ç”¨éƒ¨ç½²"</span>)</div><div class="line">    <span class="keyword">print</span> yellow(<span class="string">"    1.é…ç½®æ–‡ä»¶"</span>)</div><div class="line">    helper = PrettyTable()</div><div class="line">    helper.field_names = [<span class="string">"é…ç½®"</span>,<span class="string">"è¯´æ˜"</span>]</div><div class="line">    helper.align = <span class="string">"l"</span></div><div class="line">    helper.add_row([<span class="string">"config/__init__.py"</span>, <span class="string">"é…ç½®æ–‡ä»¶å¼€å…³"</span>])</div><div class="line">    helper.add_row([<span class="string">"config/test/kvm_config.py"</span>, <span class="string">"æµ‹è¯•ç¯å¢ƒéƒ¨ç½²é…ç½®"</span>])</div><div class="line">    helper.add_row([<span class="string">"config/prod/kvm_config.py"</span>, <span class="string">"ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®"</span>])</div><div class="line">    <span class="keyword">print</span> helper</div><div class="line">    <span class="keyword">print</span> red(<span class="string">"    2.æŒ‡ä»¤è¯´æ˜"</span>)</div><div class="line">    helper = PrettyTable()</div><div class="line">    helper.field_names = [<span class="string">"æŒ‡ä»¤"</span>,<span class="string">"è¯´æ˜"</span>]</div><div class="line">    helper.align = <span class="string">"l"</span></div><div class="line">    helper.add_row([<span class="string">"fab -f kvm.py -l"</span>, <span class="string">"åˆ—å‡ºéƒ¨ç½²äº§å“"</span>])</div><div class="line">    helper.add_row([<span class="string">"fab -f kvm.py install"</span>, <span class="string">"å®‰è£…kvm,å¹¶æ•´åˆé…ç½®çš„åº”ç”¨è‡³kvmæ–°è™šæ‹ŸæœåŠ¡å™¨"</span>])</div><div class="line">    <span class="keyword">print</span> helper</div><div class="line">    <span class="keyword">print</span> blue(<span class="string">"    3.ä½œè€…ä¿¡æ¯"</span>)</div><div class="line">    helper = PrettyTable()</div><div class="line">    helper.field_names = [<span class="string">"ä½œè€…"</span>,<span class="string">"ä¿¡æ¯"</span>]</div><div class="line">    helper.add_row([<span class="string">"å§“å"</span>, <span class="string">"ä»»é”¦"</span>])</div><div class="line">    helper.add_row([<span class="string">"æ‰‹æœºå·"</span>, <span class="string">"13161389224"</span>])</div><div class="line">    helper.add_row([<span class="string">"åšå®¢åœ°å€"</span>, <span class="string">"www.ssjinyao.com"</span>])</div><div class="line">    <span class="keyword">print</span> helper</div></pre></td></tr></table></figure><h2 id="æœåŠ¡å™¨éƒ¨ç½²å®Œæ­¤ä»£ç åï¼Œå®šä¹‰åˆ«åè°ƒç”¨kvm-pyå®ç°å¿«é€Ÿå¼€é€š"><a href="#æœåŠ¡å™¨éƒ¨ç½²å®Œæ­¤ä»£ç åï¼Œå®šä¹‰åˆ«åè°ƒç”¨kvm-pyå®ç°å¿«é€Ÿå¼€é€š" class="headerlink" title="æœåŠ¡å™¨éƒ¨ç½²å®Œæ­¤ä»£ç åï¼Œå®šä¹‰åˆ«åè°ƒç”¨kvm.pyå®ç°å¿«é€Ÿå¼€é€š"></a>æœåŠ¡å™¨éƒ¨ç½²å®Œæ­¤ä»£ç åï¼Œå®šä¹‰åˆ«åè°ƒç”¨kvm.pyå®ç°å¿«é€Ÿå¼€é€š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># alias kc1='source  /root/renjin/kvm_pyenv/bin/activate &amp;&amp; vim /root/renjin/kvm_create/config/__init__.py'</span></div><div class="line"><span class="comment"># alias kc2p='vim +33 /root/renjin/kvm_create/config/prod/kvm_config.py'</span></div><div class="line"><span class="comment"># alias kc2t='vim +33 /root/renjin/kvm_create/config/test/kvm_config.py'</span></div><div class="line"><span class="comment"># alias kc3='cd /root/renjin/kvm_create/ &amp;&amp; fab -f kvm.py install'</span></div><div class="line"><span class="comment"># alias kcok1='vim /root/renjin/kvm_create/config/__init__.py'</span></div><div class="line"><span class="comment"># alias kcok2p='vim +33 /root/renjin/kvm_create/config/prod/kvm_config.py'</span></div><div class="line"><span class="comment"># alias kcok2t='vim +33 /root/renjin/kvm_create/config/test/kvm_config.py'</span></div></pre></td></tr></table></figure><h2 id="è‡ªåŠ¨åŒ–å¿«é€Ÿå¼€å¯å¼€é€škvmè™šæ‹ŸåŒ–æœåŠ¡å™¨"><a href="#è‡ªåŠ¨åŒ–å¿«é€Ÿå¼€å¯å¼€é€škvmè™šæ‹ŸåŒ–æœåŠ¡å™¨" class="headerlink" title="è‡ªåŠ¨åŒ–å¿«é€Ÿå¼€å¯å¼€é€škvmè™šæ‹ŸåŒ–æœåŠ¡å™¨"></a>è‡ªåŠ¨åŒ–å¿«é€Ÿå¼€å¯å¼€é€škvmè™šæ‹ŸåŒ–æœåŠ¡å™¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">****************************************************************************************************</div><div class="line">**********  KVM ENV Is: <span class="built_in">test</span>                                                              **********</div><div class="line">**********  KVM Host Name Is: xx-xxxx-xx-xxx-xxxx-xxxx                                   **********</div><div class="line">**********  KVM IP Is: xxx.xx.xx.xx                                                       **********</div><div class="line">**********  TARGET IP Is: xxx.xx.xxx.xx                                                   **********</div><div class="line">**********  KVM Gateway Is: xxx.xx.x.x                                                    **********</div><div class="line">**********  KVM Netmask Is: xxx.xxx.xxx.x                                                 **********</div><div class="line">**********  KVM APP Is: zabbix_agent nginx mysql_xx                                       **********</div><div class="line">**********  KVM CPU Is: 2                                                                 **********</div><div class="line">**********  KVM Memory Is: 4194304                                                        **********</div><div class="line">**********  KVM Disk Is: 100G                                                             **********</div><div class="line">**********  KVM Passwd IS: xxxxxxxXXXX                                                    **********</div><div class="line">****************************************************************************************************</div><div class="line"></div><div class="line">If the information is incorrect, please input no:</div></pre></td></tr></table></figure><p><img src="/images/kvm_start_install.png" alt=""></p><h3 id="å¼€é€škvmè™šä¼¼æœåŠ¡å™¨å·²ç»å®Œæˆï¼Œä¿¡æ¯å¦‚ä¸‹"><a href="#å¼€é€škvmè™šä¼¼æœåŠ¡å™¨å·²ç»å®Œæˆï¼Œä¿¡æ¯å¦‚ä¸‹" class="headerlink" title="å¼€é€škvmè™šä¼¼æœåŠ¡å™¨å·²ç»å®Œæˆï¼Œä¿¡æ¯å¦‚ä¸‹"></a>å¼€é€škvmè™šä¼¼æœåŠ¡å™¨å·²ç»å®Œæˆï¼Œä¿¡æ¯å¦‚ä¸‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">****************************************************************************************************</div><div class="line">**********  KVM ENV Is: <span class="built_in">test</span>                                                              **********</div><div class="line">**********  KVM Host Name Is: bj-xxxx-xx-xxx-xxxx-xxxxx                                   **********</div><div class="line">**********  KVM IP Is: xxx.xx.xx.xx                                                       **********</div><div class="line">**********  TARGET IP Is: xxx.xx.xxx.xx                                                   **********</div><div class="line">**********  KVM Gateway Is: xxx.xx.xx.x                                                   **********</div><div class="line">**********  KVM Netmask Is: xxx.xxx.xxx.0                                                 **********</div><div class="line">**********  KVM APP Is:  zabbix_agent nginx mysql_xx                                      **********</div><div class="line">**********  KVM CPU Is: 2                                                                 **********</div><div class="line">**********  KVM Memory Is: 4194304                                                        **********</div><div class="line">**********  KVM Disk Is: 100G                                                             **********</div><div class="line">**********  KVM Passwd IS: XXXXXXXX                                                       **********</div><div class="line">****************************************************************************************************</div><div class="line"></div><div class="line"></div><div class="line">Done.</div><div class="line">Disconnecting from xxx.xx.xx.xx... <span class="keyword">done</span>.</div><div class="line">Disconnecting from xxx.xx.xx.xx... <span class="keyword">done</span>.</div><div class="line">Disconnecting from xxx.xx.xx.xx... <span class="keyword">done</span>.</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å…³äºæŸç³»ç»Ÿé˜µå‘æ€§ç½‘ç»œé—®é¢˜çš„å¤„ç†ã€‚</title>
      <link href="/2019/03/16/%E5%85%B3%E4%BA%8E%E6%9F%90%E7%B3%BB%E7%BB%9F%E9%98%B5%E5%8F%91%E6%80%A7%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86/"/>
      <url>/2019/03/16/%E5%85%B3%E4%BA%8E%E6%9F%90%E7%B3%BB%E7%BB%9F%E9%98%B5%E5%8F%91%E6%80%A7%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="å…³äºæŸç³»ç»Ÿé˜µå‘æ€§ç½‘ç»œé—®é¢˜çš„å¤„ç†ã€‚"><a href="#å…³äºæŸç³»ç»Ÿé˜µå‘æ€§ç½‘ç»œé—®é¢˜çš„å¤„ç†ã€‚" class="headerlink" title="å…³äºæŸç³»ç»Ÿé˜µå‘æ€§ç½‘ç»œé—®é¢˜çš„å¤„ç†ã€‚"></a>å…³äºæŸç³»ç»Ÿé˜µå‘æ€§ç½‘ç»œé—®é¢˜çš„å¤„ç†ã€‚</h2><p> <img src="/images/tcp_problem.jpeg" alt=""></p><h3 id="ä¸€ã€é—®é¢˜æè¿°"><a href="#ä¸€ã€é—®é¢˜æè¿°" class="headerlink" title="ä¸€ã€é—®é¢˜æè¿°"></a>ä¸€ã€é—®é¢˜æè¿°</h3><ul><li>1ã€xxx ã€ç§»åŠ¨ xx ç­‰ç³»ç»Ÿé˜µå‘æ€§ç½‘ç»œè¿æ¥å¤±è´¥;</li><li>2ã€keepalived è™šæ‹Ÿipæœªå‘ç”Ÿåˆ‡æ¢ï¼Œnginx è®¿é—®æ—¥å¿—è®°å½•æ­£å¸¸ï¼Œæœªæ”¶åˆ°é”™è¯¯æ—¥å¿—ï¼Œç½‘ç»œåŠé“¾è·¯æµ‹è¯•æ­£å¸¸;</li><li>3ã€keepalvied+ nginx åä»£çš„å…¶ä½™ç³»ç»Ÿæœªå‘ç°é˜µå‘æ€§ç½‘ç»œé—®é¢˜;</li><li><p>4ã€ä¿®æ”¹æœ¬åœ°è§£æåˆ°keepalivedè™šæ‹Ÿipï¼ŒXXXç›¸å…³ç³»ç»Ÿè®¿é—®æ­£å¸¸ã€‚</p><p><img src="/images/granfana-network-problem.jpg" alt=""></p></li></ul><h3 id="äºŒã€åº”æ€¥åˆ‡æ¢ä¸æ•…éšœé‡ç°"><a href="#äºŒã€åº”æ€¥åˆ‡æ¢ä¸æ•…éšœé‡ç°" class="headerlink" title="äºŒã€åº”æ€¥åˆ‡æ¢ä¸æ•…éšœé‡ç°"></a>äºŒã€åº”æ€¥åˆ‡æ¢ä¸æ•…éšœé‡ç°</h3><ul><li>1ã€å‘¨äºŒé¢‘ç¹å‡ºç°é˜µå‘æ€§ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œåº”æ€¥å°†XXXè™šipåˆ‡æ¢å›åŸç§æœ‰äº‘æœåŠ¡å™¨ï¼Œç³»ç»Ÿæ¢å¤;</li><li>2ã€åè€ƒè™‘ç§»åŠ¨xxç³»ç»Ÿå‡ºç°çš„ç½‘ç»œé—®é¢˜é¢‘ç‡è¾ƒé«˜ï¼Œå› æ­¤è€ƒè™‘åœ¨ä¸ªäººå®¢æˆ·ç«¯é‡ç°æ•…éšœ;</li><li>3ã€åœ¨ä¸ªäººmacosä¸­æ­å»ºdnsæœåŠ¡å™¨ï¼Œé…ç½®xxåŸŸåè§£æåˆ°éXXX ç³»ç»Ÿkeepavliedè™šipæ‰€æ˜ å°„çš„å…¬ç½‘ip;</li><li>4ã€åœ¨æ‰‹æœºä¸Šåˆ·æ–°appï¼Œå¤šæ¬¡åˆ·æ–°ï¼Œé”å±å†æ‰“å¼€åæ•…éšœé‡ç°ã€‚</li></ul><h3 id="ä¸‰ã€é—®é¢˜å®šä½"><a href="#ä¸‰ã€é—®é¢˜å®šä½" class="headerlink" title="ä¸‰ã€é—®é¢˜å®šä½"></a>ä¸‰ã€é—®é¢˜å®šä½</h3><ul><li>1ã€æ•…éšœé‡ç°åï¼Œåœ¨XXXç³»ç»Ÿ keepailved æ‰€åœ¨çš„æœåŠ¡å™¨ä¸Šè¿›è¡Œ tcpdump æŠ“åŒ…åˆ†æ;</li><li>2ã€å› ç›®å‰åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è®¿é—®éXXX nginxï¼Œå› æ­¤å¯ä»¥çœ‹åˆ°nginxæ—¥å¿—æ˜¯ä¸€ä¸ªå…¬ç½‘ipè®¿é—®è¿‡æ¥çš„;</li><li>3ã€å¼€å¯ä¸¤ä¸ªç»ˆç«¯ï¼Œä¸€ä¸ªå®æ—¶ç›‘æ§æ—¥å¿—ï¼Œå¦ä¸€ä¸ªç”¨äºtcpdumpæŠ“åŒ…ä¿å­˜</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># tail -f /var/log/nginx/oa.huatu.com.log </div><div class="line"># tcpdump -i team1 -s 0 -n &apos;host xxx.xxx.xxx.xxx&apos; -w /tmp/xx_packet.pcap</div></pre></td></tr></table></figure><ul><li>4ã€å½“appç«¯é—®é¢˜å¤ç°åï¼Œå‘ç°nginx æœªè®°å½•æ—¥å¿—, å°† xx_packet.pcap å¯¼å‡ºï¼Œç”¨wireshark å¯¼å‡ºåˆ†æ</li><li>5ã€å‘ç°æœ‰ä¸‰æ¬¡tcpè¯·æ±‚æ˜¯æ­£å¸¸è¿›å…¥ç½‘å¡çš„ï¼Œä½†æ˜¯æœåŠ¡å™¨æ²¡æœ‰å›åº”ï¼Œé—®é¢˜å®šä½åœ¨æœåŠ¡å™¨ç½‘ç»œå±‚é¢;</li><li>6ã€googleæœç´¢ linux tcp æ²¡æœ‰å›åŒ… ï¼Œå‘ç°åŸç†æ˜¯ç”±ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°å¯¼è‡´çš„</li><li>7ã€net.ipv4.tcp_timestamps net.ipv4.tcp_tw_recycle;</li><li>8ã€å‘ç°æœåŠ¡å™¨ä¸Šçš„net.ipv4.tcp_timestampsï¼Œnet.ipv4.tcp_tw_recycle éƒ½ä¸º1;</li></ul><h3 id="å››ã€æ•…éšœå¤„ç†"><a href="#å››ã€æ•…éšœå¤„ç†" class="headerlink" title="å››ã€æ•…éšœå¤„ç†"></a>å››ã€æ•…éšœå¤„ç†</h3><p>ä¿®æ”¹ä¸¤å°æœåŠ¡å™¨çš„ /etc/sysctl.conf  ä»¥ä¸‹ä¸¤æ¡å†…æ ¸å‚æ•°ï¼Œå¹¶ç”Ÿæ•ˆ;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># vim  /etc/sysctl.conf</div><div class="line">net.ipv4.tcp_tw_recycle = 0</div><div class="line">net.ipv4.tcp_timestamps = 0 </div><div class="line"></div><div class="line"># sysctl -p ç”Ÿæ•ˆ</div></pre></td></tr></table></figure><p>å°†keepalived è™šæ‹Ÿipå†åˆ‡æ¢å›ç‰©ç†æœåŠ¡å™¨ï¼Œæ•…éšœå¤„ç†;</p><h3 id="äº”ã€å†…æ ¸å‚æ•°è¯´æ˜"><a href="#äº”ã€å†…æ ¸å‚æ•°è¯´æ˜" class="headerlink" title="äº”ã€å†…æ ¸å‚æ•°è¯´æ˜;"></a>äº”ã€å†…æ ¸å‚æ•°è¯´æ˜;</h3><ul><li>1ã€net.ipv4.tcp_timestamps æ˜¯ç»™æ‰€æœ‰è¿›å…¥æœåŠ¡å™¨ç½‘å¡çš„æµé‡æ‰“æ—¶é—´æ ‡ç­¾ï¼Œå°±åƒç”Ÿäº§çš„é¢åŒ…æ‰“å°ç”Ÿäº§æ—¥æœŸ;</li><li>2ã€net.ipv4.tcp_tw_recycle æ˜¯å¯¹è¿æ¥æ—¶é—´è¶…è¿‡60sçš„tcpèµ„æºè¿›è¡Œå›æ”¶å¹¶rejectï¼ŒåŒä¸€æ—¶é—´å†…åŒä¸€ipè®¿é—®è¿‡å¤šçš„tcpè¿æ¥ï¼Œå®ƒåªä¼šè®¤ä¸ºæœ€è¿‘çš„ä¸€æ¬¡SYNæœ‰æ•ˆï¼Œå…¶ä½™çš„SYNæ‹’ç»;</li><li>è¿™ä¸¤æ¡å‚æ•°é…åˆèµ·æ¥ï¼Œå½“éƒ½å¼€å¯æ—¶ç”¨äºé˜²èŒƒtcpæ”»å‡»;</li><li>3ã€è¿™ä¸¤ä¸ªå‚æ•°ç»“åˆèµ·æ¥æ˜¯ä¸ºäº†é˜²æ­¢åŒä¸€ipçš„tcpæ”»å‡»ï¼Œå› åŒä¸€å±€åŸŸç½‘å†…æ˜¯åŒä¸€ä¸ªå…¬ç½‘ipï¼Œæ•…é€ æˆåŒä¸€å±€åŸŸç½‘å†…å¤šäººè®¿é—®æ—¶ï¼ŒSYNè¢«æ‹’ç»ï¼ŒæŠ¥ç½‘ç»œé”™è¯¯ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•éXXXä¸šåŠ¡è®¿é—®æœªå‡ºç°è¿™æ ·çš„é—®é¢˜ã€é€šè¿‡ä¿®æ”¹æœ¬åœ°hostè§£æç›´æ¥è®¿é—®ç§ç½‘ipæœªå‡ºç°è¿™æ ·çš„é—®é¢˜ã€‚</li></ul>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>nginx+lua+redis å®ç°çŸ­é“¾æ¥è½¬å‘é•¿é“¾æ¥</title>
      <link href="/2019/03/11/nginx-lua-redis%E5%AE%9E%E7%9F%AD%E9%93%BE%E6%8E%A5%E8%BD%AC%E5%8F%91%E9%95%BF%E9%93%BE%E6%8E%A5/"/>
      <url>/2019/03/11/nginx-lua-redis%E5%AE%9E%E7%9F%AD%E9%93%BE%E6%8E%A5%E8%BD%AC%E5%8F%91%E9%95%BF%E9%93%BE%E6%8E%A5/</url>
      <content type="html"><![CDATA[<h2 id="nginx-lua-redis-å®ç°çŸ­é“¾æ¥è½¬å‘é•¿é“¾æ¥"><a href="#nginx-lua-redis-å®ç°çŸ­é“¾æ¥è½¬å‘é•¿é“¾æ¥" class="headerlink" title="nginx + lua + redis å®ç°çŸ­é“¾æ¥è½¬å‘é•¿é“¾æ¥"></a>nginx + lua + redis å®ç°çŸ­é“¾æ¥è½¬å‘é•¿é“¾æ¥</h2><p><img src="/images/nginx-redis-lua.png" alt=""></p><h3 id="é‡æ–°ç¼–è¯‘å®‰è£…-nginx-åŠç›¸å…³ä¾èµ–"><a href="#é‡æ–°ç¼–è¯‘å®‰è£…-nginx-åŠç›¸å…³ä¾èµ–" class="headerlink" title="é‡æ–°ç¼–è¯‘å®‰è£… nginx  åŠç›¸å…³ä¾èµ–"></a>é‡æ–°ç¼–è¯‘å®‰è£… nginx  åŠç›¸å…³ä¾èµ–</h3><p>å®‰è£…ç›¸å…³ä¾èµ–åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel  lua-devel luajit-devel pcre pcre-devel libxml2 libxml2-dev libxslt-devel gd-devel perl-devel perl-ExtUtils-Embed  GeoIP GeoIP-devel GeoIP-data gperftools</span></div></pre></td></tr></table></figure><p>ä¸‹è½½nginx_devel_kit lua-nginx-module</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  wget https://github.com/simplresty/ngx_devel_kit/archive/master.zip</span></div><div class="line"><span class="comment">#  wget https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz</span></div><div class="line"><span class="comment">#  unzip master.zip &amp;&amp; mv ngx_devel_kit-master/ /usr/local/</span></div><div class="line"><span class="comment">#  tar -xvf v0.10.13.tar.gz  -C /usr/local/</span></div></pre></td></tr></table></figure><p>é‡æ–°å®‰è£…  nginx </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /usr/local/src/nginx-1.12.2</span></div><div class="line"><span class="comment"># ./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E' --add-module=/usr/local/lua-nginx-module-0.10.13 --add-module=/usr/local/ngx_devel_kit-master</span></div><div class="line"><span class="comment"># make  &amp;&amp; make install</span></div></pre></td></tr></table></figure><p>å®‰è£…lua-resty-redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /usr/local/src</span></div><div class="line"><span class="comment"># wget https://github.com/openresty/lua-resty-redis/archive/master.zip</span></div><div class="line"><span class="comment"># unzip master.zip</span></div><div class="line"><span class="comment"># cd lua-resty-redis-master/</span></div><div class="line"><span class="comment"># make &amp;&amp; make install</span></div><div class="line">make: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `all<span class="string">'.</span></div><div class="line"><span class="string">install -d /usr/local/lib/lua//resty</span></div><div class="line"><span class="string">install lib/resty/*.lua /usr/local/lib/lua//resty</span></div></pre></td></tr></table></figure><h2 id="ä¿®æ”¹nginx-http-æ®µå†…é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹nginx-http-æ®µå†…é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹nginx http æ®µå†…é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹nginx http æ®µå†…é…ç½®æ–‡ä»¶</h2><p>httpå†…æ·»åŠ  <code>lua_package_path &quot;/usr/local/lib/lua/?.lua;;&quot;;</code><br><code>;;</code> ä»£è¡¨çš„æ˜¯LuaJITå®‰è£…æ—¶çš„åŸå§‹æœç´¢è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nginx -t &amp;&amp; nginx -s reload</span></div></pre></td></tr></table></figure><h2 id="ä¿®æ”¹nginx-serveræˆ–location-å­—æ®µ"><a href="#ä¿®æ”¹nginx-serveræˆ–location-å­—æ®µ" class="headerlink" title="ä¿®æ”¹nginx serveræˆ–location å­—æ®µ"></a>ä¿®æ”¹nginx serveræˆ–location å­—æ®µ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /lua &#123;</div><div class="line">       default_type text/plain;</div><div class="line">       content_by_lua_file /usr/<span class="built_in">local</span>/lua/request.lua;</div><div class="line">     &#125;</div></pre></td></tr></table></figure><h2 id="request-lua"><a href="#request-lua" class="headerlink" title="request.lua"></a>request.lua</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"># vim /usr/<span class="keyword">local</span>/lua/request.lua</div><div class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">"resty.redis"</span></div><div class="line"><span class="keyword">local</span> cache = redis:new()</div><div class="line"><span class="comment">-- redisè¿æ¥</span></div><div class="line"><span class="keyword">local</span> ok,err = cache.connect(cache, <span class="string">'127.0.0.1'</span>, <span class="string">'25612'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></div><div class="line">    ngx.say(<span class="string">"failed to connect redis cache:"</span>, err);</div><div class="line">    <span class="keyword">return</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">-- redisè®¤è¯</span></div><div class="line"><span class="keyword">local</span> count</div><div class="line">count, err = cache:get_reused_times()</div><div class="line"><span class="keyword">if</span> <span class="number">0</span> == count <span class="keyword">then</span></div><div class="line">    ok,err = cache:auth(<span class="string">"xxxxx"</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></div><div class="line">        ngx.say(<span class="string">"failed to auth redis: "</span> , err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">elseif</span> err <span class="keyword">then</span></div><div class="line">    ngx.say(<span class="string">"failed to get reused times: "</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="comment">-- é€‰æ‹©ä½¿ç”¨çš„redisæ•°æ®åº“</span></div><div class="line">cache:<span class="built_in">select</span>(<span class="number">7</span>)</div><div class="line"><span class="comment">-- å½“å‰è®¿é—®åœ°å€</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> url = ngx.var.uri</div><div class="line"></div><div class="line"><span class="comment">--  ä¸»æœºå</span></div><div class="line"><span class="keyword">local</span> host = ngx.var.host</div><div class="line"></div><div class="line"><span class="comment">-- é“¾æ¥å‚æ•°</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> args = ngx.var.args</div><div class="line"></div><div class="line"><span class="comment">-- è·å–æ–¹æ³•</span></div><div class="line"><span class="keyword">local</span> sch =ngx.var.scheme</div><div class="line"></div><div class="line"><span class="comment">-- è·å–ç«¯å£</span></div><div class="line"><span class="comment">--local pot =ngx.var.server_port</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- å®šä¹‰é€šç”¨å®Œæ•´ url è·¯å¾„</span></div><div class="line"><span class="keyword">local</span> url_full_path = sch .. <span class="string">"://"</span> .. host .. url</div><div class="line"></div><div class="line"><span class="comment">-- è·å–redis ä¸­çš„å€¼</span></div><div class="line"><span class="keyword">local</span> res, err = cache:get(url_full_path)</div><div class="line"><span class="comment">-- ngx.req.set_uri(url)</span></div><div class="line"><span class="keyword">if</span> res <span class="keyword">then</span></div><div class="line">   <span class="comment">--ngx.say(sch .. "://" .. host .. url .. " " .. res)</span></div><div class="line">   ngx.redirect(res,<span class="number">302</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"># nginx -s reload</div></pre></td></tr></table></figure><h2 id="åœ¨redis-å†™å…¥key-å¹¶æµ‹è¯•"><a href="#åœ¨redis-å†™å…¥key-å¹¶æµ‹è¯•" class="headerlink" title="åœ¨redis å†™å…¥key å¹¶æµ‹è¯•"></a>åœ¨redis å†™å…¥key å¹¶æµ‹è¯•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># redis-cli -h 127.0.0.1 -p 25612</span></div><div class="line">127.0.0.1:25612&gt; AUTH xxxxxxxxxx</div><div class="line">OK</div><div class="line">127.0.0.1:25612&gt; SELECT 7</div><div class="line">OK</div><div class="line">127.0.0.1:25612[7]&gt; <span class="built_in">set</span> https://www.ssjinyao.com/lua/<span class="built_in">test</span> https://www.ssjinyao.com/2019/03/16/%E5%85%B3%E4%BA%8E%E6%9F%90%E7%B3%BB%E7%BB%9F%E9%98%B5%E5%8F%91%E6%80%7%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86/</div><div class="line">OK</div></pre></td></tr></table></figure><p><img src="/images/nginx-redis-lua-test.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°è®¿é—®æ—¶çš„ä¸­è½¬</p><p><img src="/images/nginx-redis-lua-test-redirect.png" alt=""></p><h2 id="è¡¥å……nginx-rewriteè½¬å‘æ­£åˆ™åŒ¹é…"><a href="#è¡¥å……nginx-rewriteè½¬å‘æ­£åˆ™åŒ¹é…" class="headerlink" title="è¡¥å……nginx rewriteè½¬å‘æ­£åˆ™åŒ¹é…"></a>è¡¥å……nginx rewriteè½¬å‘æ­£åˆ™åŒ¹é…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rewrite ^/([0-9][0-9][0-9][0-9])/([0-1][0-9][0-9][0-9])/([0-9]+\.html) http://test.ssjinyao.com/<span class="variable">$1</span>/<span class="variable">$2</span>/<span class="variable">$3</span>  permanent;</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>æœåŠ¡å™¨å¸¸ç”¨é…ç½®å‚æ•°æ˜ç»†</title>
      <link href="/2018/10/29/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E6%98%8E%E7%BB%86/"/>
      <url>/2018/10/29/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E6%98%8E%E7%BB%86/</url>
      <content type="html"><![CDATA[<h1 id="çº¿ä¸ŠæœåŠ¡é…ç½®å‚æ•°æ˜ç»†"><a href="#çº¿ä¸ŠæœåŠ¡é…ç½®å‚æ•°æ˜ç»†" class="headerlink" title="çº¿ä¸ŠæœåŠ¡é…ç½®å‚æ•°æ˜ç»†"></a>çº¿ä¸ŠæœåŠ¡é…ç½®å‚æ•°æ˜ç»†</h1><p><img src="/images/ops.png" alt=""></p><ul><li><p>é—®ç­”nginx åå‘ä»£ç†çš„ä½œç”¨<br>1ã€ä½¿ç”¨åå‘ä»£ç†å¯ä»¥ç†è§£ä¸º7å±‚åº”ç”¨å±‚çš„è´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨è´Ÿè½½å‡è¡¡ä¹‹åå¯ä»¥éå¸¸ä¾¿æ·çš„æ¨ªå‘æ‰©å±•æœåŠ¡å™¨é›†ç¾¤ï¼Œå®ç°é›†ç¾¤æ•´ä½“å¹¶å‘èƒ½åŠ›ã€æŠ—å‹èƒ½åŠ›çš„æé«˜ã€‚<br>2ã€é€šå¸¸åå‘ä»£ç†æœåŠ¡å™¨ä¼šå¸¦æœ‰æœ¬åœ° Cache åŠŸèƒ½ï¼Œé€šè¿‡é™æ€èµ„æºçš„ Cacheï¼Œæœ‰æ•ˆçš„å‡å°‘åç«¯æœåŠ¡å™¨æ‰€æ‰¿è½½çš„å‹åŠ›ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</p></li><li><p>ç£¨åˆ€æ„è¯†</p></li></ul><p>1ã€å…³äºä»»ä½•æ“ä½œé…ç½®ï¼Œæœ€å¥½å…ˆææ˜ç™½æ“ä½œæˆ–é…ç½®çš„åŸç†ï¼Œç„¶åå†å»æ“ä½œã€‚åº”ä¸€å¥è¯å«åšâ€œç£¨åˆ€ä¸è¯¯ç æŸ´åŠŸâ€ï¼Œè€Œä¸”å¯¹äºç±»ä¼¼çš„æ“ä½œå¯ä»¥ä¸¾ä¸€åä¸‰ã€‚</p><h2 id="nginxæœåŠ¡é…ç½®é¡¹"><a href="#nginxæœåŠ¡é…ç½®é¡¹" class="headerlink" title="nginxæœåŠ¡é…ç½®é¡¹"></a>nginxæœåŠ¡é…ç½®é¡¹</h2><p>1ã€ nginx å…¨å±€é…ç½®æ˜ç»†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"># é»˜è®¤ /etc/nginx/nginx.conf å…¨å±€é…ç½®æ–‡ä»¶ </div><div class="line">#æŒ‡å®šnginx workerè¿›ç¨‹è¿è¡Œç”¨æˆ·ä»¥åŠç”¨æˆ·ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯ user www-data www-data;</div><div class="line">user www-data; </div><div class="line"># æŒ‡æ˜nginxè¦å¼€å¯çš„è¿›ç¨‹æ•°ä¸º4ï¼Œä¸€èˆ¬ä¸ºCPUæ ¸å¿ƒæ•°çš„1åˆ°2å€;</div><div class="line">worker_processes 4;</div><div class="line"></div><div class="line"># nginx pidæ–‡ä»¶å­˜æ”¾ä½ç½® </div><div class="line">pid /run/nginx.pid;</div><div class="line"></div><div class="line"># events &#123;è¿™é‡Œéƒ½æ˜¯nginxçš„äº‹ä»¶æ¨¡å—&#125;</div><div class="line">events &#123;</div><div class="line"># worker_connetctions æ˜¯æŒ‡nginxæœ€å¤§çš„å¹¶å‘è¿æ¥æ•°;</div><div class="line">worker_connections 768;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># http &#123;è®¾å®šhttpæœåŠ¡&#125;</div><div class="line">http &#123;</div><div class="line"># è®¾ç½®nginxä¸Šä¼ æ–‡ä»¶æœ€å¤§é™åˆ¶</div><div class="line">   client_max_body_size 50m;   </div><div class="line">   </div><div class="line">#  é…ç½®å¯ä»¥æé«˜ Nginx é™æ€èµ„æºæ‰˜ç®¡æ•ˆç‡ã€‚sendfile æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç›´æ¥åœ¨å†…æ ¸ç©ºé—´å®Œæˆæ–‡ä»¶å‘é€ï¼Œä¸éœ€è¦å…ˆ read å† writeï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€;</div><div class="line">sendfile on;</div><div class="line"></div><div class="line"># Nginx é‡Œç»Ÿä¸€ç”¨ tcp_nopush æ¥æ§åˆ¶å®ƒ,åªæœ‰åœ¨å¯ç”¨äº† sendfile ä¹‹åæ‰ç”Ÿæ•ˆï¼Œå¯ç”¨å®ƒä¹‹åï¼Œæ•°æ®åŒ…ä¼šç´¯è®¡åˆ°ä¸€å®šå¤§å°ä¹‹åæ‰ä¼šå‘é€ï¼Œå‡å°äº†é¢å¤–å¼€é”€ï¼Œæé«˜ç½‘ç»œæ•ˆç‡;</div><div class="line">tcp_nopush on;</div><div class="line"></div><div class="line"># å¯ç”¨åä¼šç¦ç”¨ Nagle ç®—æ³•ï¼Œå°½å¿«å‘é€æ•°æ®ï¼ŒNginx åªä¼šé’ˆå¯¹å¤„äº keep-alive çŠ¶æ€çš„ TCP è¿æ¥æ‰ä¼šå¯ç”¨;</div><div class="line">tcp_nodelay on;</div><div class="line"></div><div class="line"># é•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’,é•¿è¿æ¥è¯·æ±‚å¤§é‡å°æ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥å‡å°‘é‡å»ºè¿æ¥çš„å¼€é”€ï¼Œä½†å‡å¦‚æœ‰å¤§æ–‡ä»¶ä¸Šä¼   </div><div class="line"># 65så†…æ²¡ä¸Šä¼ å®Œæˆä¼šå¯¼è‡´å¤±è´¥ã€‚å¦‚æœè®¾ç½®æ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·åˆå¤šï¼Œé•¿æ—¶é—´ä¿æŒè¿æ¥ä¼šå ç”¨å¤§é‡èµ„æºã€‚</div><div class="line">keepalive_timeout 65;</div><div class="line"></div><div class="line"># types_hash_max_size å½±å“æ•£åˆ—è¡¨çš„å†²çªç‡ã€‚types_hash_max_sizeè¶Šå¤§ï¼Œå°±ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜</div><div class="line"># ä½†æ•£åˆ—keyçš„å†²çªç‡ä¼šé™ä½ï¼Œæ£€ç´¢é€Ÿåº¦å°±æ›´å¿«</div><div class="line"># types_hash_max_sizeè¶Šå°ï¼Œæ¶ˆè€—çš„å†…å­˜å°±è¶Šå°ï¼Œä½†æ•£åˆ—keyçš„å†²çªç‡å¯èƒ½ä¸Šå‡</div><div class="line">types_hash_max_size 2048;</div><div class="line"></div><div class="line"># å®šä¹‰ mime é…ç½®æ–‡ä»¶çš„æ–‡ä½</div><div class="line">include /etc/nginx/mime.types;</div><div class="line"></div><div class="line"># å½“ç”¨æˆ·è¯·æ±‚çš„æ–‡ä»¶ç±»å‹ ä¸åœ¨æœåŠ¡å™¨å®šä¹‰çš„mimeç±»å‹æ˜ å°„æ—¶ï¼Œä½¿ç”¨DefaultType</div><div class="line">default_type application/octet-stream;</div><div class="line"></div><div class="line"># å®šä¹‰nginxæ­£å¸¸è®¿é—®æ—¥å¿—ä½ç½® </div><div class="line">access_log /var/log/nginx/access.log;</div><div class="line"></div><div class="line"># å®šä¹‰nginxé”™è¯¯è®¿é—®æ—¥å¿—ä½ç½® </div><div class="line">error_log /var/log/nginx/error.log;</div><div class="line"></div><div class="line"># å¼€å¯nginxå‹ç¼©åŠŸèƒ½ï¼Œå‹ç¼©çš„è¿‡ç¨‹æ˜¯ä¸ªæ¶ˆè€—CPUçš„è¿‡ç¨‹ï¼Œè€Œå‹ç¼©è¿‡åä¼ è¾“è¿‡ç¨‹å¯ä»¥èŠ‚çœå¸¦å®½;</div><div class="line">gzip on;</div><div class="line"></div><div class="line"># å¯¹äºmicrosoft explorer 6 ä¸å¯ç”¨gzipå‹ç¼©åŠŸèƒ½; </div><div class="line">gzip_disable &quot;msie6&quot;;</div><div class="line"></div><div class="line"># nginx è™šæ‹ŸæœåŠ¡å™¨é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•;</div><div class="line">include /etc/nginx/conf.d/*.conf;</div><div class="line"></div><div class="line"># nginx è™šæ‹ŸæœåŠ¡å™¨é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•;</div><div class="line">include /etc/nginx/sites-enabled/*.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2ã€ nginx é»˜è®¤80é‡å®šå‘443é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># æ¯ä¸ªserverä»£è¡¨ä¸€å°è™šæ‹Ÿä¸»æœº;</div><div class="line">server &#123;  </div><div class="line"></div><div class="line"># listen 80 ç›‘å¬80ç«¯å£;</div><div class="line">    listen  80;  </div><div class="line"></div><div class="line"># server_name  _; å®šä¹‰ä»»æ„åŸŸå;</div><div class="line">    server_name _ï¼›</div><div class="line"></div><div class="line"># å°†è¿”å›301çš„é‡å†™åˆ°https://æºæœåŠ¡å™¨æºuri;</div><div class="line">    return 301 https://$HOST$request_uri;</div><div class="line"></div><div class="line"># å°†server_name æ°¸ä¹…çš„å°†ä»»æ„å­—ç¬¦å¼€å¤´ç»“å°¾çš„ é‡å†™è‡³https://æºä¸»æœºæºuriä½ç½®;</div><div class="line">#    server_name test.com;  </div><div class="line">#    rewrite ^(.*)$  https://$host$1 permanent;  </div><div class="line">&#125;</div></pre></td></tr></table></figure><p>3ã€ nginx çº¿ä¸Šè™šæ‹Ÿä¸»æœºé…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"># æ¯ä¸ªserverä»£è¡¨åˆ°å“ªè™šæ‹Ÿä¸»æœº;</div><div class="line">server &#123;</div><div class="line"></div><div class="line"># ç›‘å¬httpsä¼ è¾“åè®®çš„443ç«¯å£ï¼Œsslä¸ºé‡‡ç”¨åŠ å¯†ä¼ è¾“ï¼Œå¹¶ä¸”èº«ä»½è¯æ˜;</div><div class="line">listen 443 ssl;</div><div class="line"></div><div class="line"># sslå®‰å…¨ä¼ è¾“å¼€å¯;</div><div class="line">ssl on;</div><div class="line"></div><div class="line"># æ³¨åœ¨apacheä¸­è¯ä¹¦ä¸åŠ å¯†ä¼ è¾“è¿˜æœ‰pemæ˜¯ä¸‰ä¸ªæ–‡ä»¶</div><div class="line"># sslæˆæƒè¯ä¹¦æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºèº«ä»½çš„è¯æ˜æ–‡ä»¶;</div><div class="line">ssl_certificate /home/admin/api_ssl/server.crt;</div><div class="line"></div><div class="line"># sslåŠ å¯†æ–‡ä»¶,æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ­¤å¯†é’¥æ–‡ä»¶å°†ä¼ é€çš„æ•°æ®åŠ å¯†ç ;</div><div class="line">ssl_certificate_key /home/admin/api_ssl/server.key;</div><div class="line"></div><div class="line"># è®¾ç½®å®¢æˆ·ç«¯èƒ½å¤Ÿé‡å¤ä½¿ç”¨å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ä¼šè¯å‚æ•°æ—¶é—´ä¸º5åˆ†é’Ÿ;</div><div class="line">ssl_session_timeout 5m;</div><div class="line"></div><div class="line"># æŒ‡å®šä½¿ç”¨çš„SSLåè®®</div><div class="line">ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;</div><div class="line"></div><div class="line"># æŒ‡å®šè®¸å¯å¯†ç çš„æè¿°ã€‚å¯†ç ä»¥opensslæ”¯æŒçš„æ ¼å¼æŒ‡å®šï¼›</div><div class="line">ssl_ciphers &quot;HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES&quot;;</div><div class="line"></div><div class="line"># å¯¹SSLv3å’ŒTLSv1åè®®çš„æœåŠ¡å™¨ç«¯å¯†ç éœ€æ±‚ä¼˜å…ˆçº§é«˜äºå®¢æˆ·ç«¯å¯†ç ;</div><div class="line">ssl_prefer_server_ciphers on;</div><div class="line"></div><div class="line"># æŒ‡å®šè™šæ‹Ÿä¸»æœºçš„ä¸»æœºå;</div><div class="line">server_name api.ssjinyao.com.com;</div><div class="line"></div><div class="line"># location æŒ‡å®šåŒ¹é…è§„åˆ™, / è¿™é‡ŒæŒ‡é»˜è®¤åŒ¹é…é¡¹;</div><div class="line">        location / &#123;</div><div class="line">        </div><div class="line"># å°†åŒ¹é…åˆ°çš„locationåä»£åˆ°è‡³http://127.0.0.1:17777;</div><div class="line">            proxy_pass http://127.0.0.1:17777; # è¿™é‡Œæ˜¯æŒ‡å‘ gunicorn host çš„æœåŠ¡åœ°å€</div><div class="line"></div><div class="line"># è®¾ç½®åå‘ä»£ç†çš„è¯·æ±‚å¤´éƒ¨hostä¸ºæºhttpçš„è¯·æ±‚host;</div><div class="line">            proxy_set_header Host $host;</div><div class="line"></div><div class="line"># è®¾ç½®åå‘ä»£ç†çš„è¯·æ±‚å¤´éƒ¨è½¬å‘çš„å†…å®¹ä¸ºè¯·æ±‚urlçš„æºåœ°å€;</div><div class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line"></div><div class="line"># è®¾ç½®å°†ç”¨æˆ·çš„IPèµ‹å€¼ç»™X-Real-IPä»¥ä¾›å„åº”ç”¨è°ƒç”¨;  </div><div class="line">  proxy_set_header X-Real-Ip $Remote_addr;</div><div class="line"></div><div class="line"># è®¾ç½®ä»£ç†ç¼“å†²å¤§å°ä¸º128k</div><div class="line">proxy_buffer_size   128k;</div><div class="line"></div><div class="line"># è®¾ç½®ä»£ç†ç¼“å†²åŒºé—´4è‡³ 256k       </div><div class="line">            proxy_buffers   4 256k;</div><div class="line">            </div><div class="line"># è®¾ç½®ä»£ç†æœ€å¤§ç¼“å†²åŒºé—´ä¸º256k;            </div><div class="line">            proxy_busy_buffers_size   256k;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>4ã€éœ€æ±‚-è´Ÿè½½å‡è¡¡é…ç½®é¡¹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># åœ¨httpæ®µä¸­åŠ å…¥ä»¥ä¸‹é…ç½®</div><div class="line"># æŒ‡å®šupstreamè´Ÿè½½å‡è¡¡æ¨¡å—,æŒ‡å®šå°†è¦åœ¨serverä¸­è°ƒç”¨çš„è°ƒåº¦æœåŠ¡åç§°;</div><div class="line">upstream tewww &#123;</div><div class="line"></div><div class="line"># æŒ‡å®šwebæœåŠ¡çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹; æ³¨:ä¹‹åé…ç½®ä½¿ç”¨IPæ¥é…ç½®ï¼Œè€Œä¸ä½¿ç”¨åŸŸå</div><div class="line">server wwwnode1.ssjinyao.com.com:443;</div><div class="line"></div><div class="line"># è‹¥æœ‰æ€§èƒ½è¾ƒé«˜çš„æœåŠ¡å™¨ï¼Œå¯ä»¥é‡‡ç”¨åŠ æƒè½®è¯¢ï¼Œé‚£ä¹ˆè¿™å°æœåŠ¡å™¨çš„æƒé‡æ˜¯3/5;</div><div class="line">server wwwnode2.ssjinyao.com.com:443 weight=3;</div><div class="line"></div><div class="line"># æŒ‡å®šwebæœåŠ¡çš„ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹;</div><div class="line">server wwwnode3.ssjinyao.com.com:443;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># åœ¨å®šä¹‰ä¸€å°è™šæ‹Ÿä¸»æœºï¼›</div><div class="line">server &#123;</div><div class="line">      listen 443;</div><div class="line">      server_name www.ssjinyao.com.com;</div><div class="line"></div><div class="line">      ssl on;</div><div class="line">      ssl_certificate /etc/nginx/te_ssl/ssjinyao.com.crt;</div><div class="line">      ssl_certificate_key /etc/nginx/te_ssl/ssjinyao.com.key;</div><div class="line"></div><div class="line">      ssl_session_timeout 5m;</div><div class="line"></div><div class="line">      ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">      ssl_ciphers &quot;HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES&quot;;</div><div class="line">      ssl_prefer_server_ciphers on;</div><div class="line">      location /</div><div class="line">      &#123;</div><div class="line"># æŒ‡å®šåä»£çš„æœåŠ¡å™¨ï¼Œä¸ºtewwwè´Ÿè½½å‡è¡¡é›†ç¾¤;</div><div class="line">        proxy_pass http://tewww;</div><div class="line">proxy_set_header Host $host;</div><div class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">        &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure><p>5ã€nginxæ“ä½œæ³¨æ„é¡¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">aã€ä¸å½±å“å…¶å®ƒæœåŠ¡çš„æƒ…å†µä¸‹é‡è¯»é…ç½®æ–‡ä»¶, ä¸€å®šè¦å…ˆå¯¹nginxçš„é…ç½®è¯­æ³•è¿›è¡Œæµ‹è¯•;</div><div class="line"># sudo nginx -t </div><div class="line"></div><div class="line">bã€åœ¨æ²¡æœ‰nginxç›‘å¬ç«¯å£å˜æ›´çš„æƒ…å†µä¸‹ï¼Œåˆ™ä¸è¦é‡å¯æœåŠ¡;</div><div class="line"># sudo nginx -s reload </div><div class="line"></div><div class="line">cã€å¦‚ä¸Šï¼Œåä¹‹ï¼Œåˆ™å¿…éœ€é‡å¯æœåŠ¡å™¨</div><div class="line"># sudo nginx -s restart # sudo /etc/init.d/nginx restart</div></pre></td></tr></table></figure><p>6ã€nginxç›‘æ§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">æœåŠ¡ç«¯çš„ç›‘æ§ï¼Œç›‘æ§nginx 443ç«¯å£ï¼Œ80ç«¯å£, æœ€è¿‘æœ€åä¸€æ¬¡å€¼ä¸ä¸º1æ—¶æŠ¥è­¦;</div></pre></td></tr></table></figure><p>7ã€æ‰‹å¤´å­˜ä¸€ä»½æ ‡å‡†çš„é…ç½®æ–‡ä»¶</p><p>8ã€ä¸€æ¬¡æ¯”è¾ƒå¤æ‚çš„è™šæ‹Ÿä¸»æœºé…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  jr.local.ssjinyao.com;</div><div class="line">        charset gb2312;</div><div class="line">        </div><div class="line"> access_log  /Users/zlz/wwwroot/logs/jr.access.log;</div><div class="line">        location / &#123;</div><div class="line">  root /Users/zlz/wwwroot/dedecms/a/bank;</div><div class="line">  index index.html index.htm index.php;</div><div class="line">      location ~ \.php$ &#123;</div><div class="line">               # default_type text/html;</div><div class="line">               # add_header Content-Type &apos;text/html; charset=utf-8&apos;;</div><div class="line">               # return 200 &quot;$document_root  , $fastcgi_script_name&quot;;</div><div class="line">                fastcgi_split_path_info ^(.+\.php)(.*)$;</div><div class="line">                fastcgi_param PATH_INFO $fastcgi_path_info;</div><div class="line">                fastcgi_pass   127.0.0.1:9000;</div><div class="line">                fastcgi_index  index.php;</div><div class="line">                fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</div><div class="line">                include        fastcgi_params;</div><div class="line"></div><div class="line"> &#125;</div><div class="line"></div><div class="line">      &#125;</div><div class="line"> </div><div class="line">        location /zt &#123; </div><div class="line">    alias /Users/zlz/wwwroot/dedecms/zt;</div><div class="line">    #default_type text/html;</div><div class="line">           #add_header Content-Type &apos;text/html; charset=utf-8&apos;;</div><div class="line">           #return 200 &quot;&lt;h1&gt;åæœˆåä¸ƒ&lt;/h1&gt;&quot;;</div><div class="line"> </div><div class="line">    location ~ /zt/(.*)\.php(.*)$ &#123;</div><div class="line">               #default_type text/html;</div><div class="line">               #add_header Content-Type &apos;text/html; charset=utf-8&apos;;</div><div class="line">               #return 200 &quot;$document_root  , $fastcgi_script_name&quot;;</div><div class="line">        alias /Users/zlz/wwwroot/dedecms;</div><div class="line">               fastcgi_split_path_info ^(.+\.php)(.*)$;</div><div class="line">               fastcgi_param PATH_INFO $fastcgi_path_info;</div><div class="line">               fastcgi_pass   127.0.0.1:9000;</div><div class="line">               fastcgi_index  index.php;</div><div class="line">               fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;</div><div class="line">               include        fastcgi_params;</div><div class="line">         &#125;</div><div class="line">       &#125;</div><div class="line">        </div><div class="line">  </div><div class="line"> </div><div class="line">        </div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">        location ~ /\.ht &#123;</div><div class="line">            deny  all;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"># proxy_pass http://127.0.0.1:8080/;</div><div class="line">#/Users/zlz/wwwroot/dedecms/zt;</div><div class="line">#proxy_pass http://127.0.0.1:8089/;</div></pre></td></tr></table></figure><p>è¡¥å……ä¸€ä¼ªé™æ€çš„é‡å†™ï¼Œå³ ww.ssjinyao.com/xxxx/xxxxx  é‡å†™è‡³ www.ssjinyao.com/xxxx/xxxx/</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rewrite /(.*) https://www.ssjinyao.com/$1/ permanent;</div></pre></td></tr></table></figure><p>rewrite ç›´æ¥é‡å†™ç›®å½•</p><p>rewrite 301</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rewrite ^/zhaokao/ /list/zhaokao/ permanent;</div><div class="line">rewrite ^/szrd/    /list/szrd/ permanent;</div></pre></td></tr></table></figure><p>rewrite 302 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rewrite ^/zhaokao/ /list/zhaokao/ redirect;</div><div class="line">rewrite ^/szrd/    /list/szrd/ redirect;</div></pre></td></tr></table></figure><p>nginx php-fpm å®‰å…¨é¡¹é…ç½® </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># php-fpm.conf</div><div class="line">security.limit_extensions = .php .php2 .php4 .php5 .php7 .html .htm</div><div class="line"># nginx vhosts</div><div class="line">location ~* ^/jt/.*.(php|php3|php4|php5)$ &#123;deny all;&#125;</div><div class="line"># æµ‹è¯•è®¿é—®è°ƒåº¦ </div><div class="line">location ~ \.php|\.php7|\.html|.htm$ &#123;</div><div class="line">        fastcgi_pass   127.0.0.1:9000;</div><div class="line">        fastcgi_index  index.php;</div><div class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</div><div class="line">        include        fastcgi_params;</div><div class="line">        fastcgi_read_timeout 600;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="redisæœåŠ¡é…ç½®é¡¹"><a href="#redisæœåŠ¡é…ç½®é¡¹" class="headerlink" title="redisæœåŠ¡é…ç½®é¡¹"></a>redisæœåŠ¡é…ç½®é¡¹</h2><p>1ã€redisæŒä¹…åŒ–é…ç½®</p><p>æ³¨: è‹¥ä¸éœ€è¦åˆ™å…³é—­ä»¥ä¸‹é…ç½®ï¼› </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># æŒä¹…åŒ–æ•°æ®ä¿å­˜è§„åˆ™</div><div class="line"># è‡ªå·±æ”¯å®ç°ä¸€ä¸‹</div><div class="line">#   900 ç§’å†…å¦‚æœè‡³å°‘æœ‰ 1 ä¸ª key çš„å€¼å˜åŒ–ï¼Œåˆ™ä¿å­˜</div><div class="line">#   300 ç§’å†…å¦‚æœè‡³å°‘æœ‰ 10 ä¸ª key çš„å€¼å˜åŒ–ï¼Œåˆ™ä¿å­˜</div><div class="line">#   60 ç§’å†…å¦‚æœè‡³å°‘æœ‰ 10000 ä¸ª key çš„å€¼å˜åŒ–ï¼Œåˆ™ä¿å­˜</div><div class="line">save 900 1</div><div class="line">save 300 10</div><div class="line">save 60 10000</div><div class="line"></div><div class="line"># redisæŒä¹…åŒ–ä¿å­˜æ•°æ®é…ç½®</div><div class="line">stop-writes-on-bgsave-error yes</div><div class="line"></div><div class="line"># æ•°æ®ä¿å­˜çš„ä½ç½®</div><div class="line">dir /usr/local/redis/db/</div><div class="line"></div><div class="line"># æ•°æ®åº“çš„æ–‡ä»¶åç§°,å¦å¤–è¦ç¡®å®šæ•°æ®ä¿å­˜çš„ä½ç½®redisæœ‰owneræƒé™</div><div class="line">dbfilename dump.rdb</div></pre></td></tr></table></figure><p>2ã€redisæ˜¯å¦éœ€è¦å¤–ç½‘è¿æ¥;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># ç»‘å®šçš„ip </div><div class="line"># bind 127.0.0.1</div><div class="line"># port 6379 æˆ–è€…port 25133</div><div class="line"></div><div class="line"># è‹¥éœ€è¦å¤–ç½‘è¿æ¥ï¼Œåˆ™</div><div class="line"># bind 0.0.0.0</div><div class="line"># port 6379 æˆ–è€…port 25133 </div><div class="line">æ³¨: å¦å¤–è¿˜éœ€è¦åœ¨é˜¿é‡Œäº‘ä¸Šæ·»åŠ å¯¹åº”çš„éœ€è¦è®¿é—®çš„åœ°å€ç™½åå•ä¸ç«¯å£ç™½åå•;</div></pre></td></tr></table></figure><p>3ã€ç›®å‰ä¸‰æ¡ä¸šåŠ¡çº¿ä¸Šçš„redisæ•°æ®é‡è¦æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># é…ç½®æœªå¼€æŒä¹…åŒ–ï¼Œä¿å­˜çš„æ•°æ®çš†ä¸ºä¸´æ—¶æ•°æ®ï¼Œå¯ä»¥æ¸…ç©º;</div><div class="line"># é…ç½®å·²ç»å¼€å¯æŒä¹…åŒ–ï¼Œä¿å­˜çš„æ•°æ®ä¸ºæ•°æ®ç´¢å¼•;æ•°æ®ä¸å¯ä»¥æ¸…ç©º;</div><div class="line"># é…ç½®å·²ç»å¼€å¯æŒä¹…åŒ–ï¼Œä¿å­˜çš„æ•°æ®ä¸ºç”¨æˆ·æ•°æ®;æ•°æ®ä¸å¯ä»¥æ¸…ç©º;</div><div class="line">æ³¨: ä¸è®ºæ•°æ®æ˜¯å¦ä¸ºä¸´æ—¶æ•°æ®ï¼Œæ¯æ¬¡å¯¹æœåŠ¡å™¨çš„æ“ä½œéƒ½è¦å…ˆå¯¹æ•°æ®ä¸´æ—¶ä¿å­˜ï¼Œç¡®ä¿æ“ä½œåä¸ä¼šé€ æˆæ•°æ®ä¸¢å¤±;</div><div class="line"># æ“ä½œè¿‡ç¨‹å¦‚ä¸‹</div><div class="line"># redis-cli </div><div class="line">127.0.0.1:6379&gt; AUTH Amdce0De1fxxxxx</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; CONFIG SET dir &quot;/usr/local/redis/db&quot;</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; SAVE</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt;</div></pre></td></tr></table></figure><p>4ã€æŒæ¡redisé‡å¯å‘½ä»¤ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># /etc/init.d/redis-server stop</div><div class="line"># /etc/init.d/redis-server start</div><div class="line"># /etc/init.d/redis-server restart</div><div class="line"># redis-cli -h 127.0.0.1 -p 6379 shutdown </div><div class="line"># kill -9 REDISPID</div></pre></td></tr></table></figure><p>5ã€redisç›‘æ§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">aã€ç›‘æ§æœåŠ¡redisç«¯å£ 25133 æˆ–è€… 6379</div></pre></td></tr></table></figure><p>6ã€è®°å¾—åœ¨/etc/redis/redis.confä¸­è¦é…ç½®å¯†ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># requirepass Amdce0De1fxxxxx</div></pre></td></tr></table></figure><p>7ã€æ³¨æ„ç™½åå•é…ç½®ï¼Œè®©çº¿ä¸Šçš„æœåŠ¡å™¨å¯ä»¥è®¿é—®;</p><h2 id="mongoæœåŠ¡é…ç½®é¡¹"><a href="#mongoæœåŠ¡é…ç½®é¡¹" class="headerlink" title="mongoæœåŠ¡é…ç½®é¡¹"></a>mongoæœåŠ¡é…ç½®é¡¹</h2><p>1ã€ä¿è¯æœ‰éœ€è¦å¼€æœºè‡ªå¯mongoçš„æœåŠ¡å™¨,å¼€æœºå¯åŠ¨mongo </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># åœ¨mongoçš„/etc/rc.localä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ </div><div class="line"># mongod --auth --fork -f /etc/mongod.conf </div><div class="line"># å¹¶ä¿è¯ /etc/rc.localæœ‰æ‰§è¡Œæƒé™</div></pre></td></tr></table></figure><p>2ã€ä¿è¯çº¿ä¸Šä½¿ç”¨çš„mongoæœåŠ¡å™¨éƒ½æ˜¯3.4çš„ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv # 0C49F3730359A14518585931BC711F9BA15703C6  </div><div class="line"># echo &quot;deb [ arch=amd64 ] http://repo.mongodb.org/apt/ubuntu &quot;$(lsb_release -sc)&quot;/mongodb-org/3.4 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-3.4.list&apos;  </div><div class="line"># sudo apt-get update  </div><div class="line"># sudo apt-get install mongodb-org  </div><div class="line"># sudo killall mongod</div><div class="line"># sudo echo &apos;never&apos; &gt; /sys/kernel/mm/transparent_hugepage/enabled</div><div class="line"># sudo echo &apos;never&apos; &gt; /sys/kernel/mm/transparent_hugepage/defrag</div><div class="line"># sudo service mongod restart  </div><div class="line"># sudo chkconfig mongod on</div></pre></td></tr></table></figure><p>3ã€ä¼šå¯¹ç”¨æˆ·çš„æ“ä½œ(å¢/åˆ /æ”¹/æŸ¥)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"># æ·»åŠ adminç”¨æˆ·</div><div class="line">use admin</div><div class="line">db.auth(&quot;admin&quot;,&quot;passwdxxxxxxxxxxx&quot;)</div><div class="line">use bc_ccc</div><div class="line"></div><div class="line">db.createUser(</div><div class="line"> &#123;</div><div class="line"> user:&quot;ht_eedu&quot;,</div><div class="line"> pwd:&apos;ht_eedom99xxx&apos;,</div><div class="line"> roles:[</div><div class="line"> &#123;role:&quot;dbOwner&quot;,db:&apos;ht_eedu&apos;&#125;</div><div class="line"> ]</div><div class="line"> &#125;</div><div class="line"> )</div><div class="line"> </div><div class="line"> db.createUser(</div><div class="line"> &#123;</div><div class="line"> user:&quot;admin&quot;,</div><div class="line"> pwd:&apos;passwdxxxxxxxxxxx&apos;,</div><div class="line"> roles:[</div><div class="line"> &#123;role:&quot;dbOwner&quot;,db:&apos;test&apos;&#125;</div><div class="line"> ]</div><div class="line"> &#125;</div><div class="line"> )</div><div class="line"> </div><div class="line">  </div><div class="line"> db.createUser(</div><div class="line"> &#123;</div><div class="line"> user:&quot;admin&quot;,</div><div class="line"> pwd:&apos;passwdxxxxxxxxxxx&apos;,</div><div class="line"> roles:[</div><div class="line"> &#123;role:&quot;userAdminAnyDatabase&quot;,db:&apos;admin&apos;&#125;</div><div class="line"> ]</div><div class="line"> &#125;</div><div class="line"> )</div><div class="line"></div><div class="line"> </div><div class="line"># æ·»åŠ å¯¹åº”æ•°æ®åº“çš„ç”¨æˆ· </div><div class="line">use te_data;</div><div class="line">db.createUser(</div><div class="line"> &#123;</div><div class="line"> user:&quot;admin&quot;,</div><div class="line"> pwd:&apos;passwdxxxxxxxxxxxx&apos;,</div><div class="line"> roles:[</div><div class="line"> &#123;role:&quot;dbOwner&quot;,db:&apos;test_data&apos;&#125;</div><div class="line"> ]</div><div class="line"> &#125;</div><div class="line"> )</div><div class="line"># åˆ é™¤ç”¨æˆ·</div><div class="line">db.dropUser(&quot;test_data&quot;)</div><div class="line"></div><div class="line"> db.createUser(</div><div class="line"> &#123;</div><div class="line"> user:&quot;test_data_read&quot;,</div><div class="line"> pwd:&apos;passwdxxxxxxxxxxx&apos;,</div><div class="line"> roles:[</div><div class="line"> &#123;role:&quot;read&quot;,db:&apos;test_data&apos;&#125;</div><div class="line"> ]</div><div class="line"> &#125;</div><div class="line"> )</div><div class="line"></div><div class="line"> db.createUser(</div><div class="line"> &#123;</div><div class="line"> user:&quot;test_read&quot;,</div><div class="line"> pwd:&apos;passwdxxxxxxxxxxx&apos;,</div><div class="line"> roles:[</div><div class="line"> &#123;role:&quot;read&quot;,db:&apos;test&apos;&#125;</div><div class="line"> ]</div><div class="line"> &#125;</div><div class="line"> )</div><div class="line"> </div><div class="line"># ä¿®æ”¹ç”¨æˆ·å¯†ç </div><div class="line">db.changeUserPassword(&apos;admin&apos;,&apos;passwdxxxxxxxxxxxx&apos;);</div><div class="line"></div><div class="line"># æŸ¥çœ‹ç›®å‰å­˜åœ¨çš„ç”¨æˆ·</div><div class="line">&gt; show dbs</div><div class="line">admin         0.000GB</div><div class="line">bac_data      0.000GB</div><div class="line">kk            0.000GB</div><div class="line">local         0.000GB</div><div class="line">migrate_data  0.000GB</div><div class="line">te_data       0.031GB</div><div class="line">&gt; show users</div><div class="line">&#123;</div><div class="line">&quot;_id&quot; : &quot;admin.admin&quot;,</div><div class="line">&quot;user&quot; : &quot;admin&quot;,</div><div class="line">&quot;db&quot; : &quot;admin&quot;,</div><div class="line">&quot;roles&quot; : [</div><div class="line">&#123;</div><div class="line">&quot;role&quot; : &quot;userAdminAnyDatabase&quot;,</div><div class="line">&quot;db&quot; : &quot;admin&quot;</div><div class="line">&#125;</div><div class="line">]</div><div class="line">&#125;</div><div class="line"></div><div class="line">&gt; use trisk_tmp</div><div class="line">&gt; show users;</div><div class="line">&gt; db.dropAllUsers()</div><div class="line"></div><div class="line"># åœ¨åº“ä¸­å¢æ–°å»ºè¡¨</div><div class="line">use bm_kyc</div><div class="line">db.createCollection(&quot;ep_search&quot;)</div><div class="line">db.createCollection(&quot;screening_sections&quot;)</div><div class="line"></div><div class="line"># åˆ é™¤å­—æ®µ</div><div class="line">db.screening_sections.remove(&#123;&apos;no&apos;:&apos;5a279xxxxxxxxx&apos;&#125;)</div></pre></td></tr></table></figure><p>4ã€æ•°æ®çš„å¤‡ä»½(å¯¼å…¥/å¯¼å‡º)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir /tmp/bak/mongo</div><div class="line">mongodump --db test_kyc --out /tmp/bak/mongo/`date +&quot;%m-%d-%y&quot;`</div><div class="line">cd /tmp/bak/mongo &amp;&amp; tar -cvf xxxx-xx-xx.tar.gz xxxx-xx-xx</div><div class="line">scp /tmp/bak/mongo/xxxx-xx-xx.tar.gz root@xx.xxx.xx.xxx:/tmp/</div><div class="line">crontab -e</div><div class="line">3 1 * * * find /tmp/bak/mongo -mtime +7 -exec rm -rf &#123;&#125; \;</div><div class="line">mongorestore -u admin -p xxxx --db newdb --drop /tmp/bak/mongo  æ³¨: --drop è¦å°å¿ƒä½¿ç”¨</div></pre></td></tr></table></figure><p>5ã€phpæ¨¡å—ç¼–è¯‘å®‰è£…3.4çš„æ”¯æŒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">aã€mac å®‰è£…php mongoæ¨¡å—çš„æ”¯æŒ</div><div class="line"># brew install mongo</div><div class="line"># brew install mongodb</div><div class="line"># cd /Library/WebServer/Documents</div><div class="line"># brew install php56-mongo</div><div class="line"># ä»¥ä¸‹ä¸ºæµ‹è¯•è¿æ¥æ–‡ä»¶ </div><div class="line">âœ cat index.php </div><div class="line">&lt;?php</div><div class="line">    $m = new MongoClient(&apos;mongodb://admin:passwdxxxxxxxxxxx@47.92.xxx.xxxx:20911/bc_ccc&apos;);</div><div class="line">    echo &quot;Connection to database successfully&quot;;  </div><div class="line">    // é€‰æ‹©ä¸€ä¸ªæ•°æ®åº“  </div><div class="line">  $db = $m-&gt;bm_kyc;  </div><div class="line">   echo &quot;Database mydb selected&quot;;  </div><div class="line">?&gt;</div><div class="line"></div><div class="line">âœ  cat test2.php </div><div class="line">&lt;?php </div><div class="line">phpinfo();</div><div class="line">?&gt;</div><div class="line"># sudo vim /etc/php.ini</div><div class="line">    extension=/usr/local/opt/php56-mongodb/mongodb.so</div><div class="line">    extension=/usr/local/opt/php56-mongo/mongo.so</div><div class="line">    </div><div class="line">bã€ubuntu å®‰è£… php mongoæ¨¡å—çš„æ”¯æŒ</div><div class="line"></div><div class="line">#  cd root &amp;&amp; wget https://github.com/mongodb/mongo-php-driver-legacy/archive/master.zip</div><div class="line">#  cd root &amp;&amp; unzip master.zip </div><div class="line">#  cd /root/mongo-php-driver-legacy-master/</div><div class="line">#  phpize</div><div class="line">#  ./configure </div><div class="line">#  make</div><div class="line">#  make install</div><div class="line">#  ls /usr/lib/php5/20121212/mongo.so </div><div class="line"># vim /etc/php5/apache2/php.ini</div><div class="line">extension = /usr/lib/php5/20121212/mongo.so</div><div class="line">#  apachectl restart</div><div class="line">æµ‹è¯•</div><div class="line"></div><div class="line">âœ cat index.php </div><div class="line">&lt;?php</div><div class="line">    $m = new MongoClient(&apos;mongodb://admin:passwdxxxxxxxxxxx@47.92.162.27:20911/bc_ccc&apos;);</div><div class="line">    echo &quot;Connection to database successfully&quot;;  </div><div class="line">    // é€‰æ‹©ä¸€ä¸ªæ•°æ®åº“  </div><div class="line">  $db = $m-&gt;bc_ccc;  </div><div class="line">   echo &quot;Database mydb selected&quot;;  </div><div class="line">?&gt;  </div><div class="line"></div><div class="line">âœ  cat test2.php </div><div class="line">&lt;?php </div><div class="line">phpinfo();</div><div class="line">?&gt;</div><div class="line"></div><div class="line"># è®¿é—®test2.phpå¯ä»¥è¿‡æ»¤åˆ°ä»¥ä¸‹å†…å®¹</div><div class="line">MONGODB-CR  enabled</div><div class="line">SCRAM-SHA-1 enabled</div><div class="line">MONGODB-X509    enabled</div><div class="line">GSSAPI (Kerberos)   disabled</div><div class="line">PLAIN   disabled</div></pre></td></tr></table></figure><p>6ã€æ³¨æ„ç™½åå•é…ç½®ï¼Œè®©çº¿ä¸Šçš„æœåŠ¡å™¨å¯ä»¥è®¿é—®;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">net:</div><div class="line">  port =20133   # é…ç½®mongoç›‘å¬åœ°å€</div><div class="line">  bind_ip =0.0.0.0  # é…ç½®ç»‘å®šçš„IP</div></pre></td></tr></table></figure><p>7ã€ æ³¨æ„é…ç½®æ–‡ä»¶ä¸­å¼€å¯authè®¤è¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">auth =true</div></pre></td></tr></table></figure><p>8ã€ä»£ç ä¸­ä¸æ”¯æŒå¸¦æœ‰@çš„å¯†ç </p><h2 id="mysqlæœåŠ¡é…ç½®é¡¹"><a href="#mysqlæœåŠ¡é…ç½®é¡¹" class="headerlink" title="mysqlæœåŠ¡é…ç½®é¡¹"></a>mysqlæœåŠ¡é…ç½®é¡¹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># æ³¨æ„æ¸…ç©ºè¿æ¥mysqlçš„ä½¿ç”¨è®°å½•</div><div class="line"># æ³¨æ„æ•°æ®åº“çš„å¤‡ä»½æ–‡ä»¶æ‰€åœ¨çš„æœåŠ¡å™¨åªèƒ½ä»¥å¯†é’¥ç™»å½•</div><div class="line"># æ³¨æ„RDSçš„ä½¿ç”¨ç‡</div></pre></td></tr></table></figure><h2 id="apacheæœåŠ¡é…ç½®é¡¹"><a href="#apacheæœåŠ¡é…ç½®é¡¹" class="headerlink" title="apacheæœåŠ¡é…ç½®é¡¹"></a>apacheæœåŠ¡é…ç½®é¡¹</h2><p>1ã€apacheå…¨å±€é…ç½®é¡¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">Mutex file:$&#123;APACHE_LOCK_DIR&#125; default</div><div class="line">PidFile $&#123;APACHE_PID_FILE&#125;</div><div class="line">Timeout 300</div><div class="line">KeepAlive On</div><div class="line">MaxKeepAliveRequests 100</div><div class="line">KeepAliveTimeout 5</div><div class="line">User $&#123;APACHE_RUN_USER&#125;</div><div class="line">Group $&#123;APACHE_RUN_GROUP&#125;</div><div class="line"></div><div class="line"># ä½¿å¾—ä¸»æœºåèƒ½è¢«è®°å…¥æ—¥å¿—</div><div class="line">HostnameLookups Off</div><div class="line"></div><div class="line"></div><div class="line">ErrorLog $&#123;APACHE_LOG_DIR&#125;/error.log</div><div class="line"></div><div class="line"># å®šä¹‰apacheè®°å½•æ—¥å¿—çš„çº§åˆ«ä¸ºwarn</div><div class="line">LogLevel warn</div><div class="line"></div><div class="line">#åŠ è½½æ¨¡å—é…ç½®æ–‡ä»¶ï¼Œè™šæ‹Ÿä¸»æœºé…ç½®æ–‡ä»¶ï¼Œä¸ç«¯é…ç½®æ–‡ä»¶</div><div class="line">IncludeOptional mods-enabled/*.load</div><div class="line">IncludeOptional mods-enabled/*.conf</div><div class="line">Include ports.conf</div><div class="line"></div><div class="line"># å®šä¹‰ä¸å…è®¸è®¿é—®ç«™ç‚¹æ ¹ç›®å½•ç´¢å¼•</div><div class="line">&lt;Directory /&gt;</div><div class="line">Options FollowSymLinks</div><div class="line">AllowOverride None</div><div class="line">Require all denied</div><div class="line">&lt;/Directory&gt;</div><div class="line">&lt;Directory /usr/share&gt;</div><div class="line">AllowOverride None</div><div class="line">Require all granted</div><div class="line">&lt;/Directory&gt;</div><div class="line"></div><div class="line"># å…è®¸åœ¨/var/www/ä¸­å»ºç«‹url</div><div class="line">&lt;Directory /var/www/&gt;</div><div class="line">AllowOverride All</div><div class="line">Require all granted</div><div class="line">&lt;/Directory&gt;</div><div class="line"></div><div class="line"># å®šä¹‰å…è®¸è®¿é—®çš„ç”¨æˆ·ï¼Œ .htaccesså®šä¹‰äº†ç”¨æˆ·å</div><div class="line">AccessFileName .htaccess</div><div class="line"></div><div class="line"># æ‹’ç»æ‰€ä»¥ ä»»æ„ä»¥.htåç¼€ç»“å°¾çš„æ–‡ä»¶ </div><div class="line">&lt;FilesMatch &quot;^\.ht&quot;&gt;</div><div class="line">Require all denied</div><div class="line">&lt;/FilesMatch&gt;</div><div class="line"></div><div class="line"># å®šä¹‰ vhost_combined combined comman refererçš„å››ç§æ—¥å¿—æ ¼å¼,ä¾›è™šæ‹Ÿä¸»æœºè°ƒç”¨</div><div class="line">LogFormat &quot;%v:%p %h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; vhost_combined</div><div class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; combined</div><div class="line">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %O&quot; common</div><div class="line">LogFormat &quot;%&#123;Referer&#125;i -&gt; %U&quot; referer</div><div class="line">LogFormat &quot;%&#123;User-agent&#125;i&quot; agent</div><div class="line">IncludeOptional conf-enabled/*.conf</div><div class="line">IncludeOptional sites-enabled/*.conf</div></pre></td></tr></table></figure><p>2ã€apacheè™šæ‹Ÿä¸»æœºé…ç½®é¡¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># æŒ‡å®š VirtualHost ä»¥ç«¯å£è¿›è¡Œå®šä¹‰</div><div class="line"></div><div class="line">&lt;VirtualHost *:8001&gt;</div><div class="line"></div><div class="line"># æŒ‡å®šVirtualHoståŸŸå</div><div class="line">ServerAdmin www.ssjinyao.com.com</div><div class="line"></div><div class="line"># æŒ‡å®šè™šæ‹Ÿä¸»æœºurlæ ¹è·¯å¾„</div><div class="line">DocumentRoot /var/www/html/tweb</div><div class="line"></div><div class="line"># æŒ‡å®šè®¿é—®é”™è¯¯æ—¥å¿—ä¿è·¯å¾„</div><div class="line">ErrorLog $&#123;APACHE_LOG_DIR&#125;/error.log</div><div class="line"></div><div class="line"># æŒ‡å®šè®¿é—®æ—¥å¿—ä¿å­˜è·¯å¾„</div><div class="line">CustomLog $&#123;APACHE_LOG_DIR&#125;/access.log combined</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure><p>3ã€åŒnginxä¸€æ ·ï¼Œåšå®Œå˜æ›´ä¹‹åéœ€è¦å…ˆæµ‹è¯•è¯­æ³•å†é‡è¯»ï¼Œæˆ–é‡èµ·</p><p>4ã€ç«¯å£é…ç½®æ–‡ä»¶ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># å°†è™šæ‹Ÿä¸»æœºä¸­æ‰€ç”¨åˆ°çš„å¯¹åº”ç«¯å£å¯åŠ¨; </div><div class="line"># Listen 80</div><div class="line">Listen 8001</div><div class="line">Listen 8002</div><div class="line">Listen 8003</div><div class="line">Listen 8004</div><div class="line">Listen 8101</div></pre></td></tr></table></figure><h2 id="supvisord-æœåŠ¡é…ç½®é¡¹"><a href="#supvisord-æœåŠ¡é…ç½®é¡¹" class="headerlink" title="supvisord æœåŠ¡é…ç½®é¡¹"></a>supvisord æœåŠ¡é…ç½®é¡¹</h2><p>1ã€æ›´æ¢æœåŠ¡å™¨ä¹‹åï¼Œéœ€è¦ä¿®æ”¹æœåŠ¡å™¨çš„ç›‘å¬åœ°å€ï¼›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># éƒ¨ç½²ç›‘å¬ç«¯å£çš„é—®é¢˜</div><div class="line">[inet_http_server]         ; inet (TCP) server disabled by default</div><div class="line">port=172.17.xxx.xxx:7558        ; (ip_address:port specifier, *:port for all iface)</div></pre></td></tr></table></figure><p>2ã€éƒ¨ç½²pythonç³»ç»Ÿæ—¶æŠ¥ä¾èµ–é—®é¢˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd /home/admin/xbasement/</div><div class="line">source ./ENV/bin/activate</div><div class="line">pip install -r requirements.txt </div><div class="line">å¦‚æœå®‰è£…è½¯ä»¶åŒ…å­˜åœ¨é—®é¢˜ï¼ŒæŠŠå¯¹åº”çš„è½¯ä»¶åŒ…ç»™åˆ é™¤;</div></pre></td></tr></table></figure><p>3ã€æŸ¥çœ‹å¯¹åº”æœåŠ¡å™¨å¯åŠ¨æ—¶çš„æŠ¥é”™ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">admin@iZ2zegjb9m90kxovynpkbzZ:~$ tail -f ~/xbasement/log/xbasement-server-stdout.log </div><div class="line">  File &quot;server.py&quot;, line 3, in &lt;module&gt;</div><div class="line">    from tornado.wsgi import WSGIContainer</div><div class="line">ImportError: No module named tornado.wsgiTraceback (most recent call last):</div><div class="line">  File &quot;server.py&quot;, line 3, in &lt;module&gt;</div><div class="line">    from tornado.wsgi import WSGIContainer</div><div class="line">ImportError: No module named tornado.wsgi</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;server.py&quot;, line 3, in &lt;module&gt;</div><div class="line">    from tornado.wsgi import WSGIContainer</div><div class="line">ImportError: No module named tornado.wsgi</div></pre></td></tr></table></figure><p>4ã€pythonéƒ¨ç½²æ—¶ç¼ºå°‘æ¨¡å—çš„é—®é¢˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"># é—®é¢˜å¦‚ä¸‹</div><div class="line">supervisor&gt; status</div><div class="line">customer:customer-0              RUNNING   pid 7981, uptime 0:00:19</div><div class="line">customer:job-recieve-0           RUNNING   pid 7980, uptime 0:00:19</div><div class="line">order:api-0                      FATAL     Exited too quickly (process log may have details)</div><div class="line">order:forward-job-0              FATAL     Exited too quickly (process log may have details)</div><div class="line">order:order-job-payment-0        FATAL     Exited too quickly (process log may have details)</div><div class="line">order:order-risk-job-0           FATAL     Exited too quickly (process log may have details)</div><div class="line">supervisor&gt; staus</div><div class="line">*** Unknown syntax: staus</div><div class="line">supervisor&gt; </div><div class="line">admin@ssjinyao.com-007:~/torder/venv/lib/python2.7/site-packages$ !tail</div><div class="line">tail -f torder/log/order-api-out.log </div><div class="line">    from api import app</div><div class="line">ImportError: No module named api</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;api/server.py&quot;, line 10, in &lt;module&gt;</div><div class="line">    from api import app</div><div class="line">ImportError: No module named api</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;api/server.py&quot;, line 10, in &lt;module&gt;</div><div class="line">    from api import app</div><div class="line">ImportError: No module named api</div><div class="line"># è§£å†³æ–¹å¼ </div><div class="line">admin@ssjinyao.com-007:~/torder/venv/lib/python2.7/site-packages$ cat v.pth </div><div class="line">/home/admin/torder</div><div class="line">admin@ssjinyao.com-007:~/torder/venv/lib/python2.7/site-packages$ pwd</div><div class="line">/home/admin/torder/venv/lib/python2.7/site-packages</div><div class="line">admin@ssjinyao.com-007:~/torder/venv/lib/python2.7/site-packages$ history | grep ln </div><div class="line">ln -s /home/admin/torder/ .</div></pre></td></tr></table></figure><p>5ã€åŠ å…¥æ–°å·¥ç¨‹æ—¶ï¼Œè¦å¤åˆ¶ç¼–è¾‘~/opt/supervisord.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[include]</div><div class="line">files = /home/admin/xbasement/config/supervisor/xbasement.server.ini /home/admin/topen/config/supervisor/*.ini /home/admin/cashier/config/supervisor/*.ini</div></pre></td></tr></table></figure><p>6ã€éƒ¨ç½²open å·¥ç¨‹æ—¶ï¼Œè¦æŠŠsslä¹Ÿå¤åˆ¶ä¸Š<br>7ã€åº”ç”¨å˜åŠ¨æ—¶ï¼Œè¦æ³¨æ„mongo,redisç™½åå•</p><h2 id="zabbix-é…ç½®"><a href="#zabbix-é…ç½®" class="headerlink" title="zabbix é…ç½®"></a>zabbix é…ç½®</h2><p>1ã€zabbix_agent é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"># è¿›ç¨‹çš„pidä¿å­˜çš„é…ç½®</div><div class="line">PidFile=/tmp/zabbix_agentd.pid</div><div class="line"></div><div class="line"># zabbix_agent ç«¯æ—¥å¿—ä¿å­˜ä½ç½® </div><div class="line">LogFile=/var/log/zabbix-agent/zabbix_agentd.log</div><div class="line"></div><div class="line"># æ—¥å¿—æ–‡ä»¶å­˜å‚¨å¤§å° </div><div class="line">LogFileSize=33</div><div class="line"></div><div class="line"># æ—¥å¿—çº§åˆ«</div><div class="line">DebugLevel=4</div><div class="line"></div><div class="line"># æ³¨:è¿™ä¸ªæ˜¯é‡ç‚¹ï¼Œéœ€è¦æŒ‡å®šzabbix_serverç«¯çš„ip zabbix_serverç«¯æ‰èƒ½å®åˆ«</div><div class="line">Server=121.xxx.xx.xxx</div><div class="line"></div><div class="line"># ç›‘å¬çš„ç«¯å£</div><div class="line">ListenPort=10050</div><div class="line"></div><div class="line"># zabbix_agent ç«¯è¿›ç¨‹ç›‘å¬çš„åœ°å€ </div><div class="line">ListenIP=0.0.0.0</div><div class="line"></div><div class="line"># zabbix_agent ä¸»åŠ¨è¯·æ±‚æœåŠ¡ç«¯æ—¶çš„åœ°å€ ä¸ Serveré…åˆä½¿ç”¨</div><div class="line">ServerActive=121.xxx.xx.xxx</div><div class="line">Hostname=te_server</div></pre></td></tr></table></figure><p>2ã€ zabbix_server ç«¯é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"># æŒ‡å®šzabbix_server ç«¯ç›‘å¬çš„åœ°å€</div><div class="line">ListenPort=10051</div><div class="line"></div><div class="line"># æŒ‡å®šzabbix_server äº§ç”Ÿçš„æ—¥å¿—æ‰€ä¿å­˜çš„æ–‡ä»¶ä½ç½® </div><div class="line">LogFile=/var/log/zabbixsrv/zabbix_server.log</div><div class="line"></div><div class="line"># æŒ‡å®šæ—¥å¿—çš„å¤§å°</div><div class="line">LogFileSize=0</div><div class="line"></div><div class="line"># æŒ‡å®šzabbix_server PidFileæ‰€ä¿å­˜çš„ä½ç½®</div><div class="line">PidFile=/var/run/zabbixsrv/zabbix_server.pid</div><div class="line"></div><div class="line"># æŒ‡å®šzabbix è°ƒç”¨çš„æ•°æ®åº“åº“å</div><div class="line">DBName=zabbix</div><div class="line"></div><div class="line"># æŒ‡å®šzabbix è°ƒç”¨çš„æ•°æ®åº“çš„ç”¨æˆ·å </div><div class="line">DBUser=zabbix</div><div class="line"></div><div class="line"># æŒ‡å®šzabbix ä½¿ç”¨çš„æ•°æ®åº“å¯†ç </div><div class="line">DBPassword=centos.xxxxxxxx</div><div class="line"></div><div class="line"># æŒ‡å®šmysqlçš„sockæ–‡ä»¶</div><div class="line">DBSocket=/var/lib/mysql/mysql.sock</div><div class="line"></div><div class="line"># æŒ‡å®šmysqlæ‰€ç›‘å¬çš„ç«¯å£ï¼Œæ³¨ï¼Œzabbix_serveræ‰€å ç”¨çš„æ•°æ®åº“ä¸å¤§ï¼Œä¸”åªéœ€è¦ç›‘å¬æœ¬åœ°</div><div class="line">DBPort=3306</div><div class="line"></div><div class="line"># æŒ‡å®šzabbix_server æ‰€ç›‘å¬çš„åœ°å€</div><div class="line">ListenIP=0.0.0.0</div><div class="line"></div><div class="line"># æŒ‡å®šä¾›zabbixè°ƒç”¨çš„è„šæœ¬ç¨‹åº(bash || python || perl),ç›®å‰ä½¿ç”¨çš„æ˜¯bash</div><div class="line">AlertScriptsPath=/var/lib/zabbixsrv/alertscripts</div><div class="line"></div><div class="line"># è‡ªå®šä¹‰ç›‘æ§é¡¹æ—¶çš„ä¿å­˜ä½ç½® </div><div class="line">ExternalScripts=/var/lib/zabbixsrv/externalscripts</div><div class="line"></div><div class="line"># æŒ‡å®šä¸´æ—¶çš„è„šæœ¬ç¨‹åº </div><div class="line">TmpDir=/var/lib/zabbixsrv/tmp</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># è°ƒç”¨æ¥å£ç¨‹åº</div><div class="line"></div><div class="line">#!/bin/bash</div><div class="line">#export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin</div><div class="line">echo &quot;$2</div><div class="line">$3&quot; | /usr/bin/mutt -s &quot;ZABBIX æŠ¥è­¦&quot; $1</div><div class="line"></div><div class="line">zabbix.sh </div><div class="line"></div><div class="line">#!/bin/bash</div><div class="line">#Can send weixin mail </div><div class="line">export path=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin</div><div class="line">#/bin/weixin --corpid=ww3bba6a2898b91e69 --corpsecret=3GqhGNZeEYuVvr9SRSyBWCOsbGvNcc6LXAn0uCO24XM --msg=&quot;$2         $3&quot; --user=&quot;$1&quot; --agentid=1000002</div><div class="line">/bin/weixin --corpid=wwfc47b4739f369c7c --corpsecret=hD0ITPFehD8WJm-3ydJVxWamXQYs2l64xPCx9K76doM --msg=&quot;$2</div><div class="line">$3&quot; --user=$1 --agentid=1000003</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># å®‰è£…å‘é€é‚®ä»¶æŠ¥è­¦ç¨‹åºçš„ä¾èµ–</div><div class="line"># yum -y install msmtp mutt</div><div class="line"></div><div class="line"># é‚®ä»¶å‘æ˜¯ç”±ç³»ç»Ÿç”¨æˆ·zabbixsrvè°ƒç”¨ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶è¦åœ¨å…¬å…±é…ç½®ç›®å½•/etc/ä¸­é…ç½®</div><div class="line"># ä¸å¯ä»¥åœ¨ admin/root æˆ–è€…å…¶å®ƒç”¨æˆ·ä¸‹é…ç½®</div><div class="line"># muttrc  é…ç½®é¡¹</div><div class="line">/etc/muttrc </div><div class="line">set sendmail=&quot;/usr/bin/msmtp&quot;</div><div class="line">set use_from=yes</div><div class="line">set realname=&quot;15822097176@139.com&quot;</div><div class="line">set editor=&quot;vim&quot;</div><div class="line"></div><div class="line"># msmtprc é…ç½®é¡¹</div><div class="line">/etc/msmtprc </div><div class="line">account default</div><div class="line">host smtp.ssjinyao.com</div><div class="line">port 25</div><div class="line">from dev@ssjinyao.com</div><div class="line">auth login</div><div class="line">tls off</div><div class="line">user dev@ssjinyao.com</div><div class="line">password xxxxxxxxxx</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">éœ€æ±‚, ä»£ç è¦ä¸€æ¡æ¡çš„å†™ </div><div class="line">è®¾è®¡, å…ˆå®ç°å†è®¾è®¡ä¼˜åŒ–</div></pre></td></tr></table></figure><h2 id="çº¿ä¸ŠsshæœåŠ¡é…ç½®é¡¹"><a href="#çº¿ä¸ŠsshæœåŠ¡é…ç½®é¡¹" class="headerlink" title="çº¿ä¸ŠsshæœåŠ¡é…ç½®é¡¹"></a>çº¿ä¸ŠsshæœåŠ¡é…ç½®é¡¹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"># æŒ‡å®šsshé»˜è®¤ç›‘å¬çš„åœ°å€</div><div class="line">Port 22</div><div class="line"></div><div class="line"># æŒ‡å®šsshä½¿ç”¨çš„åè®®</div><div class="line">Protocol 2</div><div class="line"></div><div class="line"># æŒ‡å®šå½“å‰æœåŠ¡å™¨ä½¿ç”¨çš„ç§é’¥</div><div class="line">HostKey /etc/ssh/ssh_host_rsa_key</div><div class="line">HostKey /etc/ssh/ssh_host_dsa_key</div><div class="line">HostKey /etc/ssh/ssh_host_ecdsa_key</div><div class="line">HostKey /etc/ssh/ssh_host_ed25519_key</div><div class="line"></div><div class="line"># æ˜¯å¦è®©sshdé€šè¿‡åˆ›å»ºéç‰¹æƒå­è¿›ç¨‹å¤„ç†æ¥å…¥è¯·æ±‚çš„æ–¹æ³•æ¥è¿›è¡Œæƒé™åˆ†ç¦»ã€‚é»˜è®¤å€¼æ˜¯&quot;yes&quot;ã€‚è®¤è¯æˆåŠŸåï¼Œå°†ä»¥è¯¥è®¤è¯ç”¨æˆ·çš„èº«ä»½åˆ›å»ºå¦ä¸€ä¸ªå­è¿›ç¨‹ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢é€šè¿‡æœ‰ç¼ºé™·çš„å­è¿›ç¨‹æå‡æƒé™ï¼Œä»è€Œä½¿ç³»ç»Ÿæ›´åŠ å®‰å…¨</div><div class="line">UsePrivilegeSeparation yes</div><div class="line"></div><div class="line"># è®¾ç½®åœ¨å¤šå°‘ç§’ä¹‹åè‡ªåŠ¨é‡æ–°ç”ŸæˆæœåŠ¡å™¨çš„å¯†åŒ™ï¼ˆå¦‚æœä½¿ç”¨å¯†åŒ™ï¼‰ã€‚é‡æ–°ç”Ÿæˆå¯†åŒ™æ˜¯ä¸ºäº†é˜²æ­¢ç”¨ç›—ç”¨çš„å¯†åŒ™è§£å¯†è¢«æˆªè·çš„ä¿¡æ¯ã€‚</div><div class="line">KeyRegenerationInterval 3600</div><div class="line"></div><div class="line"># Server Key çš„åŠ å¯†ç å¼ºåº¦ï¼Œå¼ºåº¦è¶Šå¤§è¶Šå®‰å…¨ï¼Œä¼ è¾“é€Ÿç‡ä¹Ÿè¶Šæ…¢</div><div class="line">ServerKeyBits 1024</div><div class="line"></div><div class="line"># sshd è®°å½•æ—¥å¿—çš„çº§åˆ« </div><div class="line">LogLevel INFO</div><div class="line"></div><div class="line"># ç”¨æˆ·ç™»å½•æ—¶å¯è§†ç•Œé¢åŠæ—¶é—´</div><div class="line">LoginGraceTime 120</div><div class="line"></div><div class="line"># å½“ä½¿ç”¨è€…çš„ host key æ”¹å˜ä¹‹åï¼ŒServer å°±ä¸æ¥å—è”æœºï¼Œ</div><div class="line">StrictModes yes</div><div class="line"></div><div class="line"># ä½¿ç”¨çº¯rsaè®¤è¯æ–¹å¼</div><div class="line">RSAAuthentication yes</div><div class="line"></div><div class="line"># æ˜¯å¦å…è®¸pubkeyè®¤è¯</div><div class="line">PubkeyAuthentication yes</div><div class="line"></div><div class="line"># æ˜¯å¦å–æ¶ˆä½¿ç”¨ ~/.ssh/.hosts æ¥åšä¸ºè®¤è¯</div><div class="line">IgnoreRhosts yes</div><div class="line"></div><div class="line"># è¿™ä¸ªé€‰é¡¹æ˜¯ä¸“é—¨ç»™ version 1 ç”¨çš„</div><div class="line">RhostsRSAAuthentication no</div><div class="line"></div><div class="line"># è¿™ä¸ªé¡¹ç›®ä¸ä¸Šé¢çš„é¡¹ç›®ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯ç»™ version 2 ä½¿ç”¨çš„</div><div class="line">HostbasedAuthentication no</div><div class="line"></div><div class="line">#è¿™ä¸ªé¡¹ç›®åœ¨æ˜¯å¦å…è®¸ä»¥ç©ºçš„å¯†ç ç™»å…¥ï¼# æ­¤é¡¹è¦æ³¨æ„</div><div class="line">PermitEmptyPasswords no</div><div class="line"></div><div class="line"># æŒ‘æˆ˜ä»»ä½•çš„å¯†ç è®¤è¯, ä»»ä½• login.conféƒ½èƒ½ä½¿ç”¨ </div><div class="line">ChallengeResponseAuthentication no</div><div class="line"></div><div class="line"># x11è½¬å‘åŠŸèƒ½å¼€å¯ï¼Œå¯ä»¥ä½¿ç”¨åŸºäºsshçš„åŠ å¯†ç å›¾å½¢å·¥å…·</div><div class="line">X11Forwarding yes</div><div class="line"></div><div class="line"># è‡ªé€‚å¤§å°</div><div class="line">X11DisplayOffset 10</div><div class="line"></div><div class="line"># æ‰“å°Motdä¿¡æ¯</div><div class="line">PrintMotd no</div><div class="line"></div><div class="line"># ç™»å½•å‰åè¾“å‡ºæ—¥å¿—</div><div class="line">PrintLastLog yes</div><div class="line"></div><div class="line"># å¼€å¯tcpé•¿è¿æ¥</div><div class="line">TCPKeepAlive yes</div><div class="line"></div><div class="line"># è®¾ç½®x11çš„è½¬è¾“è¯­è¨€åŠç¼–ç </div><div class="line">AcceptEnv LANG LC_*</div><div class="line"></div><div class="line"># åŸºäºssh çš„vftpæœåŠ¡</div><div class="line">Subsystem sftp /usr/lib/openssh/sftp-server</div><div class="line"></div><div class="line">#åˆ©ç”¨ PAM ç®¡ç†ä½¿ç”¨è€…è®¤è¯</div><div class="line">UsePAM yes</div><div class="line"></div><div class="line">#ä½¿ç”¨dnsè§£æ </div><div class="line">UseDNS no</div><div class="line"></div><div class="line">#</div><div class="line">AddressFamily inet</div><div class="line"></div><div class="line"># å…è®¸rootç”¨æˆ·ç›´æ¥ç™»å½• </div><div class="line">PermitRootLogin yes</div><div class="line"></div><div class="line"># è®°å½•ç³»ç»Ÿæ—¥å¿—</div><div class="line">SyslogFacility AUTHPRIV</div><div class="line"></div><div class="line"># å¼€å¯ç”¨æˆ·è®¤è¯ç™»å½•</div><div class="line">PasswordAuthentication yes</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kubernetesç¬”è®°</title>
      <link href="/2018/10/04/kubernetes%20%E7%AC%94%E8%AE%B0%E4%B8%80/"/>
      <url>/2018/10/04/kubernetes%20%E7%AC%94%E8%AE%B0%E4%B8%80/</url>
      <content type="html"><![CDATA[<h1 id="kubernetes-ç¬”è®°"><a href="#kubernetes-ç¬”è®°" class="headerlink" title="kubernetes ç¬”è®°"></a>kubernetes ç¬”è®°</h1><p><img src="/images/kubernetes.png" alt=""><br>CI: æŒç»­é›†æˆ<br>CD: æŒç»­äº¤ä»˜ï¼ŒDelivery<br>CD: æŒç»­éƒ¨ç½²ï¼ŒDeployment</p><p><a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="external">kubernetesçš„releasesç‰ˆæœ¬</a></p><p>kubernetes  è‡ªåŠ¨è£…ç®±ã€è‡ªæˆ‘ä¿®å¤ã€è‡ªåŠ¨å®ç°æ°´å¹³æ‰©å±•<br>è‡ªåŠ¨å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œè‡ªåŠ¨å‘å¸ƒå’Œå›æ»š<br>å¯†é’¥å’Œé…ç½®é›†ä¸­åŒ–ç®¡ç†ã€å­˜å‚¨ç¼–æ’(åŠ¨æ€ä¾›ç»™)<br>ä»»åŠ¡æ‰¹å¤„ç†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">master/node </div><div class="line">    master: API Sserver,Scheduler, Controller-Manager</div><div class="line">    node: kubelet, docker(å®¹å™¨å¼•æ“), kube-proxy</div><div class="line">Podï¼Œ Label, Label Selector </div><div class="line">    Label: key=value</div><div class="line">    Label: Selector:</div><div class="line">Pod:</div><div class="line">    è‡ªä¸»å¼Pod</div><div class="line">    æ§åˆ¶å™¨ç®¡ç†çš„Pod</div><div class="line">    ReplicationController</div><div class="line">    ReplicaSet</div><div class="line">    Deployment</div><div class="line">    StateFulSet(æœ‰çŠ¶æ€å‰¯æœ¬é›†)</div><div class="line">    DaemonSet</div><div class="line">    Job,Ctonjob</div><div class="line">    AddOns: é™„åŠ ç»„ä»¶</div><div class="line">HPA</div><div class="line">    HorizontalPodAutoscaler</div></pre></td></tr></table></figure><p>Master èŠ‚ç‚¹: æ•´ä¸ªk8sé›†ç¾¤çš„å¸ä»¤éƒ¨<br>æ ¸å¿ƒç»„ä»¶: api_server è´Ÿè´£æ¥æ”¶å¹¶å¤„ç†è¯·æ±‚<br>         schechuler è°ƒåº¦å®¹å™¨çš„åˆ›å»ºè¯·æ±‚<br>         æ§åˆ¶å™¨ç®¡ç†å™¨: ç¡®ä¿æ§åˆ¶å™¨æ˜¯å¥åº·çŠ¶æ€çš„<br>k8s å¹¶ä¸ç›´æ¥è°ƒåº¦å®¹å™¨ï¼Œè€Œè°ƒåº¦çš„æ˜¯podã€‚podå¯¹å®¹å™¨åšä¸ºå°è£…;</p><p>æœåŠ¡çš„è‡ªåŠ¨å‘ç°åŠŸèƒ½ï¼Œå°±æ˜¯æŠŠè‡ªå·±ä¿¡æ¯æ³¨å†Œä¸Šå»;<br>NMT: ä¸€èˆ¬å¼€æ”¾ç»™å¤–éƒ¨è®¿é—®çš„åªæœ‰Nï¼Œè€ŒN åœ¨é›†ç¾¤å†…å…¶å®æ˜¯ä¹Ÿæ˜¯å®¢æˆ·ç«¯;<br>åœ¨ä¸€ä¸ªå¤§çš„é›†ç¾¤ä¸­ï¼ŒåªæŠŠæœ‰ç‰¹æ®Šéœ€æ±‚çš„ï¼Œå¼€æ”¾ç»™å®¢æˆ·ç«¯;<br>LBaaS: è´Ÿè½½å‡è¡¡åŠæœåŠ¡;</p><p>å¤šç§é€šä¿¡<br>åŒä¸€ä¸ªPodå†…çš„å¤šä¸ªå®¹å™¨é—´é€šä¿¡:lo<br>å„Podä¹‹é—´çš„é€šä¿¡ Overlay Network,å åŠ ç½‘ç»œé€šä¿¡(äºŒå±‚å åŠ ï¼Œä¸‰å±‚å åŠ )<br>Podä¸Serviceä¹‹é—´çš„é€šä¿¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CNIæ’ä»¶ä½“ç³»:å®¹å™¨ç½‘ç»œæ¥å£</div><div class="line">    flannel: ç½‘ç»œé…ç½®</div><div class="line">    calico: ç½‘ç»œé…ç½®ï¼Œç½‘ç»œç­–ç•¥</div><div class="line">    canel: ç½‘ç»œé…ç½®ï¼Œç½‘ç»œç­–ç•¥</div></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯â€“&gt; API server<br>    user: username, uid<br>    group:<br>    extra:</p><p><img src="/images/kubernetes-network.png" alt=""></p><p>ç¯å¢ƒ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">master: etcd: 10.180.66.11</div><div class="line">node1: 10.180.66.12</div><div class="line">node2: 10.180.66.13</div><div class="line">æ³¨æ„è¿™ä¸‰å°æœåŠ¡å™¨éœ€è¦æ—¶é—´åŒæ­¥</div></pre></td></tr></table></figure><p>å‰æ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1ã€åŸºäºä¸»æœºåé€šä¿¡: /etc/hosts;</div><div class="line">2ã€æ—¶é—´åŒæ­¥;</div><div class="line">3ã€å…³é—­firewalldå’Œiptables.service;</div><div class="line"></div><div class="line">OS: CentOS 7.3.1611ï¼Œ Extrasä»“åº“ä¸­;</div></pre></td></tr></table></figure><p>å®‰è£…é…ç½®æ­¥éª¤:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">1ã€etcd clusterï¼Œä»…MasterèŠ‚ç‚¹;</div><div class="line">2ã€flannel,é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹;</div><div class="line">3ã€é…ç½®k8sçš„master:ä»…masterèŠ‚ç‚¹;</div><div class="line">    kubernetes-master</div><div class="line">    å¯åŠ¨çš„æœåŠ¡:</div><div class="line">        kube-apiserver,kub-scheduler,kube-controller-manager</div><div class="line">4ã€é…ç½®k8sçš„å„NodeèŠ‚ç‚¹;</div><div class="line">    kubernetes-node</div><div class="line">    å…ˆè®¾å®šå¯åŠ¨dockeræœåŠ¡;</div><div class="line">    å¯åŠ¨çš„k8sçš„æœåŠ¡:</div><div class="line">        kube-proxy,kubelet</div></pre></td></tr></table></figure><p>kubeadm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1ã€master, nodes:å®‰è£…kubelet,kubeadm,docker</div><div class="line">2ã€master: kubeadm init</div><div class="line">3ã€nodes: kubeadm join</div><div class="line">    https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.10.md</div><div class="line">æ— è®ºserver è¿˜æ˜¯node  ä¸€èˆ¬æœåŠ¡</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">master:</div><div class="line"># cd /etc/yum.repos.d/</div><div class="line"># wget https://mirrors.aliyun.com/docker-ce/linux/centos-ce.repo</div><div class="line"># vim kubernetes.repo  </div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes Repo </div><div class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kuberentes-el7-x86_64/</div><div class="line">gpgcheck=1</div><div class="line">pgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</div><div class="line">enabled=1</div><div class="line"># yum -y install docker-ce kubelet kubeadm kubectl</div></pre></td></tr></table></figure><p>è¡¥å……:<br><a href="https://mirrors.tuna.tsinghua.edu.cn" target="_blank" rel="external">æ¸…åå¤§å­¦mirrorsåœ°å€</a><br><a href="https://mirrors.aliyun.com/kubernetes/yum" target="_blank" rel="external">é˜¿é‡Œäº‘k8såœ°å€</a></p><hr><p>æä¾›ç½‘ç»œåŠŸèƒ½<br>RESTful<br>    GET, PUT, DELETE, POST, â€¦<br>    kubectl run, get, edit, â€¦<br>èµ„æº:å¯¹è±¡<br>    å·¥ä½œè´Ÿè½½æ€§èµ„æºå¯¹è±¡ workload: Pod,ReplicaSet, Deployment, StatefulSet, DaemonSet, Job, Cronjob, â€¦<br>    æœåŠ¡å‘ç°åŠæœåŠ¡å‡è¡¡: Service, Ingerss, â€¦<br>    é…ç½®ä¸å­˜å‚¨: Volume,CSI<br>        ConfigMap,Secret,<br>        DownwardAPI,<br>    é›†ç¾¤çº§èµ„æº:<br>        Namespace,Node,Role,ClusterRole,RoleBinding, ClusterRoleBinding<br>    æ— æ•°æ®å‹èµ„æº:<br>        HPA,PodTemplate,LimitRange<br>åˆ›å»ºèµ„æºçš„æ–¹æ³•:<br>    apiserverä»…æ¥æ”¶JSONæ ¼å¼çš„èµ„æºå®šä¹‰;<br>    yamlæ ¼å¼æä¾›é…ç½®æ¸…å•ï¼Œapiserverå¯è‡ªåŠ¨å°†å…¶è½¬ä¸ºjsonæ ¼å¼ï¼Œè€Œåå†æäº¤;</p><p>å¤§éƒ¨åˆ†èµ„æºçš„é…ç½®æ¸…å•:<br>    apiversion:group/version;<br>        $ kubectl api-versions<br>    kind:èµ„æºç±»åˆ«<br>    metadata:å…ƒæ•°æ®<br>        nameå¿…éœ€æ˜¯å”¯ä¸€çš„<br>        namespace<br>        labels<br>        annotations<br>        æ¯ä¸ªèµ„æºçš„å¼•ç”¨PATH<br>        /api/GROUP/VERSION/namspace/NAMESAPCE/TYPE/NAME<br>    spec:æœŸæœ›çš„çŠ¶æ€ï¼Œdisired state<br>    status: å½“å‰çŠ¶æ€ï¼Œcurrent state,æœ¬å­—æ®µç”±kubernetesé›†ç¾¤ç»´æŠ¤;<br>èµ„æºé…ç½®æ¸…å•:<br>    è‡ªä¸»å¼Podèµ„æº<br>    èµ„æºçš„æ¸…å•æ ¼å¼:<br>        ä¸€çº§å­—æ®µ: apiVersion(group/version),kind,metadata(name,namespace,lables,annotations,â€¦)spec,status(åªè¯»)<br>    Podèµ„æº:<br>        spec.container&lt;[]object&gt;</p><pre><code>- name &lt;string&gt;- image &lt;string&gt;  imagePullPloicy &lt;string&gt;    Always(ä¸‹è½½), Never(ä¸ä¸‹è½½), IfNotPresent(æœ¬åœ°ä¸å­˜åœ¨é•œåƒåˆ™ä¸‹è½½)</code></pre><p> ä¿®æ”¹é•œåƒä¸­çš„é»˜è®¤åº”ç”¨:<br>    command,args<br>    <a href="https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/" target="_blank" rel="external">https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/</a></p><p>liveness probe:å­˜æ´»çŠ¶æ€æ£€æµ‹</p><hr><table><thead><tr><th>Image Entrypoint</th><th>Image Cmd</th><th>Container command</th><th>Container args</th><th>Command run</th></tr></thead><tbody><tr><td>[/ep-1]</td><td>[foo bar]</td><td>\<not set=""></not></td><td>\<not set=""></not></td><td>[ep-1 foo bar]</td></tr><tr><td>[/ep-1]</td><td>[foo bar]</td><td>[/ep-2]</td><td>\<not set=""></not></td><td>[ep-2]</td></tr><tr><td>[/ep-1]</td><td>[foo bar]</td><td>\<not set=""></not></td><td>[zoo boo]</td><td>[ep-1 zoo boo]</td></tr><tr><td>[/ep-1]</td><td>[foo bar]</td><td>[/ep-2]</td><td>[zoo boo]</td><td>[ep-2 zoo boo]</td></tr></tbody></table><hr><p>æ ‡ç­¾:<br>    key=value<br>    key: å­—æ¯ã€æ•°å­—ã€_ã€-ã€.<br>    value: å¯ä»¥ä¸ºç©º,åªèƒ½å­—æ¯æˆ–æ•°å­—å¼€å¤´åŠç»“å°¾ï¼Œä¸­é—´å¯ä½¿ç”¨<br>æ ‡ç­¾é€‰æ‹©å™¨:<br>    ç­‰å€¼å…³ç³»:=ï¼Œ==ï¼Œ!=<br>    é›†åˆå…³ç³»:<br>        KEY in (VALUE1,VALUE2,â€¦)<br>        KEY notin (VALUE1,VALUE2,â€¦)<br>        KEY å­˜åœ¨è¿™ä¸ªé”®å°±å¯ä»¥<br>        !KEY ä¸å­˜åœ¨è¿™ä¸ªé”®çš„èµ„æº<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># kubectl get pods -l &quot;release notin (canary,beta,alpha)&quot;</div></pre></td></tr></table></figure></p><p>è®¸å¤šèµ„æºæ”¯æŒå†…åµŒå­—æ®µå®šä¹‰å…¶ä½¿ç”¨çš„æ ‡ç­¾é€‰æ‹©å™¨:<br>matchLables: ç›´æ¥ç»™å®šé”®å€¼<br>matchLables: åŸºäºç»™å®šçš„è¡¨è¾¾å¼æ¥å®šä¹‰ä½¿ç”¨çš„æ ‡ç­¾é€‰æ‹©å™¨,{key:â€KEYâ€,operator:â€OPERATORâ€, value:[VAL1,VAL2,â€¦]}<br>    æ“ä½œç¬¦:<br>        IN, NotIN:vlaueså­—æ®µçš„å€¼å¿…é¡»ä¸ºç©ºåˆ—è¡¨;<br>         Exists, NotExists:valueså­—æ®µçš„å€¼å¿…é¡»ä¸ºç©ºåˆ—è¡¨;</p><hr><p>nodeSelector <map[string]string><br>    èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨,<br>nodeName <string><br>annotations:<br>    ä¸labelä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œ å®ƒä¸èƒ½ç”¨äºæŒ‘é€‰èµ„æºå¯¹è±¡ï¼Œä»…ç”¨äºä¸ºå¯¹è±¡æä¾›â€å…ƒæ•°æ®â€ã€‚<br>Podçš„ç”Ÿå‘½å‘¨æœŸ<br>    çŠ¶æ€:Pending(æŒ‚èµ·)ï¼Œå·²ç»åˆ›å»ºï¼Œä½†æœªæ‰¾åˆ°è¿è¡Œå®ƒçš„èŠ‚ç‚¹;<br>        Running;<br>        Failed;<br>        Succeede;<br>        Unknown<br>        Podç”Ÿå‘½å‘¨æœŸä¸­çš„é‡è¦è¡Œä¸ºï¼š<br>            å®å§‹åŒ–å®¹å™¨<br>            å®¹å™¨æ¢æµ‹ï¼š<br>                liveness<br>                readliness<br>        restartPolicy:<br>            Always, OnFailure, Never. Default to Always.</string></map[string]string></p><p>æ¢é’ˆç±»å‹æœ‰ä¸‰ç§:<br>    ExecActionã€ TCPSocketActionã€ HTTPGetAction</p><p>Podæ§åˆ¶å™¨:<br>    ReplicationController:<br>    ReplicaSet: ä»£ç”¨æˆ·åˆ›å»ºæŒ‡å®šæ•°é‡çš„Podå‰¯æœ¬ï¼Œå¤šé€€å°‘è¡¥ï¼Œæ»šåŠ¨æ›´æ–°;æ–°ä¸€ä»£çš„ReplicationController<br>    Deployment: å»ºæ„åœ¨ReplicaSetä¹‹ä¸Šçš„ï¼ŒæµåŠ¨æ›´æ–°ï¼Œå›æ»šï¼Œå£°æ˜å¼é…ç½®;<br>    DemonSet:<br>    Job:<br>    CronJob:<br>    StatefulSet<br>    TRR: Third Party Resources, 1.2+, 1.7<br>    CDR: Custom Defined Resources, 1.8+<br>    Operator:<br>ä¸€ä¸ªåçš„è„šæœ¬åœ¨k8sé›†ç¾¤ä¸­ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´æ•´ä¸ªk8sé›†ç¾¤å²©æ‰; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line">kind: ReplicaSet</div><div class="line">metadata:</div><div class="line">    name: myapp</div><div class="line">    namespace: default </div><div class="line">spec:</div><div class="line">    replicas: 2 </div><div class="line">    relector:</div><div class="line">        matchLabels:</div><div class="line">            app: myapp</div><div class="line">            replease: canary</div><div class="line">    template:</div><div class="line">        metadata:</div><div class="line">            name: myapp-pod</div><div class="line">            labels:</div><div class="line">                app: myapp</div><div class="line">                replease: canary</div><div class="line">                environment:qa</div><div class="line">        spec:</div><div class="line">            contrainers:</div><div class="line">            - name: myapp-container</div><div class="line">              image: ikuberentes/myapp:v1</div><div class="line">              ports:</div><div class="line">              - name: http</div><div class="line">                containerPort: 80</div><div class="line"># kubectl create -f rs-demo.yaml</div></pre></td></tr></table></figure><p>Helm: å¤–å£³ ç±»ä¼¼äºredhatç³»ç»Ÿä¸Šçš„yumç®¡ç†å™¨ä¸€æ ·</p><p>Service<br>    å·¥ä½œæ¨¡å¼:userspace, iptables, ipvs<br>        userspace: 1.1-<br>        iptables: 1.10-<br>        ipvs: 1.11+<br>    ç±»å‹:<br>        ExternalName, CluseterIP, NodePort, and LoadBalancer<br>    èµ„æºè®°å½•:<br>        SVC_NAME.NS_NAME.DOMAIN.LTD.<br>        svc.cluster.local.<br>        redis.default.svc.custer.local.</p><p>NodePort:client â€“&gt; NodeIP:NodePort â€“&gt;ClusterIP:ServciePort â€“&gt; PodIP:containerPort<br>LoadBalancer<br>ExternelName<br>    FQDN<br>        CNAME â€“&gt; FQDN<br>No ClusterIP: Headless Service<br>    ServiceName â€“&gt; PodIP</p><p>è§£å†³æ–¹æ¡ˆ<br>å¤šç»„nginx server å¯¹åº”å¤šä¸ªpod;<br>å¤šä¸ªurl æ˜ å°„å¤šä¸ªpod;</p><p>é…ç½®å®¹å™¨åŒ–åº”ç”¨çš„æ–¹å¼:</p><p>1ã€ è‡ªå®šä¹‰å‘½ä»¤è¡Œå‚æ•°;<br>    args: []</p><p>2ã€ æŠŠé…ç½®æ–‡ä»¶ç›´æ¥ç„™è¿›é•œåƒ;</p><p>3ã€ ç¯å¢ƒå˜é‡<br>    (1) Cloud Nativeçš„åº”ç”¨ç¨‹åºä¸€èˆ¬å¯ä»¥ç›´æ¥ é€šè¿‡ç¯å¢ƒå˜é‡åŠ è½½é…ç½®;<br>    (2) é€šè¿‡entrypointè„šæœ¬æ¥é¢„å¤„ç†å˜é‡ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯;</p><p>4ã€ å­˜å‚¨å·</p><p>CoreOS: operator<br>StatefulSet:</p><p>1ã€ç¨³å®šä¸”æƒŸä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦;<br>2ã€ç¨³å®šä¸”æŒä¹…çš„å­˜å‚¨;<br>3ã€æœ‰åºã€å¹³æ»‘åœ°éƒ¨ç½²å’Œæ‰©å±•;<br>4ã€æœ‰åºã€å¹³æ»‘åœ°åˆ é™¤å’Œç»ˆæ­¢;<br>5ã€æœ‰åºçš„æ»šåŠ¨æ›´æ–°;</p><p>ä¸‰ä¸ªç»„ä»¶: headless serviceã€ StatefulSet ã€ volumeClaimTemplate<br>pod_name.service_name.ns_name.svc.cluster.local<br>    myapp-0.myapp.default.svc.cluster.local</p><p>API<br>Request path<br>    <a href="http://172.20.0.70:6443/apls/apps/v1/namespaces/default/deployment/myapp-deploy/" target="_blank" rel="external">http://172.20.0.70:6443/apls/apps/v1/namespaces/default/deployment/myapp-deploy/</a></p><p>HTTP request verb:<br>    get, post, pub, delete<br>API request verb:<br>    get, list, create, update, patch, watch, redirect, delete, deletecollection </p><p>Resource:<br>Subresource:<br>Namespace<br>API group</p><p>Object URL:<br>    /apis/<group>/<version>/namespaces/<namespace_name>/<kind [object_id]=""> </kind></namespace_name></version></group></p><p>role:<br>    operation<br>    objects<br>rolebinding:<br>    user account OR service account<br>    role</p><p>clusterrole, clusterrolebinding</p><p>role æˆæƒ: get * ; get pod ; get deployment;</p><p>æˆæƒæ’ä»¶: Node, ABAC, RBAC, Webhook(åŸºäºhttpdçš„å›è°ƒæœºåˆ¶)<br>    RBAC: Role-based AC â€˜<br>    è§’è‰²(role)<br>    è®¸å¯(permission)</p><p>å½“ç”¨æˆ·æƒé™ rolebinding  ç»‘å®šåˆ° clusterrolebinding æ—¶ï¼Œclusterrolebinding ä¼šè¢«é™æƒä¸ºrolebinding;</p><p>spec.serviceAccountName<br>    rolebinding<br>    serviceaccount<br>    role</p><p>Kubernetes:è®¤è¯ã€æˆæƒ<br>    API server:<br>        subject â€“&gt; action â€“&gt; object<br>      è®¤è¯: token,tls,user/password<br>        è´¦å·:UserAccount, ServiceAccount<br>    æˆæƒ:RBAC<br>        role,rolebinding<br>        clusterrole,clusterrolebinding<br>        subject:<br>            user<br>            group<br>            serviceaccount<br>        object:<br>            resource group<br>            resource<br>            non-resource url<br>        action:get,list,watch,patch,delete,deletecollectionâ€¦</p><p>Dashboard<br>1ã€éƒ¨ç½²</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml</div></pre></td></tr></table></figure><p>2ã€å°†Service æ”¹ä¸ºNodePort</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl patch svc kubernetes-dashboard -p &apos;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&apos; -n kube-system</div></pre></td></tr></table></figure><p>3ã€ è®¤è¯:<br>    è®¤è¯æ—¶çš„è´¦å·å¿…é¡»ä¸ºServiceAccount: è¢«dashboard podæ‹¿æ¥ç”±kubernetesè¿›è¡Œè®¤è¯çš„;<br>    token:<br>    (1) åˆ›å»ºServiceAccountï¼Œæ ¹æ®å…¶ç®¡ç†ç›®æ ‡ï¼Œä½¿ç”¨rolebindingæˆ–clusterrolebinding ç»‘å®šè‡³åˆç†roleæˆ–clusterrole;<br>    (2) è·å–åˆ°æ­¤ServiceAccountçš„secretï¼ŒæŸ¥çœ‹secretçš„è¯¦ç»†ä¿¡æ¯ï¼Œå…¶ä¸­å°±æœ‰token;</p><p>kubeconfig:æŠŠServiceAccountçš„tokenå°è£…ä¸ºkubeconfigæ–‡ä»¶<br>    (1) åˆ›å»ºServiceAccountï¼Œæ ¹æ®å…¶ç®¡ç†ç›®æ ‡ï¼Œä½¿ç”¨rolebindingæˆ–clusterrolebinding ç»‘å®šè‡³åˆç†roleæˆ–clusterrole;<br>    (2) </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get secret | awk &apos;/^ServiceAccount/&#123;print $1&#125;&apos;</div><div class="line">DEF_NS_ADMIN_TOKEN=$(kubectl get secret SERVCIEACCOUNT_SERRET_NAME -o jsonpath=&#123;.data.token&#125; | base64 -d )</div></pre></td></tr></table></figure><p>(3)ç”Ÿæˆkubeconfig æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl config set-cluster --kuberconfig=/PATH/TO/SOMEFILE</div><div class="line">kubectl config set-credentials NAME --token=$KUBE_TOKEN --kubeconfig=/PATH/TO/SOMEFILE</div><div class="line">kubectl config set-context</div><div class="line">kubectl config use-context</div></pre></td></tr></table></figure><p>kubernetesé›†ç¾¤çš„ç®¡ç†æ–¹å¼<br>1ã€å‘½ä»¤å¼: create, run, expose, delete, edit, â€¦<br>2ã€å‘½ä»¤å¼é…ç½®æ–‡ä»¶:create -f /PATH/TO/RESOURCE_CONFIGURATION_FILE, delete -f , replace -f<br>3ã€å£°æ˜å¼é…ç½®æ–‡ä»¶: apply -f,path,</p><p>docker å¸¸ç”¨çš„å››ç§ç½‘ç»œæ¨¡å‹ <code>bridge/joined/open/none</code></p><p>Kubernetesç½‘ç»œé€šä¿¡:<br>    ï¼ˆ1ï¼‰å®¹å™¨é—´é€šä¿¡: åŒä¸€ä¸ªPodå†…çš„å¤šä¸ªå®¹å™¨é—´çš„é€šä¿¡ï¼Œlo<br>    ï¼ˆ2ï¼‰Podé€šä¿¡: Pod IP &lt;â€“&gt; Pod IP<br>    ï¼ˆ3ï¼‰Podä¸Serviceé€šä¿¡:PodIP &lt;â€“&gt; ClusterIP<br>    ï¼ˆ4ï¼‰Serviceä¸é›†ç¾¤å¤–éƒ¨å®¢æˆ·ç«¯çš„é€šä¿¡<br>CNI: Container Network Interface<br>    flanner<br>    calico<br>    canel<br>    kube-router<br>    â€¦<br>è§£å†³æ–¹æ¡ˆ:<br>    è™šæ‹Ÿç½‘æ¡¥<br>    å¤šè·¯å¤ç”¨: MacVLAN<br>    ç¡¬ä»¶äº¤æ¢: SR-IOV<br>kubelet, /etc/cni/net.d/<br>flannel:<br>    æ”¯æŒå¤šç§åç«¯:<br>        VxLAN<br>            ï¼ˆ1ï¼‰vxlan<br>            ï¼ˆ2ï¼‰Directrouting<br>        host-gw: Host Gateway<br>        UDP<br>flannelçš„é…ç½®å‚æ•°<br>    Network: flannelä½¿ç”¨çš„CIDRæ ¼å¼çš„ç½‘ç»œåœ°å€ï¼Œç”¨äºä¸ºPodçš„é…ç½®ç½‘ç»œåŠŸèƒ½;<br>        master:10.244.0.0/24<br>        node01:10.244.1.0/24<br>        â€¦<br>        node255:10.244.255.0/24<br>    SubneteLen:æŠŠNetworkåˆ‡åˆ†å­ç½‘ä¾›å„èŠ‚ç‚¹ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨å¤šé•¿çš„æ©ç è¿›è¡Œåˆ‡åˆ†ï¼Œé»˜è®¤ä¸º28ä½;<br>    SubnetMin:10.244.10.0/24 å¼€å§‹<br>    SubnetMax:10.244.100.0/24 ç»“æŸ<br>    Backend:vxlan, host-gw, udp<br>        vxlan:<br>ç½‘ç»œç­–ç•¥:<br>    åç§°ç©ºé—´:<br>        æ‹’ç»æ‰€æœ‰å‡ºç«™ï¼Œå…¥ç«™;<br>        æ”¾è¡Œæ‰€æœ‰å‡ºç«™ç›®æ ‡æœ¬åç§°ç©ºé—´å†…çš„æ‰€æœ‰Pod;</p><p>è°ƒåº¦å™¨:<br>    é¢„é€‰ç­–ç•¥:<br>        CheckNodeCondition<br>        GeneralPredicates:<br>            HostName: æ£€æŸ¥Podå¯¹è±¡æ˜¯å¦å®šä¹‰äº†pod.spec.hostname<br>            PodFitsHostPorts:pods.spec.containers.ports.hostPort<br>            MatchNodeSelector:pod.spec.nodeSelector<br>            PodFitsResources:æ£€æŸ¥Podçš„èµ„æºéœ€æ±‚æ˜¯å¦èƒ½è¢«èŠ‚ç‚¹æ‰€æ»¡è¶³;<br>        NoDiskConflict:æ£€æŸ¥Podä¾èµ–çš„å­˜å‚¨å·æ˜¯å¦èƒ½æ»¡è¶³éœ€æ±‚;<br>        PodToleratesNodeTaints:æ£€æŸ¥Podçš„specl.tolerationså¯å®¹å®¹å¿çš„æ±¡ç‚¹æ˜¯å¦å®Œå…¨åŒ…å«èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹;<br>        PodToleratesNodeNoExecuteTaints: å¯¹åº”çš„è¡Œä¸ºæ˜¯é»˜è®¤ä¸æ£€æŸ¥çš„;<br>        CheckNodeLabelPresence: æ£€æŸ¥èŠ‚ç‚¹æŒ‡å®šæ ‡ç­¾çš„å­˜åœ¨æ€§;<br>        CheckServiceAffinity: äº²å’Œæ€§ï¼Œå°†åŒä¸€Serviceçš„Podå°½å¯èƒ½æ”¾åœ¨ä¸€å—;<br>        MaxEBSVolumeCount<br>        MaxGCEPDVolumeCount<br>        MaxAzureDiskVolumeCount<br>        CheckVolumeBinding<br>        NoVolumeZoneConflict<br>        CheckNodeMemoryPressure: æ£€æŸ¥å†…å­˜èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å‹åŠ›;<br>        CheckNodePIDPressure: æ£€æŸ¥PIDæ•°é‡æ˜¯å¦è¿‡å¤š;<br>        CheckNodeDiskPressure: æ£€æŸ¥ç£ç›˜å‹åŠ›æ˜¯å¦è¿‡å¤§;<br>        MatchInterPodAffity: æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ»¡podè¶³äº²å’Œæ€§ä¸åäº²å’Œæ€§<br>ä¼˜é€‰å‡½æ•°<br>    LeastRequested:(cpu((capacity-sum(requested))<em>10/capacity)+memory((capacity-sum(requested))</em>10/capacity))<br>    BalancedResourceAllocation: CPUå’Œå†…å­˜èµ„æºè¢«å ç”¨ç‡ç›¸è¿‘çš„èƒœå‡º;<br>    NodePreferAvoidPods:èŠ‚ç‚¹æ³¨è§£ä¿¡æ¯â€scheduler.alpha.kubernetes.io/perferAvoidPodsâ€<br>    TaintToleration: å°†Podå¯¹è±¡çš„spec.tolerationsåˆ—è¡¨é¡¹ä¸èŠ‚ç‚¹çš„ taintsåˆ—è¡¨é¡¹è¿›è¡ŒåŒ¹é…åº¦æ£€æŸ¥ï¼ŒåŒ¹é…æ¡ç›®è¶Šå¤šï¼Œå¾—åˆ†è¶Šä½;<br>    SeletorSpreading:ä¸å½“å‰Podå¯¹è±¡åŒå±çš„æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹©é€‚é…çš„å…¶å®ƒé€‰æ‹©å…¶Podå¯¹è±¡æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œè¶Šå¤šçš„è¡¨ç¤ºè¶Šä½ï¼Œå¦åˆ™è¶Šé«˜;<br>    NodeAffinity:åŸºäºèŠ‚ç‚¹äº²å’Œæ€§çš„;<br>    InterPodAffinity:éå†Podå¯¹è±¡çš„äº²å’Œæ€§æ¡ç›®ï¼Œå¹¶å°†èƒ½åŒ¹é…åˆ°ç»™å®šèŠ‚ç‚¹çš„æ¡ç›®çš„æƒé‡ç›¸åŠ ï¼Œç»“æœå€¼è¶Šå¤§çš„ï¼Œè¡¨ç¤ºè¶Šé«˜;</p><p>MostRequested:è·ŸLeastRequestedæ­£å¥½ç›¸å;<br>NodeLabel:æ ‡ç­¾è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜;<br>ImageLocality: é•œåƒè¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜ï¼Œæ ¹æ®æ»¡è¶³å½“å‰Podå¯¹è±¡éœ€æ±‚çš„å·²æœ‰é•œåƒä½“ç§¯å¤§å°ä¹‹å’Œ;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl describe nodes node node01.ssjinyao.com</div></pre></td></tr></table></figure><p>èŠ‚ç‚¹é€‰æ‹©å™¨:nodeSelector, nodeName<br>èŠ‚ç‚¹äº²å’Œè°ƒåº¦: nodeAffinity </p><p>taintçš„effectå®šä¹‰å¯¹Podæ’æ–¥æ•ˆæœ:<br>    NoSchedule: ä»…å½±å“è°ƒåº¦è¿‡ç¨‹ï¼Œå¯¹ç°å­˜çš„Podå¯¹è±¡ä¸äº§ç”Ÿå½±å“;<br>    NoExecute: å³å½±å“è°ƒåº¦è¿‡ç¨‹ï¼Œä¹Ÿå½±å“ç°å­˜çš„Podå¯¹è±¡;ä¸å®¹å¿çš„Podå¯¹è±¡å°†è¢«é©±é€;<br>    PreferNoSchedule:ä¸èƒ½å®¹å¿è¢«è°ƒåº¦è¿‡æ¥ï¼Œä½†æ˜¯å®åœ¨æ²¡æœ‰åˆ«çš„èŠ‚ç‚¹è¿è¡Œï¼Œä¹Ÿå¯è¢«è°ƒåº¦ï¼Œæ˜¯NoScheduleçš„æŸ”æ€§ç‰ˆ;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: myapp-deploy</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  replicas: 3</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: myapp</div><div class="line">      release: canary</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app:myapp</div><div class="line">        release:canary</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: myapp</div><div class="line">        image: ikubernetes/myapp:v2</div><div class="line">        ports:</div><div class="line">        - name: myapp</div><div class="line">          image: ikubernetes/myapp: v2</div><div class="line">          ports:</div><div class="line">          - name: http</div><div class="line">            containerPort: 80</div><div class="line">        tolerations:</div><div class="line">        - key: &quot;node-type&quot;</div><div class="line">          operator: &quot;Equal&quot;</div><div class="line">          value: &quot;production&quot;</div><div class="line">          effect: &quot;NoSchedule&quot;</div></pre></td></tr></table></figure><p>å®¹å™¨çš„èµ„æºéœ€æ±‚ï¼Œèµ„æºé™åˆ¶<br>    requests: éœ€æ±‚ï¼Œæœ€ä½ä¿éšœ;<br>    limits: é™åˆ¶ï¼Œæœ€é«˜æ¶ˆè€—åŒºé—´ï¼Œç¡¬é™åˆ¶;<br>    CPU:<br>        1é¢—é€»è¾‘CPU<br>        1=1000å¾®æ ¸å¿ƒ,millicores<br>            500m=0.5CPU<br>    å†…å­˜:<br>        Eã€Pã€Tã€Gã€Mã€K<br>        Eiã€Piã€Tiã€Giã€Miã€Ki<br>    QoS:<br>        Guranteed: æ¯ä¸ªå®¹å™¨åŒæ—¶è®¾ç½®CPUå’Œå†…å­˜çš„requestså’Œlimits;<br>            cpu.limits=cpu.requests<br>            memory.limits=memory.request<br>        Burstable:è‡³å°‘ä¸€ä¸ªå®¹å™¨è®¾ç½®CPUæˆ–è€…å†…å­˜èµ„æºçš„requestså±æ€§;<br>        BestEffort:æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå®¹å™¨è®¾ç½®äº†requestsæˆ–limitså±æ€§;æœ€ä½ä¼˜å…ˆçº§åˆ«;<br>èµ„æºæŒ‡æ ‡:metrics-server<br>è‡ªå®šä¹‰æŒ‡æ ‡:prometheusï¼Œk8s-prometheus-adapter<br>æ–°ä¸€ä»£æ¶æ¶æ„:<br>    æ ¸å¿ƒæŒ‡æ ‡æµæ°´çº¿: ç”±kubeletã€metrics-serverä»¥åŠç”±API server æä¾›çš„apiç»„æˆ;CPUç´¯ç§¯ä½¿ç”¨ç‡ã€å†…å­˜å®æ—¶ä½¿ç”¨ç‡ã€Podçš„èµ„æºå ç”¨ç‡åŠå®¹å™¨çš„ç£ç›˜å ç”¨ç‡;<br>    ç›‘æ§æµæ°´çº¿:ç”¨äºä»ç³»ç»Ÿæ”¶é›†å„ç§æŒ‡æ ‡æ•°æ®å¹¶æä¾›ç»ˆç«¯ç”¨æˆ·ã€å­˜å‚¨ç³»ç»Ÿä»¥åŠHPAï¼Œå®ƒä»¬åŒ…å«æ ¸å¿ƒæŒ‡æ ‡åŠè®¸å¤šéæ ¸å¿ƒæŒ‡æ ‡ã€‚éæ ¸å¿ƒæŒ‡æ ‡æœ¬èº«ä¸èƒ½è¢«k8sæ‰€è§£æ,<br>   metrics-server:API-server<br>Helm:<br>    æ ¸å¿ƒæœ¯è¯­:<br>        Chart: ä¸€ä¸ªhelmç¨‹åºåŒ…çš„;<br>        Repository: Chartsä»“åº“ï¼Œhttps/httpæœåŠ¡å™¨;<br>        Release: ç‰¹å®šçš„Chartéƒ¨ç½²äºç›®æ ‡é›†ç¾¤ä¸Šçš„ä¸€ä¸ªå®ä¾‹;<br>        Chart â€“&gt; Config â€“&gt; Release<br>    ç¨‹åºæ¶æ„:<br>        helm:å®¢æˆ·ç«¯ï¼Œç®¡ç†æœ¬åœ°çš„Chartä»“åº“ï¼Œç®¡ç†Chartï¼Œä¸TilleræœåŠ¡å™¨äº¤äº’ï¼Œå‘é€Chartï¼Œå®ä¾‹å®‰è£…ã€æŸ¥è¯¢ã€å¸è½½ç­‰æ“ä½œ;<br>        Tiller: æœåŠ¡ç«¯ï¼Œå¯ä»¥è¿è¡Œåœ¨kubernetesä¹‹ä¸Šï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨kubernetesä¹‹å¤–ã€æ¥æ”¶helmå‘æ¥çš„Chartsä¸Configï¼Œåˆå¹¶ç”Ÿæˆrelease;<br>        RBACé…ç½®æ–‡ä»¶ç¤ºä¾‹:<br>            <a href="https://github.com/helm/helm/blob/master/docs/rbac.md" target="_blank" rel="external">https://github.com/helm/helm/blob/master/docs/rbac.md</a><br>        å®˜æ–¹å¯ç”¨çš„Chartåˆ—è¡¨:<br>            <a href="https://hub.kubeapps.com" target="_blank" rel="external">https://hub.kubeapps.com</a><br>    helmå¸¸ç”¨å‘½ä»¤:<br>        releaseç®¡ç† </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># helm search jenkins</div><div class="line"># helm inspect jenkins</div><div class="line"># helm list </div><div class="line"># helm install</div><div class="line"># helm delete</div><div class="line"># helm upgrade</div><div class="line"># helm rollback</div><div class="line"># helm history # releaseçš„éƒ¨ç½²å†å²;</div><div class="line"># helm status # è·å–releaseçŠ¶æ€ä¿¡æ¯;</div><div class="line"># helm install --name redis -f ./values.yaml stable/redis</div></pre></td></tr></table></figure><p>chartç®¡ç† </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># helm create</div><div class="line"># helm fetch</div><div class="line"># helm get </div><div class="line"># helm inspect</div><div class="line"># helm package æ‰“åŒ…chart æ–‡ä»¶</div><div class="line"># helm verify</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># helm lint ../myapp  # æ£€æŸ¥è¯­æ³•é”™è¯­</div><div class="line"># helm package myapp/</div><div class="line"># helm delete --purge mapp3 </div><div class="line"># helm delete --purge mapp2</div><div class="line"># helm delete --purge mapp1</div><div class="line"># helm repo add --help </div><div class="line"># helm repo list</div></pre></td></tr></table></figure><p>Chart â€“&gt; helm,tiller service<br>Chart â€“&gt; Config â€“&gt;Release<br>Config:values.yaml</p><p>ELK: E:elasticsearch L:logstash K: kibana<br>æ—¥å¿—æ”¶é›†çš„ç»„ä»¶ï¼ˆLogstashã€Filebeatã€Fluentdï¼‰</p><p>å½“podå‡ºç°æŒ‚äº†çš„æƒ…å†µï¼ŒæŸ¥çœ‹podæ—¥å¿—æ—¶ä¸æ–¹ä¾¿æŸ¥çœ‹ã€‚å› æ­¤ï¼Œåº”è¯¥å°†æ—¥å¿—æå‰æ”¾åˆ°ä¸€ä¸ªå­˜å‚¨ä¸­ã€‚kubernetesé›†ç¾¤åº”æä¾›ä¸€ä¸ªæ—¥å¿—æ”¶é›†å™¨ã€‚<br>å®Œæ•´çš„kubernetes é›†ç¾¤ (kubdns| kubcurl ,ingress controller,heapster| metrics-server prometheus, dashboard)<br>å››å¤§ç»„ä»¶ç»„æˆéƒ¨åˆ†ï¼Œå¦å¤–é™„åŠ é™„ä»¶efk;</p><p>/var/log  â€“&gt; /var/log/containers/<br>k8sç³»ç»Ÿå…³é”®ç»„ä»¶:<br>Core Infrastructure â€“&gt; Network(SDN) Storage (Provisioning Congfiguration ) â€“&gt; Kubernetes Cluster â€“&gt; Containerzed Worload (image registry)<br>é¢å¤–çš„ç³»ç»Ÿ:Logging Monitoring<br>ç¡¬ä»¶åŠè´Ÿè½½ã€è½¯ä»¶åŠè´Ÿè½½:LoadBalancer<br>å­˜å‚¨ä½ç½®:Artifact factory<br>æ„å»ºè‡ªåŠ¨åŒ–:Build Automation (CI,CD)<br>è‡ªåŠ¨åŒ–å‘å¸ƒ:Rlease Automation</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>dockerç¬”è®°(äºŒ)</title>
      <link href="/2018/10/02/docker%E7%AC%94%E8%AE%B0%E4%BA%8C/"/>
      <url>/2018/10/02/docker%E7%AC%94%E8%AE%B0%E4%BA%8C/</url>
      <content type="html"><![CDATA[<h1 id="docker-ç¬”è®°-äºŒ"><a href="#docker-ç¬”è®°-äºŒ" class="headerlink" title="docker ç¬”è®°(äºŒ)"></a>docker ç¬”è®°(äºŒ)</h1><p><img src="/images/docker-image-2.png" alt=""></p><h2 id="Docker-Data-Volume"><a href="#Docker-Data-Volume" class="headerlink" title="Docker Data Volume"></a>Docker Data Volume</h2><p>å…³é—­å¹¶é‡å¯å®¹å™¨ï¼Œå…¶æ•°æ®ä¸å—å½±å“; ä½†åˆ é™¤Dockerå®¹å™¨ï¼Œåˆ™å…¶æ›´å°†ä¼šå…¨éƒ¨ä¸¢å¤±;<br>å­˜åœ¨çš„é—®é¢˜<br>å­˜å‚¨äºè”åˆæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä¸æ˜“äºå®¿ä¸»æœºè®¿é—®;<br>å®¹å™¨é—´æ•°æ®å…±äº«ä¸ä¾¿;<br>åˆ é™¤å®¹å…¶æ•°æ®ä¼šå…¨éƒ¨ä¸¢å¤±;<br>è§£å†³æ–¹æ¡ˆ:â€å·(volume)â€</p><p>â€œå·â€æ˜¯å®¹å™¨ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªâ€ç›®å½•â€ï¼Œæ­¤ç±»ç›®å½•å¯ç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œä¸å®¿ä¸»æœºä¸Šçš„æŸç›®å½•â€ç»‘å®š(å…³è”)â€<br>Volume äºå®¹å™¨åˆå§‹åŒ–ä¹‹æ—¶å³ä¼šåˆ›å»ºï¼Œç”±base imageæä¾›çš„å·ä¸­çš„æ•°æ®ä¼šäºæ­¤æœŸé—´å®Œæˆå¤åˆ¶<br>Volume çš„åˆè¡·æ˜¯ç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå®ç°æ•°æ®æŒä¹…åŒ–ï¼Œå› æ­¤åˆ é™¤å®¹å™¨æ—¶å³ä¸ä¼šåˆ é™¤å·ï¼Œä¹Ÿ<br>ä¸ä¼šå¯¹å“ªæ€•æœªè¢«å¼•ç”¨çš„å·åšåƒåœ¾å›æ”¶æ“ä½œ;</p><p>Dockeræœ‰ä¸¤ç§ç±»å‹çš„å·ï¼Œæ¯ç§ç±»å‹éƒ½åœ¨å®¹å™¨ä¸­å­˜åœ¨ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œä½†å…¶åœ¨å®¿ä¸»æœºä¸Šçš„ä½ç½®æœ‰æ‰€ä¸åŒ;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker run --name b2 -it -v /data busybox</div></pre></td></tr></table></figure><p>æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹Mountä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># docker inspect b2 </div><div class="line">&quot;Mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;Type&quot;: &quot;volume&quot;,</div><div class="line">                &quot;Name&quot;: &quot;5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d&quot;,</div><div class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d/_data&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/data&quot;,</div><div class="line">                &quot;Driver&quot;: &quot;local&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;&quot;</div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line"># echo &quot;hello container&quot; &gt;&gt; /var/lib/docker/volumes/5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d/_data/test.html</div></pre></td></tr></table></figure><p>åœ¨å®¹å™¨ä¸­æŸ¥çœ‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/ # cat data/test.html</div><div class="line">hello container</div><div class="line">/ # echo &quot;test rj&quot; &gt;&gt; data/test.html</div></pre></td></tr></table></figure><p>åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># cat /var/lib/docker/volumes/5d2aaa4a60dd5724bed6011c92d71df8eb093de43bae2038c992f746f97f6e7d/_data/test.html</div><div class="line">hello container</div><div class="line">test rj</div></pre></td></tr></table></figure><p>å½“å®¹å™¨é€€å‡ºå¹¶åˆ é™¤åï¼Œæ•°æ®ä¾ç„¶å­˜åœ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker run --name b2 -it --rm -v /data/volumes/b2:/data busybox</div><div class="line"># docker inspect b2 | grep volume</div><div class="line">                &quot;/data/volumes/b2:/data&quot;</div><div class="line">                &quot;Source&quot;: &quot;/data/volumes/b2&quot;,</div></pre></td></tr></table></figure><p>æŸ¥çœ‹inspectå…ƒç´  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker inspect -f &#123;&#123;.Mounts&#125;&#125; b2</div><div class="line">[&#123;bind  /data/volumes/b2 /data   true rprivate&#125;]</div></pre></td></tr></table></figure><p>æ³¨: ä¸¤ä¸ªå®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ªå­˜å‚¨å·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker run -it --name c1 -v /docker/volumes/v1:/data busybox</div><div class="line"># docker run -it --name c2 -v /docker/volumes/v1:/data busybox</div></pre></td></tr></table></figure><p>å¤åˆ¶ä½¿ç”¨å…¶å®ƒå®¹å™¨çš„å·ï¼Œä¸ºdocker run å‘½ä»¤ä½¿ç”¨ â€“volumes-fromé€‰é¡¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker run -it --name bbox1 -v /docker/volumes/v1:/data busybox </div><div class="line"># docker run -it --name bbox2 --volumes-from bbox1 busybox</div></pre></td></tr></table></figure><h2 id="docker-file"><a href="#docker-file" class="headerlink" title="docker file"></a>docker file</h2><p>FROM<br>FROMçš„æŒ‡ä»¤æ˜¯æœ€é‡çš„ä¸€ä¸ªä¸”å¿…é¡»ä¸ºDockefileæ–‡ä»¶å¼€ç¯‡çš„ç¬¬ä¸€ä¸ªéæ³¨é‡Šè¡Œï¼Œ<br>ç”¨äºä¸ºæ˜ åƒæ–‡ä»¶æ„å»ºè¿‡ç¨‹æŒ‡å®šåŸºå‡†é•œåƒï¼Œåç»­çš„æŒ‡ä»¤è¿è¡Œäºæ­¤åŸºå‡†é•œåƒæ‰€æä¾›çš„<br>è¿è¡Œç¯å¢ƒã€‚<br>å®è·µä¸­ï¼ŒåŸºå‡†é•œåƒå¯ä»¥æ˜¯ä»»ä½•å¯ç”¨é•œåƒæ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œdocker buildä¼šåœ¨<br>docker ä¸»æœºä¸ŠæŸ¥æ‰¾æŒ‡å®šçš„é•œåƒæ–‡ä»¶ï¼Œåœ¨å…¶ä¸å­˜åœ¨æ—¶ï¼Œåˆ™ä¼šä»Docker Hub<br>Registryä¸Šæ‹‰å–æ‰€éœ€è¦çš„é•œåƒæ–‡ä»¶<br>å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„é•œåƒæ–‡ä»¶ï¼Œdocker buildä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚</p><p>Syntax</p><p>FROM <repository>[:<tag>]æˆ–<br>FROM <resository>@<digest></digest></resository></tag></repository></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># vim Dockerfile</div><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">COPY index.html /data/web/html</div><div class="line"># vim index.html </div><div class="line">&lt;h1&gt; ssjinyao httpd server.&lt;/h1&gt;</div><div class="line"># docker build -t ssjinyaohttpd-img:v0.1-1 ./</div><div class="line">Sending build context to Docker daemon  3.072kB</div><div class="line">Step 1/3 : FROM busybox:latest</div><div class="line"> ---&gt; e1ddd7948a1c</div><div class="line">Step 2/3 : MAINTAINER &quot;Jinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"> ---&gt; Running in aa9838facca1</div><div class="line">Removing intermediate container aa9838facca1</div><div class="line"> ---&gt; 71258688ebeb</div><div class="line">Step 3/3 : COPY index.html /data/web/html</div><div class="line"> ---&gt; b23d8149125a</div><div class="line">Successfully built b23d8149125a</div><div class="line">Successfully tagged ssjinyaohttpd-img:v0.1-1</div></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker run --name ssjinyao-web1 --rm ssjinyaohttpd-img:v0.1-1 cat /data/web/html/index.html</div><div class="line">&lt;h1&gt; ssjinyao httpd server.&lt;/h1&gt;</div></pre></td></tr></table></figure><p>å¤åˆ¶ç›®å½•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">COPY index.html /data/web/html/</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line"># ls</div><div class="line">Dockerfile  index.html  yum.repos.d</div><div class="line"># docker build -t tinyhttpd:v0.1-2 ./</div><div class="line"># docker build -t tinyhttpd:v0.1-2 ./</div><div class="line">Sending build context to Docker daemon  26.11kB</div><div class="line">Step 1/4 : FROM busybox:latest</div><div class="line"> ---&gt; e1ddd7948a1c</div><div class="line">Step 2/4 : MAINTAINER &quot;ssjinayo &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 708bad816b72</div><div class="line">Step 3/4 : COPY index.html /data/web/html/</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 758051947b4d</div><div class="line">Step 4/4 : COPY yum.repos.d /etc/yum.repos.d/</div><div class="line"> ---&gt; a4c01bf4fe8d</div><div class="line">Successfully built a4c01bf4fe8d</div><div class="line">Successfully tagged tinyhttpd:v0.1-2</div><div class="line"># docker run --name tinyweb1 --rm tinyhttpd:v0.1-2 ls /etc/yum.repos.d/</div><div class="line">CentOS-Base.repo</div><div class="line">CentOS-CR.repo</div><div class="line">CentOS-Debuginfo.repo</div><div class="line">CentOS-Media.repo</div><div class="line">CentOS-Sources.repo</div><div class="line">CentOS-Vault.repo</div><div class="line">CentOS-fasttrack.repo</div><div class="line">docker-ce.repo</div><div class="line">epel-testing.repo</div><div class="line">epel.repo</div></pre></td></tr></table></figure><p>ADD æŒ‡ä»¤çš„ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># vim Dockerfile</div><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">COPY index.html /data/web/html/</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line">ADD http://nginx.org/download/nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line"># docker build -t tinyhttpd:v0.1-3 ./</div><div class="line">Sending build context to Docker daemon  26.11kB</div><div class="line">Step 1/5 : FROM busybox:latest</div><div class="line"> ---&gt; e1ddd7948a1c</div><div class="line">Step 2/5 : MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 708bad816b72</div><div class="line">Step 3/5 : COPY index.html /data/web/html/</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 758051947b4d</div><div class="line">Step 4/5 : COPY yum.repos.d /etc/yum.repos.d/</div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; a4c01bf4fe8d</div><div class="line">Step 5/5 : ADD http://nginx.org/download/nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line">Downloading  1.025MB/1.025MB</div><div class="line"> ---&gt; 884e8bf3725f</div><div class="line">Successfully built 884e8bf3725f</div><div class="line">Successfully tagged tinyhttpd:v0.1-3</div><div class="line"># docker run --name tinyweb1 --rm tinyhttpd:v0.1-3 ls /usr/local/src/</div><div class="line">nginx-1.15.5.tar.gz</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">COPY index.html /data/web/html/</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line">#ADD http://nginx.org/download/nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line">ADD nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line"># ls</div><div class="line">Dockerfile  index.html  nginx-1.15.5.tar.gz  yum.repos.d</div><div class="line"># docker build -t tinyhttpd:v0.1-4 ./</div><div class="line"># docker run --name tinyweb --rm tinyhttpd:v0.1-4 ls /usr/local/src</div><div class="line">nginx-1.15.5</div></pre></td></tr></table></figure><p>å¦å¤–ä¸€ç§å†™æ³• </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># vim Dockerfile</div><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">COPY index.html /data/web/html/</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line">#ADD http://nginx.org/download/nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line">WORKDIR /usr/local/src/</div><div class="line">ADD nginx-1.15.5.tar.gz ./ #è¿™é‡Œçš„./ç›¸å½“äºWORKDIRæŒ‡å®šçš„ç›®å½•</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">COPY index.html /data/web/html/</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line">#ADD http://nginx.org/download/nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line">WORKDIR /usr/local/</div><div class="line">ADD nginx-1.15.5.tar.gz ./src/</div><div class="line"></div><div class="line">VOLUME /data/mysql/</div><div class="line"># docker build -t tinyhttpd:v0.1-5 ./</div><div class="line">Sending build context to Docker daemon  1.052MB</div><div class="line">Step 1/7 : FROM busybox:latest</div><div class="line"> ---&gt; e1ddd7948a1c</div><div class="line">Step 2/7 : MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"> ---&gt; Running in 206968a461e1</div><div class="line">Removing intermediate container 206968a461e1</div><div class="line"> ---&gt; acce38db09a6</div><div class="line">Step 3/7 : COPY index.html /data/web/html/</div><div class="line"> ---&gt; cfac93db1094</div><div class="line">Step 4/7 : COPY yum.repos.d /etc/yum.repos.d/</div><div class="line"> ---&gt; ccbddff1520b</div><div class="line">Step 5/7 : WORKDIR /usr/local/</div><div class="line"> ---&gt; Running in 8bbda4faa5a4</div><div class="line">Removing intermediate container 8bbda4faa5a4</div><div class="line"> ---&gt; 1660db5c8614</div><div class="line">Step 6/7 : ADD nginx-1.15.5.tar.gz ./src/</div><div class="line"> ---&gt; cfd686660ff8</div><div class="line">Step 7/7 : VOLUME /data/mysql/</div><div class="line"> ---&gt; Running in e85008cba000</div><div class="line">Removing intermediate container e85008cba000</div><div class="line"> ---&gt; 529be777da05</div><div class="line">Successfully built 529be777da05</div><div class="line">Successfully tagged tinyhttpd:v0.1-5</div><div class="line"># docker run --name tinweb1 --rm tinyhttpd:v0.1-5 mount | grep data</div><div class="line">/dev/mapper/centos-root on /data/mysql type xfs (rw,seclabel,relatime,attr2,inode64,noquota)</div></pre></td></tr></table></figure><p>EXPOSE æŒ‡ä»¤ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EXPOSE 1211/udp 11211/tcp # å¯åŠ¨é•œåƒæ˜¯è¦ä½¿ç”¨-Pé€‰é¡¹</div></pre></td></tr></table></figure><p>ENV </p><p>ç”¨äºä¸ºé•œåƒå®šä¹‰æ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶å¯è¢«Dockerfileæ–‡ä»¶ä¸­ä½äºå…¶åå…¶å®ƒæŒ‡ä»¤<br>(ENV,ADD,COPYç­‰)æ‰€è°ƒç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">ENV DOC_ROOT /data/web/html</div><div class="line"></div><div class="line">COPY index.html $DOC_ROOT</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line">#ADD http://nginx.org/download/nginx-1.15.5.tar.gz /usr/local/src/</div><div class="line">WORKDIR /usr/local/</div><div class="line">ADD nginx-1.15.5.tar.gz ./src/</div><div class="line"></div><div class="line">VOLUME /data/mysql/</div><div class="line"></div><div class="line">EXPOSE 80/tcp</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker run --name tinyweb1 --rm -P tinyhttpd:v0.1-7 printenv # æ‰“å°è¾“å‡ºç¯å¢ƒå˜é‡</div><div class="line"># docker run --name tinyweb --rm -P -e WEB_SERVER_PACKAGE=&quot;nginx-1.15.1&quot; tinyhttpd:v0.1-7 printenv # -e å¯ä»¥å¤–éƒ¨æ›´æ”¹æˆ–æŒ‡å®šç¯å¢ƒå˜é‡çš„</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#Deskription: test image</div><div class="line">FROM busybox:latest</div><div class="line">MAINTAINER &quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot;</div><div class="line"># LABEL maintainer=&quot;ssjinyao&quot;</div><div class="line">ENV DOC_ROOT=/data/web/html/ \</div><div class="line">    WEB_SERVER_PACKAGE=&quot;nginx-1.15.5.gz&quot;</div><div class="line"></div><div class="line">#å½“æ²¡æœ‰</div><div class="line">COPY index.html $&#123;DOC_ROOT: -/data/web/html/&#125;</div><div class="line">COPY yum.repos.d /etc/yum.repos.d/</div><div class="line">ADD http://nginx.org/download/$&#123;WEB_SERVER_PACKAGE&#125; /usr/local/src/</div><div class="line">WORKDIR /usr/local/</div><div class="line">#ADD $&#123;WEB_SERVER_PACKAGE&#125;.tar.gz ./src/</div><div class="line"></div><div class="line">VOLUME /data/mysql/</div><div class="line"></div><div class="line">EXPOSE 80/tcp</div><div class="line"></div><div class="line">RUN cd /usr/local/src &amp;&amp; \</div><div class="line">    tar xvf $&#123;WEB_SERVER_PACKAGE&#125;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">FROM busybox</div><div class="line">LABEL maintainer=&quot;ssjinyao &lt;renjin@ssjinyao.com&gt;&quot; app=&quot;httpd&quot;</div><div class="line"></div><div class="line">ENV WEB_DOC_ROOT=&quot;/data/web/html&quot;</div><div class="line"></div><div class="line">RUN mkdir -p $WEB_DOC_ROOT &amp;&amp; \</div><div class="line">echo &apos;&lt;h1&gt;Busybox httpd server.&lt;/h1&gt;&apos; &gt; $&#123;WEB_DOC_ROOT&#125;/index.html</div><div class="line"></div><div class="line"># COM /bin/httpd  -f -h $&#123;WEB_DOC_ROOT&#125;</div><div class="line">CMD [&quot;/bin/httpd&quot;, &quot;-f&quot;, &quot;-h $&#123;EWB_DOC_ROOT&#125;&quot;]</div><div class="line">ENTRYPOINT /bin/sh -c</div></pre></td></tr></table></figure><p>Dockerfile Nginxé•œåƒ ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"># mkdir img_nginx</div><div class="line"># cd img_nginx</div><div class="line"># vim Dockerfile</div><div class="line">FROM nginx:1.14-alpine</div><div class="line"></div><div class="line">ARG author=&quot;ssjinyao &lt;rejin@ssjinyao.com&gt;&quot;</div><div class="line"></div><div class="line">LABEL maintainer=&quot;$&#123;author&#125;&quot;</div><div class="line"></div><div class="line">ENV NGX_DOC_ROOT=&quot;/data/web/html/&quot;</div><div class="line"></div><div class="line">ADD index.html $&#123;NGX_DOC_ROOT&#125;</div><div class="line">ADD entrypoint.sh /bin/</div><div class="line"></div><div class="line">EXPOSE 80/tcp</div><div class="line"></div><div class="line">HEALTHCHECK --start-period=3s CMD wget -O - -q http://$&#123;IP:-0.0.0.0&#125;:$&#123;PORT:-80&#125;/</div><div class="line"></div><div class="line">CMD [&quot;/usr/sbin/nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</div><div class="line"></div><div class="line">ENTRYPOINT [&quot;/bin/entrypoint.sh&quot;]</div><div class="line"></div><div class="line"></div><div class="line"># vim index.html</div><div class="line">&lt;h1&gt; Dockerfile Nginx Test Page.&lt;/h1&gt;</div><div class="line"></div><div class="line"># vim entrypoint.sh</div><div class="line">#!/bin/sh</div><div class="line">#</div><div class="line">cat &gt; /etc/nginx/conf.d/www.conf &lt;&lt;EOF</div><div class="line">server &#123;</div><div class="line">        server_name $&#123;HOSTNAME&#125;;</div><div class="line">        listen $&#123;IP:-0.0.0.0&#125;:$&#123;PORT:-80&#125;;</div><div class="line">        root $&#123;NGINX_DOC_ROOT:-/usr/share/nginx/html&#125;;</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line"></div><div class="line">exec &quot;$@&quot;</div><div class="line"># docker run --name myweb1 --rm -P  -e &quot;PORT=8080&quot; nginx_web:v0.0-1</div><div class="line">127.0.0.1 - - [03/Oct/2018:07:43:31 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Wget&quot; &quot;-&quot;</div><div class="line">127.0.0.1 - - [03/Oct/2018:07:44:01 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Wget&quot; &quot;-&quot;</div></pre></td></tr></table></figure><h2 id="è‡ªå»ºdocker-registry"><a href="#è‡ªå»ºdocker-registry" class="headerlink" title="è‡ªå»ºdocker-registry"></a>è‡ªå»ºdocker-registry</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># yum -y install docker-registry</div><div class="line"># rpm -ql docker-distribution</div><div class="line">/etc/docker-distribution/registry/config.yml</div><div class="line">/usr/bin/registry</div><div class="line">/usr/lib/systemd/system/docker-distribution.service</div><div class="line">/var/lib/registry</div></pre></td></tr></table></figure><p>æ³¨: docker push  å®¢æˆ·ç«¯é»˜è®¤æ˜¯httpså·¥ä½œçš„ï¼Œå› æ­¤åœ¨å®¢æˆ·ç«¯é…ç½®ä¸åŠ å¯†ä¼ è¾“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># vim /etc/docker/daemon.json</div><div class="line">&#123;</div><div class="line">    &quot;registry-mirrors&quot;:[&quot;https://registry.docker-cn.com&quot;],</div><div class="line">    &quot;bip&quot;: &quot;10.0.0.1/16&quot;,</div><div class="line">    &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2375&quot;,&quot;unix:///var/run/docker.sock&quot;],</div><div class="line">    &quot;insecure-registries&quot;: [&quot;node2:5000&quot;]</div><div class="line">&#125;</div><div class="line"># docker tag ssjinyao/httpd:v0.1.1.1-2 node2:5000/ssjinayo-web:v0.1.1.1-2</div><div class="line"># docker push node2:5000/ssjinayo-web</div><div class="line">The push refers to repository [node2:5000/ssjinayo-web]</div><div class="line">e6baf59e35e7: Pushed</div><div class="line">f9d9e4e6e2f0: Pushed</div><div class="line">v0.1.1.1-2: digest: sha256:2f3d6d2f468ee189b4b43ff2b9f99a6e3895d9832b606522176f804cba738037 size: 734</div></pre></td></tr></table></figure><p>æœåŠ¡ç«¯é•œåƒé»˜è®¤ä¿å­˜çš„è·¯å¾„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># ls /var/lib/registry/docker/registry/v2/repositories/ssjinayo-web</div><div class="line">_layers  _manifests  _uploads</div></pre></td></tr></table></figure><p>ç§æœ‰docker æºpull ä½¿ç”¨, å‰æä¹Ÿè¦é…ç½®ä¸åŠ å¯†ä¼ è¾“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker pull node2:5000/ssjinayo-web:v0.1.1.1-2</div><div class="line">v0.1.1.1-2: Pulling from ssjinayo-web</div><div class="line">Digest: sha256:2f3d6d2f468ee189b4b43ff2b9f99a6e3895d9832b606522176f804cba738037</div><div class="line">Status: Downloaded newer image for node2:5000/ssjinayo-web:v0.1.1.1-2</div></pre></td></tr></table></figure><h2 id="vmware-harborç§æœ‰æºçš„å®‰è£…ä¸ä½¿ç”¨"><a href="#vmware-harborç§æœ‰æºçš„å®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="vmware-harborç§æœ‰æºçš„å®‰è£…ä¸ä½¿ç”¨"></a>vmware-harborç§æœ‰æºçš„å®‰è£…ä¸ä½¿ç”¨</h2><p><a href="https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">vmware/harborå®‰è£…</a><br><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="external">vmware/harborä¸‹è½½</a></p><table><thead><tr><th style="text-align:right">Resource</th><th style="text-align:right">Capacity</th><th style="text-align:right">Description</th></tr></thead><tbody><tr><td style="text-align:right">CPU</td><td style="text-align:right">minimal 2 CPU</td><td style="text-align:right">4 CPU is prefered</td></tr><tr><td style="text-align:right">Mem</td><td style="text-align:right">minimal 4GB</td><td style="text-align:right">8GB is prefered</td></tr><tr><td style="text-align:right">Disk</td><td style="text-align:right">minimal 40GB</td><td style="text-align:right">160GB is prefered</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># yum -y install docker-compose</div><div class="line"># vim harbor.cfg # è¿™é‡Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ”¹é…ç½®æ–‡ä»¶</div><div class="line"># vim docker-compose.yml # </div><div class="line"># cd /usr/local/src/harbor</div><div class="line"># ./install</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">CONTAINER ID        IMAGE                                    COMMAND                  CREATED             STATUS                   PORTS                                                              NAMES</div><div class="line">f01090bf5ba1        goharbor/nginx-photon:v1.6.0             &quot;nginx -g &apos;daemon ofâ€¦&quot;   3 minutes ago       Up 3 minutes (healthy)   0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp   nginx</div><div class="line">7e4849fcb12a        goharbor/harbor-jobservice:v1.6.0        &quot;/harbor/start.sh&quot;       3 minutes ago       Up 3 minutes                                                                                harbor-jobservice</div><div class="line">0d8ceb3ec5c0        goharbor/harbor-ui:v1.6.0                &quot;/harbor/start.sh&quot;       3 minutes ago       Up 3 minutes (healthy)                                                                      harbor-ui</div><div class="line">c5780037bc8f        goharbor/harbor-adminserver:v1.6.0       &quot;/harbor/start.sh&quot;       3 minutes ago       Up 3 minutes (healthy)                                                                      harbor-adminserver</div><div class="line">b184110cfac2        goharbor/registry-photon:v2.6.2-v1.6.0   &quot;/entrypoint.sh /etcâ€¦&quot;   3 minutes ago       Up 3 minutes (healthy)   5000/tcp                                                           registry</div><div class="line">83b4b2ea3b2e        goharbor/redis-photon:v1.6.0             &quot;docker-entrypoint.sâ€¦&quot;   3 minutes ago       Up 3 minutes             6379/tcp                                                           redis</div><div class="line">9055f4dcdaeb        goharbor/harbor-db:v1.6.0                &quot;/entrypoint.sh postâ€¦&quot;   3 minutes ago       Up 3 minutes (healthy)   5432/tcp                                                           harbor-db</div><div class="line">583dd6d3dc30        goharbor/harbor-log:v1.6.0               &quot;/bin/sh -c /usr/locâ€¦&quot;   3 minutes ago       Up 3 minutes (healthy)   127.0.0.1:1514-&gt;10514/tcp                                          harbor-log</div></pre></td></tr></table></figure><p><img src="/images/docker-vmware-harbor.png" alt=""></p><p>ç™»å½•ç®¡ç†å‘˜åå°<br><img src="/images/docker-vmware-harbor-loggin.png" alt=""></p><p>åœ¨ docker-vmware-harborä¸­åˆ›å»ºæ™®é€šç”¨æˆ·ï¼Œåœ¨æ™®é€šç”¨æˆ·ä¸­åˆ›å»ºé¡¹ç›®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># vim /etc/docker/daemon.json</div><div class="line">&#123;</div><div class="line">    &quot;insecure-registries&quot;: [&quot;blog.ssjinyao.com&quot;]</div><div class="line">&#125;</div><div class="line"># docker login blog.ssjinyao.com</div><div class="line">Username: ssjinyao</div><div class="line">Password:</div><div class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</div><div class="line">Configure a credential helper to remove this warning. See</div><div class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</div><div class="line"></div><div class="line">Login Succeeded</div><div class="line">[root@ssjinyao-node2:~]# docker push blog.ssjinyao.com/devel/ssjinyao-httpd</div><div class="line">The push refers to repository [blog.ssjinyao.com/devel/ssjinyao-httpd]</div><div class="line">e6baf59e35e7: Pushed</div><div class="line">f9d9e4e6e2f0: Pushed</div><div class="line">v0.1.1.1-1: digest: sha256:7248231aa495c62947519646d25acb453fd2caf3ed6bf778b41e6201bd3e31fc size: 734</div><div class="line">e6baf59e35e7: Layer already exists</div><div class="line">f9d9e4e6e2f0: Layer already exists</div><div class="line">v0.1.1.1-2: digest: sha256:2f3d6d2f468ee189b4b43ff2b9f99a6e3895d9832b606522176f804cba738037 size: 734</div></pre></td></tr></table></figure><p><img src="/images/docker-vmware-harbor-ssjinyao.png" alt=""></p><p>push é•œåƒå‰å¯ä»¥æŸ¥çœ‹vmware-harborçš„æ‰“æ ‡ç­¾æç¤º</p><p><img src="/images/docker-vmware-harbor-ssjinyao-devel.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker-compose pause æš‚åœ</div><div class="line"># docker-compose unpause è¿è¡Œ</div><div class="line"># docker-compose stop åœæ­¢</div><div class="line"># docker-compose start å¯åŠ¨</div></pre></td></tr></table></figure><h2 id="docker-èµ„æºé™åˆ¶"><a href="#docker-èµ„æºé™åˆ¶" class="headerlink" title="docker èµ„æºé™åˆ¶"></a>docker èµ„æºé™åˆ¶</h2><p>OOME<br>ä¸€æ—¦å‘ç”ŸOOMEï¼Œä»»ä½•è¿›ç¨‹éƒ½æœ‰å¯èƒ½è¢«æ€æ­»ï¼ŒåŒ…æ‹¬docker daemonåœ¨å†…<br>ä¸ºæ­¤ï¼ŒDokcerç‰¹åœ°è°ƒæ•´äº†docker daemonçš„OOMä¼˜å…ˆçº§ï¼Œä»¥åå®ƒè¢«å†…æ ¸â€æ­£æ³•â€<br>ä½†å®¹å™¨çš„ä¼˜å…ˆçº§å¹¶æœªè¢«è°ƒæ•´</p><table><thead><tr><th style="text-align:center">â€“memory-swap</th><th style="text-align:center">â€“memory</th><th style="text-align:center">åŠŸèƒ½</th></tr></thead><tbody><tr><td style="text-align:center">æ­£æ•°S</td><td style="text-align:center">æ­£æ•°M</td><td style="text-align:center">å®¹å™¨å¯ç”¨æ€»ç©ºé—´ä¸ºS,å…¶ä¸­ramä¸ºM,swapä¸º(S-M)è‹¥S=M,åˆ™æ— å¯ç”¨swapèµ„æº</td></tr><tr><td style="text-align:center">0</td><td style="text-align:center">æ­£æ•°M</td><td style="text-align:center">ç›¸å½“äºæœªè®¾ç½® swap(unset)</td></tr><tr><td style="text-align:center">unset</td><td style="text-align:center">æ­£æ•°M</td><td style="text-align:center">è‹¥ä¸»æœº(Docker Host)å¯ç”¨äº†swap,åˆ™å®¹å™¨çš„å¯ç”¨swapä¸º2*M</td></tr><tr><td style="text-align:center">-1</td><td style="text-align:center">æ­£æ•°M</td><td style="text-align:center">è‹¥ä¸»æœº(Docker Host)å¯ç”¨äº†swap,åˆ™å®¹å™¨å¯ä½¿ç”¨æœ€å¤§è‡³ä¸»æœºä¸Šæ‰€çš„æ‰€æœ‰swapç©ºé—´çš„èµ„æº</td></tr><tr><td style="text-align:center">æ³¨æ„: åœ¨å®¹å™¨ä½¿ç”¨freeå‘½ä»¤å¯ä»¥çœ‹åˆ°çš„swapç©ºé—´å¹¶ä¸æ˜¯å…·æœ‰å…¶æ‰€å±•ç°å‡ºçš„ç©ºé—´æŒ‡ç¤ºæ„ä¹‰</td></tr></tbody></table><p>pull ä¸€ä¸ªå‹æµ‹é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># docker pull lorel/docker-stress-ng</div><div class="line"># docker run --name stress -it --rm lorel/docker-stress-ng:latest stress --help</div><div class="line"># docker run --name stree -it --rm -m 256m lorel/docker-stress-ng:latest stress --vm 2</div></pre></td></tr></table></figure><p>æŸ¥çœ‹å¯ç”¨çš„dockerè¿›ç¨‹</p><p><img src="/images/docker-top-stress.png" alt=""></p><p>æŸ¥çœ‹stress å®¹å™¨çš„åˆ†é…å†…å­˜çŠ¶æ€ </p><p><img src="/images/docker-status-stee.png" alt=""></p><p>åŒæ ·çš„ï¼Œå½“å¯¹cpuåšå‹æµ‹æ—¶ï¼ŒæŒ‡å®šä¸Šé™ä¸ºä¸¤ä¸ªcpuï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ç‡ä¸º200%ï¼Œå½“å‹æµ‹ä¸º8ä¸ªcpuæ—¶ï¼Œcpuæœ€é«˜å ç”¨ä¸º200%  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># docker run --name stress -it --rm --cpus 2 lorel/docker-stress-ng:latest stress --cpu 8</div><div class="line"># docker run --name stress -it --cpuset-cpus 0,2 --rm lorel/docker-stress-ng:latest stress --cpu 8  #è®¾å®šåªè¿è¡Œåœ¨ç¬¬0å’Œ2ä¸ªcpuä¸Š</div><div class="line"># docker run --name stress -it --cpus 2 --rm lorel/docker-stress-ng:latest stresss --cpu8 #è®¾å®šcpus 2 ï¼Œè¯´æ˜æ‰€æœ‰æ ¸å¿ƒéƒ½èƒ½ç”¨åˆ°ï¼Œä½†æ˜¯æœ€å¤šåªèƒ½ä½¿ç”¨200%</div><div class="line"># docker run --name stress -it --cpu-shares 1024 --rm lorel/docker-stress-ng:latest stress --cpu 8 </div><div class="line"># è®¾å®šé™åˆ¶ä¸ºå°½å¯èƒ½å¤šçš„åˆ†é…cpuèµ„æº,æœ€åè¿™ç§æ¨¡å¼ï¼Œå½“å†å¯ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œä¼šå®æ—¶æŒ‰æ¯”ä¾‹åˆ†é…cpuèµ„æºåˆ†åˆ°å¦ä¸€ä¸ªå®¹å™¨ï¼Œ</div><div class="line"># docker run --name stress2 -it --cpu-shares 512 --rm lorel/docker-stress-ng:latest stress --cpu 8</div></pre></td></tr></table></figure><p><img src="/images/docker-strees-two-shares.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>dockerç¬”è®°(ä¸€)</title>
      <link href="/2018/09/28/docker%E7%AC%94%E8%AE%B0%E4%B8%80/"/>
      <url>/2018/09/28/docker%E7%AC%94%E8%AE%B0%E4%B8%80/</url>
      <content type="html"><![CDATA[<h1 id="dockerç¬”è®°-ä¸€"><a href="#dockerç¬”è®°-ä¸€" class="headerlink" title="dockerç¬”è®°(ä¸€)"></a>dockerç¬”è®°(ä¸€)</h1><p><img src="/images/docker-images.png" alt=""></p><h2 id="Virtualization-And-Container"><a href="#Virtualization-And-Container" class="headerlink" title="Virtualization And Container"></a>Virtualization And Container</h2><h3 id="ä¸»æœºçº§è™šæ‹ŸåŒ–"><a href="#ä¸»æœºçº§è™šæ‹ŸåŒ–" class="headerlink" title="ä¸»æœºçº§è™šæ‹ŸåŒ–"></a>ä¸»æœºçº§è™šæ‹ŸåŒ–</h3><ol><li>Type-I ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šåšè™šæ‹ŸåŒ–;</li><li>Type-II å¯åŠ¨ç³»ç»Ÿåï¼Œå†åšè™šæ‹ŸåŒ–;</li><li>çœŸæ­£èƒ½äº§ç”Ÿç”Ÿäº§åŠ›çš„ï¼Œæ˜¯åº”ç”¨å±‚é¢;</li><li>ç³»ç»Ÿè¿è¡Œä¸¤é¢—æ ‘:è¿›ç¨‹æ ‘å’Œæ–‡ä»¶ç³»ç»Ÿæ ‘;</li><li>åŸºäºç”¨æˆ·å±‚é¢çš„éš”ç¦»(UTS,Mount,IPC,PID,User,Net);</li><li>namespaces:åç§°ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨ï¼Œå‘å¤–è¾“å‡º(clone(),setns());</li></ol><h3 id="Linux-Namespaces"><a href="#Linux-Namespaces" class="headerlink" title="Linux Namespaces"></a>Linux Namespaces</h3><table><thead><tr><th>namespace</th><th>ç³»ç»Ÿè°ƒç”¨å‚æ•°</th><th>éš”ç¦»å†…å®¹</th><th>å†…æ ¸ç‰ˆæœ¬</th></tr></thead><tbody><tr><td>UTS</td><td>CLONE_NEWUTS</td><td>ä¸»æœºåå’ŒåŸŸå</td><td>2.6.19</td></tr><tr><td>IPC</td><td>CLONE_NEWIPC</td><td>ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œå…±äº«å†…å­˜</td><td>2.6.19</td></tr><tr><td>PID</td><td>CLONE_NEWPID</td><td>è¿›ç¨‹ç¼–å·</td><td>2.6.24</td></tr><tr><td>Network</td><td>CLONE_NEWNET</td><td>ç½‘ç»œè®¾å¤‡ã€ç½‘ç»œæ ˆã€ç«¯å£å·ç­‰</td><td>2.6.29</td></tr><tr><td>Mount</td><td>CLONE_NEWNS</td><td>æŒ‚è½½ç‚¹(æ–‡ä»¶ç³»ç»Ÿ)</td><td>2.4.19</td></tr><tr><td>User</td><td>CLONE_NEWUSER</td><td>ç”¨æˆ·å’Œç”¨æˆ·ç»„</td><td>3.8</td></tr></tbody></table><h3 id="Control-Groups-cGroups"><a href="#Control-Groups-cGroups" class="headerlink" title="Control Groups(cGroups)"></a>Control Groups(cGroups)</h3><p>æŠŠç³»ç»Ÿçº§çš„èµ„æºåˆ†æˆå¤šä¸ªç»„ </p><hr><ul><li>lxc-create,template</li><li>nmp</li><li>machine+swarm+compose </li><li>mesos+marathon</li><li>kubernetes -&gt; k8s</li><li>libcontainer -&gt; runC</li><li>Moby, CNCF</li><li>dockerä¸­çš„å®¹å™¨<br>  lxc -&gt; libcontainer -&gt; runC  </li><li>OCI Open Container Initiative<br>  æ—¨åœ¨å›´ç»•å®¹å™¨å¼å’Œè¿è¡Œæ—¶åˆ¶å®šä¸€ä¸ªå¼€æ”¾çš„å¼ä¸šåŒ–æ ‡å‡†<br>  the Runtime Specification(runtime-spec)<br>  the Image Specification(image-spec)  </li><li>runC Open Container Format  </li></ul><p><code>https:hub.docker.com</code></p><ul><li>docker çš„ä¸¤ä¸ªç‰ˆæœ¬<br>docker-ee<br>docker-ce</li><li>docker architecture<br>  The Docker daemon<br>  The Docker client<br>  Docker registries</li><li>yum ä¸­çš„ä»“åº“ repository,repo </li><li><p>docker ä¸­çš„ä»“åº“ repository, repo<br>é•œåƒåç§°  nginx:1.10  ä»¥æ­¤æ¥å‘½ä»¤é•œåƒï¼Œnginx:1.15 nginx:latest è€Œé•œåƒçš„é»˜è®¤ç‰ˆæ˜¯æœ€æ–°ç‰ˆçš„<br>nginx:1.14 nginx:stable  æœ€æ–°ç¨³å®šç‰ˆ<br>é•œåƒï¼šé™æ€;<br>å®¹å™¨ï¼šåŠ¨æ€ï¼Œæœ‰ç”Ÿå‘½å‘¨æœŸï¼Œç‰¹åˆ«ç±»ä¼¼äºç¨‹åº;<br>å®¹å™¨å¸¸ç”¨èµ„æº: images, containers, networks, volumes, plugins,</p><h2 id="å®‰è£…åŠä½¿ç”¨docker"><a href="#å®‰è£…åŠä½¿ç”¨docker" class="headerlink" title="å®‰è£…åŠä½¿ç”¨docker"></a>å®‰è£…åŠä½¿ç”¨docker</h2></li><li><p>ä¾èµ–çš„ç¯å¢ƒ<br>  64 bits CPU<br>  Linux Kernel 3.10+<br>  Linux Kernel cgrups and namespace </p></li><li><p>CentOS 7<br>  â€œExtrasâ€ repository </p></li><li><p>Docker Daemon<br>  systemctl start docker.service</p></li><li><p>Docker Client<br>  docker[OPTIONS] COMMAND [arg â€¦]</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#  cd /etc/yum.repos.d/</div><div class="line"># wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</div><div class="line"># yum makecache</div><div class="line"># yum repolist</div><div class="line"># yum remove docker docker-common container-selinux docker-selinux docker-engine</div><div class="line"># yum install docker-ce</div></pre></td></tr></table></figure><p>ä»“åº“é…ç½®æ–‡ä»¶: <a href="https://dowland.docker.com/linux/centos/docker-ce.repo" target="_blank" rel="external">https://dowland.docker.com/linux/centos/docker-ce.repo</a></p><p>Dockerç»„ä»¶:</p><p>dockerç¨‹åºç¯å¢ƒ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ç¯å¢ƒé…ç½®æ–‡ä»¶:</div><div class="line">    /etc/sysconfig/docker-network</div><div class="line">    /etc/sysconfig/docker-storage</div><div class="line">    /etc/sysconfig/docker</div><div class="line">Unit FIle:</div><div class="line">    /usr/lib/systemd/system/docker.serivce</div><div class="line">Docker Registryé…ç½®æ–‡ä»¶</div><div class="line">    /etc/contalners/registries.conf </div><div class="line">docker-ce:</div><div class="line">    é…ç½®æ–‡ä»¶:/etc/docker/daemon.json</div></pre></td></tr></table></figure><p>æ³¨å†Œé˜¿é‡Œäº‘è´¦å·ï¼Œä¸“ç”¨åŠ é€Ÿå™¨åœ°å€è·å¾—è·¯å¾„:<br>    <a href="https://cr.console.aliyun.com/#/accelerator" target="_blank" rel="external">https://cr.console.aliyun.com/#/accelerator</a></p><p>Dockeré•œåƒåŠ é€Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">    docker cn </div><div class="line">    é˜¿é‡Œäº‘åŠ é€Ÿå™¨ </div><div class="line">    ä¸­å›½ç§‘æŠ€å¤§å­¦</div><div class="line">&#123; </div><div class="line">    &quot;registry-mirrors&quot;:[&quot;https://registry.docker-cn.com&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># mkdir /etc/docker</div><div class="line"># vim /etc/docker/daemon.json</div><div class="line">&#123;</div><div class="line">    &quot;registry-mirrors&quot;:[&quot;https://registry.docker-cn.com&quot;]</div><div class="line">&#125;</div><div class="line"># systemctl start docker</div></pre></td></tr></table></figure><p>æŸ¥çœ‹docker ç‰ˆæœ¬ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># docker version</div><div class="line">Client:</div><div class="line"> Version:           18.06.1-ce</div><div class="line"> API version:       1.38</div><div class="line"> Go version:        go1.10.3</div><div class="line"> Git commit:        e68fc7a</div><div class="line"> Built:             Tue Aug 21 17:23:03 2018</div><div class="line"> OS/Arch:           linux/amd64</div><div class="line"> Experimental:      false</div><div class="line"></div><div class="line">Server:</div><div class="line"> Engine:</div><div class="line">  Version:          18.06.1-ce</div><div class="line">  API version:      1.38 (minimum version 1.12)</div><div class="line">  Go version:       go1.10.3</div><div class="line">  Git commit:       e68fc7a</div><div class="line">  Built:            Tue Aug 21 17:25:29 2018</div><div class="line">  OS/Arch:          linux/amd64</div><div class="line">  Experimental:     false</div><div class="line"># docker info</div></pre></td></tr></table></figure><h2 id="å¸¸ç”¨æ“ä½œ"><a href="#å¸¸ç”¨æ“ä½œ" class="headerlink" title="å¸¸ç”¨æ“ä½œ"></a>å¸¸ç”¨æ“ä½œ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">docker search : æœç´¢é•œåƒ</div><div class="line"># docker search nginx</div><div class="line">docker pull: ä¸‹è½½é•œåƒåˆ°æœ¬åœ°</div><div class="line"># docker pull nginx:1.14-alpine-perl</div><div class="line"># docker pull busybox:latest</div><div class="line"># docker image pull nginx:1.14-alpine-perl</div><div class="line"># docker </div><div class="line">docker images: åˆ—å‡ºæœ¬åœ°é•œåƒ </div><div class="line"># docker images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">nginx               1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</div><div class="line">busybox             latest              e1ddd7948a1c        8 weeks ago         1.16MB</div><div class="line"># docker image rm a47b6006585d  # åˆ é™¤é•œåƒ</div><div class="line"># docker images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">busybox             latest              e1ddd7948a1c        8 weeks ago         1.16MB</div><div class="line"># docker image ls --no-trunc # åˆ—å‡ºå®Œæ•´image idä¿¡æ¯</div><div class="line">REPOSITORY          TAG                 IMAGE ID                                                                  CREATED             SIZE</div><div class="line">nginx               1.14-alpine-perl    sha256:a47b6006585d03b999ee55c6eec4331430fb2bcddb5ce8f76f294cc997482ca2   2 weeks ago         51.6MB</div><div class="line">busybox             latest              sha256:e1ddd7948a1c31709a23cc5b7dfe96e55fc364f90e1cebcde0773a1b5a30dcda   8 weeks ago         1.16MB</div><div class="line"># docker container ls # åˆ—å‡ºæ‰€æœ‰å®¹å™¨</div><div class="line"># docker ps: åˆ—å‡ºæ‰€æœ‰å®¹å™¨</div><div class="line"># docker images: åˆ—å‡ºæ‰€æœ‰é•œåƒ</div><div class="line"># docker create: åˆ›å»ºæ–°çš„container</div><div class="line"># docker start: Start one or more stopped contaners</div><div class="line"># docker run: Run a command in a new container</div><div class="line"># docker attacth: Attach to a running container</div><div class="line"># docker ps: List containers</div></pre></td></tr></table></figure><p>apline: èƒ½å¤Ÿèƒ½ç¨‹åºæä¾›åŸºç¡€ç¯å¢ƒï¼Œä½†æ˜¯ä½“ç§¯éå¸¸å°ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸å»ºè®®ä½¿ç”¨aplineç‰ˆ;<br>busybox: èƒ½å¤Ÿç”¨ä¸€ä¸ªbusyboxå®ç°linuxç³»ç»Ÿçš„å¤šä¸ªå‘½ä»¤ï¼Œå½“é“¾æ¥busyboxä¸ºls æ—¶ï¼Œå®ƒå¯ä»¥æ‰§è¡Œlså‘½ä»¤;<br>        é“¾æ¥æˆpwdæ—¶ï¼Œå¯ä»¥å®ç°pwdå‘½ä»¤ã€‚kernel+busyboxå¯ä»¥å®ç°ä¸€ä¸ªå¾®linuxç³»ç»Ÿ;<br>        æ‰€ç•çš„androidç³»ç»Ÿä¹Ÿæ˜¯linux+busybox+jvmæ‰€è¿è¡Œçš„ç³»ç»Ÿ;</p><h2 id="å®¹å™¨ä½¿ç”¨"><a href="#å®¹å™¨ä½¿ç”¨" class="headerlink" title="å®¹å™¨ä½¿ç”¨"></a>å®¹å™¨ä½¿ç”¨</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># docker run --name b2 -it busybox:latest</div><div class="line">/ #</div><div class="line"># docker run --name b1 -it busybox:latest</div><div class="line">/ # mkdir /data/www -p</div><div class="line">/ # vi /data/www/index.html</div><div class="line">&lt;h1&gt;www.ssjinyao.com&lt;/h1&gt;</div><div class="line">/ # httpd -f -h /data/www/</div><div class="line"># docker inspect b1 # æŸ¥çœ‹ docker å®¹å™¨çš„å¯åŠ¨ä¿¡æ¯ </div><div class="line"># åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è®¿é—®  curl 172.17.0.2</div><div class="line">&lt;h1&gt;www.ssjinyao.com&lt;/h1&gt;</div></pre></td></tr></table></figure><p>docker å†å¯åŠ¨ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES</div><div class="line">57c80d23f0e5        busybox:latest      &quot;sh&quot;                6 minutes ago       Exited (130) 4 minutes ago                       b1</div><div class="line"># docker container start -i -a b1</div></pre></td></tr></table></figure><p>docker å®¹å™¨ç»ˆæ­¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker kill b1</div><div class="line"># docker stop b1</div></pre></td></tr></table></figure><p>docker å¯åŠ¨nginxé•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># docker run --name web1 -d nginx:1.14-alpine-perl </div><div class="line"># docker inspect web1</div><div class="line"># [root@ssjinyao-node1:~]# curl 172.17.0.2</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</div><div class="line">&lt;style&gt;</div><div class="line">    body &#123;</div><div class="line">        width: 35em;</div><div class="line">        margin: 0 auto;</div><div class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</div><div class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</div><div class="line">working. Further configuration is required.&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p&gt;For online documentation and support please refer to</div><div class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</div><div class="line">Commercial support is available at</div><div class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure><p>æ³¨: ä¸€ä¸ªå®¹å™¨å°±æ˜¯ä¸ºäº†è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œå¦‚æœç¨‹åºè·‘åå°è¿è¡Œï¼Œé‚£ä¹ˆå®¹å™¨è®¤ä¸ºç¨‹åºç»ˆæ­¢äº†ã€‚<br>å› ä¸ºï¼Œå¦‚æœç¨‹åºåœ¨å®¹å™¨è¿è¡Œåœ¨åå°ï¼Œé‚£ä¹ˆç¨‹åºä¸€å¯åŠ¨ï¼Œå®¹å™¨å°±ä¼šç»ˆæ­¢ã€‚<br>ç›´æ¥æœç´¢ä¸‹è½½é•œåƒå¹¶è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker run --name kvstor1 -d redis:4-alpine</div></pre></td></tr></table></figure><p>ç»•è¿‡å®¹å™¨çš„è¾¹ç•Œï¼Œäº¤äº’å¼æ¥å…¥è¿›å» </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># docker exec -it  kvstor1 /bin/sh</div><div class="line">/data # ps</div><div class="line">PID   USER     TIME  COMMAND</div><div class="line">    1 redis     0:00 redis-server</div><div class="line">   12 root      0:00 /bin/sh</div><div class="line">   16 root      0:00 ps</div></pre></td></tr></table></figure><p>æŸ¥çœ‹dockerå¯åŠ¨å®¹å™¨åçš„æ—¥å¿—ä¿¡æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker logs web1</div></pre></td></tr></table></figure><p>docker event state<br><img src="/images/docker-event-state.png" alt=""></p><h2 id="Docker-é•œåƒçš„ä½¿ç”¨ä¸ç®¡ç†"><a href="#Docker-é•œåƒçš„ä½¿ç”¨ä¸ç®¡ç†" class="headerlink" title="Docker é•œåƒçš„ä½¿ç”¨ä¸ç®¡ç†"></a>Docker é•œåƒçš„ä½¿ç”¨ä¸ç®¡ç†</h2><p>Docker:ç å¤´å·¥äºº<br>ä¸€èˆ¬æˆ‘ä»¬éƒ¨ç½²åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬éƒ½æ˜¯æ•£è£…çš„ã€‚è€Œdockerå¯ä»¥è¿›è¡Œé›†è£…çš„;</p><p>Docker é•œåƒå«æœ‰å¯åŠ¨å®¹å™¨æ‰€éœ€è¦çš„æ–‡ä»¶ç³»ç»ŸåŠå…¶å†…å®¹ï¼Œå› æ­¤ï¼Œå…¶ç”¨äºåˆ›å»ºå¹¶å¯åŠ¨dockerå®¹å™¨  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">é‡‡ç”¨åˆ†å±‚æ„å»ºæœºåˆ¶ï¼Œæœ€åº•å±‚ä¸ºbootfs,å…¶ä¹‹ä¸ºrootfs  </div><div class="line">    bootfs: ç”¨äºç³»ç»Ÿå¼•å¯¼çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬bootloaderå’Œkernelï¼Œ</div><div class="line">        å®¹å™¨å¯åŠ¨å®Œæˆåä¼šè¢«å¸è½½ä»¥èŠ‚çº¦å†…åœ¨èµ„æº </div><div class="line">    rootfs: ä½äºbootfsä¹‹ä¸Šï¼Œè¡¨ç°ä¸ºdockerå®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ:</div><div class="line">        ä¼ ç»Ÿæ¨¡å¼ä¸­ï¼Œç³»ç»Ÿå¯åŠ¨ä¹‹æ—¶ï¼Œå†…æ ¸æŒ‚è½½rootfsæ—¶ä¼šé¦–å…ˆå°†å…¶æŒ‚è½½ä¸º&quot;åªè¯»&quot;æ¨¡å¼,</div><div class="line">        å®Œæ•´æ€§è‡ªæ£€åå°†å…¶é‡æ–°æŒ‚è½½ä¸ºè¯»å†™æ¨¡å¼;</div><div class="line">        dockerä¸­,rootfsç”±å†…æ ¸æŒ‚è½½ä¸º&quot;åªè¯»&quot;æ¨¡å¼ï¼Œè€Œåé€šè¿‡&quot;è”åˆæŒ‚è½½&quot;æŠ€æœ¯é¢å¤–æä¾›ä¸€ä¸ªå¯å†™å±‚;</div></pre></td></tr></table></figure><p>Aufs: advnaced multi-layered unification filesystem: é«˜çº§å¤šå±‚ç»Ÿä¸€æ–‡ä»¶ç³»ç»Ÿ<br>CentOS ä¸ºæ±‚ç¨³å®šï¼Œä¸æ•´åˆæ­¤æ–‡ä»¶ç³»ç»Ÿ<br>overlayfs ä»3.18ç‰ˆæœ¬å¼€å§‹è¢«åˆå¹¶åˆ°Linuxå†…æ ¸;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># docker info # å¯ä»¥çœ‹å‡ºå‰ç«¯ç”¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯overlay2ï¼Œè€Œåç«¯ç”¨çš„æ˜¯xfs </div><div class="line"> Storage Driver: overlay2</div><div class="line"> Backing Filesystem: xfs</div></pre></td></tr></table></figure><h2 id="Docker-Registry"><a href="#Docker-Registry" class="headerlink" title="Docker Registry"></a>Docker Registry</h2><p>å¯åŠ¨å®¹å™¨æ—¶ï¼Œdocker daemon ä¼šè¯•å›¾ä»æœ¬åœ°è·å–é•œåƒ; æœ¬åœ°é•œåƒä¸å­˜åœ¨æ—¶ å°†Registry ä¸­çš„é•œåƒä¸‹è½½ä¿å­˜åˆ°æœ¬åœ°;</p><p>Docker Registry åˆ†ç±»<br>Registryç”¨äºä¿å­˜dockeré•œåƒï¼ŒåŒ…æ‹¬é•œåƒçš„å±‚æ¬¡ç»“æ„å’Œå…ƒæ•°æ®;<br>ç”¨æˆ·å¯è‡ªå»ºRegistryï¼Œä¹Ÿå¯ä»¥ç”¨å®˜æ–¹çš„Docker Hub</p><p>åˆ†ç±»<br>Sponsor Registry: ç¬¬ä¸‰æ–¹çš„registry, ä¾›å®¢æˆ·å’ŒDockerç¤¾åŒºä½¿ç”¨<br>Mirror Registry: ç¬¬ä¸‰æ–¹çš„registry,åªè®©å®¢æˆ·ä½¿ç”¨<br>Vendor Registry: ç”±å‘å¸ƒDockeré•œåƒçš„ä¾›åº”å•†æä¾›çš„registry<br>Private Rgeistry: é€šè¿‡è®¾æœ‰é˜²ç«å¢™å’Œå®¢å¤–çš„å®‰å…¨å±‚çš„ç§æœ‰å®ä½“æä¾›çš„registry</p><p>Repository</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ç”±æŸç‰¹å®šçš„dockeré•œåƒçš„æ‰€æœ‰è¿­ä»£ç‰ˆæœ¬ç»„æˆçš„é•œåƒä»“åº“</div><div class="line">ä¸€ä¸ªRegistryä¸­å¯èƒ½å­˜åœ¨å¤šä¸ªRepository</div><div class="line">    Repository å¯åˆ†ä¸º&quot;é¡¶å±‚ä»“åº“&quot; å’Œ &quot;ç”¨æˆ·ä»“åº“&quot;</div><div class="line">    ç”¨æˆ·ä»“åº“åç§°æ ¼å¼ä¸º&quot;ç”¨æˆ·å/ä»“åº“å&quot;</div><div class="line">æ¯ä¸ªä»“åº“å¯ä»¥åŒ…å«å¤šä¸ªTag(æ ‡ç­¾)ï¼Œæ¯ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ªé•œåƒ</div></pre></td></tr></table></figure><p>Index</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ç»´æŠ¤ç”¨æˆ·å¸æˆ·ã€é•œåƒçš„æ ¡éªŒä»¥åŠå…¬å…±å‘½åç©ºé—´çš„ä¿¡æ¯; </div><div class="line">ç›¸å½“äºä¸ºRegistryæ    ç›¸å½“äºä¸ºRegistryæä¾›äº†ä¸€ä¸ªå®Œæˆç”¨æˆ·è®¤è¯ç­‰åŠŸèƒ½</div></pre></td></tr></table></figure><p>Docker Registryä¸­çš„é•œåƒé€šå¸¸ç”±å¼€å‘äººå‘˜åˆ¶ä½œï¼Œè€Œåæ¨é€è‡³â€å…¬å…±â€æˆ–â€ç§æœ‰â€Registryä¸Šä¿å­˜;<br>ä¾›å…¶ä»–äººå‘˜ä½¿ç”¨ï¼Œä¾‹å¦‚â€éƒ¨ç½²â€åˆ°ç”Ÿäº§ç¯å¢ƒ;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker pull registry&gt;[:&lt;prot&gt;]/[&lt;namespace&gt;/]&lt;name&gt;:&lt;tag&gt;</div></pre></td></tr></table></figure><p><a href="https://quay.io/repository/coreos/flannel" target="_blank" rel="external">quay.io</a> ä¹Ÿå¯ä»¥ä¸‹è½½å¤šç§é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker pull quay.io/coreos/flannel:v0.10.0-amd64 #æŒ‡å®šç«™ç‚¹pullé•œåƒ</div></pre></td></tr></table></figure><h2 id="é•œåƒåˆ¶ä½œ"><a href="#é•œåƒåˆ¶ä½œ" class="headerlink" title="é•œåƒåˆ¶ä½œ"></a>é•œåƒåˆ¶ä½œ</h2><p>é•œåƒçš„ç”Ÿæˆé€”å¾„<br>Dockerfile<br>åŸºäºå®¹å™¨åˆ¶ä½œ<br>Docker Hub automated builds</p><table><thead><tr><th style="text-align:center">Namespace</th><th style="text-align:center">Example(<namespace>/<name>)</name></namespace></th></tr></thead><tbody><tr><td style="text-align:center">organization</td><td style="text-align:center">redhat/kubernets</td></tr><tr><td style="text-align:center">login(user name)</td><td style="text-align:center">alice/application, bob/application</td></tr><tr><td style="text-align:center">role</td><td style="text-align:center">devel/database, test/database, prod/database</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># docker container run --name busybox1 -it busybox</div><div class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</div><div class="line">/ #</div><div class="line">/ #</div><div class="line">/ # mkdir  -p /data/html</div><div class="line">/ # echo &quot;&lt;h1&gt;www.ssjinyao.com&lt;/h1&gt;&quot; &gt; /data/html/index.html</div></pre></td></tr></table></figure><p>æš‚æ—¶ä¸å…³é—­å®¹å™¨ï¼Œå†æ‰“å¼€ä¸€ä¸ªç»ˆç«¯æ¥åˆ¶ä½œé•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># docker commit -p busybox1</div><div class="line"># docker image ls</div><div class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">&lt;none&gt;                   &lt;none&gt;              d5ab408117c0        8 seconds ago       1.16MB</div><div class="line">redis                    4-alpine            db23f46600bc        2 weeks ago         30MB</div><div class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</div><div class="line">busybox                  latest              e1ddd7948a1c        2 months ago        1.16MB</div><div class="line">quay.io/coreos/flannel   v0.10.0-amd64       f0fad859c909        8 months ago        44.6MB</div><div class="line"># å†ç»™æ ‡ç­¾æ‰“æ ‡ç­¾</div><div class="line"># docker tag d5ab408117c0 ssjinyao/httpd:v0.1.1-1</div><div class="line"># docker image ls</div><div class="line">REPOSITORY               TAG                 IMAGE ID            CREATED              SIZE</div><div class="line">ssjinyao/httpd           v0.1.1-1            d5ab408117c0        About a minute ago   1.16MB</div><div class="line">redis                    4-alpine            db23f46600bc        2 weeks ago          30MB</div><div class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago          51.6MB</div><div class="line">busybox                  latest              e1ddd7948a1c        2 months ago         1.16MB</div><div class="line">quay.io/coreos/flannel   v0.10.0-amd64       f0fad859c909        8 months ago         44.6MB</div><div class="line"># docker tag ssjinyao/httpd:v0.1.1-1 ssjinyao/httpd:latest</div><div class="line"># docker image ls</div><div class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">ssjinyao/httpd           latest              d5ab408117c0        3 minutes ago       1.16MB</div><div class="line">ssjinyao/httpd           v0.1.1-1            d5ab408117c0        3 minutes ago       1.16MB</div></pre></td></tr></table></figure><p>ä¸€ä¸ªIMAGE ID å¯¹åº”å¤šä¸ªTagæ—¶ï¼Œåˆ é™¤ Tag ä¸ä¼šåˆ é™¤é•œåƒï¼Œè€Œåƒè½¯é“¾ä¸€ä¸‹ï¼Œåˆ é™¤é“¾æ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># docker image rm ssjinyao/httpd:latest</div><div class="line">Untagged: ssjinyao/httpd:latest</div><div class="line"># docker image ls</div><div class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">ssjinyao/httpd           v0.1.1-1            d5ab408117c0        5 minutes ago       1.16MB</div><div class="line">redis                    4-alpine            db23f46600bc        2 weeks ago         30MB</div><div class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</div><div class="line">busybox                  latest              e1ddd7948a1c        2 months ago        1.16MB</div><div class="line">quay.io/coreos/flannel   v0.10.0-amd64       f0fad859c909        8 months ago        44.6MB</div><div class="line"># docker tag ssjinyao/httpd:v0.1.1-1 ssjinyao/httpd:latest</div><div class="line"># docker images</div><div class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">ssjinyao/httpd           latest              d5ab408117c0        6 minutes ago       1.16MB</div><div class="line">ssjinyao/httpd           v0.1.1-1            d5ab408117c0        6 minutes ago       1.16MB</div><div class="line">redis                    4-alpine            db23f46600bc        2 weeks ago         30MB</div><div class="line">nginx                    1.14-alpine-perl    a47b6006585d        2 weeks ago         51.6MB</div><div class="line">busybox                  latest              e1ddd7948a1c        2 months ago        1.16MB</div><div class="line">quay.io/coreos/flannel   v0.10.0-amd64       f0fad859c909        8 months ago        44.6MB</div></pre></td></tr></table></figure><p>åˆ¶ä½œé•œåƒåŠ å…¥CommandæŒ‡ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># docker commit -a &quot;ssjinyao&quot; -c &apos;CMD [&quot;/bin/httpd&quot;, &quot;-f&quot;, &quot;-h&quot;,&quot;/data/html&quot;]&apos; -p busybox1 ssjinyao/httpd:v0.1.1.1-2</div><div class="line"># docker image ls</div><div class="line">REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">ssjinyao/httpd           v0.1.1.1-2          0ec8103a1bb2        53 seconds ago      1.16MB</div><div class="line"># docker run --name busybox2 ssjinyao/httpd:v0.1.1.1-2 # è‚¯æ®åˆ›å»ºçš„é•œåƒå¯åŠ¨å®¹å™¨</div><div class="line"></div><div class="line"># docker container ls</div><div class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div class="line">27403687efa0        ssjinyao/httpd:v0.1.1.1-2   &quot;/bin/httpd -f -h /dâ€¦&quot;   30 seconds ago      Up 29 seconds                           busybox2</div><div class="line">6373ae374a7a        redis:4-alpine              &quot;docker-entrypoint.sâ€¦&quot;   4 days ago          Up 4 days           6379/tcp            kvstor1</div><div class="line">a5ffdd373b90        nginx:1.14-alpine-perl      &quot;nginx -g &apos;daemon ofâ€¦&quot;   4 days ago          Up 4 days           80/tcp              web1</div><div class="line"># docker inspect # æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</div><div class="line"># curl  172.17.0.4</div><div class="line">&lt;h1&gt;www.ssjinyao.com&lt;/h1&gt;</div></pre></td></tr></table></figure><p>åœ¨ <a href="https://hub.docker.com/" target="_blank" rel="external">docker hub</a> å»ºç«‹å¸å·ï¼Œå¹¶åˆ›å»ºREPOSITORY</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># docker login -u ssjinyao</div><div class="line">Password:</div><div class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</div><div class="line">Configure a credential helper to remove this warning. See</div><div class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</div><div class="line"></div><div class="line">Login Succeeded</div></pre></td></tr></table></figure><p>å¾€ hub.docker.com ä¸Šé¢æ¨é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker push ssjinyao/httpd</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šä¼ çš„é•œåƒ</p><p><img src="/images/docker-push.png" alt=""></p><p><a href="https://dev.aliyun.com" target="_blank" rel="external">å›½å†…æ¯”è¾ƒå¸¸ç”¨çš„é•œåƒåœ°å€</a><br>åœ¨é˜¿é‡Œäº‘docker é•œåƒç«™ç‚¹ä¸­åˆ›å»ºREPOSITORY<br>ä¸Šä¼ æœ¬åœ°çš„é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># docker tag ssjinyao/httpd:v0.1.1.1-2 registry.cn-qingdao.aliyuncs.com/ssjinyao/httpd</div><div class="line"># docker logout</div><div class="line">Removing login credentials for https://index.docker.io/v1/</div><div class="line"></div><div class="line"># docker login --username=ssjinyao registry.cn-qingdao.aliyuncs.com</div><div class="line">Password:</div><div class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</div><div class="line">Configure a credential helper to remove this warning. See</div><div class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</div><div class="line"></div><div class="line">Login Succeeded</div><div class="line"># docker push registry.cn-qingdao.aliyuncs.com/ssjinyao/httpd</div></pre></td></tr></table></figure><p><img src="/images/docker-image-pull-aliyun.png" alt=""></p><p>docker é•œåƒçš„å¯¼å…¥å’Œå¯¼å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker save -o ssjinyao-busybox-image.gz ssjinyao/httpd:v0.1.1.1-3 ssjinyao/httpd:v0.1.1.1-2</div><div class="line"># å°†é•œåƒå¤åˆ¶åˆ°å¦ä¸€å°æœåŠ¡å™¨</div><div class="line"># scp ssjinyao-busybox-image.gz root@node2:/root/</div><div class="line">ssjinyao-busybox-image.gz                                                  100% 1370KB  23.8MB/s   00:00</div></pre></td></tr></table></figure><p>åœ¨å¦ä¸€å°æœåŠ¡å™¨ä¸Šå¯¼å…¥é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># docker load -i ssjinyao-busybox-image.gz</div><div class="line">f9d9e4e6e2f0: Loading layer  1.378MB/1.378MB</div><div class="line">e6baf59e35e7: Loading layer  4.608kB/4.608kB</div><div class="line"># docker image ls</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">ssjinyao/httpd      v0.1.1.1-3          cfa66f44c384        About an hour ago   1.16MB</div><div class="line">ssjinyao/httpd      v0.1.1.1-2          3dc1b07020fd        About an hour ago   1.16MB</div><div class="line"># docker run --name busybox  ssjinyao/httpd:v0.1.1.1-2</div><div class="line"># å†å¼€å¯ä¸€ä¸ªç»ˆç«¯</div><div class="line"># # docker inspect busybox | grep &quot;IPAddress&quot;</div><div class="line">            &quot;SecondaryIPAddresses&quot;: null,</div><div class="line">            &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</div><div class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</div><div class="line"># curl  172.17.0.2</div><div class="line">&lt;h1&gt;www.ssjinyao.com&lt;/h1&gt;</div></pre></td></tr></table></figure><h2 id="è™šæ‹ŸåŒ–ç½‘ç»œç®¡ç†"><a href="#è™šæ‹ŸåŒ–ç½‘ç»œç®¡ç†" class="headerlink" title="è™šæ‹ŸåŒ–ç½‘ç»œç®¡ç†"></a>è™šæ‹ŸåŒ–ç½‘ç»œç®¡ç†</h2><p>6ç§åç§°ç©ºé—´: UTS, User, Mount, IPC, Pid, Net;<br>Linux å†…æ ¸æ”¯æŒäºŒå±‚å’Œä¸‰å±‚è®¾å¤‡çš„æ¨¡æ‹Ÿ;<br>OVS: Open VSwitch; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># yum -y install bridge-utils</div><div class="line"># brctl show</div><div class="line">bridge namebridge idSTP enabledinterfaces</div><div class="line">docker08000.024288c640efnoveth5097b16</div><div class="line"># ip link show #å¯ä»¥çœ‹åˆ°dockerè™šæ‹Ÿç½‘å¡ä¿¡</div></pre></td></tr></table></figure><p>åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šå¯åŠ¨ä¸¤ä¸ªå®¹å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># docker start 27403687efa0</div><div class="line"># docker container run --name busybox3 -it ssjinyao/httpd:v0.1.1.1-3</div><div class="line"># æŸ¥çœ‹ä¸¤ä¸ªå®¹å™¨é—´åŸºäºnatçš„é€šä¿¡ </div><div class="line"># docker exec -it busybox2 /bin/sh</div><div class="line">/ # wget -O - -q http://172.17.0.5</div><div class="line">&lt;h1&gt;www.ssjinyao.com&lt;/h1&gt;</div></pre></td></tr></table></figure><p>{User,Mount,Pid}, {User,Mount,Pid} â€“&gt; å…±äº«{UTS,Net,IPC}</p><p>è®©å®¹å™¨ä½¿ç”¨ç®¡ç†å®¿ä¸»æœºçš„ç½‘ç»œåç§°ç©ºé—´</p><p><img src="/images/docker-network.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker network inspect bridge</div></pre></td></tr></table></figure><p>ip åç§°ç©ºé—´ç®¡ç†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># yum -y install iproute</div><div class="line"># ip netns help</div><div class="line">Usage: ip netns list</div><div class="line">       ip netns add NAME</div><div class="line">       ip netns set NAME NETNSID</div><div class="line">       ip [-all] netns delete [NAME]</div><div class="line">       ip netns identify [PID]</div><div class="line">       ip netns pids NAME</div><div class="line">       ip [-all] netns exec [NAME] cmd ...</div><div class="line">       ip netns monitor</div><div class="line">       ip netns list-id</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"># ip netns add r1</div><div class="line"># ip netns add r2</div><div class="line"># ip netns exec r1 ifconfig -a</div><div class="line"># ip link add name veth1.1 type veth peer name veth1.2</div><div class="line"># ip link show | grep veth1</div><div class="line">34: veth1.2@veth1.1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</div><div class="line">35: veth1.1@veth1.2: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000</div><div class="line"># ip link set dev veth1.2 netns r1 # å°†è®¾veth1.2 ç§°åˆ°åç§°ç©ºé—´r1 ä¸­</div><div class="line"># ip netns exec  r1 ifconfig -a</div><div class="line">lo: flags=8&lt;LOOPBACK&gt;  mtu 65536</div><div class="line">        loop  txqueuelen 1  (Local Loopback)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">veth1.2: flags=4098&lt;BROADCAST,MULTICAST&gt;  mtu 1500</div><div class="line">        ether da:2a:32:c9:1e:e2  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"># ip netns exec r1 ip link set dev veth1.2 name eth0 # å°†åç§°ç©ºé—´ä¸­çš„veth1.2æ›´åä¸ºeth0</div><div class="line"># ip netns exec  r1 ifconfig -a</div><div class="line">eth0: flags=4098&lt;BROADCAST,MULTICAST&gt;  mtu 1500</div><div class="line">        ether da:2a:32:c9:1e:e2  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">lo: flags=8&lt;LOOPBACK&gt;  mtu 65536</div><div class="line">        loop  txqueuelen 1  (Local Loopback)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"># ifconfig veth1.1 10.1.0.1/24 up # æ¿€æ´»ç½‘å¡veth1.1</div><div class="line"># ip netns exec r1 ifconfig eth0 10.1.0.2/24 up # æ¿€æ´»r1åç§°ç©ºé—´ä¸­çš„ eth0</div><div class="line"># ip netns exec r1 ifconfig</div><div class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 10.1.0.2  netmask 255.255.255.0  broadcast 10.1.0.255</div><div class="line">        inet6 fe80::d82a:32ff:fec9:1ee2  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether da:2a:32:c9:1e:e2  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 8  bytes 648 (648.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 8  bytes 648 (648.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line"># ping 10.1.0.2</div><div class="line">PING 10.1.0.2 (10.1.0.2) 56(84) bytes of data.</div><div class="line">64 bytes from 10.1.0.2: icmp_seq=1 ttl=64 time=0.945 ms</div><div class="line">64 bytes from 10.1.0.2: icmp_seq=2 ttl=64 time=0.061 ms</div><div class="line"># ip link set dev veth1.1 netns r2 # å°† veth1.1 ç§»åˆ°åç§°ç©ºé—´r2ä¸­</div><div class="line"># ip netns exec r2 ifconfig veth1.1 10.1.0.3/24 up # å¯ç”¨r2åç§°ç©ºé—´ä¸­çš„veth1.1</div><div class="line"># ip netns exec r2 ping 10.1.0.2 # åœ¨åç§°ç©ºé—´r2ä¸­ping åç§°ç©ºé—´r1çš„eth0ç»‘å®šçš„ipåœ°å€</div><div class="line">PING 10.1.0.2 (10.1.0.2) 56(84) bytes of data.</div><div class="line">64 bytes from 10.1.0.2: icmp_seq=1 ttl=64 time=0.214 ms</div><div class="line">64 bytes from 10.1.0.2: icmp_seq=2 ttl=64 time=0.080 ms</div><div class="line"></div><div class="line">--rm  å®¹å™¨åœæ­¢åï¼Œå°†å®¹å™¨åˆ é™¤</div><div class="line"># docker run --name t1 -it --network bridge -h www.ssjinyao.com --rm busybox:latest</div><div class="line">/ # hostname</div><div class="line">www.ssjinyao.com</div><div class="line">/ # ping www.ssjinyao.com</div><div class="line">PING www.ssjinyao.com (172.17.0.6): 56 data bytes</div><div class="line">64 bytes from 172.17.0.6: seq=0 ttl=64 time=0.094 ms</div><div class="line">--- www.ssjinyao.com ping statistics ---</div><div class="line">1 packets transmitted, 1 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 0.094/0.094/0.094 ms</div><div class="line">/ # cat /etc/hosts</div><div class="line">127.0.0.1localhost</div><div class="line">::1localhost ip6-localhost ip6-loopback</div><div class="line">fe00::0ip6-localnet</div><div class="line">ff00::0ip6-mcastprefix</div><div class="line">ff02::1ip6-allnodes</div><div class="line">ff02::2ip6-allrouters</div><div class="line">172.17.0.6www.ssjinyao.com www</div><div class="line">/ # cat /etc/resolv.conf</div><div class="line"># Generated by NetworkManager</div><div class="line">search localdomain</div><div class="line">nameserver 10.180.66.2</div></pre></td></tr></table></figure><p>åªè¦é…ç½®äº†æ­£ç¡®çš„åŸŸåæœåŠ¡å™¨ï¼Œå¯ä»¥æ­£è§£çš„è§£æ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/ # nslookup -type=A nas.ssjinyao.com</div><div class="line">Server:10.180.66.2</div><div class="line">Address:10.180.66.2:53</div><div class="line"></div><div class="line">Non-authoritative answer:</div><div class="line">Name:nas.ssjinyao.com</div><div class="line">Address: 47.104.201.165</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># docker run --name t1 -it --network bridge -h www.ssjinyao.com --dns 114.114.114.114 --dns 8.8.8.8 --rm busybox:latest</div><div class="line">/ # cat /etc/resolv.conf</div><div class="line">search localdomain</div><div class="line">nameserver 114.114.114.114</div><div class="line">nameserver 8.8.8.8</div><div class="line">/ # hostname</div><div class="line">www.ssjinyao.com</div><div class="line"># docker run --name t1 -it --network bridge -h t1.ssjinyao.com --dns 114.114.114.114 --dns-search ssjinyao.com --add-host www.ssjinyao.com:1.1.1.1 --rm busybox:latest</div><div class="line">/ # cat /etc/hosts</div><div class="line">127.0.0.1localhost</div><div class="line">::1localhost ip6-localhost ip6-loopback</div><div class="line">fe00::0ip6-localnet</div><div class="line">ff00::0ip6-mcastprefix</div><div class="line">ff02::1ip6-allnodes</div><div class="line">ff02::2ip6-allrouters</div><div class="line">1.1.1.1www.ssjinyao.com</div><div class="line">172.17.0.6t1.ssjinyao.com t1</div></pre></td></tr></table></figure><p>å°†å®¹å™¨çš„ç«¯å£è¿›è¡Œæš´éœ² </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker run --name myweb --rm -p 80 ssjinyao/httpd:v0.1.1.1-2</div><div class="line"># docker container ps</div><div class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                   NAMES</div><div class="line">97212485437e        ssjinyao/httpd:v0.1.1.1-3   &quot;/bin/httpd -f -h /dâ€¦&quot;   4 minutes ago       Up 4 minutes        0.0.0.0:32773-&gt;80/tcp   myweb</div></pre></td></tr></table></figure><p><img src="/images/docker-32773.png" alt=""></p><p>Opening inbound communication</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-p é€‰é¡¹çš„ä½¿ç”¨æ ¼å¼</div><div class="line">    -p &lt;containerPort&gt;</div><div class="line">    å°†æŒ‡å®šçš„å®¹å™¨ç«¯å£æ˜ å°„è‡³ä¸»æœºæ‰€æœ‰åœ°å€çš„ä¸€ä¸ªåŠ¨æ€ç«¯å£;</div><div class="line">    -p &lt;hostPort&gt;:&lt;containerPort&gt;</div><div class="line">    å°†å®¹å™¨ç«¯å£&lt;containerPort&gt;æ˜ å°„è‡³æŒ‡å®šçš„ä¸»æœºç«¯å£&lt;hostPort&gt;</div><div class="line">    -p &lt;ip&gt;::&lt;containerPort&gt;</div><div class="line">    å°†æŒ‡å®šçš„å®¹å™¨ç«¯å£&lt;containerPort&gt;æ˜ å°„è‡³ä¸»æœºæŒ‡å®š&lt;ip&gt;çš„ç«¯å£&lt;hostPort&gt;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># docker run --name myweb --rm -p 10.180.66.11:8080:80 ssjinyao/httpd:v0.1.1.1-3</div><div class="line"># docker port myweb</div><div class="line">80/tcp -&gt; 10.180.66.11:8080</div></pre></td></tr></table></figure><p><img src="/images/docker-port-8080.png" alt=""></p><p>Joined container(è”ç›Ÿå¼å®¹å™¨)</p><p>å…±äº«b1å®¹å™¨çš„ç½‘ç»œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"># docker run --name b1 -it --rm busybox</div><div class="line"># docker run --name b2 --network container:b1 -it --rm busybox</div><div class="line">/ # ifconfig</div><div class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02</div><div class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:0</div><div class="line">          RX bytes:648 (648.0 B)  TX bytes:0 (0.0 B)</div><div class="line"></div><div class="line">lo        Link encap:Local Loopback</div><div class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</div><div class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1</div><div class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</div><div class="line"></div><div class="line">/ # echo &quot;Joined container&quot; &gt; /tmp/index.html</div><div class="line">/ # httpd -h /tmp/</div><div class="line">/ # netstat  -tnl</div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State</div><div class="line">tcp        0      0 :::80                   :::*                    LISTEN</div><div class="line">/ # wget -O - -q 127.0.0.1</div><div class="line">Joined container</div></pre></td></tr></table></figure><p>å…±äº«å®¿ä¸»æœºç½‘ç»œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"># docker run --name b2 --network host -it --rm busybox</div><div class="line">/ #</div><div class="line">/ # ifconfig</div><div class="line">docker0   Link encap:Ethernet  HWaddr 02:42:88:C6:40:EF</div><div class="line">          inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0</div><div class="line">          inet6 addr: fe80::42:88ff:fec6:40ef/64 Scope:Link</div><div class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:347 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:371 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:0</div><div class="line">          RX bytes:35796 (34.9 KiB)  TX bytes:40247 (39.3 KiB)</div><div class="line"></div><div class="line">ens33     Link encap:Ethernet  HWaddr 00:0C:29:F8:70:D5</div><div class="line">          inet addr:10.180.66.11  Bcast:10.180.66.255  Mask:255.255.255.0</div><div class="line">          inet6 addr: fe80::20c:29ff:fef8:70d5/64 Scope:Link</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:123421 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:39524 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000</div><div class="line">          RX bytes:81346864 (77.5 MiB)  TX bytes:8253033 (7.8 MiB)</div><div class="line"></div><div class="line">lo        Link encap:Local Loopback</div><div class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</div><div class="line">          inet6 addr: ::1/128 Scope:Host</div><div class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div class="line">          RX packets:80 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:80 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1</div><div class="line">          RX bytes:6944 (6.7 KiB)  TX bytes:6944 (6.7 KiB)</div></pre></td></tr></table></figure><p>æ›´æ”¹docker0 æ¡¥çš„ipåœ°å€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># vim /etc/docker/daemon.json</div><div class="line">&#123;</div><div class="line">    &quot;registry-mirrors&quot;:[&quot;https://registry.docker-cn.com&quot;],</div><div class="line">    &quot;bip&quot;: &quot;10.0.0.1/16&quot;,</div><div class="line">    &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2375&quot;,&quot;unix:///var/run/docker.sock&quot;]</div><div class="line">&#125;</div><div class="line"># ifconfig</div><div class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 10.0.0.1  netmask 255.255.0.0  broadcast 10.0.255.255</div><div class="line">        inet6 fe80::42:88ff:fec6:40ef  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 02:42:88:c6:40:ef  txqueuelen 0  (Ethernet)</div><div class="line">        RX packets 347  bytes 35796 (34.9 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 371  bytes 40247 (39.3 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"># docker -H 10.180.66.11:2375 image ls</div></pre></td></tr></table></figure><p>åˆ›å»ºç½‘æ¡¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"># docker network create -d bridge --subnet &quot;172.26.0.0/16&quot; --gateway &quot;172.26.0.1&quot; mbr0</div><div class="line"># ifconfig</div><div class="line">br-76b59a5dfce3: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 172.26.0.1  netmask 255.255.0.0  broadcast 172.26.255.255</div><div class="line">        ether 02:42:ea:15:d6:9e  txqueuelen 0  (Ethernet)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"># ip link set dev br-76b59a5dfce3 name docker1</div><div class="line">RTNETLINK answers: Device or resource busy</div><div class="line"># ifconfig br-76b59a5dfce3 down</div><div class="line"># ifconfig docker1 up </div><div class="line"># ifconfig docker1 down  # æ›´æ”¹åç§°åé»˜è®¤docker è°ƒç”¨æ—¶ä¼šæ‰¾ä¸åˆ°docker1è¿™ä¸ªè™šæ‹Ÿç½‘å¡</div><div class="line"># ip link set dev docker1 name br-76b59a5dfce3</div><div class="line"># docker run --name t1 -it --net mbr0 busybox:latest</div><div class="line">/ # ifconfig</div><div class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:1A:00:02</div><div class="line">          inet addr:172.26.0.2  Bcast:172.26.255.255  Mask:255.255.0.0</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:3 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:0</div><div class="line">          RX bytes:258 (258.0 B)  TX bytes:0 (0.0 B)</div></pre></td></tr></table></figure><p>è‡ªå®šä¹‰docker0æ¡¥çš„ç½‘ç»œå±æ€§ä¿¡æ¯: /etc/docker/daemon.jsonæ–‡ä»¶ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;bip&quot;: &quot;192.168.1.5/24&quot;,</div><div class="line">    &quot;fixed-cidr&quot;: &quot;10.20.0.0/16&quot;,</div><div class="line">    &quot;fixed-cidr-v6&quot;: &quot;2001:db8::/64&quot;,</div><div class="line">    &quot;mtu&quot;: 1500,</div><div class="line">    &quot;default-gateway&quot;: &quot;10.20.1.1&quot;,</div><div class="line">    &quot;default-gateway-v6&quot;: &quot;2001:db8:abcd::89&quot;,</div><div class="line">    &quot;dns&quot;: [&quot;10.20.1.2&quot;, &quot;10.20.1.3&quot;]</div></pre></td></tr></table></figure><p>dockerå®ˆæŠ¤è¿›ç¨‹çš„C/Sï¼Œå…¶é»˜è®¤ç›‘å¬Unix SOcketæ ¼å¼çš„åœ°å€ï¼Œ/var/run/docker.sock;å¦‚æœä½¿ç”¨TCPå¥—æ¥å­—ï¼Œ /etc/docker/daemon.json:<br>â€œhostsâ€: [â€œtcp://0.0.0.0:2375â€, â€œunix:///var/run/docker.sockâ€]</p>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>linux ç³»ç»Ÿå®šåˆ¶</title>
      <link href="/2018/09/01/linux%E7%B3%BB%E7%BB%9F%E5%AE%9A%E5%88%B6/"/>
      <url>/2018/09/01/linux%E7%B3%BB%E7%BB%9F%E5%AE%9A%E5%88%B6/</url>
      <content type="html"><![CDATA[<h1 id="linuxç³»ç»Ÿä¸åº”ç”¨å®šåˆ¶"><a href="#linuxç³»ç»Ÿä¸åº”ç”¨å®šåˆ¶" class="headerlink" title="linuxç³»ç»Ÿä¸åº”ç”¨å®šåˆ¶"></a>linuxç³»ç»Ÿä¸åº”ç”¨å®šåˆ¶</h1><p>linux ç³»ç»Ÿå±‚é¢å·¥ä½œåŸç»“æ„<br><img src="/images/linux-kernel.png" alt=""></p><h2 id="å¿…éœ€è¦ç†Ÿæ‚‰ç³»ç»Ÿå¯åŠ¨æµç¨‹"><a href="#å¿…éœ€è¦ç†Ÿæ‚‰ç³»ç»Ÿå¯åŠ¨æµç¨‹" class="headerlink" title="å¿…éœ€è¦ç†Ÿæ‚‰ç³»ç»Ÿå¯åŠ¨æµç¨‹"></a>å¿…éœ€è¦ç†Ÿæ‚‰ç³»ç»Ÿå¯åŠ¨æµç¨‹</h2><blockquote><p>CentOS 6 ç³»ç»Ÿå¯åŠ¨æµç¨‹</p></blockquote><p><img src="/images/kernerl-boot-statg-ce6.png" alt=""></p><blockquote><p>CentOS 7 ç³»ç»Ÿå¯åŠ¨æµç¨‹</p></blockquote><p><img src="/images/kernel-boot-statg-ce7.jpg" alt=""></p><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><table><thead><tr><th>æœåŠ¡å™¨</th><th>ç³»ç»Ÿç¯å¢ƒ</th><th>ä¸»æœºå</th><th>å†…æ ¸ç‰ˆæœ¬</th><th>å¿…è£…ç¯å¢ƒ</th></tr></thead><tbody><tr><td>å®¿ä¸»æœº</td><td>CentOS 6.9</td><td>Node11</td><td>Kernel 2.6.32-696.el6.x86_64</td><td>Development Tools</td></tr><tr><td>åˆ¶ä½œæœº</td><td>ssjinyao  Linux</td><td>Node21</td><td>Kernel linux-4.18.4</td><td>Busybox 1.29</td></tr></tbody></table><p>å°†ä¸‹è½½çš„åŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸­ </p><p><img src="/images/kernel-org.png" alt=""></p><p><img src="/images/busybox-dowland.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~ â¤ scp ~/Downloads/linux-4.18.4.tar.xz root@node11:/usr/local/src/                                                                                                                          </div><div class="line">~ â¤ scp ~/Downloads/busybox-1.29.2.tar.bz2 root@node11:/usr/local/src/</div></pre></td></tr></table></figure><p>å®‰è£…å®¿ä¸»æœºæ‰€éœ€è¦ç¼–è¯‘ç¯å¢ƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:~]# yum groupinstall &quot;Development tools&quot; &quot;Desktop Platform Development&quot; -y</div></pre></td></tr></table></figure><h2 id="å†…æ ¸ç¼–è¯‘"><a href="#å†…æ ¸ç¼–è¯‘" class="headerlink" title="å†…æ ¸ç¼–è¯‘"></a>å†…æ ¸ç¼–è¯‘</h2><h3 id="è§£å‹æ–‡ä»¶"><a href="#è§£å‹æ–‡ä»¶" class="headerlink" title="è§£å‹æ–‡ä»¶"></a>è§£å‹æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:~]# cd /usr/local/src/</div><div class="line">[root@ssjinyao-node11:~]# ln -s linux-4.18.4 linux</div><div class="line">[root@ssjinyao-node11:~]# cd linux</div><div class="line">[root@ssjinyao-node11:~]# make help   # æŸ¥çœ‹makeå¸®åŠ©</div><div class="line"># å¦‚æœåœ¨centosä¸èƒ½è§£å‹æ—¶ï¼Œéœ€è¦æ‰§è¡Œ</div><div class="line"># yum -y install xz å› ä¸ºåœ¨CentOS 6 çš„ç¯å¢ƒä¸­ tar è§£å‹xzæ–‡ä»¶è°ƒç”¨çš„æ˜¯xzå‘½ä»¤</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/<span class="built_in">local</span>/src/linux]<span class="comment"># make allnoconfig</span></div><div class="line"><span class="comment"># æŠŠåŸé»˜è®¤é…ç½®éƒ½æ¸…ç©ºï¼Œæ ¹æ®æˆ‘ä»¬çš„éœ€è¦é€‰åˆ™ç¼–è¯‘</span></div><div class="line">[root@ssjinyao-node11:/usr/<span class="built_in">local</span>/src/linux]<span class="comment"># make menuconfig</span></div><div class="line"><span class="comment"># æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œé€‰åˆ™å†…æ ¸éœ€è¦æ”¯æŒæ¨¡å—</span></div></pre></td></tr></table></figure><h3 id="é»˜è®¤é…ç½®"><a href="#é»˜è®¤é…ç½®" class="headerlink" title="é»˜è®¤é…ç½®"></a>é»˜è®¤é…ç½®</h3><p><img src="/images/kernel-org-make-menuconfig.png" alt=""></p><h3 id="å…¨å±€é…ç½®"><a href="#å…¨å±€é…ç½®" class="headerlink" title="å…¨å±€é…ç½®"></a>å…¨å±€é…ç½®</h3><p><img src="/images/kernel-config-all.png" alt=""></p><h3 id="kernel-config-general-setup"><a href="#kernel-config-general-setup" class="headerlink" title="kernel-config-general-setup"></a>kernel-config-general-setup</h3><p><img src="/images/kernel-config-generalsetup.png" alt=""></p><h3 id="kernel-config-enable-loadble-module"><a href="#kernel-config-enable-loadble-module" class="headerlink" title="kernel-config-enable-loadble-module"></a>kernel-config-enable-loadble-module</h3><p><img src="/images/kernel-config-enable-loadble-module.png" alt=""></p><h3 id="kernel-config-device-drivers"><a href="#kernel-config-device-drivers" class="headerlink" title="kernel-config-device-drivers"></a>kernel-config-device-drivers</h3><p><img src="/images/kernel-config-device-drivers.png" alt=""></p><h3 id="kernel-config-file-systems"><a href="#kernel-config-file-systems" class="headerlink" title="kernel-config-file-systems"></a>kernel-config-file-systems</h3><p><img src="/images/kernel-config-file-systems.png" alt=""></p><h3 id="è¯¦ç»†é…ç½®ä¸æ“ä½œè¿‡ç¨‹å¦‚ä¸‹"><a href="#è¯¦ç»†é…ç½®ä¸æ“ä½œè¿‡ç¨‹å¦‚ä¸‹" class="headerlink" title="è¯¦ç»†é…ç½®ä¸æ“ä½œè¿‡ç¨‹å¦‚ä¸‹"></a>è¯¦ç»†é…ç½®ä¸æ“ä½œè¿‡ç¨‹å¦‚ä¸‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">* å¯ç”¨ <span class="number">64</span>-bit kernel # è®©å†…æ ¸æ”¯æŒ <span class="number">64</span>ä½æ¶æ„</div><div class="line">* å¯ç”¨ Enable loadable <span class="keyword">module</span> support # æ”¯æŒå†…æ ¸æ¨¡å—è£…è½½</div><div class="line">* ç‚¹è¿› Enable loadable <span class="keyword">module</span> support --&gt;  Module unloading # è®©å†…æ ¸æ”¯æŒåŠ¨æ€è£…å¸è½½</div><div class="line">* ç‚¹è¿› Enable loadable <span class="keyword">module</span> support --&gt; Module signature verification </div><div class="line">        # è®©å†…æ ¸æ ¡éªŒè£…è½½çš„æ¨¡å—æ˜¯å¦æ˜¯å·²ç»è®¤è¯çš„å…¬å¸ï¼Œé¿å…å†…æ ¸è¢«æ±¡æŸ“ï¼Œä»¥ç¡®ä¿å†…æ ¸å±‚é¢çš„å®‰å…¨</div><div class="line">* ç‚¹è¿› Processor type and features --&gt; processor family(Generic-x86-64) ---&gt; Generic-x86-64  </div><div class="line">        # æ”¯æŒé€šç”¨cpuï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å¯¹åº”é€‰åˆ™é€‚åˆè‡ªå·±çš„</div><div class="line">* ç‚¹è¿› Processor type <span class="keyword">and</span> features --&gt; Symmetric multi-processing support  </div><div class="line">        # æ”¯æŒå¤šæ ¸cpu</div><div class="line">* ç‚¹è¿› Bus options (PCI etc.) --&gt; PCI support # é€‰ä¸­æ”¯æŒ</div><div class="line">* å¯ç”¨ Enable the block layer  # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; SCSI device support  # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; SCSI disk support # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Fusion MPT device supportï¼ˆå¯ç”¨ï¼‰ ---&gt; Fusion MPT ScsiHost drivers <span class="keyword">for</span> SPI # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Fusion MPT device supportï¼ˆå¯ç”¨ï¼‰ ---&gt; Fusion MPT ScsiHost drivers <span class="keyword">for</span> SAS # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Fusion MPT device supportï¼ˆå¯ç”¨ï¼‰ ---&gt; Fusion MPT misc device (ioctl) driver # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Fusion MPT device supportï¼ˆå¯ç”¨ï¼‰ ---&gt; Fusion MPT logging facility # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Input device support   ---&gt; Keyboards (NEW) (å¯ç”¨ ) ----&gt;  &lt;*&gt;   AT keyboard (NEW) # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Input device support ---&gt;  Mouse interface # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Input device support ---&gt; Provide legacy /dev/psaux device # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support  ---&gt; Support <span class="keyword">for</span> Host-side USB # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt; Enable USB persist by default (NEW) # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt; xHCI HCD (USB 3.0) support # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt;  Generic xHCI driver <span class="keyword">for</span> a platform device # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt; EHCI HCD (USB 2.0) support # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt; Root Hub Transaction Translators # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt; Improved Transaction Translator scheduling (NEW) # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt;  OHCI HCD (USB 1.1) support # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers --&gt; USB support ---&gt; OHCI support for PCI-bus USB controllers (NEW) # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› Device Drivers  --&gt; Generic Driver Options  ---&gt; Maintain a devtmpfs filesystem to mount at /dev # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Device Drivers --&gt; Generic Driver Options ---&gt; Automount devtmpfs at /dev, after the kernel mounted the rootfs # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; Second extended fs support # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext2 extended attributes # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext2 POSIX Access Control Lists # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext2 Security Labels # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; The Extended <span class="number">3</span> (ext3) filesystem # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext3 POSIX Access Control Lists # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext3 Security Labels  # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; The Extended <span class="number">4</span> (ext4) filesystem # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext4 POSIX Access Control Lists # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext4 Security Labels # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; Ext4 Encryption #  é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS filesystem support # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS Quota support # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS POSIX ACL support # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS Realtime subvolume support # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS online metadata check support # é€‰ä¸­æ”¯æŒ </div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS online metadata repair support # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS Debugging support # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› File systems  --&gt; XFS fatal asserts (NEW) # é€‰ä¸­æ”¯æŒ </div><div class="line"># æ³¨ï¼šè¿™é‡Œé€‰æ‹©æ–‡ä»¶ç³»ç»Ÿæ—¶å¯ä»¥é€‰æ‹©è‡ªå·±å¸¸ç”¨çš„ä¸€ç§å°±å¥½ï¼Œæˆ‘è¿™é‡Œä¸ºæ–¹ä¾¿ä»¥åä½¿ç”¨ï¼Œéƒ½åŠ å…¥è¿›å»äº†</div><div class="line"># ä¸€èˆ¬xfs æ–‡ä»¶ç³»ç»Ÿç±»å‹æ˜¯ç›®å‰æ€§èƒ½æœ€å¥½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œext3 ext4 åˆ™æœ‰è¾ƒæˆç†Ÿçš„æ•°æ®æ¢å¤æŠ€æœ¯ï¼Œå¦‚ext3grep</div><div class="line">* ç‚¹è¿› Executable file formats / Emulations  --&gt; Kernel support <span class="keyword">for</span> ELF binaries # é€‰ä¸­æ”¯æŒ</div><div class="line">* ç‚¹è¿› Executable file formats / Emulations  --&gt;  Kernel support <span class="keyword">for</span> scripts starting with #! # é€‰ä¸­æ”¯æŒï¼Œå³æ–‡ä»¶ç³»ç»Ÿshellæ”¯æŒæœºåˆ¶ </div><div class="line">* ç‚¹è¿› Executable file formats / Emulations  --&gt;  Kernel support <span class="keyword">for</span> MISC binaries # é€‰ä¸­æ”¯æŒ</div><div class="line">* Networking support (å¯ç”¨) --&gt; Networking options  ---&gt;  TCP/IP networking # é€‰ä¸­æ”¯æŒï¼Œä¸ºä»¥ååšå®éªŒæˆ–è€…ä½¿ç”¨æ–¹ä¾¿ã€‚å°†TCP/IP networking ä¸‹é¢çš„æ ¸å¿ƒé¡¹å³tcp/ip ä¸develé¡¹å®‰è£…</div><div class="line">* Device Drivers  --&gt; Network device support  ---&gt; Ethernet driver support (NEW)  ----&gt; (å¯ç”¨) ----&gt; Intel devices (NEW)(å¯ç”¨) -----&gt;  Intel(R) PRO/1000 Gigabit </div><div class="line">* * Device Drivers  --&gt; Network device support  ---&gt; Ethernet driver support (NEW)  ----&gt; (å¯ç”¨) ----&gt; AMD devices(å¯ç”¨) -----&gt;  AMDç›¸å…³çš„æˆ‘è¿™é‡Œå…¨éƒ¨å‹¾é€‰ </div><div class="line">Ethernet support # æ·»åŠ æ¨¡å—  , å…¶å®ƒçš„æ‰€æœ‰ Ethernet driver support å¯ä»¥å–æ¶ˆï¼Œä¾æ®è‡ªå·±çš„éœ€æ±‚é€‰åˆ™</div><div class="line">* ç‚¹è¿› General setup  --&gt; (huatu-ssjinyao-kernel) Local version - append to kernel release # ç‚¹åŠ Kernel release </div><div class="line">* ç‚¹è¿› General setup --&gt; (huatu-ssjinyao) Default hostname</div></pre></td></tr></table></figure><p>ç¼–è¯‘å†…æ ¸æ˜¯ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œè¿™é‡Œçš„å¤§å®¶å¦‚æœä¸€ç›´ç¼–è¯‘ä¸æˆåŠŸï¼Œæˆ–è€…ç¼–è¯‘å®Œå†…æ ¸åä¸æœ‰æˆåŠŸå¯åŠ¨ç³»ç»Ÿ<br>å¯ä»¥ä½¿ç”¨æˆ‘è¿™é‡Œç»™å¤§å®¶å»ºç«‹çš„æ¨¡æ¿</p><p><a href="https://www.ssjinyao.com/images/kernel-config-ok-net-all-ok" target="_blank" rel="external">å»ºç«‹å¯ä»¥ä½¿ç”¨çš„å†…æ ¸é…ç½®æ¨¡æ¿</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># cp kernel-config-ok-net-all-ok /usr/local/src/linux/.config # å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿æ¥è¿›è¡Œç¼–è¯‘ç”Ÿæˆå†…æ ¸æ–‡ä»¶</div></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src/linux-4.18.4]# cat init/main.c | grep -C 8 ' !try_to_run_init_process("/etc/init")'</div><div class="line"><span class="keyword">if</span> (execute_command) &#123;</div><div class="line">ret = run_init_process(execute_command);</div><div class="line"><span class="keyword">if</span> (!ret)</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">panic(<span class="string">"Requested init %s failed (error %d)."</span>,</div><div class="line">      execute_command, ret);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (!try_to_run_init_process(<span class="string">"/sbin/init"</span>) ||</div><div class="line">    !try_to_run_init_process(<span class="string">"/etc/init"</span>) ||</div><div class="line">    !try_to_run_init_process(<span class="string">"/bin/init"</span>) ||</div><div class="line">    !try_to_run_init_process(<span class="string">"/bin/sh"</span>))</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">panic(<span class="string">"No working init found.  Try passing init= option to kernel. "</span></div><div class="line">      <span class="string">"See Linux Documentation/admin-guide/init.rst for guidance."</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">[root@ssjinyao-node11:/usr/local/src/linux<span class="number">-4.18</span><span class="number">.4</span>]<span class="meta"># pwd</span></div><div class="line">/usr/local/src/linux<span class="number">-4.18</span><span class="number">.4</span></div><div class="line"># æ³¨: é€šè¿‡æŸ¥çœ‹è¿™æ®µå†…æ ¸æºç ï¼Œåˆ™å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå¯åŠ¨æ—¶æŸ¥åˆ°initçš„æµç¨‹</div><div class="line">  å…ˆæ‰¾ /sbin/init --&gt; è‹¥ä¸å­˜åœ¨</div><div class="line">  å†æ‰¾ /etc/init --&gt; è‹¥ä¸å­˜åœ¨</div><div class="line">  å†æ‰¾ /bin/init --&gt; è‹¥ä¸å­˜åœ¨</div><div class="line">  å†æ‰¾ /bin/sh   --&gt; è‹¥ä¸å­˜åœ¨</div><div class="line">  å¯åŠ¨æŠ¥å†…æ ¸ææ…Œ</div><div class="line">å½“ç„¶ä¹Ÿå¯ä»¥åœ¨grub çš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š init= æ¥æŒ‡å®šinitçš„ä½ç½®</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src/linux]# make -j 4 bzImage</div><div class="line">[root@ssjinyao-node11:/usr/local/src/linux]# du -sh arch/x86/boot/bzImage</div><div class="line">3.0March/x86/boot/bzImage</div></pre></td></tr></table></figure><h3 id="ç¼–è¯‘å•ä¸ªç½‘å¡æ¨¡å—"><a href="#ç¼–è¯‘å•ä¸ªç½‘å¡æ¨¡å—" class="headerlink" title="ç¼–è¯‘å•ä¸ªç½‘å¡æ¨¡å—"></a>ç¼–è¯‘å•ä¸ªç½‘å¡æ¨¡å—</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src/linux]# ls drivers/net/ethernet/intel/e1000/</div><div class="line">e1000_ethtool.c  e1000.h  e1000_hw.c  e1000_hw.h  e1000_main.c  e1000_osdep.h  e1000_param.c  Makefile</div><div class="line">root@ssjinyao-node11:/usr/local/src/linux]# ls drivers/net/ethernet/intel/e1000/e1000.ko</div><div class="line">drivers/net/ethernet/intel/e1000/e1000.ko</div><div class="line"># insmod /lib64/modules/e1000.ko</div></pre></td></tr></table></figure><h2 id="å®‰è£…-ç¼–è¯‘å®‰è£…busybox"><a href="#å®‰è£…-ç¼–è¯‘å®‰è£…busybox" class="headerlink" title="å®‰è£… ç¼–è¯‘å®‰è£…busybox"></a>å®‰è£… ç¼–è¯‘å®‰è£…busybox</h2><p>å› é™æ€ç¼–è¯‘ä¾èµ–äºè½¯ä»¶åŒ… glibc-static, å› æ­¤åœ¨ç¼–è¯‘busyboxæ—¶éœ€è¦å®‰è£… glibc-static</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src]# tar -xvf busybox-1.29.2.tar.bz2</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cd busybox-1.29.2</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# yum -y install glibc-static</div><div class="line">[root@ssjinyao-node11:/usr/local/src/busybox-1.29.2]# make menuconfig</div></pre></td></tr></table></figure><p><img src="/images/busybox-make.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Settings  --&gt;   --- Build Options  æ ‡é¢˜æ ä¸­ Build static binary (no shared libs) # é€‰ä¸­æ”¯æŒ</div><div class="line">Settings  --&gt;    --- Installation Options (&quot;make install&quot; behavior)  What kind of applet links to install (as soft-links)  ---&gt; è¿™ä¸ªé»˜è®¤çš„ as soft-links å°±å¯ä»¥äº† </div><div class="line">Settings  --&gt;    --- Installation Options (&quot;make install&quot; behavior)  (./_install) Destination path for &apos;make install&apos; ---&gt; è¿™ä¸ªä¹Ÿé€‰ç”¨é»˜è®¤çš„ç¼–è¯‘å®‰è£…å®Œåˆ°é»˜è®¤å½“å‰è·¯å¾„</div></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make install # æ³¨ç¼–è¯‘å‡ºé”™çš„æ—¶å€™è¦å»äº† Coreutils --&gt; sync åé¢éœ€è¦å†åŒæ­¥è¿‡å»</div></pre></td></tr></table></figure><h2 id="åˆ©ç”¨busybox-åˆ¶ä½œinitrd"><a href="#åˆ©ç”¨busybox-åˆ¶ä½œinitrd" class="headerlink" title="åˆ©ç”¨busybox åˆ¶ä½œinitrd"></a>åˆ©ç”¨busybox åˆ¶ä½œinitrd</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src/busybox-1.29.2]# mkdir /tmp/busybox</div><div class="line">[root@ssjinyao-node11:/usr/local/src/busybox-1.29.2]# cp -a ./_install/*</div><div class="line">bin/     linuxrc  sbin/    usr/</div><div class="line">[root@ssjinyao-node11:/usr/local/src/busybox-1.29.2]# cp -a ./_install/* /tmp/busybox/</div><div class="line">[root@ssjinyao-node11:/usr/local/src/busybox-1.29.2]# cd /tmp/busybox/</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]#</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# mkdir -pv  proc  sys  etc/init.d  tmp  dev  mnt/sysroot </div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# vim init</div><div class="line">#!/bin/ash</div><div class="line">echo -e &quot;\t\033[32m Now start init and switch root ! \033[0m &quot;</div><div class="line">mount -t proc proc /proc</div><div class="line">mount -t sysfs sysfs /sys</div><div class="line">mdev -s</div><div class="line">mount -t xfs /dev/sda2  /mnt/sysroot</div><div class="line">exec  switch_root  /mnt/sysroot  /sbin/init</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# chmod +x init</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# mknod  dev/console  c  5  1</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# mknod  dev/null  c  1  3</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# find  .  | cpio  --quiet  -H newc  -o  | gzip  -9 -n &gt; ./huatu-ssjinyao-initrd.gz</div><div class="line">[root@ssjinyao-node11:/tmp/busybox]# du -sh huatu-ssjinyao-initrd.gz</div><div class="line">1.3Mhuatu-ssjinyao-initrd.gz</div></pre></td></tr></table></figure><h2 id="å®‰è£…grub-æ•´åˆå†…æ ¸ä¸initrd"><a href="#å®‰è£…grub-æ•´åˆå†…æ ¸ä¸initrd" class="headerlink" title="å®‰è£…grub,æ•´åˆå†…æ ¸ä¸initrd"></a>å®‰è£…grub,æ•´åˆå†…æ ¸ä¸initrd</h2><p>æ­¤æ—¶å°†å®¿ä¸»æœºå…³æ‰ï¼ŒæŒ‚è½½ä¸€å—scsiç£ç›˜ï¼Œç”¨äºå°†grub,å†…æ ¸,initrdå†™åµŒå…¥<br>æˆ‘è¿™é‡Œç”¨çš„æ˜¯vmware fusion è™šæ‹Ÿå·¥å…·ï¼Œwindowså¤§å®¶ä¹ æƒ¯ç”¨vmware workstation<br>åªè¦ç»™è™šæ‹Ÿæœºæ·»åŠ ä¸€å—ç£ç›˜å³å¯,å¦‚ä¸‹å›¾   </p><p><img src="/images/vmware-fusion-add-disk.png" alt=""></p><p>æ³¨æ„: ç°åœ¨æŒ‚è½½ç£ç›˜ä¸€å®šæ˜¯è¦å’Œå®¿ä¸»æœºå…±äº«ç£ç›˜ï¼Œä¸ç„¶çš„è¯ä¿¡æ¯ä¸ä¼šå®æ—¶åŒæ­¥ ;<br>ä¹Ÿæ˜¯è¯´ï¼Œæ·»åŠ çš„è¿™å—ç£ç›˜æ˜¯ä¸ºå®¿ä¸»æœºå’Œåˆ¶ä½œæœºä¹‹é—´åŒæ­¥æ•°æ®ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´å…±ç”¨ä¸€å—è™šæ‹Ÿç£ç›˜;<br>æ·»åŠ å®Œåå°†å®¿ä¸»æœåŠ¡å™¨å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:~]<span class="comment"># lsblk</span></div><div class="line">NAME                                 MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</div><div class="line">sda                                    8:0    0   20G  0 disk</div><div class="line">â”œâ”€sda1                                 8:1    0  500M  0 part /boot</div><div class="line">â””â”€sda2                                 8:2    0 19.5G  0 part</div><div class="line">  â”œâ”€vg_ssjinyaonode11-lv_root (dm-0) 253:0    0 17.6G  0 lvm  /</div><div class="line">  â””â”€vg_ssjinyaonode11-lv_swap (dm-1) 253:1    0    2G  0 lvm  [SWAP]</div><div class="line">sdb                                    8:16   0   38G  0 disk</div></pre></td></tr></table></figure><p>ç”±ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå·²ç»æ·»åŠ äº†ä¸€å—ç£ç›˜ sdb,å°†ç£ç›˜åˆ†åŒºå¹¶æŒ‚è½½è‡³/mntç›®å½•ä¸‹boot,ä¸sysroot</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:~]# mkdir /mnt/&#123;boot,sysroot&#125;</div><div class="line">[root@ssjinyao-node11:~]# fdisk /dev/sdb</div><div class="line">Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</div><div class="line">Building a new DOS disklabel with disk identifier 0x42ed0c1e.</div><div class="line">Changes will remain in memory only, until you decide to write them.</div><div class="line">After that, of course, the previous content won&apos;t be recoverable.</div><div class="line"></div><div class="line">Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</div><div class="line"></div><div class="line">WARNING: DOS-compatible mode is deprecated. It&apos;s strongly recommended to</div><div class="line">         switch off the mode (command &apos;c&apos;) and change display units to</div><div class="line">         sectors (command &apos;u&apos;).</div><div class="line"></div><div class="line">Command (m for help): n</div><div class="line">Command action</div><div class="line">   e   extended</div><div class="line">   p   primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 1</div><div class="line">First cylinder (1-4960, default 1): 1</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-4960, default 4960): +300M</div><div class="line"></div><div class="line">Command (m for help): n</div><div class="line">Command action</div><div class="line">   e   extended</div><div class="line">   p   primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 2</div><div class="line">First cylinder (40-4960, default 40): 40</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (40-4960, default 4960): 4960</div><div class="line"></div><div class="line">Command (m for help): w</div><div class="line">The partition table has been altered!</div><div class="line"></div><div class="line">Calling ioctl() to re-read partition table.</div><div class="line">Syncing disks.</div><div class="line">[root@ssjinyao-node11:~]# mkfs.xfs /dev/sdb1</div><div class="line">[root@ssjinyao-node11:~]# mkfs.xfs /dev/sdb2</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># mkdir /mnt/&#123;boot,sysroot&#125;</div><div class="line"># mount /dev/sdb1 /mnt/boot</div><div class="line"># mount /dev/sdb2 /mnt/sysroot</div><div class="line">[root@ssjinyao-node11:~]# mount /dev/sdb1 /mnt/boot/</div><div class="line">[root@ssjinyao-node11:~]# mount /dev/sdb2 /mnt/sysroot/</div><div class="line">[root@ssjinyao-node11:~]# cd /tmp/busybox/</div></pre></td></tr></table></figure><p>å°†ç¼–è¯‘å¥½çš„å†…æ ¸ä¸åˆ¶ä½œå¥½çš„initrdå…¥åˆ°bootå¯åŠ¨ç›®å½•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/tmp/busybox]# cp huatu-ssjinyao-initrd.gz /mnt/boot/</div><div class="line">[root@ssjinyao-node11:~]# cp /usr/local/src/linux/arch/x86/boot/bzImage  /mnt/boot/huatu-ssjinyao-kernel</div></pre></td></tr></table></figure><p>å®‰è£… grub è‡³æ–°æ·»åŠ çš„ç¡¬ç›˜ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/tmp/busybox]# grub-install  --root-directory=/mnt/ /dev/sdb</div></pre></td></tr></table></figure><p>æä¾› grub é…ç½®æ–‡ä»¶ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# vim /mnt/boot/grub/grub.conf</div><div class="line">default        0</div><div class="line">timeout        3</div><div class="line">color    light-green/black light-magenta/black</div><div class="line">title    huatu-ssinyao-kernel 4.18.5</div><div class="line">    root (hd0,0)</div><div class="line">    kernel /huatu-ssjinyao-kernel ro root=/dev/sda2 vga=877 quiet</div><div class="line">    initrd /huatu-ssjinyao-initrd.gz</div></pre></td></tr></table></figure><p>vga=877 è¿™é‡Œæ˜¯æ ¹æ®æˆ‘çš„å±ç›®åˆ†è¾¨ç‡è€Œè°ƒæ•´çš„é€‚åº”çš„;<br>è¿™é‡Œå¯ä»¥åœ¨å¯åŠ¨ vga=ask grubå¼€æœºæ—¶ä¼šç»™ä½ ä¸€ä¸ªåˆ—è¡¨ï¼Œè®©ä½ é€‰æ‹©è‡ªå·±çš„åˆ†è¾¨ç‡;<br>æœ€åå¯ä»¥é€‰æ‹©è‡ªå·±å±å¹•çš„åˆ†è¾¨ç‡å¤§å°;<br><img src="/images/fenbianlv.png" alt=""></p><p>å¦‚ï¼Œè¿™é‡Œçš„æˆ‘çš„åˆ†è¾¨ç‡æ˜¯ 1400x900ï¼Œè¿™é‡Œé€‰çš„æ˜¯36Dï¼Œå†å°†16è¿›åˆ¶36Dè½¬æ¢ä¸ºåè¿›åˆ¶æ•°ï¼Œå³æ˜¯æˆ‘åœ¨grub.conf<br>ä¸­é…ç½®çš„vga=877</p><p>å…¶å®ƒé¡¹é…ç½®é¡¹  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">default  é…ç½®è¿™ä¸ªé¡¹ç›®ä¸º0é»˜è®¤å¯åŠ¨é¡¹;</div><div class="line">timeout  é…ç½®è¶…è¿‡3ç§’ä¸é€‰åˆ™ï¼Œåˆ™è‡ªåŠ¨é€‰åˆ™ç¬¬ä¸€ä¸ªtitleå¯åŠ¨;</div><div class="line">color    é…ç½®grubèœå•æ é¢œè‰²;</div><div class="line">title    é…ç½®å¯åŠ¨é¡¹æ ‡é¢˜;</div><div class="line">root (hd0,0)    é…ç½®rootå…ˆè¯†åˆ«ç¬¬ä¸€å—ç›˜çš„ç¬¬ä¸€ä¸ªåˆ†åŒº;</div><div class="line">kernel  é…ç½®æŒ‡å®šå¯åŠ¨å†…æ ¸ï¼Œè¿™é‡Œå³æ˜¯æˆ‘ä»¬ç¼–è¯‘å¥½çš„å†…æ ¸ï¼Œroot æŒ‡å®šå¯åŠ¨åçš„æ ¹åˆ†åŒº;</div><div class="line">initrd  é…ç½®å¯åŠ¨è™šæ ¹ï¼Œä¸ç¬¬ä¸€ä¸ªè¿›ç¨‹;</div></pre></td></tr></table></figure><h2 id="å»ºç«‹çœŸå®æ–‡ä»¶ç³»ç»Ÿ"><a href="#å»ºç«‹çœŸå®æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="å»ºç«‹çœŸå®æ–‡ä»¶ç³»ç»Ÿ"></a>å»ºç«‹çœŸå®æ–‡ä»¶ç³»ç»Ÿ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# cp /usr/local/src/busybox-1.29.2/_install/*  . -a</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# rm -f linuxrc</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# mkdir -pv etc  dev proc sys bin sbin usr/&#123;bin,sbin,lib,lib64,local&#125; lib64 lib/modules home var/&#123;log,run,lock&#125; tmp mnt media root boot</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# vim etc/inittab</div><div class="line"># console:respawn:-/bin/ash</div><div class="line"># tty1::askfirst:/bin/ash</div><div class="line"># tty2::askfirst:/bin/ash</div><div class="line"># tty3::askfirst:/bin/ash</div><div class="line">::sysinit:/etc/rc.d/rc.sysinit</div><div class="line">::respawn:/sbin/getty 9600 tty1</div><div class="line">::respawn:/sbin/getty 9600 tty2</div><div class="line">::respawn:/sbin/getty 9600 tty3</div><div class="line">::respawn:/sbin/getty 9600 tty4</div><div class="line">::respawn:/sbin/getty 9600 tty5</div><div class="line">::respawn:/sbin/getty 9600 tty6</div><div class="line">::respawn:/sbin/getty 9600 tty7</div><div class="line">::ctrlaltdel:/sbin/reboot</div><div class="line">::shutdown:/bin/umount -a -r &amp;&gt; /dev/null</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# chmod +x etc/inittab</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#[root@ssjinyao-node11:/mnt/sysroot]# mkdir etc/rc.d/</span></div><div class="line"><span class="comment">#[root@ssjinyao-node11:/mnt/sysroot]# vim  etc/rc.d/rc.sysinit</span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\t welcome to \033[31m HuaTu SSJinYao \033[0m Linux"</span></div><div class="line">mount -t proc proc /proc</div><div class="line">mount -t sysfs sysfs /sys</div><div class="line"><span class="built_in">echo</span> <span class="string">"scan /sys and to populate to /dev..."</span></div><div class="line">mdev -s</div><div class="line">mount -o remount,rw  /dev/sda2 /</div><div class="line"><span class="built_in">echo</span> <span class="string">"mounting all filesystems..."</span></div><div class="line">mount -a</div><div class="line">ifconfig eth0 10.180.66.31 netmask 255.255.255.0</div><div class="line">ifconfig lo 127.0.0.1</div><div class="line"></div><div class="line">route add default gw 10.180.66.2</div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\033[31m Start Network Manager.........................\033[0m \033[32m [OK] \033[0m"</span></div><div class="line">/usr/<span class="built_in">local</span>/sbin/dropbear -E -F &amp;&gt; /var/<span class="built_in">log</span>/dropbear/sshd.log &amp;</div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\033[31m Start dropbear sshd ..........................\033[0m \033[32m [OK] \033[0m"</span></div><div class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\033[31m Start Nginx Service ..........................\033[0m \033[32m [OK] \033[0m"</span></div><div class="line">/usr/<span class="built_in">local</span>/keepalived/sbin/keepalived -D -S 0 -f /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf</div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\033[31m Start Keepalived Service .....................\033[0m \033[32m [OK] \033[0m"</span></div><div class="line">rsync.sh &amp;&gt; /dev/null &amp;</div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\033[31m Start Rsync Service ..........................\033[0m \033[32m [OK] \033[0m"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> -e <span class="string">"\033[31m</span></div><div class="line"><span class="string">            \</span></div><div class="line"><span class="string">              - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">                                 ** **</span></div><div class="line"><span class="string">                                // //            **   **</span></div><div class="line"><span class="string">               ******  ******    ** ** *******  //** **   ******    ******</span></div><div class="line"><span class="string">              **////  **////    /**/**//**///**  //***   //////**  **////**</span></div><div class="line"><span class="string">             //***** //*****    /**/** /**  /**   /**     ******* /**   /**</span></div><div class="line"><span class="string">              /////** /////** **/**/** /**  /**   **     **////** /**   /**</span></div><div class="line"><span class="string">              ******  ****** //*** /** ***  /**  **     //********//******</span></div><div class="line"><span class="string">             //////  //////   ///  // ///   //  //       ////////  //////</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">            \\</span></div><div class="line"><span class="string">              - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \\</span></div><div class="line"><span class="string">\033[0m"</span></div><div class="line"><span class="comment"># chmod +x etc/rc.d/rc.sysinit</span></div></pre></td></tr></table></figure><p>å»ºç³»ç»Ÿç³»ç»ŸæŒ‚è½½ç›®å½• fstab </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# mkdir /dev/pts</div><div class="line"># æ³¨: åœ¨æ­¤ä¹‹å‰ä¸€å®šè¦æœ‰ dev/pts ç›®å½• </div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# vim etc/fstab </div><div class="line">sysfs       /sys      sysfs defaults 0 0 </div><div class="line">proc        /proc     proc      defaults 0 0 </div><div class="line">devpts      /dev/pts  devpts    mode=620 0 0 </div><div class="line">/dev/sda1   /boot     xfs      defaults 0 0 </div><div class="line">/dev/sda2   /         xfs      defaults 0 0</div></pre></td></tr></table></figure><p>æ·»åŠ ç™»å½•åè„šæœ¬/etc/profile</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PS1=<span class="string">'[\[\033[01;36m\]\u\[\033[00m\]@\[\033[01;34m\]\h\[\033[00m\]:\[\033[01;32m\]\w\[\033[00m\]]\[\033[01;34m\]\$\[\033[00m\] '</span></div><div class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/bin:/usr/<span class="built_in">local</span>/sbin/:/sbin:/bin:/usr/bin:/usr/sbin</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# vim etc/shells </div><div class="line">/bin/sh</div><div class="line">/bin/ash</div><div class="line">/bin/hush</div><div class="line">/bin/bash</div><div class="line">/sbin/nologin</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# etc/nsswitch.conf</div><div class="line">passwd: files</div><div class="line">grup: files</div><div class="line">shadow: files</div><div class="line">hosts: files dns</div></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å®‰è£…dropbear"><a href="#ç¼–è¯‘å®‰è£…dropbear" class="headerlink" title="ç¼–è¯‘å®‰è£…dropbear"></a>ç¼–è¯‘å®‰è£…dropbear</h2><p>æ³¨ dropbear å¯ä»¥åœ¨<a href="https://matt.ucc.asn.au/dropbear/" target="_blank" rel="external">dropbearå®˜ç½‘</a>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src]# tar -xvf dropbear-2018.76.tar.bz2</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cd dropbear-2018.76</div><div class="line">[root@ssjinyao-node11:/usr/local/src/dropbear-2018.76]#  make PROGRAMS=&quot;dropbear dbclient dropbearkey dropbearconvert scp&quot; install</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# cd /mnt/sysroot/etc/dropbear/</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot/etc/dropbear/]# openssl passwd -1 -salt $(openssl rand -hex 4)</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot/etc/dropbear/]# dropbearkey -t rsa -s 2048 -f dropbear_rsa_host_key</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot/etc/dropbear/]# dropbearkey -t dss -f dropbear_dss_host_key</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot/etc/dropbear/]# dropbear -E -F å¯åŠ¨</div></pre></td></tr></table></figure><h2 id="ç§»æ¤ç³»ç»Ÿè®¤è¯ã€ç™»å½•ã€è§£æç›¸å…³çš„ä¾èµ–åº“"><a href="#ç§»æ¤ç³»ç»Ÿè®¤è¯ã€ç™»å½•ã€è§£æç›¸å…³çš„ä¾èµ–åº“" class="headerlink" title="ç§»æ¤ç³»ç»Ÿè®¤è¯ã€ç™»å½•ã€è§£æç›¸å…³çš„ä¾èµ–åº“"></a>ç§»æ¤ç³»ç»Ÿè®¤è¯ã€ç™»å½•ã€è§£æç›¸å…³çš„ä¾èµ–åº“</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot] mkdir  usr/lib64/</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /lib64/libnss_files* lib64/</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /usr/lib64/libnss3.so usr/lib64/</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /usr/lib64/libnss_files.so* usr/lib64/</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /lib64/libresolv*  lib64/</div><div class="line">[root@ssjinyao-node11:/mnt/sysroot] cp -d /lib64/libnss_dns* lib64/</div></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å®‰è£…nginx"><a href="#ç¼–è¯‘å®‰è£…nginx" class="headerlink" title="ç¼–è¯‘å®‰è£…nginx"></a>ç¼–è¯‘å®‰è£…nginx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src]# cd /usr/local/src/</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# tar -xvf nginx-1.14.0.tar.gz</div><div class="line">./configure --prefix=/usr/local/nginx   --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --with-http_gzip_static_module --with-http_stub_status_module --with-http_ssl_module --user=root --group=root</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cp -a /usr/local/nginx/sbin/nginx  /usr/sbin/</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cp -a /usr/local/nginx/ /mnt/sysroot/usr/local/</div></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å®‰è£…inotifyå¹¶ç§»æ¤"><a href="#ç¼–è¯‘å®‰è£…inotifyå¹¶ç§»æ¤" class="headerlink" title="ç¼–è¯‘å®‰è£…inotifyå¹¶ç§»æ¤"></a>ç¼–è¯‘å®‰è£…inotifyå¹¶ç§»æ¤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local]# cd /usr/local/src/</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# tar -xvf inotify-tools-3.14.tar.gz</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cd inotify-tools-3.14</div><div class="line">[root@ssjinyao-node11:/usr/local/src/inotify-tools-3.14]# ./configure --prefix=/usr/local/inotify/</div><div class="line">[root@ssjinyao-node11:/usr/local/src/inotify-tools-3.14]# cp -a /usr/local/inotify/ /mnt/sysroot/usr/local</div></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å®‰è£…keepalived"><a href="#ç¼–è¯‘å®‰è£…keepalived" class="headerlink" title="ç¼–è¯‘å®‰è£…keepalived"></a>ç¼–è¯‘å®‰è£…keepalived</h2><p>æ³¨: keepalived ä¾èµ–net-tools psmisc ä¸¤ä¸ªå·¥å…·åŒ…ï¼Œå› æ­¤éœ€è¦å°†è¿™ä¸¤ä¸ªå·¥å…·åŒ…çš„å‘½ä»¤ç§»æ¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@laoba-10-17:/usr/local/src/linux-4.18.5]# rpm -ql net-tools | grep bin &amp;&amp; rpm -ql psmisc | grep bin</div><div class="line">/bin/netstat</div><div class="line">/sbin/arp</div><div class="line">/sbin/ether-wake</div><div class="line">/sbin/ifconfig</div><div class="line">/sbin/ipmaddr</div><div class="line">/sbin/iptunnel</div><div class="line">/sbin/mii-diag</div><div class="line">/sbin/mii-tool</div><div class="line">/sbin/nameif</div><div class="line">/sbin/plipconfig</div><div class="line">/sbin/route</div><div class="line">/sbin/slattach</div><div class="line">/usr/bin/killall</div><div class="line">/usr/bin/peekfd</div><div class="line">/usr/bin/prtstat</div><div class="line">/usr/bin/pstree</div><div class="line">/usr/bin/pstree.x11</div><div class="line">/usr/sbin/fuser</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/usr/local/src]# tar -xvf keepalived-2.0.6.tar.gz</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cd keepalived-2.0.6</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cp /usr/local/keepalived/sbin/keepalived /usr/sbin/</div><div class="line">[root@ssjinyao-node11:/usr/local/src/keepalived-2.0.6]# ./configure --prefix=/usr/local/keepalived/</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# cp -a /usr/local/keepalived/ /mnt/sysroot/usr/local</div></pre></td></tr></table></figure><h2 id="ç¼–å†™bincp-è„šæœ¬"><a href="#ç¼–å†™bincp-è„šæœ¬" class="headerlink" title="ç¼–å†™bincp è„šæœ¬"></a>ç¼–å†™bincp è„šæœ¬</h2><p>ldd å‘½ä»¤å¯ä»¥æŸ¥çœ‹å‘½ä»¤æ‰€ä¾èµ–çš„åº“çš„ä½ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]# ldd /bin/cp</div></pre></td></tr></table></figure><p>ç¼–å†™è„šæœ¬ï¼Œå°†éœ€è¦çš„å‘½ä»¤åŒæ­¥åˆ°/mnt/sysroot ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@ssjinyao-node11:/mnt/sysroot]<span class="comment"># mkdir /root/bin</span></div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]<span class="comment"># vim /root/bin/bincp.sh</span></div><div class="line">[root@ssjinyao-node11:/mnt/sysroot]<span class="comment"># chmod +x /root/bin/bincp.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#The scripts can copy bin file and that bin libs</span></div><div class="line"><span class="comment">#author renjin</span></div><div class="line"><span class="comment">#date 2016 11 19</span></div><div class="line"><span class="comment">#version 3.0</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"acquiesce copy bin file in /mnt/sysroot!! "</span></div><div class="line">MNT=<span class="string">"/mnt/sysroot"</span></div><div class="line"><span class="function"><span class="title">BIN_FILE</span></span>() &#123; bindir=`dirname <span class="variable">$file</span>`</div><div class="line">             [ -e <span class="variable">$MNT</span> ] || mkdir -p <span class="variable">$MNT</span></div><div class="line">             [ -e <span class="variable">$MNT</span><span class="variable">$bindir</span> ] || mkdir -p <span class="variable">$MNT</span><span class="variable">$bindir</span></div><div class="line">             <span class="keyword">if</span> [ -e <span class="variable">$MNT</span><span class="variable">$file</span> ] ; <span class="keyword">then</span></div><div class="line">                <span class="built_in">echo</span> <span class="string">"you will copy bin file exsit !"</span></div><div class="line">             <span class="keyword">else</span></div><div class="line">               cp <span class="variable">$file</span> <span class="variable">$MNT</span><span class="variable">$bindir</span></div><div class="line">             <span class="keyword">fi</span></div><div class="line">          &#125;</div><div class="line"><span class="function"><span class="title">LIB_FILE</span></span>() &#123; lib=`ldd <span class="variable">$file</span> | grep -Eo <span class="string">"/.*lib(64)&#123;0,1&#125;/[^[:space:]]&#123;1,&#125;"</span>`</div><div class="line">             <span class="keyword">for</span> lib64 <span class="keyword">in</span> <span class="variable">$lib</span>; <span class="keyword">do</span></div><div class="line">                 libdir=`dirname <span class="variable">$lib64</span>`</div><div class="line">                 <span class="keyword">if</span> [ ! -e <span class="variable">$MNT</span><span class="variable">$libdir</span> ]; <span class="keyword">then</span></div><div class="line">                       mkdir -p <span class="variable">$MNT</span><span class="variable">$libdir</span></div><div class="line">                 <span class="keyword">elif</span>  [ -e <span class="variable">$MNT</span><span class="variable">$lib64</span> ] ; <span class="keyword">then</span></div><div class="line">                     <span class="built_in">echo</span> <span class="string">"you will copy lib file exsit "</span> &amp;&amp; <span class="built_in">continue</span></div><div class="line">                 <span class="keyword">else</span> cp <span class="variable">$lib</span> <span class="variable">$MNT</span><span class="variable">$libdir</span></div><div class="line">                 <span class="keyword">fi</span></div><div class="line">            <span class="keyword">done</span></div><div class="line">          &#125;</div><div class="line"></div><div class="line"><span class="built_in">read</span> -p <span class="string">"please input your will copy bin file name,or input quit quitng: "</span> BIN</div><div class="line">until [ <span class="variable">$BIN</span> == <span class="string">'quit'</span> -o <span class="variable">$BIN</span> == <span class="string">'q'</span> ]; <span class="keyword">do</span></div><div class="line">! <span class="built_in">which</span> <span class="variable">$BIN</span> 2&gt; /dev/null &amp;&amp; <span class="built_in">read</span> -p  <span class="string">"you input command no exsit,please again input or input quit ,quiting  "</span> BIN &amp;&amp; <span class="built_in">continue</span></div><div class="line">file=`<span class="built_in">which</span> --skip-alias <span class="variable">$BIN</span> 2&gt; /dev/null | grep <span class="string">"/.*[^[:space:]]"</span> `</div><div class="line">      BIN_FILE <span class="variable">$BIN</span> &amp;&amp; LIB_FILE <span class="variable">$BIN</span></div><div class="line"><span class="built_in">read</span> -p <span class="string">"continue!,or input quit ,quting: "</span> BIN</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># chmod +x /root/bincp.sh &amp;&amp; cp /root/bincp.sh /bin</div><div class="line">[root@ssjinyao-node11:/usr/local/src]# bincp.sh</div><div class="line">acquiesce copy bin file in /mnt/sysroot!!</div><div class="line">please input your will copy bin file name,or input quit quitng:</div></pre></td></tr></table></figure><p>éœ€è¦ç§»æ¤çš„å‘½ä»¤æœ‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash dropbear ssh scp rysnc dbclient dropbearconvert dropbearkey genhash nginx ç­‰ç­‰</div></pre></td></tr></table></figure><p>åˆ©ä¸Šè¿™ä¸ªè„šæœ¬å°†è‡ªå·±éœ€è¦çš„å‘½ä»¤æ‹·è´åˆ°/mnt/sysrootä¸­ </p><p>æ·»åŠ rootç”¨æˆ·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># adduser root </div><div class="line"># passwd root</div><div class="line">è¿™é‡Œè¦æ³¨æ„æŠŠ root id åœ¨ /etc/passwd ä¸­æ”¹0</div><div class="line">åœ¨Linuxå†…æ ¸ä¸­ï¼Œç³»ç»Ÿæƒé™åªå¯¹åº”id</div></pre></td></tr></table></figure><h2 id="å¾®ç³»ç»Ÿ-keepaived-nginx-rsync-inotifyçš„å®ç°"><a href="#å¾®ç³»ç»Ÿ-keepaived-nginx-rsync-inotifyçš„å®ç°" class="headerlink" title="å¾®ç³»ç»Ÿ keepaived+nginx+rsync+inotifyçš„å®ç°"></a>å¾®ç³»ç»Ÿ keepaived+nginx+rsync+inotifyçš„å®ç°</h2><p>keepalived+nginx+rsync+intofity åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æœ‰å®ç°<br>å¤§å®¶å¯ä»¥å†å…‹éš†ä¸€ä¸ªå°ç³»ç»Ÿï¼Œæ¥å®ç°keepalivedçš„åŒä¸»</p><h2 id="ç³»ç»Ÿå¯åŠ¨åå¦‚ä¸‹å›¾"><a href="#ç³»ç»Ÿå¯åŠ¨åå¦‚ä¸‹å›¾" class="headerlink" title="ç³»ç»Ÿå¯åŠ¨åå¦‚ä¸‹å›¾"></a>ç³»ç»Ÿå¯åŠ¨åå¦‚ä¸‹å›¾</h2><p><img src="/images/huatu-ssjinyao-little-linux.png" alt=""></p><p><img src="/images/linux-little-ps.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>pythonæ—¥å¸¸ç»ƒä¹ </title>
      <link href="/2018/08/23/python%20%E6%97%A5%E5%B8%B8%E7%BB%83%E4%B9%A008-23/"/>
      <url>/2018/08/23/python%20%E6%97%A5%E5%B8%B8%E7%BB%83%E4%B9%A008-23/</url>
      <content type="html"><![CDATA[<h1 id="python-æ—¥å¸¸ç»ƒä¹ "><a href="#python-æ—¥å¸¸ç»ƒä¹ " class="headerlink" title="python æ—¥å¸¸ç»ƒä¹ "></a>python æ—¥å¸¸ç»ƒä¹ </h1><p><img src="/images/python.jpg" alt=""></p><h2 id="å’Œå¹¶ä¸¤ä¸ªæœ‰åºåˆ—è¡¨ï¼Œå¹¶ä¸”ä¿æŒåˆå¹¶åçš„ä¸¤ä¸ªåˆ—è¡¨æœ‰åº"><a href="#å’Œå¹¶ä¸¤ä¸ªæœ‰åºåˆ—è¡¨ï¼Œå¹¶ä¸”ä¿æŒåˆå¹¶åçš„ä¸¤ä¸ªåˆ—è¡¨æœ‰åº" class="headerlink" title="å’Œå¹¶ä¸¤ä¸ªæœ‰åºåˆ—è¡¨ï¼Œå¹¶ä¸”ä¿æŒåˆå¹¶åçš„ä¸¤ä¸ªåˆ—è¡¨æœ‰åº"></a>å’Œå¹¶ä¸¤ä¸ªæœ‰åºåˆ—è¡¨ï¼Œå¹¶ä¸”ä¿æŒåˆå¹¶åçš„ä¸¤ä¸ªåˆ—è¡¨æœ‰åº</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">In [11]: l1 = [1,2,3,4]</div><div class="line">In [12]: l2 = [2,3,7,9]</div><div class="line">In [13]: l3 = []</div><div class="line">In [14]: <span class="keyword">for</span> x <span class="keyword">in</span> l1:</div><div class="line">    ...:     <span class="keyword">while</span> len(l2) &gt; 0 :</div><div class="line">    ...:         <span class="keyword">if</span> x &gt; l2[0]:</div><div class="line">    ...:             l3.append(l2.pop(0))</div><div class="line">    ...:         <span class="keyword">else</span>:</div><div class="line">    ...:             l3.append(x)</div><div class="line">    ...:             <span class="built_in">break</span></div><div class="line">    ...:     <span class="keyword">if</span> len(l2)  &lt;= 0:</div><div class="line">    ...:         l3.append(x)</div><div class="line">    ...: l3.append(l2)</div><div class="line">    ...:</div><div class="line">    ...:</div><div class="line">In [15]:</div><div class="line">In [15]: l3</div><div class="line">Out[15]: [1, 2, 2, 3, 3, 4, [7, 9]]</div></pre></td></tr></table></figure><h2 id="æŒ‰å•è¯åè½¬å­—ç¬¦ä¸²ï¼Œ-å¦‚â€™I-love-Linuxâ€™-åè½¬ä¸º-â€˜Linux-love-Iâ€™"><a href="#æŒ‰å•è¯åè½¬å­—ç¬¦ä¸²ï¼Œ-å¦‚â€™I-love-Linuxâ€™-åè½¬ä¸º-â€˜Linux-love-Iâ€™" class="headerlink" title="æŒ‰å•è¯åè½¬å­—ç¬¦ä¸²ï¼Œ å¦‚â€™I love Linuxâ€™ åè½¬ä¸º â€˜Linux love Iâ€™"></a>æŒ‰å•è¯åè½¬å­—ç¬¦ä¸²ï¼Œ å¦‚â€™I love Linuxâ€™ åè½¬ä¸º â€˜Linux love Iâ€™</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">30</span>]: <span class="string">' '</span>.join(s.split()[::<span class="number">-1</span>])</div><div class="line">Out[<span class="number">30</span>]: <span class="string">'Linux love I'</span></div><div class="line">In [<span class="number">31</span>]: s = <span class="string">"I love Linux"</span></div><div class="line">In [<span class="number">32</span>]: <span class="string">' '</span>.join(s.split()[::<span class="number">-1</span>])</div><div class="line">Out[<span class="number">32</span>]: <span class="string">'Linux love I'</span></div><div class="line">In [<span class="number">33</span>]: s.split()[::<span class="number">-1</span>]</div><div class="line">Out[<span class="number">33</span>]: [<span class="string">'Linux'</span>, <span class="string">'love'</span>, <span class="string">'I'</span>]</div></pre></td></tr></table></figure><h2 id="æ‰¾å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­åªå‡ºç°äº†ä¸€æ¬¡çš„æ•°å­—ï¼Œå¹¶ä¸”ä¿æŒåŸæ¥çš„æ¬¡åºï¼Œä¾‹å¦‚-1-2-1-3-2-5-ï¼Œç»“æœä¸º-3-5"><a href="#æ‰¾å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­åªå‡ºç°äº†ä¸€æ¬¡çš„æ•°å­—ï¼Œå¹¶ä¸”ä¿æŒåŸæ¥çš„æ¬¡åºï¼Œä¾‹å¦‚-1-2-1-3-2-5-ï¼Œç»“æœä¸º-3-5" class="headerlink" title="æ‰¾å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­åªå‡ºç°äº†ä¸€æ¬¡çš„æ•°å­—ï¼Œå¹¶ä¸”ä¿æŒåŸæ¥çš„æ¬¡åºï¼Œä¾‹å¦‚[1,2,1,3,2,5]ï¼Œç»“æœä¸º[3,5]"></a>æ‰¾å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­åªå‡ºç°äº†ä¸€æ¬¡çš„æ•°å­—ï¼Œå¹¶ä¸”ä¿æŒåŸæ¥çš„æ¬¡åºï¼Œä¾‹å¦‚[1,2,1,3,2,5]ï¼Œç»“æœä¸º[3,5]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Numberï¼ˆæ•°å­—ï¼‰</div><div class="line">Stringï¼ˆå­—ç¬¦ä¸²ï¼‰</div><div class="line">Listï¼ˆåˆ—è¡¨ï¼‰</div><div class="line">Tupleï¼ˆå…ƒç»„ï¼‰</div><div class="line">Setï¼ˆé›†åˆï¼‰</div><div class="line">Dictionaryï¼ˆå­—å…¸ï¼‰</div></pre></td></tr></table></figure><p>æœ‰bugçš„ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ä¾‹å¦‚ï¼Œå½“1 å‡ºç°ä¸‰æ¬¡æ—¶ï¼Œä¼šæŠŠ1ä¹Ÿè®°å½•ä¸‹æ¥</span></div><div class="line">In [<span class="number">59</span>]: lst_set</div><div class="line">Out[<span class="number">59</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</div><div class="line"></div><div class="line">In [<span class="number">60</span>]: lst =  [<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>]</div><div class="line">In [<span class="number">61</span>]: ret = []</div><div class="line">In [<span class="number">62</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst:</div><div class="line">    ...:     <span class="keyword">if</span> x <span class="keyword">in</span> ret:</div><div class="line">    ...:         ret.remove(x)</div><div class="line">    ...:     <span class="keyword">else</span>:</div><div class="line">    ...:         ret.append(x)</div><div class="line">    ...:</div><div class="line">In [<span class="number">63</span>]: ret</div><div class="line">Out[<span class="number">63</span>]: [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å»é™¤bugå</span></div><div class="line">In [<span class="number">51</span>]: lst =  [<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>]</div><div class="line">In [<span class="number">52</span>]: ret = []</div><div class="line">In [<span class="number">53</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst:</div><div class="line">    ...:     <span class="keyword">if</span> lst.count(x) == <span class="number">1</span>:</div><div class="line">    ...:         ret.append(x)</div><div class="line">    ...:</div><div class="line">In [<span class="number">54</span>]: ret</div><div class="line">Out[<span class="number">54</span>]: [<span class="number">3</span>, <span class="number">5</span>]</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å½“é‡å¤çš„æ•°è¿‡å¤§çš„æ—¶ï¼Œä¸ä¾¿é‡å¤çš„å…ƒç´ æ¯ä¸ªéƒ½éå†ï¼Œå¦‚10wä¸ª1é‡å¤</span></div><div class="line">In [<span class="number">77</span>]: lst =  [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>]</div><div class="line">In [<span class="number">78</span>]: lst_set = list(set(lst))</div><div class="line">In [<span class="number">79</span>]: lst_set</div><div class="line">Out[<span class="number">79</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</div><div class="line">In [<span class="number">80</span>]: ret = []</div><div class="line">In [<span class="number">81</span>]: ret</div><div class="line">Out[<span class="number">81</span>]: []</div><div class="line">In [<span class="number">84</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> lst_set:</div><div class="line">    ...:     <span class="keyword">if</span> lst.count(x) == <span class="number">1</span>:</div><div class="line">    ...:         ret.append(x)</div><div class="line">    ...:</div><div class="line">In [<span class="number">85</span>]: ret</div><div class="line">Out[<span class="number">85</span>]: [<span class="number">3</span>, <span class="number">5</span>]</div></pre></td></tr></table></figure><h2 id="å–å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­çš„æœ€å¤§å€¼"><a href="#å–å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­çš„æœ€å¤§å€¼" class="headerlink" title="å–å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­çš„æœ€å¤§å€¼"></a>å–å‡ºä¸€ä¸ªåˆ—è¡¨ä¸­çš„æœ€å¤§å€¼</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [86]: lst = [1,3,5,8,10,101,301]</div><div class="line">In [87]: max(lst)</div><div class="line">Out[87]: 301</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">In [93]: lst = [1,3,5,8,10,101,301]</div><div class="line">In [94]: m = lst[0]</div><div class="line">In [96]: for x in lst:</div><div class="line">    ...:     if x &gt; m:</div><div class="line">    ...:         m = x</div><div class="line">    ...:</div><div class="line">In [97]: m</div><div class="line">Out[97]: 301</div></pre></td></tr></table></figure><h2 id="å†™ä¸€ä¸ªç¨‹åºï¼ŒæŠŠå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­—ï¼Œä¸å…è®¸ä½¿ç”¨å‡½æ•°å’Œæ¨¡å—"><a href="#å†™ä¸€ä¸ªç¨‹åºï¼ŒæŠŠå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­—ï¼Œä¸å…è®¸ä½¿ç”¨å‡½æ•°å’Œæ¨¡å—" class="headerlink" title="å†™ä¸€ä¸ªç¨‹åºï¼ŒæŠŠå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­—ï¼Œä¸å…è®¸ä½¿ç”¨å‡½æ•°å’Œæ¨¡å—"></a>å†™ä¸€ä¸ªç¨‹åºï¼ŒæŠŠå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­—ï¼Œä¸å…è®¸ä½¿ç”¨å‡½æ•°å’Œæ¨¡å—</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">138</span>]: s = <span class="string">'123.456'</span></div><div class="line">In [<span class="number">139</span>]: integer, decimals=s.split(<span class="string">'.'</span>)</div><div class="line">In [<span class="number">140</span>]: list(enumerate(integer))</div><div class="line">Out[<span class="number">140</span>]: [(<span class="number">0</span>, <span class="string">'1'</span>), (<span class="number">1</span>, <span class="string">'2'</span>), (<span class="number">2</span>, <span class="string">'3'</span>)]</div><div class="line">In [<span class="number">141</span>]: integer_length = len(integer)</div><div class="line">In [<span class="number">142</span>]: result = <span class="number">0</span></div><div class="line">     ...: <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(integer):</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'0'</span>:</div><div class="line">     ...:         result += <span class="number">0</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'1'</span>:</div><div class="line">     ...:         result += <span class="number">1</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'2'</span>:</div><div class="line">     ...:         result += <span class="number">2</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'3'</span>:</div><div class="line">     ...:         result += <span class="number">3</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'4'</span>:</div><div class="line">     ...:         result += <span class="number">4</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'5'</span>:</div><div class="line">     ...:         result += <span class="number">5</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'6'</span>:</div><div class="line">     ...:         result += <span class="number">6</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'7'</span>:</div><div class="line">     ...:         result += <span class="number">7</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'8'</span>:</div><div class="line">     ...:         result += <span class="number">8</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'9'</span>:</div><div class="line">     ...:         result += <span class="number">9</span> * <span class="number">10</span> ** (integer_length -i <span class="number">-1</span>)</div><div class="line">     ...:</div><div class="line">In [<span class="number">143</span>]: <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(decimals):</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'0'</span>:</div><div class="line">     ...:         result += <span class="number">0</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'1'</span>:</div><div class="line">     ...:         result += <span class="number">1</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'2'</span>:</div><div class="line">     ...:         result += <span class="number">2</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'3'</span>:</div><div class="line">     ...:         result += <span class="number">3</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'4'</span>:</div><div class="line">     ...:         result += <span class="number">4</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'5'</span>:</div><div class="line">     ...:         result += <span class="number">5</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'6'</span>:</div><div class="line">     ...:         result += <span class="number">6</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'7'</span>:</div><div class="line">     ...:         result += <span class="number">7</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'8'</span>:</div><div class="line">     ...:         result += <span class="number">8</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:     <span class="keyword">if</span> x == <span class="string">'9'</span>:</div><div class="line">     ...:         result += <span class="number">9</span> * <span class="number">10</span> ** (<span class="number">-1</span> * (i+<span class="number">1</span>))</div><div class="line">     ...:</div><div class="line">In [<span class="number">144</span>]: result</div><div class="line">Out[<span class="number">144</span>]: <span class="number">123.456</span></div><div class="line">In [<span class="number">145</span>]: type(result)</div><div class="line">Out[<span class="number">145</span>]: float</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>pythonè¾“å‡ºæ ¼å¼</title>
      <link href="/2018/08/20/python%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F/"/>
      <url>/2018/08/20/python%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p><img src="/images/python.jpg" alt=""></p><h2 id="åˆ—è¡¨çš„å°è£…ä¸è§£å‹"><a href="#åˆ—è¡¨çš„å°è£…ä¸è§£å‹" class="headerlink" title="åˆ—è¡¨çš„å°è£…ä¸è§£å‹"></a>åˆ—è¡¨çš„å°è£…ä¸è§£å‹</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">10</span>]: lst = [<span class="number">1</span>,[<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>],<span class="number">4</span>]</div><div class="line">In [<span class="number">11</span>]: a, (b, *_, c),d = lst</div><div class="line">In [<span class="number">12</span>]: a</div><div class="line">Out[<span class="number">12</span>]: <span class="number">1</span></div><div class="line">In [<span class="number">13</span>]: b</div><div class="line">Out[<span class="number">13</span>]: <span class="number">2</span></div><div class="line">In [<span class="number">14</span>]: c</div><div class="line">Out[<span class="number">14</span>]: <span class="number">10</span></div><div class="line">In [<span class="number">15</span>]: d</div><div class="line">Out[<span class="number">15</span>]: <span class="number">4</span></div></pre></td></tr></table></figure><h2 id="è¾“å‡ºæ ¼å¼ç»ƒä¹ "><a href="#è¾“å‡ºæ ¼å¼ç»ƒä¹ " class="headerlink" title="è¾“å‡ºæ ¼å¼ç»ƒä¹ "></a>è¾“å‡ºæ ¼å¼ç»ƒä¹ </h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">18</span>]: <span class="string">'i am %s'</span> %(<span class="string">'renjin'</span>)</div><div class="line">Out[<span class="number">18</span>]: <span class="string">'i am renjin'</span></div><div class="line">In [<span class="number">24</span>]: <span class="string">'i am %(name)s'</span> %&#123;<span class="string">'name'</span>:<span class="string">'renjin'</span>&#125;</div><div class="line">Out[<span class="number">24</span>]: <span class="string">'i am renjin'</span></div><div class="line">In [<span class="number">29</span>]: <span class="string">'i am %s my name is %s'</span> %(<span class="string">'ssjinyao'</span>,<span class="string">'renjin'</span>)</div><div class="line">Out[<span class="number">29</span>]: <span class="string">'i am ssjinyao my name is renjin'</span></div></pre></td></tr></table></figure><h2 id="format-è¾“å‡ºæ ¼å¼"><a href="#format-è¾“å‡ºæ ¼å¼" class="headerlink" title="format è¾“å‡ºæ ¼å¼"></a>format è¾“å‡ºæ ¼å¼</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">3</span>]: <span class="string">'I am &#123;&#125;'</span>.format(<span class="string">'ssjinyao'</span>)</div><div class="line">Out[<span class="number">3</span>]: <span class="string">'I am ssjinyao'</span></div><div class="line">In [<span class="number">4</span>]: <span class="string">'I am &#123;&#125; my age is &#123;&#125;'</span>.format(<span class="string">'ssjinyao'</span>,<span class="number">23</span>)</div><div class="line">Out[<span class="number">4</span>]: <span class="string">'I am ssjinyao my age is 23'</span></div><div class="line">In [<span class="number">5</span>]: <span class="string">'I am &#123;1&#125; my age is &#123;0&#125;'</span>.format(<span class="number">23</span>,<span class="string">'ssjinyao'</span>)</div><div class="line">Out[<span class="number">5</span>]: <span class="string">'I am ssjinyao my age is 23'</span></div><div class="line">In [<span class="number">6</span>]: <span class="string">'I am &#123;name&#125; my age is &#123;age&#125;'</span>.format(age=<span class="string">'23'</span>,name=<span class="string">'ssjinyao'</span>)</div><div class="line">Out[<span class="number">6</span>]: <span class="string">'I am ssjinyao my age is 23'</span></div><div class="line">In [<span class="number">8</span>]: <span class="string">'I am &#123;0&#125; my name is &#123;0&#125;'</span>.format(<span class="string">'ssjinyao'</span>)</div><div class="line">Out[<span class="number">8</span>]: <span class="string">'I am ssjinyao my name is ssjinyao'</span></div><div class="line">In [<span class="number">15</span>]: <span class="string">'&#123;&#125; name &#123;&#125; and age is &#123;age&#125;'</span>.format(<span class="string">'renjin'</span>,<span class="string">'ssjinyao'</span>,age=<span class="string">'23'</span>)</div><div class="line">Out[<span class="number">15</span>]: <span class="string">'renjin name ssjinyao and age is 23'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">16</span>]: <span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">()</span>:</span></div><div class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    ...:         self.x=<span class="number">1</span></div><div class="line">    ...:         self.y=<span class="number">2</span></div><div class="line">    ...:</div><div class="line">In [<span class="number">17</span>]: a = A()</div><div class="line">In [<span class="number">18</span>]: a.x</div><div class="line">Out[<span class="number">18</span>]: <span class="number">1</span></div><div class="line">In [<span class="number">19</span>]: a.y</div><div class="line">Out[<span class="number">19</span>]: <span class="number">2</span></div><div class="line">In [<span class="number">24</span>]: <span class="string">'&#123;inst.x&#125;'</span>.format(inst=a)</div><div class="line">Out[<span class="number">24</span>]: <span class="string">'1'</span></div><div class="line">In [<span class="number">20</span>]: <span class="string">'&#123;0.x&#125; &#123;0.y&#125;'</span>.format(a)</div><div class="line">Out[<span class="number">20</span>]: <span class="string">'1 2'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">26</span>]: <span class="string">'&#123;0!a&#125;'</span>.format(<span class="string">'é€æ°´é”¦é¥'</span>)</div><div class="line">Out[<span class="number">26</span>]: <span class="string">"'\\u901d\\u6c34\\u9526\\u9065'"</span></div><div class="line">In [<span class="number">27</span>]: <span class="string">'&#123;0:^80&#125;'</span>.format(<span class="string">'é€æ°´é”¦é¥'</span>)</div><div class="line">Out[<span class="number">27</span>]: <span class="string">'                                      é€æ°´é”¦é¥                                      '</span></div><div class="line">In [<span class="number">29</span>]: <span class="string">'&#123;0:&lt;80&#125;'</span>.format(<span class="string">'é€æ°´é”¦é¥'</span>)</div><div class="line">Out[<span class="number">29</span>]: <span class="string">'é€æ°´é”¦é¥                                                                            '</span></div><div class="line"></div><div class="line">In [<span class="number">30</span>]: <span class="string">'&#123;0:&gt;80&#125;'</span>.format(<span class="string">'é€æ°´é”¦é¥'</span>)</div><div class="line">Out[<span class="number">30</span>]: <span class="string">'                                                                            é€æ°´é”¦é¥'</span></div><div class="line">In [<span class="number">34</span>]: <span class="string">'&#123;0:&#123;fill&#125;^&#123;width&#125;&#125;'</span>.format(<span class="string">'é€æ°´é”¦é¥'</span>,width=<span class="string">'80'</span>,fill=<span class="string">'*'</span>)</div><div class="line">Out[<span class="number">34</span>]: <span class="string">'**************************************é€æ°´é”¦é¥**************************************'</span></div><div class="line"></div><div class="line">In [<span class="number">35</span>]: <span class="string">'&#123;message:&#123;fill&#125;^&#123;width&#125;&#125;'</span>.format(message=<span class="string">'é€æ°´é”¦é¥'</span>,width=<span class="string">'80'</span>,fill=<span class="string">'*'</span>)</div><div class="line">Out[<span class="number">35</span>]: <span class="string">'**************************************é€æ°´é”¦é¥**************************************'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">41</span>]: s = <span class="string">'é€æ°´é”¦é¥'</span></div><div class="line">In [<span class="number">42</span>]: b = s.encode()</div><div class="line">In [<span class="number">43</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> s:</div><div class="line">    ...:     <span class="keyword">print</span> (x)</div><div class="line">    ...:</div><div class="line">é€</div><div class="line">æ°´</div><div class="line">é”¦</div><div class="line">é¥</div><div class="line"></div><div class="line">In [<span class="number">44</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> b:</div><div class="line">    ...:     <span class="keyword">print</span> (x)</div><div class="line">    ...:</div><div class="line"><span class="number">233</span></div><div class="line"><span class="number">128</span></div><div class="line"><span class="number">157</span></div><div class="line"><span class="number">230</span></div><div class="line"><span class="number">176</span></div><div class="line"><span class="number">180</span></div><div class="line"><span class="number">233</span></div><div class="line"><span class="number">148</span></div><div class="line"><span class="number">166</span></div><div class="line"><span class="number">233</span></div><div class="line"><span class="number">129</span></div><div class="line"><span class="number">165</span></div><div class="line">In [<span class="number">44</span>]: <span class="keyword">for</span> x <span class="keyword">in</span> b:</div><div class="line">    ...:     <span class="keyword">print</span> (x)</div><div class="line">    ...:</div><div class="line"><span class="number">233</span></div><div class="line"><span class="number">128</span></div><div class="line"><span class="number">157</span></div><div class="line"><span class="number">230</span></div><div class="line"><span class="number">176</span></div><div class="line"><span class="number">180</span></div><div class="line"><span class="number">233</span></div><div class="line"><span class="number">148</span></div><div class="line"><span class="number">166</span></div><div class="line"><span class="number">233</span></div><div class="line"><span class="number">129</span></div><div class="line"><span class="number">165</span></div><div class="line">In [<span class="number">45</span>]: b.decode()</div><div class="line">Out[<span class="number">45</span>]: <span class="string">'é€æ°´é”¦é¥'</span></div></pre></td></tr></table></figure><h2 id="python3-æ ¼å¼è½¬æ¢"><a href="#python3-æ ¼å¼è½¬æ¢" class="headerlink" title="python3 æ ¼å¼è½¬æ¢"></a>python3 æ ¼å¼è½¬æ¢</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># cat &lt;&lt;EOF &gt;&gt; utf-8.txt</span></div><div class="line">é€æ°´é”¦é¥</div><div class="line">EOF</div><div class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># iconv -f UTF-8 -f UTF-8 -t GBK utf-8.txt</span></div><div class="line">ï¿½ï¿½Ë®ï¿½ï¿½Ò£</div><div class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># iconv -f UTF-8 -f UTF-8 -t GBK utf-8.txt &gt; gbk.txt</span></div><div class="line">(py3_env) [root@laoba<span class="number">-10</span><span class="number">-17</span>:~/mypython/python3]<span class="comment"># cat gbk.txt</span></div><div class="line">ï¿½ï¿½Ë®ï¿½ï¿½Ò£</div><div class="line">In [<span class="number">6</span>]: f = open(<span class="string">'/root/mypython/python3/gbk.txt'</span>,<span class="string">'rb'</span>)</div><div class="line">In [<span class="number">7</span>]: buf = f.read()</div><div class="line">In [<span class="number">8</span>]: buf.decode(<span class="string">'GBK'</span>)</div><div class="line">Out[<span class="number">8</span>]: <span class="string">'é€æ°´é”¦é¥\n'</span></div><div class="line">In [<span class="number">9</span>]: name = buf.decode(<span class="string">'GBK'</span>)</div><div class="line">In [<span class="number">10</span>]: <span class="keyword">print</span> (name)</div><div class="line">é€æ°´é”¦é¥</div></pre></td></tr></table></figure><h2 id="åŸºäºsocket-ä¹‹é—´çš„ç¼–ç æ ¼å¼è½¬æ¢"><a href="#åŸºäºsocket-ä¹‹é—´çš„ç¼–ç æ ¼å¼è½¬æ¢" class="headerlink" title="åŸºäºsocket ä¹‹é—´çš„ç¼–ç æ ¼å¼è½¬æ¢"></a>åŸºäºsocket ä¹‹é—´çš„ç¼–ç æ ¼å¼è½¬æ¢</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æœåŠ¡ç«¯</span></div><div class="line">In [<span class="number">14</span>]: <span class="keyword">import</span> socket</div><div class="line">In [<span class="number">15</span>]: s = socket.socket(family=socket.AF_INET, type=socket.SOCK_STREAM)</div><div class="line">In [<span class="number">16</span>]: s.bind((<span class="string">'0.0.0.0'</span>,<span class="number">3000</span>))</div><div class="line">In [<span class="number">17</span>]: s.listen()</div><div class="line">In [<span class="number">18</span>]: fd, addr = s.accept()</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®¢æˆ·ç«¯</span></div><div class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> socket</div><div class="line">In [<span class="number">2</span>]: s = socket.socket(family=socket.AF_INET, type=socket.SOCK_STREAM)</div><div class="line">In [<span class="number">4</span>]: so = s.connect((<span class="string">'127.0.0.1'</span>,<span class="number">3000</span>))</div><div class="line">In [<span class="number">5</span>]: s.send(<span class="string">'é€æ°´é”¦é¥'</span>.encode())</div><div class="line">Out[<span class="number">5</span>]: <span class="number">12</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æœåŠ¡ç«¯</span></div><div class="line">In [<span class="number">33</span>]: fd.recv(<span class="number">1024</span>)</div><div class="line">Out[<span class="number">33</span>]: <span class="string">b'\xe9\x80\x9d\xe6\xb0\xb4\xe9\x94\xa6\xe9\x81\xa5'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®¢æˆ·ç«¯</span></div><div class="line">In [<span class="number">22</span>]: s.send(<span class="string">'é€æ°´é”¦é¥'</span>.encode())</div><div class="line">Out[<span class="number">22</span>]: <span class="number">12</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æœåŠ¡ç«¯</span></div><div class="line">In [<span class="number">40</span>]: buf = fd.recv(<span class="number">1024</span>)</div><div class="line">In [<span class="number">41</span>]: buf.decode()</div><div class="line">Out[<span class="number">41</span>]: <span class="string">'é€æ°´é”¦é¥'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®¢æˆ·ç«¯</span></div><div class="line">In [<span class="number">23</span>]: s.send(<span class="string">'ä¹ä¹åœ¨çº¿'</span>.encode())</div><div class="line">Out[<span class="number">23</span>]: <span class="number">12</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æœåŠ¡ç«¯</span></div><div class="line">In [<span class="number">42</span>]: buf = fd.recv(<span class="number">1024</span>)</div><div class="line">In [<span class="number">43</span>]: buf.decode()</div><div class="line">Out[<span class="number">43</span>]: <span class="string">'ä¹ä¹åœ¨çº¿'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®¢æˆ·ç«¯</span></div><div class="line">In [<span class="number">24</span>]: s.send(<span class="string">'é€æ°´é”¦é¥ï¼Œä¹ä¹åœ¨çº¿'</span>.encode())</div><div class="line">Out[<span class="number">24</span>]: <span class="number">27</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æœåŠ¡ç«¯</span></div><div class="line">In [<span class="number">45</span>]: buf = fd.recv(<span class="number">1024</span>)</div><div class="line">In [<span class="number">46</span>]: buf.decode()</div><div class="line">Out[<span class="number">46</span>]: <span class="string">'é€æ°´é”¦é¥ï¼Œä¹ä¹åœ¨çº¿'</span></div></pre></td></tr></table></figure><p>åŸºäº socket ä¹‹é—´çš„jsonæ ¼å¼ä¼ è¾“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®¢æˆ·ç«¯ç”Ÿæˆjsonæ ¼å¼çš„æ•°æ®å¹¶å‘é€</span></div><div class="line">In [<span class="number">26</span>]: <span class="keyword">import</span> json</div><div class="line">In [<span class="number">27</span>]: data = &#123;<span class="string">'name'</span>:<span class="string">'ssjinyao'</span>,&#125;</div><div class="line">In [<span class="number">28</span>]: data = &#123;<span class="string">'name'</span>:<span class="string">'ssjinyao'</span>,<span class="string">'owner'</span>:<span class="string">'renjin'</span>&#125;</div><div class="line">In [<span class="number">30</span>]: json.dumps(data)</div><div class="line">Out[<span class="number">30</span>]: <span class="string">'&#123;"name": "ssjinyao", "owner": "renjin"&#125;'</span></div><div class="line">In [<span class="number">31</span>]: js = json.dumps(data)</div><div class="line">In [<span class="number">32</span>]: s.send(js.encode())</div><div class="line">Out[<span class="number">32</span>]: <span class="number">39</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æœåŠ¡ç«¯æ¥æ”¶å‘é€è¿‡æ¥çš„jsonæ•°æ®</span></div><div class="line">In [<span class="number">47</span>]: buf = fd.recv(<span class="number">1024</span>)</div><div class="line">In [<span class="number">48</span>]: buf.decode()</div><div class="line">Out[<span class="number">48</span>]: <span class="string">'&#123;"name": "ssjinyao", "owner": "renjin"&#125;'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ä¸€èˆ¬å‘é€ç«¯ä¼šæŒ‡å®šç¼–ç </span></div><div class="line">In [<span class="number">34</span>]: s.send(js.encode(<span class="string">'UTF-8'</span>))</div><div class="line">Out[<span class="number">34</span>]: <span class="number">39</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ¥æ”¶ç«¯ä¹Ÿä¼šæŒ‡å®šç¼–ç ï¼Œè¿™æ ·ä¸ä¼šå‡ºç°ä¹±ç ã€</span></div><div class="line">In [<span class="number">50</span>]: buf.decode(<span class="string">'UTF-8'</span>)</div><div class="line">Out[<span class="number">50</span>]: <span class="string">'&#123;"name": "ssjinyao", "owner": "renjin"&#125;'</span></div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>keepalived+nginx+inotify+rsyncçš„å®ç°</title>
      <link href="/2018/08/08/keepalived+nginx+inotify+rsync%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/2018/08/08/keepalived+nginx+inotify+rsync%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ¶æ„ä¸å®ç°"><a href="#ç¯å¢ƒæ¶æ„ä¸å®ç°" class="headerlink" title="ç¯å¢ƒæ¶æ„ä¸å®ç°"></a>ç¯å¢ƒæ¶æ„ä¸å®ç°</h1><h2 id="å®éªŒç¯å¢ƒä»‹ç»"><a href="#å®éªŒç¯å¢ƒä»‹ç»" class="headerlink" title="å®éªŒç¯å¢ƒä»‹ç»"></a>å®éªŒç¯å¢ƒä»‹ç»</h2><table><thead><tr><th>æœåŠ¡å™¨ip</th><th>æ“ä½œç³»ç»Ÿ</th><th>ä¸»æœºå</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>10.180.66.11</td><td>CentOS7.4</td><td>node1</td><td>ansibleè‡ªåŠ¨æ¨é€</td></tr><tr><td>10.180.66.12</td><td>CentOS7.4</td><td>node2</td><td>keepalived+nginx+rsyncå®¢æˆ·ç«¯</td></tr><tr><td>10.180.66.13</td><td>CentOS7.4</td><td>node3</td><td>keepalived+nginx+rsyncæœåŠ¡ç«¯</td></tr></tbody></table><p><img src="/images/keepalived-huajin1.png" alt=""></p><h2 id="å®ç°é€»è¾‘æ¶æ„å›¾"><a href="#å®ç°é€»è¾‘æ¶æ„å›¾" class="headerlink" title="å®ç°é€»è¾‘æ¶æ„å›¾"></a>å®ç°é€»è¾‘æ¶æ„å›¾</h2><p><img src="/images/keepalived+nginx+rsync+inotify.png" alt=""><br>æ³¨: ä¸Šå›¾node{1..7}æ˜¯æŒ‡nginx upstream çš„å„èŠ‚ç‚¹  </p><h2 id="ansible-ç¯å¢ƒå‡†å¤‡"><a href="#ansible-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ansible ç¯å¢ƒå‡†å¤‡"></a>ansible ç¯å¢ƒå‡†å¤‡</h2><p>node1 ansible ç¯å¢ƒçš„å‡†å¤‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/hosts</span></div><div class="line">10.180.66.11 node1 node1.ssjinyao.com</div><div class="line">10.180.66.12 node2 node2.ssjinyao.com</div><div class="line">10.180.66.13 node3 node3.ssjinyao.com</div><div class="line"><span class="comment"># for i in &#123;1..3&#125;; do ssh-copy-id -i ~/.ssh/id_rsa.pub root@node$i ; done # åŒæœºäº’ä¿¡</span></div><div class="line"><span class="comment"># yum -y install epel-release</span></div><div class="line"><span class="comment"># yum -y install ansible</span></div><div class="line"><span class="comment"># vim /etc/ansible/hosts</span></div><div class="line">[keepalived]</div><div class="line">10.180.66.12</div><div class="line">10.180.66.13</div></pre></td></tr></table></figure><h2 id="keepalived-æ‰‹åŠ¨å®‰è£…"><a href="#keepalived-æ‰‹åŠ¨å®‰è£…" class="headerlink" title="keepalived æ‰‹åŠ¨å®‰è£…"></a>keepalived æ‰‹åŠ¨å®‰è£…</h2><p>node2 ä¸ node3 keepalivedæ‰‹åŠ¨å®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># yum -y install  gcc \</div><div class="line">            openssl-devel \</div><div class="line">            libnl3-devel \</div><div class="line">            ipset-devel \</div><div class="line">            iptables-devel \</div><div class="line">            libnfnetlink-devel \</div><div class="line">            net-snmp-devel  \</div><div class="line">            procps-ng  \</div><div class="line">            psmisc  \</div><div class="line">            lsof \</div><div class="line">            grep</div><div class="line"># ntpdate ntp.aliyun.com</div><div class="line"># timedatectl set-timezone Asia/Shanghai</div><div class="line"># cd /usr/local/src</div><div class="line"># ä¸Šä¼ keepalived-2.0.6.tar.gz</div></pre></td></tr></table></figure><p>æ²¡æœ‰keepavliedåŒ…çš„å½“ç„¶ä¹Ÿå¯ä»¥åœ¨keepalived <a href="http://www.keepalived.org/" target="_blank" rel="external">å®˜ç½‘</a>ä¸‹è½½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/src/keepalived-2.0.6</div><div class="line"># ./configure --prefix=/usr/local/keepalived </div><div class="line"># make &amp;&amp; make install</div><div class="line"># mkdir /var/log/keepalived/</div><div class="line"># vim /etc/rsyslog.conf  # æœ€ååŠ å…¥</div><div class="line">local0.*                                                /var/log/keepalived/keepalived.log</div><div class="line"># </div><div class="line"># systemctl restart rsyslog</div><div class="line"># vim /usr/local/keepalived/etc/sysconfig/keepalived # å°†æœ€åä¸€è¡Œæ”¹ä¸º</div><div class="line">KEEPALIVED_OPTIONS=&quot;-D -S 0 -f /usr/local/keepalived/etc/keepalived/keepalived.conf&quot;</div></pre></td></tr></table></figure><p>node2 keepalived çš„é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"># vim /usr/local/keepalived/etc/keepalived/keepalived.conf</div><div class="line">! Configuration File for keepalived</div><div class="line"></div><div class="line">global_defs &#123;</div><div class="line">   notification_email &#123;</div><div class="line">     root@localhost</div><div class="line">   &#125;</div><div class="line">   notification_email_from Alexandre.Cassen@firewall.loc</div><div class="line">   smtp_server 127.0.0.1</div><div class="line">   smtp_connect_timeout 30</div><div class="line">   router_id node2</div><div class="line">   &#125;</div><div class="line"></div><div class="line">vrrp_script chk_nginx &#123;</div><div class="line">    script &quot;/bin/bash /usr/local/keepalived/etc/keepalived/nginx_check.sh&quot;</div><div class="line">    interval 5</div><div class="line">    weight -20</div><div class="line">&#125;</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">    state BACKUP</div><div class="line">    interface ens33</div><div class="line">    virtual_router_id 55</div><div class="line">    priority 80</div><div class="line">    nopreempt</div><div class="line">    advert_int 1</div><div class="line">    notify_master &quot;/usr/local/keepalived/etc/keepalived/message.sh  master&quot;</div><div class="line">    notify_backup &quot;/usr/local/keepalived/etc/keepalived/message.sh  backup&quot;</div><div class="line">    notify_fault  &quot;/usr/local/keepalived/etc/keepalived/message.sh  fault&quot;</div><div class="line">    unicast_src_ip 10.180.66.12</div><div class="line">    unicast_peer &#123;</div><div class="line">     10.180.66.13</div><div class="line">    &#125;</div><div class="line">    track_script &#123;</div><div class="line">       chk_nginx</div><div class="line">    &#125;</div><div class="line">    authentication &#123;</div><div class="line">        auth_type PASS</div><div class="line">        auth_pass testLLb</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual_ipaddress &#123;</div><div class="line">      10.180.66.100</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>node3 keepalived çš„é…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"># vim /usr/local/keepalived/etc/keepalived/keepalived.conf</div><div class="line">! Configuration File for keepalived</div><div class="line"></div><div class="line">global_defs &#123;</div><div class="line">   notification_email &#123;</div><div class="line">     root@localhost</div><div class="line">   &#125;</div><div class="line">   notification_email_from Alexandre.Cassen@firewall.loc</div><div class="line">   smtp_server 127.0.0.1</div><div class="line">   smtp_connect_timeout 30</div><div class="line">   router_id node2</div><div class="line">   &#125;</div><div class="line"></div><div class="line">vrrp_script chk_nginx &#123;</div><div class="line">    script &quot;/bin/bash /usr/local/keepalived/etc/keepalived/nginx_check.sh&quot;</div><div class="line">    interval 5</div><div class="line">    weight -20</div><div class="line">&#125;</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">    state BACKUP</div><div class="line">    interface ens33</div><div class="line">    virtual_router_id 55</div><div class="line">    priority 80</div><div class="line">    nopreempt</div><div class="line">    advert_int 1</div><div class="line">    notify_master &quot;/usr/local/keepalived/etc/keepalived/message.sh  master&quot;</div><div class="line">    notify_backup &quot;/usr/local/keepalived/etc/keepalived/message.sh  backup&quot;</div><div class="line">    notify_fault  &quot;/usr/local/keepalived/etc/keepalived/message.sh  fault&quot;</div><div class="line">    unicast_src_ip 10.180.66.13</div><div class="line">    unicast_peer &#123;</div><div class="line">     10.180.66.12</div><div class="line">    &#125;</div><div class="line">    track_script &#123;</div><div class="line">       chk_nginx</div><div class="line">    &#125;</div><div class="line">    authentication &#123;</div><div class="line">        auth_type PASS</div><div class="line">        auth_pass testLLb</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual_ipaddress &#123;</div><div class="line">      10.180.66.100</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>å®‰è£…å¯ç”¨nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># yum -y install nginx </div><div class="line"># systemctl start nginx </div><div class="line"># systemctl enable nginx </div><div class="line">node2 # echo &quot;node2.ssjinyao.com&quot; &gt; /usr/share/nginx/html/index.html</div><div class="line">node3 # echo &quot;node3.ssjinyao.com&quot; &gt; /usr/share/nginx/html/index.html</div><div class="line"># è‡³äºé…ç½®nginxçš„è´Ÿè½½å‡è¡¡ä¹‹å‰å†™çš„æ–‡ç« æœ‰æåˆ°è¿‡</div></pre></td></tr></table></figure><p>node2,node3 ç¼©å†™keepalived nginxæœåŠ¡ç›‘æµ‹è„šæœ¬ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /usr/local/keepalived/etc/keepalived/nginx_check.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="function"><span class="title">package</span></span>() &#123;</div><div class="line">    rpm -qf /bin/ps &amp;&gt; /dev/null || yum -y install procps-ng &amp;&gt; /dev/null</div><div class="line">    rpm -qf /bin/grep &amp;&gt; /dev/null || yum -y install grep &amp;&gt; /dev/null</div><div class="line">    rpm -qf /usr/bin/killall &amp; &gt; /dev/null || yum -y install psmisc &amp;&gt; /dev/null</div><div class="line">&#125;</div><div class="line">package</div><div class="line"></div><div class="line"><span class="function"><span class="title">nginx_state</span></span> () &#123;</div><div class="line">ps aux | grep nginx &amp;&gt; /dev/null &amp;&amp; ps -C nginx --no-header &amp;&gt; /dev/null</div><div class="line">&#125;</div><div class="line">nginx_state ; nginx_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_state_num</span></div><div class="line"></div><div class="line"><span class="function"><span class="title">nginx_port</span></span> () &#123;</div><div class="line">       netstat -tnlup | egrep <span class="string">":80\&gt;"</span> &amp;&gt; /dev/null</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">kill_keepalived</span></span> () &#123;</div><div class="line">      <span class="built_in">kill</span> -9 `cat /var/run/keepalived.pid`</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$nginx_state_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">   <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` nginx_status_one_check problem "</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</div><div class="line">   nginx_port ; nginx_port_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_port_num</span></div><div class="line">   <span class="keyword">if</span> [ <span class="variable">$nginx_port_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">   <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` nginx_port_one_check problem"</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</div><div class="line">systemctl restart nginx</div><div class="line">        sleep 2</div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">nginx_state ; nginx_state_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_state_num</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$nginx_state_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` restart nginx and nginx_status_two_check problem "</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</div><div class="line">    nginx_port ; nginx_port_num=$? ; <span class="built_in">echo</span> <span class="variable">$nginx_port_num</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$nginx_port_num</span> -ne 0 ] ; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"`date +"</span>%Y-%m-%d-%H-%M-%S<span class="string">"` restart nginx and nginx_port_two_check problem "</span> &gt;&gt; /var/<span class="built_in">log</span>/keepalived/check_nginx.log</div><div class="line">        kill_keepalived</div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure><p><code>æ³¨: keepalived ä¸­è°ƒç”¨å‘½ä»¤æ—¶ä¸è¦ç”¨lsof;</code><br><code>å½“è®¿é—®é‡è¾ƒé«˜æ—¶ï¼Œlsof æŸ¥è¯¢è¿›ç¨‹å¾ˆæ…¢ï¼Œä¼šé€ æˆkeepalivedé¢‘ç¹åˆ‡æ¢;</code></p><p>node2,node3 ä¸Šçš„keepalived ç°åœ¨å¯ä»¥å¯åŠ¨äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># systemctl start keepalived</div><div class="line"># systemctl stop  keepalived</div><div class="line">æ³¨:éœ€è¦å…³é—­selinux å’Œiptables </div><div class="line"># iptables -F</div><div class="line"># setenforce 0</div></pre></td></tr></table></figure><p>æµ‹è¯•æ•ˆæœ<br>ç›®å‰ip åœ¨node2ä¸Š<br><img src="/images/keepavlied-ip-a.png" alt=""></p><p>tcmpdump ç›‘æµ‹å•æ’­å¿ƒè·³ä¿¡æ¯<br><img src="/images/tcpdump-keepalived2.png" alt=""><br>å½“æŠŠnode2ä¸Šçš„nginxåœæ­¢æ—¶<br><img src="/images/keepavlied-nginx-ok2.png" alt=""><br><img src="/images/keepavlied-stop-nginx-ok.png" alt=""><br>å½“node2ä¸Šçš„nginxç”¨ç›‘æµ‹è„šæœ¬æ— æ³•è‡ªåŠ¨æ¢å¤æ—¶<br><img src="/images/keepavlied-stop-nginx2.png" alt=""><br><img src="/images/keepalived-return-node3.png" alt=""><br>å½“node2 nginxæ¢å¤æ—¶<br><img src="/images/keepavlied-status-keepalived.png" alt=""><br><img src="/images/keepavied-node3.png" alt=""><br>å¯ä»¥å¤šæ¬¡æœåŠ¡å®•äº†æ—¶ï¼Œè§„èŒƒåˆ’çš„æ£€æŸ¥nginxçš„å¯åŠ¨æ—¥å¿—<br><img src="/images/keepalived-messages.png" alt=""></p><h2 id="ansible-ç¼–å†™keepalived-è‡ªåŠ¨åŒ–roles"><a href="#ansible-ç¼–å†™keepalived-è‡ªåŠ¨åŒ–roles" class="headerlink" title="ansible ç¼–å†™keepalived è‡ªåŠ¨åŒ–roles"></a>ansible ç¼–å†™keepalived è‡ªåŠ¨åŒ–roles</h2><p>åœ¨ node1 ä¸Šç¼–å†™ keepalived è‡ªåŠ¨åŒ–è„šæœ¬</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tree</span></div><div class="line"><span class="string">.</span></div><div class="line"><span class="string">â”œâ”€â”€</span> <span class="string">keepalived.yml</span></div><div class="line"><span class="string">â””â”€â”€</span> <span class="string">roles</span></div><div class="line">    <span class="string">â””â”€â”€</span> <span class="string">keepalived</span></div><div class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">files</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">keepalived</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">keepalived-2.0.6.tar.gz</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">keepalived.conf.bak</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">message.sh</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">nginx_check.sh</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">rsyslog.conf</span></div><div class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">tasks</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">main.yml</span></div><div class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">templates</span></div><div class="line">        <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">keepalived.conf</span></div><div class="line">        <span class="string">â””â”€â”€</span> <span class="string">vars</span></div><div class="line">            <span class="string">â””â”€â”€</span> <span class="string">main.yml</span></div><div class="line"></div><div class="line"><span class="number">6</span> <span class="string">directories,</span> <span class="number">10</span> <span class="string">files</span></div><div class="line"></div><div class="line"><span class="comment"># vim keepalived.yml</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">- hosts:</span> <span class="string">"<span class="template-variable">&#123;&#123; keepalivedhosts &#125;&#125;</span>"</span></div><div class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></div><div class="line"><span class="attr">  roles:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">keepalived</span></div><div class="line"><span class="comment"># vim roles/keepalived/tasks/main.yml</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">set</span> <span class="string">off</span> <span class="string">selinux</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">setenforce</span> <span class="number">0</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">set</span> <span class="string">of</span> <span class="string">iptables</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">iptables</span> <span class="bullet">-F</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">required</span> <span class="string">packges</span></div><div class="line"><span class="attr">    yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></div><div class="line"><span class="attr">    with_items:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">gcc</span></div><div class="line"><span class="bullet">    -</span> <span class="string">openssl-devel</span></div><div class="line"><span class="bullet">    -</span> <span class="string">libnl3-devel</span></div><div class="line"><span class="bullet">    -</span> <span class="string">ipset-devel</span></div><div class="line"><span class="bullet">    -</span> <span class="string">iptables-devel</span></div><div class="line"><span class="bullet">    -</span> <span class="string">libnfnetlink-devel</span></div><div class="line"><span class="bullet">    -</span> <span class="string">net-snmp-devel</span></div><div class="line"><span class="bullet">    -</span> <span class="string">procps-ng</span></div><div class="line"><span class="bullet">    -</span> <span class="string">psmisc</span></div><div class="line"><span class="bullet">    -</span> <span class="string">lsof</span></div><div class="line"><span class="bullet">    -</span> <span class="string">grep</span></div><div class="line"></div><div class="line"><span class="attr">  - name:</span> <span class="string">ntpdate</span> <span class="string">time</span> <span class="string">to</span> <span class="string">keepavlied</span> <span class="string">hosts</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">ntpdate</span> <span class="string">ntp.aliyun.com</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">site</span> <span class="string">time</span> <span class="string">zone</span> <span class="string">to</span> <span class="string">Asia/Shanghai</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">timedatectl</span> <span class="string">set-timezone</span> <span class="string">Asia/Shanghai</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">keepalived_file</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">servers</span></div><div class="line"><span class="attr">    copy:</span> <span class="string">src=keepalived-&#123;&#123;</span> <span class="string">keepalivedversion</span> <span class="string">&#125;&#125;.tar.gz</span>  <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedsrc</span> <span class="string">&#125;&#125;</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">decompression</span> <span class="string">keepalived</span> <span class="string">Source</span> <span class="string">code</span> <span class="string">package</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">cd</span> <span class="string">/usr/local/src/</span> <span class="string">&amp;&amp;</span> <span class="string">tar</span> <span class="bullet">-xvf</span> <span class="string">keepalived-2.0.6.tar.gz</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">install</span> <span class="string">keepalived</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">cd</span> <span class="string">/usr/local/src/keepalived-&#123;&#123;</span> <span class="string">keepalivedversion</span> <span class="string">&#125;&#125;</span> <span class="string">&amp;&amp;</span> <span class="string">./configure</span> <span class="bullet">--prefix=/usr/local/keepalived</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">mkdir</span> <span class="string">keepalived</span> <span class="string">log</span> <span class="string">floder</span></div><div class="line"><span class="attr">    shell:</span> <span class="string">mkdir</span> <span class="string">&#123;&#123;</span> <span class="string">keepalivedlogpath</span> <span class="string">&#125;&#125;</span> <span class="bullet">-pv</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">rsyslog</span> <span class="string">config</span> <span class="string">to</span> <span class="string">keepalived</span></div><div class="line"><span class="attr">    copy:</span> <span class="string">src=rsyslog.conf</span> <span class="string">dest=/etc</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">restart</span> <span class="string">rsyslog</span></div><div class="line"><span class="attr">    service:</span> <span class="string">name=rsyslog</span> <span class="string">state=restarted</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">keepalived</span>  <span class="string">sysconfig</span> <span class="string">file</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></div><div class="line"><span class="attr">    copy:</span> <span class="string">src=keepalived</span>  <span class="string">dest=/usr/local/keepalived/etc/sysconfig</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">keepalived</span> <span class="string">nginx</span> <span class="string">monitor</span> <span class="string">bash</span> <span class="string">script</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></div><div class="line"><span class="attr">    copy:</span> <span class="string">src=nginx_check.sh</span>  <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedpath</span> <span class="string">&#125;&#125;etc/keepalived/</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">keepalived</span> <span class="string">nginx</span> <span class="string">messge</span> <span class="string">bash</span> <span class="string">script</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></div><div class="line"><span class="attr">    copy:</span> <span class="string">src=message.sh</span>  <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedpath</span> <span class="string">&#125;&#125;etc/keepalived/</span> <span class="string">mode=755</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">copy</span> <span class="string">keepalived</span> <span class="string">config</span> <span class="string">file</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">server</span></div><div class="line"><span class="attr">    template:</span> <span class="string">src=keepalived.conf</span> <span class="string">dest=&#123;&#123;</span> <span class="string">keepalivedpath</span> <span class="string">&#125;&#125;etc/keepalived/</span></div><div class="line"><span class="comment"># vim roles/keepalived/vars/main.yml</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">keepalivedhosts:</span> <span class="string">keepalived</span></div><div class="line"><span class="attr">keepalivedversion:</span> <span class="number">2.0</span><span class="number">.6</span></div><div class="line"><span class="attr">keepalivedpath:</span> <span class="string">/usr/local/keepalived/</span></div><div class="line"><span class="attr">keepalivedsrc:</span> <span class="string">/usr/local/src/</span></div><div class="line"><span class="attr">keepalivedlogpath:</span> <span class="string">/var/log/keepalived/</span></div><div class="line"><span class="attr">priority:</span> <span class="number">100</span></div><div class="line"><span class="attr">unicast_src_ip:</span> <span class="string">keepalived</span></div><div class="line"><span class="attr">unicast_peer1:</span> <span class="number">10.180</span><span class="number">.66</span><span class="number">.13</span></div><div class="line"><span class="attr">unicast_peer2:</span> <span class="number">10.180</span><span class="number">.66</span><span class="number">.12</span></div><div class="line"><span class="attr">virtual_ipaddress:</span> <span class="number">10.180</span><span class="number">.66</span><span class="number">.100</span></div><div class="line"></div><div class="line"><span class="comment"># vim roles/keepalived/templates/keepalived.conf</span></div><div class="line"> <span class="string">!</span> <span class="string">Configuration</span> <span class="string">File</span> <span class="string">for</span> <span class="string">keepalived</span></div><div class="line"></div><div class="line"><span class="string">global_defs</span> <span class="string">&#123;</span></div><div class="line">   <span class="string">notification_email</span> <span class="string">&#123;</span></div><div class="line">     <span class="string">root@localhost</span></div><div class="line">   <span class="string">&#125;</span></div><div class="line">   <span class="string">notification_email_from</span> <span class="string">Alexandre.Cassen@firewall.loc</span></div><div class="line">   <span class="string">smtp_server</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line">   <span class="string">smtp_connect_timeout</span> <span class="number">30</span></div><div class="line">   <span class="string">router_id</span> <span class="string">node2</span></div><div class="line">   <span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="string">vrrp_script</span> <span class="string">chk_nginx</span> <span class="string">&#123;</span></div><div class="line">    <span class="string">script</span> <span class="string">"/bin/bash /usr/local/keepalived/etc/keepalived/nginx_check.sh"</span></div><div class="line">    <span class="string">interval</span> <span class="number">5</span></div><div class="line">    <span class="string">weight</span> <span class="bullet">-20</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"></div><div class="line"><span class="string">vrrp_instance</span> <span class="string">VI_1</span> <span class="string">&#123;</span></div><div class="line">    <span class="string">state</span> <span class="string">MASTER</span></div><div class="line">    <span class="string">interface</span> <span class="string">eth0</span></div><div class="line">    <span class="string">virtual_router_id</span> <span class="number">55</span></div><div class="line">    <span class="string">priority</span> <span class="string">&#123;&#123;</span> <span class="string">priority</span> <span class="string">&#125;&#125;</span></div><div class="line">    <span class="string">nopreempt</span></div><div class="line">    <span class="string">advert_int</span> <span class="number">1</span></div><div class="line">    <span class="string">notify_master</span> <span class="string">"/usr/local/keepalived/etc/keepalived/message.sh  master"</span></div><div class="line">    <span class="string">notify_backup</span> <span class="string">"/usr/local/keepalived/etc/keepalived/message.sh  backup"</span></div><div class="line">    <span class="string">notify_fault</span>  <span class="string">"/usr/local/keepalived/etc/keepalived/message.sh  fault"</span></div><div class="line">    <span class="string">unicast_src_ip</span> <span class="string">xxx.xx.xxx.xx</span></div><div class="line">    <span class="string">unicast_peer</span> <span class="string">&#123;</span></div><div class="line">     <span class="string">xxx.xx.xxx.xx</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line">    <span class="string">track_script</span> <span class="string">&#123;</span></div><div class="line">       <span class="string">chk_nginx</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line">    <span class="string">authentication</span> <span class="string">&#123;</span></div><div class="line">        <span class="string">auth_type</span> <span class="string">PASS</span></div><div class="line">        <span class="string">auth_pass</span> <span class="string">zE2kNsRQ</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line"></div><div class="line">    <span class="string">virtual_ipaddress</span> <span class="string">&#123;</span></div><div class="line"><span class="string">xxx.xx.xxx.xxx</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line"><span class="comment"># æ³¨ï¼šä¸ºé¿å…æ„å¤–åœæ­¢ç”Ÿäº§ä¸­çš„nginxæœåŠ¡ï¼Œåœ¨ç”Ÿäº§ä¸­ï¼Œæœ€å¥½å…ˆæŠŠæœ‰å…³nginxç›‘æµ‹é…ç½®çš„æ³¨é‡Šäº†</span></div><div class="line"><span class="comment"># vim roles/keepalived/files/message.sh</span></div><div class="line"><span class="comment">#!/bin/bash</span></div><div class="line"><span class="string">/usr/bin/echo</span> <span class="string">"`date +"</span><span class="string">%Y-%m-%d-%H-%M-%S"`</span> <span class="string">node2</span> <span class="string">notify</span> <span class="string">$1</span> <span class="string">" &gt;&gt; /var/log/keepalived/shell-message.log</span></div><div class="line"><span class="string"># å…¶ä½™æ–‡keepalivedã€keepalived-2.0.6.tar.gzã€</span></div><div class="line"><span class="string">keepalived.conf.bakã€message.shã€nginx_check.shã€rsyslog.confä»¶ä¸ä»¥ä¸Šçš„ä½¿ç”¨çš„ä¸€æ ·</span></div></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æŠŠnode2,node3æ¢å¤å¿«ç…§åˆ°åˆå§‹çŠ¶æ€è·‘ä¸€æ¬¡è¯•è¯•<br><img src="/images/ansible-keepalived.png" alt=""><br>ä¸ºé¿å…ç”Ÿäº§ä¸­å‡ºç°çªå‘æƒ…å†µï¼Œæ£€æŸ¥å˜æ›´å®Œkeepalived ä¸»é…ç½®æ–‡ä»¶åæ‰‹åŠ¨å¯åŠ¨æœåŠ¡</p><h2 id="rsync-inotify-nginxé…ç½®æ–‡ä»¶å®æ—¶åŒæ­¥"><a href="#rsync-inotify-nginxé…ç½®æ–‡ä»¶å®æ—¶åŒæ­¥" class="headerlink" title="rsync+inotify nginxé…ç½®æ–‡ä»¶å®æ—¶åŒæ­¥"></a>rsync+inotify nginxé…ç½®æ–‡ä»¶å®æ—¶åŒæ­¥</h2><h3 id="ä¸»æœåŠ¡å™¨é…ç½®10-180-66-13"><a href="#ä¸»æœåŠ¡å™¨é…ç½®10-180-66-13" class="headerlink" title="ä¸»æœåŠ¡å™¨é…ç½®10.180.66.13"></a>ä¸»æœåŠ¡å™¨é…ç½®10.180.66.13</h3><p>1ã€ å®‰è£…rsync</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/src</div><div class="line"># ä¸Šä¼ rsyncæºç åŒ…</div><div class="line"># tar -xvf rsync-3.0.9.tar.gz</div><div class="line"># cd /usr/local/src/rsync-3.0.9</div><div class="line"># ./configure --prefix=/usr/local/rsync</div><div class="line"># make </div><div class="line"># make install</div></pre></td></tr></table></figure><p>2ã€ å»ºç«‹å¯†ç è®¤è¯æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># echo &apos;Tpz99YJV1p&apos; &gt;&gt; /usr/local/rsync/rsync.passwd</div><div class="line"># cd /usr/local/rsync/</div><div class="line"># chown root.root rsync.passwd</div><div class="line"># chmod 600 rsync.passwd</div><div class="line"># ll rsync.passwd # æŸ¥çœ‹æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®</div></pre></td></tr></table></figure><p>3ã€ å®‰è£… inotify </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/src/</div><div class="line"># ä¸Šä¼ inotify æºç åŒ…</div><div class="line"># tar -xvf inotify-tools-3.14.tar.gz</div><div class="line"># cd /usr/local/src/inotify-tools-3.14</div><div class="line"># ./configure --prefix=/usr/local/inotify</div><div class="line"># make</div><div class="line"># make install</div></pre></td></tr></table></figure><p>4ã€åˆ›å»º rsyncå¤åˆ¶è„šæœ¬(è¦æ³¨æ„åŒæ­¥çš„æ–¹å‘ä¸æ“ä½œ)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">host=10.180.66.13</div><div class="line">src=/etc/nginx/</div><div class="line">des=web</div><div class="line">user=usernode</div><div class="line">src_ssl=/tmp/</div><div class="line">des_ssl=ssl</div><div class="line">/usr/<span class="built_in">local</span>/inotify/bin/inotifywait -mrq --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w%f%e'</span> -e modify,delete,create,attrib <span class="variable">$src</span> <span class="variable">$src_ssl</span> | <span class="keyword">while</span> <span class="built_in">read</span> files</div><div class="line"><span class="keyword">do</span></div><div class="line">/usr/<span class="built_in">local</span>/rsync/bin/rsync -vzrtopg --delete --progress --password-file=/usr/<span class="built_in">local</span>/rsync/rsync.passwd <span class="variable">$src</span> <span class="variable">$user</span>@<span class="variable">$host</span>::<span class="variable">$des</span></div><div class="line">/usr/<span class="built_in">local</span>/rsync/bin/rsync -vzrtopg --delete --progress --password-file=/usr/<span class="built_in">local</span>/rsync/rsync.passwd <span class="variable">$src_ssl</span> <span class="variable">$user</span>@<span class="variable">$host</span>::<span class="variable">$des_ssl</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;files&#125;</span> was rsynced"</span> &amp;&gt;&gt; /var/<span class="built_in">log</span>/rsync.log</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># echo &apos;bash /root/rsync.sh &amp;&gt; /dev/null &amp;&apos; &gt;&gt; /etc/rc.local</div><div class="line"># chmod +x /etc/rc.d/rc.local</div></pre></td></tr></table></figure><p>å¤‡æœåŠ¡å™¨åŒæ­¥é…ç½®10.180.66.13</p><p>1ã€ å®‰è£…rsync(å¤‡æœåŠ¡å™¨åªå®‰è£…rsyncï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ­¥æ–‡ä»¶çš„ç›®æ ‡æœåŠ¡)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/src</div><div class="line"># ä¸Šä¼ rsyncæºç åŒ…</div><div class="line"># tar -xvf rsync-3.0.9.tar.gz</div><div class="line"># cd /usr/local/src/rsync-3.0.9</div><div class="line"># ./configure --prefix=/usr/local/rsync</div><div class="line"># make </div><div class="line"># make install</div></pre></td></tr></table></figure><p>2ã€ å»ºç«‹ç”¨æˆ·ä¸å¯†ç è®¤è¯æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/rsync/</div><div class="line"># echo &apos;usernode:Tpz99YJV1p&apos; &gt;&gt; rsync.passwd</div><div class="line"># chown root.root rsync.passwd</div><div class="line"># chmod 600 rsync.passwd</div><div class="line"># ll # æŸ¥çœ‹æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®</div></pre></td></tr></table></figure><p>3ã€ å»ºç«‹rsyncçš„å¯åŠ¨é…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/rsync</div><div class="line"># vim rsync.conf</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">uid = root</div><div class="line">gid = root</div><div class="line">use chroot = no</div><div class="line">max connections = 10</div><div class="line">strict modes = yes</div><div class="line">pid file = /var/run/rsyncd.pid</div><div class="line">lock file = /var/run/rsync.lock</div><div class="line">log file = /var/log/rsyncd.log</div><div class="line">[web]</div><div class="line">path = /etc/nginx/</div><div class="line">comment = web file</div><div class="line">ignore errors</div><div class="line">read only = no</div><div class="line">write only = no</div><div class="line">hosts allow = 10.180.66.12</div><div class="line">hosts deny = *</div><div class="line">list = false</div><div class="line">uid = root</div><div class="line">gid = root</div><div class="line">auth users = usernode</div><div class="line">secrets file = /usr/local/rsync/rsync.passwd</div><div class="line"></div><div class="line">[ssl]</div><div class="line">path = /tmp/</div><div class="line">comment = ssl file</div><div class="line">ignore errors</div><div class="line">read only = no</div><div class="line">write only = no</div><div class="line">hosts allow = 10.180.66.12</div><div class="line">hosts deny = *</div><div class="line">list = false</div><div class="line">uid = root</div><div class="line">gid = root</div><div class="line">auth users = usernode</div><div class="line">secrets file = /usr/local/rsync/rsync.passwd</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  /usr/local/rsync/bin/rsync --daemon --config=/usr/local/rsync/rsync.conf</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># echo &apos;/usr/local/rsync/bin/rsync --daemon --config=/usr/local/rsync/rsync.conf&apos; &gt;&gt; /etc/rc.d/rc.local</div><div class="line"># chmod +x /etc/rc.d/rc.local</div></pre></td></tr></table></figure><h3 id="åœ¨10-180-66-12-å¼€å§‹å¾€-10-180-66-13ä¸Šé¢åŒæ­¥"><a href="#åœ¨10-180-66-12-å¼€å§‹å¾€-10-180-66-13ä¸Šé¢åŒæ­¥" class="headerlink" title="åœ¨10.180.66.12 å¼€å§‹å¾€ 10.180.66.13ä¸Šé¢åŒæ­¥"></a>åœ¨10.180.66.12 å¼€å§‹å¾€ 10.180.66.13ä¸Šé¢åŒæ­¥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># bash /root/rsync.sh &amp;&gt; /dev/null &amp;  æ³¨: shell</div></pre></td></tr></table></figure><h3 id="é…ç½®åŒæ­¥ç»“æœå¦‚ä¸‹"><a href="#é…ç½®åŒæ­¥ç»“æœå¦‚ä¸‹" class="headerlink" title="é…ç½®åŒæ­¥ç»“æœå¦‚ä¸‹"></a>é…ç½®åŒæ­¥ç»“æœå¦‚ä¸‹</h3><p><img src="/images/rysnc+inotify.png" alt=""><br><img src="/images/rsync+inotify2.png" alt=""></p><p>æ³¨æ„:<br>nginx åŒæ­¥é…ç½®çš„æºåœ°å€ä¸ç›®æ ‡åœ°å€ä¸€å®šè¦æ³¨æ„ï¼Œå¦‚æœå¯¹ä»¥ä¸Šé…ç½®ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œä¸€å®šè¦æµ‹è¯•æ— è¯¯å<br>      å†ä¸Šç”Ÿäº§ç¯å¢ƒï¼Œ ä¸è¦æŠŠç”Ÿäº§ä¸­çš„é…ç½®æ›¿æ¢äº†<br>keepalived åœ¨è‡ªåŠ¨åŒ–åˆå§‹åŒ–æ—¶ï¼Œä¸è¦å¯ç”¨nginxç›‘æµ‹ï¼Œå¦å¤–æ³¨æ„åœ¨ç”Ÿäº§ä¸­çš„è™šæ‹Ÿipå†²çª;  </p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>hadoopå­¦ä¹ ç¬”è®°</title>
      <link href="/2018/07/29/hadoop/"/>
      <url>/2018/07/29/hadoop/</url>
      <content type="html"><![CDATA[<h2 id="hadoopå­¦ä¹ ç¬”è®°"><a href="#hadoopå­¦ä¹ ç¬”è®°" class="headerlink" title="hadoopå­¦ä¹ ç¬”è®°"></a>hadoopå­¦ä¹ ç¬”è®°</h2><p><img src="/images/hadoop.png" alt=""></p><h2 id="Bigdata"><a href="#Bigdata" class="headerlink" title="Bigdata"></a>Bigdata</h2><hr><pre><code>ç»“æ„åŒ–æ•°æ®: çº¦æŸåŠç»“æ„åŒ–æ•°æ®:éç»“æ„åŒ–æ•°æ®: æ²¡æœ‰å…ƒæ•°æ®ï¼›æœç´¢å¼•æ“ï¼šæœç´¢ç»„ä»¶ã€ç´¢å¼•ç»„ä»¶å…±åŒç»„æˆ        èœ˜è››ç¨‹åº:        å­˜å‚¨ï¼š        åˆ†æå¤„ç†ï¼š2003å¹´: The Google File System2004å¹´:  MapReduce:  Simplified Data Processing On large Cluster2006å¹´: BigTable: A Distributed Strorage System for Structure DataHDFS + MapReduce  = HadoopHBaseNutchMapRduce æ˜¯æ‰¹å¤„ç†ç¨‹åº:DN: Data Node   NN: Name Node SNN: Secondary Name Nodeå‡½æ•°å¼ç¼–ç¨‹:    Lisp, MLå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼›é«˜é˜¶å‡½æ•°ï¼›        map, fold        map: ä¸€ä¸ªä»»åŠ¡æ˜ å°„ä¸ºå¤šä¸ªmap(f())        map: æ¥å—ä¸€ä¸ªå‡½æ•°ä¸ºå‚æ•°ï¼Œå¹¶å°†å…¶åº”ç”¨äºåˆ—è¡¨ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä»è€Œç”Ÿæˆä¸€ä¸ªç»“æœåˆ—è¡¨;        fold: æ¥å—ä¸¤ä¸ªèƒ½æ•°ï¼šå‡½æ•°ï¼Œåˆå§‹å€¼fold(g(), init)    mapreduce:  mapper, reducer    mapper:ç»Ÿè®¡ã€æ’åº k-v(é”®å€¼æ•°æ®)ç»Ÿè®¡ä¸€æœ¬ä¹¦æ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°:    mapper:æ¯100é¡µä¸€ä¸ªå•ä½ï¼Œ 5 mappers        ç”¨äºæ‹†åˆ†æˆä¸ºå•è¯:10000000    reducer:        reducer1, reducer2    mapper: this 1, is 1 ,this1 ,how1    åŒä¸€ä¸ªé”®çš„æ•°æ®åªèƒ½å‘å¾€åŒä¸€ä¸ªreducer    reducer: this 500 is    MRv1(Hadoop2) --&gt; MRv2(Hadoop2)        MRv1: Cluster resource manager,Data processing        MRv2:             YARN: Cluster resource manager            MRv2: Data processing                MR: batch                Tez: execution engine                 RM: Resource Manager                NM: Node Manager                AM: Application Master                container: mrä»»åŠ¡                Ambari             Hadoop Distribution:            Cloudera: CDH            Hortonworks: HDP            Intel: IDH            MapR:</code></pre><hr><h2 id="å®‰è£…ä½¿ç”¨Hadoop"><a href="#å®‰è£…ä½¿ç”¨Hadoop" class="headerlink" title="å®‰è£…ä½¿ç”¨Hadoop"></a>å®‰è£…ä½¿ç”¨Hadoop</h2><p>å•æœºæ¨¡å‹: æµ‹è¯•ä½¿ç”¨;<br>ä¼ªåˆ†å¸ƒå¼æ¨¡å‹: è¿è¡Œäºå•æœº;<br>åˆ†å¸ƒå¼æ¨¡å‹: é›†ç¾¤æ¨¡å‹;<br>Hadoopï¼ŒåŸºäºJavaè¯­è¨€;<br>éœ€è¦é…ç½®jvmå’Œjvm homeç¯å¢ƒ;<br>    jdk: 1.6, 1.7, 1.8<br>        hadoop-2.6.2  jdk 1.6+</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># yum -y install java-1.7.0-openjdk.x86_64</div><div class="line"># vim /etc/profile.d/java.sh</div><div class="line">export JAVA_HOME=/usr</div><div class="line"># chmod +x /etc/profile.d/java.sh</div><div class="line"># source /etc/profile.d/java.sh</div><div class="line"># yum -y install java-1.7.0-openjdk-devel</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># cd /usr/local/src &amp;&amp; # wget https://archive.apache.org/dist/hadoop/core/hadoop-2.6.1/hadoop-2.6.1.tar.gz</div><div class="line">#</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Hyperledger Fabric 1.0éƒ¨ç½²ä¸ä½¿ç”¨</title>
      <link href="/2018/07/19/Hyperledger%E7%9A%84%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/07/19/Hyperledger%E7%9A%84%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<h1 id="Hyperledger-Fabric-1-0éƒ¨ç½²ä¸ä½¿ç”¨"><a href="#Hyperledger-Fabric-1-0éƒ¨ç½²ä¸ä½¿ç”¨" class="headerlink" title="Hyperledger Fabric 1.0éƒ¨ç½²ä¸ä½¿ç”¨"></a>Hyperledger Fabric 1.0éƒ¨ç½²ä¸ä½¿ç”¨</h1><p><img src="/images/hyperledger_chatu.png" alt=""></p><h2 id="1-ç¯å¢ƒæ„å»ºä¸æµ‹è¯•"><a href="#1-ç¯å¢ƒæ„å»ºä¸æµ‹è¯•" class="headerlink" title="1.ç¯å¢ƒæ„å»ºä¸æµ‹è¯•"></a>1.ç¯å¢ƒæ„å»ºä¸æµ‹è¯•</h2><p>æœ¬æ–‡ä¸­ç”¨åˆ°çš„å®¿ä¸»ç¯å¢ƒæ˜¯CentOSï¼Œç‰ˆæœ¬ä¸ºCentOS.x86_64(7.4);<br>é€šè¿‡Dcokerå®¹å™¨æ¥è¿è¡ŒFabricçš„èŠ‚ç‚¹ï¼Œç‰ˆæœ¬ä¸ºv1.0;<br>å› æ­¤ï¼Œå¯åŠ¨Fabricç½‘ç»œçš„èŠ‚ç‚¹éœ€è¦å…ˆå®‰è£… Dockerã€Docker-composeå’ŒGoè¯­è¨€ç¯å¢ƒ;<br>ç„¶ååœ¨ç½‘ä¸Šæ‘˜å–ç›¸å…³çš„Dockeré•œåƒï¼Œå†èƒ½è¿‡é…ç½®composeæ–‡ä»¶æ¥å¯åŠ¨å„ä¸ªèŠ‚ç‚¹;</p><h3 id="1-1-CentOS-yumæºçš„é…ç½®"><a href="#1-1-CentOS-yumæºçš„é…ç½®" class="headerlink" title="1.1: CentOS yumæºçš„é…ç½®"></a>1.1: CentOS yumæºçš„é…ç½®</h3><p>å…¬å¸å†…ç½‘ï¼Œå¯ä»¥è®©æœåŠ¡å™¨ä»¥æ¡¥æ¥æ–¹å¼æ¥å…¥ç½‘ç»œ;</p><p>aã€å¤‡ä»½åŸæœ‰çš„yumæºé…ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># æ³¨:è‹¥ç³»ç»Ÿç¯å¢ƒæ˜¯åˆå§‹åŒ–å®‰è£…çš„ï¼Œæœ€å¥½å…ˆå®‰è£…ä»¥ä¸‹è½¯ä»¶åŒ…</div><div class="line"># yum -y install wget screen vim</div><div class="line"># cd /etc/yum.repos.d/ &amp;&amp; mkdir bak</div><div class="line"># mv *repo bak</div></pre></td></tr></table></figure><p>bã€è®¾ç½®é˜¿é‡Œyumæº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</div></pre></td></tr></table></figure><p>cã€æ¸…ç†ç¼“å­˜å¹¶ç”Ÿæˆæ–°çš„ç¼“å­˜</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># yum clean all </div><div class="line"># yum makecache</div></pre></td></tr></table></figure><p>dã€æ›´æ–°yumåº“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum update</div></pre></td></tr></table></figure><blockquote><p>æ­¤æ“ä½œçš„ç›®çš„æ˜¯ä¸ºæ›´æ–°æ‰€æœ‰çš„å†…ç½®åº“åˆ°æœ€æ–°ç‰ˆ;<br>å› ä¸ºdockeræœ€æ–°ç‰ˆçš„å®‰è£…éœ€è¦æ‰€å¯¹åº”çš„ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆ;<br>ä¸ºäº†é¿å…å®‰è£…æ—¶è½¯ä»¶åŒ…ä¾èµ–çš„å‘ï¼Œæ•…å¦‚æ­¤æ“ä½œ;  </p></blockquote><h3 id="1-2-Dockerå®‰è£…"><a href="#1-2-Dockerå®‰è£…" class="headerlink" title="1.2: Dockerå®‰è£…"></a>1.2: Dockerå®‰è£…</h3><p><a href="https://www.docker.com/" target="_blank" rel="external">è¿›å…¥dockerå®˜ç½‘</a></p><p>aã€GetDockerâ€“&gt; CentOS â€“&gt; Get CE ç¤¾åŒºç‰ˆ  â€“&gt; Get Docker CE on CentOS â€“&gt; Install Docker CE on CentOS.  </p><p>bã€è‹¥æœåŠ¡å™¨ä¸Šå­˜åœ¨æ—§çš„dockerç‰ˆæœ¬ï¼Œéœ€è¦å…ˆæ‰§è¡Œä»¥ä¸‹æ“ä½œ: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum -y remove docker docker-common docker-selinux docker-engine</div></pre></td></tr></table></figure><p>cã€éšåå¼€å§‹å®‰è£…Docker CE<br>ç›®å‰Dockerå®˜æ–¹æœ€æ–°ç‰ˆä¸º<code>docker-ce-17.12.1.ce-1.el7.centos.x86_64.rpm</code>;<br>å¯ä»¥åœ¨<a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="external">docker rpmåŒ…ä¸­ä¸‹è½½å¹¶å®‰è£…</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># mkdir -p /tmp/rpm/docker</div><div class="line"># cd /tmp/rpm/docker </div><div class="line"># wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-17.12.1.ce-1.el7.centos.x86_64.rpm</div><div class="line"># yum -y install *docker*rpm</div></pre></td></tr></table></figure><p>dã€æ£€æŸ¥dockeræ˜¯å¦å®‰è£…æˆåŠŸ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker --version</div><div class="line">Docker version 17.12.1-ce, build 7390fc6</div></pre></td></tr></table></figure><p>eã€å¯åŠ¨dockeræœåŠ¡  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># systemctl start docker</div></pre></td></tr></table></figure><p>fã€è®¾ç½®dockerä¸ºå¼€æœºè‡ªå¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># systemctl enable docker</div></pre></td></tr></table></figure><h3 id="1-3-Docker-Composeå®‰è£…"><a href="#1-3-Docker-Composeå®‰è£…" class="headerlink" title="1.3: Docker-Composeå®‰è£…"></a>1.3: Docker-Composeå®‰è£…</h3><blockquote><p>Docker-Composeçš„ç¦»çº¿å®‰è£…ç›¸å¯¹äºcurlå®‰è£…æ¯”è¾ƒéº»çƒ¦ï¼›<br>éœ€è¦åœ¨å®˜ç½‘æä¾›çš„<a href="https://github.com/docker/compose/releases" target="_blank" rel="external">github</a>ä¸­ä¸‹è½½æœ€æ–°çš„docker-compose;<br>å°†å…¶clone /tmp/rpm/docker/ä¸‹ï¼›  </p></blockquote><p>aã€æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åå®Œæˆå®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># curl -L https://github.com/docker/compose/releases/download/1.20.0-rc1/docker-compose-`uname -s`-`uname -m` -o /tmp/rpm/docker/docker-compose</div></pre></td></tr></table></figure><p>bã€ç§»æ¤docker-composeåˆ°PATHå˜é‡ç¯å¢ƒä¸­ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># chmod +x docker-compose </div><div class="line"># cp -a docker-compose /usr/bin/</div></pre></td></tr></table></figure><p>cã€ç§»æ¤åæŸ¥çœ‹å®‰è£…çš„ç‰ˆæœ¬ä¿¡æ¯ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker-compose  --version</div><div class="line">docker-compose version 1.20.0-rc1, build 86428af</div></pre></td></tr></table></figure><p>åˆ°æ­¤dockerç¯å¢ƒå·²å‡†å¤‡å®Œæ¯•</p><h3 id="1-4-Goç¯å¢ƒå‡†å¤‡"><a href="#1-4-Goç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.4 Goç¯å¢ƒå‡†å¤‡"></a>1.4 Goç¯å¢ƒå‡†å¤‡</h3><p>aã€å‚ç…§<a href="https://golang.org/" target="_blank" rel="external">goå®˜ç½‘</a>ï¼Œä¸‹è½½æœ€æ–°çš„Goè¯­è¨€åŒ…;<br>bã€ç›´æ¥é€šè¿‡é“¾æ¥ä¸‹è½½ <a href="http://www.cnblogs.com/aberic/p/7531276.html" target="_blank" rel="external">Goå®˜ç½‘è¿æ¥</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># mkdir -p /tmp/rpm/go &amp;&amp; cd /tmp/rpm/go</div><div class="line"># wget https://test-inner.transfereasy.com/go1.8.3.linux-amd64.tar.gz</div><div class="line"># æ³¨: ç›®å‰è¿™ä¸ªåŒ…å·²ç»ç½®äºå†…ç½‘ç¯å¢ƒä¸­</div><div class="line"># æ³¨: å¯ä»¥é€šè¿‡ssjinyaoç½‘ç«™ä¸‹è½½</div><div class="line"># wget https://rjyy.ssjinyao.com/go1.8.3.linux-amd64.tar.gz</div></pre></td></tr></table></figure><p>cã€è§£å‹äºŒè¿›åˆ¶ç¨‹åºåˆ°/usr/localç›®å½•ä¸‹;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># tar -xvf go1.8.3.linux-amd64.tar.gz -C /usr/local/ </div><div class="line"># ll /usr/local/go/</div><div class="line">æ€»ç”¨é‡ 136</div><div class="line">drwxr-xr-x.  2 root root   205 5æœˆ  25 2017 api</div><div class="line">-rw-r--r--.  1 root root 33243 5æœˆ  25 2017 AUTHORS</div><div class="line">drwxr-xr-x.  2 root root    42 5æœˆ  25 2017 bin</div><div class="line">drwxr-xr-x.  4 root root    37 5æœˆ  25 2017 blog</div><div class="line">-rw-r--r--.  1 root root  1366 5æœˆ  25 2017 CONTRIBUTING.md</div><div class="line">-rw-r--r--.  1 root root 45710 5æœˆ  25 2017 CONTRIBUTORS</div><div class="line">drwxr-xr-x.  8 root root  4096 5æœˆ  25 2017 doc</div><div class="line">-rw-r--r--.  1 root root  5686 5æœˆ  25 2017 favicon.ico</div><div class="line">drwxr-xr-x.  3 root root    18 5æœˆ  25 2017 lib</div><div class="line">-rw-r--r--.  1 root root  1479 5æœˆ  25 2017 LICENSE</div><div class="line">drwxr-xr-x. 14 root root   190 5æœˆ  25 2017 misc</div><div class="line">-rw-r--r--.  1 root root  1303 5æœˆ  25 2017 PATENTS</div><div class="line">drwxr-xr-x.  7 root root    87 5æœˆ  25 2017 pkg</div><div class="line">-rw-r--r--.  1 root root  1399 5æœˆ  25 2017 README.md</div><div class="line">-rw-r--r--.  1 root root    26 5æœˆ  25 2017 robots.txt</div><div class="line">drwxr-xr-x. 46 root root  4096 5æœˆ  25 2017 src</div><div class="line">drwxr-xr-x. 17 root root  8192 5æœˆ  25 2017 test</div><div class="line">-rw-r--r--.  1 root root     7 5æœˆ  25 2017 VERSION</div></pre></td></tr></table></figure><p>dã€é…ç½®goç¯å¢ƒå˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># echo &quot;export PATH=$PATH:/usr/local/go/bin&quot; &gt; /etc/profile.d/go.sh</div><div class="line"># echo &quot;export GOPATH=/opt/gopath&quot; &gt;&gt; /etc/profile.d/go.sh</div><div class="line"># chmod +x /etc/profile.d/go.sh</div><div class="line"># source /etc/profile.d/go.sh</div><div class="line"># echo $PATH</div><div class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/srv/jdk1.8.0_66/bin:/root/bin:/usr/local/go/bin</div><div class="line"># go version</div><div class="line">go version go1.8.3 linux/amd64</div></pre></td></tr></table></figure><p>è‡³æ­¤goç¯å¢ƒå˜é‡å·²ç»é…ç½®å®Œæ¯•  </p><h2 id="2-Fabricæºç åŠé•œåƒæ–‡ä»¶å¤„ç†"><a href="#2-Fabricæºç åŠé•œåƒæ–‡ä»¶å¤„ç†" class="headerlink" title="2.Fabricæºç åŠé•œåƒæ–‡ä»¶å¤„ç†"></a>2.Fabricæºç åŠé•œåƒæ–‡ä»¶å¤„ç†</h2><h3 id="2-1ä¸‹è½½Fabricæºç "><a href="#2-1ä¸‹è½½Fabricæºç " class="headerlink" title="2.1ä¸‹è½½Fabricæºç "></a>2.1ä¸‹è½½Fabricæºç </h3><blockquote><p>ä¸‹è½½Fabricæºæ˜¯å› ä¸ºè¦ç”¨åˆ°æºç ä¸­æåˆ°çš„ä¾‹å­å’Œå·¥å…·;<br>å·¥å…·ç¼–è¯‘éœ€è¦ç”¨åˆ°goè¯­è¨€ç¯å¢ƒ;<br>å› æ­¤éœ€è¦æŠŠæºç ç›®å½•æ”¾åˆ°$GOPATHç¯å¢ƒå˜é‡ä¸‹;<br>é€šè¿‡1.4ä¸­çš„å®‰è£…é…ç½® $GOPATHè®¾ç½®ä¸º/opt/gopath;  </p></blockquote><p><code>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨git cloneæºç </code><br><code>ä¹Ÿå¯ä»¥ä½¿ç”¨go get å‘½ä»¤</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># go get github.com/hyperledger/fabric</div><div class="line">æˆ–è€…æ˜¯</div><div class="line"># mkdir -p /opt/gopath/src/github.com/hyperledger/ </div><div class="line"># cd /opt/gopath/src/github.com/hyperledger/ &amp;&amp; git clone https://github.com/hyperledger/fabric.git</div><div class="line"># cd /opt/gopath/src/github.com/hyperledger/fabric &amp;&amp; git checkout -b v1.0.0</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"># æœ€åçš„å·¥ç¨‹ç»“æ„å¦‚ä¸‹</div><div class="line"># cd /opt/gopath/src/github.com/hyperledger</div><div class="line"># tree  -L 1 fabric/</div><div class="line">fabric/</div><div class="line">â”œâ”€â”€ bccsp</div><div class="line">â”œâ”€â”€ bddtests</div><div class="line">â”œâ”€â”€ CHANGELOG.md</div><div class="line">â”œâ”€â”€ ci.properties</div><div class="line">â”œâ”€â”€ common</div><div class="line">â”œâ”€â”€ CONTRIBUTING.md</div><div class="line">â”œâ”€â”€ core</div><div class="line">â”œâ”€â”€ devenv</div><div class="line">â”œâ”€â”€ docker-env.mk</div><div class="line">â”œâ”€â”€ docs</div><div class="line">â”œâ”€â”€ events</div><div class="line">â”œâ”€â”€ examples</div><div class="line">â”œâ”€â”€ gossip</div><div class="line">â”œâ”€â”€ gotools</div><div class="line">â”œâ”€â”€ images</div><div class="line">â”œâ”€â”€ LICENSE</div><div class="line">â”œâ”€â”€ Makefile</div><div class="line">â”œâ”€â”€ mkdocs.yml</div><div class="line">â”œâ”€â”€ msp</div><div class="line">â”œâ”€â”€ orderer</div><div class="line">â”œâ”€â”€ peer</div><div class="line">â”œâ”€â”€ proposals</div><div class="line">â”œâ”€â”€ protos</div><div class="line">â”œâ”€â”€ README.md</div><div class="line">â”œâ”€â”€ release</div><div class="line">â”œâ”€â”€ release_notes</div><div class="line">â”œâ”€â”€ sampleconfig</div><div class="line">â”œâ”€â”€ scripts</div><div class="line">â”œâ”€â”€ settings.gradle</div><div class="line">â”œâ”€â”€ test</div><div class="line">â”œâ”€â”€ unit-test</div><div class="line">â””â”€â”€ vendor</div><div class="line"></div><div class="line">23 directories, 9 files</div></pre></td></tr></table></figure><h3 id="2-2ä¸‹è½½Fabricç›¸å…³é•œåƒæ–‡ä»¶"><a href="#2-2ä¸‹è½½Fabricç›¸å…³é•œåƒæ–‡ä»¶" class="headerlink" title="2.2ä¸‹è½½Fabricç›¸å…³é•œåƒæ–‡ä»¶"></a>2.2ä¸‹è½½Fabricç›¸å…³é•œåƒæ–‡ä»¶</h3><blockquote><p>è¯¥æ“ä½œæœ‰å¤šç§æ–¹å¼è¿›è¡Œï¼Œå¦‚æœæ˜¯æµ‹è¯•Fabricé›†ç¾¤æ–¹æ¡ˆ;<br>ç›´æ¥è¿›å…¥fabric/examples/e2e_cliç›®å½•ä¸‹ï¼Œè¿è¡Œ./dowload-dockerimages.sh;<br>å³å¯ä¸‹è½½è¯¥å·¥ç¨‹å¿…è¦çš„é•œåƒæ–‡ä»¶;<br>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¿è¯é•œåƒä¸ä¸‹è½½åˆ°hyperledgerä¸­çš„æºç demoç‰ˆæœ¬å·ç›¸å¯¹åº”;<br>è¯¥å¤„æ–¹æ³•å±äºè¾ƒä¸ºå¦¥å½“çš„æ–¹æ¡ˆ; </p></blockquote><p>æ£€ç´¢ <a href="https://hub.docker.com/u/hyperledger/?page=1" target="_blank" rel="external">HyperLedger</a>,ä»¥hyperledger/fabric-peerä¸ºä¾‹ï¼Œè¿›å…¥ä¸‹è½½é¡µé¢;<br>å®˜æ–¹ç»™å‡ºçš„ä¸‹è½½æ–¹å¼å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker pull hyperledger/fabric-peer</div></pre></td></tr></table></figure><p>ä½†ç”±äºdockeré•œåƒä¸‹è½½åœ¨æ²¡æœ‰ç»™å‡ºtagçš„æƒ…å†µä¸‹ä¼šé»˜è®¤ä½¿ç”¨latest;<br>æ‰€ä»¥è¯¥æ–¹æ¡ˆæœ€ç»ˆå¯èƒ½ä¼šä¸‹è½½å¤±è´¥,å› æ­¤éœ€åœ¨fabric-peerä¸‹è½½é¡µé€‰ä¸­å…¶tagsæ ‡ç­¾;<br>æŸ¥çœ‹å½“å‰fabric-peeræœ€æ–°ç‰ˆæœ¬å·ï¼Œæ ¹æ®æˆ‘ä»¬æ‰€ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿæƒ…å†µï¼Œé€‰æ‹©x86_64-1.0.0ç‰ˆæœ¬ï¼›<br>æ•…æœ€ç»ˆæ‰§è¡Œçš„dockerä¸‹è½½å‘½ä»¤å¦‚ä¸‹:  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># docker pull hyperledger/fabric-peer:x86_64-1.0.0</div><div class="line">x86_64-1.0.0: Pulling from hyperledger/fabric-peer</div><div class="line">aafe6b5e13de: Pull complete </div><div class="line">0a2b43a72660: Pull complete </div><div class="line">18bdd1e546d2: Pull complete </div><div class="line">8198342c3e05: Pull complete </div><div class="line">f56970a44fd4: Pull complete </div><div class="line">e32b597e7839: Pull complete </div><div class="line">a6e362fc71c4: Pull complete </div><div class="line">f107ea6d90f4: Pull complete </div><div class="line">72c8e84de237: Pull complete </div><div class="line">776cc74c9f73: Pull complete </div><div class="line">Digest: sha256:b7c1c2a6b356996c3dbe2b9554055cd2b63194cd7a492a83de2dbabf7f7e3c65</div><div class="line">Status: Downloaded newer image for hyperledger/fabric-peer:x86_64-1.0.0</div></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šè¿°æ–¹æ¡ˆï¼Œå¯ä»¥å°†è¿™äº›å¿…è¦çš„é•œåƒç”±dockeræœåŠ¡å…¨éƒ¨ä¸‹è½½è‡³æœ¬åœ°;<br>å¹¶æœ€ç»ˆä½¿ç”¨docker-composeæ¥å¯åŠ¨å¯¹åº”çš„é•œåƒæœåŠ¡;<br>ä¸ºäº†æ–¹ä¾¿docker-composeçš„é…ç½®ï¼Œå°†ç”©çš„é•œåƒtagéƒ½æ”¹ä¸ºlatestï¼Œæ‰§è¡Œå¦‚ä¸‹æ ¼å¼;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker tag IMAGEID(é•œåƒid) REPOSITORY:TAG(ä»“åº“:æ ‡ç­¾)</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/</div><div class="line"># bash download-dockerimages.sh  æ³¨:ä¹Ÿå¯ä»¥ç”¨åé¢æ‰€æåˆ°shellå»ºç«‹</div><div class="line"># docker images</div><div class="line">REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">hyperledger/fabric-peer        x86_64-1.0.0        6830dcd7b9b5        8 months ago        182MB</div><div class="line">hyperledger/fabric-tools       latest              ae6b0f53cb70        9 months ago        1.32GB</div><div class="line">hyperledger/fabric-tools       x86_64-1.0.0-beta   ae6b0f53cb70        9 months ago        1.32GB</div><div class="line">hyperledger/fabric-couchdb     latest              31bbbec3d853        9 months ago        1.48GB</div><div class="line">hyperledger/fabric-couchdb     x86_64-1.0.0-beta   31bbbec3d853        9 months ago        1.48GB</div><div class="line">hyperledger/fabric-kafka       latest              c4ac1c9a4797        9 months ago        1.3GB</div><div class="line">hyperledger/fabric-kafka       x86_64-1.0.0-beta   c4ac1c9a4797        9 months ago        1.3GB</div><div class="line">hyperledger/fabric-zookeeper   latest              2c4ebacb6f00        9 months ago        1.31GB</div><div class="line">hyperledger/fabric-zookeeper   x86_64-1.0.0-beta   2c4ebacb6f00        9 months ago        1.31GB</div><div class="line">hyperledger/fabric-orderer     latest              11ff350dd297        9 months ago        179MB</div><div class="line">hyperledger/fabric-orderer     x86_64-1.0.0-beta   11ff350dd297        9 months ago        179MB</div><div class="line">hyperledger/fabric-peer        latest              e01c2b645f11        9 months ago        182MB</div><div class="line">hyperledger/fabric-peer        x86_64-1.0.0-beta   e01c2b645f11        9 months ago        182MB</div><div class="line">hyperledger/fabric-javaenv     latest              61c188dca542        9 months ago        1.42GB</div><div class="line">hyperledger/fabric-javaenv     x86_64-1.0.0-beta   61c188dca542        9 months ago        1.42GB</div><div class="line">hyperledger/fabric-ccenv       latest              7034cca1918d        9 months ago        1.29GB</div><div class="line">hyperledger/fabric-ccenv       x86_64-1.0.0-beta   7034cca1918d        9 months ago        1.29GB</div><div class="line">hyperledger/fabric-ca          latest              e549e8c53c2e        9 months ago        238MB</div><div class="line">hyperledger/fabric-ca          x86_64-1.0.0-beta   e549e8c53c2e        9 months ago        238MB</div></pre></td></tr></table></figure><h3 id="2-3è¡¥å……é•œåƒå¤‡ä»½å’Œè¿ç§»"><a href="#2-3è¡¥å……é•œåƒå¤‡ä»½å’Œè¿ç§»" class="headerlink" title="2.3è¡¥å……é•œåƒå¤‡ä»½å’Œè¿ç§»"></a>2.3è¡¥å……é•œåƒå¤‡ä»½å’Œè¿ç§»</h3><p>ä¸Šè¿°HperLedger/Fabric é•œåƒæ•°é‡è¾ƒå¤šä¸”å®¹é‡éœ€æ±‚å¤§ï¼Œä¸€å¥—åŸºæœ¬çš„æœåŠ¡é•œåƒå¯è¾¾10Gå·¦å³;<br>å¦‚æœåœ¨å¤šå°æœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œä¼šè€½è¯¯å¾ˆå¤šæ—¶é—´ã€‚å› æ­¤ï¼Œå¯¹äºä¸Šè¿°å·²ä¸‹è½½çš„é•œåƒ;<br>æˆ‘ä»¬éœ€è¦ä½¿ç”¨docker saveå‘½ä»¤æ¥å¤‡ä»½ï¼Œå¹¶é€šè¿‡scpå‘½ä»¤æ¥æŠŠè¿™äº›æ–‡ä»¶æ‹·è´è‡³å…¶å®ƒæœåŠ¡å™¨ï¼›  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat dk_image_bak.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">##  å¼€å§‹è‡ªåŠ¨å¤‡ä»½é•œåƒ</span></div><div class="line">im=`docker images  | grep latest | wc -l`</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="variable">$im</span>` ;<span class="keyword">do</span> </div><div class="line">       id=` docker images | grep latest | grep fabric | awk <span class="string">'&#123;print $3&#125;'</span> | sed -n <span class="variable">$i</span>\p`</div><div class="line">       fn=` docker images | grep latest | grep fabric | awk -F <span class="string">"/"</span> <span class="string">'&#123;print $2&#125;'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | sed -n <span class="variable">$i</span>\p `</div><div class="line">       dir=` docker images | grep latest  | grep fabric  | awk -F <span class="string">"/"</span> <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line">       mkdir -p /tmp/images/docker/<span class="variable">$dir</span>/</div><div class="line">       docker save <span class="variable">$id</span> &gt; /tmp/images/docker/<span class="variable">$dir</span>/<span class="variable">$fn</span>.gz</div><div class="line">     <span class="keyword">done</span> </div><div class="line"><span class="comment">## è‡³æ­¤idå·²ç»ä¿å­˜é•œåƒå®Œæ¯•</span></div><div class="line"><span class="comment">## å¼€å§‹è¿œç¨‹åŒæ­¥ä¸è¿ç§» </span></div><div class="line">ssh root@10.180.55.126  <span class="string">"mkdir -p /tmp/images/docker/<span class="variable">$dir</span>/"</span></div><div class="line">scp /tmp/images/docker/<span class="variable">$fn</span>/*gz root@10.180.55.126:/tmp/images/docker/<span class="variable">$dir</span>/</div></pre></td></tr></table></figure><p>å½“è¿œç«¯æœåŠ¡å™¨æ¥æ”¶åˆ°æ‰€æœ‰çš„é•œåƒä¹‹åï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥åŠ è½½è¿™äº›é•œåƒæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker load &lt; /tmp/images/docker/hyperledger/fabric-ccenv.gz</div></pre></td></tr></table></figure><p>ä»¥ä¸Š2.3é•œåƒçš„å¤‡ä»½å’Œè¿ç§»æ˜¯å¯é€‰æ–¹æ¡ˆ;</p><h2 id="3-è¿è¡Œæµ‹è¯•e2e"><a href="#3-è¿è¡Œæµ‹è¯•e2e" class="headerlink" title="3.è¿è¡Œæµ‹è¯•e2e"></a>3.è¿è¡Œæµ‹è¯•e2e</h2><h3 id="3-1-è¿è¡Œfabric-sampleçš„é—®é¢˜"><a href="#3-1-è¿è¡Œfabric-sampleçš„é—®é¢˜" class="headerlink" title="3.1 è¿è¡Œfabric-sampleçš„é—®é¢˜"></a>3.1 è¿è¡Œfabric-sampleçš„é—®é¢˜</h3><blockquote><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå‚ç…§å®˜ç½‘æ¥å®Œæˆç¬¬ä¸€ä¸ªç½‘ç»œæµ‹è¯•;<br>åœ¨è¯¥åœ¨çº¿æ–‡æ¡£ä¸­ä¼šè®©æˆ‘ä»¬å»ä¸‹è½½ä¸€ä¸ª<a href="http://hyperledger-fabric.readthedocs.io/en/latest/samples.html" target="_blank" rel="external">fabric-sample</a>;<br>ä¸‹è½½åœ°å€åœ¨<a href="https://github.com/hyperledger/fabric-samples" target="_blank" rel="external">github</a>ä¸Š;<br>æˆ‘ä»¬éœ€è¦å°†å…¶ä¸‹è½½è‡³æœ¬åœ°æ˜¯ä¸€ä¸ªfabric-sample-releaseçš„æ–‡ä»¶,å°†å…¶æ›´åä¸ºfabric-samples<br>éšåå°†å…¶ç§»åˆ°opt/gopath/srcç›®å½•ä¸‹;  </p></blockquote><p>æŒ‰ç…§å®˜ç½‘æç¤ºæ‰§è¡Œçš„å‘½ä»¤æ˜¯æ— æ³•è¿è¡Œèµ·first-networkè¿™ä¸ªé¡¹ç›®;<br>è¯¥demoéœ€è¦å…ˆä¸‹è½½Platform-specific Binaries(ç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶);<br>æŒ‰ç…§å®˜æ–‡æ¡£ä¸­çš„æè¿°ï¼Œéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤; </p><p>å®˜æ–¹æä¾›bashè„šæœ¬å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /root/ &amp;&amp; vim dk_bin.sh</span></div><div class="line">åŠ å…¥ä»¥ä¸‹æ‰§è¡Œç¨‹åº</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="comment"># current version of fabric released</span></div><div class="line"><span class="built_in">export</span> VERSION=<span class="variable">$&#123;1:-1.0.4&#125;</span></div><div class="line"><span class="comment"># current version of fabric-ca released</span></div><div class="line"><span class="built_in">export</span> CA_VERSION=<span class="variable">$&#123;2:-$VERSION&#125;</span></div><div class="line"><span class="comment"># current version of thirdparty images (couchdb, kafka and zookeeper) released</span></div><div class="line"><span class="built_in">export</span> THIRDPARTY_IMAGE_VERSION=0.4.6</div><div class="line"><span class="built_in">export</span> ARCH=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$(uname -s|tr '[:upper:]' '[:lower:]'|sed 's/mingw64_nt.*/windows/')</span>-<span class="variable">$(uname -m | sed 's/x86_64/amd64/g')</span>"</span> | awk <span class="string">'&#123;print tolower($0)&#125;'</span>)</div><div class="line"><span class="comment">#Set MARCH variable i.e ppc64le,s390x,x86_64,i386</span></div><div class="line">MARCH=`uname -m`</div><div class="line"></div><div class="line"><span class="function"><span class="title">dockerFabricPull</span></span>() &#123;</div><div class="line">  <span class="built_in">local</span> FABRIC_TAG=<span class="variable">$1</span></div><div class="line">  <span class="keyword">for</span> IMAGES <span class="keyword">in</span> peer orderer ccenv javaenv tools; <span class="keyword">do</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"==&gt; FABRIC IMAGE: <span class="variable">$IMAGES</span>"</span></div><div class="line">      <span class="built_in">echo</span></div><div class="line">      docker pull hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$FABRIC_TAG</span></div><div class="line">      docker tag hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$FABRIC_TAG</span> hyperledger/fabric-<span class="variable">$IMAGES</span></div><div class="line">  <span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">dockerThirdPartyImagesPull</span></span>() &#123;</div><div class="line">  <span class="built_in">local</span> THIRDPARTY_TAG=<span class="variable">$1</span></div><div class="line">  <span class="keyword">for</span> IMAGES <span class="keyword">in</span> couchdb kafka zookeeper; <span class="keyword">do</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"==&gt; THIRDPARTY DOCKER IMAGE: <span class="variable">$IMAGES</span>"</span></div><div class="line">      <span class="built_in">echo</span></div><div class="line">      docker pull hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$THIRDPARTY_TAG</span></div><div class="line">      docker tag hyperledger/fabric-<span class="variable">$IMAGES</span>:<span class="variable">$THIRDPARTY_TAG</span> hyperledger/fabric-<span class="variable">$IMAGES</span></div><div class="line">  <span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">dockerCaPull</span></span>() &#123;</div><div class="line">      <span class="built_in">local</span> CA_TAG=<span class="variable">$1</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"==&gt; FABRIC CA IMAGE"</span></div><div class="line">      <span class="built_in">echo</span></div><div class="line">      docker pull hyperledger/fabric-ca:<span class="variable">$CA_TAG</span></div><div class="line">      docker tag hyperledger/fabric-ca:<span class="variable">$CA_TAG</span> hyperledger/fabric-ca</div><div class="line">&#125;</div><div class="line"></div><div class="line">: <span class="variable">$&#123;CA_TAG:="$MARCH-$CA_VERSION"&#125;</span></div><div class="line">: <span class="variable">$&#123;FABRIC_TAG:="$MARCH-$VERSION"&#125;</span></div><div class="line">: <span class="variable">$&#123;THIRDPARTY_TAG:="$MARCH-$THIRDPARTY_IMAGE_VERSION"&#125;</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"===&gt; Downloading platform specific fabric binaries"</span></div><div class="line">curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>/hyperledger-fabric-<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>.tar.gz | tar xz</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"===&gt; Downloading platform specific fabric-ca-client binary"</span></div><div class="line">curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric-ca/hyperledger-fabric-ca/<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>/hyperledger-fabric-ca-<span class="variable">$&#123;ARCH&#125;</span>-<span class="variable">$&#123;VERSION&#125;</span>.tar.gz | tar xz</div><div class="line"><span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></div><div class="line">     <span class="built_in">echo</span></div><div class="line">     <span class="built_in">echo</span> <span class="string">"------&gt; <span class="variable">$VERSION</span> fabric-ca-client binary is not available to download  (Avaialble from 1.1.0-rc1) &lt;----"</span></div><div class="line">     <span class="built_in">echo</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"===&gt; Pulling fabric Images"</span></div><div class="line">dockerFabricPull <span class="variable">$&#123;FABRIC_TAG&#125;</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"===&gt; Pulling fabric ca Image"</span></div><div class="line">dockerCaPull <span class="variable">$&#123;CA_TAG&#125;</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"===&gt; Pulling thirdparty docker images"</span></div><div class="line">dockerThirdPartyImagesPull <span class="variable">$&#123;THIRDPARTY_TAG&#125;</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"===&gt; List out hyperledger docker images"</span></div><div class="line">docker images | grep hyperledger*</div><div class="line"></div><div class="line"><span class="comment"># chmod + x /root/dk_bin.sh</span></div><div class="line"><span class="comment"># bash /root/dk_bin.sh</span></div></pre></td></tr></table></figure><p>è¿è¡Œæ—¶æ•ˆæœå¦‚ä¸‹; æ³¨:è‹¥æ˜¯å†…ç½‘ç¯å¢ƒï¼Œåˆ™å¯èƒ½æ‰§è¡Œæ—¶é—´è¾ƒé•¿;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># bash /root/dk_bin.sh </div><div class="line">===&gt; Downloading platform specific fabric binaries</div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line"> 18 22.6M   18 4312k    0     0   6860      0  0:57:45  0:10:43  0:47:02  5364</div></pre></td></tr></table></figure></p><h3 id="3-2è¿è¡Œe2e-clié¡¹ç›®"><a href="#3-2è¿è¡Œe2e-clié¡¹ç›®" class="headerlink" title="3.2è¿è¡Œe2e_clié¡¹ç›®"></a>3.2è¿è¡Œe2e_clié¡¹ç›®</h3><p>è¿›å…¥åˆ°/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/ç›®å½•;</p><p>aã€ç›®å½•ç»“æ„å¦‚ä¸‹å›¾;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># tree ../e2e_cli/</div><div class="line">../e2e_cli/</div><div class="line">â”œâ”€â”€ base</div><div class="line">â”‚Â Â  â”œâ”€â”€ docker-compose-base.yaml</div><div class="line">â”‚Â Â  â””â”€â”€ peer-base.yaml</div><div class="line">â”œâ”€â”€ channel-artifacts</div><div class="line">â”œâ”€â”€ configtx.yaml</div><div class="line">â”œâ”€â”€ crypto-config.yaml</div><div class="line">â”œâ”€â”€ docker-compose-cli.yaml</div><div class="line">â”œâ”€â”€ docker-compose-couch.yaml</div><div class="line">â”œâ”€â”€ docker-compose-e2e-template.yaml</div><div class="line">â”œâ”€â”€ docker-compose-e2e.yaml</div><div class="line">â”œâ”€â”€ download-dockerimages.sh</div><div class="line">â”œâ”€â”€ end-to-end.rst</div><div class="line">â”œâ”€â”€ examples</div><div class="line">â”‚Â Â  â””â”€â”€ chaincode</div><div class="line">â”‚Â Â      â””â”€â”€ go</div><div class="line">â”‚Â Â          â””â”€â”€ chaincode_example02</div><div class="line">â”‚Â Â              â””â”€â”€ chaincode_example02.go</div><div class="line">â”œâ”€â”€ generateArtifacts.sh</div><div class="line">â”œâ”€â”€ network_setup.sh</div><div class="line">â””â”€â”€ scripts</div><div class="line">    â””â”€â”€ script.sh</div><div class="line"></div><div class="line">7 directories, 14 files</div></pre></td></tr></table></figure><p>network_setup.shæ˜¯ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œè¯¥è„šæœ¬å¯åŠ¨5ä¸ªdockerå®¹å™¨;<br>å…¶ä¸­4ä¸ªå®¹å™¨è¿è¡ŒpeerèŠ‚ç‚¹å’Œ1ä¸ªå®¹å™¨è¿è¡ŒordererèŠ‚ç‚¹ï¼Œå®ƒç»„æˆä¸€ä¸ªfabricé›†ç¾¤;<br>å¦å¤–è¿˜æœ‰ä¸€ä¸ªcliå®¹å™¨ç”¨äºåˆ›å»ºchannleã€åŠ å…¥channelã€å®‰è£…å’Œæ‰§è¡Œchaincodeç­‰æ“ä½œ;<br>æµ‹è¯•ç”¨çš„chaincodeå®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼Œåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šç»™è¿™ä¸¤ä¸ªå˜é‡èµ‹äºˆäº†åˆå§‹å€¼;<br>å¹¶èƒ½è¿‡invokeæ“ä½œå¯ä»¥ä½¿ç”¨ä¸¤ä¸ªå˜é‡çš„å€¼å‘ç”Ÿå˜åŒ–;  </p><p>bã€é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/</div><div class="line"># bash network_setup.sh up</div></pre></td></tr></table></figure><p>cã€å½“å‡ºç°ä»¥ä¸‹ç•Œé¢æ—¶ï¼Œè¯´æ˜å·²ç»æµ‹è¯•é€šäº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">2018-03-13 09:38:21.185 UTC [main] main -&gt; INFO 008 Exiting.....</div><div class="line">===================== Query on PEER3 on channel &apos;mychannel&apos; is successful ===================== </div><div class="line"></div><div class="line">===================== All GOOD, End-2-End execution completed ===================== </div><div class="line"></div><div class="line"></div><div class="line"> _____   _   _   ____            _____   ____    _____ </div><div class="line">| ____| | \ | | |  _ \          | ____| |___ \  | ____|</div><div class="line">|  _|   |  \| | | | | |  _____  |  _|     __) | |  _|  </div><div class="line">| |___  | |\  | | |_| | |_____| | |___   / __/  | |___ </div><div class="line">|_____| |_| \_| |____/          |_____| |_____| |_____|</div></pre></td></tr></table></figure><p>dã€å¦‚æœä¸Šä¸€æ­¥æœ‰æŠ¥é”™ï¼Œè‹¥æ²¡æœ‰éƒ¨ç½²å…¶å®ƒåº”ç”¨ï¼Œå¯ä»¥è€ƒè™‘å°†å†…æ ¸å‡çº§;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</div><div class="line"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</div><div class="line"># yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; list available</div><div class="line"># yum --enablerepo=elrepo-kernel install kernel-ml</div><div class="line"># vim /etc/default/grub</div><div class="line">GRUB_TIMEOUT=5</div><div class="line">GRUB_DISTRIBUTOR=&quot;$(sed &apos;s, release .*$,,g&apos; /etc/system-release)&quot;</div><div class="line">GRUB_DEFAULT=0</div><div class="line">GRUB_DISABLE_SUBMENU=true</div><div class="line">GRUB_TERMINAL_OUTPUT=&quot;console&quot;</div><div class="line">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet&quot;</div><div class="line">GRUB_DISABLE_RECOVERY=&quot;true&quot;</div><div class="line"># grub2-mkconfig -o /boot/grub2/grub.cfg</div></pre></td></tr></table></figure><h2 id="4-åˆ›å»ºFabricå¤šèŠ‚ç‚¹é›†ç¾¤"><a href="#4-åˆ›å»ºFabricå¤šèŠ‚ç‚¹é›†ç¾¤" class="headerlink" title="4.åˆ›å»ºFabricå¤šèŠ‚ç‚¹é›†ç¾¤"></a>4.åˆ›å»ºFabricå¤šèŠ‚ç‚¹é›†ç¾¤</h2><h3 id="4-1é…ç½®è¯´æ˜"><a href="#4-1é…ç½®è¯´æ˜" class="headerlink" title="4.1é…ç½®è¯´æ˜"></a>4.1é…ç½®è¯´æ˜</h3><blockquote><p>é¦–å…ˆå¯ä»¥æ ¹æ®å®˜æ–¹Fabricè‡ªå¸¦çš„e2e_cliä¾‹å­ä¸­çš„é›†ç¾¤æ–¹æ¡ˆæ¥ç”Ÿæˆé›†ç¾¤;<br>ä¸æ¡ˆä¾‹ä¸åŒçš„æ˜¯æˆ‘ä»¬éœ€è¦æŠŠå®¹å™¨åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼›<br>å„å®¹å™¨ä¹‹é—´é€šè¿‡ç½‘ç»œæ¥è¿›è¡Œé€šä¿¡ï¼Œç½‘ç»œæ„å»ºå®Œæˆåè¿›è¡Œç›¸å…³çš„channelå’Œchanincodeæ“ä½œ;<br>ç›®å‰ç”¨æœ‰äº”å°æœåŠ¡å™¨ï¼Œ æ‰€æœ‰çš„æœåŠ¡å™¨å‡æ˜¯æŒ‰ç…§ä¸Šè¿°e2e_cliç¯å¢ƒä¸æµ‹è¯•æ­¥éª¤é…ç½®;<br>è®¡åˆ’å…¶ä¸­çš„å››å°æœåŠ¡å™¨è¿è¡ŒpeerèŠ‚ç‚¹ï¼Œå¦å¤–ä¸€å°æœåŠ¡å™¨è¿è¡ŒordererèŠ‚ç‚¹;<br>ä¸ºå…¶å®ƒå››ä¸ªèŠ‚ç‚¹æä¾›orderæœåŠ¡; </p></blockquote><table><thead><tr><th>åç§°</th><th>ip</th><th>èŠ‚ç‚¹æ ‡è¯†</th><th>èŠ‚ç‚¹Hostname</th><th>Organization</th></tr></thead><tbody><tr><td>Hyperledger</td><td>10.180.55.123</td><td>orderer</td><td>orderer.example.com</td><td>Orderer</td></tr><tr><td>Fabric1</td><td>10.180.55.124</td><td>sp0</td><td>peer0.org1.example.com</td><td>Org1</td></tr><tr><td>Fabric2</td><td>10.180.55.125</td><td>sp1</td><td>peer1.org1.example.com</td><td>Org1</td></tr><tr><td>Fabric3</td><td>10.180.55.126</td><td>sp2</td><td>peer0.org2.example.com</td><td>Org2</td></tr><tr><td>Fabric4</td><td>10.180.55.128</td><td>sp3</td><td>peer0.org3.example.com</td><td>Org2</td></tr></tbody></table><p>ç¯å¢ƒå¦‚ä¸‹<br><img src="/images/hyperledger.png" alt=""></p><h3 id="4-2-ç”Ÿæˆå…¬ç§é’¥ã€è¯ä¹¦ã€åˆ›å·¨åŒºå—"><a href="#4-2-ç”Ÿæˆå…¬ç§é’¥ã€è¯ä¹¦ã€åˆ›å·¨åŒºå—" class="headerlink" title="4.2 ç”Ÿæˆå…¬ç§é’¥ã€è¯ä¹¦ã€åˆ›å·¨åŒºå—"></a>4.2 ç”Ÿæˆå…¬ç§é’¥ã€è¯ä¹¦ã€åˆ›å·¨åŒºå—</h3><p>å…¬/ç§é’¥å’Œè¯ä¹¦æ˜¯ç”¨äºServerä¸Serverä¹‹é—´çš„å®‰å…¨é€šä¿¡;<br>å¦å¤–è¦åˆ›å»ºchannelå¹¶è®©å…¶å®ƒèŠ‚ç‚¹åŠ å…¥channleå°±éœ€è¦åˆ›ä¸–åŒºå—;<br>è¿™äº›å¿…è¦æ–‡ä»¶éƒ½å¯ä»¥é€šè¿‡ä¸€æ¡å‘½ä»¤ç”Ÿ,å¹¶ä¸”å®˜æ–¹å·²ç»ç»™å‡ºè„šæœ¬;</p><p>è„šæœ¬åœ¨ä»¥ä¸‹ç›®å½•ä¸­; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/</div><div class="line"># ls generateArtifacts.sh</div></pre></td></tr></table></figure><p>ä½¿generateArtifacts.shç”Ÿæˆè¯ä¹¦å’Œconfig.txï¼Œå…·ä½“æ‰§è¡Œå‘½ä»¤å¦‚ä¸‹; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># bash generateArtifacts.sh  mychannel</div></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºäº†3å°æœåŠ¡å™¨ï¼Œåœ¨ä»»æ„ä¸€å°æœåŠ¡å™¨çš„è¯¥ç›®å½•ä¸‹æ‰§è¡Œæ­¤é¡¹å‘½ä»¤å³å¯ï¼›<br>å°†ä¼šç”Ÿæˆä¸¤ä¸ªç›®å½•ï¼Œåˆ†åˆ«ä¸ºchannel-artifacsã€crypto-config</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">channel-artifacts/</div><div class="line">â”œâ”€â”€ channel.tx</div><div class="line">â”œâ”€â”€ genesis.block</div><div class="line">â”œâ”€â”€ Org1MSPanchors.tx</div><div class="line">â””â”€â”€ Org2MSPanchors.tx</div><div class="line"></div><div class="line">0 directories, 4 files</div></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç›®å½•é‡Œçš„æ–‡ä»¶ç”¨äºordereråˆ›å»ºchannleï¼Œå®ƒä»¬æ ¹æ®configex.yamlçš„é…ç½®ç”Ÿæˆ;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">crypto-config</div><div class="line">â”œâ”€â”€ ordererOrganizations</div><div class="line">â””â”€â”€ peerOrganizations</div><div class="line"></div><div class="line">2 directories, 0 files</div></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç›®å½•é‡Œæœ‰ordererå’Œpeerçš„è¯ä¹¦ã€ç§é’¥å’Œç”¨äºé€šä¿¡çš„åŠ å¯†çš„tlsè¯ä¹¦æ–‡ä»¶;<br>å®ƒé€šè¿‡configex.yamlé…ç½®æ–‡ä»¶ç”Ÿæˆ;  </p><h3 id="4-3-é…ç½®å¤šæœåŠ¡å™¨"><a href="#4-3-é…ç½®å¤šæœåŠ¡å™¨" class="headerlink" title="4.3 é…ç½®å¤šæœåŠ¡å™¨"></a>4.3 é…ç½®å¤šæœåŠ¡å™¨</h3><p>æ ¹æ®4.2çš„æ–¹æ¡ˆï¼Œä»¥åŠä¹‹å‰æ‰€è¿°çš„gopathç›®å½•ç­‰é…ç½®æ–¹æ¡ˆ;<br>æˆ‘ä»¬å‡å®šæ‰€æœ‰çš„æœåŠ¡å™¨éƒ½æŒ‰ç…§è¯¥æ–‡æ¡£çš„é…ç½®æ¥æ“ä½œ;<br>æ‰€æœ‰æœåŠ¡å™¨éƒ½æœ‰Fabricæºç ,ä¸”ç›®å½•ä¸º </p><p>å¦‚4.2æ‰€è¿°,è¯¥å‘½ä»¤åªéœ€è¦åœ¨æŸä¸€å°æœåŠ¡å™¨ä¸Šè¿è¡Œä¸€æ¬¡å³å¯ï¼Œå…¶å®ƒæœåŠ¡å™¨æ— éœ€å†æ¬¡è¿è¡Œ;  </p><p>åœ¨è¿è¡Œè¯¥å‘½ä»¤çš„æœåŠ¡å™¨/opt/gopath/src/github.com/hyperledger/fabric/example/e2e_cli;<br>è¯¥ç›®å½•ä¸‹ä¼šç”Ÿæˆchannel-artifactså’Œcrypto-configç›®å½•;<br>éœ€è¦æŠŠå®ƒä»¬æ‹·è´è‡³å…¶å®ƒæœåŠ¡å™¨ç›¸åŒçš„e2e_cliç›®å½•ä¸‹ï¼Œå¦‚æœåœ¨å…¶å®ƒæœåŠ¡å™¨ä¸­å·²ç»åœ¨è¯¥ç›®å½•,åˆ™éœ€è¦å…ˆæŠŠå®ƒåˆ é™¤;   </p><p>å½“æ‰€æœ‰æœåŠ¡å™¨éƒ½æœ‰åŒä¸€ä¸ªchannel-artifactså’Œcrypto-configç›®å½•å;<br>å¼€å§‹é…ç½®composeæ–‡ä»¶;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">å¼€å§‹å‘å…¶å®ƒä¸¤ä¸ªæœåŠ¡å™¨åŒæ­¥ä»¥ä¸Šä¸¤ä¸ªç›®å½•;</div><div class="line"># cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/</div><div class="line"># tar -cvf  ctfile.tar.gz channel-artifacts crypto-config</div><div class="line"># scp ctfile.tar.gz root@10.180.55.124:/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli</div><div class="line"># scp ctfile.tar.gz root@10.180.55.125:/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli</div><div class="line"># ssh root@10.180.55.124 &quot;cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli &amp;&amp; tar -xvf ctfile.tar.gz&quot;</div><div class="line"># ssh root@10.180.55.125 &quot;cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli &amp;&amp; tar -xvf ctfile.tar.gz&quot;</div></pre></td></tr></table></figure><h3 id="4-4-è®¾ç½®peer0-arg1-example-comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶"><a href="#4-4-è®¾ç½®peer0-arg1-example-comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶" class="headerlink" title="4.4 è®¾ç½®peer0.arg1.example.comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶"></a>4.4 è®¾ç½®peer0.arg1.example.comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶</h3><blockquote><p>e2e_cliä¸­æä¾›äº†å¤šä¸ªyamlæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºdocker-compose-cli.yamlæ–‡ä»¶åˆ›å»º;  </p></blockquote><p>ä¿®æ”¹docker-compose-peer.yamlï¼Œå»æ‰ordererçš„é…ç½®ï¼›<br>åªä¿ç•™ä¸€ä¸ªpeerå’Œcliï¼Œå› ä¸ºéœ€è¦å¤šçº§éƒ¨ç½²ï¼ŒèŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´åˆæ˜¯é€šè¿‡ä¸»æœºåé€šè®¯;<br>æ‰€ä»¥éœ€è¦ä¿®æ”¹å®¹å™¨ä¸­çš„hostæ–‡ä»¶,ä¹Ÿå°±æ˜¯xtra_hostsè®¾ç½®;<br>ä¿®æ”¹åçš„peeré…ç½®å¦‚ä¸‹ï¼›   </p><p>åŒæ ·çš„,cliä¹Ÿéœ€è¦èƒ½å¤Ÿå’Œå„ä¸ªèŠ‚ç‚¹é€šè®¯ï¼Œæ‰€ä»¥cliä¸‹é¢ä¹Ÿéœ€è¦æ·»åŠ extra_hostsè®¾ç½®;<br>å»æ‰æ— æ•ˆçš„ä¾èµ–ï¼Œå¹¶ä¸”å»æ‰commandè¿™ä¸€è¡Œï¼Œå› ä¸ºæ¯ä¸ªpeeréƒ½ä¼šæœ‰ä¸ªå¯¹åº”çš„å®¢æˆ·ç«¯;<br>ä¹Ÿæ˜¯å°±æ˜¯cliï¼› æ‰€ä»¥åªéœ€è¦å»æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨æ‰§è¡Œ;   </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd base/</span></div><div class="line"><span class="comment"># cp docker-compose-base.yaml&#123;,.bak&#125;</span></div><div class="line"><span class="comment"># vim base/docker-compose-base.yaml</span></div><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">peer0.org1.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"></div><div class="line"><span class="attr">  cli:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">cli</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-tools</span></div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">GOPATH=/opt/gopath</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=cli</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">peer0.org1.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org1.example.com:10.180.55.125"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org2.example.com:10.180.55.126"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org2.example.com:10.180.55.128"</span></div></pre></td></tr></table></figure><p>åœ¨3.2ç¤ºä¾‹å•æœºæ¨¡å¼ä¸‹ï¼Œ4ä¸ªpeeræ”¯æ˜ å°„ä¸»æœºä¸åŒçš„ç«¯å£;<br>ä½†æ˜¯åœ¨å¤šæœºéƒ¨ç½²çš„æ—¶å€™ä¸éœ€è¦æ˜ å°„ä¸åŒç«¯å£çš„;<br>æ‰€ä»¥éœ€è¦ä¿®æ”¹base/docker-compose-base.yamlæ–‡ä»¶ï¼Œå°†æ‰€æœ‰peerçš„ç«¯å£æ˜ å°„éƒ½æ”¹ä¸ºç›¸åŒçš„;  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd base/</span></div><div class="line"><span class="comment"># cp docker-compose-base.yaml&#123;,.bak&#125;</span></div><div class="line"><span class="comment"># vim base/docker-compose-base.yaml</span></div><div class="line"><span class="attr"> ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7051</span><span class="string">:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7052</span><span class="string">:7052</span></div><div class="line"><span class="bullet">      -</span> <span class="number">7053</span><span class="string">:7053</span></div></pre></td></tr></table></figure><h3 id="4-5ã€-è®¾ç½®peer1-org1-example-comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶"><a href="#4-5ã€-è®¾ç½®peer1-org1-example-comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶" class="headerlink" title="4.5ã€ è®¾ç½®peer1.org1.example.comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶"></a>4.5ã€ è®¾ç½®peer1.org1.example.comèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶</h3><p>ä¸peer0.org1.example.comèŠ‚ç‚¹composeæ–‡ä»¶é…ç½®ä¸€æ ·;<br>ä¸è¿‡å‹å²è¦å°†å¯åŠ¨çš„å®¹å™¨æ”¹ä¸ºpeer1.org1.example.com;<br>å¹¶ä¸”æ·»åŠ peer0.org1.example.comçš„IPæ˜ å°„;<br>å¯¹åº”çš„cliä¸­æ”¹æˆå¯¹peer1.org1.example.comçš„ä¾èµ–;<br>ä¿®æ”¹å¦‚ä¸‹</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#  cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/</span></div><div class="line"><span class="comment">#  cp docker-compose-cli.yaml  docker-compose-peer.yaml</span></div><div class="line"><span class="comment">#  vim docker-compose-peer.yaml </span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">peer1.org1.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer1.org1.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer1.org1.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"></div><div class="line"><span class="attr">  cli:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">cli</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-tools</span></div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">GOPATH=/opt/gopath</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=cli</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">peer1.org1.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org1.example.com:10.180.55.125"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org2.example.com:10.180.55.126"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org2.example.com:10.180.55.128"</span></div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># cd base/</div><div class="line"># cp docker-compose-base.yaml&#123;,.bak&#125;</div><div class="line"># vim base/docker-compose-base.yaml</div><div class="line"> ports:</div><div class="line">      - 7051:7051</div><div class="line">      - 7052:7052</div><div class="line">      - 7053:7053</div></pre></td></tr></table></figure><p>org2çš„ä¸¤ä¸ªç»“ç‚¹é…ç½®æ–‡ä»¶ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat docker-compose-peer.yaml </span></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">peer0.org2.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"></div><div class="line"><span class="attr">  cli:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">cli</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-tools</span></div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">GOPATH=/opt/gopath</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=cli</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">peer0.org2.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org1.example.com:10.180.55.125"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org2.example.com:10.180.55.126"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org2.example.com:10.180.55.128"</span></div></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat docker-compose-peer.yaml </span></div><div class="line"><span class="comment"># Copyright IBM Corp. All Rights Reserved.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"></div><div class="line"><span class="attr">services:</span></div><div class="line"></div><div class="line">  <span class="string">peer1.org2.example.com:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">peer1.org2.example.com</span></div><div class="line"><span class="attr">    extends:</span></div><div class="line"><span class="attr">      file:</span>  <span class="string">base/docker-compose-base.yaml</span></div><div class="line"><span class="attr">      service:</span> <span class="string">peer1.org2.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"></div><div class="line"><span class="attr">  cli:</span></div><div class="line"><span class="attr">    container_name:</span> <span class="string">cli</span></div><div class="line"><span class="attr">    image:</span> <span class="string">hyperledger/fabric-tools</span></div><div class="line"><span class="attr">    tty:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">GOPATH=/opt/gopath</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_LOGGING_LEVEL=DEBUG</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ID=cli</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_ADDRESS=peer0.org1.example.com:7051</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_LOCALMSPID=Org1MSP</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ENABLED=true</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt</span></div><div class="line"><span class="bullet">      -</span> <span class="string">CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</span></div><div class="line"><span class="attr">    working_dir:</span> <span class="string">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">/var/run/:/host/var/run/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/</span></div><div class="line"><span class="bullet">        -</span> <span class="string">./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">peer1.org2.example.com</span></div><div class="line"><span class="attr">    extra_hosts:</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"orderer.example.com:10.180.55.123"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org1.example.com:10.180.55.124"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org1.example.com:10.180.55.125"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer0.org2.example.com:10.180.55.126"</span></div><div class="line"><span class="bullet">      -</span> <span class="string">"peer1.org2.example.com:10.180.55.128"</span></div></pre></td></tr></table></figure><h3 id="4-6-è®¾ç½®orderèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶"><a href="#4-6-è®¾ç½®orderèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶" class="headerlink" title="4.6 è®¾ç½®orderèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶"></a>4.6 è®¾ç½®orderèŠ‚ç‚¹çš„docker-composeæ–‡ä»¶</h3><p>ä¸åˆ›å»ºpeerçš„é…ç½®æ–‡ä»¶ç±»ä¼¼ï¼Œéœ€è¦å¤åˆ¶ä¸€ä¸ªyamlæ–‡ä»¶å‡ºæ¥ä¿®æ”¹; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli</div><div class="line"># cp docker-compose-cli.yaml docker-compose-orderer.yaml</div></pre></td></tr></table></figure><p>ordereræœåŠ¡å™¨ä¸Šæˆ‘ä»¬åªéœ€è¦ä¿ç•™orderè®¾ç½®;<br>å…¶ä»–peerå’Œcliè®¾ç½®éƒ½å¯ä»¥åˆ é™¤ã€‚orderå¯ä»¥ä¸è®¾ç½®extra_hosts;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">orderer.example.com:</div><div class="line">  extends:</div><div class="line">    file:   base/docker-compose-base.yaml</div><div class="line">    service: orderer.example.com</div><div class="line">  container_name: orderer.example.com</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#å¯åŠ¨æŠ¥é”™ï¼Œå•çº¯çš„æŠ¥å‘½ä»¤è°ƒç”¨ç”¨æ³•é”™è¯¯</div><div class="line">docker rm -f $(docker ps -aq)</div></pre></td></tr></table></figure><p>è‹¥éƒ¨ç½²ç¯å¢ƒåœ¨å†…ç½‘ï¼Œåˆ™éœ€è¦ä¿®æ”¹5å°æœåŠ¡å™¨çš„/etc/hostsæ–‡ä»¶;<br>ç¡®ä¿æœåŠ¡å™¨ä¹‹é—´å¯ä»¥åŸºäºä¸»æœºåäº’ç›¸é€šä¿¡ï¼› </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># vim /etc/hosts </div><div class="line">10.180.55.123 orderer.example.com</div><div class="line">10.180.55.124 peer0.org1.example.com</div><div class="line">10.180.55.125 peer1.org1.example.com</div><div class="line">10.180.55.126 peer0.org2.example.com</div><div class="line">10.180.55.128 peer1.org2.example.com</div></pre></td></tr></table></figure><h2 id="5-å¯åŠ¨Fabricå¤šèŠ‚ç‚¹é›†ç¾¤"><a href="#5-å¯åŠ¨Fabricå¤šèŠ‚ç‚¹é›†ç¾¤" class="headerlink" title="5.å¯åŠ¨Fabricå¤šèŠ‚ç‚¹é›†ç¾¤"></a>5.å¯åŠ¨Fabricå¤šèŠ‚ç‚¹é›†ç¾¤</h2><h3 id="5-1å¯åŠ¨orderereèŠ‚ç‚¹æœåŠ¡"><a href="#5-1å¯åŠ¨orderereèŠ‚ç‚¹æœåŠ¡" class="headerlink" title="5.1å¯åŠ¨orderereèŠ‚ç‚¹æœåŠ¡"></a>5.1å¯åŠ¨orderereèŠ‚ç‚¹æœåŠ¡</h3><p>æ“ä½œå®Œæˆåï¼Œæ­¤æ—¶èŠ‚ç‚¹çš„composeé…ç½®æ–‡ä»¶åŠè¯ä¹¦éš¾ç›®å½•éƒ½å·²ç»å‡†å¤‡å®Œæˆ;<br>å¯ä»¥å¼€å§‹å°è¯•å¯åŠ¨å¤šæœºFabricé›†ç¾¤;<br>é¦–å…ˆè¦å¯ordererèŠ‚ç‚¹ï¼Œåˆ‡æ¢è‡³orderer.example.comæœåŠ¡å™¨;<br>å³å‰æ–‡æŒ‡å®šçš„10.180.55.123çš„æœåŠ¡å™¨ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›å…¥å¯dockerè¿›ç¨‹;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker-compose -f docker-compose-orderer.yaml up -d</div></pre></td></tr></table></figure><p>è¿è¡Œå®Œæ¯•åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨docker psçœ‹åˆ°è¿è¡Œäº†ä¸€ä¸ªåå­—ä¸ºorderer.example.comçš„èŠ‚ç‚¹; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># docker ps</div><div class="line">CONTAINER ID        IMAGE                        COMMAND             CREATED             STATUS              PORTS                    NAMES</div><div class="line">f188590553b7        hyperledger/fabric-orderer   &quot;orderer&quot;           25 seconds ago      Up 22 seconds       0.0.0.0:7050-&gt;7050/tcp   orderer.example.com</div></pre></td></tr></table></figure><h3 id="5-2å¯åŠ¨peerèŠ‚ç‚¹æœåŠ¡"><a href="#5-2å¯åŠ¨peerèŠ‚ç‚¹æœåŠ¡" class="headerlink" title="5.2å¯åŠ¨peerèŠ‚ç‚¹æœåŠ¡"></a>5.2å¯åŠ¨peerèŠ‚ç‚¹æœåŠ¡</h3><p>åˆ‡æ¢åˆ°peer0.org1.example.comæœåŠ¡å™¨ï¼Œå³å‰æ–‡æŒ‡å®šçš„10.180.55.124æœåŠ¡å™¨;<br>å¯åŠ¨æœ¬æœåŠ¡å™¨çš„peerèŠ‚ç‚¹å’Œcli;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker-compose  -f docker-compose-peer.yaml  up -d</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># docker ps</div><div class="line">CONTAINER ID        IMAGE                      COMMAND             CREATED             STATUS              PORTS                              NAMES</div><div class="line">2f49281a48c9        hyperledger/fabric-tools   &quot;/bin/bash&quot;         38 minutes ago      Up 38 minutes                                          cli</div><div class="line">8ef009a57457        hyperledger/fabric-peer    &quot;peer node start&quot;   38 minutes ago      Up 38 minutes       0.0.0.0:7051-7053-&gt;7051-7053/tcp   peer0.org1.example.com</div></pre></td></tr></table></figure><p><code>æ³¨: å…¶å®ƒä¸‰ä¸ªpeerç»“ç‚¹ä¸ä»¥ä¸Šç»“ç‚¹çš„å¯åŠ¨/éªŒè¯æ–¹å¼ç›¸åŒ</code><br><code>é‡åˆ°çš„å‘:åœ¨CentOSä¸­è¦æŠŠiptableså…³é—­;selinuxä¸ºå¼€æœºå…³é—­</code><br><code>ç¡®ä¿5ä¸ªç»“ç‚¹é—´åŸŸåå’Œç«¯å£éƒ½èƒ½telnet é€š;ä¾‹telnet peer1.org2.example.com 7051;</code></p><p>ç°åœ¨æ•´ä¸ªFabric4+1æœåŠ¡å™¨ç½‘ç»œå·²ç»æˆå‹;</p><h3 id="5-3åˆ›å»ºchannleå’Œè¿è¡Œchaincode"><a href="#5-3åˆ›å»ºchannleå’Œè¿è¡Œchaincode" class="headerlink" title="5.3åˆ›å»ºchannleå’Œè¿è¡Œchaincode"></a>5.3åˆ›å»ºchannleå’Œè¿è¡Œchaincode</h3><p>åˆ‡æ¢åˆ°peer0.org1.example.comæœåŠ¡å™¨ä¸Š;<br>ä½¿ç”¨è¯¥æœåŠ¡å™¨çš„cliæ¥è¿è¡Œåˆ›å»ºChannelå’Œè¿è¡ŒChainCodeçš„æ“ä½œ; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker exec -it cli bash</div></pre></td></tr></table></figure><p>è¿›å…¥å®¹å™¨å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@078471f17d9a:/opt/gopath/src/github.com/hyperledger/fabric/peer# ./scripts/script.sh mychannel</div></pre></td></tr></table></figure><p>è¯¥è„šæœ¬ä¼šä¸€æ­¥æ­¥çš„å®Œæˆåˆ›å»ºé€šé“,å°†å…¶ä»–èŠ‚ç‚¹åŠ å…¥é€šé“ï¼Œæ›´æ–°é”šèŠ‚ç‚¹;<br>åˆ›å»ºChainCodeï¼Œåˆå§‹åŒ–å¸æˆ·ï¼ŒæŸ¥è¯¢ï¼Œè½¬å¸ï¼Œå†æ¬¡æŸ¥è¯¢ç­‰é“¾ä¸Šæ“ä½œçš„è‡ªåŠ¨åŒ–;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">2018-03-19 03:00:03.146 UTC [main] main -&gt; INFO 007 Exiting.....</div><div class="line">===================== Query on PEER3 on channel &apos;mychannel&apos; is successful ===================== </div><div class="line"></div><div class="line">===================== All GOOD, End-2-End execution completed ===================== </div><div class="line"></div><div class="line"></div><div class="line"> _____   _   _   ____            _____   ____    _____ </div><div class="line">| ____| | \ | | |  _ \          | ____| |___ \  | ____|</div><div class="line">|  _|   |  \| | | | | |  _____  |  _|     __) | |  _|  </div><div class="line">| |___  | |\  | | |_| | |_____| | |___   / __/  | |___ </div><div class="line">|_____| |_| \_| |____/          |_____| |_____| |_____|</div></pre></td></tr></table></figure><p>å‡ºç°ä»¥ä¸Šç»“æœå‡ºæ˜4+1çš„Fabricå¤šçº§éƒ¨ç½²å·²ç»æˆåŠŸ;<br>åœ¨peer0.org1.example.comçš„cliå®¹å™¨å†…;<br>ä¹‹å‰çš„2ä¸ªå®¹å™¨ï¼Œå·²ç»å› ChainCodeåˆ›å»ºäº†3ä¸ªå®¹å™¨; </p><p><img src="/images/hyperledger2.png" alt=""></p><h3 id="E2E-è¿è¡ŒåæŸ¥è¯¢ä¸è½¬å¸æµ‹è¯•"><a href="#E2E-è¿è¡ŒåæŸ¥è¯¢ä¸è½¬å¸æµ‹è¯•" class="headerlink" title="E2E è¿è¡ŒåæŸ¥è¯¢ä¸è½¬å¸æµ‹è¯•"></a>E2E è¿è¡ŒåæŸ¥è¯¢ä¸è½¬å¸æµ‹è¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># æŸ¥è¯¢</div><div class="line"># docker exec -it cli bash</div><div class="line">root@078471f17d9a:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p><img src="/images/hyperledger-test1.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># è½¬å¸20åˆ°b</div><div class="line"># peer chaincode invoke -o orderer.example.com:7050  --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem  -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;20&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p><img src="/images/hyperledger-test2.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>pythonæ—¥å¸¸ç»ƒä¹ </title>
      <link href="/2018/07/19/python%20%E6%97%A5%E5%B8%B8%E7%BB%83%E4%B9%A0/"/>
      <url>/2018/07/19/python%20%E6%97%A5%E5%B8%B8%E7%BB%83%E4%B9%A0/</url>
      <content type="html"><![CDATA[<h1 id="python-æ—¥å¸¸ç»ƒä¹ "><a href="#python-æ—¥å¸¸ç»ƒä¹ " class="headerlink" title="python æ—¥å¸¸ç»ƒä¹ "></a>python æ—¥å¸¸ç»ƒä¹ </h1><p><img src="/images/python.jpg" alt=""></p><h2 id="è§£å‹åºèµ‹å€¼ç»™å¤šä¸ªå˜é‡"><a href="#è§£å‹åºèµ‹å€¼ç»™å¤šä¸ªå˜é‡" class="headerlink" title="è§£å‹åºèµ‹å€¼ç»™å¤šä¸ªå˜é‡"></a>è§£å‹åºèµ‹å€¼ç»™å¤šä¸ªå˜é‡</h2><p>ç°æœ‰ä¸€ä¸ªåŒ…å«Nä¸ªå…ƒç´ çš„å…ƒç»„æˆ–è€…æ˜¯åºåˆ—ï¼Œå°†å®ƒé‡Œé¢çš„å€¼è§£å‹ååŒæ—¶èµ‹å€¼ç»™Nä¸ªå˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">In [22]: p = (1,2)</div><div class="line">In [23]: a,b = p</div><div class="line">In [24]: a</div><div class="line">Out[24]: 1</div><div class="line">In [25]: b</div><div class="line">Out[25]: 2</div><div class="line"></div><div class="line"></div><div class="line">In [26]: date = [&apos;test&apos;,&apos;frum&apos;,&apos;bind&apos;,&apos;lance&apos;,(201,202,203)]</div><div class="line">In [27]: te,fr,bi,la,data = date</div><div class="line">In [28]: te</div><div class="line">Out[28]: &apos;test&apos;</div><div class="line">In [29]: fr</div><div class="line">Out[29]: &apos;frum&apos;</div><div class="line">In [30]: bi</div><div class="line">Out[30]: &apos;bind&apos;</div><div class="line">In [31]: date</div><div class="line">Out[31]: [&apos;test&apos;, &apos;frum&apos;, &apos;bind&apos;, &apos;lance&apos;, (201, 202, 203)]</div><div class="line">In [32]: data</div><div class="line">Out[32]: (201, 202, 203)</div><div class="line"></div><div class="line"></div><div class="line">In [41]: a = &apos;Hello&apos;</div><div class="line">In [42]: b,c,d,e,f = a</div><div class="line">In [43]: b</div><div class="line">Out[43]: &apos;H&apos;</div><div class="line">In [44]: c</div><div class="line">Out[44]: &apos;e&apos;</div><div class="line">In [45]: d</div><div class="line">Out[45]: &apos;l&apos;</div><div class="line">In [46]: f</div><div class="line">Out[46]: &apos;o&apos;</div></pre></td></tr></table></figure><h2 id="åˆçº§ç»ƒä¹ é¢˜"><a href="#åˆçº§ç»ƒä¹ é¢˜" class="headerlink" title="åˆçº§ç»ƒä¹ é¢˜"></a>åˆçº§ç»ƒä¹ é¢˜</h2><h3 id="ç»™ä¸€ä¸ªåŠå¾„ï¼Œæ±‚åœ†çš„é¢ç§¯å’Œå‘¨é•¿ã€‚åœ†å‘¨ç‡3-14"><a href="#ç»™ä¸€ä¸ªåŠå¾„ï¼Œæ±‚åœ†çš„é¢ç§¯å’Œå‘¨é•¿ã€‚åœ†å‘¨ç‡3-14" class="headerlink" title="ç»™ä¸€ä¸ªåŠå¾„ï¼Œæ±‚åœ†çš„é¢ç§¯å’Œå‘¨é•¿ã€‚åœ†å‘¨ç‡3.14"></a>ç»™ä¸€ä¸ªåŠå¾„ï¼Œæ±‚åœ†çš„é¢ç§¯å’Œå‘¨é•¿ã€‚åœ†å‘¨ç‡3.14</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from math import pi</div><div class="line">r=int(input(&apos;r=&apos;))</div><div class="line">print(&apos;area=&apos;+str(pi*r*r))</div><div class="line">print(&apos;circumference=&apos;+str(2*pi*r))</div><div class="line"></div><div class="line">(py3_env) kernel â¤ python test.py                                                                                                                                                               </div><div class="line">r=10</div><div class="line">area=314.1592653589793</div><div class="line">circumference=62.83185307179586</div></pre></td></tr></table></figure><h3 id="è¾“å…¥ä¸¤ä¸ªæ•°ï¼Œæ¯”è¾ƒå¤§å°åï¼Œä»å°åˆ°å¤§å‡åºæ‰“å°"><a href="#è¾“å…¥ä¸¤ä¸ªæ•°ï¼Œæ¯”è¾ƒå¤§å°åï¼Œä»å°åˆ°å¤§å‡åºæ‰“å°" class="headerlink" title="è¾“å…¥ä¸¤ä¸ªæ•°ï¼Œæ¯”è¾ƒå¤§å°åï¼Œä»å°åˆ°å¤§å‡åºæ‰“å°"></a>è¾“å…¥ä¸¤ä¸ªæ•°ï¼Œæ¯”è¾ƒå¤§å°åï¼Œä»å°åˆ°å¤§å‡åºæ‰“å°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">a = input(&apos;first: &apos;)</div><div class="line">b = input(&apos;second: &apos;)</div><div class="line"></div><div class="line">if a &gt; b:</div><div class="line">    print(b,a)</div><div class="line">else:</div><div class="line">    print(a,b)</div><div class="line"></div><div class="line">(py3_env) kernel â¤ python test.py                                                                                                                                                               </div><div class="line">first: 10</div><div class="line">second: 11</div><div class="line">10 11</div></pre></td></tr></table></figure><h3 id="è¾“å…¥nä¸ªæ•°ï¼Œæ±‚æ¯æ¬¡è¾“å…¥åçš„ç®—æ•°å¹³å‡æ•°"><a href="#è¾“å…¥nä¸ªæ•°ï¼Œæ±‚æ¯æ¬¡è¾“å…¥åçš„ç®—æ•°å¹³å‡æ•°" class="headerlink" title="è¾“å…¥nä¸ªæ•°ï¼Œæ±‚æ¯æ¬¡è¾“å…¥åçš„ç®—æ•°å¹³å‡æ•°"></a>è¾“å…¥nä¸ªæ•°ï¼Œæ±‚æ¯æ¬¡è¾“å…¥åçš„ç®—æ•°å¹³å‡æ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">n = 0</div><div class="line">sum = 0</div><div class="line"></div><div class="line">while True:</div><div class="line">    i = input(&quot;&gt;&gt;&gt;&quot;)</div><div class="line">    if i == &apos;quit&apos;:</div><div class="line">        break</div><div class="line"></div><div class="line">    n += 1</div><div class="line">    sum += int(i)</div><div class="line">    avg = sum/n</div><div class="line">    print(avg)</div></pre></td></tr></table></figure><h3 id="æ‰“å°ä¹ä¹ä¹˜æ³•è¡¨"><a href="#æ‰“å°ä¹ä¹ä¹˜æ³•è¡¨" class="headerlink" title="æ‰“å°ä¹ä¹ä¹˜æ³•è¡¨"></a>æ‰“å°ä¹ä¹ä¹˜æ³•è¡¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">for i in range(1,10):</div><div class="line">    for j in range(1,i+1):</div><div class="line">        print(str(j)+&apos;x&apos;+ str(i) +&quot;=&quot; +str(i*j),end=&apos; &apos;)</div><div class="line"></div><div class="line"></div><div class="line">for i in range(1,10):</div><div class="line">    for j in range(1,i+1):</div><div class="line">        product = i*j</div><div class="line"></div><div class="line">        if j &gt; 1 and product &lt;10:</div><div class="line">            product = str(product) + &apos; &apos;</div><div class="line">        else:</div><div class="line">            product = str(product)</div><div class="line">        print(str(j)+&apos;x&apos;+str(i)+&quot;=&quot;+str(product),end=&apos; &apos;)</div><div class="line">    print()</div></pre></td></tr></table></figure><h3 id="æ‰“å°è±å½¢"><a href="#æ‰“å°è±å½¢" class="headerlink" title="æ‰“å°è±å½¢"></a>æ‰“å°è±å½¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">for i in range(-3,4):</div><div class="line">    if i&lt;0:</div><div class="line">        prespace = -i</div><div class="line">    else:</div><div class="line">        prespace = i</div><div class="line"></div><div class="line">    print(&apos; &apos;*prespace + &apos;*&apos;*(7-prespace*2))</div></pre></td></tr></table></figure><h3 id="æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œ100ä»¥å†…"><a href="#æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œ100ä»¥å†…" class="headerlink" title="æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œ100ä»¥å†…"></a>æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œ100ä»¥å†…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">æ–æ³¢é‚£å¥‘æ•°åˆ—:1,1,2,3,5,8,13,21,34,55,89,144,...</div><div class="line">a = 0</div><div class="line">b = 1</div><div class="line"></div><div class="line">while True:</div><div class="line">    c = a+b</div><div class="line">    if c &gt; 100: break</div><div class="line">    a=b</div><div class="line">    b=c</div><div class="line">    print(c)</div><div class="line"></div><div class="line">a = 1</div><div class="line">b = 1</div><div class="line">index = 2</div><div class="line">print(&apos;&#123;0&#125;,&#123;1&#125;&apos;.format(0,0))</div><div class="line">print(&apos;&#123;0&#125;,&#123;1&#125;&apos;.format(1,1))</div><div class="line">print(&apos;&#123;0&#125;,&#123;1&#125;&apos;.format(2,1))</div><div class="line"></div><div class="line">while True:</div><div class="line">    c = a + b</div><div class="line">    a = b</div><div class="line">    b = c</div><div class="line">    index +=1</div><div class="line">    print(&apos;&#123;0&#125;,&#123;1&#125;&apos;.format(index,c))</div><div class="line"></div><div class="line">    if index == 101:</div><div class="line">        break</div></pre></td></tr></table></figure><h3 id="pip-ç®€å•ä½¿ç”¨"><a href="#pip-ç®€å•ä½¿ç”¨" class="headerlink" title="pip ç®€å•ä½¿ç”¨"></a>pip ç®€å•ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># é…ç½®å›½å†…çš„æº</div><div class="line">~ â¤ cat ~/.pip/pip.conf</div><div class="line">[global]</div><div class="line">index-url=http://mirrors.aliyun.com/pypi/simple</div><div class="line">trusted-host=mirrors.aliyun.com</div><div class="line"># pip å¸¸ç”¨å‘½ä»¤</div><div class="line"># pip install xxx yyy</div><div class="line"># pip list </div><div class="line"># pip search keyword æˆ–è€… pypi</div><div class="line"># pip help install </div><div class="line"># pip install jupyter </div><div class="line"># pip -V </div><div class="line"># pip freeze &gt; requirement</div><div class="line"># pip install -r requirement</div><div class="line"># virtualenv  ~/Desktop/MyPython/py3_env --python=python3</div></pre></td></tr></table></figure><h3 id="çŒœæ•°å­—çš„æ¸¸æˆ"><a href="#çŒœæ•°å­—çš„æ¸¸æˆ" class="headerlink" title="çŒœæ•°å­—çš„æ¸¸æˆ"></a>çŒœæ•°å­—çš„æ¸¸æˆ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">NUM = 35</div><div class="line"></div><div class="line">count = 0</div><div class="line"></div><div class="line">while count &lt; 3:</div><div class="line">    user_input = int(input(&apos;è¯·ä½ è¾“å…¥ä¸€ä¸ªæ•°å­—: &apos;))</div><div class="line">    if user_input == NUM :</div><div class="line">        print(&apos;ä½ çŒœå¯¹äº†&apos;)</div><div class="line">        break</div><div class="line">    elif user_input &lt; NUM:</div><div class="line">        print(&apos;ä½ è¾“å…¥çš„æ•°æ¯”è¿™ä¸ªæ•°è¦å°&apos;)</div><div class="line">    else:</div><div class="line">        print(&apos;ä½ è¾“å…¥çš„æ•°æ¯”è¿™ä¸ªè¦å¤§&apos;)</div><div class="line">    count +=1</div><div class="line">else:</div><div class="line">    print(&apos;ä½ å·²ç»è¶…è¿‡äº†ä¸‰æ¬¡æœºä¼š&apos;)</div></pre></td></tr></table></figure><p>ä¸ç”¨å˜é‡æ—¶ï¼ŒæŠŠå˜é‡æ”¾ç©º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">for _ in range(0,3):</div><div class="line">    user_input = int(input(&apos;è¯·ä½ è¾“å…¥ä¸€ä¸ªæ•°å­—: &apos;))</div><div class="line">    if user_input == NUM :</div><div class="line">        print(&apos;ä½ çŒœå¯¹äº†&apos;)</div><div class="line">        break</div><div class="line">    elif user_input &lt; NUM:</div><div class="line">        print(&apos;ä½ è¾“å…¥çš„æ•°æ¯”è¿™ä¸ªæ•°è¦å°&apos;)</div><div class="line">    else:</div><div class="line">        print(&apos;ä½ è¾“å…¥çš„æ•°æ¯”è¿™ä¸ªè¦å¤§&apos;)</div><div class="line">    count +=1</div><div class="line">else:</div><div class="line">    print(&apos;ä½ å·²ç»è¶…è¿‡äº†ä¸‰æ¬¡æœºä¼š&apos;)</div></pre></td></tr></table></figure><h3 id="æ‰“å°æ‰¬è¾‰ä¸‰è§’"><a href="#æ‰“å°æ‰¬è¾‰ä¸‰è§’" class="headerlink" title="æ‰“å°æ‰¬è¾‰ä¸‰è§’"></a>æ‰“å°æ‰¬è¾‰ä¸‰è§’</h3><p>python ä¸­æ±‚é˜¶ä¹˜çš„æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">import math </div><div class="line">math.factorial(5) # 5 çš„é˜¶ä¹˜</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">import math</div><div class="line"></div><div class="line">lines = 10</div><div class="line"></div><div class="line">for n in range(0,lines):</div><div class="line">    if n == 0:</div><div class="line">        for _ in range(0, lines // 2):</div><div class="line">            print(&apos; &apos;,end=&apos; &apos;)</div><div class="line">        print(1)</div><div class="line">    else:</div><div class="line">        for _ in range(0,lines //2):</div><div class="line">            print(&apos; &apos;,end=&apos; &apos;)</div><div class="line"></div><div class="line">        for m in range(0, n+1):</div><div class="line">            num = math.factorial(n) //(math.factorial(m) * math.factorial(n-m))</div><div class="line">            print(num, end=&apos; &apos;)</div><div class="line">        print()</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">host = &#123;&quot;host%d&quot;%i: &quot;192.168.1.%d&quot;%i for i in range(2,11)&#125;</div><div class="line">for i in host.values():</div><div class="line">    print (i)</div><div class="line">    </div><div class="line">lst = list(range(1,101))</div><div class="line">lst[0::2] [::-1]</div><div class="line">lst[1::2] [::-1]</div></pre></td></tr></table></figure><h3 id="python-ä¸ç”¨æˆ·äº¤äº’è¾“å…¥ä½æ•°ç”Ÿæˆè‹¥å¹²éšæœºæ•°ï¼Œæ±‚è‹¥å¹²éšæœºæ•°çš„æœ€å¤§å€¼ï¼Œæœ€å°å€¼"><a href="#python-ä¸ç”¨æˆ·äº¤äº’è¾“å…¥ä½æ•°ç”Ÿæˆè‹¥å¹²éšæœºæ•°ï¼Œæ±‚è‹¥å¹²éšæœºæ•°çš„æœ€å¤§å€¼ï¼Œæœ€å°å€¼" class="headerlink" title="python ä¸ç”¨æˆ·äº¤äº’è¾“å…¥ä½æ•°ç”Ÿæˆè‹¥å¹²éšæœºæ•°ï¼Œæ±‚è‹¥å¹²éšæœºæ•°çš„æœ€å¤§å€¼ï¼Œæœ€å°å€¼"></a>python ä¸ç”¨æˆ·äº¤äº’è¾“å…¥ä½æ•°ç”Ÿæˆè‹¥å¹²éšæœºæ•°ï¼Œæ±‚è‹¥å¹²éšæœºæ•°çš„æœ€å¤§å€¼ï¼Œæœ€å°å€¼</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python3</div><div class="line">from fabric.colors import red,blue,green,cyan</div><div class="line">import random</div><div class="line"></div><div class="line"></div><div class="line">a=int(input(red(&apos;æ‚¨è¦è·å–å¤šå°‘ä¸ªéšæœºæ•°: &apos;)))</div><div class="line">b=int(input(red(&apos;æ‚¨è¦è·å–çš„éšæœºæ•°ä½æ•°: &apos;))) + 1</div><div class="line"></div><div class="line">num_two = []</div><div class="line">for i in range(int(a)):</div><div class="line">    num = random.randrange(0,b)</div><div class="line">    print(cyan(&apos;ç¬¬&apos;) + blue(i + 1) + cyan(&apos;ä¸ªéšæœºæ•°ä¸º&apos;),blue(num))</div><div class="line">    num_two.append(num)</div><div class="line">print(cyan(&apos;æ‚¨è·å–äº†&apos;) + blue(i + 1) + cyan(&apos;ä¸ªéšæœºæ•°&apos;))</div><div class="line">print(cyan(&apos;æ‚¨çš„ç¬¬&apos;) + blue(num_two.index(max(num_two)) +1 ) + cyan(&apos;ä¸ªéšæœºæ•°ä¸ºæœ€å¤§å€¼:&apos;), green(max(num_two)))</div><div class="line">print(cyan(&apos;æ‚¨çš„ç¬¬&apos;) + blue(num_two.index(min(num_two)) +1 ) + cyan(&apos;ä¸ªéšæœºæ•°ä¸ºæœ€å°å€¼:&apos;), green(min(num_two)))</div></pre></td></tr></table></figure><p>æ–¹æ³•äºŒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python3</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line">from fabric.colors import red,blue,green,cyan</div><div class="line">import random</div><div class="line">a=int(input(red(&apos;æ‚¨è¦è·å–å¤šå°‘ä¸ªéšæœºæ•°: &apos;)))</div><div class="line">b=int(input(red(&apos;æ‚¨è¦ç²å–çš„éš¨æ©Ÿæ•¸ç¯„åœ: &apos;))) + 1</div><div class="line">range_init = list(range(1,int(a)+1))</div><div class="line">print (range_init)</div><div class="line">num_two = []</div><div class="line">for i in range_init:</div><div class="line">    num = random.randrange(0,b)</div><div class="line">    num = random.randrange(0,b)</div><div class="line"></div><div class="line">    print(cyan(&apos;ç¬¬&apos;) + blue(i) + cyan(&apos;ä¸ªéšæœºæ•°ä¸º&apos;),blue(num))</div><div class="line">    num_two.append(num)</div><div class="line">print(cyan(&apos;æ‚¨è·å–äº†&apos;) + blue(i) + cyan(&apos;ä¸ªéšæœºæ•°&apos;))</div><div class="line">print(cyan(&apos;æ‚¨çš„ç¬¬&apos;) + blue(num_two.index(max(num_two))+1) + cyan(&apos;ä¸ªéšæœºæ•°ä¸ºæœ€å¤§å€¼:&apos;), green(max(num_two)))</div><div class="line">print(cyan(&apos;æ‚¨çš„ç¬¬&apos;) + blue(num_two.index(min(num_two))+1) + cyan(&apos;ä¸ªéšæœºæ•°ä¸ºæœ€å°å€¼:&apos;), green(min(num_two)))</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>awk çš„ç»ƒä¹ </title>
      <link href="/2018/06/18/awk%E7%9A%84%E7%BB%83%E4%B9%A0/"/>
      <url>/2018/06/18/awk%E7%9A%84%E7%BB%83%E4%B9%A0/</url>
      <content type="html"><![CDATA[<h1 id="awkæ¯æ—¥ç»ƒ"><a href="#awkæ¯æ—¥ç»ƒ" class="headerlink" title="awkæ¯æ—¥ç»ƒ"></a>awkæ¯æ—¥ç»ƒ</h1><p><img src="/images/awk.jpg" alt=""></p><h2 id="å…ˆç†Ÿç»ƒä¸€äº›æ“ä½œ"><a href="#å…ˆç†Ÿç»ƒä¸€äº›æ“ä½œ" class="headerlink" title="å…ˆç†Ÿç»ƒä¸€äº›æ“ä½œ"></a>å…ˆç†Ÿç»ƒä¸€äº›æ“ä½œ</h2><h3 id="1ã€-ä»¥ç©ºæ ¼åšä¸ºåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd-æ–‡ä»¶çš„ç¬¬ä¸€åˆ—"><a href="#1ã€-ä»¥ç©ºæ ¼åšä¸ºåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd-æ–‡ä»¶çš„ç¬¬ä¸€åˆ—" class="headerlink" title="1ã€ ä»¥ç©ºæ ¼åšä¸ºåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd æ–‡ä»¶çš„ç¬¬ä¸€åˆ—"></a>1ã€ ä»¥ç©ºæ ¼åšä¸ºåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd æ–‡ä»¶çš„ç¬¬ä¸€åˆ—</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk &apos;&#123;print $1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="2ã€-ä»¥å†’å·åšåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd-æ–‡ä»¶çš„ç¬¬ä¸€åˆ—-å³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·"><a href="#2ã€-ä»¥å†’å·åšåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd-æ–‡ä»¶çš„ç¬¬ä¸€åˆ—-å³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·" class="headerlink" title="2ã€ ä»¥å†’å·åšåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd æ–‡ä»¶çš„ç¬¬ä¸€åˆ—,å³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·"></a>2ã€ ä»¥å†’å·åšåˆ†æ ¼ç¬¦ï¼Œæ‰“å°passwd æ–‡ä»¶çš„ç¬¬ä¸€åˆ—,å³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;print $1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="3ã€-ä»¥ç®¡é“æ–¹å¼ï¼Œæ‰“å°passwd-æ–‡ä»¶çš„ç¬¬ä¸‰åˆ—ï¼Œå³å…±è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·çš„idå·"><a href="#3ã€-ä»¥ç®¡é“æ–¹å¼ï¼Œæ‰“å°passwd-æ–‡ä»¶çš„ç¬¬ä¸‰åˆ—ï¼Œå³å…±è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·çš„idå·" class="headerlink" title="3ã€ ä»¥ç®¡é“æ–¹å¼ï¼Œæ‰“å°passwd æ–‡ä»¶çš„ç¬¬ä¸‰åˆ—ï¼Œå³å…±è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·çš„idå·"></a>3ã€ ä»¥ç®¡é“æ–¹å¼ï¼Œæ‰“å°passwd æ–‡ä»¶çš„ç¬¬ä¸‰åˆ—ï¼Œå³å…±è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ç”¨æˆ·çš„idå·</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  cat /etc/passwd | awk -F : &apos;&#123;print $3&#125;&apos;</div></pre></td></tr></table></figure><h3 id="4ã€-ä»¥è¾“å…¥é‡å®šå‘æ–¹å¼ï¼Œæ‰“å°-passwd-æ–‡ä»¶çš„ç¬¬1åˆ—ï¼Œå³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·"><a href="#4ã€-ä»¥è¾“å…¥é‡å®šå‘æ–¹å¼ï¼Œæ‰“å°-passwd-æ–‡ä»¶çš„ç¬¬1åˆ—ï¼Œå³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·" class="headerlink" title="4ã€ ä»¥è¾“å…¥é‡å®šå‘æ–¹å¼ï¼Œæ‰“å° passwd æ–‡ä»¶çš„ç¬¬1åˆ—ï¼Œå³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·"></a>4ã€ ä»¥è¾“å…¥é‡å®šå‘æ–¹å¼ï¼Œæ‰“å° passwd æ–‡ä»¶çš„ç¬¬1åˆ—ï¼Œå³è·å–å½“å‰ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰ç”¨æˆ·</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;print $1&#125;&apos; &lt; /etc/passwd</div></pre></td></tr></table></figure><h3 id="5ã€ç”¨awk-è‡ªå¸¦BEGINæ‰“å°-hello-awk-å­—ç¬¦ä¸²"><a href="#5ã€ç”¨awk-è‡ªå¸¦BEGINæ‰“å°-hello-awk-å­—ç¬¦ä¸²" class="headerlink" title="5ã€ç”¨awk è‡ªå¸¦BEGINæ‰“å°  hello awk å­—ç¬¦ä¸²"></a>5ã€ç”¨awk è‡ªå¸¦BEGINæ‰“å°  hello awk å­—ç¬¦ä¸²</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk &apos;BEGIN&#123;print &quot;hello awk&quot;&#125;&apos; æ‰§è¡ŒåªåŠè¾“å‡ºhello awk</div></pre></td></tr></table></figure><h3 id="6ã€-ç”¨awk-è·å–df-å‘½ä»¤çš„filesystem-ä¸userd"><a href="#6ã€-ç”¨awk-è·å–df-å‘½ä»¤çš„filesystem-ä¸userd" class="headerlink" title="6ã€ ç”¨awk  è·å–df å‘½ä»¤çš„filesystem ä¸userd %"></a>6ã€ ç”¨awk  è·å–df å‘½ä»¤çš„filesystem ä¸userd %</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># df | awk &apos;&#123;print $1,$5&#125;&apos;  </div><div class="line"># df | awk &apos;&#123;print $1 $5&#125;&apos;  # æ³¨æ„è¿™æ ·è¾“å‡ºä¿¡æ¯å°±è¿æ¥åˆ°ä¸€å—äº†</div><div class="line">    FilesystemUse%</div><div class="line">    /dev/vda113%</div><div class="line">    devtmpfs0%</div><div class="line">    tmpfs0%</div><div class="line">    tmpfs1%</div><div class="line">    tmpfs0%</div><div class="line">    tmpfs0%</div><div class="line"># df | awk &apos;&#123;print $1&quot;===&quot;$5&#125;&apos; #  åœ¨ä¸¤ä¸ªä½ç½®å˜é‡çš„ä¸­é—´åŠ å…¥ä¸‰ä¸ª=== å·</div><div class="line">    Filesystem===Use%</div><div class="line">    /dev/vda1===13%</div><div class="line">    devtmpfs===0%</div><div class="line">    tmpfs===0%</div><div class="line">    tmpfs===1%</div><div class="line">    tmpfs===0%</div><div class="line">    tmpfs===0%</div><div class="line"> # df | awk &apos;&#123;print $1&quot;\t&quot;$5&#125;&apos;  # åœ¨ä¸¤ä¸ªä½ç½®å˜é‡çš„ä¸­é—´åŠ å…¥ä¸€ä¸ªtab é”®</div><div class="line">    Filesystem      Use%</div><div class="line">    /dev/vda1       13%</div><div class="line">    devtmpfs        0%</div><div class="line">    tmpfs   0%</div><div class="line">    tmpfs   1%</div><div class="line">    tmpfs   0%</div><div class="line">    tmpfs   0%</div></pre></td></tr></table></figure><h3 id="7ã€-ç»“åˆtail-å‘½ä»¤æ¥è¿›è¡Œå­—ç¬¦ä¸²åˆ‡å‰²"><a href="#7ã€-ç»“åˆtail-å‘½ä»¤æ¥è¿›è¡Œå­—ç¬¦ä¸²åˆ‡å‰²" class="headerlink" title="7ã€ ç»“åˆtail å‘½ä»¤æ¥è¿›è¡Œå­—ç¬¦ä¸²åˆ‡å‰²"></a>7ã€ ç»“åˆtail å‘½ä»¤æ¥è¿›è¡Œå­—ç¬¦ä¸²åˆ‡å‰²</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  tail -4 /etc/fstab | awk &apos;&#123;print $3,$4&#125;&apos;</div></pre></td></tr></table></figure><h3 id="8ã€-æ‰‹åŠ¨æŒ‡å®šåˆ†éš”ç¬¦ä¸º-ï¼Œæ‰“å°ç¬¬ä¸€åˆ—-ç¬¬ä¸‰åˆ—ï¼ŒFS-å³æŒ‡å®šåˆ†éš”ç¬¦"><a href="#8ã€-æ‰‹åŠ¨æŒ‡å®šåˆ†éš”ç¬¦ä¸º-ï¼Œæ‰“å°ç¬¬ä¸€åˆ—-ç¬¬ä¸‰åˆ—ï¼ŒFS-å³æŒ‡å®šåˆ†éš”ç¬¦" class="headerlink" title="8ã€ æ‰‹åŠ¨æŒ‡å®šåˆ†éš”ç¬¦ä¸º: ï¼Œæ‰“å°ç¬¬ä¸€åˆ—:ç¬¬ä¸‰åˆ—ï¼ŒFS å³æŒ‡å®šåˆ†éš”ç¬¦"></a>8ã€ æ‰‹åŠ¨æŒ‡å®šåˆ†éš”ç¬¦ä¸º: ï¼Œæ‰“å°ç¬¬ä¸€åˆ—:ç¬¬ä¸‰åˆ—ï¼ŒFS å³æŒ‡å®šåˆ†éš”ç¬¦</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v FS=&quot;:&quot; &apos;&#123;print $1,FS,$3&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="9ã€å°†åˆ—å‡ºåˆ†ç¬¦ï¼Œæ”¹ä¸ºå…¶å®ƒçš„å­—ç¬¦"><a href="#9ã€å°†åˆ—å‡ºåˆ†ç¬¦ï¼Œæ”¹ä¸ºå…¶å®ƒçš„å­—ç¬¦" class="headerlink" title="9ã€å°†åˆ—å‡ºåˆ†ç¬¦ï¼Œæ”¹ä¸ºå…¶å®ƒçš„å­—ç¬¦"></a>9ã€å°†åˆ—å‡ºåˆ†ç¬¦ï¼Œæ”¹ä¸ºå…¶å®ƒçš„å­—ç¬¦</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk -v FS=&quot;:&quot; -v OFS=&quot;uid is &quot; &apos;&#123;print $1,FS,$3&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="10-ã€ä»¥ç©ºæ ¼åšä¸ºæ¢è¡Œç¬¦ï¼Œå–å…¶ç¬¬ä¸€ä¸ªå­—æ®µ"><a href="#10-ã€ä»¥ç©ºæ ¼åšä¸ºæ¢è¡Œç¬¦ï¼Œå–å…¶ç¬¬ä¸€ä¸ªå­—æ®µ" class="headerlink" title="10 ã€ä»¥ç©ºæ ¼åšä¸ºæ¢è¡Œç¬¦ï¼Œå–å…¶ç¬¬ä¸€ä¸ªå­—æ®µ"></a>10 ã€ä»¥ç©ºæ ¼åšä¸ºæ¢è¡Œç¬¦ï¼Œå–å…¶ç¬¬ä¸€ä¸ªå­—æ®µ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v RS=&quot; &quot; &apos;&#123;print $1&#125;&apos; text.txt</div></pre></td></tr></table></figure><h3 id="11ã€-å°†è®°å½•è¾“å‡ºåˆ†éš”ç¬¦é»˜è®¤å€¼â€-nâ€ï¼Œæ¢æˆâ€-â€"><a href="#11ã€-å°†è®°å½•è¾“å‡ºåˆ†éš”ç¬¦é»˜è®¤å€¼â€-nâ€ï¼Œæ¢æˆâ€-â€" class="headerlink" title="11ã€ å°†è®°å½•è¾“å‡ºåˆ†éš”ç¬¦é»˜è®¤å€¼â€\nâ€ï¼Œæ¢æˆâ€===â€"></a>11ã€ å°†è®°å½•è¾“å‡ºåˆ†éš”ç¬¦é»˜è®¤å€¼â€\nâ€ï¼Œæ¢æˆâ€===â€</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk -v FS=&quot;:&quot; -v ORS&quot;===&quot; &apos;&#123;print $1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="12ã€-æˆªå–-etc-passwd-çš„ç™»å½•shell"><a href="#12ã€-æˆªå–-etc-passwd-çš„ç™»å½•shell" class="headerlink" title="12ã€ æˆªå–/etc/passwd çš„ç™»å½•shell"></a>12ã€ æˆªå–/etc/passwd çš„ç™»å½•shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v FS=&quot;:&quot; &apos;&#123;print $NF-1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="13ã€-æˆªå–-etc-passwd-çš„å®¶ç›®å½•"><a href="#13ã€-æˆªå–-etc-passwd-çš„å®¶ç›®å½•" class="headerlink" title="13ã€ æˆªå– /etc/passwd çš„å®¶ç›®å½•"></a>13ã€ æˆªå– /etc/passwd çš„å®¶ç›®å½•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk -v FS=&quot;:&quot; &apos;&#123;print $(NF-1)&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="14ã€æˆªå–æŒ‡å®šå­—æ®µå¹¶æ‰“å°awk-å†…ç½®å˜é‡"><a href="#14ã€æˆªå–æŒ‡å®šå­—æ®µå¹¶æ‰“å°awk-å†…ç½®å˜é‡" class="headerlink" title="14ã€æˆªå–æŒ‡å®šå­—æ®µå¹¶æ‰“å°awk å†…ç½®å˜é‡"></a>14ã€æˆªå–æŒ‡å®šå­—æ®µå¹¶æ‰“å°awk å†…ç½®å˜é‡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v RS=&quot;:&quot; &apos;&#123;print RS,NR,$0&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="15ã€-ä»¥å†’å·åˆ†éš”è®°å½•å½“å‰å­—æ®µä¸ªæ•°å¹¶è¿›è¡Œè®¡ç®—"><a href="#15ã€-ä»¥å†’å·åˆ†éš”è®°å½•å½“å‰å­—æ®µä¸ªæ•°å¹¶è¿›è¡Œè®¡ç®—" class="headerlink" title="15ã€ ä»¥å†’å·åˆ†éš”è®°å½•å½“å‰å­—æ®µä¸ªæ•°å¹¶è¿›è¡Œè®¡ç®—"></a>15ã€ ä»¥å†’å·åˆ†éš”è®°å½•å½“å‰å­—æ®µä¸ªæ•°å¹¶è¿›è¡Œè®¡ç®—</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v FS=&quot;:&quot; &apos;&#123;print NF*5&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="16ã€ç»Ÿè®¡å½“å‰è¾“å…¥æ–‡ä»¶çš„ä¸ªæ•°"><a href="#16ã€ç»Ÿè®¡å½“å‰è¾“å…¥æ–‡ä»¶çš„ä¸ªæ•°" class="headerlink" title="16ã€ç»Ÿè®¡å½“å‰è¾“å…¥æ–‡ä»¶çš„ä¸ªæ•°"></a>16ã€ç»Ÿè®¡å½“å‰è¾“å…¥æ–‡ä»¶çš„ä¸ªæ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;print FNR&#125;&apos; /etc/passwd /etc/shadow</div></pre></td></tr></table></figure><h3 id="17ã€-æ‰“å°ä¸¤æ–‡ä»¶è¾“å‡ºçš„è¡Œæ•°"><a href="#17ã€-æ‰“å°ä¸¤æ–‡ä»¶è¾“å‡ºçš„è¡Œæ•°" class="headerlink" title="17ã€ æ‰“å°ä¸¤æ–‡ä»¶è¾“å‡ºçš„è¡Œæ•°"></a>17ã€ æ‰“å°ä¸¤æ–‡ä»¶è¾“å‡ºçš„è¡Œæ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;print FNR,$1&#125;&apos; /etc/passwd /etc/shadow</div></pre></td></tr></table></figure><h3 id="18ã€è¾“å‡ºä¸¤æ–‡ä»¶çš„æ–‡ä»¶åè¡Œå·åŠå¯¹åº”ç”¨çš„ç”¨æˆ·å"><a href="#18ã€è¾“å‡ºä¸¤æ–‡ä»¶çš„æ–‡ä»¶åè¡Œå·åŠå¯¹åº”ç”¨çš„ç”¨æˆ·å" class="headerlink" title="18ã€è¾“å‡ºä¸¤æ–‡ä»¶çš„æ–‡ä»¶åè¡Œå·åŠå¯¹åº”ç”¨çš„ç”¨æˆ·å"></a>18ã€è¾“å‡ºä¸¤æ–‡ä»¶çš„æ–‡ä»¶åè¡Œå·åŠå¯¹åº”ç”¨çš„ç”¨æˆ·å</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk -F: &apos;&#123;print FILENAME,FNR,$1&#125;&apos; /etc/passwd /etc/shadow</div></pre></td></tr></table></figure><h3 id="19ã€-ç»Ÿè®¡å‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°"><a href="#19ã€-ç»Ÿè®¡å‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°" class="headerlink" title="19ã€ ç»Ÿè®¡å‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°"></a>19ã€ ç»Ÿè®¡å‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;BEGIN&#123;print ARGC&#125;&apos; /etc/passwd /etc/group </div><div class="line">    3</div></pre></td></tr></table></figure><h3 id="20ã€-æ‰“å°å‘½ä»¤è¡Œå‚æ•°çš„å†…å®¹"><a href="#20ã€-æ‰“å°å‘½ä»¤è¡Œå‚æ•°çš„å†…å®¹" class="headerlink" title="20ã€ æ‰“å°å‘½ä»¤è¡Œå‚æ•°çš„å†…å®¹"></a>20ã€ æ‰“å°å‘½ä»¤è¡Œå‚æ•°çš„å†…å®¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;BEGIN&#123;print ARGV[2]&#125;&apos; /etc/passwd /etc/group </div><div class="line">   /etc/group</div></pre></td></tr></table></figure><p>awkå˜é‡ è‡ªå®šä¹‰å˜é‡åŒºåˆ†å¤§å°å†™</p><h3 id="21ã€-æŒ‡å®šå˜é‡è°ƒç”¨æ‰“å°"><a href="#21ã€-æŒ‡å®šå˜é‡è°ƒç”¨æ‰“å°" class="headerlink" title="21ã€ æŒ‡å®šå˜é‡è°ƒç”¨æ‰“å°"></a>21ã€ æŒ‡å®šå˜é‡è°ƒç”¨æ‰“å°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: -v name=&quot;username&quot; &apos;&#123;print name&quot;:&quot;$1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="22-ã€-æŒ‡å®šå¤šä¸ªå˜é‡è°ƒç”¨æ‰“å°ï¼Œå¹¶åŠ å…¥åˆ¶è¡¨ç¬¦"><a href="#22-ã€-æŒ‡å®šå¤šä¸ªå˜é‡è°ƒç”¨æ‰“å°ï¼Œå¹¶åŠ å…¥åˆ¶è¡¨ç¬¦" class="headerlink" title="22 ã€ æŒ‡å®šå¤šä¸ªå˜é‡è°ƒç”¨æ‰“å°ï¼Œå¹¶åŠ å…¥åˆ¶è¡¨ç¬¦"></a>22 ã€ æŒ‡å®šå¤šä¸ªå˜é‡è°ƒç”¨æ‰“å°ï¼Œå¹¶åŠ å…¥åˆ¶è¡¨ç¬¦</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk -F: -v name=&quot;username&quot; -v uid=&quot;uid &quot; &apos;&#123;print name&quot;:&quot;$1&quot;\t&quot;uid&quot;:&quot;$3&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;n=&quot;username&quot;;uid=&quot;userid&quot;; print n &quot;:&quot;$1&quot;\t&quot;uid&quot;:&quot;$3&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>äº†è§£ä¸€ä¸‹ä»¥ä¸‹çš„ç»ƒä¹ <br>awk -F: â€˜{n=â€hahaâ€; print n,m;m=â€xixiâ€}â€™ /etc/passwd å˜é‡åå®šä¹‰ä¹Ÿè¡Œï¼ˆè¡¨é¢ä¸Šå¯ç”¨ï¼Œä½†å®é™…ä¸Šæœ‰é—®é¢˜ï¼šç¬¬ä¸€æ¬¡å¾ªç¯ï¼‰<br>awk -F: â€˜BEGIN{n=â€hahaâ€;hehe=100;m=200;print n,m}â€™ /etc/passwd </p><h3 id="23ã€-printf-æŒ‡å®šè¾“å‡ºæ ¼å¼"><a href="#23ã€-printf-æŒ‡å®šè¾“å‡ºæ ¼å¼" class="headerlink" title="23ã€ printf  æŒ‡å®šè¾“å‡ºæ ¼å¼"></a>23ã€ printf  æŒ‡å®šè¾“å‡ºæ ¼å¼</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;printf &quot;%s == %d\n&quot;,$1,$3&#125;&apos; /etc/passwd %æ ¼å¼ä¸$å­—ç¬¦å¿…é¡»ä¸€ä¸€å¯¹åº”</div><div class="line"># awk -F: &apos;&#123;printf &quot;%s20s == %d\n&quot;,$1,$3&#125;&apos; /etc/passwd å³å¯¹é½</div><div class="line"># awk -F: &apos;&#123;printf &quot;%s-20s == %d\n&quot;,$1,$3&#125;&apos; /etc/passwd å·¦å¯¹é½</div><div class="line"># awk -F: &apos;&#123;printf &quot;%s-20s == %10.3f\n&quot;,$1,$3&#125;&apos; /etc/passwd å°æ•°ä½çš„å®½åº¦</div><div class="line"># awk -F: &apos;&#123;printf &quot;%s-20s == %+df\n&quot;,$1,$3&#125;&apos; /etc/passwd</div><div class="line"># awk -F : &apos;&#123;printf &quot;%s\n&quot;,$1&#125;&apos; /etc/passwd </div><div class="line"># awk -F : &apos;&#123;printf &quot;Username: %s\n&quot;,$1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="24ã€awk-æ•°æœ¯è¿ç®—æ“ä½œ"><a href="#24ã€awk-æ•°æœ¯è¿ç®—æ“ä½œ" class="headerlink" title="24ã€awk æ•°æœ¯è¿ç®—æ“ä½œ"></a>24ã€awk æ•°æœ¯è¿ç®—æ“ä½œ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># awk &apos;BEGIN&#123;print 2^10&#125;&apos;</div><div class="line"># awk &apos;BEGIN&#123;n=1;m=2;print m+=n&#125;&apos; </div><div class="line"># awk &apos;BEGIN&#123;n=1;m=2;print m++;print m&#125;&apos; </div><div class="line"># awk &apos;BEGIN&#123;n=1;m=2;print ++m;print m&#125;&apos; </div><div class="line"># awk -F: &apos;$3 &gt; 1000&#123;print $1,$3&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;$3==0&#123;print $1,$3&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;$0~&quot;root&quot;&#123;print $1,$3&#125;&apos; /etc/passwd ~åŒ…æ¶µ</div><div class="line"># awk -F: &apos;$0~/root/&#123;print $0&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;$0~/^root/&#123;print $0&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;$0 !~/^root/&#123;print $0&#125;&apos; /etc/passwd </div><div class="line"># awk -F : &apos;$0 ~ /root/&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="25ã€æ“ä½œç¬¦-amp-amp-ä¸¤éƒ½æ‰§è¡Œ"><a href="#25ã€æ“ä½œç¬¦-amp-amp-ä¸¤éƒ½æ‰§è¡Œ" class="headerlink" title="25ã€æ“ä½œç¬¦  &amp;&amp; ä¸¤éƒ½æ‰§è¡Œ  ||"></a>25ã€æ“ä½œç¬¦  &amp;&amp; ä¸¤éƒ½æ‰§è¡Œ  ||</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;$3==0 || $3 &gt;=1000 &#123;print $1&#125;&apos; /etc/passwd </div><div class="line"># awk -F: !(&apos;$3==0 || $3 &gt;=1000) &#123;print $1&#125;&apos; /etc/passwd  or </div><div class="line"># awk -F : &apos;$3&gt;1 &amp;&amp; $3 &lt;1000 &#123;print $1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="26ã€æ¡ä»¶è¡¨è¾¾å¼ä¸‰ç›®"><a href="#26ã€æ¡ä»¶è¡¨è¾¾å¼ä¸‰ç›®" class="headerlink" title="26ã€æ¡ä»¶è¡¨è¾¾å¼ä¸‰ç›®"></a>26ã€æ¡ä»¶è¡¨è¾¾å¼ä¸‰ç›®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;$3&lt;1000?var=&quot;sysuser&quot;: var=&quot;commonuser&quot;&#123;print var&quot;:&quot;$1,$3&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="27ã€å¸¸ç”¨è¯­æ³•ç»ƒä¹ "><a href="#27ã€å¸¸ç”¨è¯­æ³•ç»ƒä¹ " class="headerlink" title="27ã€å¸¸ç”¨è¯­æ³•ç»ƒä¹ "></a>27ã€å¸¸ç”¨è¯­æ³•ç»ƒä¹ </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;print $1&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;/^root/&#123;print $0&#125;&apos; /etc/passwd </div><div class="line"># awk &apos;/^U/&#123;print $1&#125;&apos; /etc/fstab </div><div class="line"># awk &apos;!/^U/&#123;print $1&#125;&apos; /etc/fstab </div><div class="line"># awk &apos;&quot; &quot;&#123;print $0&#125;&apos; /etc/fstab </div><div class="line"># awk &apos;i=1;j=1&#123;print i,j&#125;&apos; /etc/fstab æŠŠæ–‡ä»¶æ‰“å°ä¸¤æ¬¡</div><div class="line"># awk â€˜i=1;j=0&#123;print i,j&#125;â€™ /etc/fstab </div><div class="line"># awk &apos;i=1;j=1&#123;print i,j&#125;&apos; /etc/fstab </div><div class="line"># awk &apos;!2&apos; /etc/fstab </div><div class="line"># awk &apos;&quot;abc&quot;&apos; /etc/fstab </div><div class="line"># awk -F: &apos;$NF==&quot;/bin/bash&quot;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;$NF~&quot;/bin/bash&quot;  /etc/passwd </div><div class="line"># awk -F: &apos;$NF!~&quot;/bin/bash&quot;  /etc/passwd </div><div class="line"># awk -F: &apos;/^root/,/^ftp/&apos; /etc/passwd </div><div class="line"># awk -F: &apos;/^root\&gt;/,/^ftp/&apos; /etc/passwd  æ³¨ï¼š\b ä¸è¡Œ</div><div class="line"># awk -F: &apos;NR&gt;=10&amp;&amp;NR&lt;=30&#123;print NR&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="28ã€æ¯”è¾ƒç»•çš„ç»ƒä¹ "><a href="#28ã€æ¯”è¾ƒç»•çš„ç»ƒä¹ " class="headerlink" title="28ã€æ¯”è¾ƒç»•çš„ç»ƒä¹ "></a>28ã€æ¯”è¾ƒç»•çš„ç»ƒä¹ </h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;NR&gt;=10&amp;&amp;NR&lt;=30&#123;print NR,$0&#125;&apos; /etc/passswd </div><div class="line"># awk -F: &apos;BEGIN&#123;print &quot;linenumber usernmae&quot;&#125;NR&gt;=10&amp;&amp;NR&lt;=30&#123;print NR,$1&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;BEGIN&#123;print &quot;linenumber username&quot;&#125;NR&gt;=10&amp;&amp;NR&lt;=30&#123;print NR,$1&#125; END print &quot;end&quot;&#125;&apos; /etc/passwd </div><div class="line"># awk -F: &apos;&#123;print &quot;linenumber username&quot;;print NR,$1&#125;END&#123;print &quot;end&quot;&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;print &quot;linenumber username\n-------------&quot;;print $1&#125;END&#123;print &quot;end&quot;&#125;&apos; /etc/passwd </div><div class="line"># seq 10 | awk &apos;&#123;i=!i;print i&#125;&apos;</div><div class="line"># seq 10 | awk &apos;i=!i&apos;</div><div class="line"># seq 10 | awk &apos;!(i=!i)&apos;</div><div class="line"># seq 10 | awk -v -i=1 &apos;i=!i&apos;</div></pre></td></tr></table></figure><h3 id="29ã€å¸¸è§å¾ªç¯ä¸ç”¨æ³•"><a href="#29ã€å¸¸è§å¾ªç¯ä¸ç”¨æ³•" class="headerlink" title="29ã€å¸¸è§å¾ªç¯ä¸ç”¨æ³•"></a>29ã€å¸¸è§å¾ªç¯ä¸ç”¨æ³•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># awk &apos;BEGIN&#123;for(i=1;i&lt;=100;i++)sum+=i;print sum&#125;&apos;</div><div class="line"># echo &#123;1..100&#125;|sed &apos;s/ /+/g&apos;|bc</div><div class="line"># echo &#123;1..100&#125;| tr &quot; &quot; &quot;+&quot; |bc </div><div class="line">#!/bin/bash</div><div class="line">num=0</div><div class="line">for i in `seq 100`; do </div><div class="line">    num=$[$num+$i]</div><div class="line">    echo $i</div><div class="line">done</div><div class="line">echo $num</div><div class="line">#!/usr/bin/env python2.7</div><div class="line">num=0</div><div class="line">for i in range(1,101):</div><div class="line">    print i</div><div class="line">    num = num + i</div><div class="line">print num</div></pre></td></tr></table></figure><h2 id="AWK-åŸºç¡€"><a href="#AWK-åŸºç¡€" class="headerlink" title="AWK åŸºç¡€"></a>AWK åŸºç¡€</h2><ul><li>awkï¼šAho, Weinberger, Kernighanï¼ŒæŠ¥å‘Šç”Ÿæˆå™¨ï¼Œæ ¼å¼åŒ–æ–‡æœ¬è¾“å‡º</li><li>æœ‰å¤šç§ç‰ˆæœ¬ï¼šNew awkï¼ˆnawkï¼‰,GNU awkï¼ˆgawkï¼‰</li><li>gawkï¼šæ¨¡å¼æ‰«æå’Œå¤„ç†è¯­è¨€</li></ul><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># awk [options] &apos;program&apos; var=value fileâ€¦</div><div class="line"># awk [options] -f programfile var=value fileâ€¦</div><div class="line"># awk [options] &apos;BEGIN&#123; action;â€¦ &#125; pattern&#123; action;â€¦ &#125; END&#123; action;â€¦ &#125;&apos; file ...</div></pre></td></tr></table></figure><p>awkç¨‹åºé€šå¸¸ç”±ï¼šBEGINè¯­å¥å—ã€èƒ½å¤Ÿä½¿ç”¨æ¨¡å¼åŒ¹é…çš„é€šç”¨è¯­å¥å—ã€ENDè¯­å¥å—ï¼Œå…±3éƒ¨åˆ†ç»„æˆ<br>  programé€šå¸¸æ˜¯è¢«å•å¼•å·æˆ–åŒå¼•å·ä¸­<br>    é€‰é¡¹ï¼š<br>        -F:æŒ‡æ˜è¾“å…¥æ—¶ç”¨åˆ°çš„å­—æ®µåˆ†éš”ç¬¦<br>        -v var=value:è‡ªå®šä¹‰å˜é‡</p><h3 id="awkè¯­è¨€"><a href="#awkè¯­è¨€" class="headerlink" title="awkè¯­è¨€"></a>awkè¯­è¨€</h3><ul><li>åŸºæœ¬æ ¼å¼ï¼šawk [options] â€˜programâ€™ fileâ€¦</li><li>program:pattern{action statements;..}</li><li>patternå’Œactionï¼š<br>patternéƒ¨åˆ†å†³å®šåŠ¨ä½œè¯­å¥ä½•æ—¶è§¦å‘åŠè§¦å‘äº‹ä»¶<pre><code>BEGIN,END</code></pre>  action statements å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ”¾åœ¨{}å†…æŒ‡æ˜<br>print, printf</li></ul><p>åˆ†å‰²ç¬¦ã€åŸŸå’Œè®°å½•<br>    awkæ‰§è¡Œæ—¶ï¼Œç”±åˆ†éš”ç¬¦åˆ†éš”çš„å­—æ®µï¼ˆåŸŸï¼‰æ ‡è®°$1,$2..$nç§°ä¸ºåŸŸæ ‡è¯†ã€‚$0ä¸ºæ‰€æœ‰åŸŸï¼Œæ³¨æ„ï¼šå’Œshellä¸­å˜é‡$ç¬¦å«ä¹‰ä¸åŒ<br>    æ–‡ä»¶çš„æ¯ä¸€è¡Œç§°ä¸ºè®°å½•<br>    çœç•¥actionè¡Œï¼Œåˆ™é»˜è®¤æ‰§è¡Œprint $0çš„æ“ä½œ</p><h3 id="awkå·¥ä½œåŸç†"><a href="#awkå·¥ä½œåŸç†" class="headerlink" title="awkå·¥ä½œåŸç†"></a>awkå·¥ä½œåŸç†</h3><p>ç¬¬ä¸€æ­¥ï¼šæ‰§è¡ŒBEGIN{action;â€¦ } è¯­å¥å—ä¸­çš„è¯­å¥<br>ç¬¬äºŒæ­¥ï¼šä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥(stdin)è¯»å–ä¸€è¡Œï¼Œç„¶åæ‰§è¡Œpattern{ action;<br>â€¦ } è¯­å¥å—ï¼Œå®ƒé€è¡Œæ‰«ææ–‡ä»¶ï¼Œä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°æ–‡ä»¶å…¨éƒ¨è¢«è¯»å–å®Œæ¯•ã€‚<br>    ç¬¬ä¸‰æ­¥ï¼šå½“è¯»è‡³è¾“å…¥æµæœ«å°¾æ—¶ï¼Œæ‰§è¡ŒEND{action;â€¦}è¯­å¥å—<br>        BEGINè¯­å¥å—åœ¨awkå¼€å§‹ä»è¾“å…¥æµä¸­è¯»å–è¡Œä¹‹å‰è¢«æ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„è¯­å¥å—ï¼Œæ¯”å¦‚å˜é‡åˆå§‹åŒ–ã€æ‰“å°è¾“å‡ºè¡¨æ ¼çš„è¡¨å¤´ç­‰è¯­å¥é€šå¸¸å¯ä»¥å†™åœ¨BEGINè¯­å¥å—ä¸­<br>        ENDè¯­å¥å—åœ¨awkä»è¾“å…¥æµä¸­è¯»å–å®Œæ‰€æœ‰çš„è¡Œä¹‹åå³è¢«æ‰§è¡Œï¼Œæ¯”å¦‚æ‰“å°æ‰€æœ‰è¡Œçš„åˆ†æç»“æœè¿™ç±»ä¿¡æ¯æ±‡æ€»éƒ½æ˜¯åœ¨ENDè¯­å¥å—ä¸­å®Œæˆï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¯é€‰è¯­å¥å—<br>        patternè¯­å¥å—ä¸­çš„é€šç”¨å‘½ä»¤æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯å¯é€‰çš„ã€‚å¦‚æœæ²¡æœ‰æä¾›patternè¯­å¥å—ï¼Œåˆ™é»˜è®¤æ‰§è¡Œ{ print }ï¼Œå³æ‰“å°æ¯ä¸€ä¸ªè¯»å–åˆ°çš„è¡Œï¼Œawkè¯»å–çš„æ¯ä¸€è¡Œéƒ½ä¼šæ‰§è¡Œè¯¥è¯­å¥å—</p><h3 id="awk-æ ¼å¼"><a href="#awk-æ ¼å¼" class="headerlink" title="awk æ ¼å¼"></a>awk æ ¼å¼</h3><p> è¦ç‚¹ï¼š<br>        (1)é€—å·åˆ†éš”ç¬¦<br>        (2)è¾“å‡ºçš„å„itemå¯ä»¥å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å€¼ï¼›å½“å‰è®°å½•çš„å­—æ®µã€å˜é‡æˆ–awkçš„è¡¨è¾¾å¼<br>        (3)å¦‚çœç•¥itemï¼Œç›¸å½“äºprint $0</p><p>ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123;print &quot;hello,awk&quot;&#125;&apos;</div><div class="line"># awk -F: &apos;&#123;print&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;print &quot;wang&quot;&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;print $1&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;print $0&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;print $1&quot;\t&quot;$3&#125;&apos; /etc/passwd</div><div class="line"># tail -3 /etc/fstab |awk  &apos;&#123;print $2,$4&#125;&apos;</div></pre></td></tr></table></figure><h3 id="awk-å˜é‡"><a href="#awk-å˜é‡" class="headerlink" title="awk å˜é‡"></a>awk å˜é‡</h3><ul><li>å˜é‡ï¼šå†…ç½®å’Œè‡ªå®šä¹‰å˜é‡</li></ul><table><thead><tr><th style="text-align:center">æ¨¡å¼</th><th style="text-align:center">ä¾‹å­</th><th style="text-align:center">åŒ¹é…</th></tr></thead><tbody><tr><td style="text-align:center">BEGIN</td><td style="text-align:center">BEGIN</td><td style="text-align:center">è¾“å…¥è¢«è¯»å–ä¹‹å‰</td></tr><tr><td style="text-align:center">END</td><td style="text-align:center">END</td><td style="text-align:center">æ‰€æœ‰è¾“å…¥è¢«è¯»å–ä¹‹å</td></tr><tr><td style="text-align:center">expression</td><td style="text-align:center">$3&gt;100</td><td style="text-align:center">ç¬¬ä¸‰ä¸ªå­—æ®µå¤§äº100</td></tr><tr><td style="text-align:center">string-matching</td><td style="text-align:center">/Asia/</td><td style="text-align:center">å«æœ‰Asiaçš„è¡Œ</td></tr><tr><td style="text-align:center">compound</td><td style="text-align:center">\$3&lt;100 &amp;&amp; $4 ==â€Asiaâ€</td><td style="text-align:center">ç¬¬ä¸‰ä¸ªå­—æ®µå°äº100ä¸”ç¬¬å››ä¸ªå­—æ®µå«æœ‰Asiaçš„è¡Œ</td></tr><tr><td style="text-align:center">range</td><td style="text-align:center">NR == 10,NR==20</td><td style="text-align:center">è¾“å…¥çš„ç¬¬10è¡Œåˆ°20è¡Œ</td></tr></tbody></table><table><thead><tr><th style="text-align:center">å˜é‡</th><th style="text-align:center">æ„ä¹‰</th><th style="text-align:center">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td style="text-align:center">FS</td><td style="text-align:center">æ§åˆ¶è¾“å…¥è¡Œçš„å­—æ®µåˆ†éš”ç¬¦</td><td style="text-align:center">â€œ â€œ</td></tr><tr><td style="text-align:center">OFS</td><td style="text-align:center">è¾“å‡ºå­—æ®µåˆ†éš”ç¬¦</td><td style="text-align:center">â€œ â€œ</td></tr><tr><td style="text-align:center">RS</td><td style="text-align:center">æ§åˆ¶ç€è¾“å…¥è¡Œçš„è®°å½•åˆ†éš”ç¬¦</td><td style="text-align:center">â€œ\nâ€</td></tr><tr><td style="text-align:center">NF</td><td style="text-align:center">å½“å‰è®°å½•çš„å­—æ®µä¸ªæ•°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">NR</td><td style="text-align:center">åˆ°ç›®å‰ä¸ºæ­¢è¯»çš„è®°å½•æ•°é‡</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">FNR</td><td style="text-align:center">å½“å‰è¾“å…¥æ–‡ä»¶çš„è®°å½•ä¸ªæ•°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">ARGC</td><td style="text-align:center">å‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">ARGV</td><td style="text-align:center">å‘½ä»¤è¡Œå‚æ•°æ•°ç»„</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">FILENAME</td><td style="text-align:center">å½“å‰è¾“å…¥æ–‡ä»¶å</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">OFMT</td><td style="text-align:center">æ•°å€¼çš„è¾“å‡ºæ ¼å¼</td><td style="text-align:center">â€œ%.6gâ€</td></tr><tr><td style="text-align:center">RLENGTE</td><td style="text-align:center">è¢«å‡½æ•°matchåŒ¹é…çš„å­—ç¬¦ä¸²çš„é•¿åº¦</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">RSTART</td><td style="text-align:center">è¢«å‡½æ•°matchåŒ¹é…çš„å­—ç¬¦ä¸²çš„å¼€å§‹</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">SUBSEP</td><td style="text-align:center">ä¸‹æ ‡åˆ†éš”ç¬¦</td><td style="text-align:center">â€œ\034â€</td></tr></tbody></table><p>FSï¼šè¾“å…¥å­—æ®µåˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºç™½å­—ç¬¦   </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># awk -v FS=&apos;:&apos; &apos;&#123;print $1,FS,$3&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;&#123;print $1,$3,$7&#125;&apos; /etc/passwd</div><div class="line"># s=:;awk -v FS=$s &apos;&#123;print $1 FS $3&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>OFSï¼šè¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºç©ºç™½å­—ç¬¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v FS=&apos;:&apos; -v OFS=&apos;:&apos; &apos;&#123;print $1,$3,$7&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>RSï¼šè¾“å…¥è®°å½•åˆ†éš”ç¬¦ï¼ŒæŒ‡å®šè¾“å…¥æ—¶çš„æ¢è¡Œç¬¦ï¼ŒåŸæ¢è¡Œç¬¦ä»æœ‰æ•ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#  awk -v RS=&apos; &apos; &apos;&#123;print &#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>ORSï¼šè¾“å‡ºè®°å½•åˆ†éš”ç¬¦ï¼Œè¾“å‡ºæ—¶ç”¨æŒ‡å®šç¬¦å·ä»£æ›¿æ¢è¡Œç¬¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -v RS=&apos; &apos; -v ORS=&apos;###&apos;â€˜&#123;print&#125;â€™ /etc/passwd</div></pre></td></tr></table></figure><p>NFï¼šå­—æ®µæ•°é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk -F:&apos;&#123;print NF&#125;&apos; /etc/fstab, å¼•ç”¨å†…ç½®å˜é‡ä¸ç”¨$</div><div class="line"># awk -F: &apos;&#123;print $(NF-1)&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>NRï¼šè¡Œå·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123;print NR&#125;&apos; /etc/fstab; awk END&apos;&#123;print NR&#125;&apos; /etc/fstab</div></pre></td></tr></table></figure><p>FNRï¼šå„æ–‡ä»¶åˆ†åˆ«è®¡æ•°, è¡Œå·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123;print FNR&#125;&apos; /etc/fstab /etc/inittab</div></pre></td></tr></table></figure><p>FILENAMEï¼šå½“å‰æ–‡ä»¶å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123;print FILENAME&#125;&apos; /etc/fstab</div></pre></td></tr></table></figure><p>ARGCï¼šå‘½ä»¤è¡Œå‚æ•°çš„ä¸ªæ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk &apos;&#123;print ARGC&#125;&apos; /etc/fstab /etc/inittab</div><div class="line"># awk &apos;BEGIN &#123;print ARGC&#125;&apos; /etc/fstab /etc/inittab</div></pre></td></tr></table></figure><p>ARGVï¼šæ•°ç»„ï¼Œä¿å­˜çš„æ˜¯å‘½ä»¤è¡Œæ‰€ç»™å®šçš„å„å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk &apos;BEGIN &#123;print ARGV[0]&#125;&apos; /etc/fstab /etc/inittab</div><div class="line"># awk &apos;BEGIN &#123;print ARGV[1]&#125;&apos; /etc/fstab /etc/inittab</div></pre></td></tr></table></figure><p>è‡ªå®šä¹‰å˜é‡(åŒºåˆ†å­—ç¬¦å¤§å°å†™)<br>        (1) -v var=value<br>        (2) åœ¨programä¸­ç›´æ¥å®šä¹‰</p><p>ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># awk -v test=&apos;hello gawk&apos; &apos;&#123;print test&#125;&apos; /etc/fstab</div><div class="line"># awk -v test=&apos;hello gawk&apos; &apos;BEGIN&#123;print test&#125;&apos;</div><div class="line"># awk &apos;BEGIN&#123;test=&quot;hello,gawk&quot;;print test&#125;&apos;</div><div class="line"># awk -F:â€˜&#123;sex=â€œmaleâ€;print $1,sex,age;age=18&#125;â€™ /etc/passwd</div><div class="line"># cat awkscript </div><div class="line">      &#123;print script,$1,$2&#125;</div><div class="line">        awk -F: -f awkscript script=â€œawkâ€ /etc/passwd</div></pre></td></tr></table></figure><h3 id="printf-å‚æ•°"><a href="#printf-å‚æ•°" class="headerlink" title="printf å‚æ•°"></a>printf å‚æ•°</h3><ul><li><p>æ ¼å¼åŒ–è¾“å‡ºï¼šprintf â€œFORMATâ€, item1, item2, â€¦<br>  (1)å¿…é¡»æŒ‡å®šFORMAT<br>  (2)ä¸ä¼šè‡ªåŠ¨æ¢è¡Œï¼Œéœ€è¦æ˜¾å¼ç»™å‡ºæ¢è¡Œæ§åˆ¶ç¬¦ï¼Œ\n<br>  (3)FORMATä¸­éœ€è¦åˆ†åˆ«ä¸ºåé¢æ¯ä¸ªitemæŒ‡å®šæ ¼å¼ç¬¦</p></li><li><p>æ ¼å¼ç¬¦ï¼šä¸itemä¸€ä¸€å¯¹åº”</p></li></ul><table><thead><tr><th style="text-align:left">æ ¼å¼ç¬¦</th><th style="text-align:left">æ„ä¹‰</th></tr></thead><tbody><tr><td style="text-align:left">%c</td><td style="text-align:left">æ˜¾ç¤ºå­—ç¬¦çš„ASCIIç </td></tr><tr><td style="text-align:left">%d,%i</td><td style="text-align:left">æ˜¾ç¤ºåè¿›åˆ¶æ•´æ•°</td></tr><tr><td style="text-align:left">%e,%E</td><td style="text-align:left">æ˜¾ç¤ºç§‘å­¦è®¡æ•°æ³•æ•°å€¼</td></tr><tr><td style="text-align:left">%f</td><td style="text-align:left">æ˜¾ç¤ºä¸ºæµ®ç‚¹æ•°</td></tr><tr><td style="text-align:left">%g,%G</td><td style="text-align:left">ä»¥ç§‘å­¦è®¡æ•°æ³•æˆ–æµ®ç‚¹å½¢å¼æ˜¾ç¤ºæ•°å€¼</td></tr><tr><td style="text-align:left">%s</td><td style="text-align:left">æ˜¾ç¤ºå­—ç¬¦ä¸²</td></tr><tr><td style="text-align:left">%u</td><td style="text-align:left">æ— ç¬¦å·æ•´æ•°</td></tr><tr><td style="text-align:left">%%</td><td style="text-align:left">æ˜¾ç¤º%è‡ªèº«</td></tr></tbody></table><h3 id="ä¿®é¥°ç¬¦ï¼š"><a href="#ä¿®é¥°ç¬¦ï¼š" class="headerlink" title="ä¿®é¥°ç¬¦ï¼š"></a>ä¿®é¥°ç¬¦ï¼š</h3><p>[.#]ï¼šç¬¬ä¸€ä¸ªæ•°å­—æ§åˆ¶æ˜¾ç¤ºçš„å®½åº¦ï¼›ç¬¬äºŒä¸ª#è¡¨ç¤ºå°æ•°ç‚¹åç²¾åº¦ï¼Œ%3.1f<br>-: å·¦å¯¹é½ï¼ˆé»˜è®¤å³å¯¹é½ï¼‰ %-15s<br>+ï¼šæ˜¾ç¤ºæ•°å€¼çš„æ­£è´Ÿç¬¦å· %+d</p><h3 id="printfç¤ºä¾‹"><a href="#printfç¤ºä¾‹" class="headerlink" title="printfç¤ºä¾‹"></a>printfç¤ºä¾‹</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># awk -F: '&#123;printf "%s",$1&#125;' /etc/passwd</span></div><div class="line"><span class="comment"># awk -F: '&#123;printf "%s\n",$1&#125;' /etc/passwd</span></div><div class="line"><span class="comment"># awk -F: '&#123;printf "%-20s %10d\n",$1,$3&#125;' /etc/passwd</span></div><div class="line"><span class="comment"># awk -F: '&#123;printf "Username: %s\n",$1&#125;' /etc/passwd</span></div><div class="line"><span class="comment"># awk -F: '&#123;printf â€œUsername: %s,UID:%d\n",$1,$3&#125;â€™ /etc/passwd</span></div><div class="line"><span class="comment"># awk -F: '&#123;printf "Username: %15s,UID:%d\n",$1,$3&#125;' /etc/passwd</span></div><div class="line"><span class="comment"># awk -F: '&#123;printf "Username: %-15s,UID:%d\n",$1,$3&#125;' /etc/passwd</span></div></pre></td></tr></table></figure><h3 id="æ“ä½œç¬¦è¡¨è¾¾å¼"><a href="#æ“ä½œç¬¦è¡¨è¾¾å¼" class="headerlink" title="æ“ä½œç¬¦è¡¨è¾¾å¼"></a>æ“ä½œç¬¦è¡¨è¾¾å¼</h3><ol><li>åˆç­‰è¡¨è¾¾å¼åŒ…æ‹¬<br> æ•°å€¼ä¸å­—ç¬¦ä¸²å¸¸é‡, å˜é‡, å­—æ®µ, å‡½æ•°è°ƒç”¨, æ•°ç»„å…ƒç´ .</li><li>å¯ä»¥æŠŠè¡¨è¾¾å¼ç»„åˆèµ·æ¥çš„è¿ç®—ç¬¦åŒ…æ‹¬<br> èµ‹å€¼è¿ç®—ç¬¦ = += -= <em>= /= %= ^= æ¡ä»¶è¡¨è¾¾å¼ ?:<br> é€»è¾‘è¿ç®—ç¬¦ || (OR), &amp;&amp; (AND), ! (NOT)<br> åŒ¹é…è¿ç®—ç¬¦ ~ å’Œ!~<br> å…³ç³»è¿ç®—ç¬¦ &lt; &lt;= == != &gt; &gt;=<br> æ‹¼æ¥è¿ç®—ç¬¦ (æ²¡æœ‰æ˜¾å¼çš„æ‹¼æ¥è¿ç®—ç¬¦)<br> ç®—æœ¯è¿ç®—ç¬¦ + - </em> / % ^<br> å•ç›®è¿ç®—ç¬¦ +å’Œ-<br> è‡ªå¢ä¸è‡ªå‡è¿ç®—ç¬¦++å’Œâ€“(åŒ…æ‹¬å‰ç¼€ä¸åç¼€)<br>æ‹¬å· (ç”¨äºåˆ†ç»„)  </li></ol><table><thead><tr><th style="text-align:center">æ“ä½œ</th><th style="text-align:center">è¿ç®—ç¬¦</th><th style="text-align:center">ä¾‹å­</th><th style="text-align:center">ä¾‹å­çš„å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center">èµ‹å€¼</td><td style="text-align:center">= += -= *= /= %= ^=</td><td style="text-align:center">x *= 2</td><td style="text-align:center">x = x * 2</td></tr><tr><td style="text-align:center">æ¡ä»¶è¡¨è¾¾å¼</td><td style="text-align:center">?:</td><td style="text-align:center">x ? y : z</td><td style="text-align:center">è‹¥xä¸ºçœŸ,åˆ™ y,å¦åˆ™z</td></tr><tr><td style="text-align:center">é€»è¾‘ä¸</td><td style="text-align:center">&amp;&amp;</td><td style="text-align:center">x &amp;&amp; y</td><td style="text-align:center">è‹¥xä¸yéƒ½ä¸ºçœŸ, åˆ™ä¸º1,å¦åˆ™ä¸º0</td></tr><tr><td style="text-align:center">æ•°ç»„æˆå‘˜</td><td style="text-align:center">in</td><td style="text-align:center">i in a</td><td style="text-align:center">å¦‚æœa[i]å­˜åœ¨, åˆ™ä¸º1,å¦åˆ™ä¸º0</td></tr><tr><td style="text-align:center">åŒ¹é…</td><td style="text-align:center">~ !~</td><td style="text-align:center">$1 ~ /x/</td><td style="text-align:center">å¦‚æœç¬¬ä¸€ä¸ªå­—æ®µåŒ…å«x,åˆ™ä¸º1,å¦åˆ™ä¸º0</td></tr><tr><td style="text-align:center">å…³ç³»è¿ç®—</td><td style="text-align:center">&lt; &lt;= == != &gt;= &gt;</td><td style="text-align:center">x == y</td><td style="text-align:center">å¦‚æœxç­‰äºy,åˆ™ä¸º1, å¦åˆ™ä¸º0</td></tr><tr><td style="text-align:center"></td></tr><tr><td style="text-align:center">æ‹¼æ¥</td><td style="text-align:center">â€œaâ€ â€œbcâ€</td><td style="text-align:center">â€œabcâ€</td><td style="text-align:center">ä¸å­˜åœ¨æ˜¾å¼çš„æ‹¼æ¥è¿ç®—ç¬¦</td></tr><tr><td style="text-align:center">å‡æ³•, åŠ æ³•</td><td style="text-align:center">+ -</td><td style="text-align:center">x + y</td><td style="text-align:center">xä¸yçš„å’Œ</td></tr><tr><td style="text-align:center"></td></tr><tr><td style="text-align:center">ä¹˜æ³•, é™¤æ³•, å–æ¨¡</td><td style="text-align:center">* / %</td><td style="text-align:center">x % y</td><td style="text-align:center">xé™¤ä»¥yçš„ä½™æ•°</td></tr><tr><td style="text-align:center">å•ç›®åŠ , å•ç›®å‡</td><td style="text-align:center">+ -</td><td style="text-align:center">-x</td><td style="text-align:center">xçš„ç›¸åæ•°</td></tr><tr><td style="text-align:center">é€»è¾‘é</td><td style="text-align:center">!</td><td style="text-align:center">!$1</td><td style="text-align:center">è‹¥$1ä¸ºç©ºæˆ–ä¸º0, åˆ™ä¸º1,å¦åˆ™ä¸º0</td></tr><tr><td style="text-align:center">æŒ‡æ•°è¿ç®—</td><td style="text-align:center">^</td><td style="text-align:center">x ^ y</td><td style="text-align:center">xçš„yæ¬¡æ–¹</td></tr><tr><td style="text-align:center">è‡ªå¢, è‡ªå‡</td><td style="text-align:center">++ â€“</td><td style="text-align:center">++x, x++</td><td style="text-align:center">ä¸ºxåŠ 1</td></tr><tr><td style="text-align:center">å­—æ®µ</td><td style="text-align:center">$</td><td style="text-align:center">$i+1</td><td style="text-align:center">1åŠ ä¸Šç¬¬iä¸ªå­—æ®µçš„å€¼</td></tr><tr><td style="text-align:center">ç»„</td><td style="text-align:center">( )</td><td style="text-align:center">($i)++</td><td style="text-align:center">ç»™ç¬¬iä¸ªå­—æ®µçš„å€¼åŠ 1</td></tr></tbody></table><p>ç®—æœ¯æ“ä½œç¬¦ï¼š<br>    x+y, x-y, x*y, x/y, x^y, x%y<br>    -x:è½¬æ¢ä¸ºè´Ÿæ•°<br>    +x:è½¬æ¢ä¸ºæ•°å€¼</p><p>å­—ç¬¦ä¸²æ“ä½œç¬¦ï¼šæ²¡æœ‰ç¬¦å·çš„æ“ä½œç¬¦ï¼Œå­—ç¬¦ä¸²è¿æ¥</p><p>èµ‹å€¼æ“ä½œç¬¦ï¼š<br>    =, +=, -=, *=, /=, %=, ^=<br>    ++, â€“</p><p>æ¯”è¾ƒæ“ä½œç¬¦ï¼š<br>    ==, !=, &gt;, &gt;=, &lt;, &lt;=</p><p>æ¨¡å¼åŒ¹é…ç¬¦<br>    ~ï¼šå·¦è¾¹æ˜¯å¦å’Œå³è¾¹åŒ¹é…åŒ…å«<br>    !~ ï¼šæ˜¯å¦ä¸åŒ¹é…</p><p>  ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># awk â€“F: &apos;$0 ~ /root/&#123;print $1&#125;â€˜ /etc/passwd</div><div class="line"># awk &apos;$0~&quot;^root&quot;&apos; /etc/passwd</div><div class="line"># awk &apos;$0 !~ /root/&apos; /etc/passwd</div><div class="line"># awk -F: &apos;$3==0&apos; /etc/passwd</div></pre></td></tr></table></figure><p>é€»è¾‘æ“ä½œç¬¦ï¼š<br>    &amp;&amp; ä¸<br>    || æˆ–<br>    ï¼ é</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;$3&gt;=0 &amp;&amp; $3&lt;=1000 &#123;print $1&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;$3==0 || $3&gt;=1000 &#123;print $1&#125;&apos; /etc/passwd</div><div class="line"># awk -F: â€˜!($3==0) &#123;print $1&#125;&apos; /etc/passwd</div><div class="line"># awk -F: â€˜!($3&gt;=500) &#123;print $3&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;$3 &gt; 100 &amp;&amp; $3&lt;1000 &#123;print $1,$3&#125;&apos; passwd</div></pre></td></tr></table></figure><h3 id="å‡½æ•°è°ƒç”¨"><a href="#å‡½æ•°è°ƒç”¨" class="headerlink" title="å‡½æ•°è°ƒç”¨"></a>å‡½æ•°è°ƒç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">function_name(argu1, argu2, ...)</div><div class="line">æ¡ä»¶è¡¨è¾¾å¼ï¼ˆä¸‰ç›®è¡¨è¾¾å¼ï¼‰   </div><div class="line">    selector?if-true-expression:if-false-expression</div></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">awk -F: &apos;&#123;$3&gt;=1000?usertype=&quot;Common User&quot;:usertype=&quot;Sysadmin or SysUser&quot;;printf &quot;%15s:%-s\n&quot;,$1,usertype&#125;&apos; /etc/passwd</div><div class="line">awk -F: &apos;&#123;$3&gt;1000?username=&quot;common user:&quot;:username=&quot;sysuser:&quot;;</div><div class="line">printf &quot;%s %-30s %d\n&quot;,username,$1,$3&#125;&apos; passwd</div></pre></td></tr></table></figure><p>æ­£åˆ™è¡¨è¾¾å¼</p><ol><li>æ­£åˆ™è¡¨è¾¾å¼çš„å…ƒå­—ç¬¦åŒ…æ‹¬ï¼š<br> <code>\ ^ $ . [] | ()  * + ?</code></li><li>ä¸€ä¸ªåŸºæœ¬çš„æ­£åˆ™è¡¨è¾¾å¼åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š<br> ä¸€ä¸ªä¸æ˜¯å…ƒå­—ç¬¦çš„å­—ç¬¦ï¼Œä¾‹å¦‚Aï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å°±æ˜¯å®ƒæœ¬èº«ï¼›<br> ä¸€ä¸ªåŒ¹é…ç‰¹æ®Šå­—ç¬¦çš„è½¬ä¹‰å­—ç¬¦ï¼š\tåŒ¹é…ä¸€ä¸ªåˆ¶è¡¨ç¬¦<br> ä¸€ä¸ªè¢«å¼•ç”¨çš„å…ƒå­—ç¬¦ï¼Œä¾‹å¦‚*ï¼ŒæŒ‰å­—é¢æ„ä¹‰åŒ¹é…å…ƒå­—ç¬¦<br> ^ åŒ¹é…ä¸€è¡Œçš„å¼€å§‹<br> $ åŒ¹é…ä¸€è¡Œçš„ç»“æŸ<br> . åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦<br> ä¸€ä¸ªå­—ç¬¦ç±»:[ABC]åŒ¹é…å­—ç¬¦Aã€Bæˆ–C<br> å­—ç¬¦ç±»å¯èƒ½åŒ…èƒ½åŒ…å«ç¼©å†™æ ¼å¼ï¼š[A-Za-z]åŒ¹é…å•ä¸ªå­—æ¯<br> ä¸€ä¸ªäº’è¡¥çš„å­—ç¬¦ç±»:[^0-9] åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦ï¼Œä½†é™¤äº†æ•°å­—</li><li><p>è¿ç®—ç¬¦ç»„åˆèµ·æ¥ä½¿ç”¨<br> é€‰æ‹©ï¼šA|B åŒ¹é…Aæˆ–B<br> æ‹¼æ¥ï¼šABåŒ¹é…åé¢ç´§è·Ÿç€Bçš„A<br> é—­åŒ…ï¼šA*åŒ¹é…0ä¸ªæˆ–å¤šä¸ªA<br> æ­£å¿…åŒ…ï¼šA+åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªA<br> é›¶æˆ–ä¸€ï¼šAï¼ŸåŒ¹é…ç©ºå­—ç¬¦ä¸²æˆ–A<br> æ‹¬å·ï¼šè¢«(r)åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œä¸ræ‰€åŒ¹é…çš„å­—ç¬¦ä¸²ç›¸åŒ</p></li><li><p>ä¼˜å…ˆçº§<br> é€‰æ‹©è¿ç®—ç¬¦|ä¼˜å…ˆçº§æœ€ä½ï¼Œç„¶åæ˜¯æ‹¼æ¥è¿ç®—ï¼Œæœ€åæ˜¯é‡å¤è¿ç®—+ï¼Œ*ä¸ï¼Ÿï¼›</p></li><li>è½¬ä¹‰åºåˆ—    </li></ol><table><thead><tr><th style="text-align:center">åºåˆ—</th><th style="text-align:center">æ„ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center">\b</td><td style="text-align:center">é€€æ ¼</td></tr><tr><td style="text-align:center">\f</td><td style="text-align:center">æ¢é¡µ</td></tr><tr><td style="text-align:center">\n</td><td style="text-align:center">æ¢è¡Œ</td></tr><tr><td style="text-align:center">\r</td><td style="text-align:center">å›è½¦</td></tr><tr><td style="text-align:center">\t</td><td style="text-align:center">åˆ¶è¡¨ç¬¦</td></tr><tr><td style="text-align:center">\ddd</td><td style="text-align:center">å…«è¿›åˆ¶æ•°ddd.dddå«æœ‰1åˆ°3ä¸ªæ•°å­—ï¼Œæ¯ä¸ªæ•°å­—çš„å€¼åœ¨0-7ä¹‹é—´</td></tr><tr><td style="text-align:center">\c</td><td style="text-align:center">å…¶ä»–å­—é¢æ„ä¹‰ä¸Šçš„cï¼ˆå¦‚\è¡¨ç¤º,â€è¡¨ç¤ºåŒå¼•å·ï¼‰</td></tr></tbody></table><p>###ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">^[^^] åŒ¹é…ä¸ä»¥è„±å­—ç¬¦å¼€å§‹çš„å­—ç¬¦ä¸²</div><div class="line">/^[0-9]+$/ åŒ¹é…å«æœ‰ä¸”åªå«æœ‰æ•°å­—çš„è¾“å…¥è¡Œ</div><div class="line">/^[0-9][0-9][0-9]$/ è¾“å…¥è¡Œæœ‰ä¸”ä»…æœ‰ 3 ä¸ªæ•°å­—.</div><div class="line">/^(\+|-)?[0-9]+\.?[0-9]*$/ åè¿›åˆ¶å°æ•°, ç¬¦å·ä¸å°æ•°éƒ¨åˆ†æ˜¯å¯é€‰çš„.</div><div class="line">/^[+-]?[0-9]+[.]?[0-9]*$/ ä¹Ÿæ˜¯åŒ¹é…åè¿›åˆ¶å°æ•°, å¸¦æœ‰å¯é€‰çš„ç¬¦å·ä¸å°æ•°éƒ¨åˆ†.</div><div class="line">/^[+-]?([0-9]+[.]?[0-9]*|[.][0-9]+)([eE][+-]?[0-9]+)?$/ æµ®ç‚¹æ•°, ç¬¦å·ä¸æŒ‡æ•°éƒ¨åˆ†æ˜¯å¯é€‰çš„.</div><div class="line">/^[A-Za-z][A-Za-z0-9]*$/ ä¸€ä¸ªå­—æ¯, åé¢å†è·Ÿç€ä»»æ„å¤šä¸ªå­—æ¯æˆ–æ•°å­— (æ¯”å¦‚awkçš„å˜é‡å).</div><div class="line">/^[A-Za-z]$|^[A-Za-z][0-9]$/ ä¸€ä¸ªå­—æ¯, åˆæˆ–è€…æ˜¯ä¸€ä¸ªåé¢è·Ÿç€ä¸€ä¸ªæ•°å­—çš„å­—æ¯ (æ¯”å¦‚ Basic çš„å˜é‡å).</div><div class="line">/^[A-Za-z][0-9]?$/ åŒæ ·æ˜¯ä¸€ä¸ªå­—æ¯, åˆæˆ–è€…æ˜¯ä¸€ä¸ªåé¢è·Ÿç€ä¸€ä¸ªæ•°å­—çš„å­—æ¯</div></pre></td></tr></table></figure><h3 id="awk-PATTERN"><a href="#awk-PATTERN" class="headerlink" title="awk PATTERN"></a>awk PATTERN</h3><ul><li>PATTERN: æ ¹æ®patternæ¡ä»¶ï¼Œè¿‡æ»¤åŒ¹é…çš„è¡Œï¼Œå†åšå¤„ç†<br>  (1) å¦‚æœæœªæŒ‡å®šï¼šç©ºæ¨¡å¼ï¼ŒåŒ¹é…æ¯ä¸€è¡Œ<br>  (2) /regular expression/ ï¼šä»…å¤„ç†èƒ½å¤Ÿæ¨¡å¼åŒ¹é…åˆ°çš„è¡Œï¼Œéœ€è¦ç”¨/ / æ‹¬èµ·æ¥<pre><code>awk &apos;/^UUID/{print $1}&apos; /etc/fstabawk &apos;!/^UUID/{print $1}&apos; /etc/fstab</code></pre>  (3) relational expression: å…³ç³»è¡¨è¾¾å¼ï¼Œç»“æœä¸ºâ€œçœŸâ€æ‰ä¼šè¢«å¤„ç†<pre><code>çœŸï¼šç»“æœä¸ºé0å€¼ï¼Œéç©ºå­—ç¬¦ä¸²å‡ï¼šç»“æœä¸ºç©ºå­—ç¬¦ä¸²æˆ–0å€¼</code></pre></li></ul><p>ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;i=1;j=1&#123;print i,j&#125;&apos; /etc/passwd</div><div class="line"># awk â€˜!0â€™ /etc/passwd ; awk â€˜!1â€™ /etc/passwd</div><div class="line"># awk â€“F: &apos;$3&gt;=1000&#123;print $1,$3&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;$3&lt;1000&#123;print $1,$3&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;$NF==&quot;/bin/bash&quot;&#123;print $1,$NF&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;$NF ~ /bash$/&#123;print $1,$NF&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>(4) line rangesï¼šè¡ŒèŒƒå›´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">startline,endline</div><div class="line">        /pat1/,/pat2/</div><div class="line"># awk -F: &apos;/^root\&gt;/,/^nobody\&gt;/&#123;print $1&#125;&apos; /etc/passwd</div><div class="line">æ³¨æ„ï¼šä¸æ”¯æŒç›´æ¥ç»™å‡ºæ•°å­—æ ¼å¼</div><div class="line"># awk -F: &apos;(NR&gt;=10&amp;&amp;NR&lt;=20)&#123;print NR,$1&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><p>(5) BEGIN/END æ¨¡å¼<br>        BEGIN{}:     ä»…åœ¨å¼€å§‹å¤„ç†æ–‡ä»¶ä¸­çš„æ–‡æœ¬ä¹‹å‰æ‰§è¡Œä¸€æ¬¡<br>        END{}ï¼š    ä»…åœ¨æ–‡æœ¬å¤„ç†å®Œæˆä¹‹åæ‰§è¡Œä¸€æ¬¡</p><p>ç¤ºä¾‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># awk -F : &apos;BEGIN &#123;print &quot;USER USERID&quot;&#125; &#123;print $1&quot;:&quot;$3&#125; END&#123;print &quot;end file&quot;&#125;&apos; /etc/passwd</div><div class="line"># awk -F : &apos;&#123;print &quot;USER USERIDâ€œ;print $1&quot;:&quot;$3&#125; END&#123;print &quot;end file&quot;&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;BEGIN&#123;print &quot; USER UID \n--------------- &quot;&#125;&#123;print $1,$3&#125;&apos; /etc/passwd</div><div class="line"># awk -F: &apos;BEGIN&#123;print &quot; USER UID \n--------------- &quot;&#125;&#123;print $1,$3&#125;&apos;END&#123;print &quot;==============&quot;&#125; /etc/passwd </div><div class="line">#  seq 10 |awk â€˜i=0â€™</div><div class="line"># seq 10 |awk â€˜i=1â€™</div><div class="line"># seq 10 | awk &apos;i=!iâ€˜</div><div class="line"># seq 10 | awk &apos;&#123;i=!i;print i&#125;â€˜</div><div class="line"># seq 10 | awk â€˜!(i=!i)â€™</div><div class="line"># seq 10 |awk -v i=1 &apos;i=!i&apos;</div></pre></td></tr></table></figure><h3 id="æ¨¡å¼æ€»ç»“"><a href="#æ¨¡å¼æ€»ç»“" class="headerlink" title="æ¨¡å¼æ€»ç»“"></a>æ¨¡å¼æ€»ç»“</h3><table><thead><tr><th style="text-align:center">æ¨¡å¼</th><th style="text-align:center">ä¾‹å­</th><th style="text-align:center">åŒ¹é…</th></tr></thead><tbody><tr><td style="text-align:center">BEGIN</td><td style="text-align:center">BEGIN</td><td style="text-align:center">è¾“å…¥è¢«è¯»å–ä¹‹å‰</td></tr><tr><td style="text-align:center">END</td><td style="text-align:center">END</td><td style="text-align:center">æ‰€æœ‰è¾“å…¥è¢«è¯»å–ä¹‹å</td></tr><tr><td style="text-align:center">expression</td><td style="text-align:center">$3&gt;100</td><td style="text-align:center">ç¬¬ä¸‰ä¸ªå­—æ®µå¤§äº100</td></tr><tr><td style="text-align:center">string-matching</td><td style="text-align:center">/Asia/</td><td style="text-align:center">å«æœ‰Asiaçš„è¡Œ</td></tr><tr><td style="text-align:center">compound</td><td style="text-align:center">$3&lt;100 &amp;&amp; $4 ==â€Asiaâ€</td><td style="text-align:center">ç¬¬ä¸‰ä¸ªå­—æ®µå°äº100ä¸”ç¬¬å››ä¸ªå­—æ®µå«æœ‰Asiaçš„è¡Œ</td></tr><tr><td style="text-align:center">range</td><td style="text-align:center">NR == 10,NR==20</td><td style="text-align:center">è¾“å…¥çš„ç¬¬10è¡Œåˆ°20è¡Œ</td></tr></tbody></table><h3 id="awk-action"><a href="#awk-action" class="headerlink" title="awk action"></a>awk action</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">å¸¸ç”¨çš„actionåˆ†ç±»</div><div class="line">    (1) Expressions: ç®—æœ¯ï¼Œæ¯”è¾ƒè¡¨è¾¾å¼ç­‰</div><div class="line">    (2) Control statementsï¼šif,whileç­‰</div><div class="line">    (3) Compound statementsï¼šç»„åˆè¯­å¥</div><div class="line">    (4) input statements</div><div class="line">    (5) output statementsï¼šprintç­‰</div></pre></td></tr></table></figure><h3 id="awkæ§åˆ¶è¯­å¥"><a href="#awkæ§åˆ¶è¯­å¥" class="headerlink" title="awkæ§åˆ¶è¯­å¥"></a>awkæ§åˆ¶è¯­å¥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123; statements;â€¦ &#125;  ç»„åˆè¯­å¥</div><div class="line">    if(condition) &#123;statements;â€¦&#125;</div><div class="line">    if(condition) &#123;statements;â€¦&#125; else &#123;statements;â€¦&#125;</div><div class="line">    while(conditon) &#123;statments;â€¦&#125;</div><div class="line">    do &#123;statements;â€¦&#125; while(condition)</div><div class="line">    for(expr1;expr2;expr3) &#123;statements;â€¦&#125;</div><div class="line">    break</div><div class="line">    continue</div><div class="line">    next å¼€å§‹è¾“å…¥ä¸»å¾ªç¯çš„ä¸‹ä¸€æ¬¡è¿­ä»£</div><div class="line">    delete array[index]</div><div class="line">    delete array</div><div class="line">        exit</div><div class="line">    exit expression é©¬ä¸Šæ‰§è¡ŒEND åŠ¨ä½œ; å¦‚æœå·²ç»åœ¨ENDåŠ¨ä½œå†…, é‚£å°±é€€å‡ºç¨‹åº. å°†expressionä½œä¸ºç¨‹åºçš„é€€å‡ºçŠ¶æ€è¿”å›.</div></pre></td></tr></table></figure><h3 id="if-else"><a href="#if-else" class="headerlink" title="if-else"></a>if-else</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">è¯­æ³•ï¼š</div><div class="line">       if(condition)&#123;statement;â€¦&#125;[else statement]</div><div class="line">       if(condition1)&#123;statement1&#125;else if(condition2)&#123;statement2&#125;</div><div class="line">           else&#123;statement3&#125;</div><div class="line">   ä½¿ç”¨åœºæ™¯ï¼šå¯¹awkå–å¾—çš„æ•´è¡Œæˆ–æŸä¸ªå­—æ®µåšæ¡ä»¶åˆ¤æ–­</div><div class="line">   ç¤ºä¾‹ï¼š</div><div class="line">   # awk -F: &apos;&#123;if($3&gt;=1000)print $1,$3&#125;&apos; /etc/passwd</div><div class="line">   # awk -F: &apos;&#123;if($NF==&quot;/bin/bash&quot;) print $1&#125;&apos; /etc/passwd</div><div class="line">   # awk &apos;&#123;if(NF&gt;5) print $0&#125;&apos; /etc/fstab</div><div class="line">   # awk -F: &apos;&#123;if($3&gt;=1000) &#123;printf &quot;Common user: %s\n&quot;,$1&#125; else &#123;printf &quot;root or Sysuser: %s\n&quot;,$1&#125;&#125;&apos; /etc/passwd</div><div class="line">   # awk -F: &apos;&#123;if($3&gt;=1000) printf &quot;Common user: %s\n&quot;,$1;</div><div class="line">           else printf &quot;root or Sysuser: %s\n&quot;,$1&#125;&apos; /etc/passwd</div><div class="line">       df -h|awk -F% &apos;/^\/dev/&#123;print $1&#125;&apos;|awk &apos;$NF&gt;=80&#123;print $1,$5&#125;â€˜</div><div class="line">   # awk &apos;BEGIN&#123; test=100;if(test&gt;90)&#123;print &quot;very good&quot;&#125;</div><div class="line">           else if(test&gt;60)&#123; print &quot;good&quot;&#125;else&#123;print &quot;no pass&quot;&#125;&#125;&apos;</div></pre></td></tr></table></figure><h3 id="whileå¾ªç¯"><a href="#whileå¾ªç¯" class="headerlink" title="whileå¾ªç¯"></a>whileå¾ªç¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">è¯­æ³•ï¼š</div><div class="line">        while(condition)&#123;statement;â€¦&#125;</div><div class="line">    æ¡ä»¶â€œçœŸâ€ï¼Œè¿›å…¥å¾ªç¯ï¼›æ¡ä»¶â€œå‡â€ï¼Œ é€€å‡ºå¾ªç¯</div><div class="line">    ä½¿ç”¨åœºæ™¯ï¼š</div><div class="line">        å¯¹ä¸€è¡Œå†…çš„å¤šä¸ªå­—æ®µé€ä¸€ç±»ä¼¼å¤„ç†æ—¶ä½¿ç”¨</div><div class="line">        å¯¹æ•°ç»„ä¸­çš„å„å…ƒç´ é€ä¸€å¤„ç†æ—¶ä½¿ç”¨</div><div class="line">    ç¤ºä¾‹ï¼š</div><div class="line">        awk &apos;/^[[:space:]]*linux16/&#123;i=1;while(i&lt;=NF) &#123;print $i,length($i); i++&#125;&#125;&apos; /etc/grub2.cfg</div></pre></td></tr></table></figure><h3 id="do-whileå¾ªç¯"><a href="#do-whileå¾ªç¯" class="headerlink" title="do-whileå¾ªç¯"></a>do-whileå¾ªç¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">è¯­æ³•ï¼š</div><div class="line">        do &#123;statement;â€¦&#125;while(condition)</div><div class="line">        æ„ä¹‰ï¼šæ— è®ºçœŸå‡ï¼Œè‡³å°‘æ‰§è¡Œä¸€æ¬¡å¾ªç¯ä½“</div><div class="line">    ç¤ºä¾‹ï¼š</div><div class="line">    # awk &apos;BEGIN&#123; total=0;i=0;do&#123; total+=i;i++;&#125;while(i&lt;=100);print total&#125;&apos;</div><div class="line">    æ€è€ƒï¼šä¸‹é¢ä¸¤è¯­å¥æœ‰ä½•ä¸åŒï¼Ÿ</div><div class="line">    # awk &apos;BEGIN&#123;i=0;print ++i,i&#125;&apos;</div><div class="line">   # awk &apos;BEGIN&#123;i=0;print i++,i&#125;&apos;</div></pre></td></tr></table></figure><h3 id="forå¾ªç¯"><a href="#forå¾ªç¯" class="headerlink" title="forå¾ªç¯"></a>forå¾ªç¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">è¯­æ³•ï¼š</div><div class="line">        for(expr1;expr2;expr3) &#123;statement;â€¦&#125;</div><div class="line">    å¸¸è§ç”¨æ³•ï¼š</div><div class="line">        for(variable assignment;condition;iteration process) </div><div class="line">            &#123;for-body&#125;</div><div class="line">    ç‰¹æ®Šç”¨æ³•ï¼šèƒ½å¤Ÿéå†æ•°ç»„ä¸­çš„å…ƒç´ </div><div class="line">        è¯­æ³•ï¼šfor(var in array) &#123;for-body&#125;</div><div class="line">    ç¤ºä¾‹ï¼š</div><div class="line">        awk &apos;/^[[:space:]]*linux16/&#123;for(i=1;i&lt;=NF;i++) &#123;print $i,length($i)&#125;&#125;&apos; /etc/grub2.cfg</div><div class="line">ç©ºè¯­å¥     </div><div class="line">å•ç‹¬ä¸€ä¸ªåˆ†å·è¡¨ç¤ºä¸€ä¸ªç©ºè¯­å¥</div><div class="line">  </div><div class="line">    åœ¨ä¸‹é¢è¿™ä¸ªç¨‹åºé‡Œ, forçš„å¾ªç¯ä½“æ˜¯ä¸€ä¸ªç©ºè¯­å¥.</div><div class="line">        BEGIN &#123; FS = &quot;\t&quot; &#125;</div><div class="line">            &#123; for (i = 1; i &lt;= NF &amp;&amp; $i != &quot;&quot;; i++);</div><div class="line">                if (i &lt;= NF)</div><div class="line">                    print</div><div class="line">            &#125;</div><div class="line">    è¿™ä¸ªç¨‹åºæ‰“å°æ‰€æœ‰çš„, åŒ…å«ç©ºå­—æ®µçš„è¡Œ.</div></pre></td></tr></table></figure><h3 id="å¾ªç¯æ€§èƒ½æ¯”è¾ƒ"><a href="#å¾ªç¯æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="å¾ªç¯æ€§èƒ½æ¯”è¾ƒ"></a>å¾ªç¯æ€§èƒ½æ¯”è¾ƒ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">time (awk &apos;BEGIN&#123;total=0;for(i=0;i&lt;=10000;i++)&#123;total+=i;&#125;;print total;&#125;&apos;)</div><div class="line">time(total=0;for i in &#123;1..10000&#125;;do total=$(($total+i));done;echo $total)</div><div class="line">time(for ((i=0;i&lt;=10000;i++));do let total+=i;done;echo $total)</div><div class="line">time(seq -s â€+â€ 10000|bc)</div></pre></td></tr></table></figure><h3 id="switchè¯­å¥"><a href="#switchè¯­å¥" class="headerlink" title="switchè¯­å¥"></a>switchè¯­å¥</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">è¯­æ³•ï¼š</div><div class="line">        switch(expression) &#123;case VALUE1 or /REGEXP/: statement1; case VALUE2 or /REGEXP2/: statement2; ...; default: statementn&#125;</div></pre></td></tr></table></figure><ul><li>break å’Œcontinue </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># awk â€˜BEGIN&#123;sum=0;for(i=1;i&lt;=100;i++) &#123;if(i%2==0)continue;sum+=i&#125;print sum&#125;â€˜</div><div class="line"># awk â€˜BEGIN&#123;sum=0;for(i=1;i&lt;=100;i++) &#123;if(i==66)break;sum+=i&#125;print sum&#125;â€˜</div></pre></td></tr></table></figure><ul><li>break [n]</li><li>continue [n]</li><li>next:æå‰ç»“æŸå¯¹æœ¬è¡Œå¤„ç†è€Œç›´æ¥è¿›å…¥ä¸‹ä¸€è¡Œå¤„ç†ï¼ˆawkè‡ªèº«å¾ªç¯ï¼‰      </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># awk -F: &apos;&#123;if($3%2!=0) next; print $1,$3&#125;&apos; /etc/passwd</div></pre></td></tr></table></figure><h3 id="awkæ•°ç»„"><a href="#awkæ•°ç»„" class="headerlink" title="awkæ•°ç»„"></a>awkæ•°ç»„</h3><ul><li>å…³è”æ•°ç»„ï¼šarray[index-expression]<pre><code>index-expression:(1)å¯ä½¿ç”¨ä»»æ„å­—ç¬¦ä¸²ï¼›å­—ç¬¦ä¸²è¦ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥(2)å¦‚æœæŸæ•°ç»„å…ƒç´ äº‹å…ˆä¸å­˜åœ¨ï¼Œåœ¨å¼•ç”¨æ—¶ï¼Œawkä¼šè‡ªåŠ¨åˆ›å»ºæ­¤å…ƒç´ ï¼Œå¹¶å°†å…¶å€¼åˆå§‹åŒ–ä¸ºâ€œç©ºä¸²â€è‹¥è¦åˆ¤æ–­æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŸå…ƒç´ ï¼Œè¦ä½¿ç”¨â€œindex in arrayâ€æ ¼å¼è¿›è¡Œéå†</code></pre>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">weekdays[â€œmonâ€]=&quot;Mondayâ€œ</div><div class="line"># awk &apos;BEGIN&#123;weekdays[&quot;mon&quot;]=&quot;Monday&quot;;weekdays[&quot;tue&quot;]=&quot;Tuesday&quot;;print weekdays[&quot;mon&quot;]&#125;&apos;&apos;</div><div class="line"># awk &apos;BEGIN&#123;weekdays[&quot;mon&quot;]=&quot;Monday&quot;;weekdays[&quot;tue&quot;]=&quot;tuesday&quot;;for(i in weekdays) print weekdays[i]&#125;&apos;    </div><div class="line"># awk â€˜!arr[$0]++â€™ dupfile   é‡å¤çš„è¡Œåªæ˜¾ç¤ºä¸€æ¬¡</div><div class="line"># awk &apos;&#123;!arr[$0]++;print $0, arr[$0]&#125;&apos; dupfile</div></pre></td></tr></table></figure><ul><li>è‹¥è¦éå†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œè¦ä½¿ç”¨forå¾ªç¯<br>  for(var in array) {for-body}<br>  æ³¨æ„ï¼švarä¼šéå†arrayçš„æ¯ä¸ªç´¢å¼•<br>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># awk &apos;BEGIN&#123;weekdays[&quot;mon&quot;]=&quot;Monday&quot;;weekdays[&quot;tue&quot;] =&quot;Tuesday&quot;;for(i in weekdays) &#123;print weekdays[i]&#125;&#125;&apos;</div><div class="line">#  netstat -tan | awk &apos;/^tcp/&#123;state[$NF]++&#125;END &#123;for(i in state) &#123; print i,state[i]&#125;&#125;&apos;</div><div class="line"># awk &apos;&#123;ip[$1]++&#125;END&#123;for(i in ip) &#123;print i,ip[i]&#125;&#125;&apos; /var/log/httpd</div><div class="line">/access_log</div></pre></td></tr></table></figure><h3 id="awkå‡½æ•°"><a href="#awkå‡½æ•°" class="headerlink" title="awkå‡½æ•°"></a>awkå‡½æ•°</h3><p>æ•°å€¼å¤„ç†:<br>rand()ï¼šè¿”å›0å’Œ1ä¹‹é—´ä¸€ä¸ªéšæœºæ•°<br>        awk â€˜BEGIN{rand(); for (i=1;i&lt;=10;i++)print int(rand()*100) }â€™</p><h3 id="å†…å»ºç®—æœ¯å‡½æ•°"><a href="#å†…å»ºç®—æœ¯å‡½æ•°" class="headerlink" title="å†…å»ºç®—æœ¯å‡½æ•°"></a>å†…å»ºç®—æœ¯å‡½æ•°</h3><table><thead><tr><th style="text-align:center">å‡½æ•°</th><th style="text-align:center">è¿”å›å€¼</th></tr></thead><tbody><tr><td style="text-align:center">atan2(y,x)</td><td style="text-align:center">y/xçš„åæ­£åˆ‡å€¼, å®šä¹‰åŸŸåœ¨ âˆ’Ï€åˆ°Ï€ä¹‹é—´</td></tr><tr><td style="text-align:center">cos(x)</td><td style="text-align:center">xçš„ä½™å¼¦å€¼, xä»¥å¼§åº¦ä¸ºå•ä½</td></tr><tr><td style="text-align:center">exp(x)</td><td style="text-align:center">xçš„æŒ‡æ•°å‡½æ•°,e x</td></tr><tr><td style="text-align:center">int(x)</td><td style="text-align:center">xçš„æ•´æ•°éƒ¨åˆ†; å½“xå¤§äº0æ—¶, å‘ 0å–æ•´</td></tr><tr><td style="text-align:center">log(x)</td><td style="text-align:center">xçš„è‡ªç„¶å¯¹æ•°(ä»¥eä¸ºåº•)</td></tr><tr><td style="text-align:center">rand()</td><td style="text-align:center">è¿”å›ä¸€ä¸ªéšæœºæ•°r, 0 â‰¤ r &lt; 1</td></tr><tr><td style="text-align:center">sin(x)</td><td style="text-align:center">xçš„æ­£å¼¦å€¼, xä»¥å¼§åº¦ä¸ºå•ä½.</td></tr><tr><td style="text-align:center">sqrt(x)</td><td style="text-align:center">xçš„æ–¹æ ¹</td></tr><tr><td style="text-align:center">srand(x)</td><td style="text-align:center">xæ˜¯rand() çš„æ–°çš„éšæœºæ•°ç§å­</td></tr></tbody></table><h3 id="è‡ªå®šä¹‰å‡½æ•°"><a href="#è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="è‡ªå®šä¹‰å‡½æ•°"></a>è‡ªå®šä¹‰å‡½æ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">æ ¼å¼ï¼š</div><div class="line">        function name ( parameter, parameter, ... ) &#123;</div><div class="line">            statements</div><div class="line">            return expression</div><div class="line">        &#125;</div><div class="line">    ç¤ºä¾‹ï¼š</div><div class="line">        cat fun.awk</div><div class="line">            function max(v1,v2) &#123;</div><div class="line">                v1&gt;v2?var=v1:var=v2</div><div class="line">                         return var</div><div class="line">            &#125;</div><div class="line">            BEGIN&#123;a=3;b=2;print max(a,b)&#125;</div><div class="line">        awk -f fun.awk</div></pre></td></tr></table></figure><h3 id="awkä¸­è°ƒç”¨shellå‘½ä»¤"><a href="#awkä¸­è°ƒç”¨shellå‘½ä»¤" class="headerlink" title="awkä¸­è°ƒç”¨shellå‘½ä»¤"></a>awkä¸­è°ƒç”¨shellå‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemå‘½ä»¤</div><div class="line">ç©ºæ ¼æ˜¯awkä¸­çš„å­—ç¬¦ä¸²è¿æ¥ç¬¦ï¼Œå¦‚æœsystemä¸­éœ€è¦ä½¿ç”¨awkä¸­çš„å˜é‡å¯ä»¥ä½¿ç”¨ç©ºæ ¼åˆ†éš”ï¼Œæˆ–è€…è¯´é™¤äº†awkçš„å˜é‡å¤–å…¶ä»–ä¸€å¾‹ç”¨&quot;&quot;å¼•ç”¨èµ·æ¥ã€‚</div><div class="line"># awk BEGIN&apos;&#123;system(&quot;hostname&quot;) &#125;&apos;</div><div class="line"># awk &apos;BEGIN&#123;score=100; system(&quot;echo your score is &quot; score) &#125;&apos;</div></pre></td></tr></table></figure><h3 id="awkè„šæœ¬"><a href="#awkè„šæœ¬" class="headerlink" title="awkè„šæœ¬"></a>awkè„šæœ¬</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">å°†awkç¨‹åºå†™æˆè„šæœ¬ï¼Œç›´æ¥è°ƒç”¨æˆ–æ‰§è¡Œ</div><div class="line">ç¤ºä¾‹ï¼š</div><div class="line"># cat f1.awk</div><div class="line">&#123;if($3&gt;=1000)print $1,$3&#125;</div><div class="line"># awk -F: -f f1.awk /etc/passwd</div><div class="line"># cat f2.awk</div><div class="line">    #!/bin/awk -f</div><div class="line">        #this is a awk script</div><div class="line">        &#123;if($3&gt;=1000)print $1,$3&#125;</div><div class="line">#chmod +x f2.awk</div><div class="line">#  f2.awk -F: /etc/passwd</div></pre></td></tr></table></figure><h3 id="å‘awkè„šæœ¬ä¼ é€’å‚æ•°"><a href="#å‘awkè„šæœ¬ä¼ é€’å‚æ•°" class="headerlink" title="å‘awkè„šæœ¬ä¼ é€’å‚æ•°"></a>å‘awkè„šæœ¬ä¼ é€’å‚æ•°</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">æ ¼å¼ï¼š</div><div class="line">        awkfile var=value var2=value2... Inputfile</div><div class="line">    æ³¨æ„ï¼šåœ¨BEGINè¿‡ç¨‹ä¸­ä¸å¯ç”¨ã€‚ç›´åˆ°é¦–è¡Œè¾“å…¥å®Œæˆä»¥åï¼Œå˜é‡æ‰å¯ç”¨ã€‚å¯ä»¥é€šè¿‡-vå‚æ•°ï¼Œè®©awkåœ¨æ‰§è¡ŒBEGINä¹‹å‰å¾—åˆ°å˜é‡çš„å€¼ã€‚å‘½ä»¤è¡Œä¸­æ¯ä¸€ä¸ªæŒ‡å®šçš„å˜é‡éƒ½éœ€è¦ä¸€ä¸ª-vå‚æ•°</div></pre></td></tr></table></figure><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># cat test.awk</div><div class="line">            #!/bin/awk -f</div><div class="line">            &#123;if($3 &gt;=min &amp;&amp; $3&lt;=max)print $1,$3&#125;</div><div class="line">        chmod +x test.awk</div><div class="line"># test.awk -F: min=100 max=200 /etc/passwd</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>redis å¸¸ç”¨åŠŸèƒ½</title>
      <link href="/2018/04/27/redis/"/>
      <url>/2018/04/27/redis/</url>
      <content type="html"><![CDATA[<h1 id="redis-å¸¸ç”¨åŠŸèƒ½"><a href="#redis-å¸¸ç”¨åŠŸèƒ½" class="headerlink" title="redis å¸¸ç”¨åŠŸèƒ½"></a>redis å¸¸ç”¨åŠŸèƒ½</h1><p><img src="/images/redis_n1.jpg" alt=""><br>KV cache and store<br>REmote DIctionary Server(è¿œç¨‹å­—å…¸æœåŠ¡å™¨)<br>redis è¿è¡Œéƒ½åœ¨å†…å­˜ä¸­æ¥å®ç°ï¼Œå‘¨æœŸæ€§çš„å†™å…¥ç£ç›˜ï¼Œæ¥å®ç°æŒä¹…åŠŸèƒ½;</p><h2 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">KV cache and store</div><div class="line">    in-memory;</div><div class="line">    æŒä¹…åŒ– ;</div><div class="line">    ä¸»ä»(å€ŸåŠ©äºsentinalå®ç°ä¸€å®šæ„ä¹‰ä¸Šçš„HA);</div><div class="line">    Clustering(åˆ†å¸ƒå¼);</div><div class="line">æ•°æ®ç»“æ„æœåŠ¡å™¨:</div><div class="line">    String, List, Hash, Set, Sorted Set, Bitmap,HperLoglogs;</div><div class="line">Memcached ä¸ Redisçš„åŒºåˆ«:</div><div class="line">    1ã€Memcached æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„å†…å­˜å¯¹è±¡ç¼“å­˜ç³»ç»Ÿ;</div><div class="line">    2ã€Reis å¯ä»¥å®ç°æŒä¹…å­˜å‚¨çš„;</div><div class="line">    3ã€Mecached æ˜¯ä¸€ä¸ªLUR ç¼“å­˜ï¼Œå°†è¿‡æœŸæ•°æ®æ¸…ç†å‡ºå»;</div><div class="line">    4ã€Redisæ”¯æŒæ›´å¤šçš„æ•°æ®ç±»å‹;</div><div class="line">    5ã€Memcached æ˜¯å¤šçº¿ç¨‹;</div><div class="line">    6ã€Redisæ˜¯å•çº¿ç¨‹;</div><div class="line">    7ã€äºŒè€…çš„æ€§èƒ½ä¸ç›¸ä¸Šä¸‹;</div><div class="line">Redis 3.0çš„LRUç®—æ³•çš„æ”¹è¿›:</div><div class="line">    é¢„è®¾éšæœºå–5ä¸ªæ ·æœ¬ï¼Œæ’å…¥å¹¶æ’åºè‡³ä¸€ä¸ªpoolï¼Œ ç§»é™¤æœ€ä½³è€…ï¼Œå¦‚æ­¤åå¤;</div><div class="line">    èµ°åˆ°å†…å­˜ç”¨ç†å°äºmaxmemoryçš„è®¾å®š;</div><div class="line">    æ ·æœ¬5æ¯”å…ˆå‰çš„3å¤š;</div><div class="line">    ä»å±€éƒ¨æœ€ä¼˜è¶‹å‘å…¨å±€æœ€ä¼˜;</div><div class="line">å­˜å‚¨ç³»ç»Ÿä¸‰ç±»:</div><div class="line">    RDBMS</div><div class="line">    NoSQL:</div><div class="line">        KV NoSQL: redis</div><div class="line">        Column Family NoSQL: HBase</div><div class="line">        Documentation NoSQL: MongoDB</div><div class="line">        Graph NoSQL: Neo4j</div><div class="line">    NewSQL(æ”¯æŒåˆ†å¸ƒå¼)</div><div class="line">Redisçš„ç»„ä»¶:</div><div class="line">    redis.io(å®˜æ–¹ç«™ç‚¹)</div></pre></td></tr></table></figure><h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">redis-server</div><div class="line">redis-cli</div><div class="line">    Command line interface </div><div class="line">redis-benchmark</div><div class="line">    Benchmarking utility</div><div class="line">redis-check-dump &amp; redis-check-aof</div><div class="line">    Corrupted RDB/AOF files utilities</div></pre></td></tr></table></figure><h2 id="Rediså®ˆæŠ¤è¿›ç¨‹"><a href="#Rediså®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="Rediså®ˆæŠ¤è¿›ç¨‹"></a>Rediså®ˆæŠ¤è¿›ç¨‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># vim /etc/redis.conf</div><div class="line">ç›‘å¬6379ç«¯å£;</div><div class="line">tcp-backlog 511 #æ˜¯rediså®ˆæŠ¤è¿›ç¨‹çš„ç­‰é˜Ÿåˆ—,å½“å¹¶å‘è¾ƒé«˜æ—¶ï¼Œå†æ‰¾ä½ç½®æ¥ç¼“å­˜æ–°è¯·æ±‚;</div><div class="line">bind # æ˜¯æŒ‡ç›‘å¬çš„åœ°å€;</div><div class="line">bind 127.0.0.1 172.16.55.128</div><div class="line">unixsocket /tmp/redis.sock # å½“æœåŠ¡å’Œredisåœ¨ä¸€å°æœåŠ¡å™¨ä¸Šä½¿ç”¨socketæ¥é€šä¿¡ï¼Œæé«˜æ•ˆç‡;</div><div class="line">unixsocketperm 700</div><div class="line">timeout #å½“ä¸€ä¸ªå®¢ç«¯è¿æ¥å¤šä¹…åï¼Œè®¤ä¸ºè¶…æ—¶ï¼Œ0è¡¨ç¤ºç¦ç”¨ï¼Œè®¤ä¸ºä¸€ç›´å­˜åœ¨;</div><div class="line">tcp-keepaoive 0</div><div class="line">loglevel notice</div><div class="line">logfile /var/log/redis/redis.log</div><div class="line">databases 16  # è¡¨ç¤ºå¯ä»¥ä½¿ç”¨å¤šå°‘ä¸ªæ•°æ®åº“;</div><div class="line">save &lt;sencods&gt; &lt;changes&gt; # å¦‚æœå¤šå°‘ç§’å‘ç”Ÿå¤šå°‘å˜åŒ–åˆ™å­˜å‚¨ï¼Œå› æ­¤è¿™å–å†³äºä¸šåŠ¡æ¨¡å‹;</div><div class="line">save &quot;&quot;   #è¿™æ ·å†™è¡¨ç¤ºç¦ç”¨redisæŒä¹…åŒ–åŠŸèƒ½;</div><div class="line">save 900 1</div><div class="line">save 300 10</div><div class="line">save 60 10000</div><div class="line">stop-writes-on-bgsave-error yes </div><div class="line">rdbcompression yes</div><div class="line">dbcheksum yes</div><div class="line">dbfilename dump.rdb</div><div class="line">dir /var/lib/redis</div><div class="line"># é…ç½®ä»¥ä¸ºæˆä¸ºä»æœåŠ¡å™¨</div><div class="line">salveof   ip # è¿™é‡ŒæŒ‡å®šä¸»æœåŠ¡å™¨çš„ipå³å¯;</div><div class="line">maxclients 100000</div><div class="line">appendonly yes # å¼€å¯appendonly æŒä¹…åŒ–åŠŸèƒ½;</div><div class="line">appendfsync  everysec # æ˜¯å¦ä½¿ç”¨fsyncæ¥æŒä¹…åŒ–;</div><div class="line"># redisæœåŠ¡ç«¯çš„å‚æ•°ï¼Œå¤§å¤šå¯ä»¥åœ¨redis-cliè¿æ¥åˆ°æœåŠ¡å™¨åè¿›è¡ŒåŠ¨æ€ä¿®å¤æˆ–ä¿®æ”¹çš„;</div></pre></td></tr></table></figure><h2 id="redis-cli-å¸¸ç”¨å‘½ä»¤"><a href="#redis-cli-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="redis-cli å¸¸ç”¨å‘½ä»¤"></a>redis-cli å¸¸ç”¨å‘½ä»¤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"># redis-cli -p 25612 </div><div class="line">127.0.0.1:25612&gt; AUTH xxxxxxx</div><div class="line">127.0.0.1:25612&gt; HELP APPEND # help ç”¨æ¥æŸ¥çœ‹å¸®åŠ©</div><div class="line">127.0.0.1:25612&gt; CLIENT LIST</div><div class="line">id=3 addr=127.0.0.1:25666 fd=5 name= age=275 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=client</div><div class="line">127.0.0.1:25612&gt; SELECT 1 # ç¬¬å¼€ç¬¬å‡ ä¸ªæ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥ç†è§£æˆä¸ºåç§°ç©ºé—´;</div><div class="line">127.0.0.1:25612&gt; SELECT 1</div><div class="line">OK</div><div class="line">127.0.0.1:25612[1]&gt; SET disto fedora</div><div class="line">OK</div><div class="line">127.0.0.1:25612[1]&gt; GET disto</div><div class="line">&quot;fedora&quot;</div><div class="line">127.0.0.1:25612[1]&gt; SET disto centos</div><div class="line">OK</div><div class="line">127.0.0.1:25612[1]&gt; STRLEN disto</div><div class="line">(integer) 6</div><div class="line">127.0.0.1:25612[1]&gt; DECR count</div><div class="line">(integer) -1</div><div class="line">127.0.0.1:25612[1]&gt; DECR count</div><div class="line">(integer) -2</div><div class="line">127.0.0.1:25612[1]&gt; DECR count</div><div class="line">(integer) -3</div><div class="line">127.0.0.1:25612[1]&gt; SET disto gentoo NX # æ˜¾ç¤ºä¸ºæœªèƒ½æ‰§è¡Œçš„æ“ä½œ,è¯¥å€¼ä¸å­˜åœ¨åˆ™è®¾å®š;</div><div class="line">(nil)</div><div class="line">127.0.0.1:25612[1]&gt; SET foo bar XX # è¯¥å€¼åˆ™åœ¨åˆ™è®¾å®š;</div><div class="line">(nil)</div><div class="line">127.0.0.1:25612[1]&gt; SADD w1 mon tue wed thu sat sun</div><div class="line">(integer) 6</div><div class="line">127.0.0.1:25612[1]&gt; SADD w1 mon tue wed thu fre sat sun</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:25612[1]&gt; </div><div class="line">127.0.0.1:25612[1]&gt; SADD w2 tue thu day</div><div class="line">127.0.0.1:25612[1]&gt; ZADD weekday1 1 mon 2 tue 3 wed</div><div class="line">(integer) 3</div><div class="line">127.0.0.1:25612[1]&gt; ZCARD weekday1</div><div class="line">(integer) 3</div><div class="line">127.0.0.1:25612[1]&gt; ZRANK weekday1 tue</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:25612[1]&gt; ZRANK weekday1 mon</div><div class="line">(integer) 0</div><div class="line">    </div><div class="line">(integer) 3</div><div class="line">127.0.0.1:25612[1]&gt; SINTER w1 w2 # æ±‚ä¸¤ä¸ªé›†åˆçš„äº¤é›†;</div><div class="line">1) &quot;thu&quot;</div><div class="line">2) &quot;tue&quot;</div><div class="line">127.0.0.1:25612[1]&gt; SUNION w1 w2  # æ±‚ä¸¤ä¸ªé›†åˆçš„å¹¶é›†;</div><div class="line">1) &quot;sun&quot;</div><div class="line">2) &quot;wed&quot;</div><div class="line">3) &quot;sat&quot;</div><div class="line">4) &quot;day&quot;</div><div class="line">5) &quot;tue&quot;</div><div class="line">6) &quot;thu&quot;</div><div class="line">7) &quot;mon&quot;</div><div class="line">8) &quot;fre&quot;</div><div class="line">127.0.0.1:25612[1]&gt; SPOP w1 # å¼¹å‡ºä¸€ä¸ªå…ƒç´  ;</div><div class="line">&quot;tue&quot;</div><div class="line">127.0.0.1:25612[1]&gt; SPOP w1</div><div class="line">&quot;sun&quot;</div><div class="line">127.0.0.1:25612[1]&gt; SISMEMBER w1 day # è¡¨ç¤ºå·²ç»æ²¡æœ‰è¿™ä¸ªå…ƒç´ ;</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:25612[1]&gt; SISMEMBER w1 sat</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:25612[1]&gt; ZRANGE weekday1 0 1</div><div class="line">1) &quot;mon&quot;</div><div class="line">2) &quot;tue&quot;</div><div class="line">127.0.0.1:25612[1]&gt; HSET h1 a mon</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:25612[1]&gt; HGET h1 a</div><div class="line">&quot;mon&quot;</div><div class="line">127.0.0.1:25612[1]&gt; HSET h1 b tue</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:25612[1]&gt; HGET h1 a </div><div class="line">&quot;mon&quot;</div><div class="line">127.0.0.1:25612[1]&gt; HGET h1 b </div><div class="line">&quot;tue&quot;</div><div class="line">127.0.0.1:25612[1]&gt; HVALS h1</div><div class="line">1) &quot;mon&quot;</div><div class="line">2) &quot;tue&quot;</div><div class="line">127.0.0.1:25612[1]&gt; HKEYS h1</div><div class="line">1) &quot;a&quot;</div><div class="line">2) &quot;b&quot;</div><div class="line">Strings: å­—ä¸²</div><div class="line">    SET key value [EX #]  [NX|XX]</div><div class="line">    GET</div><div class="line">    INCR</div><div class="line">    DECR</div><div class="line">    EXIST</div><div class="line">Lists: åˆ—è¡¨</div><div class="line">    LPUSH</div><div class="line">    RPUSH</div><div class="line">    LDROP</div><div class="line">    RPOP</div><div class="line">    LINDEX</div><div class="line">    LSET</div><div class="line">Sets: é›†åˆ</div><div class="line">    SADD</div><div class="line">    SINTER</div><div class="line">    SUNTON</div><div class="line">    SPOP</div><div class="line">    SISMEMBER</div><div class="line">Sorted Sets æœ‰åºé›†åˆï¼Œ å…¶å‘½ä»¤éƒ½ä»¥Zå¼€å¤´</div><div class="line">    ZADD </div><div class="line">    ZRANGE</div><div class="line">    ZCARD</div><div class="line">    ZRANK</div><div class="line">Hashesï¼š ä¸€ç»„å…³è”æ•°çš„é›†åˆ</div><div class="line">    HSET</div><div class="line">    HSETNX</div><div class="line">    HGET </div><div class="line">    HKEYS</div><div class="line">    HVALS</div><div class="line">    HDEL</div></pre></td></tr></table></figure><h2 id="è®¤è¯å®ç°æ–¹æ³•"><a href="#è®¤è¯å®ç°æ–¹æ³•" class="headerlink" title="è®¤è¯å®ç°æ–¹æ³•"></a>è®¤è¯å®ç°æ–¹æ³•</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(1) redis.conf</div><div class="line">    requirepass PASSWORD</div><div class="line">(2) redis-cli</div><div class="line">    AUTH PASSWD</div></pre></td></tr></table></figure><h2 id="æ¸…ç©ºæ•°æ®åº“"><a href="#æ¸…ç©ºæ•°æ®åº“" class="headerlink" title="æ¸…ç©ºæ•°æ®åº“"></a>æ¸…ç©ºæ•°æ®åº“</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># FLUSHDB:  æ¸…ç©ºå½“å‰åº“</div><div class="line"># FLUSHALL: æ¸…ç©ºæ‰€æœ‰åº“</div></pre></td></tr></table></figure><h2 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"># é€šè¿‡MULTI, EXEC, WATCHç­‰å‘½ä»¤å®ç°äº‹åŠ¡åŠŸèƒ½;</div><div class="line"># å°†ä¸€ä¸ªæˆ–å¤šä¸ªå‘½ä»¤å½’å¹¶ä¸ºä¸€ä¸ªæ“ä½œæè¯·æœåŠ¡å™¨æŒ‰é¡ºåºæ‰§è¡Œçš„æœºåˆ¶;</div><div class="line"># Redisæ•°æ®ä¸æ”¯æŒå›æ»šæ“ä½œ;</div><div class="line"># MULTI: å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸­é—´çš„æ‰€æœ‰å‘½ä»¤ä¼šæ”¾ç½®åœ¨é˜Ÿåˆ—ä¸­;</div><div class="line"># EXEC: æ‰§è¡Œäº‹åŠ¡;</div><div class="line">#  ä¸€æ¬¡æ€§å°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œæ‰§è¡Œå®Œæˆåè¿”å›ç»™å®¢æˆ·ç«¯;</div><div class="line">127.0.0.1:25612&gt; MULTI</div><div class="line">OK</div><div class="line">127.0.0.1:25612&gt; SET ip 172.16.55.123</div><div class="line">QUEUED</div><div class="line">127.0.0.1:25612&gt; GET ip </div><div class="line">QUEUED</div><div class="line">127.0.0.1:25612&gt; SET port 8080</div><div class="line">QUEUED</div><div class="line">127.0.0.1:25612&gt; GET port </div><div class="line">QUEUED</div><div class="line">127.0.0.1:25612&gt; EXEC</div><div class="line">1) OK</div><div class="line">2) &quot;172.16.55.123&quot;</div><div class="line">3) OK</div><div class="line">4) &quot;8080&quot;</div><div class="line"># WATCH: ä¹è§‚é”ï¼Œ åœ¨EXECå‘½ä»¤æ‰§è¡Œä¹‹é—´æœ‰ç”¨äºç›‘è§†æŒ‡å®šæ•°é‡é”®;</div><div class="line">    #å¦‚æœç›‘è§†ä¸­çš„æŸä»»æ„é”®æ•°æ®è¢«ä¿®æ”¹ï¼Œåˆ™æœåŠ¡å™¨æ‹’ç»æ‰§è¡Œäº‹åŠ¡;</div><div class="line"># æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯</div><div class="line">term1</div><div class="line">127.0.0.1:25612&gt; WATCH ip</div><div class="line">OK</div><div class="line">127.0.0.1:25612&gt; MULTI</div><div class="line">OK</div><div class="line">127.0.0.1:25612&gt; SET ip 10.0.0.1</div><div class="line">QUEUED</div><div class="line">127.0.0.1:25612&gt; GET ip</div><div class="line">QUEUED</div><div class="line">term2 </div><div class="line">127.0.0.1:25612&gt; GET ip </div><div class="line">&quot;172.16.55.123&quot;</div><div class="line">127.0.0.1:25612&gt; SET ip 172.16.55.123</div><div class="line">OK</div><div class="line">127.0.0.1:25612&gt; GET ip </div><div class="line">&quot;172.16.55.123&quot;</div><div class="line">term1</div><div class="line">127.0.0.1:25612&gt; EXEC</div><div class="line">(nil)</div><div class="line"># ç›‘æ§çš„ä¸€ä¸ªé”®ï¼ŒEXECä¹‹å‰é”®å‘ç”Ÿäº†æ”¹åŠ¨ï¼ŒEXECå°†æ‹’ç»æäº¤;</div></pre></td></tr></table></figure><h2 id="Connectionç›¸å…³çš„å‘½ä»¤"><a href="#Connectionç›¸å…³çš„å‘½ä»¤" class="headerlink" title="Connectionç›¸å…³çš„å‘½ä»¤:"></a>Connectionç›¸å…³çš„å‘½ä»¤:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">AUTH</div><div class="line">127.0.0.1:25612&gt; HELP PING </div><div class="line"></div><div class="line">  PING [message]</div><div class="line">  summary: Ping the server</div><div class="line">  since: 1.0.0</div><div class="line">  group: connection</div><div class="line"></div><div class="line">127.0.0.1:25612&gt; PING</div><div class="line">PONG</div><div class="line">127.0.0.1:25612&gt; ECHO &quot;hello redis&quot;</div><div class="line">&quot;hello redis&quot;</div><div class="line">127.0.0.1:25612&gt; </div><div class="line">QUIT</div><div class="line">127.0.0.1:25612&gt; HELP @connection</div></pre></td></tr></table></figure><h2 id="Serverç›¸å…³çš„å‘½ä»¤"><a href="#Serverç›¸å…³çš„å‘½ä»¤" class="headerlink" title="Serverç›¸å…³çš„å‘½ä»¤"></a>Serverç›¸å…³çš„å‘½ä»¤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">CLIENT GETNAME</div><div class="line">CLIENT KILL ip:port</div><div class="line">127.0.0.1:25612&gt; CLIENT SETNAME localconn</div><div class="line">OK</div><div class="line">127.0.0.1:25612&gt; CLIENT GETNAME</div><div class="line">&quot;localconn&quot;</div><div class="line">127.0.0.1:25612&gt; HELP INFO # è·å–å½“å‰æœåŠ¡å™¨çš„çŠ¶æ€åŠä¿¡æ¯;</div><div class="line">  INFO [section]</div><div class="line">  summary: Get information and statistics about the server</div><div class="line">  since: 1.0.0</div><div class="line">  group: server</div><div class="line">127.0.0.1:25612&gt; INFO CPU</div><div class="line"># CPU</div><div class="line">used_cpu_sys:474.20</div><div class="line">used_cpu_user:258.88</div><div class="line">used_cpu_sys_children:0.01</div><div class="line">used_cpu_user_children:0.00</div><div class="line">CONFIG RESETSTAT</div><div class="line">CONFIG SET PARAMETER value</div><div class="line">CONFIG REWRITE </div><div class="line">DBSIZE</div><div class="line"># è·ŸæŒä¹…åŒ–ç›¸å…³çš„æ•°æ® </div><div class="line">BGSAVE </div><div class="line">SAVE</div><div class="line">LASTSAVE</div><div class="line">monitor # å®æ—¶ç›‘æ§å¯¹æ•°æ®çš„è¯·æ±‚</div><div class="line">SHUTDOWN SAVE #å°†æ•°æ®å®‰å…¨çš„åŒæ­¥åˆ°ç£ç›˜åå…³é—­redis-server</div></pre></td></tr></table></figure><h2 id="redis-å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½-publish-subscribe"><a href="#redis-å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½-publish-subscribe" class="headerlink" title="redis å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½(publish/subscribe)"></a>redis å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½(publish/subscribe)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"># é¢‘é“: æ¶ˆæ¯é˜Ÿåˆ—</div><div class="line"># SUBSCRIBE: è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—;</div><div class="line"># PUBLISH: å‘é¢‘é“å‘å¸ƒæ¶ˆæ¯;</div><div class="line"># UNSUBSCRIBE: é€€è®¢æ­¤å‰è®¢é˜…çš„é¢‘é“;</div><div class="line"># PSUBSCRIBE: æ¨¡å¼è®¢é˜…;</div><div class="line"># term1 ä¸­å¼€å§‹ä¸€ä¸ªé¢‘é“; </div><div class="line">127.0.0.1:25612&gt; SUBSCRIBE news</div><div class="line">Reading messages... (press Ctrl-C to quit)</div><div class="line">1) &quot;subscribe&quot;</div><div class="line">2) &quot;news&quot;</div><div class="line">3) (integer) 1</div><div class="line"></div><div class="line"># term2 ä¸­å‘ä¸€ä¸ªé¢‘é“ä¸­å‘å¸ƒæ¶ˆæ¯;</div><div class="line">127.0.0.1:25612&gt; PUBLISH news &quot;hello renjin&quot;</div><div class="line">(integer) 1</div><div class="line"></div><div class="line"># term1 ä¸­å¯ä»¥æ”¶åˆ°æ¶ˆæ¯;</div><div class="line">1) &quot;message&quot;</div><div class="line">2) &quot;news&quot;</div><div class="line">3) &quot;hello renjin&quot;</div><div class="line"></div><div class="line"># term1 ä¸­ä½¿ç”¨æ‰©å±•æ¨¡å¼å¼€å¯ä¸¤ä¸ªé¢‘é“;</div><div class="line">127.0.0.1:25612&gt; PSUBSCRIBE &quot;rj.i[to]&quot;</div><div class="line">Reading messages... (press Ctrl-C to quit)</div><div class="line">1) &quot;psubscribe&quot;</div><div class="line">2) &quot;rj.i[to]&quot;</div><div class="line">3) (integer) 1</div><div class="line"></div><div class="line"># term2 ä¸­å‘ä¸¤ä¸ªé¢‘é“å‘å¸ƒæ¶ˆæ¯;</div><div class="line">127.0.0.1:25612&gt; PUBLISH rj.io &quot;hello RenJin&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:25612&gt; PUBLISH rj.it &quot;hello SSJinYao&quot;</div><div class="line">(integer) 1</div><div class="line"></div><div class="line"># term1 ä¸­å¯ä»¥æ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯;</div><div class="line">1) &quot;pmessage&quot;</div><div class="line">2) &quot;rj.i[to]&quot;</div><div class="line">3) &quot;rj.io&quot;</div><div class="line">4) &quot;hello RenJin&quot;</div><div class="line">1) &quot;pmessage&quot;</div><div class="line">2) &quot;rj.i[to]&quot;</div><div class="line">3) &quot;rj.it&quot;</div><div class="line">4) &quot;hello SSJinYao&quot;</div></pre></td></tr></table></figure><h2 id="Redis-çš„æŒä¹…åŒ–"><a href="#Redis-çš„æŒä¹…åŒ–" class="headerlink" title="Redis çš„æŒä¹…åŒ–:"></a>Redis çš„æŒä¹…åŒ–:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"># æä¾›äº†RDBå’ŒAOFä¸¤ç§æœºåˆ¶;</div><div class="line">    RDB: snapshot: äºŒè¿›åˆ¶æ ¼å¼; æŒ‰äº‹å…ˆå®šåˆ¶çš„ç­–ç•¥ï¼Œå‘¨æœŸæ€§åœ°å°†æ•°æ®ä¿å­˜è‡³ç£ç›˜:æ•°æ®æ–‡ä»¶é»˜è®¤ä¸ºdump.rdb;</div><div class="line">        å®¢æˆ·ç«¯ ä¹Ÿå¯ä»¥ä½¿ç”¨SAVEæˆ–BGSAVEå‘½ä»¤å¯å¿«ç…§ä¿å­˜æœºåˆ¶;</div><div class="line">            SAVEï¼šåŒæ­¥,åœ¨ä¸»çº¿ç¨‹ä¸­ä¿å­˜å¿«ç…§; æ­¤æ—¶ä¼šé˜»å¡æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚;</div><div class="line">            BGSAVE: å¼‚æ­¥ï¼Œ</div><div class="line">    AOF:Aappend Only Fil</div><div class="line">        è®°å½•æ¯ä¸€æ¬¡å†™æ“ä½œè‡³æŒ‡å®š çš„æ–‡ä»¶å°¾éƒ¨å®ç°æŒä¹…åŒ–; å½“redisé‡å¯æ—¶ï¼Œå¯é€šè¿‡é‡æ–°æ‰§è¡Œæ–‡ä»¶ä¸­çš„å‘½ä»¤åœ¨å†…å­˜é‡å»ºæ•°æ®åº“;</div><div class="line">        BGREWRITEAOF: AOFæ–‡ä»¶é‡å†™:</div><div class="line">            ä¸ä¼šè¯»å–æ­£åœ¨ä½¿ç”¨çš„AOFæ–‡ä»¶ï¼Œè€Œé€šè¿‡å°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å‘½ä»¤çš„æ–¹å¼ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå®Œä¹‹åæ›¿æ¢åŸæ¥çš„AOFæ–‡ä»¶;</div><div class="line">    RDB:é»˜è®¤ä¿å­˜ç­–ç•¥ï¼Œå–å†³äºç£ç›˜IOèƒ½åŠ›ï¼Œä¸å®¢æˆ·ç«¯å¯¹redisçš„è¯»å†™;</div><div class="line">        SAVE 900 1 </div><div class="line">        SAVE 300 10</div><div class="line">        SAVE 60 1000 </div><div class="line">stop-writes-on-bgsave-error yes  # åœ¨è¿›è¡Œå¿«ç…§å¤‡ä»½æ—¶ï¼Œç›‘æ§åˆ°æŒä¹…åŒ–å‘ç°é”™è¯¯æ—¶ï¼Œæ˜¯å¦åœæ­¢ä¸‹æ¥; ä¼šæŠ¥å‘Šä¸€ä¸ªè®¿é—®é”™è¯¯;</div><div class="line">rdbcompression yes # æ˜¯å¦é‡‡ç”¨å‹ç¼©æ¥èŠ‚çœä½¿æœ‰ç©ºé—´ï¼Œå½“ç„¶æ¶ˆè€—cpuä½¿ç”¨å‘¨æœŸ;</div><div class="line">rdbchecksum yes  # æ˜¯å¦å¯¹rdbåšæ ¡éªŒç æ“ä½œ;</div><div class="line">dbfilename dump.rdb # æŒ‡æ˜æ–‡ä»¶å;</div><div class="line">dir /var/lib/redis #æŒ‡æ˜ä¿å­˜æ–‡ä»¶çš„ä½ç½®;</div><div class="line">127.0.0.1:25612&gt; CONFIG GET dir</div><div class="line">1) &quot;dir&quot;</div><div class="line">2) &quot;/var/lib/redis&quot;            </div><div class="line"></div><div class="line">AOF:</div><div class="line">    é‡å†™è¿‡ç¨‹:</div><div class="line">        (1) redis ä¸»è¿›ç¨‹é€šè¿‡forkåˆ›å»ºå­è¿›ç¨‹;</div><div class="line">        (2) å­è¿›ç¨‹æ ¹æ®rediså†…å­˜ä¸­çš„æ•°æ®åˆ›å»ºæ•°æ®åº“é‡å»ºå‘½ä»¤åºåˆ—äºä¸´æ—¶æ–‡ä»¶ä¸­;</div><div class="line">        (3) çˆ¶è¿›ç¨‹ç»§æ‰¿clientçš„è¯·æ±‚æ—¶ï¼Œå¹¶ä¼šæŠŠè¿™äº›è¯·æ±‚ä¸­çš„å†™æ“ä½œç»§ç»­è¿½åŠ è‡³åŸæ¥çš„AOFæ–‡ä»¶;</div><div class="line">            é¢å¤–åœ°ï¼Œè¿™äº›æ–°çš„å†™è¯·æ±‚è¿˜ä¼šè¢«æ”¾ç½®äºä¸€ä¸ªç¼“å†²é˜Ÿåˆ—ä¸­;</div><div class="line">        (4) å­è¿›ç¨‹é‡å†™å®Œæˆï¼Œä¼šé€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æŠŠç¼“å†²ä¸­çš„å‘½ä»¤å†™åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­;</div><div class="line">        (5) çˆ¶è¿›ç¨‹ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢è€çš„aofæ–‡ä»¶;</div><div class="line">        </div><div class="line">        appenonly no #æ²¡æœ‰å¼€å¯AOF åŠŸèƒ½;</div><div class="line">        appendfilename &quot;appendonly.aof&quot; # æ–‡ä»¶å</div><div class="line">        appendfsync eversec  # æ¯ç§’ä¸­å†™ä¸€æ¬¡</div><div class="line">        no-appedfsync-no-rewrite no #  å¯¹æ–°çš„æ“ä½œä¸åšfsyncï¼Œè€Œæ˜¯æ”¾åœ¨ç¼“å­˜é˜Ÿåˆ—ä¸­çš„;</div><div class="line">        auto-aof-rewrite-percentage 100 # å½“å‰afo æ–‡ä»¶æ˜¯ä¸Šæ¬¡çš„ä¸¤å€æ—¶ï¼Œå†é‡æ–°è§¦å‘é‡å†™æ“ä½œ;</div><div class="line">                auto-aof-rewrite-min-size 64mb # </div><div class="line">127.0.0.1:25612&gt; CONFIG SET appendonly yes</div><div class="line">OK</div><div class="line"></div><div class="line"># æ³¨æ„: æŒä¹…æœ¬èº«ä¸èƒ½å–ä»£å¤‡ä»½: è¿˜åº”è¯¥åˆ¶å®šå¤‡ä»½ç­–ç•¥,å¯¹redisæ•°æ®åº“è¿›è¡Œå®šæœŸå¤‡ä»½;</div><div class="line"># RDBä¸AOFåŒæ—¶å¯ç”¨:</div><div class="line">    (1) BGSAVEå’ŒBGREWRITEAOF ä¸ä¼šåŒæ˜¯æ‰§è¡Œ;</div><div class="line">    (2) åœ¨RedisæœåŠ¡å™¨å¯ç”¨äºæ¢å¤æ•°æ®æ—¶ï¼Œä¼šä¼˜å…ˆä½¿ç”¨AOF;</div></pre></td></tr></table></figure><h2 id="Rediså¤åˆ¶"><a href="#Rediså¤åˆ¶" class="headerlink" title="Rediså¤åˆ¶:"></a>Rediså¤åˆ¶:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ç‰¹ç‚¹:</div><div class="line">    ä¸€ä¸ªMaster å¯ä»¥æœ‰å¤šä¸ªSlave;</div><div class="line">    æ”¯æŒé“¾å¼å¤åˆ¶;</div><div class="line">        Masterä»¥éé˜»å¡æ–¹å¼åŒæ­¥æ•°æ®è‡³slave; æ³¨:ä¸»æœåŠ¡å™¨ä¸å»ºè®®å…³é—­æŒä¹…åŒ–;</div><div class="line">slave:</div><div class="line">    &gt; SLAVEOF MASTER_IP MASTER_PORT</div><div class="line">    min-salves-to-write 3  # è‡³å°‘åº”è¯¥æœ‰ä¸‰ä¸ªä»èŠ‚ç‚¹ï¼Œå°äºä¸‰ä¸ªï¼Œç¦æ­¢ä¸»æœåŠ¡å™¨å†™æ“ä½œ;</div><div class="line">    min-salves-max-lag # ä»æœåŠ¡å™¨å¿…éœ€ä¸èƒ½æ»åäºæœåŠ¡å™¨10ç§’ä»¥ä¸Š;</div><div class="line">æ³¨æ„: å¦‚æœmasterä½¿ç”¨requirespasså¼€å¯äº†è®¤è¯åŠŸèƒ½ï¼Œä»æœåŠ¡å™¨è¦ä½¿ç”¨masterauth &lt;PASSWORD&gt;;</div><div class="line">    æ¥è¿å…¥æœåŠ¡è¯·æ±‚ä½¿ç”¨æ­¤å¯†ç è¿›è¡Œè®¤è¯;</div><div class="line">    </div><div class="line">sentinal: ä¸‡ä¸€ä¸»æœåŠ¡å™¨å²©äº†ï¼Œé‚£ä¹ˆå®ƒä¼šä»ä»æœåŠ¡å™¨èŠ‚ç‚¹ä¸­é€‰åˆ™ä¸€å°æœåŠ¡å™¨æˆä¸ºä¸»èŠ‚ç‚¹;</div><div class="line">    ä¸‡sentinal æ•…éšœï¼Œæˆ–è€…è¿æ¥ä¸ä¸Šä¸»èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦sentinalé…ç½®å¤šä¸ªèŠ‚ç‚¹;</div></pre></td></tr></table></figure><h2 id="sentinel"><a href="#sentinel" class="headerlink" title="sentinel:"></a>sentinel:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">ç”¨äºç®¡ç†å¤šä¸ªredisæœåŠ¡å®ç°HA;</div><div class="line">    ç›‘æ§;</div><div class="line">    é€šçŸ¥;</div><div class="line">    è‡ªåŠ¨æ•…éšœè½¬ç§»;</div><div class="line">    æœ¬è´¨ä¸Šï¼Œsentinelä¹Ÿæ˜¯redisçš„åˆ†å¸ƒå¼åŠŸèƒ½;</div><div class="line">    ä½¿ç”¨æµè¨€åè®®ã€æŠ•ç¥¨åè®®;</div><div class="line">ç¨‹åº:</div><div class="line">    redis-sentinel /path/to/file.conf</div><div class="line">    redis-server /path/to/file.conf</div><div class="line">(1) æœåŠ¡å™¨è‡ªèº«åˆå§‹åŒ–ï¼Œè¿è¡Œredis-serverä¸­ä¸“ç”¨äºsentinelåŠŸèƒ½çš„ä»£ç ;</div><div class="line">(2) åˆå§‹åŒ–sentinelçŠ¶æ€ï¼Œæ ¹æ®ç»™å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–ç›‘æ§çš„masteræœåŠ¡å™¨åˆ—è¡¨;</div><div class="line">(3) åˆ›å»ºè¿å‘masterçš„è¿æ¥ï¼›</div><div class="line">ä¸“ç”¨é…ç½®æ–‡ä»¶: /etc/redis-sentinel.conf</div><div class="line">(1) # sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</div><div class="line">    sentinel monitor mymaster  127.0.0.1 6379 2</div><div class="line">(2) # sentinel down-after-millisenconds &lt;master-name&gt; &lt;millisends&gt;</div><div class="line">    sentinel down-afer-millisenconds mymaster 3000</div><div class="line">(3) # sentinel parellel-syncs  &lt;master-name&gt; &lt;numslaves&gt;</div><div class="line">    seninel parallel-syncs mymaster 1 </div><div class="line">(4) # sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</div><div class="line">    sentinel failover-timeout mymaster 180000</div><div class="line"></div><div class="line">ä¸»è§‚ä¸‹çº¿,å®¢è§‚ä¸‹çº¿:</div><div class="line">    ä¸»è§‚ä¸‹çº¿: ä¸€ä¸ªsentinelå®ä¾‹åˆ¤æ–­å‡ºæŸèŠ‚ç‚¹ä¸‹çº¿:</div><div class="line">    å®¢è§‚ä¸‹çº¿:å¤šä¸ªseninel èŠ‚ç‚¹åå•†ååˆ¤æ–­å‡ºæŸèŠ‚ç‚¹ä¸‹çº¿:</div><div class="line"></div><div class="line">ä¸“ç”¨å‘½ä»¤:</div><div class="line">    SENTINEL masters</div><div class="line">    SENTINEL slaves &lt;master name&gt;</div><div class="line">    SENTINEL get-master-addr-by-name &lt;master name&gt;</div><div class="line">    SENTINEL reset</div><div class="line">    SENTINEL failover &lt;master name&gt;</div><div class="line"></div><div class="line">Clustering:</div><div class="line">    åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œé€šè¿‡åˆ†ç‰‡æœºåˆ¶è¿›è¡Œæ•°æ®åˆ†å¸ƒï¼Œclusteringå†…çš„æ¯ä¸ªå­èŠ‚ç‚¹ä»…æ•°æ®åº“çš„ä¸€éƒ¨åˆ†æ•°æ®;</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginxçš„å¸¸ç”¨æ¶æ„</title>
      <link href="/2018/04/26/nginx%E5%B8%B8%E7%94%A8%E6%9E%B6%E6%9E%84/"/>
      <url>/2018/04/26/nginx%E5%B8%B8%E7%94%A8%E6%9E%B6%E6%9E%84/</url>
      <content type="html"><![CDATA[<h1 id="Nginx-å¸¸ç”¨æ¶æ„"><a href="#Nginx-å¸¸ç”¨æ¶æ„" class="headerlink" title="Nginx å¸¸ç”¨æ¶æ„"></a>Nginx å¸¸ç”¨æ¶æ„</h1><p><img src="/images/nginx_001.png" alt=""></p><h2 id="LB-Cluster"><a href="#LB-Cluster" class="headerlink" title="LB Cluster"></a>LB Cluster</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">æå‡ç³»ç»Ÿå®¹é‡çš„æ–¹å¼:</div><div class="line">    scale up:</div><div class="line">    scale out:</div><div class="line"></div><div class="line">sessionä¿æŒæ–¹æ³•:</div><div class="line">    sessionç»‘å®š:sh</div><div class="line">    sessionå¤åˆ¶:</div><div class="line">    sessionæœåŠ¡å™¨: memchached redis (key-value,kv store)</div><div class="line">    å¯¹url åšhash è®¡ç®—åï¼Œåšä¸ºkey</div><div class="line">    å¯¹url å¯¹åº”çš„å†…å®¹åšä¸ºvalue</div></pre></td></tr></table></figure><h2 id="I-Oï¼š"><a href="#I-Oï¼š" class="headerlink" title="I/Oï¼š"></a>I/Oï¼š</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">åŒæ­¥/å¼‚æ­¥:è¢«è°ƒç”¨è€…ï¼Œåœ¨æ”¶åˆ°è°ƒç”¨è¯·æ±‚åï¼Œæ˜¯å¦ç«‹å³è¿”å›ã€‚è¿˜æ˜¯å¾—åˆ°æœ€ç»ˆç»“æœåæ‰è¿”å›ï¼› </div><div class="line">é˜»å¡/éé˜»å¡:è°ƒç”¨è€…å‘èµ·è°ƒç”¨ä¹‹åï¼Œåœ¨æ”¶åˆ°å“åº”ç»“æœä¹‹å‰ï¼Œæ˜¯å¦ä¼šè¢«æŒ‚èµ·ï¼Œè¢«æŒ‚èµ·ï¼Œè¢«ç§°ä¸ºé˜»å¡ï¼ŒéæŒ‚èµ·ä¸ºéé˜»å¡;</div><div class="line">I/Oç½‘ç»œç¼–ç¨‹æ¨¡å‹ä¸­ï¼Œå¸¸ç”¨ç½‘ç»œæ¨¡å‹æœ‰5ç§;</div><div class="line">1ã€åŒæ­¥é˜»å¡ </div><div class="line">2ã€åŒæ­¥éé˜»å¡</div><div class="line">3ã€å¤ç”¨å‹I/O</div><div class="line">4ã€(Event Driver) äº‹ä»¶é©±åŠ¨</div><div class="line">5ã€å¼‚æ­¥I/O</div><div class="line"></div><div class="line">libevent: é¡¹ç›®</div><div class="line">    epoll()</div><div class="line">å¯ä»¥å¯¹nginxè¿›ç¨‹å¯¹CPUçš„æ ¸å¿ƒæ•°æ¥è¿›è¡Œç»‘å®š;</div><div class="line">LRU:æœ€è¿‘æœ€å°‘ç¼“å­˜æ¡ç›®ç®—æ³•;</div><div class="line">å¹³æ»‘å‡çº§ï¼Œå¹³æ»‘æ•…éšœå¤„ç†ï¼Œæˆ–è€…ç°åº¦å‘å¸ƒ;</div><div class="line">å¯¹äºwebæœåŠ¡å™¨æ¥è¯´ï¼Œæ—¥å¿—è‡³å…³é‡è¦ï¼Œéœ€è¦å¯¹æ—¥å¿—è¿›è¡Œåˆ†æ;</div><div class="line">CacheManager: ç¼“å­˜çš„å¤±æ•ˆï¼Œè¿‡æœŸæ£€éªŒåŠæ¸…ç†æ“ä½œ;</div></pre></td></tr></table></figure><h2 id="Nginx-é…ç½®"><a href="#Nginx-é…ç½®" class="headerlink" title="Nginx é…ç½®"></a>Nginx é…ç½®</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">main, event, http åŸºäºcè¯­è¨€é£æ ¼ï¼›</div><div class="line"></div><div class="line">httpd&#123; </div><div class="line">    drective</div><div class="line">    server&#123;</div><div class="line">        listen</div><div class="line">        server_name</div><div class="line">        location&#123;</div><div class="line">            if &#123;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"> server &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="nginx-çš„å®‰è£…åŒ…"><a href="#nginx-çš„å®‰è£…åŒ…" class="headerlink" title="nginx çš„å®‰è£…åŒ…"></a>nginx çš„å®‰è£…åŒ…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># è¿™é‡Œé‡‡ç”¨çš„é‡‡ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„epelæº</div><div class="line"># cd /etc/yum.repos.d/epel.repo</div><div class="line">[epel]</div><div class="line">name=Extra Packages for Enterprise Linux 7 - $basearch</div><div class="line">enabled=1</div><div class="line">failovermethod=priority</div><div class="line">baseurl=http://mirrors.cloud.aliyuncs.com/epel/7/$basearch</div><div class="line">gpgcheck=0</div><div class="line">gpgkey=http://mirrors.cloud.aliyuncs.com/epel/RPM-GPG-KEY-EPEL-7</div><div class="line"># yum -y install nginx</div><div class="line"># rpm -q --scripts nginx # æŸ¥çœ‹nginx  çš„å®‰è£…å‰è„šæœ¬ï¼Œå¸è½½åè„šæœ¬;</div></pre></td></tr></table></figure><h2 id="ngx-http-proxy-module-æ¨¡å—"><a href="#ngx-http-proxy-module-æ¨¡å—" class="headerlink" title="ngx_http_proxy_module æ¨¡å—"></a>ngx_http_proxy_module æ¨¡å—</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen</div><div class="line">    server_name</div><div class="line">    location /&#123;</div><div class="line">        proxy_pass http://172.16.55.180:80/</div><div class="line">        proxy_set_header Host $host  # è®¾å®šè¯·æ±‚æŠ¥æ–‡çš„ï¼ŒHosté¦–éƒ¨ï¼Œä¸€èˆ¬apacheåŸºäºä¸»æœºåè§£æçš„é‡è¦é¦–éƒ¨ä¿¡æ¯;</div><div class="line">        proxy_set_header X-Real-IP $remote_addr;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"># è¯·æ±‚åˆ°ä»£ç†æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼ŒNingxæŠŠæŠ¥æ–‡æ‹†é™¤ï¼Œäº†è§£è¯·æ±‚çš„å†…å®¹æ˜¯ä»€ä¹ˆ;</div><div class="line"># äºæ˜¯Nginxéœ€è¦é‡æ–°æ„å»ºè¯·æ±‚æŠ¥æ–‡ ï¼Œæ¥é€åˆ°çš„åç«¯æœåŠ¡å™¨;</div><div class="line"># cipï¼ˆå®¢æˆ·ç«¯ ipï¼‰ --&gt; pip(ä»£ç†ip) --&gt; lip(æœ¬åœ°ip) --&gt; uip(åç«¯æœåŠ¡å™¨ip);</div><div class="line">http://www.ssjinyao.com</div><div class="line">http://mysql.ssjinyao.com</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"># åœ¨node1ä¸­é…ç½®ä¸€å°httpdæœåŠ¡</div><div class="line"># echo &quot;&lt;h1&gt;node1&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</div><div class="line"># systemctl start httpd </div><div class="line"># åœ¨node2ä¸­ é…ç½®ä¸€å°httpd æœåŠ¡</div><div class="line">echo &quot;&lt;h1&gt;node2&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</div><div class="line"># systemctl start httpd </div><div class="line"></div><div class="line">æ ¼å¼:</div><div class="line">    localtion /uri &#123;</div><div class="line">        proxy_pass http://back_server:port/newuri;</div><div class="line">    &#125;</div><div class="line">    # è¿™æ ·çš„é…ç½® uri å°†è¡¥åˆ°newuriçš„åé¢</div><div class="line">    location /uri &#123;</div><div class="line">        rewrite http://back_server:port/newuri</div><div class="line">        # proxy_pass http://back_server:port/newuri </div><div class="line">    &#125;</div><div class="line">    # è¿™æ ·çš„é…ç½® uri å°†é‡å†™åˆ°newuri   </div><div class="line">    /uri --&gt; /newuri</div><div class="line"># cd /etc/nginx/conf.d/</div><div class="line"># cp defalt.conf&#123;,.bak&#125;</div><div class="line"># vim default.conf</div><div class="line"></div><div class="line">server_name  www.ssjinyao.com;</div><div class="line">location / </div><div class="line">    &#123;</div><div class="line">    proxy_ass http://172.16.55.128/;</div><div class="line">    index index.htm index.html ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># systemctl restart nginx</div><div class="line"># tial -f /var/log/nginx/access.log</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"># åœ¨node2 apache ç«¯è¿›è¡Œç¼–è¾‘</div><div class="line"># mkdir /var/www/html/bbs</div><div class="line"># echo &quot;&lt;h1&gt; bbs on node2 &lt;/h1&gt;&quot; /var/www/html/bbs/index.html</div><div class="line"></div><div class="line"># å¯¹åº”çš„åœ¨nginx ç«¯</div><div class="line"></div><div class="line">location /bbs/ &#123;</div><div class="line">    proxy_pass http://172.16.55.128/bbs/;</div><div class="line">&#125;</div><div class="line"># nginx -t  or # sevice nginx configtest  </div><div class="line"># systemctl rsload nginx </div><div class="line"></div><div class="line"># æˆ–è€…å¯ä»¥ä½¿ç”¨forum</div><div class="line">location /forum/ &#123;</div><div class="line">    proxy_cache mycache;</div><div class="line">    proxy_cache_valid 200 1h;</div><div class="line">    proxy_cache_valid 301 302 10m;</div><div class="line">    proxy_cache_valid any 1m;</div><div class="line">    proxy_cache_use_statle error timeout invalid_header http_500 http_502 http_503 http504;  # ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨è¿‡æœŸç¼“å­˜</div><div class="line">    proxy_pass http://172.16.55.128/bbs/;</div><div class="line">    proxy_set_header Host $host;</div><div class="line">    proxy_set_header X-Real-IP $remote_addr;</div><div class="line">&#125;</div><div class="line"># nginx -t </div><div class="line"># systemctl reload nginx</div><div class="line"></div><div class="line">location ~* \.(jpg|png|gif)$ &#123;</div><div class="line">    proxy_pass http://172.16.55.128;</div><div class="line">    proxy_set_header Host $host;</div><div class="line">    proxy_set_header X-Real-IP $remote_addr;</div><div class="line">&#125;</div><div class="line"># nginx -t </div><div class="line"># systemctl reload nginx </div><div class="line"></div><div class="line"></div><div class="line"># æ³¨æ„ åœ¨location è¿›è¡Œæ­£åˆ™åŒ¹é…çš„æ¨¡å¼åŒ¹é…æ—¶</div><div class="line"># proxy_pass åŠ http://172.16.55.128; è¿™ä¸ªä½ç½®è¿™åä»€ä¹ˆéƒ½ä¸èƒ½å¸¦çš„ï¼Œ/ ä¹Ÿä¸èƒ½å¸¦çš„ï¼Œå¦åˆ™ä¼šæŠ¥è¯­æ³•é”™è¯¯; </div><div class="line"># apache è®°å½•å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¥å¿—,å‘åç«¯å‘é€ç‰¹å®šé¦–éƒ¨;</div><div class="line">éœ€è¦åœ¨Logformatä¸­åŠ å…¥ å°†ç¬¬ä¸€ä¸ªå€¼ %h æ¢æˆ%&#123;X-Real-IP&#125;i</div><div class="line"># systemctl restart httpd </div><div class="line"></div><div class="line"># å®šä¹‰proxyç¼“å­˜ </div><div class="line"># åœ¨nginx httpd æ®µä¸­é…ç½®cache path;</div><div class="line"># vim /etc/nginx/nginx.conf</div><div class="line">proxy_cache_path /cache/nginx/ level=1:1:1 keys_zone=mycache:32m;</div><div class="line"># mkdir -pv /cache/nginx</div><div class="line"># chown -R nginx.nginx /cache/nginx</div><div class="line"></div><div class="line"></div><div class="line">proxy_connect_timeout:  nginx  proxy è¯·æ±‚è¿æ¥åˆ°åç«¯è¿æ¥è¯·æ±‚çš„è¶…æ—¶æ—¶é•¿;</div><div class="line">proxy_hide_header: è®¾å®šå“åº”åˆ°å®¢æˆ·ç«¯æ—¶éœ€è¦éšè—çš„é¦–éƒ¨ä¿¡æ¯;â€˜</div><div class="line">proxy_buffers 8k; æŒ‡å®šç¼“å†²å¤§å°</div></pre></td></tr></table></figure><h2 id="upstream-è´Ÿè½½å‡è¡¡-æ¨¡å—"><a href="#upstream-è´Ÿè½½å‡è¡¡-æ¨¡å—" class="headerlink" title="upstream(è´Ÿè½½å‡è¡¡) æ¨¡å—"></a>upstream(è´Ÿè½½å‡è¡¡) æ¨¡å—</h2><p>upstream æ¨¡å—åªèƒ½ä½¿ç”¨åœ¨httpæ®µä¸­</p><p>ä¾‹å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># æ³¨ å¯ç”¨è´Ÿè½½å‡è¡¡æ—¶è¦æŠŠç¼“å­˜å…³äº†</div><div class="line">upstream backend &#123;</div><div class="line">    server www.ssjinyao.com weight=5 </div><div class="line">    server 127.0.0.1:8080  max_fails=3  fail_timeout=30s;</div><div class="line">    server unix:/tmp/backend3;</div><div class="line">    server backup1.ssjinyao.com backup;</div><div class="line">&#125; </div><div class="line"></div><div class="line">upstream upservers &#123;</div><div class="line">    ip hash;</div><div class="line">    server 172.16.55.127 max_fail=2  fail_timeout=2 # è‡ªå¸¦å¥åº·çŠ¶æ€æ£€æµ‹åŠŸèƒ½;</div><div class="line">    # server 172.16.55.128 weight=2;</div><div class="line">    server 172.16.55.129 bakup;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server_name  www.ssjinyao.com;</div><div class="line"></div><div class="line">location / &#123;</div><div class="line">    proxy_pass http://upservers/;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># nginx -t </div><div class="line"># systemctl reload nginx</div></pre></td></tr></table></figure><h3 id="SNATæ¨¡å¼çš„å¤§é‡çš„Client"><a href="#SNATæ¨¡å¼çš„å¤§é‡çš„Client" class="headerlink" title="SNATæ¨¡å¼çš„å¤§é‡çš„Client"></a>SNATæ¨¡å¼çš„å¤§é‡çš„Client</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">åŸºäºstickyå®ç°sessionç»‘å®š:</div><div class="line">    cookie è€Œæˆ‘ä»¬ä¸€èˆ¬å¸¸ç”¨çš„æ˜¯åŸºäºcookieçš„ç»‘å®š;</div><div class="line">    route</div><div class="line">    learn() éœ€è¦Nginx åœ¨ 1.8 ç‰ˆæœ¬ä»¥ä¸Š;</div><div class="line"></div><div class="line">example:</div><div class="line"></div><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com;</div><div class="line">    server backend2.example.com;</div><div class="line">    </div><div class="line">    sticky cookie srv_id expires=1h domain=.example.com path=/;</div><div class="line">&#125;</div><div class="line"></div><div class="line">least_conn:è°ƒåº¦æ–¹æ³•ï¼Œæœ€å°‘è¿æ¥;</div><div class="line"></div><div class="line">upstream memcached_backend &#123;</div><div class="line">    server 127.0.0.1:11211;</div><div class="line">    server 172.16.55.121:11211;</div><div class="line">    </div><div class="line">    keepavlie 32;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    location /memcached/ &#123;</div><div class="line">        set $memcached_key $uri;</div><div class="line">        memcached_pass memcached_backend;</div><div class="line">    &#125;  </div><div class="line">&#125;</div><div class="line"></div><div class="line">location / &#123;</div><div class="line">    proxy_pass http://backend;</div><div class="line">    health_check;</div><div class="line">&#125;</div><div class="line">    helth_check; å³å¥åº·çŠ¶æ€æ£€æŸ¥;</div><div class="line">    å»ºè®®: å…³é—­è®¿é—®æ—¥å¿—;</div><div class="line">    </div><div class="line">http &#123;</div><div class="line">    server &#123;</div><div class="line">    ...</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://backend;</div><div class="line">            health_check match=welcome; # åšå­—ç¬¦ä¸²åŒ¹é…;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">        metch welcome &#123;</div><div class="line">            status 200;</div><div class="line">            header Content-Type = text/html;</div><div class="line">            body ~ &quot;Welcome to nginx&quot;;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="Nginx-è‡ªå®šä¹‰é¦–éƒ¨ç»™å®¢æˆ·ç«¯"><a href="#Nginx-è‡ªå®šä¹‰é¦–éƒ¨ç»™å®¢æˆ·ç«¯" class="headerlink" title="Nginx è‡ªå®šä¹‰é¦–éƒ¨ç»™å®¢æˆ·ç«¯"></a>Nginx è‡ªå®šä¹‰é¦–éƒ¨ç»™å®¢æˆ·ç«¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"># ä»£ç†æœåŠ¡å™¨å“åº”ç»™å®¢æˆ·ç«¯æ—¶ï¼Œå¦‚ä½•è‡ªå®šä¹‰å“åº”é¦–éƒ¨;</div><div class="line">     listen 443;</div><div class="line">    server_name www.ssjinyao.com;</div><div class="line">    add_header SSJinYao-Server &apos;Next-SSJinYao&apos;;</div><div class="line">    add_header SSJinYao-IP $server_addr;</div><div class="line">    add_header X-Cache $upstream_cache_status;</div><div class="line">    add_header Name &apos;ssjinyao&apos;;</div><div class="line">    </div><div class="line"># curl -I https://www.ssjinyao.com  # å®šä¹‰å®Œå“åº”é¦–éƒ¨åï¼Œè¿›è¡ŒéªŒè¯;</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: nginx</div><div class="line">Date: Tue, 24 Apr 2018 07:24:37 GMT</div><div class="line">Content-Type: text/html; charset=UTF-8</div><div class="line">Content-Length: 39777</div><div class="line">Connection: keep-alive</div><div class="line">Vary: Accept-Encoding</div><div class="line">Last-Modified: Thu, 19 Apr 2018 09:14:18 GMT</div><div class="line">ETag: &quot;9b61-56a2fff0c14a1&quot;</div><div class="line">SSJinYao-Server: Next-SSJinYao</div><div class="line">SSJinYao-IP: 172.31.253.156</div><div class="line">X-Cache: HIT</div><div class="line">Name: ssjinyao</div><div class="line">Accept-Ranges: bytes</div></pre></td></tr></table></figure><h3 id="fast-cgi-ä½¿ç”¨"><a href="#fast-cgi-ä½¿ç”¨" class="headerlink" title="fast-cgi ä½¿ç”¨"></a>fast-cgi ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">LNMP</div><div class="line"># yum -y install php-fpm</div><div class="line"># rpm -ql php-fpm </div><div class="line"># vim /etc/php-fpm.d/www.conf</div><div class="line"># systemctl start php-fpm </div><div class="line"># vim /etc/nginx.conf.d/default.conf</div><div class="line"></div><div class="line">location / &#123;</div><div class="line">    root /usr/share/nginx/html;</div><div class="line">    index index.php index.html index.htm;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location ~\.php$ &#123;</div><div class="line">    fastcgi_cache fcgicache;</div><div class="line">    fastcgi_cache_valid 200 10m;</div><div class="line">    fastcgi_cache_valid 302 3m;</div><div class="line">    fastcgi_cache_valid any 1m;</div><div class="line">    root /usr/share/nginx/html;</div><div class="line">    fastcgi_pass 127.0.0.1:9000;</div><div class="line">    fastcgi_index indexphp;</div><div class="line">    fastcgi_param SCRIPT_FILENAME /scripts$fastcgi-script_naame;</div><div class="line">    indclude fastcgi_paramgs;</div><div class="line">&#125;</div><div class="line"># systemctl restart nginx</div><div class="line"># è‹¥è°ƒç”¨fastcgi å¤±è´¥ </div><div class="line"># ç¼–è¾‘/etc/nginx/fastcgi_paramsï¼Œå°†å…¶å†…å®¹æ›´æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼š</div><div class="line">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;</div><div class="line">fastcgi_param  SERVER_SOFTWARE    nginx;</div><div class="line">fastcgi_param  QUERY_STRING       $query_string;</div><div class="line">fastcgi_param  REQUEST_METHOD     $request_method;</div><div class="line">fastcgi_param  CONTENT_TYPE       $content_type;</div><div class="line">fastcgi_param  CONTENT_LENGTH     $content_length;</div><div class="line">fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</div><div class="line">fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;</div><div class="line">fastcgi_param  REQUEST_URI        $request_uri;</div><div class="line">fastcgi_param  DOCUMENT_URI       $document_uri;</div><div class="line">fastcgi_param  DOCUMENT_ROOT      $document_root;</div><div class="line">fastcgi_param  SERVER_PROTOCOL    $server_protocol;</div><div class="line">fastcgi_param  REMOTE_ADDR        $remote_addr;</div><div class="line">fastcgi_param  REMOTE_PORT        $remote_port;</div><div class="line">fastcgi_param  SERVER_ADDR        $server_addr;</div><div class="line">fastcgi_param  SERVER_PORT        $server_port;</div><div class="line">fastcgi_param  SERVER_NAME        $server_name;</div><div class="line"># nginx -s reload</div><div class="line"># yum -y install php-mysql mariadb maraidb-server</div><div class="line"># cd /usr/share/nginx/html</div><div class="line"># vim index.php</div><div class="line">&lt;?php </div><div class="line">    $conn = mysql_connect(&apos;127.0.0.1&apos;,&apos;root&apos;,&apos;&apos;);</div><div class="line">    if ($conn)</div><div class="line">        echo succ</div><div class="line">    else</div><div class="line">        echo fail;</div><div class="line">    mysql_close();</div><div class="line">?&gt;</div><div class="line"># å½“LNMP ç¯å¢ƒè·‘èµ·æ¥æ—¶ï¼Œå¯ä»¥é€šåŒ¹é…ååƒä»£ç†æ¥å®ç°åŠ¨é™åˆ†ç¦»;</div><div class="line">(1) rootä¸ºåŒä¸€è·¯å¾„;</div><div class="line">(2) rootä¸ºä¸åŒè·¯å¾„;</div><div class="line">    location \.php$&#123;</div><div class="line">        root /web/app/wp;</div><div class="line">    &#125;</div><div class="line">    location / &#123;</div><div class="line">        root /web/htdocs;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">(3) fpm server ä¸ºå¦ä¸€ä¸»æœº ;</div><div class="line"></div><div class="line">    location \.php$&#123;</div><div class="line">        fastcgi_pass fastcgi://172.16.55.129:9000;</div><div class="line">    &#125;</div><div class="line">    location / &#123;</div><div class="line">        root /web/htdocs;</div><div class="line">    &#125;</div><div class="line"># æ³¨: å¦‚æœåŠ¨æ€å†…å®¹èƒ½è¿‡ç¼“å­˜æ¥è¿›è¡ŒåŠ é€Ÿçš„è¯ï¼ŒåŠ é€Ÿæ•ˆæœæ˜¯éå¸¸æ˜æ˜¾ç¤ºçš„;</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MongoDB NOSQLçš„ä½¿ç”¨ã€åˆ†å¸ƒå¼æ­å»ºã€åˆ‡ç‰‡å­˜å‚¨</title>
      <link href="/2018/04/17/MongoDB%20NoSQL%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/04/17/MongoDB%20NoSQL%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<h1 id="MongoDB-NoSQLä½¿ç”¨"><a href="#MongoDB-NoSQLä½¿ç”¨" class="headerlink" title="MongoDB NoSQLä½¿ç”¨"></a>MongoDB NoSQLä½¿ç”¨</h1><p>NoSQL: Not Only SQL</p><p><img src="/images/mongodb_logo.png" alt=""></p><h2 id="å¸¸ç”¨éœ€æ±‚åŠå®ç°"><a href="#å¸¸ç”¨éœ€æ±‚åŠå®ç°" class="headerlink" title="å¸¸ç”¨éœ€æ±‚åŠå®ç°"></a>å¸¸ç”¨éœ€æ±‚åŠå®ç°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">å¤§æ•°æ®é—®é¢˜: BigData</div><div class="line">    å¹¶è¡Œæ•°æ®åº“ç³»ç»Ÿï¼Œæ— å…±äº«ä½“ç³»ç»“æ„ä¸­ï¼Œé‡‡ç”¨å…³ç³»ç»“æ„æ¨¡å‹ï¼ŒåƒMySQLçš„æ°´å¹³åˆ‡ç‰‡æŠ€æœ¯,åˆ†åŒºæŸ¥è¯¢;</div><div class="line">    NoSQLæ•°æ®åº“ç®¡ç†ç³»ç»Ÿ: ä¸æ˜¯ä¸€ç§å•ä¸€å•çº¯çš„æŠ€æœ¯ï¼Œéå…³ç³»æ¨¡å‹ã€åˆ†å¸ƒå¼ã€ä¸æ”¯æŒACIDæ•°æ®åº“è®¾è®¡èŒƒå¼;</div><div class="line">        ç®€å•æ•°æ®æ¨¡å‹;</div><div class="line">        å…ƒæ•°æ®å’Œæ•°æ®åˆ†ç¦»;</div><div class="line">        å¼±ä¸€è‡´æ€§;</div><div class="line">        é«˜ååé‡;</div><div class="line">        é«˜æ°´å¹³æ‰©å±•èƒ½åŠ›å’Œä½ç«¯ç¡¬ä»¶é›†ç¾¤;</div><div class="line">   NewSQLæ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</div><div class="line">        ç›¸å…³äº§å“: Clustrixã€ GenleDB ã€ScaleBaseã€NimbusDBã€mysql(NDBClusterã€Drizzle)</div><div class="line">    äº‘æ•°æ®ç®¡ç†ç³»ç»Ÿ:</div><div class="line">        ç›¸å…³äº§å“: DBAAS,RDS</div><div class="line"></div><div class="line">å¤§æ•°æ®çš„åˆ†æå¤„ç†:</div><div class="line">    å¸¸è§çš„æœ‰MapReduceæœºåˆ¶:å°†å¤§çš„æ•°æ®æ˜ å°„æˆé”®å€¼å¯¹ï¼Œè€Œåå¯¹å„å„é”®å€¼å¯¹å¤„ç†åè¿›è¡Œèšåˆ;</div><div class="line">    è€Œhadoop å°±æ˜¯ç±»ä¼¼äºè¿™ç§ç³»ç»Ÿ; habaseä¹Ÿæ˜¯NoSQLçš„ä¸€ç§;</div><div class="line">    CAP: å¼ºä¸€è‡´æ€§;å¯ç”¨æ€§;åˆ†åŒºå®¹é”™æ€§(å‡ºç°è„‘è£‚çš„æ—¶å€™å¯å¦å¤„ç†ä¸šåŠ¡éœ€æ±‚);</div><div class="line">        æœ€ç»ˆä¸€è‡´æ€§ç»†åˆ†:</div><div class="line">            å›°æœä¸€è‡´æ€§;</div><div class="line">            è¯»è‡ªå·±å†™ä¸€è‡´æ€§;</div><div class="line">            ä¼šè¯ä¸€è‡´æ€§;</div><div class="line">            å•è°ƒè¯»ä¸€è‡´æ€§;</div><div class="line">            æ—¶é—´è½´ä¸€è‡´æ€§;</div><div class="line">            </div><div class="line">    ACID &amp; BASE</div><div class="line">        Atomicity  åŸå­æ€§;</div><div class="line">        Consistency ä¸€è‡´æ€§;</div><div class="line">        Isolation éš”ç¦»æ€§ ;</div><div class="line">        Durability æŒä¹…æ€§;</div><div class="line">        BASE åŸºæœ¬å¯ç”¨;</div><div class="line">        </div><div class="line">    ACIDç‰¹æ€§: å¼ºä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€é‡‡ç”¨æ‚²è§‚ä¿å®ˆçš„æ–¹æ³•ã€éš¾ä»¥å˜åŒ–;</div><div class="line">    BASEç‰¹æ€§: å¼±ä¸€è‡´æ€§ã€å¯ç”¨æ€§ä¼˜å…ˆã€é‡‡ç”¨ä¹è§‚çš„æ–¹æ³•ã€æ›´ç®€å•ã€æ›´å¿«;</div><div class="line"></div><div class="line">    æ•°æ®ä¸€è‡´æ€§çš„å®ç°æŠ€æœ¯:</div><div class="line">            NRW</div><div class="line">            2PC</div><div class="line">            Paxos</div><div class="line">            Vecotr Clock </div><div class="line"></div><div class="line">æ•°æ®å­˜å‚¨æ¨¡å‹:   www.nosql-databases.org</div><div class="line">    åˆ—å¼å­˜å‚¨æ¨¡å‹ </div><div class="line">    æ–‡æ¡£å­˜å‚¨æ¨¡å‹</div><div class="line">    é”®å€¼æ•°æ®æ¨¡å‹</div><div class="line">    å›¾å¼æ•°æ®æ¨¡å‹</div><div class="line">    åˆ—å¼æ¨¡å‹:</div><div class="line">        åº”ç”¨åœºæ™¯: åœ¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šæä¾›æ”¯æŒéšæœºè¯»å†™åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨;</div><div class="line">        å…¸å‹äº§å“: HBaseã€Hypertableã€Cassandra</div><div class="line">        æ•°æ®æ¨¡å‹: ä»¥&quot;åˆ—&quot;ä¸ºä¸­å¿ƒè¿›è¡Œå­˜å‚¨ ï¼Œå°†åŒä¸€åˆ—æ•°æ®å­˜å‚¨åœ¨ä¸€èµ·;</div><div class="line">        ä¼˜ç‚¹: å¿«é€ŸæŸ¥è¯¢ã€é«˜å¯æ‰©å±•æ€§ã€æ˜“äºå®ç°åˆ†å¸ƒå¼æ‰©å±•;</div><div class="line">    </div><div class="line">    æ–‡æ¡£æ¨¡å‹:</div><div class="line">        åº”ç”¨åœºæ™¯:éå¼ºäº‹åŠ¡éœ€æ±‚çš„webåº”ç”¨;</div><div class="line">        å…¸å‹äº§å“:MongoDBã€ElasticSearch(æ„å»ºçš„æœç´¢å¼•æ“å·¥å…·)ã€CouchDBã€CouchBase Server</div><div class="line">        æ•°æ®æ¨¡å‹: é”®å€¼æ¨¡å‹ï¼Œå­˜å‚¨ä¸ºæ–‡æ¡£;</div><div class="line">        ä¼˜ç‚¹: æ•°æ®æ¨¡å‹æ— éœ€äº‹å…ˆå®šä¹‰</div><div class="line">        </div><div class="line">    é”®å€¼æ¨¡å‹:</div><div class="line">        åº”ç”¨åœºæ™¯: å†…å®¹ç¼“å­˜ï¼Œç”¨äºå¤§é‡å¹¶è¡Œæ•°æ®è®¿é—®é«˜è½½åœºæ™¯;</div><div class="line">        å…¸å‹äº§å“: Redisã€DynamoDBã€Riakã€Redis;</div><div class="line">        æ•°æ®æ¨¡å‹: åŸºäºå“ˆå¸Œè¡¨å®ç°çš„key-valueæ¨¡å‹;</div><div class="line">        ä¼˜ç‚¹: æŸ¥è¯¢è¿…é€Ÿï¼Œ ç¼ºç‚¹ï¼šæ•°æ®æ²¡æœ‰ç»“æ„;</div><div class="line">        </div><div class="line">    å›¾å¼æ¨¡å‹:</div><div class="line">        åº”ç”¨åœºæ™¯: ç¤¾äº¤ç½‘ç»œã€æ¨èç³»ç»Ÿã€å…³ç³»å›¾æ™®</div><div class="line">        å…¸å‹äº§å“: Neo4J  ã€TITAN ã€ Infinite Graph</div><div class="line">        æ•°æ®æ¨¡å‹: å›¾å¼ç»“æ„</div><div class="line">        ä¼˜ç‚¹: é€‚åº”äºå›¾å¼è®¡ç®—åœºæ™¯</div><div class="line"></div><div class="line">MongoDB: NoSQLã€æ–‡æ¡£å­˜å‚¨ã€Jsonæ•°æ®æ¨¡å‹</div><div class="line">    é€‚ç”¨åœºæ™¯: </div><div class="line">        Websites</div><div class="line">        Caching</div><div class="line">        High volume, low value</div><div class="line">        High scalability </div><div class="line">        Storage of program objects and json</div><div class="line">     ä¸é€‚ç”¨åœºæ™¯:</div><div class="line">        Hightly transactional</div><div class="line">        Ad-hoc business intelligence</div><div class="line">        Problems requiring SQL</div></pre></td></tr></table></figure><h2 id="mongo-çš„å®‰è£…ä¸ä½¿ç”¨"><a href="#mongo-çš„å®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="mongo çš„å®‰è£…ä¸ä½¿ç”¨"></a>mongo çš„å®‰è£…ä¸ä½¿ç”¨</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> # vim /etc/yum.repos.d/mongodb.repo</div><div class="line"> [mongodb-org-3.4]  </div><div class="line">name=MongoDB Repository  </div><div class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/  </div><div class="line">gpgcheck=1  </div><div class="line">enabled=1  </div><div class="line">gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc</div><div class="line"># yum clean all</div><div class="line"># yum makeacahe</div><div class="line"># yum -y install mongodb-org</div></pre></td></tr></table></figure><h3 id="serveråŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶"><a href="#serveråŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶" class="headerlink" title="serveråŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶"></a>serveråŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># rpm -ql mongodb-org-server</div><div class="line">/etc/mongod.conf</div><div class="line">/lib/systemd/system/mongod.service</div><div class="line">/usr/bin/mongod</div><div class="line">/var/lib/mongo</div><div class="line">/var/log/mongodb</div><div class="line">/var/log/mongodb/mongod.log</div><div class="line">/var/run/mongodb</div></pre></td></tr></table></figure><h3 id="shellåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶"><a href="#shellåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶" class="headerlink" title="shellåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶"></a>shellåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># rpm -ql mongodb-org-shell</div><div class="line">/usr/bin/mongo</div></pre></td></tr></table></figure><h3 id="toolsåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶"><a href="#toolsåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶" class="headerlink" title="toolsåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶"></a>toolsåŒ…ç”Ÿæˆçš„å…³é”®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># rpm -ql mongodb-org-tools</div><div class="line">/usr/bin/bsondump</div><div class="line">/usr/bin/mongodump</div><div class="line">/usr/bin/mongoexport</div><div class="line">/usr/bin/mongofiles</div><div class="line">/usr/bin/mongoimport</div><div class="line">/usr/bin/mongooplog</div><div class="line">/usr/bin/mongoperf</div><div class="line">/usr/bin/mongorestore</div><div class="line">/usr/bin/mongostat</div><div class="line">/usr/bin/mongotop</div></pre></td></tr></table></figure><h3 id="serverç«¯é…ç½®é¡¹"><a href="#serverç«¯é…ç½®é¡¹" class="headerlink" title="serverç«¯é…ç½®é¡¹"></a>serverç«¯é…ç½®é¡¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># vim /etc/mongod.conf</div></pre></td></tr></table></figure><h3 id="MongoåŸºæœ¬æ“ä½œ"><a href="#MongoåŸºæœ¬æ“ä½œ" class="headerlink" title="MongoåŸºæœ¬æ“ä½œ"></a>MongoåŸºæœ¬æ“ä½œ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">help # æŸ¥çœ‹å¸¸ç”¨çš„ä½¿ç”¨å¸®åŠ©å‘½ä»¤;</div><div class="line">db.help() # æŸ¥çœ‹å¯¹åº“æ“ä½œçš„ä½¿ç”¨å¸®åŠ©;</div><div class="line">db.mycoll.cind().help()</div><div class="line">db.mycoll.help()</div><div class="line">show dbs # æŸ¥çœ‹ç›®å‰å­˜åœ¨å“ªäº›åº“;</div><div class="line">show collections # åˆ—å‡ºåˆ—è¡¨;</div><div class="line">use testdb # åˆ‡æ¢è‡³å“ªä¸ªåº“ï¼Œæˆ–è€…æ–°å»ºå“ªä¸ªåº“ </div><div class="line">db.status() #æŸ¥çœ‹å½“å‰åº“çš„çŠ¶æ€;</div><div class="line">db.version() # æŸ¥çœ‹å½“å‰åº“çš„ç‰ˆæœ¬;</div><div class="line">db.serverStatus() # æŸ¥çœ‹å½“å‰MongoDBæœåŠ¡çš„çŠ¶æ€;</div><div class="line">show users # æŸ¥çœ‹å½“å‰å­˜åœ¨å“ªäº›ç”¨æˆ·;</div><div class="line">show logs # æŸ¥çœ‹Mongoå¼€å¯äº†å“ªäº›æ—¥å¿—è®°å½•;</div><div class="line">user db.help() # æŸ¥å¯»å¸®åŠ©;</div><div class="line">db.getCollectionNames() # æŸ¥çœ‹åˆ—è¡¨åç§°;</div><div class="line">db.students.status() #æŸ¥çœ‹æŸä¸ªåº“ï¼ŒæŸå¼ è¡¨çš„çŠ¶æ€;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Collection Query Criteria Modifier</div><div class="line">db.users.find( &#123;age: &#123;$gt: 18&#125; &#125; ).sort( &#123;age: 1&#125; )</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">JSON: JavaScript Object Notation</div><div class="line">    åç§°/å€¼å¯¹è±¡çš„é›†åˆ;</div><div class="line">    å€¼çš„æœ‰åºåˆ—è¡¨;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">db.students.inert( &#123;name:&quot;tome&quot;, age:23&#125; )</div><div class="line">show clollections</div><div class="line">show dbs</div><div class="line">db.status</div><div class="line">db.students.stats()</div><div class="line">db.getCollectionNames()</div><div class="line">db.students.insert([name:&apos;&apos;renjin&quot;,age:23,gender:&quot;M&quot;])</div><div class="line">db.students.find() </div><div class="line">db.students.insert([name:&quot;ssjinyao&quot;,Age:23,Course:&quot;PieXieJianFa&quot;])</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">find() çš„é«˜çº§ç”¨æ³•:</div><div class="line">    æ¯”è¾ƒæ“ä½œ:</div><div class="line">        $gt, è¯­æ³•æ ¼å¼&#123;filed: &#123;$gt VALUE&#125;&#125;</div><div class="line">db.statuents.find(&#123;Age:&#123;$gt 23&#125;&#125;)</div><div class="line">        $gte</div><div class="line">        $lt</div><div class="line">        $lte</div><div class="line">        $ne</div><div class="line">        $in,è¯­æ³•æ ¼å¼&#123;filed: &#123;$in: [&apos;value&apos;]&#125;&#125;</div><div class="line">db.students.find&#123;Age:&#123;$in: [20,23]&#125;&#125;</div><div class="line">ç»„åˆæ¡ä»¶: é€»è¾‘è¿ç®—</div><div class="line">        $or: æˆ–è¿ç®—ï¼Œè¯­æ³•æ ¼å¼&#123;$or: &#123;&lt;expression1&gt;,...&#125;&#125;</div><div class="line">db.students.find(&#123;$or: &#123;Age: &#123;$nin: [20,40], age &#123;$nin:[20,40]&#125;&#125;&#125;)</div><div class="line">db.students.find(&#123;$or: [&#123;Age: &#123;$nin: [20,40]&#125;&#125;, &#123;age: &#123;$nin:  [20,40]&#125;&#125;]&#125;)</div><div class="line">        $and: ä¸è¿ç®—</div><div class="line">        $not: éè¿ç®—</div><div class="line">        $nor: åè¿ç®—,è¿”å›ä¸ç¬¦æŒ‡å®šä»¶çš„æ‰€æœ‰æ–‡æ¡£</div><div class="line"></div><div class="line">å…ƒç´ æŸ¥è¯¢: æ ¹æ®æ–‡æ¡£ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­—æ®µè¿›è¡ŒæŸ¥è¯¢;</div><div class="line">        $exists: è¯­æ³•æ ¼å¼&#123;$filed:&#123;$exists:&lt;boolean&gt;&#125;&#125;</div><div class="line">        db.students.find(&#123;gender: &#123;$exits: false&#125;&#125;)</div><div class="line">        $mod: </div><div class="line">        $type: è¿”å›æŒ‡å®šçš„å­—æ®µçš„å€¼çš„ç±»å‹ä¸ºæŒ‡å®šç±»å‹çš„æ–‡æ¡£,è¯­æ³•æ ¼å¼&#123;field:&#123;$type: &lt;BSON type&gt;&#125;&#125;</div><div class="line">            Double,String,Object, Arrary, Binary data, Undefined, Boolean,Data ,Null, Regular Expression, JavaScript, Timestamp</div><div class="line"></div><div class="line">æ›´æ–°æ“ä½œ:</div><div class="line">    db.mycoll.update()</div><div class="line">        $set: ä¿®æ”¹å­—æ®µçš„å€¼ä¸ºæ–°æŒ‡å®šçš„å€¼: è¯­æ³•æ ¼å¼&#123;filed: value&#125;, &#123;$set: &#123;filed: new_value&#125;&#125;)</div><div class="line">        $unset: åˆ é™¤æŒ‡å®šå­—æ®µ;è¯­æ³•æ ¼å¼(&#123;filed: value&#125;, &#123;$unset:&#123;filed1, field2,....&#125;&#125;)</div><div class="line">    db.students.update(&#123;name: &quot;renjin&quot;&#125;, &#123;$set: &#123;age: 22&#125;&#125;)</div><div class="line">        $rename: æ›´æ”¹å­—æ®µå,è¯­æ³•æ ¼å¼(&#123;$rename: &#123;oldname: newname, oldname: newname&#125;&#125;)</div><div class="line">    db.students.update(&#123;$rename: &#123;age:Age&#125;)</div><div class="line">        $inc</div><div class="line"></div><div class="line">åˆ é™¤æ“ä½œ:</div><div class="line">    db.mycoll.remove(&lt;query&gt;,&lt;justOne&gt;)</div><div class="line">    db.students.remove(&#123;age:21&#125;)</div><div class="line">    db.students.findOne(&#123;Age: &#123;$gt:10&#125;&#125;)</div><div class="line">åˆ é™¤collection:</div><div class="line">    db.mycoll.drop()</div><div class="line">    db.studetns.drop()</div><div class="line">åˆ é™¤database:</div><div class="line">    db.dropDatabase()</div><div class="line"></div><div class="line">php+mongodb</div><div class="line">    phpçš„mongoæ‰©å±•</div></pre></td></tr></table></figure><h2 id="MongoDB-Indexes-and-Administration"><a href="#MongoDB-Indexes-and-Administration" class="headerlink" title="MongoDB Indexes and Administration"></a>MongoDB Indexes and Administration</h2><h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><p>ç±»å‹: B+ Treeã€hashã€ç©ºé—´ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">MongoDBç´¢å¼•ç±»å‹ </div><div class="line">    å•å­—æ®µç´¢å¼•</div><div class="line">    ç»„åˆç´¢å¼•(å¤šå­—æ®µç´¢å¼•)</div><div class="line">    å¤šé”®ç´¢å¼•</div><div class="line">    ç©ºé—´ç´¢å¼•</div><div class="line">    æ–‡æœ¬ç´¢å¼•</div><div class="line">    hashç´¢å¼•  hash ç´¢å¼•åªæ”¯æŒç²¾ç¡®å€¼æŸ¥æ‰¾</div><div class="line">    db.people.ensureIndex(&#123; zipcode:1&#125;, &#123;background: ture&#125;)</div><div class="line">    db.account.ensureIndex( &#123; username: 1 &#125; , &#123;unique: ture, dropDups: true &#125;)</div><div class="line">    </div><div class="line">MongoDBä¸ç´¢å¼•ç›¸å…³çš„æ–¹æ³•:</div><div class="line">    db.mycoll.ensureIndex(field[,options])</div><div class="line">        nameã€uniqueã€dropDupsã€sparse</div><div class="line">    db.mycoll.dropIndex(index_name)</div><div class="line">    db.mycoll.dropIndexes()</div><div class="line">    db.mycoll.getIndexes()</div><div class="line">    db.mycoll.reIndex()</div></pre></td></tr></table></figure><h3 id="mongodb-ç”¨for-å¾ªç¯æ¥è¿ç»­æ’å…¥æ•°æ®"><a href="#mongodb-ç”¨for-å¾ªç¯æ¥è¿ç»­æ’å…¥æ•°æ®" class="headerlink" title="mongodb ç”¨for å¾ªç¯æ¥è¿ç»­æ’å…¥æ•°æ®"></a>mongodb ç”¨for å¾ªç¯æ¥è¿ç»­æ’å…¥æ•°æ®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">use testdb</div><div class="line">for (i=1; i&lt;=1000;i++) db.students.insert(&#123;name:&quot;student&quot;+i, age:(i%120), address:&quot;#85 Wenhua Road, Zhengzhou, China&quot;&#125;)</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56c&quot;), &quot;name&quot; : &quot;student1&quot;, &quot;age&quot; : 1, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56d&quot;), &quot;name&quot; : &quot;student2&quot;, &quot;age&quot; : 2, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56e&quot;), &quot;name&quot; : &quot;student3&quot;, &quot;age&quot; : 3, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d56f&quot;), &quot;name&quot; : &quot;student4&quot;, &quot;age&quot; : 4, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d570&quot;), &quot;name&quot; : &quot;student5&quot;, &quot;age&quot; : 5, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d571&quot;), &quot;name&quot; : &quot;student6&quot;, &quot;age&quot; : 6, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d572&quot;), &quot;name&quot; : &quot;student7&quot;, &quot;age&quot; : 7, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d573&quot;), &quot;name&quot; : &quot;student8&quot;, &quot;age&quot; : 8, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d574&quot;), &quot;name&quot; : &quot;student9&quot;, &quot;age&quot; : 9, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d575&quot;), &quot;name&quot; : &quot;student10&quot;, &quot;age&quot; : 10, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d576&quot;), &quot;name&quot; : &quot;student11&quot;, &quot;age&quot; : 11, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d577&quot;), &quot;name&quot; : &quot;student12&quot;, &quot;age&quot; : 12, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d578&quot;), &quot;name&quot; : &quot;student13&quot;, &quot;age&quot; : 13, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d579&quot;), &quot;name&quot; : &quot;student14&quot;, &quot;age&quot; : 14, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57a&quot;), &quot;name&quot; : &quot;student15&quot;, &quot;age&quot; : 15, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57b&quot;), &quot;name&quot; : &quot;student16&quot;, &quot;age&quot; : 16, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57c&quot;), &quot;name&quot; : &quot;student17&quot;, &quot;age&quot; : 17, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57d&quot;), &quot;name&quot; : &quot;student18&quot;, &quot;age&quot; : 18, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57e&quot;), &quot;name&quot; : &quot;student19&quot;, &quot;age&quot; : 19, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d57f&quot;), &quot;name&quot; : &quot;student20&quot;, &quot;age&quot; : 20, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">Type &quot;it&quot; for more</div><div class="line">&gt; it</div><div class="line"># mongoä¸ºäº†ç»“çœæœåŠ¡å™¨èµ„æºï¼Œä¸ä¼šå°†æ‰€æœ‰çš„å­—æ®µä¸€ä¸‹å­åˆ—å‡ºæ¥ï¼Œè€Œéœ€è¦è¾“å…¥itæ¥ç¿»é¡µæŸ¥çœ‹ï¼Œä¸moreç±»ä¼¼</div></pre></td></tr></table></figure><h3 id="åœ¨name-1-ä¸Šæ„å»ºå‡åºç´¢å¼•"><a href="#åœ¨name-1-ä¸Šæ„å»ºå‡åºç´¢å¼•" class="headerlink" title="åœ¨name 1 ä¸Šæ„å»ºå‡åºç´¢å¼•"></a>åœ¨name 1 ä¸Šæ„å»ºå‡åºç´¢å¼•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"> db.students.ensureIndex(&#123;name: 1&#125;)</div><div class="line">&#123;</div><div class="line">        &quot;createdCollectionAutomatically&quot; : false,</div><div class="line">        &quot;numIndexesBefore&quot; : 1,</div><div class="line">        &quot;numIndexesAfter&quot; : 2,</div><div class="line">        &quot;ok&quot; : 1</div><div class="line">&#125;</div><div class="line"> db.students.getIndexes()</div><div class="line">[</div><div class="line">        &#123;</div><div class="line">                &quot;v&quot; : 2,</div><div class="line">                &quot;key&quot; : &#123;</div><div class="line">                        &quot;_id&quot; : 1</div><div class="line">                &#125;,</div><div class="line">                &quot;name&quot; : &quot;_id_&quot;,</div><div class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">                &quot;v&quot; : 2,</div><div class="line">                &quot;key&quot; : &#123;</div><div class="line">                        &quot;name&quot; : 1</div><div class="line">                &#125;,</div><div class="line">                &quot;name&quot; : &quot;name_1&quot;,</div><div class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</div><div class="line">        &#125;</div><div class="line">]</div></pre></td></tr></table></figure><h3 id="ç§»é™¤ä¹‹å‰å»ºç«‹çš„ç´¢å¼•"><a href="#ç§»é™¤ä¹‹å‰å»ºç«‹çš„ç´¢å¼•" class="headerlink" title="ç§»é™¤ä¹‹å‰å»ºç«‹çš„ç´¢å¼•"></a>ç§»é™¤ä¹‹å‰å»ºç«‹çš„ç´¢å¼•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">db.students.dropIndex(&quot;name_1&quot;)</div><div class="line">&#123; &quot;nIndexesWas&quot; : 2, &quot;ok&quot; : 1 &#125;</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹ç´¢å¼•æ˜¯å¦è¢«ç§»é™¤"><a href="#æŸ¥çœ‹ç´¢å¼•æ˜¯å¦è¢«ç§»é™¤" class="headerlink" title="æŸ¥çœ‹ç´¢å¼•æ˜¯å¦è¢«ç§»é™¤"></a>æŸ¥çœ‹ç´¢å¼•æ˜¯å¦è¢«ç§»é™¤</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> db.students.getIndexes()</div><div class="line">[</div><div class="line">        &#123;</div><div class="line">                &quot;v&quot; : 2,</div><div class="line">                &quot;key&quot; : &#123;</div><div class="line">                        &quot;_id&quot; : 1</div><div class="line">                &#125;,</div><div class="line">                &quot;name&quot; : &quot;_id_&quot;,</div><div class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</div><div class="line">        &#125;</div><div class="line">]</div></pre></td></tr></table></figure><h3 id="å»ºç«‹ç»´ä¸€é”®ç´¢å¼•"><a href="#å»ºç«‹ç»´ä¸€é”®ç´¢å¼•" class="headerlink" title="å»ºç«‹ç»´ä¸€é”®ç´¢å¼•"></a>å»ºç«‹ç»´ä¸€é”®ç´¢å¼•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">db.students.ensureIndex(&#123;name: 1&#125;,&#123;unique: true&#125;)</div><div class="line">&#123;</div><div class="line">        &quot;createdCollectionAutomatically&quot; : false,</div><div class="line">        &quot;numIndexesBefore&quot; : 1,</div><div class="line">        &quot;numIndexesAfter&quot; : 2,</div><div class="line">        &quot;ok&quot; : 1</div><div class="line">&#125;</div><div class="line">&gt; </div><div class="line">&gt; </div><div class="line">&gt; db.students.getIndexes()</div><div class="line">[</div><div class="line">        &#123;</div><div class="line">                &quot;v&quot; : 2,</div><div class="line">                &quot;key&quot; : &#123;</div><div class="line">                        &quot;_id&quot; : 1</div><div class="line">                &#125;,</div><div class="line">                &quot;name&quot; : &quot;_id_&quot;,</div><div class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">                &quot;v&quot; : 2,</div><div class="line">                &quot;unique&quot; : true,</div><div class="line">                &quot;key&quot; : &#123;</div><div class="line">                        &quot;name&quot; : 1</div><div class="line">                &#125;,</div><div class="line">                &quot;name&quot; : &quot;name_1&quot;,</div><div class="line">                &quot;ns&quot; : &quot;testdb.students&quot;</div><div class="line">        &#125;</div><div class="line">]</div></pre></td></tr></table></figure><h3 id="åˆ©ç”¨ç´¢å¼•å¿«é€ŸæŸ¥è¯¢"><a href="#åˆ©ç”¨ç´¢å¼•å¿«é€ŸæŸ¥è¯¢" class="headerlink" title="åˆ©ç”¨ç´¢å¼•å¿«é€ŸæŸ¥è¯¢"></a>åˆ©ç”¨ç´¢å¼•å¿«é€ŸæŸ¥è¯¢</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">db.students.find(&#123;name: &quot;student500&quot;&#125;)</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;5acdb56cdf2f304c1068d75f&quot;), &quot;name&quot; : &quot;student500&quot;, &quot;age&quot; : 20, &quot;address&quot; : &quot;#85 Wenhua Road, Zhengzhou, China&quot; &#125;</div><div class="line">db.students.find(&#123;name: &quot;student500&quot;&#125;).explain()</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹ç´¢å¼•æ‰§è¡Œè¿‡ç¨‹"><a href="#æŸ¥çœ‹ç´¢å¼•æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="æŸ¥çœ‹ç´¢å¼•æ‰§è¡Œè¿‡ç¨‹"></a>æŸ¥çœ‹ç´¢å¼•æ‰§è¡Œè¿‡ç¨‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">        &quot;queryPlanner&quot; : &#123;</div><div class="line">                &quot;plannerVersion&quot; : 1,</div><div class="line">                &quot;namespace&quot; : &quot;testdb.students&quot;,</div><div class="line">                &quot;indexFilterSet&quot; : false,</div><div class="line">                &quot;parsedQuery&quot; : &#123;</div><div class="line">                        &quot;name&quot; : &#123;</div><div class="line">                                &quot;$eq&quot; : &quot;student500&quot;</div><div class="line">                        &#125;</div><div class="line">                &#125;,</div><div class="line">                &quot;winningPlan&quot; : &#123;</div><div class="line">                        &quot;stage&quot; : &quot;FETCH&quot;,</div><div class="line">                        &quot;inputStage&quot; : &#123;</div><div class="line">                                &quot;stage&quot; : &quot;IXSCAN&quot;,</div><div class="line">                                &quot;keyPattern&quot; : &#123;</div><div class="line">                                        &quot;name&quot; : 1</div><div class="line">                                &#125;,</div><div class="line">                                &quot;indexName&quot; : &quot;name_1&quot;,</div><div class="line">                                &quot;isMultiKey&quot; : false,</div><div class="line">                                &quot;multiKeyPaths&quot; : &#123;</div><div class="line">                                        &quot;name&quot; : [ ]</div><div class="line">                                &#125;,</div><div class="line">                                &quot;isUnique&quot; : true,</div><div class="line">                                &quot;isSparse&quot; : false,</div><div class="line">                                &quot;isPartial&quot; : false,</div><div class="line">                                &quot;indexVersion&quot; : 2,</div><div class="line">                                &quot;direction&quot; : &quot;forward&quot;,</div><div class="line">                                &quot;indexBounds&quot; : &#123;</div><div class="line">                                        &quot;name&quot; : [</div><div class="line">                                                &quot;[\&quot;student500\&quot;, \&quot;student500\&quot;]&quot;</div><div class="line">                                        ]</div><div class="line">                                &#125;</div><div class="line">                        &#125;</div><div class="line">                &#125;,</div><div class="line">                &quot;rejectedPlans&quot; : [ ]</div><div class="line">        &#125;,</div><div class="line">        &quot;serverInfo&quot; : &#123;</div><div class="line">                &quot;host&quot; : &quot;ssjinyao&quot;,</div><div class="line">                &quot;port&quot; : 27017,</div><div class="line">                &quot;version&quot; : &quot;3.4.14&quot;,</div><div class="line">                &quot;gitVersion&quot; : &quot;fd954412dfc10e4d1e3e2dd4fac040f8b476b268&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;ok&quot; : 1</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Mongodçš„å¸¸ç”¨å…ˆé¡¹"><a href="#Mongodçš„å¸¸ç”¨å…ˆé¡¹" class="headerlink" title="Mongodçš„å¸¸ç”¨å…ˆé¡¹:"></a>Mongodçš„å¸¸ç”¨å…ˆé¡¹:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">General option:  é€šç”¨é€‰é¡¹</div><div class="line">    fork = &#123;true|false&#125;: mongodæ˜¯å¦è¿è¡Œåœ¨åå°;</div><div class="line">    bind_ip = IP: æŒ‡å®šç›‘å¬çš„åœ°å€;</div><div class="line">    port=PORT:æŒ‡å®šç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤ä¸º27017ï¼Œhttpdè®¿é—®28017;</div><div class="line">    maxConns=: å¹¶å‘æœ€å¤§è¿æ¥æ•°;</div><div class="line">    pidfilepath=: pid æ–‡ä»¶ä½ç½®;</div><div class="line">    httpinterface=:å†…ç½®httpdç»Ÿè®¡ä¿¡æ¯ç­‰;</div><div class="line">    keyFile=:ä¸»ä»åŒæ­¥åŸºäºå¯†é’¥çš„è®¤è¯;</div><div class="line">    auth: æ˜¯å¦å¼€å¯è®¤è¯åŠŸèƒ½;</div><div class="line">    repair: æœåŠ¡å™¨æ„å¤–é‡å¯ï¼Œæˆ–æœªæ­£é‡å…³é—­æ—¶ï¼Œè¦ä½¿ç”¨repairæ¥ä¿®å¤;</div><div class="line">    journal:æ˜¯å¦å¯ç”¨æ—¥å¿—åŠŸèƒ½;</div><div class="line">    jounalCommit: æ—¥å¿—æäº¤çš„æ—¶é—´é—´éš”;</div><div class="line">    cpu: é—´æ–­æ€§çš„æ˜¾ç¤ºå†…å­˜CPUçš„ä½¿ç”¨ç‡;</div><div class="line">    slowms arg: è¶…å‡ºæŒ‡å®šå€¼åé‡‡ç”¨æ…¢æŸ¥è¯¢;    </div><div class="line">Replication options å¤åˆ¶é€‰é¡¹</div><div class="line">Master/slvae options ä¸»ä»å¤åˆ¶é€‰é¡¹</div><div class="line">Replica set options å¤åˆ¶é›†é€‰é¡¹</div><div class="line">Sharding options è·Ÿåˆ‡ç‰‡ç›¸å…³çš„é€‰é¡¹</div></pre></td></tr></table></figure><h3 id="MongoDBçš„å¤åˆ¶åŠŸèƒ½"><a href="#MongoDBçš„å¤åˆ¶åŠŸèƒ½" class="headerlink" title="MongoDBçš„å¤åˆ¶åŠŸèƒ½"></a>MongoDBçš„å¤åˆ¶åŠŸèƒ½</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">ä¸¤ç§ç±»å‹:</div><div class="line">    master/slave</div><div class="line">    replica set: å¤åˆ¶é›†ã€å‰¯æœ¬é›†</div><div class="line">        ä¸¤ç§ç±»å‹: ä¸»èŠ‚ç‚¹æ”¯æŒè¯»å†™æ“ä½œï¼Œè€Œä»èŠ‚ç‚¹ä»…æ”¯æŒè¯»æ“ä½œ;</div><div class="line">        æœåŠ¡äºåŒä¸€æ•°æ®é›†çš„å¤šä¸ªmongodbå®ä¾‹;</div><div class="line">        ä¸»èŠ‚ç‚¹æ“ä½œæ•°æ®ä¿®æ”¹æ“ä½œä¿å­˜è‡³oplogä¸­;</div><div class="line">            arbiter: ä»²è£è€…ï¼Œå³ä¾¿ç”¨ä¸ä¸Šä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿæ·»åŠ ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä»¥é¿å…è„‘è£‚;</div><div class="line">å·¥ä½œç‰¹æ€§:è‡³å°‘ä¸‰ä¸ªï¼Œä¸”åº”è¯¥ä¸ºå¥‡æ•°æ®ä¸ªèŠ‚ç‚¹;å¯ä»¥ä½¿ç”¨arbiteræ¥å‚ä¸é€‰ä¸¾;</div><div class="line">    hertbeat(é»˜è®¤2sä¼ é€’ä¸€æ¬¡),è‡ªåŠ¨å¤±æ•ˆè½¬ç§»(é€šè¿‡é€‰ä¸¾æ–¹å¼å®ç°)</div><div class="line"></div><div class="line">å¤åˆ¶é›†çš„ä¸­èŠ‚ç‚¹åˆ†ç±»çš„é›†ä¸­ç±»å‹:</div><div class="line">    0ä¼˜å…ˆçº§çš„èŠ‚ç‚¹: å‡†å¤‡èŠ‚ç‚¹,è¿™ç§èŠ‚ç‚¹ä¸ä¼šé€‰ä¸¾æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œä½†å¯ä»¥å‚ä¸é€‰ä¸¾è¿‡ç¨‹;</div><div class="line">    è¢«éšè—çš„ä»èŠ‚ç‚¹: é¦–å…ˆæ˜¯ä¸€ä¸ª0ä¼˜å…ˆçº§çš„ä»èŠ‚ç‚¹ï¼Œä¸”åœ°å®¢æˆ·ç«¯ä¸å¯è§;</div><div class="line">    å»¶è¿Ÿå¤åˆ¶çš„ä»èŠ‚ç‚¹: å½“åœ¨ä¸»èŠ‚ç‚¹è¯¯åˆ é™¤æ•°æ®æ—¶ï¼Œå¯ä»¥ç«‹å³æ–­å¼€ä¸»ä»ï¼Œå¯ä¿ç•™ä»èŠ‚ç‚¹ä¸Šæœªæ”¹å˜çš„æ•°æ®;</div><div class="line">            é¦–å…ˆæ˜¯ä¸€ä¸ª0ä¼˜å…ˆçº§çš„ä»èŠ‚ç‚¹ï¼Œä¸”å¤åˆ¶æ—¶é—´è½åäºä¸»èŠ‚ç‚¹ä¸€ä¸ªå›ºå®šæ—¶é•¿;</div><div class="line">            arbiter:</div><div class="line">MongoDBçš„å¤åˆ¶æ¶æ„:</div><div class="line">    oplog</div><div class="line">    heartbeat</div><div class="line">    </div><div class="line">    oplog: å¤§å°å›ºå®šçš„æ–‡ä»¶ï¼Œå­˜å‚¨åœ¨localæ•°æ®åº“ä¸­;</div><div class="line">    å³ä¾¿ä»èŠ‚ç‚¹æœ‰aplogä¹Ÿä¸ä¼šä½¿ç”¨;</div><div class="line">        åˆå§‹åŒæ­¥(initial sync)</div><div class="line">        å›æ»šåè¿½èµ¶(post-rollback catch-up)</div><div class="line">        åˆ‡åˆ†å—è¿ç§»(sharding chunk migrations)</div><div class="line">    </div><div class="line">    local: å­˜æ”¾äº†å‰¯æœ¬é›†çš„æ‰€æœ‰å…ƒæ•°æ®å’Œoplog: ç”¨äºå­˜å‚¨aplogçš„æ˜¯ä¸€ä¸ªåä¸ºoplog.rsçš„collection</div><div class="line">        aplog.rs çš„å¤§å°ä¾èµ–äºOS åŠæ–‡ä»¶ç³»ç»Ÿ ;</div><div class="line">    </div><div class="line">    Mongoçš„æ•°åŒæ­¥ç±»å‹ :</div><div class="line">        åˆå§‹åŒæ­¥:</div><div class="line">            èŠ‚ç‚¹æ²¡æœ‰ä»»ä½•æ•°æ®æ—¶</div><div class="line">            èŠ‚ç‚¹ä¸¢å¤±å‰¯æœ¬å¤åˆ¶å†å²</div><div class="line">        å¤åˆ¶</div><div class="line">        </div><div class="line">        åˆå§‹åŒæ­¥çš„æ­¥éª¤:</div><div class="line">            1ã€å…‹éš†æ‰€æœ‰æ•°æ®;</div><div class="line">            2ã€åº”ç”¨æ•°æ®é›†çš„æ‰€æœ‰æ”¹å˜ï¼Œå¤åˆ¶oplogå¹¶åº”ç”¨äºæœ¬åœ°;</div><div class="line">            3ã€ä¸ºæ‰€æœ‰collectionæ„å»ºç´¢å¼•;</div></pre></td></tr></table></figure><h3 id="Mongod-æ•°æ®åŒæ­¥è¿‡ç¨‹"><a href="#Mongod-æ•°æ®åŒæ­¥è¿‡ç¨‹" class="headerlink" title="Mongod æ•°æ®åŒæ­¥è¿‡ç¨‹"></a>Mongod æ•°æ®åŒæ­¥è¿‡ç¨‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">åˆå§‹åŒæ­¥:</div><div class="line">    èŠ‚ç‚¹æ²¡æœ‰ä»»ä½•æ•°æ®</div><div class="line">    ä»èŠ‚ç‚¹ä¸¢å¤±å¤æœ¬ï¼Œå¤åˆ¶å†å²æ•°æ®;</div><div class="line">åˆå§‹åŒæ­¥çš„æ­¥éª¤:</div><div class="line">    1ã€å…‹éš†æ‰€æœ‰æ•°æ®åº“;</div><div class="line">    2ã€åº”ç”¨æ•°æ®é›†çš„æ‰€æœ‰æ”¹å˜;å¤åˆ¶oplogå¹¶åº”ç”¨åœ¨æœ¬åœ°;</div><div class="line">    3ã€ä¸ºæ‰€æœ‰çš„collectionæ„å»ºç´¢å¼•;</div><div class="line">è¿™æ ·åˆå§‹åŒæ­¥å°±å®Œæˆäº†;</div><div class="line">ä¼˜äºMySQLçš„åœ°æ–¹ï¼Œ MongoDB æ”¯æŒå¤šçº¿ç¨‹å¤åˆ¶åŠŸèƒ½;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># vim /etc/mongd.conf</div><div class="line">replSet=testSet</div><div class="line">replIndexPrefetch=_id_only</div><div class="line"></div><div class="line"># systemctl mongod restart</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">show dbs</div><div class="line">use local</div><div class="line">show collections</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># node2çš„é…ç½®</div><div class="line"># å°†éœ€è¦å®‰è£…çš„rpm åŒ…å¤åˆ¶åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…åœ¨å¦ä¸€å°æœåŠ¡å™¨ä¸Šé…ç½®mongoçš„yumæº;</div><div class="line"># yum -y install mongodb-org-server</div><div class="line"># mkdir -pv /mongodb/data</div><div class="line"># chown -R mongod.mongod /mongodb</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># node3çš„é…ç½®</div><div class="line"># å°†éœ€è¦å®‰è£…çš„rpm åŒ…å¤åˆ¶åˆ°ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…åœ¨å¦ä¸€å°æœåŠ¡å™¨ä¸Šé…ç½®mongoçš„yumæº;</div><div class="line"># yum -y install mongodb-org-server</div><div class="line"># mkdir -pv /mongodb/data </div><div class="line"># chown -R mongod.mongod /mongodb</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># scp  /etc/mongod.conf root@node2:/etc/ </div><div class="line"># scp /etc/mongod.conf root@node3:/etc/</div><div class="line"># ä¿è¯ä¸‰ä¸ªèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¸€è‡´ï¼Œå¹¶å°†æœåŠ¡å™¨å¯åŠ¨;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">rs.conf()</div><div class="line">rs.status()</div><div class="line">rs.initiate()</div><div class="line">rs.status()</div><div class="line">rs.help() # æŸ¥æ‰¾mongoçš„å¸®åŠ©æ–‡æ¡£ï¼ŒæŸ¥çœ‹å¦‚ä½•æ·»åŠ ä¸»æœºè¿›æ¥, rs. ä¸»è¦æŒ‡mongoçš„åˆ†å¸ƒå¼é…ç½®;</div><div class="line">rs.add(&quot;172.16.55.128&quot;)  # åœ¨ä¸»èŠ‚ç‚¹çš„mongoä¸­æ‰§è¡Œ;</div><div class="line">show dbs </div><div class="line"># ä»èŠ‚ç‚¹é»˜è®¤æ˜¯ä¸æ”¯æŒæŸ¥è¯¢çš„ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨å¼€å¯;</div><div class="line"># åœ¨node2 èŠ‚ç‚¹ä¸­ï¼Œå°†å½“å‰æœåŠ¡å™¨èŠ‚ç‚¹æ”¹ä¸ºä»èŠ‚ç‚¹;</div><div class="line">rs.salveOK() </div><div class="line">rs.status()</div><div class="line">rs.isMaster() # æŸ¥çœ‹è‡ªå·±æ˜¯å¦ä¸ºä¸»èŠ‚ç‚¹;</div><div class="line"># å› æ­¤ï¼Œå½“æœåŠ¡å™¨æ”¹ä¸ºä»èŠ‚ç‚¹ä¹‹åå¯ä»¥åœ¨ä»èŠ‚ç‚¹ä¸ŠæŸ¥è¯¢ä¿¡æ¯; </div><div class="line"># db.statudents.findOne();</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹</div><div class="line">rs.add(&quot;172.16.55.129&quot;) # åœ¨ä¸»èŠ‚ç‚¹çš„mongoä¸­æ‰§è¡Œ</div><div class="line"># åœ¨ node3 èŠ‚ç‚¹ä¸­ï¼Œå°†å½“å‰æœåŠ¡å™¨èŠ‚ç‚¹æ”¹ä¸ºä»èŠ‚ç‚¹ï¼›</div><div class="line">rs.salveOK()</div><div class="line"># æ³¨è¦å†™æ•°æ®çš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦åˆ°ä¸»èŠ‚ç‚¹ä¸­æ”¯å†™;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">db.classes.insert(&#123;class: &quot;One&quot;, nostu: 40&#125;) # å°è¯•åœ¨ä¸»èŠ‚ç‚¹ä¸­æ’å…¥æ•°æ®;</div><div class="line">show collections # è¿™é‡Œä¸»æœåŠ¡å™¨å¯¹åº”çš„æ•°æ®å·²ç»æœ‰äº†;</div><div class="line">db.classes.findOne()  # å°è¯•åœ¨ä»æœåŠ¡å™¨ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œå¦‚æŸ¥æœ‰æ•°æ®ï¼Œåˆ™è¯´æ˜æ•°æ®åŒæ­¥æ²¡æœ‰é—®é¢˜;</div><div class="line"># ä»èŠ‚ç‚¹ä¸­æ˜¯ä¸èƒ½å†™å…¥æ•°æ®;</div><div class="line">rs.stepDown() # å°†ä¸»èŠ‚ç‚¹å¼ºåˆ¶æˆä¸ºä»èŠ‚ç‚¹;</div><div class="line">rs.status() # å¯ä»¥çœ‹å‡ºï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¼šè‡ªåŠ¨æˆä¸ºä¸»èŠ‚ç‚¹;</div><div class="line">db.printReplicationInfo() #  æŸ¥çœ‹äº§ä¸­äº‹ä»¶çš„é—´æ—¶ï¼Œå¤§å°;</div></pre></td></tr></table></figure><h3 id="å‰¯æœ¬é›†çš„é‡æ–°å…ˆä¸¾çš„å½±å“æ¡ä»¶"><a href="#å‰¯æœ¬é›†çš„é‡æ–°å…ˆä¸¾çš„å½±å“æ¡ä»¶" class="headerlink" title="å‰¯æœ¬é›†çš„é‡æ–°å…ˆä¸¾çš„å½±å“æ¡ä»¶:"></a>å‰¯æœ¬é›†çš„é‡æ–°å…ˆä¸¾çš„å½±å“æ¡ä»¶:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">å¿ƒè·³ä¿¡æ¯</div><div class="line">ä¼˜å…ˆçº§</div><div class="line">optime</div><div class="line">ç½‘ç»œè¿æ¥</div><div class="line">ç½‘ç»œåˆ†åŒº</div></pre></td></tr></table></figure><h3 id="å…ˆä¸¾æœºåˆ¶"><a href="#å…ˆä¸¾æœºåˆ¶" class="headerlink" title="å…ˆä¸¾æœºåˆ¶:"></a>å…ˆä¸¾æœºåˆ¶:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">è§¦å‘é€‰ä¸¾çš„äº‹ä»¶</div><div class="line">    æ–°å‰¯æœ¬é›†åˆå§‹åŒ–æ—¶;</div><div class="line">    ä»èŠ‚ç‚¹è”ç³»ä¸åˆ°ä¸»èŠ‚ç‚¹æ—¶;</div><div class="line">    ä¸»èŠ‚ç‚¹&quot;ä¸‹å°&quot;æ—¶;</div><div class="line">        ä¸»èŠ‚ç‚¹æ”¶åˆ°stepDown()å‘½ä»¤æ—¶;</div><div class="line">        æŸä»èŠ‚ç‚¹æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ä¸”å·²ç»æ»¡è¶³äº†æˆä¸»èŠ‚ç‚¹çš„å…¶å®ƒæ‰€æœ‰æ¡ä»¶;</div><div class="line">        ä¸»èŠ‚ç‚¹æ— æ³•è”ç³»åˆ°å‰¯æœ¬é›†çš„&quot;å¤šæ•°æ–¹&quot;ï¼›</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">cfg= rs.conf() # ä¿å­˜å½“å‰mongoçš„é…ç½®ï¼›</div><div class="line">cfg.member[1].priority=2</div><div class="line">rs.conf() # è¿™æ—¶çš„é…ç½®ä¾ç„¶æ˜¯1</div><div class="line">rs.reconfig(cfg) # ç”Ÿæ•ˆé…ç½®åˆ™å¿…éœ€è¦åœ¨ä¸»èŠ‚ç‚¹ä¸­è¿›è¡Œ;</div><div class="line"># è§¦å‘æ–°çš„é€‰ä¸¾æœºåˆ¶ï¼›</div><div class="line"></div><div class="line">cfg = rs.confg()</div><div class="line">cfg.member[2].abiterOnly=ture # è®¾ç½®abiterOnly å±æ€§;</div><div class="line">rs.reconfgi(cfg)</div><div class="line">rs.conf()</div><div class="line">rs.printSlaveReplicationInfo() # åŒæ—¶ä¹Ÿå¯ä»¥çœ‹æ˜¯æ¯ä¸ªä»èŠ‚ç‚¹æ˜¯å¦è½åäºä¸»èŠ‚ç‚¹;</div></pre></td></tr></table></figure><h2 id="MongoDBçš„åˆ†ç‰‡"><a href="#MongoDBçš„åˆ†ç‰‡" class="headerlink" title="MongoDBçš„åˆ†ç‰‡:"></a>MongoDBçš„åˆ†ç‰‡:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">sharding åˆ†ç‰‡</div><div class="line">    # éšç€å…¬å¸ä¸šåŠ¡çš„åˆ†å±•ï¼Œæ•°æ®é›†ä¼šå˜çš„è¶Šæ¥è¶Šå¤§ï¼›</div><div class="line">    # ä¼šåœ¨æŸä¸€ä¸ªæ—¶åˆ»ï¼ŒCPUï¼Œå†…å­˜ï¼ŒIO ç­‰å•æœºä¸Šå‡ºç°ç“¶é¢ˆ;</div><div class="line">    # å› æ­¤å‘ä¸Šå¤–å‘å¤–æ‰©å±•ï¼Œå‘ä¸Šæ‰©å±•æ˜¯ç»æµå½¢åŠ¿çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œä»æŠ€æœ¯è§’åº¦ï¼Œæˆ‘ä»¬å¯ä»¥å‘å¤–æ‰©å±•;</div><div class="line"></div><div class="line">MySQL: Gizzard, HivedDB(ç‹¬ç«‹çš„é¡¹ç›®ï¼Œè½¬é—¨æ¥å¯¹MySQLæ¥å®ç°åˆ†ç‰‡çš„)ï¼ŒMySQL Proxy + HSACLE, Hibernate Shared Pyshards</div><div class="line">    </div><div class="line">    # åˆ†ç‰‡æ¶æ„ä¸­çš„è§’è‰²:</div><div class="line">        mongos: Router;</div><div class="line">        config server: å…ƒæ•°æ®æœåŠ¡å™¨;</div><div class="line">        shard: æ•°æ®èŠ‚ç‚¹ï¼Œä¹Ÿç§°mongodå®ä¾‹èŠ‚ç‚¹; è´Ÿè´£å°†æ•°æ®å­˜ä¸‹æ¥ï¼Œå¹¶å“åº”å®¢æˆ·ç«¯çš„;</div><div class="line">        zookeeper: é€šå¸¸ç”¨äºåˆ†å¸ƒå¼èŠ‚ç‚¹çš„åè°ƒ; </div><div class="line">    # åŸºäºèŒƒå›´åˆ‡ç‰‡</div><div class="line">            range</div><div class="line">    # åŸºäºåˆ—è¡¨åˆ‡ç‰‡</div><div class="line">            list</div><div class="line">    #  åŸºäºhashåˆ‡ç‰‡</div><div class="line">            hash</div><div class="line">        å†™ç¦»æ•£ï¼Œè¯»è¦é›†ä¸­</div></pre></td></tr></table></figure><p><img src="/images/mongofs.png" alt=""></p><h3 id="åˆ†ç‰‡å¼æ¶æ„é…ç½®"><a href="#åˆ†ç‰‡å¼æ¶æ„é…ç½®" class="headerlink" title="åˆ†ç‰‡å¼æ¶æ„é…ç½®"></a>åˆ†ç‰‡å¼æ¶æ„é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"># rm -rf  /mongodb/data/ # æ³¨: åœ¨ç”Ÿäº§ä¸­ï¼Œè¿™ä¸ªæ“ä½œéå¸¸å±é™©ï¼éœ€è¦å°†æ•°æ®åº“ç”¨mongodump å¤‡ä»½ï¼›</div><div class="line"># å°†mongodb å®‰è£…çš„rpmåŒ…ï¼Œæˆ–è€…yumçš„é…ç½®æ–‡ä»¶ç”¨ansible æˆ–scp åŒæ­¥åˆ°å…¶å®ƒå››ä¸ªèŠ‚ç‚¹ä¸Šå»;</div><div class="line"># åœ¨å››ä¸ªèŠ‚ç‚¹å°†mongodb ç›¸å…³è½¯ä»¶åŒ…éƒ½å®‰è£…å¥½</div><div class="line"># å…ˆè¦é…ç½®config server --&gt; mongos --&gt; Shard1 --&gt; Shard2</div><div class="line">-------------------------&gt; confiserver æœåŠ¡å™¨é…ç½®</div><div class="line"># vim /etc/mongod.conf</div><div class="line"># replSet=testSet</div><div class="line"># replIndexPrefetch=id_only #  </div><div class="line">dbpath=/mongodb/data</div><div class="line">configsvr=true</div><div class="line"># chown -R mongod.mongod /mongodb</div><div class="line"># install -o mongod -g mongod -d /mongodb/data  # å»ºç«‹æ•°æ®åº“çš„å…ƒæ•°æ® ;</div><div class="line"># systemctl start mongod  mongo    # config server é»˜è®¤ç›‘å¬åœ¨27019çš„ç«¯å£ä¸Š;  </div><div class="line"></div><div class="line">-----------------------&gt; mongofs æœåŠ¡å™¨é…ç½®</div><div class="line"># yum -y insetall mongodb-org-mongos  # </div><div class="line">#  å¯åŠ¨ mongofs èŠ‚ç‚¹</div><div class="line"># mongos --configdb=172.16.55.172.16.55.128 --fork --logpath=/var/log/mongodb/mongo.log</div><div class="line"># mongo --host 172.16.55.127</div><div class="line">help</div><div class="line">sh.status() </div><div class="line"># ä»¥ä¸‹èŠ‚ç‚¹èµ·åŠ¨å</div><div class="line">sh.addShard(&quot;172.16.55.129&quot;)</div><div class="line">ss.addShard(&quot;172.16.55.120&quot;)</div><div class="line">sh.enableShareding(&quot;testdb&quot;) # åœ¨testdbä¸­å¯æœ‰shardåŠŸèƒ½;</div><div class="line">sh.help() # æŸ¥æ‰¾shardsé›†ç¾¤ç›¸å…³çš„é…ç½®é¡¹;</div><div class="line">sh.enableSharding(dbname)  # åœ¨å“ªä¸ªèŠ‚ç‚¹èµ·ç”¨sharding;</div><div class="line">sh.shardCollection(fullName,key,unique) # åœ¨collectionå“ªä¸ªé”®ï¼Œç´¢å¼•ä¸Šåšsharding ;</div><div class="line">sh.shardCollection(&quot;students&quot;, &#123;&quot;age&quot; : 1 &#125;)</div><div class="line">sh.status() # æ­¤æ—¶å°±å¯ä»¥æŸ¥çœ‹åˆ†ç‰‡ä¿¡æ¯äº†;</div><div class="line">use testdb;</div><div class="line">for (i=1; i&lt;=100000;i++) db.students.insert(&#123;name:&quot;studentt&quot;+i,  age:(i%120),classes:&quot;class&quot;+(i%10),address:&quot;www.ssjinyao.com, Magedu, #85 WenhuaRoad, BeiJin, China&quot;&#125;) # æ‰¹é‡æ’å…¥æµ‹è¯•æ•°æ®;</div><div class="line">use testdb</div><div class="line">db.students.find().count()</div><div class="line">sh.status() # å¯ä»¥çœ‹åˆ°åˆ†ç‰‡å­˜å‚¨çš„ä¿¡æ¯;</div><div class="line">db.databases.find(&quot;partitioned&quot;:true)</div><div class="line">db.runCommands(&quot;listShards&quot;)</div><div class="line">use admin</div><div class="line">db.runCommand(&quot;listShards&quot;)</div><div class="line">db.printShardingStatus()</div><div class="line">sh.isBalancerRunning()  # æŸ¥çœ‹å‡è¡¡å™¨çŠ¶æ€ï¼Œå®ƒä¼šåœ¨éœ€è¦æ—¶è‡ªåŠ¨å¯åŠ¨;</div><div class="line">sh.getBalancerState() # æŸ¥çœ‹BlancerSateçš„çŠ¶æ€;</div><div class="line">-----------------------&gt; Shard1 æœåŠ¡å™¨é…ç½®</div><div class="line"># vim /etc/mongod.conf</div><div class="line"># replSet=testSet</div><div class="line"># replIndexPrefetch=id_only # æ³¨é‡Šä»¥ä¸Šé…ç½®</div><div class="line"># dbpath=/mongodb/data</div><div class="line"># chown -R mongod.mongod /mongodb</div><div class="line"># systemctl start mongod</div><div class="line"></div><div class="line">-----------------------&gt; Shard2 æœåŠ¡å™¨é…ç½®</div><div class="line"># vim /etc/mongod.conf</div><div class="line"># replSet=testSet</div><div class="line"># replIndexPrefetch=id_only # æ³¨é‡Šä»¥ä¸Šé…ç½®</div><div class="line"># dbpath=/mongodb/data</div><div class="line"># chown -R mongod.mongod /mongodb</div><div class="line"># systemctl start mongod</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ansible è‡ªåŠ¨åŒ–è¿ç»´</title>
      <link href="/2018/04/09/ansible%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/04/09/ansible%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<h1 id="ansible-è‡ªåŠ¨åŒ–è¿ç»´"><a href="#ansible-è‡ªåŠ¨åŒ–è¿ç»´" class="headerlink" title="ansible è‡ªåŠ¨åŒ–è¿ç»´"></a>ansible è‡ªåŠ¨åŒ–è¿ç»´</h1><p><img src="/images/ansbile_n1.png" alt=""></p><h2 id="è¿ç»´å·¥å…·"><a href="#è¿ç»´å·¥å…·" class="headerlink" title="è¿ç»´å·¥å…·"></a>è¿ç»´å·¥å…·</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">OS Provisioning: PXE, Cobbler(repository, distritution, profile)</div><div class="line">    PXE: dhcp, tftp,(http,ftp)</div><div class="line">        dnsmsq:dhcp,dns</div><div class="line">OS Config:</div><div class="line">    puppet, saltstack, func </div><div class="line">Task Excute:</div><div class="line">    fabric, func,saltstack</div><div class="line">Deployment:</div><div class="line">    fabric,</div><div class="line">è¿ç»´å·¥å…·åˆ†ç±»:</div><div class="line">    agent: puppet, func  è¿™äº›å·¥å…·å¿…éœ€è¦æœ‰agentç«¯;</div><div class="line">    agentless: ansible, fabirc è¿™äº›å·¥å…·å¿…éœ€å¯ç”¨sshæœåŠ¡;</div><div class="line">Properties:</div><div class="line">    Minimal learning curve, auditability: å…¥é—¨æ›²çº¿éå¸¸å¹³ç¼“;</div><div class="line">    No bootstrapping:  æ— éœ€agent;</div><div class="line">    No DAG ordering, Fails  Fast: æ²¡æœ‰æ¬¡åº; </div><div class="line">    No agents(other than sshd) -o resource consumption when not in use: æ²¡æœ‰ä»£ç†;</div><div class="line">    No Server: ä¹Ÿæ²¡æœ‰æœåŠ¡ç«¯ï¼›</div><div class="line">    No additional PKI : æ— éœ€è¯ä¹¦ç­‰åŠŸèƒ½;</div><div class="line">    Modules in any language: æ¨¡å—å¯ä»¥ä½¿ç”¨ä»»æ„ç¼–ç¨‹è¯­è¨€æ¥ç¼–å†™;</div><div class="line">    YAML, not code: ä½¿ç”¨yamlé…ç½®æ–‡ä»¶;</div><div class="line">    SSH by default: ä½¿ç”¨sshé»˜è®¤æ¥å£;</div><div class="line">    Strong multi-tier solution: æ”¯æŒå¤šçº§ä½¿ç”¨æ–¹æ¡ˆ;</div><div class="line">Host Inventory:</div><div class="line">    å®šä¹‰å¯è¢« ansibleç®¡æ§çš„ä¸»æœº; </div><div class="line">Core Modules:</div><div class="line">    å¯è¢«è°ƒç”¨çš„æ ¸å¿ƒæ¨¡å—ï¼Œå¯ä»¥å®Œæˆå¤§éƒ¨ä½œçš„ä»»åŠ¡;</div><div class="line">Custom Modules:</div><div class="line">    è‡ªå®šä¹‰æ¨¡å—ï¼Œå½“ansibleå®ç°ä¸äº†æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ç¼–ç¨‹è¯­è¨€æ¥ç¼–å†™æ¨¡å—;</div><div class="line">Connection Plugins:</div><div class="line">    ansible å¯ä»¥æ”¯æŒä¸€äº›æ’ä»¶æ¥å®ç°ä¸€äº›åŠŸèƒ½ï¼Œå¦‚å‘é€é‚®ä»¶åŠŸèƒ½;</div><div class="line">ansibleçš„æ ¸å¿ƒçº¿ä»¶:</div><div class="line">    ansible core </div><div class="line">    host iventory</div><div class="line">    core modules </div><div class="line">    custom modules</div><div class="line">    playbook (yaml, jinjia2)</div><div class="line">    connect plugin</div><div class="line">ansibleç‰¹æ€§:</div><div class="line">    åŸºäºPythonè¯­è¨€å®ç°ï¼Œç”±Paramikoæ¨¡å—å®ç°ï¼ŒPyYAMLå’ŒJinia2 ä¸‰ä¸ªå…³é”®çš„æ¨¡å—æ„å»º</div><div class="line">pythonç‰¹æ€§:,agentless;</div><div class="line">    é»˜è®¤ä½¿ç”¨SSHåè®®: ä¼šæœ‰å®‰å…¨éšæ‚£;</div><div class="line">        åŸºäºå¯†é’¥è®¤è¯æ¥è¿æ¥åˆ°å„èŠ‚ç‚¹æ“ä½œ;</div><div class="line">    ä¸»ä»æ¨¡å¼:</div><div class="line">        master: ansible, ssh client;</div><div class="line">        savle: ssh serverç»“ç‚¹;</div><div class="line">    æ”¯æŒè‡ªå®šä¹‰æ¨¡å—:æ”¯æŒå„ç§ç¼–ç¨‹è¯­è¨€;</div><div class="line">    æ”¯æŒPlaybook</div><div class="line">    åŸºäº&quot;æ¨¡å—&quot;å®Œæˆå„ç§&quot;ä»»åŠ¡&quot;;</div></pre></td></tr></table></figure><h2 id="ansible-çš„å®‰è£…å’Œä½¿ç”¨"><a href="#ansible-çš„å®‰è£…å’Œä½¿ç”¨" class="headerlink" title="ansible çš„å®‰è£…å’Œä½¿ç”¨"></a>ansible çš„å®‰è£…å’Œä½¿ç”¨</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># ansible åœ¨äºepelæºä¸­</div><div class="line"># yum list all *ansible*</div><div class="line">ansible.noarch              2.4.2.0-2.el7                               @extras</div><div class="line"># å®‰è£…ä¾èµ–äºepelæº</div><div class="line">    é…ç½®æ–‡ä»¶ /etc/ansible/ansible.cfg</div><div class="line">    Invertory: /etc/ansible/hosts</div><div class="line"># vim /etc/ansible # ä¿ç•™ä»¥ä¸‹é…ç½®</div><div class="line">[dbserver]</div><div class="line">172.16.55.123</div><div class="line"></div><div class="line">[webserver]</div><div class="line">172.16.55.124</div><div class="line">172.1655.125</div><div class="line"># åœ¨ansibleä¸»æœºç”Ÿæˆä¸€ç»„å¯†é’¥</div><div class="line"># ssh-keygen</div><div class="line"># å®ç°åŒæœºäº’ä¿¡</div><div class="line"># for i in &#123;3..5&#125; ; do ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.55.12$i; done</div><div class="line"># for i in &#123;3..5&#125; ; do ssh root@172.16.55.12$i &quot;date&quot; &amp;&amp; echo &quot;The Messages From 172.16.55.12$i&quot;; done</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:47:09 CST</div><div class="line">The Messages From 172.16.55.123</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:47:10 CST</div><div class="line">The Messages From 172.16.55.124</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:47:10 CST</div><div class="line">The Messages From 172.16.55.125</div><div class="line"># æ­¤æ—¶ansbileæ‰€åœ¨çš„æœåŠ¡å™¨å¯ä»¥å®ç°å¯¹å„ç»“ç‚¹çš„æ§åˆ¶</div></pre></td></tr></table></figure><h2 id="asnbile-doc-çš„ä½¿ç”¨"><a href="#asnbile-doc-çš„ä½¿ç”¨" class="headerlink" title="asnbile-doc çš„ä½¿ç”¨"></a>asnbile-doc çš„ä½¿ç”¨</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># ansible-doc  # ç”¨æ¥æŸ¥çœ‹asnbile æ¨¡å—çš„ä½¿ç”¨æŸ¥è¯¢;</div><div class="line"># ansible-doc -l # ä¾‹å‡ºæ‰€æœ‰å¯ç”¨çš„æ¨¡å—; </div><div class="line"># ansible-doc -s MODULE_NAME; # æŸ¥çœ‹æŸä¸ªæ¨¡å—çš„ä½¿ç”¨ç”¨æ³•;</div><div class="line"># ansible-doc -s yum</div></pre></td></tr></table></figure><h2 id="ansibleå‘½ä»¤çš„åº”ç”¨åŸºç¡€"><a href="#ansibleå‘½ä»¤çš„åº”ç”¨åŸºç¡€" class="headerlink" title="ansibleå‘½ä»¤çš„åº”ç”¨åŸºç¡€"></a>ansibleå‘½ä»¤çš„åº”ç”¨åŸºç¡€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ansibleå‘½ä»¤åº”ç”¨åŸºç¡€:</div><div class="line">    è¯­æ³•: ansible &lt;host-pattern&gt; [-f forks] [-m module_name] [-a args]</div><div class="line">        -f forks: å¯åŠ¨çš„å¹¶å‘çº¿ç¨‹æ•°;</div><div class="line">        -m module_name: è¦ä½¿ç”¨çš„æ¨¡å—;</div><div class="line">        -a args: æ¨¡å—ç‰¹æœ‰çš„å‚æ•°;</div></pre></td></tr></table></figure><h2 id="å¸¸è§çš„æ¨¡å—"><a href="#å¸¸è§çš„æ¨¡å—" class="headerlink" title="å¸¸è§çš„æ¨¡å—:"></a>å¸¸è§çš„æ¨¡å—:</h2><h3 id="command-å‘½ä»¤æ¨¡å—ï¼Œé»˜è®¤æ¨¡å—ï¼Œç”¨äºåœ¨è¿œç¨‹å‘½ä»¤"><a href="#command-å‘½ä»¤æ¨¡å—ï¼Œé»˜è®¤æ¨¡å—ï¼Œç”¨äºåœ¨è¿œç¨‹å‘½ä»¤" class="headerlink" title="command: å‘½ä»¤æ¨¡å—ï¼Œé»˜è®¤æ¨¡å—ï¼Œç”¨äºåœ¨è¿œç¨‹å‘½ä»¤;"></a>command: å‘½ä»¤æ¨¡å—ï¼Œé»˜è®¤æ¨¡å—ï¼Œç”¨äºåœ¨è¿œç¨‹å‘½ä»¤;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"># ansible 172.16.55.124 -m command -a &quot;date&quot;</div><div class="line">172.16.55.124 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:57:39 CST</div><div class="line"></div><div class="line"># ansible dbserver -m command -a &quot;date&quot;              </div><div class="line">172.16.55.123 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:58:02 CST</div><div class="line"></div><div class="line"># ansible all -m command -a &quot;date&quot;        </div><div class="line">172.16.55.124 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:58:24 CST</div><div class="line"></div><div class="line">172.16.55.123 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:58:24 CST</div><div class="line"></div><div class="line">172.16.55.125 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">2018å¹´ 04æœˆ 09æ—¥ æ˜ŸæœŸä¸€ 09:58:32 CST</div><div class="line"></div><div class="line"># ansible all -m command -a &quot;tail -2 /var/log/messages&quot;</div><div class="line">172.16.55.124 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Apr  9 09:58:24 fabric1 ansible-command: Invoked with warn=True executable=None _uses_shell=False _raw_params=date removes=None creates=None chdir=None stdin=None</div><div class="line">Apr  9 09:59:22 fabric1 ansible-command: Invoked with warn=True executable=None _uses_shell=False _raw_params=tail -2 /var/log/messages removes=None creates=None chdir=None stdin=None</div><div class="line"></div><div class="line">172.16.55.123 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Apr  9 09:58:24 hyperledger ansible-command: Invoked with warn=True executable=None _uses_shell=False _raw_params=date removes=None creates=None chdir=None stdin=None</div><div class="line">Apr  9 09:59:23 hyperledger ansible-command: Invoked with warn=True executable=None _uses_shell=False _raw_params=tail -2 /var/log/messages removes=None creates=None chdir=None stdin=None</div><div class="line"></div><div class="line">172.16.55.125 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">Apr  9 09:58:31 fabric2 ansible-command: Invoked with warn=True executable=None _uses_shell=False _raw_params=date removes=None creates=None chdir=None stdin=None</div><div class="line">Apr  9 09:59:23 fabric2 ansible-command: Invoked with warn=True executable=None _uses_shell=False _raw_params=tail -2 /var/log/messages removes=None creates=None chdir=None stdin=None</div></pre></td></tr></table></figure><h3 id="cron-æ¨¡å—-å¯ä»¥ä½¿è¢«ç®¡ç†èŠ‚ç‚¹è‡ªåŠ¨ç”Ÿæˆä¸€ç”Ÿä»»åŠ¡è®¡åˆ’"><a href="#cron-æ¨¡å—-å¯ä»¥ä½¿è¢«ç®¡ç†èŠ‚ç‚¹è‡ªåŠ¨ç”Ÿæˆä¸€ç”Ÿä»»åŠ¡è®¡åˆ’" class="headerlink" title="cron æ¨¡å—:å¯ä»¥ä½¿è¢«ç®¡ç†èŠ‚ç‚¹è‡ªåŠ¨ç”Ÿæˆä¸€ç”Ÿä»»åŠ¡è®¡åˆ’;"></a>cron æ¨¡å—:å¯ä»¥ä½¿è¢«ç®¡ç†èŠ‚ç‚¹è‡ªåŠ¨ç”Ÿæˆä¸€ç”Ÿä»»åŠ¡è®¡åˆ’;</h3><p>stateæ‰€æœ‰å±æ€§:</p><ul><li>present: å®‰è£… </li><li>absent: ç§»é™¤</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">    */10 * * * *  /bin/echo &quot;Test Message&quot;</div><div class="line"># ansible webserver -m cron -a  &apos;minute=&quot;*/10&quot; job=&quot;/bin/echo Test Message&quot; name=&quot;Test Cron Job&quot;&apos; </div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;envs&quot;: [], </div><div class="line">    &quot;jobs&quot;: [</div><div class="line">        &quot;Test Cron Job&quot;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;envs&quot;: [], </div><div class="line">    &quot;jobs&quot;: [</div><div class="line">        &quot;Test Cron Job&quot;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line"># æ‰§è¡Œå®Œä¹‹åç™»å½•ä»¥ä¸Šçš„æŸä¸€å°æœåŠ¡å™¨è¿›è¡ŒéªŒè¯</div><div class="line"># crontab  -l</div><div class="line">#Ansible: Test Cron Job</div><div class="line">*/10 * * * * /bin/echo Test Message</div><div class="line"># ansible webserver -m cron -a  &apos;minute=&quot;*/10&quot; job=&quot;/bin/echo Test Message&quot; name=&quot;Test Cron Job&quot; state=&quot;absent&quot;&apos;</div><div class="line"># å°†ä»¥ä¸Šå»ºç«‹çš„å®šæ—¶ä»»åŠ¡è®¡åˆ’ç§»é™¤</div></pre></td></tr></table></figure><h3 id="useræ¨¡å—-ç”¨äºå»ºç«‹ç”¨æˆ·ï¼›"><a href="#useræ¨¡å—-ç”¨äºå»ºç«‹ç”¨æˆ·ï¼›" class="headerlink" title="useræ¨¡å—: ç”¨äºå»ºç«‹ç”¨æˆ·ï¼›"></a>useræ¨¡å—: ç”¨äºå»ºç«‹ç”¨æˆ·ï¼›</h3><p>name=: æŒ‡æ˜éœ€è¦å»ºç«‹ç”¨æˆ·çš„ç”¨æˆ·å;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"># ansible all -m user -a &apos;user=&quot;user1&quot;&apos;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;createhome&quot;: true, </div><div class="line">    &quot;group&quot;: 1001, </div><div class="line">    &quot;home&quot;: &quot;/home/user1&quot;, </div><div class="line">    &quot;name&quot;: &quot;user1&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: false, </div><div class="line">    &quot;uid&quot;: 1001</div><div class="line">&#125;</div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;createhome&quot;: true, </div><div class="line">    &quot;group&quot;: 1001, </div><div class="line">    &quot;home&quot;: &quot;/home/user1&quot;, </div><div class="line">    &quot;name&quot;: &quot;user1&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: false, </div><div class="line">    &quot;uid&quot;: 1001</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;createhome&quot;: true, </div><div class="line">    &quot;group&quot;: 1001, </div><div class="line">    &quot;home&quot;: &quot;/home/user1&quot;, </div><div class="line">    &quot;name&quot;: &quot;user1&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: false, </div><div class="line">    &quot;uid&quot;: 1001</div><div class="line">&#125;</div><div class="line"># éªŒè¯æ˜¯å¦åˆ›å»ºäº†ç”¨æˆ·</div><div class="line"># id user1</div><div class="line"># å°†ä»¥ä¸Šå»ºç«‹çš„ç”¨æˆ·åˆ é™¤</div><div class="line"># ansible all -m user -a &apos;user=&quot;user1&quot; state=&quot;absent&quot;&apos;</div><div class="line"># åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç³»ç»Ÿç»„</div><div class="line"># ansible all -m group -a &apos;name=&quot;mysql&quot; gid=&quot;306&quot; system=&quot;yes&quot;&apos; </div><div class="line"># ansible all -m user -a &apos;name=&quot;mysqld&quot; uid=&quot;306&quot; group=&quot;mysql&quot; system=&quot;yes&quot;&apos; </div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;createhome&quot;: true, </div><div class="line">    &quot;group&quot;: 306, </div><div class="line">    &quot;home&quot;: &quot;/home/mysqld&quot;, </div><div class="line">    &quot;name&quot;: &quot;mysqld&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: true, </div><div class="line">    &quot;uid&quot;: 306</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;createhome&quot;: true, </div><div class="line">    &quot;group&quot;: 306, </div><div class="line">    &quot;home&quot;: &quot;/home/mysqld&quot;, </div><div class="line">    &quot;name&quot;: &quot;mysqld&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: true, </div><div class="line">    &quot;uid&quot;: 306</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;createhome&quot;: true, </div><div class="line">    &quot;group&quot;: 306, </div><div class="line">    &quot;home&quot;: &quot;/home/mysqld&quot;, </div><div class="line">    &quot;name&quot;: &quot;mysqld&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: true, </div><div class="line">    &quot;uid&quot;: 306</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="copyæ¨¡å—-ç”¨äºæ–‡ä»¶çš„è¿œç¨‹ä¼ è¾“"><a href="#copyæ¨¡å—-ç”¨äºæ–‡ä»¶çš„è¿œç¨‹ä¼ è¾“" class="headerlink" title="copyæ¨¡å—: ç”¨äºæ–‡ä»¶çš„è¿œç¨‹ä¼ è¾“;"></a>copyæ¨¡å—: ç”¨äºæ–‡ä»¶çš„è¿œç¨‹ä¼ è¾“;</h3><ul><li>src=: å®šä¹‰æœ¬åœ°æºæ–‡ä»¶è·¯å¾„;</li><li>dest=: å®šä¹‰è¿œç¨‹ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼Œä½†ä¸æ”¯æŒç»å¯¹è·¯å¾„;</li><li>content=: å–ä»£src=,è¡¨ç¤ºç›´æ¥ç”¨æ­¤å¤„æŒ‡å®šçš„ä¿¡æ¯ç”Ÿæˆç›®æ ‡æ–‡ä»¶, <code>ä½†è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œä¼šæŠŠèŠ‚ç‚¹ä¸»æœºçš„æºæ–‡ä»¶è¦†ç›–ï¼Œç±»ä¼¼äº echo &gt; /path/to/file</code></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"># ansible all -m copy -a &apos;src=/etc/fstab dest=/tmp/fstab.ansible owner=root mode=&quot;640&quot;&apos;  </div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;checksum&quot;: &quot;3858e5b009a8c0828cb529780a2ad547411d8d94&quot;, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/fstab.ansible&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;md5sum&quot;: &quot;01ea40602497b8cfe5a53743054fa04d&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0640&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;size&quot;: 541, </div><div class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1523241179.42-225211025896206/source&quot;, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;checksum&quot;: &quot;3858e5b009a8c0828cb529780a2ad547411d8d94&quot;, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/fstab.ansible&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;md5sum&quot;: &quot;01ea40602497b8cfe5a53743054fa04d&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0640&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </div><div class="line">    &quot;size&quot;: 541, </div><div class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1523241179.42-108291746173038/source&quot;, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;checksum&quot;: &quot;3858e5b009a8c0828cb529780a2ad547411d8d94&quot;, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/fstab.ansible&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;md5sum&quot;: &quot;01ea40602497b8cfe5a53743054fa04d&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0640&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;size&quot;: 541, </div><div class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1523241179.35-169240840464627/source&quot;, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line"># ansible all -m copy -a &apos;content=&quot;Hellow Ansible\nWelcome to ssjinyao\n&quot; dest=&quot;/tmp/ssjinyao&quot;&apos;</div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;checksum&quot;: &quot;06759ebeeffb1ec2ba32b71d0440258a2ec812ca&quot;, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;md5sum&quot;: &quot;7da4c3d419470482101fa8cfa338c882&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0644&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;size&quot;: 35, </div><div class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1523241579.59-247115936338069/source&quot;, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;checksum&quot;: &quot;06759ebeeffb1ec2ba32b71d0440258a2ec812ca&quot;, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;md5sum&quot;: &quot;7da4c3d419470482101fa8cfa338c882&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0644&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;size&quot;: 35, </div><div class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1523241579.53-265190945061484/source&quot;, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;checksum&quot;: &quot;06759ebeeffb1ec2ba32b71d0440258a2ec812ca&quot;, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;md5sum&quot;: &quot;7da4c3d419470482101fa8cfa338c882&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0644&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </div><div class="line">    &quot;size&quot;: 35, </div><div class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1523241579.58-230356470158720/source&quot;, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line"># cat /tmp/ssjinyao </div><div class="line">Hellow Ansible</div><div class="line">Welcome to ssjinyao</div></pre></td></tr></table></figure><h3 id="file-ç”¨äºè®¾å®šæ–‡ä»¶å±æ€§"><a href="#file-ç”¨äºè®¾å®šæ–‡ä»¶å±æ€§" class="headerlink" title="file: ç”¨äºè®¾å®šæ–‡ä»¶å±æ€§;"></a>file: ç”¨äºè®¾å®šæ–‡ä»¶å±æ€§;</h3><ul><li>path=: æŒ‡å®šæ–‡ä»¶è·¯å¾„, å¯ä»¥ä½¿ç”¨name æˆ–destæ¥æ›¿æ¢;</li><li>åˆ›å»ºæ–‡ä»¶çš„ç¬¦å·é“¾æ¥;</li><li>src=:æŒ‡æ˜æºæ–‡ä»¶;</li><li>path=: æŒ‡æ˜ç¬¦å·é“¾æ¥æ–‡ä»¶è·¯å¾„;     </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"># ansible all -m file -a &apos;owner=&quot;mysql&quot; group=&quot;mysql&quot; mode=&quot;644&quot; path=&quot;/tmp/ssjinyao&quot;&apos;  </div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;gid&quot;: 306, </div><div class="line">    &quot;group&quot;: &quot;mysql&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0644&quot;, </div><div class="line">    &quot;owner&quot;: &quot;mysql&quot;, </div><div class="line">    &quot;path&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;size&quot;: 35, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 27</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;gid&quot;: 306, </div><div class="line">    &quot;group&quot;: &quot;mysql&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0644&quot;, </div><div class="line">    &quot;owner&quot;: &quot;mysql&quot;, </div><div class="line">    &quot;path&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;size&quot;: 35, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 27</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;gid&quot;: 306, </div><div class="line">    &quot;group&quot;: &quot;mysql&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0644&quot;, </div><div class="line">    &quot;owner&quot;: &quot;mysql&quot;, </div><div class="line">    &quot;path&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </div><div class="line">    &quot;size&quot;: 35, </div><div class="line">    &quot;state&quot;: &quot;file&quot;, </div><div class="line">    &quot;uid&quot;: 27</div><div class="line">&#125;</div><div class="line"># ansible all -m file -a &apos;path=&quot;/tmp/ssjinyao.link&quot; src=&quot;/tmp/ssjinyao&quot; state=&quot;link&quot;&apos;</div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/ssjinyao.link&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0777&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;size&quot;: 13, </div><div class="line">    &quot;src&quot;: &quot;/tmp/172.16&quot;, </div><div class="line">    &quot;state&quot;: &quot;link&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/ssjinyao.link&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0777&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;size&quot;: 13, </div><div class="line">    &quot;src&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;state&quot;: &quot;link&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;dest&quot;: &quot;/tmp/ssjinyao.link&quot;, </div><div class="line">    &quot;gid&quot;: 0, </div><div class="line">    &quot;group&quot;: &quot;root&quot;, </div><div class="line">    &quot;mode&quot;: &quot;0777&quot;, </div><div class="line">    &quot;owner&quot;: &quot;root&quot;, </div><div class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:user_tmp_t:s0&quot;, </div><div class="line">    &quot;size&quot;: 13, </div><div class="line">    &quot;src&quot;: &quot;/tmp/ssjinyao&quot;, </div><div class="line">    &quot;state&quot;: &quot;link&quot;, </div><div class="line">    &quot;uid&quot;: 0</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="ping-æµ‹è¯•è¿œç¨‹ä¸»æœºçš„è¿æ¥æ€§"><a href="#ping-æµ‹è¯•è¿œç¨‹ä¸»æœºçš„è¿æ¥æ€§" class="headerlink" title="ping: æµ‹è¯•è¿œç¨‹ä¸»æœºçš„è¿æ¥æ€§;"></a>ping: æµ‹è¯•è¿œç¨‹ä¸»æœºçš„è¿æ¥æ€§;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># ansible all -m ping </div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: false, </div><div class="line">    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: false, </div><div class="line">    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: false, </div><div class="line">    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="service-æŒ‡å®šè¿è¡ŒçŠ¶æ€"><a href="#service-æŒ‡å®šè¿è¡ŒçŠ¶æ€" class="headerlink" title="service: æŒ‡å®šè¿è¡ŒçŠ¶æ€;"></a>service: æŒ‡å®šè¿è¡ŒçŠ¶æ€;</h3><ul><li>enabled=: æ˜¯å¦å¼€æœºè‡ªåŠ¨å¯åŠ¨;</li><li>name =: æœåŠ¡åç§°;</li><li>state =: çŠ¶æ€ï¼Œå–å€¼æœ‰started, stopped, restarted;</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># ansible webserver -m service -a &quot;enabled=true name=httpd state=started&quot;</div></pre></td></tr></table></figure><h3 id="shell-åœ¨è¿œç¨‹ä¸»æœºè¿è¡Œå‘½ä»¤"><a href="#shell-åœ¨è¿œç¨‹ä¸»æœºè¿è¡Œå‘½ä»¤" class="headerlink" title="shell: åœ¨è¿œç¨‹ä¸»æœºè¿è¡Œå‘½ä»¤;"></a>shell: åœ¨è¿œç¨‹ä¸»æœºè¿è¡Œå‘½ä»¤;</h3><p>å°¤å…¶æ˜¯ç”¨åˆ°ç®¡é“ç­‰å¤æ‚å‘½ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># ansible all -m shell -a &apos;echo &quot;xxxxxxxx&quot; | passwd --stdin user1 &apos;         </div><div class="line">172.16.55.123 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">æ›´æ”¹ç”¨æˆ· user1 çš„å¯†ç  ã€‚</div><div class="line">passwdï¼šæ‰€æœ‰çš„èº«ä»½éªŒè¯ä»¤ç‰Œå·²ç»æˆåŠŸæ›´æ–°ã€‚</div><div class="line"></div><div class="line">172.16.55.124 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">æ›´æ”¹ç”¨æˆ· user1 çš„å¯†ç  ã€‚</div><div class="line">passwdï¼šæ‰€æœ‰çš„èº«ä»½éªŒè¯ä»¤ç‰Œå·²ç»æˆåŠŸæ›´æ–°ã€‚</div><div class="line"></div><div class="line">172.16.55.125 | SUCCESS | rc=0 &gt;&gt;</div><div class="line">æ›´æ”¹ç”¨æˆ· user1 çš„å¯†ç  ã€‚</div><div class="line">passwdï¼šæ‰€æœ‰çš„èº«ä»½éªŒè¯ä»¤ç‰Œå·²ç»æˆåŠŸæ›´æ–°ã€‚</div></pre></td></tr></table></figure><h3 id="script-å°†æœ¬åœ°è„šæœ¬å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºä¸Šå¹¶è¿è¡Œä¹‹"><a href="#script-å°†æœ¬åœ°è„šæœ¬å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºä¸Šå¹¶è¿è¡Œä¹‹" class="headerlink" title="script:  å°†æœ¬åœ°è„šæœ¬å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºä¸Šå¹¶è¿è¡Œä¹‹;"></a>script:  å°†æœ¬åœ°è„šæœ¬å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºä¸Šå¹¶è¿è¡Œä¹‹;</h3><p>æ³¨æ„: è¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„æŒ‡å®šè„šæœ¬;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"># cat test.sh       </div><div class="line">#!/bin/bash</div><div class="line">sum=0</div><div class="line">for i in &#123;1..100&#125;; do </div><div class="line">        sum=$[$sum+$i]</div><div class="line">done</div><div class="line">    echo $sum</div><div class="line">    </div><div class="line"># chmod +x test.sh </div><div class="line"># ansible all -m script -a &quot;/tmp/test.sh&quot;</div><div class="line">172.16.55.123 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;rc&quot;: 0, </div><div class="line">    &quot;stderr&quot;: &quot;Shared connection to 172.16.55.123 closed.\r\n&quot;, </div><div class="line">    &quot;stdout&quot;: &quot;5050\r\n&quot;, </div><div class="line">    &quot;stdout_lines&quot;: [</div><div class="line">        &quot;5050&quot;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">172.16.55.124 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;rc&quot;: 0, </div><div class="line">    &quot;stderr&quot;: &quot;Shared connection to 172.16.55.124 closed.\r\n&quot;, </div><div class="line">    &quot;stdout&quot;: &quot;5050\r\n&quot;, </div><div class="line">    &quot;stdout_lines&quot;: [</div><div class="line">        &quot;5050&quot;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">172.16.55.125 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;rc&quot;: 0, </div><div class="line">    &quot;stderr&quot;: &quot;Shared connection to 172.16.55.125 closed.\r\n&quot;, </div><div class="line">    &quot;stdout&quot;: &quot;5050\r\n&quot;, </div><div class="line">    &quot;stdout_lines&quot;: [</div><div class="line">        &quot;5050&quot;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="yum-å®‰è£…ç¨‹åºåŒ…"><a href="#yum-å®‰è£…ç¨‹åºåŒ…" class="headerlink" title="yum: å®‰è£…ç¨‹åºåŒ…;"></a>yum: å®‰è£…ç¨‹åºåŒ…;</h3><ul><li>name=: æŒ‡æ˜è¦å®‰è£…çš„ç¨‹åºåŒ…ï¼Œå¯ä»¥å¸¦ä¸Šç‰ˆæœ¬å·;</li><li>state=: present, latestè¡¨ç¤ºå®‰è£…ï¼Œabsentè¡¨ç¤ºå¸è½½;</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># ansible all -m yum -a &apos;name=&quot;zsh&quot; state=&quot;present&quot;&apos;</div><div class="line"># ansible all -m yum -a &apos;name=&quot;zsh&quot; state=&quot;absent&quot;&apos;</div></pre></td></tr></table></figure><h3 id="setup-æ”¶é›†è¿œç¨‹ä¸»æœºçš„facts"><a href="#setup-æ”¶é›†è¿œç¨‹ä¸»æœºçš„facts" class="headerlink" title="setup: æ”¶é›†è¿œç¨‹ä¸»æœºçš„facts;"></a>setup: æ”¶é›†è¿œç¨‹ä¸»æœºçš„facts;</h3><ul><li>æ¯ä¸ªè¢«ç®¡ç†èŠ‚ç‚¹åœ¨æ¥æ”¶å¹¶è¿è¡Œç®¡ç†å‘½ä»¤ä¹‹å‰ï¼Œä¼šå°†è‡ªå·±ä¸»æœºç›¸å…³ä¿¡æ¯ï¼›</li><li>å¦‚æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€IPåœ°å€ç­‰æŠ¥å‘Šç»™è¿œç¨‹çš„ansibleä¸»æœº;</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># æŸ¥çœ‹è¿œç¨‹èŠ‚ç‚¹çš„æœåŠ¡å™¨ä¿¡æ¯ï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒç”¨é…ç½®</div><div class="line"># ansible all -m setup</div></pre></td></tr></table></figure><h2 id="ansible-playbook-å‰§æœ¬-çš„ä½¿ç”¨"><a href="#ansible-playbook-å‰§æœ¬-çš„ä½¿ç”¨" class="headerlink" title="ansible-playbook(å‰§æœ¬) çš„ä½¿ç”¨"></a>ansible-playbook(å‰§æœ¬) çš„ä½¿ç”¨</h2><h3 id="playbookçš„æ ¸å¿ƒå…ƒç´ "><a href="#playbookçš„æ ¸å¿ƒå…ƒç´ " class="headerlink" title="playbookçš„æ ¸å¿ƒå…ƒç´ ;"></a>playbookçš„æ ¸å¿ƒå…ƒç´ ;</h3><ul><li>taskfs:ä»»åŠ¡</li><li>variadble: å˜é‡</li><li>templates: æ¨¡æ¿</li><li>handlers: å¤„ç†å™¨</li><li>roles:è§’è‰²</li></ul><h3 id="YAML-ä»‹ç»"><a href="#YAML-ä»‹ç»" class="headerlink" title="YAML ä»‹ç»;"></a>YAML ä»‹ç»;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">YAML æ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜çš„ç”¨æ¥è¡¨è¾¾èµ„æ–™åºåˆ—çš„æ ¼å¼ï¼ŒYAMLå‚è€ƒäº†å…¶ä»–å¤šå¤„è¯­è¨€;</div><div class="line">åŒ…æ‹¬:XMLã€Cè¯­è¨€ã€Pythonã€Perlä»¥åŠç”µå­é‚®ä»¶æ ¼å¼ç­‰</div><div class="line">Clark Evansåœ¨2001å¹´é¦–æ¬¡å‘è¡¨äº†è¿™ç§è¯­è¨€</div><div class="line"></div><div class="line">YAML Ain&apos;t Markup Language, å³YAMLä¸æ˜¯XMLã€‚ä¸è¿‡ï¼Œåœ¨å¼€å‘çš„è¿™ç§è¯­è¨€æ—¶;</div><div class="line">YAMLçš„æ„æ€å…¶å®æ˜¯:&quot;Yet Another Markup Language(ä»æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€)ã€‚&quot;å…¶ç‰¹æ€§:</div><div class="line"></div><div class="line">YAMLçš„å¯è¯»æ€§å¥½</div><div class="line">YAML å’Œè„šæœ¬è¯­è¨€çš„äº¤äº’æ€§å¥½</div><div class="line">YAML ä½¿ç”¨å®ç°è¯­è¨€çš„æ•°æ®ç±»å‹</div><div class="line">YAML æœ‰ä¸€ä¸ªä¸€è‡´çš„ä¿¡æ¯æ¨¡å‹</div><div class="line">YAML æ˜“äºå®ç°</div><div class="line">YAML å¯ä»¥åŸºäºæµæ¥å¤„ç†</div><div class="line">YAML è¡¨è¾¾èƒ½åŠ›å¼ºï¼Œæ‰©å±•æ€§å¥½</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">YAMLçš„è¯­æ³•å’Œå…¶ä»–é«˜é˜¶è¯­è¨€ç±»ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥ç®€å•è¡¨è¾¾æ¸…å•ã€æ•£åˆ—è¡¨ã€æ ‡é‡ç­‰æ•°æ®ç»“æ„; </div><div class="line">å…¶ç»“æ„(Structure)é€šè¿‡ç©ºæ ¼æ¥å±•ç¤ºï¼Œåºåˆ—(Sequence)é‡Œçš„é¡¹ç”¨&quot;-&quot;æ¥ä»£è¡¨ï¼ŒMapé‡Œçš„é”®å€¼ç”¨&quot;;&quot;åˆ†éš”</div></pre></td></tr></table></figure><h3 id="ansibleå˜é‡"><a href="#ansibleå˜é‡" class="headerlink" title="ansibleå˜é‡:"></a>ansibleå˜é‡:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">å˜é‡å‘½å</div><div class="line">    å˜é‡åä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´;</div><div class="line"> facts</div><div class="line">    factsæ˜¯ç”±æ­£åœ¨é€šä¿¡çš„è¿œç¨‹ç›®æ ‡ä¸»æœºå‘å›çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ä¿å­˜åœ¨ansibleå˜é‡ä¸­;</div><div class="line">    è¦è·å–æŒ‡å®šçš„è¿œç¨‹ä¸»æœºæ‰€æ”¯æŒçš„æ‰€æœ‰factsï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œ;</div><div class="line"># ansible hostname -m setup</div><div class="line">register</div><div class="line">æŠŠä»»åŠ¡çš„è¾“å‡ºå®šä¹‰ä¸ºå˜é‡ï¼Œç„¶åç”¨äºå…¶ä»–ä»»åŠ¡ï¼Œç¤ºä¾‹å¦‚ä¸‹:</div><div class="line">  tasks:</div><div class="line">     - shell: /usr/bin/foo</div><div class="line">       register: foo_result</div><div class="line">       ignore_errors: True</div><div class="line">    - hosts: websrvs</div><div class="line">      remote_user: root</div><div class="line">      tasks:</div><div class="line">      - name: copy file</div><div class="line">        copy: content=&quot;&#123;&#123; ansible_all_ipv4_address &#125;&#125;&quot; dest=/tmp/var.dns</div><div class="line"></div><div class="line">é€šè¿‡å‘½ä»¤è¡Œä¼ é€’å˜é‡</div><div class="line">åœ¨è¿è¡Œplaybookçš„æ—¶å€™ä¹Ÿå¯ä»¥ä¼ é€’ä¸€äº›å˜é‡ä¾›playbookä½¿ç”¨ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</div><div class="line">ansible-playbook test.yml --extra-vars &quot;hosts=www user=ssjinyao&quot;</div><div class="line">é€šè¿‡rolesä¼ é€’å˜é‡</div><div class="line">å½“ç»™ä¸€ä¸ªä¸»æœºåº”ç”¨è§’è‰²çš„æ—¶å€™å¯ä»¥ä¼ é€’å˜é‡ï¼Œç„¶ååœ¨è§’è‰²å†…ä½¿ç”¨è¿™äº›å˜é‡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</div><div class="line">- hosts: webservers</div><div class="line">  roles:</div><div class="line">    - common</div><div class="line">    - &#123; role: foo_app_instance, dir: &apos;/web/htdocs/a.com&apos;,  port: 8080 &#125;</div><div class="line">Inventory</div><div class="line">    ansibleçš„ä¸»è¦åŠŸç”¨åœ¨äºæ‰¹é‡ä¸»æœºæ“ä½œï¼Œä¸ºäº†ä¾¿æ·åœ°ä½¿ç”¨å…¶ä¸­çš„éƒ¨åˆ†ä¸»æœº;</div><div class="line">    å¯ä»¥åœ¨inventory fileä¸­å°†å…¶åˆ†ç»„å‘½åï¼Œé»˜è®¤çš„inventory fileä¸º/etc/ansible/hosts;</div><div class="line">    inventory fileå¯ä»¥æœ‰å¤šä¸ªï¼Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡Dynamic Inventoryæ¥åŠ¨æ€ç”Ÿæˆ;</div><div class="line">inventoryæ–‡ä»¶æ ¼å¼</div><div class="line">    inventoryæ–‡ä»¶éµå¾ªINIæ–‡ä»¶é£æ ¼ï¼Œä¸­æ‹¬å·ä¸­çš„å­—ç¬¦ä¸ºç»„å;</div><div class="line">    å¯ä»¥å°†åŒä¸€ä¸ªä¸»æœºåŒæ—¶å½’å¹¶åˆ°å¤šä¸ªä¸åŒçš„ç»„ä¸­ï¼›</div><div class="line">    æ­¤å¤–ï¼Œå½“å¦‚è‹¥ç›®æ ‡ä¸»æœºä½¿ç”¨äº†éé»˜è®¤çš„SSHç«¯å£ï¼Œè¿˜å¯ä»¥åœ¨ä¸»æœºåç§°ä¹‹åä½¿ç”¨å†’å·åŠ ç«¯å£å·æ¥æ ‡æ˜;</div><div class="line"></div><div class="line">        [webservers]</div><div class="line">            web1.ssjinyao.com:25181</div><div class="line">            web2.ssjinyao.com</div><div class="line">        [dbservers]</div><div class="line">        db1.ssjinyao</div><div class="line">        db2.ssjinyao.com</div><div class="line">        db3.ssjinyao.com</div><div class="line">å¦‚æœä¸»æœºåç§°éµå¾ªç›¸ä¼¼çš„å‘½åæ¨¡å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ—è¡¨çš„æ–¹å¼æ ‡è¯†å„ä¸»æœºï¼Œä¾‹å¦‚ï¼š</div><div class="line"></div><div class="line">            [webservers]</div><div class="line">            www[01:50].ssjinyao.com</div><div class="line">            [databases]</div><div class="line">            db-[a:f].ssjinyao.com</div><div class="line"></div><div class="line">ä¸»æœºå˜é‡</div><div class="line">    å¯ä»¥åœ¨inventoryä¸­å®šä¹‰ä¸»æœºæ—¶ä¸ºå…¶æ·»åŠ ä¸»æœºå˜é‡ä»¥ä¾¿äºåœ¨playbookä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼š</div><div class="line">        [webservers]</div><div class="line">        web1.ssjinyao.com http_port=80 maxRequestsPerChild=808</div><div class="line">        web2.ssjinyao.com http_port=8080 maxRequestsPerChild=909</div><div class="line"></div><div class="line">ç»„å˜é‡</div><div class="line">    ç»„å˜é‡æ˜¯æŒ‡èµ‹äºˆç»™æŒ‡å®šç»„å†…æ‰€æœ‰ä¸»æœºä¸Šçš„åœ¨playbookä¸­å¯ç”¨çš„å˜é‡ã€‚ä¾‹å¦‚ï¼š</div><div class="line">    [webservers]</div><div class="line">    web1.ssjinyao.com</div><div class="line">    web2.ssjinyao.com</div><div class="line">    </div><div class="line">    [webservers:vars]</div><div class="line">    ntp_server=web1.ssjinyao.com</div><div class="line">    nfs_server=web2.ssjinyao.com</div><div class="line"></div><div class="line">ç»„åµŒå¥—</div><div class="line">    åœ¨inventoryä¸­ç»„è¿˜å¯ä»¥åŒ…å«å…¶å®ƒçš„ç»„ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥å‘ç»„ä¸­çš„ä¸»æœºæŒ‡å®šå˜é‡;</div><div class="line">    ä¸è¿‡ï¼Œè¿™äº›å˜é‡åªèƒ½åœ¨ansible-playbookä¸­ä½¿ç”¨ï¼Œè€Œansibleä¸æ”¯æŒ;</div><div class="line">    </div><div class="line">[apache]</div><div class="line">httpd1.ssjinyao.com</div><div class="line">httpd2.ssjinyao.com</div><div class="line">[nginx]</div><div class="line">nginx1.ssjinyao.com</div><div class="line">nginx2.ssjinyao.com</div><div class="line">[webservers:children]</div><div class="line">apache</div><div class="line">nginx</div><div class="line">[webservers:vars]</div><div class="line">ntp_server=ntp.ssjinyao.com</div><div class="line">    inventoryå‚æ•°</div><div class="line">        ansibleåŸºäºsshè¿æ¥inventoryä¸­æŒ‡å®šçš„è¿œç¨‹ä¸»æœºæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šå…¶äº¤äº’æ–¹å¼ï¼›è¿™äº›å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</div><div class="line">            ansible_ssh_host</div><div class="line">                The name of the host to connect to, if different from the alias you wish to give to it.</div><div class="line">            ansible_ssh_port</div><div class="line">                The ssh port number, if not 22</div><div class="line">            ansible_ssh_user</div><div class="line">                The default ssh user name to use.</div><div class="line">            ansible_ssh_pass</div><div class="line">                The ssh password to use (this is insecure, we strongly recommend using --ask-pass or SSH keys)</div><div class="line">            ansible_sudo_pass</div><div class="line">                The sudo password to use (this is insecure, we strongly recommend using --ask-sudo-pass)</div><div class="line">            ansible_connection</div><div class="line">                Connection type of the host. Candidates are local, ssh or paramiko.  The default is paramiko before         </div><div class="line">                Ansible 1.2, and &apos;smart&apos; afterwards which detects whether usage of &apos;ssh&apos; would be feasible based on         </div><div class="line">                whether ControlPersist is supported.</div><div class="line">        ansible_ssh_private_key_file</div><div class="line">                Private key file used by ssh.  Useful if using multiple keys and you don&apos;t want to use SSH agent.</div><div class="line">ansible_shell_type</div><div class="line">                The shell type of the target system. By default commands are formatted using &apos;sh&apos;-style syntax by default. </div><div class="line">                Setting this to &apos;csh&apos; or &apos;fish&apos; will cause commands executed on target systems to follow those shell&apos;s syntax instead.</div><div class="line">            ansible_python_interpreter</div><div class="line">                The target host python path. This is useful for systems with more</div><div class="line">                than one Python or not located at &quot;/usr/bin/python&quot; such as \*BSD, or where /usr/bin/python</div><div class="line">                is not a 2.X series Python.  We do not use the &quot;/usr/bin/env&quot; mechanism as that requires the remote user&apos;s</div><div class="line">                path to be set right and also assumes the &quot;python&quot; executable is named python, where the executable might</div><div class="line">                 be named something like &quot;python26&quot;.</div><div class="line">                ansible\_\*\_interpreter</div><div class="line">                Works for anything such as ruby or perl and works just like ansible_python_interpreter.</div><div class="line">                This replaces shebang of modules which will run on that host.</div></pre></td></tr></table></figure><h3 id="æ¡ä»¶æµ‹è¯•"><a href="#æ¡ä»¶æµ‹è¯•" class="headerlink" title="æ¡ä»¶æµ‹è¯•"></a>æ¡ä»¶æµ‹è¯•</h3><p>å¦‚æœéœ€è¦æ ¹æ®å˜é‡ã€factsæˆ–æ­¤å‰ä»»åŠ¡çš„æ‰§è¡Œç»“æœæ¥åšä¸ºæŸtaskæ‰§è¡Œä¸å¦çš„å‰ææ—¶è¦ç”¨åˆ°æ¡ä»¶æµ‹è¯•;</p><h3 id="whenè¯­å¥"><a href="#whenè¯­å¥" class="headerlink" title="whenè¯­å¥"></a>whenè¯­å¥</h3><p>åœ¨taskåæ·»åŠ whenå­å¥å³å¯ä½¿ç”¨æ¡ä»¶æµ‹è¯•ï¼›whenè¯­å¥æ”¯æŒJinja2è¡¨è¾¾å¼è¯­æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">  - name: &quot;shutdown Debian flavored systems&quot;</div><div class="line">    command: /sbin/shutdown -h now</div><div class="line">    when: ansible_os_family == &quot;Debian&quot;</div><div class="line"># whenè¯­å¥ä¸­è¿˜å¯ä»¥ä½¿ç”¨Jinja2çš„å¤§å¤šâ€œfilterâ€;</div><div class="line"># ä¾‹å¦‚è¦å¿½ç•¥æ­¤å‰æŸè¯­å¥çš„é”™è¯¯å¹¶åŸºäºå…¶ç»“æœï¼ˆfailedæˆ–è€…sucessï¼‰è¿è¡Œåé¢æŒ‡å®šçš„è¯­å¥</div><div class="line">tasks:</div><div class="line">  - command: /bin/false</div><div class="line">    register: result</div><div class="line">    ignore_errors: True</div><div class="line">  - command: /bin/something</div><div class="line">    when: result|failed</div><div class="line">  - command: /bin/something_else</div><div class="line">    when: result|success</div><div class="line">  - command: /bin/still/something_else</div><div class="line">    when: result|skipped</div><div class="line">- hosts: all </div><div class="line">  remote_user: root</div><div class="line">  vars:</div><div class="line">  - username: user10</div><div class="line">  tasks:</div><div class="line">  - name: create &#123;&#123; username &#125;&#125; user</div><div class="line">    user: name=&#123;&#123;username&#125;&#125;</div><div class="line">    when: ansible_fqdn == &quot;fabric2&quot;</div><div class="line"># whenè¯­å¥ä¸­è¿˜å¯ä»¥ä½¿ç”¨factsæˆ–playbookä¸­å®šä¹‰çš„å˜é‡;</div></pre></td></tr></table></figure><h3 id="è¿­ä»£"><a href="#è¿­ä»£" class="headerlink" title="è¿­ä»£"></a>è¿­ä»£</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># å½“æœ‰éœ€è¦é‡å¤æ€§æ‰§è¡Œçš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿­ä»£æœºåˆ¶;</div><div class="line"># å…¶ä½¿ç”¨æ ¼å¼ä¸ºå°†éœ€è¦è¿­ä»£çš„å†…å®¹å®šä¹‰ä¸ºitemå˜é‡å¼•ç”¨ï¼Œå¹¶é€šè¿‡with_itemsè¯­å¥æ¥æŒ‡æ˜è¿­ä»£çš„å…ƒç´ åˆ—è¡¨</div><div class="line">- name: add several users</div><div class="line">  user: name=&#123;&#123; item &#125;&#125; state=present groups=wheel</div><div class="line">  with_items:</div><div class="line">     - testuser1</div><div class="line">     - testuser2</div><div class="line"># ä¸Šé¢è¯­å¥åŠŸèƒ½ç­‰åŒäºä¸‹é¢è¯­å¥çš„åŠŸèƒ½</div><div class="line">- name: add user testuser1</div><div class="line">  user: name=testuser1 state=present groups=wheel</div><div class="line">- name: add user testuser2</div><div class="line">  user: name=testuser2 state=present groups=wheel</div><div class="line"># with_itemsä¸­å¯ä»¥ä½¿ç”¨å…ƒç´ è¿˜å¯ä¸ºhashes</div><div class="line">- name: add several users</div><div class="line">  user: name=&#123;&#123; item.name &#125;&#125; state=present groups=&#123;&#123; item.groups &#125;&#125;</div><div class="line">  with_items:</div><div class="line">    - &#123; name: &apos;testuser1&apos;, groups: &apos;wheel&apos; &#125;</div><div class="line">    - &#123; name: &apos;testuser2&apos;, groups: &apos;root&apos; &#125;</div></pre></td></tr></table></figure><h3 id="Hostå’ŒUser"><a href="#Hostå’ŒUser" class="headerlink" title="Hostå’ŒUser"></a>Hostå’ŒUser</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># playbookä¸­çš„æ¯ä¸€ä¸ªplayçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†è®©æŸä¸ªæˆ–æŸäº›ä¸»æœºä»¥æŸä¸ªæŒ‡å®šçš„ç”¨æˆ·èº«ä»½æ‰§è¡Œä»»åŠ¡;</div><div class="line"># hostsç”¨äºæŒ‡å®šè¦æ‰§è¡ŒæŒ‡å®šä»»åŠ¡çš„ä¸»æœºï¼Œå…¶å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªç”±å†’å·åˆ†éš”ä¸»æœºç»„</div><div class="line"># remote_useråˆ™ç”¨äºæŒ‡å®šè¿œç¨‹ä¸»æœºä¸Šçš„æ‰§è¡Œä»»åŠ¡çš„ç”¨æˆ·;</div><div class="line">-hosts: webnodes</div><div class="line"> remote_user: root</div><div class="line"></div><div class="line"># remote_userä¹Ÿå¯ç”¨äºå„taskä¸­;</div><div class="line"># ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå…¶é€šè¿‡sudoçš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå…¶å¯ç”¨äºplayå…¨å±€æˆ–æŸä»»åŠ¡;</div><div class="line"># å¯ä»¥åœ¨sudoæ—¶ä½¿ç”¨sudo_useræŒ‡å®šsudoæ—¶åˆ‡æ¢çš„ç”¨æˆ·ã€‚</div><div class="line"></div><div class="line">- hosts: webnodes</div><div class="line">  remote_user: ssjinyao</div><div class="line">  tasks:</div><div class="line">    - name: test connection</div><div class="line">      ping:</div><div class="line">      remote_user: ssjinyao</div><div class="line">      sudo: yes</div></pre></td></tr></table></figure><h3 id="ä»»åŠ¡åˆ—è¡¨ä¸action"><a href="#ä»»åŠ¡åˆ—è¡¨ä¸action" class="headerlink" title="ä»»åŠ¡åˆ—è¡¨ä¸action"></a>ä»»åŠ¡åˆ—è¡¨ä¸action</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># playçš„ä¸»ä½“éƒ¨åˆ†æ˜¯task list;</div><div class="line"># task listä¸­çš„å„ä»»åŠ¡æŒ‰æ¬¡åºé€ä¸ªåœ¨hostsä¸­æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼Œå³åœ¨æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡åå†å¼€å§‹ç¬¬äºŒä¸ª</div><div class="line"># åœ¨è¿è¡Œè‡ªä¸‹è€Œä¸‹æŸplaybookæ—¶ï¼Œå¦‚æœä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œæ‰€æœ‰å·²æ‰§è¡Œä»»åŠ¡éƒ½å°†å›æ»šï¼Œå› æ­¤ï¼Œåœ¨æ›´æ­£playbookåé‡æ–°æ‰§è¡Œä¸€æ¬¡å³å¯;</div><div class="line"># taskçš„ç›®çš„æ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°æ‰§è¡Œæ¨¡å—ï¼Œè€Œåœ¨æ¨¡å—å‚æ•°ä¸­å¯ä»¥ä½¿ç”¨å˜é‡;</div><div class="line"># æ¨¡å—æ‰§è¡Œæ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€å¤šæ¬¡æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ç»“æœå‡ä¸€è‡´;</div><div class="line"># æ¯ä¸ªtaskéƒ½åº”è¯¥æœ‰å…¶nameï¼Œç”¨äºplaybookçš„æ‰§è¡Œç»“æœè¾“å‡º;</div><div class="line"># å»ºè®®å…¶å†…å®¹å°½å¯èƒ½æ¸…æ™°åœ°æè¿°ä»»åŠ¡æ‰§è¡Œæ­¥éª¤,å¦‚æœæœªæä¾›nameï¼Œåˆ™actionçš„ç»“æœå°†ç”¨äºè¾“å‡ºã€‚</div><div class="line"></div><div class="line"># å®šä¹‰taskçš„å¯ä»¥ä½¿ç”¨â€œaction: module optionsâ€æˆ–â€œmodule: optionsâ€çš„æ ¼å¼ï¼Œæ¨èä½¿ç”¨åè€…ä»¥å®ç°å‘åå…¼å®¹;</div><div class="line"># å¦‚æœactionä¸€è¡Œçš„å†…å®¹è¿‡å¤šï¼Œä¹Ÿä¸­ä½¿ç”¨åœ¨è¡Œé¦–ä½¿ç”¨å‡ ä¸ªç©ºç™½å­—ç¬¦è¿›è¡Œæ¢è¡Œã€‚</div><div class="line">tasks:</div><div class="line">  - name: make sure apache is running</div><div class="line">    service: name=httpd state=running</div><div class="line"># åœ¨ä¼—å¤šæ¨¡å—ä¸­ï¼Œåªæœ‰commandå’Œshellæ¨¡å—ä»…éœ€è¦ç»™å®šä¸€ä¸ªåˆ—è¡¨è€Œæ— éœ€ä½¿ç”¨â€œkey=valueâ€æ ¼å¼ï¼Œä¾‹å¦‚ï¼š</div><div class="line">tasks:</div><div class="line">  - name: disable selinux</div><div class="line">    command: /sbin/setenforce 0</div><div class="line"># å¦‚æœå‘½ä»¤æˆ–è„šæœ¬çš„é€€å‡ºç ä¸ä¸ºé›¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ›¿ä»£ï¼š</div><div class="line">tasks:</div><div class="line">  - name: run this command and ignore the result</div><div class="line">    shell: /usr/bin/somecommand || /bin/true</div><div class="line"># æˆ–è€…ä½¿ç”¨ignore_errorsæ¥å¿½ç•¥é”™è¯¯ä¿¡æ¯ï¼š</div><div class="line">tasks:</div><div class="line">  - name: run this command and ignore the result</div><div class="line">    shell: /usr/bin/somecommand</div><div class="line">    ignore_errors: True</div></pre></td></tr></table></figure><h3 id="handlers"><a href="#handlers" class="headerlink" title="handlers"></a>handlers</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># ç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶é‡‡å–ä¸€å®šçš„æ“ä½œ;</div><div class="line"># â€œnotifyâ€è¿™ä¸ªactionå¯ç”¨äºåœ¨æ¯ä¸ªplayçš„æœ€åè¢«è§¦å‘;</div><div class="line"># è¿™æ ·å¯ä»¥é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œå–è€Œä»£ä¹‹;</div><div class="line"># ä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œ;</div><div class="line"># åœ¨notifyä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸ºhandlerï¼Œä¹Ÿå³notifyä¸­è°ƒç”¨handlerä¸­å®šä¹‰çš„æ“ä½œ;</div><div class="line">- name: template configuration file</div><div class="line">  template: src=template.j2 dest=/etc/foo.conf</div><div class="line">  notify:</div><div class="line">     - restart memcached</div><div class="line">     - restart apache</div><div class="line"># handleræ˜¯taskåˆ—è¡¨ï¼Œè¿™äº›taskä¸å‰è¿°çš„taskå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒ;</div><div class="line">handlers:</div><div class="line">    - name: restart memcached</div><div class="line">      service:  name=memcached state=restarted</div><div class="line">    - name: restart apache</div><div class="line">      service: name=apache state=restarted</div></pre></td></tr></table></figure><h3 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"># ansilbeè‡ª1.2ç‰ˆæœ¬å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œç”¨äºå±‚æ¬¡æ€§ã€ç»“æ„åŒ–åœ°ç»„ç»‡playbook;</div><div class="line"># rolesèƒ½å¤Ÿæ ¹æ®å±‚æ¬¡å‹ç»“æ„è‡ªåŠ¨è£…è½½å˜é‡æ–‡ä»¶ã€tasksä»¥åŠhandlersç­‰;</div><div class="line"># è¦ä½¿ç”¨rolesåªéœ€è¦åœ¨playbookä¸­ä½¿ç”¨includeæŒ‡ä»¤å³å¯;</div><div class="line"># roleså°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡ã€æ–‡ä»¶ã€ä»»åŠ¡ã€æ¨¡å—åŠå¤„ç†å™¨æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­;</div><div class="line"># å¹¶å¯ä»¥ä¾¿æ·åœ°includeå®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚è§’è‰²ä¸€èˆ¬ç”¨äºåŸºäºä¸»æœºæ„å»ºæœåŠ¡çš„åœºæ™¯ä¸­ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç”¨äºæ„å»ºå®ˆæŠ¤è¿›ç¨‹ç­‰åœºæ™¯ä¸­;</div><div class="line">    ä¸€ä¸ªrolesçš„æ¡ˆä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</div><div class="line">    site.yml</div><div class="line">    webservers.yml</div><div class="line">    fooservers.yml</div><div class="line">    roles/</div><div class="line">       common/</div><div class="line">         files/</div><div class="line">         templates/</div><div class="line">         tasks/</div><div class="line">         handlers/</div><div class="line">         vars/</div><div class="line">         meta/</div><div class="line">       webservers/</div><div class="line">         files/</div><div class="line">         templates/</div><div class="line">         tasks/</div><div class="line">         handlers/</div><div class="line">         vars/</div><div class="line">         meta/</div><div class="line">è€Œåœ¨playbookä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨rolesï¼š</div><div class="line">    ---</div><div class="line">    </div><div class="line">    - hosts: webservers</div><div class="line">    roles:</div><div class="line">     - common</div><div class="line">     - webservers</div><div class="line">    ä¹Ÿå¯ä»¥å‘rolesä¼ é€’å‚æ•°ï¼Œä¾‹å¦‚ï¼š</div><div class="line">    ---</div><div class="line">    </div><div class="line">    - hosts: webservers</div><div class="line">    roles:</div><div class="line">    - common</div><div class="line">    - &#123; role: foo_app_instance, dir: &apos;/opt/a&apos;,  port: 5000 &#125;</div><div class="line">    - &#123; role: foo_app_instance, dir: &apos;/opt/b&apos;,  port: 5001 &#125;</div><div class="line">    </div><div class="line">    ç”šè‡³ä¹Ÿå¯ä»¥æ¡ä»¶å¼åœ°ä½¿ç”¨rolesï¼Œä¾‹å¦‚ï¼š</div><div class="line">    ---</div><div class="line">    </div><div class="line">    - hosts: webservers</div><div class="line">    roles:</div><div class="line">    - &#123; role: some_role, when: &quot;ansible_os_family == &apos;RedHat&apos;&quot; &#125;</div></pre></td></tr></table></figure><h3 id="åˆ›å»ºroleçš„æ­¥éª¤"><a href="#åˆ›å»ºroleçš„æ­¥éª¤" class="headerlink" title="åˆ›å»ºroleçš„æ­¥éª¤"></a>åˆ›å»ºroleçš„æ­¥éª¤</h3><ul><li>åˆ›å»ºä»¥roleså‘½åçš„ç›®å½•ï¼›</li><li>åœ¨rolesç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºä»¥å„è§’è‰²åç§°å‘½åçš„ç›®å½•ï¼Œå¦‚webserversç­‰ï¼›</li><li>åœ¨æ¯ä¸ªè§’è‰²å‘½åçš„ç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºfilesã€handlersã€metaã€tasksã€templateså’Œvarsç›®å½•ï¼›</li><li>ç”¨ä¸åˆ°çš„ç›®å½•å¯ä»¥åˆ›å»ºä¸ºç©ºç›®å½•ï¼Œä¹Ÿå¯ä»¥ä¸åˆ›å»ºï¼›</li><li>åœ¨playbookæ–‡ä»¶ä¸­ï¼Œè°ƒç”¨å„è§’è‰²ï¼›</li></ul><h3 id="roleå†…å„ç›®å½•ä¸­å¯ç”¨çš„æ–‡ä»¶"><a href="#roleå†…å„ç›®å½•ä¸­å¯ç”¨çš„æ–‡ä»¶" class="headerlink" title="roleå†…å„ç›®å½•ä¸­å¯ç”¨çš„æ–‡ä»¶"></a>roleå†…å„ç›®å½•ä¸­å¯ç”¨çš„æ–‡ä»¶</h3><ol><li>tasksç›®å½•ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œå…¶å®šä¹‰äº†æ­¤è§’è‰²çš„ä»»åŠ¡åˆ—è¡¨ï¼›æ­¤æ–‡ä»¶å¯ä»¥ä½¿ç”¨includeåŒ…å«å…¶å®ƒçš„ä½äºæ­¤ç›®å½•ä¸­çš„taskæ–‡ä»¶;</li><li>filesç›®å½•ï¼šå­˜æ”¾ç”±copyæˆ–scriptç­‰æ¨¡å—è°ƒç”¨çš„æ–‡ä»¶;</li><li>templatesç›®å½•ï¼štemplateæ¨¡å—ä¼šè‡ªåŠ¨åœ¨æ­¤ç›®å½•ä¸­å¯»æ‰¾Jinja2æ¨¡æ¿æ–‡ä»¶;</li><li>handlersç›®å½•ï¼šæ­¤ç›®å½•ä¸­åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å„handlerï¼›åœ¨handlerä¸­ä½¿ç”¨includeåŒ…å«çš„å…¶å®ƒçš„handleræ–‡ä»¶ä¹Ÿåº”è¯¥ä½äºæ­¤ç›®å½•ä¸­;</li><li>varsç›®å½•ï¼šåº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å˜é‡;</li><li>metaç›®å½•ï¼šåº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»;</li><li>ansible 1.3åŠå…¶ä»¥åçš„ç‰ˆæœ¬æ‰æ”¯æŒ;</li><li>defaultç›®å½•ï¼šä¸ºå½“å‰è§’è‰²è®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨æ­¤ç›®å½•ï¼›åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶;</li></ol><h3 id="Tags"><a href="#Tags" class="headerlink" title="Tags"></a>Tags</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tagsç”¨äºè®©ç”¨æˆ·é€‰æ‹©è¿è¡Œæˆ–è·¯è¿‡playbookä¸­çš„éƒ¨åˆ†ä»£ç ;</div><div class="line">ansibleå…·æœ‰å¹‚ç­‰æ€§ï¼Œå› æ­¤ä¼šè‡ªåŠ¨è·³è¿‡æ²¡æœ‰å˜åŒ–çš„éƒ¨åˆ†;</div><div class="line">æœ‰äº›ä»£ç ä¸ºæµ‹è¯•å…¶ç¡®å®æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶é—´ä¾ç„¶ä¼šéå¸¸åœ°é•¿;</div><div class="line">æ­¤æ—¶ï¼Œå¦‚æœç¡®ä¿¡å…¶æ²¡æœ‰å˜åŒ–ï¼Œå°±å¯ä»¥é€šè¿‡tagsè·³è¿‡æ­¤äº›ä»£ç ç‰‡æ–­ã€‚</div></pre></td></tr></table></figure><ol><li>ç›®å½•ååŒè§’è‰²å;</li><li>ç›®å½•ç»“æ„æœ‰å›ºå®šæ ¼å¼;</li><li>files: è¡¨æ€æ–‡ä»¶;</li></ol><ul><li>templates: Jinjia2æ¨¡æ¿æ–‡ä»¶;</li><li>tasks:è‡³å°‘æœ‰main.ymlæ–‡ä»¶ï¼Œå®šä¹‰å„tasks;</li><li>handlers: è‡³å°‘æœ‰ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œå®šä¹‰å„handlers;</li><li>vars:è‡³å°‘æœ‰ä¸€ä¸ªmian.ymlæ–‡ä»¶ï¼Œå®šä¹‰å˜é‡;</li><li>meta:å®šä¹‰ä¾èµ–å…³ç³»ç­‰ä¿¡æ¯;</li><li>site.ymlä¸­å®šä¹‰playbookï¼Œé¢å¤–ä¹Ÿå¯ä»¥æœ‰å…¶å®ƒçš„ymlæ–‡ä»¶;</li></ul><h3 id="ansible-playbookä½¿ç”¨ç¤ºä¾‹"><a href="#ansible-playbookä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ansible-playbookä½¿ç”¨ç¤ºä¾‹"></a>ansible-playbookä½¿ç”¨ç¤ºä¾‹</h3><h4 id="åœ¨webserverä¸­æ‰§è¡Œç®€å•ç®¡ç†ç±»å‘½ä»¤"><a href="#åœ¨webserverä¸­æ‰§è¡Œç®€å•ç®¡ç†ç±»å‘½ä»¤" class="headerlink" title="åœ¨webserverä¸­æ‰§è¡Œç®€å•ç®¡ç†ç±»å‘½ä»¤"></a>åœ¨webserverä¸­æ‰§è¡Œç®€å•ç®¡ç†ç±»å‘½ä»¤</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">test.yml </div><div class="line">- hosts: webserver</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">  - name: create nginx group</div><div class="line">    group: name=nginx system=yes gid=208</div><div class="line">  - name: create nginx user</div><div class="line">    user: name=nginx uid=208 group=nginx system=yes</div><div class="line">- hosts: dbserver</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">  - name: copy file to db_servers</div><div class="line">    copy: src=/etc/inittab dest=/tmp/inittab.ans## ansible-playbook test.yml</div></pre></td></tr></table></figure><h4 id="heartbeat-éƒ¨ç½²"><a href="#heartbeat-éƒ¨ç½²" class="headerlink" title="heartbeat éƒ¨ç½²"></a>heartbeat éƒ¨ç½²</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">heartbeat.yaml</div><div class="line">- hosts: hbhosts</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">    - name: ensure heartbeat latest version</div><div class="line">      yum: name=heartbeat state=present</div><div class="line">    - name: authkeys configure file</div><div class="line">      copy: src=/root/hb_conf/authkeys dest=/etc/ha.d/authkeys</div><div class="line">    - name: authkeys mode 600</div><div class="line">      file: path=/etc/ha.d/authkeys mode=600</div><div class="line">      notify:</div><div class="line">        - restart heartbeat</div><div class="line">    - name: ha.cf configure file</div><div class="line">      copy: src=/root/hb_conf/ha.cf dest=/etc/ha.d/ha.cf</div><div class="line">      notify: </div><div class="line">       - restart heartbeat</div><div class="line">  handlers:</div><div class="line">  - name: restart heartbeat</div><div class="line">    service: name=heartbeat state=restarted</div></pre></td></tr></table></figure><h4 id="ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–"><a href="#ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–"></a>ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line">--- </div><div class="line">- hosts: all</div><div class="line">  tasks:</div><div class="line">    - name: Add mongodb 3.4 yum repo</div><div class="line">      template: src=./yum/mongo34.repo dest=/etc/yum.repos.d/</div><div class="line">    - name: Yum remove old mongodb</div><div class="line">      yum: name=mongodb state=removed update_cache=true</div><div class="line">    - name: Yum install mongodb 3.4</div><div class="line">      yum: name=mongodb-org state=installed update_cache=true</div><div class="line">    - name: Mongo shell edit</div><div class="line">      shell: |</div><div class="line">        killall mongod</div><div class="line">        echo &apos;never&apos; &gt; /sys/kernel/mm/transparent_hugepage/enabled</div><div class="line">        echo &apos;never&apos; &gt; /sys/kernel/mm/transparent_hugepage/defrag</div><div class="line">    - name: start mongodb</div><div class="line">      service: name=mongod state=restarted</div><div class="line"></div><div class="line">    - name: Create mongo user and passwd admin xxxxxx</div><div class="line">      mongodb_user: </div><div class="line">        name: &quot;admin&quot; </div><div class="line">        password: &quot;xxxxxxssjinyao.com&quot; </div><div class="line">        database: &quot;admin&quot;</div><div class="line">        roles: &quot;userAdminAnyDatabase&quot; </div><div class="line">        state: &quot;present&quot;</div><div class="line">      yum: name=mod_ssl state=installed update_cache=true</div><div class="line">    - name: Install git</div><div class="line">      yum: name=git state=installed update_cache=true</div><div class="line">    - name: Install tree</div><div class="line">      yum: name=tree state=installed update_cache=true</div><div class="line"></div><div class="line">    - name: Install any packages</div><div class="line">      yum: name=&#123;&#123;item&#125;&#125; state=installed update_cache=true</div><div class="line">      with_items:</div><div class="line">        - libffi</div><div class="line">        - libffi-devel</div><div class="line">        - openssl</div><div class="line">        - openssl-devel</div><div class="line">        - libxml2</div><div class="line">        - libxml2-devel</div><div class="line">        - libjpeg-turbo</div><div class="line">        - libjpeg-turbo-devel</div><div class="line"></div><div class="line">    - name: Install any packages2</div><div class="line">      yum: name=&#123;&#123;item&#125;&#125; state=installed update_cache=true</div><div class="line">      with_items:</div><div class="line">        - zlib</div><div class="line">        - zlib-devel</div><div class="line">        - vim</div><div class="line">        - httpd</div><div class="line">        - mariadb-server</div><div class="line">        - redis</div><div class="line">        - php</div><div class="line">        - php-intl</div><div class="line">        - php-pear</div><div class="line">        - php-devel</div><div class="line">        - libicu</div><div class="line">        - libicu-devel</div><div class="line">        - git</div><div class="line">        - centos-release-scl</div><div class="line"></div><div class="line">    - name: Install any packages3</div><div class="line">      yum: name=&#123;&#123;item&#125;&#125; state=present update_cache=true</div><div class="line">      with_items:</div><div class="line">        - python-pip</div><div class="line">        - python-devel</div><div class="line">        - gcc</div><div class="line">        - gcc-c++</div><div class="line">        - kernel-devel </div><div class="line">        - make</div><div class="line">        - MySQL-python</div><div class="line">        - php-mysql</div><div class="line">        - php-gd</div><div class="line">        - mysql-devel</div><div class="line">        - libcurl</div><div class="line">        - libcurl-devel</div><div class="line">        - python-lxml </div><div class="line"></div><div class="line">    - name: Install any packages4</div><div class="line">      yum: name=&#123;&#123;item&#125;&#125; state=present update_cache=true</div><div class="line">      with_items:</div><div class="line">        - php55</div><div class="line">        - php-pecl-mongo</div><div class="line">        - php55-php</div><div class="line">        - php55-php-gd</div><div class="line">        - php55-php-mbstring</div><div class="line">        - php55-php-devel</div><div class="line">        - php55-php-mysqlnd</div><div class="line">        - php55-php-ldap</div><div class="line">        - php55-php-intl</div><div class="line">        - php55-php-pear</div><div class="line">        - php55-php-mongo</div><div class="line">        - unzip</div><div class="line"></div><div class="line">    - name: Install any packages5 other, you can add</div><div class="line">      yum: name=&#123;&#123;item&#125;&#125; state=present update_cache=true</div><div class="line">      with_items: </div><div class="line">        - readline-devel</div><div class="line">        - patch</div><div class="line"></div><div class="line">    - name: Copy php-55 config file to etc</div><div class="line">      copy: remote_src=True src=/opt/rh/httpd24/root/etc/httpd/conf.d/php55-php.conf dest=/etc/httpd/conf.d/</div><div class="line">    - name: Copy php-55 httpd modules to etc</div><div class="line">      copy: remote_src=True src=/opt/rh/httpd24/root/etc/httpd/conf.modules.d/10-php55-php.conf dest=/etc/httpd/conf.d/</div><div class="line">    - name: Copy php-55 httpd moduels to etc</div><div class="line">      copy: remote_src=True src=/opt/rh/httpd24/root/etc/httpd/modules/libphp55-php5.so dest=/etc/httpd/modules/</div><div class="line"></div><div class="line">    - name: pip install any packages</div><div class="line">      pip: name=&#123;&#123;item&#125;&#125; state=present</div><div class="line">      with_items:</div><div class="line">        - supervisor</div><div class="line">        - virtualenv</div><div class="line">        - celery</div><div class="line">        - flower</div><div class="line">        - mongo</div><div class="line">        - redis</div><div class="line"></div><div class="line">    - name: echo a messages</div><div class="line">      shell: |</div><div class="line">        ifconfig &amp;&gt; /tmp/test.ifconfig</div><div class="line">        netstat -ant &amp;&gt; /tmp/test.netstat</div><div class="line">        exit 0</div><div class="line">      notify:</div><div class="line">        - start nginx </div><div class="line">    - name: Add redis config file </div><div class="line">      template: src=./redis/redis.conf dest=/etc/</div><div class="line"></div><div class="line">    - name: start redis </div><div class="line">      service: name=redis  state=started</div><div class="line"></div><div class="line">    - name: stop apache </div><div class="line">      service: name=httpd state=stopped</div><div class="line"></div><div class="line">  handlers:</div><div class="line">    - name: start nginx</div><div class="line">      service: name=nginx state=started</div><div class="line">    - name: restart httpd</div><div class="line">      service: name=httpd state=restarted</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>zabbixç›‘æ§å®ç°æ–‡æ¡£</title>
      <link href="/2018/04/02/zabbix%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/"/>
      <url>/2018/04/02/zabbix%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/</url>
      <content type="html"><![CDATA[<h1 id="Zabbix-ç›‘æ§å®ç°æ–‡æ¡£"><a href="#Zabbix-ç›‘æ§å®ç°æ–‡æ¡£" class="headerlink" title="Zabbix ç›‘æ§å®ç°æ–‡æ¡£"></a>Zabbix ç›‘æ§å®ç°æ–‡æ¡£</h1><p><img src="/images/zabbix_chatu.png" alt=""></p><h2 id="ç†è®ºçŸ¥è¯†äº†è§£"><a href="#ç†è®ºçŸ¥è¯†äº†è§£" class="headerlink" title="ç†è®ºçŸ¥è¯†äº†è§£"></a>ç†è®ºçŸ¥è¯†äº†è§£</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ä¼ æ„Ÿå™¨;</div><div class="line">æ•°æ®é‡‡é›† --&gt; æ•°æ®å­˜å‚¨ --&gt; æ•°æ®å±•ç¤º; </div><div class="line">        æŠ¥è­¦: é‡‡é›†åˆ°çš„æ•°æ®è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œé€šå¸¸ä¼šæ‰§è¡ŒæŠ¥è­¦æ“ä½œ;</div><div class="line">        æ—¶é—´åºåˆ—æ•°æ®;</div><div class="line">å¤§è§„æ¨¡çš„ç›‘æ§:        </div><div class="line">å¼€æºç›‘æ§å·¥å…·: </div><div class="line">    Nagios</div><div class="line">æœ‰ä¸¤ç§ç»“ç‚¹ç±»å‹: </div><div class="line">NMS(ç½‘ç»œç›‘æ§ç³»ç»Ÿ)ï¼Œå‘¨æœŸæ€§çš„å®Œæˆæ•°æ®é‡‡é›†,ä¸”æœ€é‡è¦çš„æ˜¯è¦å®Œæˆå­˜å‚¨ï¼Œä¸ä»…ä»…æ˜¯ä¸»æœºã€‚æ›´é‡è¦çš„è·¯ç”±å™¨;  </div><div class="line">SNMP å¯¹å…¶å®ƒç‰©ç†è®¾å¤‡è¿›è¡Œç›‘æ§, Simple Network Management Protocol  </div><div class="line">ä¸€èˆ¬è€Œè¨€è¦å¯¹å…¶å®ƒç»“ç‚¹ä¸­å®‰è£…agentç«¯; </div><div class="line">SNMPçš„å·¥ä½œæ¨¡å¼:</div><div class="line">        NMSå‘agenté‡‡é›†æ•°æ®;</div><div class="line">        agentå‘NMSæŠ¥å‘Šæ•°æ®;</div><div class="line">        NMSè¯·æ±‚agentä¿®æ”¹é…ç½®;</div></pre></td></tr></table></figure><h3 id="SNMPçš„ç»„ä»¶"><a href="#SNMPçš„ç»„ä»¶" class="headerlink" title="SNMPçš„ç»„ä»¶"></a>SNMPçš„ç»„ä»¶</h3><p>MIB: management information base;<br>SMI: MIBè¡¨ç¤ºç¬¦å·;<br>SNMPåè®®ä¸­çš„ NMS;<br>SNMPåè®®çš„ç‰ˆæœ¬;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">v1,v2,v3</div><div class="line">v2c:NMS --&gt; agent</div><div class="line">v3:è®¤è¯ã€åŠ å¯†ã€ è§£å¯†</div></pre></td></tr></table></figure><p>NMS å¯ä»¥å‘èµ·çš„æ“ä½œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Get, GetNextï¼ŒSet, Trap(æ•è·);</div><div class="line">agent: Response,è¿”å›ä¸€ä¸ªæˆ–è€…å¤šä¸ªå€¼;</div><div class="line">UDP  NMS:161ç«¯å£  agent:162ç«¯å£;</div><div class="line">cacti: å¯ä»¥è°ƒç”¨ç¼–ç¨‹æ¥å£ï¼Œåˆ©ç”¨SNMPï¼Œå³æ—¶ç»˜åˆ¶å±•ç¤ºå›¾å½¢;</div><div class="line">cacti: æŠ¥è­¦èƒ½åŠ›æ˜¯éå¸¸å¼±çš„;</div><div class="line">    ä¸‡ä¸€æœåŠ¡è«åå¥‡å¦™çš„çš„å…³é—­äº†ï¼Œå¯ä»¥å°è¯•å¯åŠ¨æœåŠ¡ï¼Œå¯åŠ¨ä¸äº†åå†æ‰§è¡ŒæŠ¥è­¦æ“ä½œ;</div><div class="line">    ä¸ºé¿å…è¯¯åˆ¤ï¼Œåº”è¦å¤šæ¬¡é‡‡æ ·;</div><div class="line">Nagios: å¯ä»¥è°ƒç”¨å„ç§æŠ¥è­¦å·¥å…·æ¥æ‰§è¡ŒæŠ¥è­¦æ“ä½œ;</div><div class="line">    æŠ¥è­¦æ¬¡æ•°æ®å’ŒæŠ¥è­¦èŒƒå›´ï¼ŒæŠ¥è­¦èŒƒå›´çš„æ“ä½œ; </div><div class="line">    ä»£ç ä¸Šçº¿çš„æ—¶å€™ä¸éœ€è¦æŠ¥è­¦ï¼Œä¸”è¦å®šä¹‰ä¸æŠ¥è­¦æ—¶é—´æ®µ;</div><div class="line">    Nagios å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªéå¸¸å¼ºå¤§çš„æŠ¥è­¦å·¥å…·; </div><div class="line">    NMS å¯èƒ½è¦ç›‘æ§æ•°ä¸‡ä¸ªæŒ‡æ ‡ï¼Œé‚£ä¹ˆä¼šå¯¹NMS çš„ç£ç›˜IO,ç½‘ç»œå¸¦å®½ï¼ŒCPUè´Ÿè½½ç­‰é€ æˆè¾ƒå¤§çš„å‹åŠ›;</div><div class="line">        æˆ‘ä»¬å¯ä»¥å¯¹è®¾å¤‡ä¸ç½‘ç»œåˆ’åˆ†ï¼Œéƒ¨ç½²å¤šå¥—ç›‘æ§ç³»ç»Ÿï¼Œè€Œä¸”å®ƒä»¬æ˜¯ç”¨ä¸åŒçš„æ–¹æ³•å®ç°çš„;  </div><div class="line">        ä½†è¿™æ ·å¯¹æˆ‘ä»¬çš„é’ˆå¯¹å¼ç®¡ç†å°±ä¼šå¸¦æ¥å·¨å¤§çš„éº»çƒ¦;</div><div class="line">        å®ŒæˆçŠ¶æ€è½¬æ¢ï¼Œå¹¶å®ŒæˆæŠ¥è­¦;</div><div class="line">        cacti å®Œæˆæ•°æ®æ”¶é›†å’Œå±•ç¤ºï¼Œä½†å¯¹äºæŠ¥è­¦èƒ½åŠ›æ¯”è¾ƒè–„å¼±;</div></pre></td></tr></table></figure><p>Zabbix:ç»“åˆäº†ä»¥ä¸Šä¸¤ç§å·¥å…·çš„åŠŸèƒ½; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1ã€zabbix ä¼šè‡ªå·±å…ˆè§£å†³</div><div class="line">2ã€zabbix è§£å†³ä¸äº†æŠ¥è­¦ç»™éƒ¨é—¨è´Ÿè´£äºº</div><div class="line">3ã€zabbix ç»§ç»­æŠ¥è­¦å‡çº§ï¼ŒæŠ¥è­¦ç»™éƒ¨é—¨è´Ÿè´£äºº, éƒ¨é—¨é¢†å¯¼</div></pre></td></tr></table></figure><p>è‘—åçš„å¼€æºç›‘æ§å·¥å…·: zabbix, zennos, opennms, cacti, nagios(icinga),ganglia</p><p>(NMS linux) (è¢«ç›‘æ§ç«¯ Linuxä¸»æœº) </p><h3 id="ç›‘æ§åŠŸèƒ½çš„å®ç°"><a href="#ç›‘æ§åŠŸèƒ½çš„å®ç°" class="headerlink" title="ç›‘æ§åŠŸèƒ½çš„å®ç°:"></a>ç›‘æ§åŠŸèƒ½çš„å®ç°:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1ã€agent </div><div class="line">2ã€ssh</div><div class="line">3ã€SIMP</div><div class="line">4ã€IPMI æ™ºæ…§å¹³å°ç®¡ç†æ¥å£</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">zabbix NMS ä¸ agent ç«¯åŒæ–¹æ”¯æŒçš„åè®®(JSON,XML)</div><div class="line">è§†å›¾(è¯»æ“ä½œ/å†™æ“ä½œå„å®šä¹‰ä¸€ä¸ªå›¢ä½“)</div><div class="line">åœ¨linuxä¸Šè¦ä½¿ç”¨snmpåŠŸèƒ½è¦ä½¿ç”¨&quot;Linux: net-snmpç¨‹åºåŒ…&quot;</div><div class="line">zabbixï¼šæœ‰ä¸“ç”¨agentçš„ç›‘æ§å·¥å…·;</div><div class="line">        ç›‘æ§ä¸»æœº:</div><div class="line">            linuxã€windowsã€FreeBSD</div><div class="line">            ç½‘ç»œè®¾ç½®ã€è·¯ç”±äº¤æ¢è®¾å¤‡ï¼Œå¯ä»¥ç”¨SNMPè¿™ç§åè®®æ¥è¿›è¡Œç›‘æ§; </div><div class="line">é‡‡é›†ç½‘å¡æµé‡ï¼Œå¯ä»¥å°†å¤šä¸ªç½‘å¡æµé‡éƒ½åŠ èµ·æ¥è¿›è¡Œè®¡ç®—;  </div><div class="line">æŠ¥è­¦ï¼Œéœ€è¦æ·»åŠ æŠ¥è­¦ç­–ç•¥ï¼Œå¦å¤–éœ€è¦æŠ¥è­¦è·Ÿè¸ªï¼ŒæŠ¥è­¦è¿åŠ¨;   </div><div class="line">å¯¹ç›‘æ§ç³»ç»Ÿè¦åšç³»ç»Ÿè¯„ä¼°;</div><div class="line">zabbix æ˜¯ç”±phpå®ç°çš„ï¼Œæ‰€ä»¥å¯ä»¥å®ç°åŠŸèƒ½çš„äºŒæ¬¡å¼€å‘;</div></pre></td></tr></table></figure><h3 id="ç›‘æ§å¯¹è±¡"><a href="#ç›‘æ§å¯¹è±¡" class="headerlink" title="ç›‘æ§å¯¹è±¡"></a>ç›‘æ§å¯¹è±¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">è®¾å¤‡å’Œè½¯ä»¶</div><div class="line">    è®¾å¤‡:æœåŠ¡å™¨ã€è·¯ç”±å™¨ ã€äº¤æ¢æœºã€IOç³»ç»Ÿ</div><div class="line">    è½¯ä»¶: OSã€ç½‘ç»œã€åº”ç”¨ç¨‹åº</div><div class="line">å¶å‘æ€§æ•…éšœ</div><div class="line">    ä¸»æœºdownæœºã€æœåŠ¡ä¸å¯ç”¨ã€ä¸»æœºä¸å¯è¾¾</div><div class="line">ä¸¥é‡æ•…éšœ</div><div class="line">ä¸»æœºæ€§èƒ½æ‰¹æ ‡</div><div class="line">è¶‹åŠ¿:æ—¶é—´åºåˆ—æ•°æ®</div></pre></td></tr></table></figure><h3 id="æ•°æ®å­˜å‚¨"><a href="#æ•°æ®å­˜å‚¨" class="headerlink" title="æ•°æ®å­˜å‚¨"></a>æ•°æ®å­˜å‚¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cacti: rrd(round robin database) å¼ºå¤§çš„é›†æˆå·¥å…·</div><div class="line">zabbix: mysql,pgsql</div><div class="line">ä¼ä¸šçº§çš„ç›‘æ§è§£å†³æ–¹æ¡ˆ; </div><div class="line">    å¦‚æœå®šä¹‰äº†è§¦å‘å™¨ï¼Œè¶…å‡ºäº†é¢„å€¼ï¼Œåˆ™æ‰§è¡Œè„šæœ¬ï¼Œè€Œåå†æ‰§è¡ŒæŠ¥è­¦ï¼ŒæŠ¥è­¦å‡çº§æ“ä½œ;</div><div class="line">    zabbixå¯ä»¥åšåˆ†å¸ƒå¼; zabbixå¯ä»¥éƒ¨ç½²ä¸­å¿ƒèŠ‚ç‚¹ï¼Œä¸åˆ†å¸ƒå¼èŠ‚ç‚¹;</div><div class="line">        è¦å…³æ³¨ç³»ç»Ÿæœ‰å¤šå¤§çš„å‹åŠ›ï¼Œéœ€è¦ä»€ä¹ˆæ ·çš„ç»„ä»¶;</div><div class="line">        åŸºäºZabbix agent,SNMP Agent, IPMI Agent,SSH.pingï¼ŒDatabase Monitoring ,è‡ªå®šä¹‰ç›‘æ§è„šæœ¬;</div><div class="line">    ç›‘æ§ç›®æ ‡: CPU, Memeory, Network, Disk, Service, Log, File, Other</div><div class="line">    å¯¹Webåšç›‘æ§æ—¶ï¼Œå¯ä»¥çŸ¥é“å“åº”çš„æ—¶é—´ï¼Œé€Ÿåº¦ï¼ŒåŠè·å–çš„å†…å®¹;</div><div class="line">    è·å–é€šçŸ¥: é‚®ä»¶ï¼ŒçŸ­ä¿¡ï¼Œç”µè¯ç­‰ç­‰; </div><div class="line">Zabbix çš„å››ä¸ªä¸»è¦åŠŸèƒ½</div><div class="line">    Data gathering: æ•°æ®çš„æ”¶é›†</div><div class="line">    Data storage: æ•°æ®çš„å­˜å‚¨ </div><div class="line">    Alerting: æŠ¥è­¦</div><div class="line">    Visualisation:å¯è§†åŒ–</div></pre></td></tr></table></figure><h3 id="zabbix-æ¶æ„ä¸­çš„ç»„ä»¶"><a href="#zabbix-æ¶æ„ä¸­çš„ç»„ä»¶" class="headerlink" title="zabbix æ¶æ„ä¸­çš„ç»„ä»¶"></a>zabbix æ¶æ„ä¸­çš„ç»„ä»¶</h3><p>1ã€zabbixä¹‹é—´çš„é€šä¿¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">zabbix-server: ä½¿ç”¨Cè¯­è¨€ç ”å‘çš„</div><div class="line">OS zabbix-agent: ä½¿ç”¨Cè¯­è¨€ç ”å‘çš„</div><div class="line">zabbix-web: GUI,ç”¨äºå®ç°zabbixè®¾å®šå’Œå±•ç¤º</div><div class="line">zabbix-proxy:åˆ†å¸ƒå¼ç›‘æ§ç¯å¢ƒä¸­çš„ä¸“ç”¨ç»„ä»¶</div><div class="line">å› æ­¤å·¥ä½œæ€§èƒ½ä¹Ÿæ˜¯ç›¸å½“ä¸é”™çš„</div><div class="line">æ¶æ„é€šä¿¡åè®®:</div><div class="line">    agentæ¶æ„ä½¿ç”¨zabbix agentåè®®è¿›è¡Œé€šä¿¡</div><div class="line">    web pagess ä½¿ç”¨httpåè®® </div><div class="line">    ICMP/IPMI/SNMP: Device</div><div class="line">zabbix dabases:</div><div class="line">    MySQL,PGSQL(postgreSQL),DB2,Orcale,SQLite</div><div class="line">    zabbix-server(zabbix-get) ä¸ zabbix-agentd è¿›è¡Œé€šä¿¡</div><div class="line">    zabbix-getä¸zabbix-agentd(zabbix-sender) è¿›è¡Œé€šä¿¡</div><div class="line">    zabbix-server çš„æ—¥å¿—ä¿å­˜åœ¨ /var/log/zabbix/zabbix-server.logä¸­</div><div class="line">    zabbix-agentd çš„æ—¥å¿—ä¿å­˜åœ¨ /var/log/zabbix/zabbix-agentd.logä¸­</div><div class="line">    zabbix-gui  æ¥å£éœ€è¦ä¸€ä¸ªlampå¹³å°æ¥è¿è¡Œ</div></pre></td></tr></table></figure><p>2ã€ zabbixçš„éƒ¨ç½²åˆ†ç±»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">aã€å¯ä»¥å°†zabbix-serverï¼Œzabbix-gui web (lamp),databaseåˆ†åˆ«æ”¾åœ¨ä¸€å°æœåŠ¡å™¨ä¸Š;</div><div class="line">        ç„¶è€Œ,zabbix-serverä¸databaseé€šä¿¡ï¼Œ zabbix-guiä¹Ÿåªéœ€è¦ä¸databaseé€šä¿¡å°±å¯ä»¥äº†;</div><div class="line">bã€å¯ä»¥å°†zabbix-server, zabbix-gui web(lamp),database ç»Ÿä¸€æ”¾åœ¨ä¸€å°æœåŠ¡å™¨ä¸Š;</div><div class="line">dã€å¯ä»¥å°†ä»¥ä¸Šç»„ä»¶ï¼Œä¸¤ä¸¤éƒ¨ç½²åœ¨ä¸€å°æœåŠ¡å™¨ä¸Š;</div></pre></td></tr></table></figure><h3 id="zabbixå¸¸ç”¨æœ¯è¯­"><a href="#zabbixå¸¸ç”¨æœ¯è¯­" class="headerlink" title="zabbixå¸¸ç”¨æœ¯è¯­"></a>zabbixå¸¸ç”¨æœ¯è¯­</h3><ol><li>ä¸»æœºHost: è¦ç›‘æ§çš„ç½‘ç»œè®¾å¤‡;</li><li>ä¸»æœºç»„Host Group: åˆ†ç±»ç›‘æ§çš„æœåŠ¡å™¨ï¼Œä¸€ç»„æ¨¡æ¿(ç›‘æ§é¡¹ï¼Œè§¦å‘å™¨ï¼Œç­‰ç­‰);</li><li>ç›‘æ§é¡¹item: zabbixè¿›è¡Œæ•°æ®æ”¶é›†çš„æ ¸å¿ƒï¼Œä¸€ä¸ªæŒ‡å®šçš„ç›‘æ§æŒ‡æ ‡;</li><li>è§¦å‘å™¨trigger: æ˜¯æŒ‡ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¯„ä¼°itemæ”¶é›†çš„æ•°æ®æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…; </li><li>äº‹ä»¶event: å³å‘ç”Ÿä¸€ä»¶å€¼å¾—å…³æ³¨çš„äº‹æƒ…ï¼Œä¾‹å¦‚triggerçŠ¶æ€ç”±problemè½¬ä¸ºokçŠ¶æ€;  </li><li>åŠ¨ä½œaction: å³é¢„å…ˆå®šä¹‰çš„å¤„ç†æ–¹æ³•ï¼Œé€šè¿‡å®šä¹‰çš„åŠ¨ä½œï¼Œå‘é€é‚®ä»¶ï¼ŒçŸ¥ä¿¡ç­‰ç­‰;</li><li>æŠ¥è­¦å‡çº§escalation:å‘é€æŠ¥è­¦ï¼Œæˆ–è€…æ‰§è¡Œè¿œç¨‹å‘½ä»¤ï¼Œæ¯äº”åˆ†é’Ÿå‘ä¸€æ¬¡ï¼Œå…±å‘5æ¬¡ç­‰; </li><li>åª’ä»‹media: å‘é€é€šçŸ¥çš„æ‰‹æ®µæˆ–é€šé“ï¼Œå¦‚Emailã€Jobberã€SMS æˆ–è€…å¾®ä¿¡ç­‰ç­‰;  </li><li>é€šçŸ¥notification:é€šè¿‡é€‰å®šçš„åª’ä»‹å‘ç”¨æˆ·å‘é€æœ‰å…³çš„æŸä»¶äº‹æƒ…; </li><li>è¿œç¨‹å‘½ä»¤(remote command): é¢„å®šä¹‰çš„å‘½ä»¤ï¼Œå¯ä»¥åœ¨è¢«ç›‘æ§çš„ä¸»æœºå¤„äºæŸç‰¹å®šæ¡ä»¶ä¸‹æ—¶è‡ªåŠ¨æ‰§è¡Œ;  </li><li>æ¨¡æ¿(template): ç”¨äºå¿«åº¦å®šä¹‰è¢«ç›‘æ§ä¸»æœºçš„çš„é¢„è®¾æ¡ç›®é›†åˆï¼Œé€šå¸¸åŒ…å«äº†itemã€trigeerã€graphã€screen; </li><li>å¦å¤–ï¼Œæ¨¡æ¿å¯ä»¥ç›´æ¥é“¾æ¥è‡³å•ä¸ªä¸»æœº;  </li><li>åº”ç”¨(application):ä¸€ç»„itemçš„é›†åˆ;</li><li>webåœºæ™¯(web scennario):ç”¨äºæ£€æµ‹webç«™ç‚¹å¯ç”¨æ€§çš„ä¸€ä¸ªæˆ–å¤šä¸ªHTTPè¯·æ±‚;  </li><li>å‰ç«¯(frontend): zabbixçš„webæ¥å£; </li></ol><p>å¯æ ¹æ®ç³»ç»Ÿç±»å‹ ï¼Œä¸šåŠ¡éœ€æ±‚ï¼Œè®¾å¤‡ç±»å‹ç­‰ç­‰å°†æœåŠ¡å™¨åˆ†ç»„;  </p><h3 id="zabbix-server-å®ç°"><a href="#zabbix-server-å®ç°" class="headerlink" title="zabbix server å®ç°"></a>zabbix server å®ç°</h3><ul><li>watchdog è´Ÿè´£è¿è¡Œçš„è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œä¸­;</li><li>housekeeper ç®¡å®¶ï¼ŒæŒ‡æ˜ä½ çš„æ•°æ®å°†è¦è¢«ä¿å­˜å¤šä¹…;</li><li>alerter æ‰§è¡Œè­¦æŠ¥æ“ä½œçš„;</li><li>poller ç›‘æ§è¿›ç¨‹ï¼›</li><li>httppoler  ç›‘æ§webé¡µé¢çš„ä¸“ç”¨poller;</li><li>discover  é«˜çº§çš„å‘ç°æœºåˆ¶ï¼Œå¯ä»¥è‡ªåŠ¨åŠ è½½è¿›æ¥ï¼Œä½†å®ƒçš„å·¥ä½œç›¸å½“å ç”¨èµ„æº; </li><li>escalator æŠ¥è­¦å‡çº§; </li><li>timer  è®¡æ—¶å™¨;</li><li>nodewatcher ç›‘æ§å„èŠ‚ç‚¹çš„; </li><li>db_data_syncer  æ•°æ®åº“çš„æ•°æ®åŒæ­¥å™¨;</li><li>db_config_syncer æ•°æ®åº“çš„æ•°æ®åŒæ­¥å™¨;</li><li>pinger èƒ½è¿‡pingæ“ä½œæŸ¥çœ‹å„ä¸»æœºæ˜¯å¦åœ¨çº¿çš„å·¥å…·;</li></ul><h3 id="zabbix-ç›‘æ§å®ç°çš„ç¡¬ä»¶éœ€æ±‚"><a href="#zabbix-ç›‘æ§å®ç°çš„ç¡¬ä»¶éœ€æ±‚" class="headerlink" title="zabbix ç›‘æ§å®ç°çš„ç¡¬ä»¶éœ€æ±‚"></a>zabbix ç›‘æ§å®ç°çš„ç¡¬ä»¶éœ€æ±‚</h3><table><thead><tr><th>Name</th><th>Platform</th><th>CPU/Memory</th><th>Database</th><th>Monitored Hosts</th></tr></thead><tbody><tr><td>Small</td><td>Ubuntu Linux</td><td>PII 350MHZ 256MB</td><td>SQLite</td><td>20</td></tr><tr><td>Medium</td><td>Ubuntu linux 64 bit</td><td>AMD Athlon  320 + 2GB</td><td>MySQL InnoDB</td><td>500</td></tr><tr><td>Large</td><td>Ubuntu Linux 64 bit</td><td>Inter Dual Core 6400 + 6GB</td><td>RAID 10 MySQL InnoDB or PostgreSQL</td><td>&gt;1000</td></tr><tr><td>Verfy Large</td><td>RedHat Enterprise</td><td>Inter Xeon 2xCPU 8G</td><td>FAST RAID 10 MySQl InnoDB or PostgreSQL</td><td>&gt;10000</td></tr></tbody></table><h3 id="zabbixäº§ç”Ÿçš„æ•°æ®ç»„æˆå…±æœ‰å››éƒ¨åˆ†"><a href="#zabbixäº§ç”Ÿçš„æ•°æ®ç»„æˆå…±æœ‰å››éƒ¨åˆ†" class="headerlink" title="zabbixäº§ç”Ÿçš„æ•°æ®ç»„æˆå…±æœ‰å››éƒ¨åˆ†"></a>zabbixäº§ç”Ÿçš„æ•°æ®ç»„æˆå…±æœ‰å››éƒ¨åˆ†</h3><ol><li>é…ç½®æ•°æ®;</li><li>å†å²æ•°æ® 50Bytes;</li><li>å†å²è¶‹åŠ¿æ•°æ® 128Bytes;</li><li>äº‹ä»¶æ•°æ®130Bytes; </li></ol><p>Zabbix ç›®å‰éƒ¨ç½²åœ¨LinuxæœåŠ¡å™¨æœ€ä¸ºå¸¸è§</p><p><a href="https://www.zabbix.com/download" target="_blank" rel="external">zabbix å®˜æ–¹æºç  </a> </p><h2 id="zabbixçš„å®‰è£…ä¸ä½¿ç”¨"><a href="#zabbixçš„å®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="zabbixçš„å®‰è£…ä¸ä½¿ç”¨"></a>zabbixçš„å®‰è£…ä¸ä½¿ç”¨</h2><h3 id="zabbix-server-çš„å®‰è£…ä¸ä½¿ç”¨"><a href="#zabbix-server-çš„å®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="zabbix-server çš„å®‰è£…ä¸ä½¿ç”¨"></a>zabbix-server çš„å®‰è£…ä¸ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"># yum -y install mariadb-server mariadb </div><div class="line"># systemctl enable mariadb</div><div class="line"># systemctl start mariadb</div><div class="line"># mysql </div><div class="line">MariaDB [(none)]&gt; CREATE DATABASE zabbix CHARACTER SET utf8;</div><div class="line">MariaDB [(none)]&gt; GRANT ALL on zabbix.* TO &apos;zbxuser&apos;@&apos;127.0.0.1&apos; IDENTIFIED BY &apos;xxxxxxx%3&apos;; </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">MariaDB [(none)]&gt; GRANT ALL on zabbix.* TO &apos;zbxuser&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;xxxxxxx%3&apos;;              </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">MariaDB [mysql]&gt; FLUSH PRIVILEGES ;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</div><div class="line">Your MariaDB connection id is 3</div><div class="line">Server version: 5.5.56-MariaDB MariaDB Server</div><div class="line"></div><div class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; show databases;</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| test               |</div><div class="line">| zabbix             |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt;</div></pre></td></tr></table></figure><p>è¿™é‡Œé€‰ç”¨ zabbix 2.2 çš„åŒ…æ¥å®‰è£…;ä¹‹åä¼šé™„zabbix 2.2 å‡çº§3.4 çš„æ–‡æ¡£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># rpm -i http://repo.zabbix.com/zabbix/2.2/rhel/7/x86_64/zabbix-release-2.2-1.el7.noarch.rpm</div><div class="line"># yum clean all</div><div class="line"># yum -y install zabbix zabbix-server zabbix-server-mysql zabbix-get  zabbix-web zabbix-web-mysql zabbix-agent zabbix-sender </div><div class="line"># systemctl start httpd</div><div class="line"># systemctl enable httpd </div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.</div><div class="line"># cd /usr/share/doc/zabbix-server-mysql-2.2.21/create/</div><div class="line"># mysql zabbix &lt; schema.sql </div><div class="line"># mysql zabbix &lt; images.sql </div><div class="line"># mysql zabbix &lt; data.sql</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># vim /etc/zabbix/zabbix_server.conf</div><div class="line"># å‚æ•°è¯´æ˜</div><div class="line">ListenPort = 10051  æŒ‡å®šç«¯å£ </div><div class="line">LogFile = æŒ‡å®šæ—¥å¿—æ–‡ä»¶</div><div class="line">LogFileSize =0 è¡¨ç¤ºä¸åšæ»šåŠ¨</div><div class="line">DebugLevel = 3 </div><div class="line">PidFile = /var/run/zabbix/zabbix_server.pid </div><div class="line">DBHost = localhost </div><div class="line">DBName = zabbix </div><div class="line">DBUser = zbxuser</div><div class="line">DBPassword = xxxxxxx%3</div><div class="line">DBSocket = /tmp/mysql.sock</div><div class="line">StartPollers = 5  éšæ—¶ç­‰å¾…çš„è¿›ç¨‹æœ‰å¤šå°‘ä¸ª</div><div class="line">SNMPTrapperFile = /var/log/snmppt/snmptt.log</div><div class="line">MaxHousekeeperDelete=500 æœ€å¤šåˆ é™¤å¤šå°‘ä¸ª</div><div class="line">CacheUpdateFrequency= 60  cache æœ€å¤§çš„æ›´æ–°é¢‘ç‡</div><div class="line">StartDBsyncers=4 DBåŒæ­¥è¿›ç¨‹å¤šå°‘ä¸ª</div><div class="line">StartDiscoverers =1  æ˜¯å¯åŠ¨è‡ªåŠ¨æ·»åŠ æ¨¡æ¿åŠŸèƒ½çš„</div><div class="line">StartHTTPPollers =1 ä½œä¸ºhttpæµè§ˆå™¨æ¥è¯·æ±‚è¢«ç›‘æ§é¡µé¢çš„</div><div class="line">StartTimers =1  å¯åŠ¨è®¡æ—¶å™¨ </div><div class="line">JavaGateway = 1    ç›‘æ§javaç½‘å…³çš„</div><div class="line">ä¸€èˆ¬é»˜è®¤çš„ç¼“å­˜å€¼ä¸ç”¨è°ƒ </div><div class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts/ æŠ¥è­¦è„šæœ¬çš„å­˜æ”¾ä½ç½®</div><div class="line">ExternalScripts=/usr/lib/zabbix/externalscripts/ å¤–éƒ¨è„šæœ¬çš„å­˜æ”¾ä½ç½®</div><div class="line">FpingLocation=/usr/sbin/fping å¹¶è¡Œå‘é€å¤šä¸ªè¯·æ±‚ï¼Œå¯ä»¥å½“ä½œæ”»å‡»å‘½ä»¤</div><div class="line">SSLCerLocation = å¦‚æœå¯ç”¨SSLçš„è¯åˆ™é…é…ç½®è¯¥é¡¹</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># systemctl start zabbix-server</div><div class="line"># vim /etc/php.ini</div><div class="line">date.timezone = Asia/Chongqing</div><div class="line">max_input_time = 600</div><div class="line">max_execution_time = 600</div><div class="line">post_max_size = 28M</div><div class="line"># systemctl restart httpd</div></pre></td></tr></table></figure><p><img src="/images/zabbix2.2.png" alt=""></p><p><img src="/images/zabbix_logging.png" alt=""></p><h3 id="å¦‚æœä½¿ç”¨ç¼–è¯‘å®‰è£…"><a href="#å¦‚æœä½¿ç”¨ç¼–è¯‘å®‰è£…" class="headerlink" title="å¦‚æœä½¿ç”¨ç¼–è¯‘å®‰è£…"></a>å¦‚æœä½¿ç”¨ç¼–è¯‘å®‰è£…</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># åŒæ—¶å®‰è£… server å’Œagent ï¼Œå¹¶æ”¯æŒå°†æ•°æ®æ”¾å…¥myqlæ•°æ®ä¸­ï¼Œå¯ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹é…ç½®å‘½ä»¤;</div><div class="line"># ./configure --enable-server --enable-agent --with-mysql --enable-ipv6 --with-net-snmp --with-libcurl --with-ssh2 </div><div class="line"></div><div class="line"># å¦‚æœä»…å®‰è£… server,å¹¶æ”¯æŒå°†æ•°æ®æ”¾å…¥mysqlæ•°æ®ä¸­ï¼Œå¯ä½¿ç”¨ä¼¼å¦‚ä¸‹é…ç½®å‘½ä»¤; </div><div class="line"># ./configure --enable-server --with-mysql --with-net-snmp --with-libcurl</div><div class="line"></div><div class="line"># å¦‚æœä»…å®‰è£… proxyï¼Œå¹¶æ”¯æŒå°†æ•°æ®æ”¾å…¥mysqlæ•°æ®ä¸­ï¼Œå¯ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹é…ç½®å‘½ä»¤; </div><div class="line"># ./configure --profix=/usr --enable-proxy --with-net-snmp --with-mysql --with-ssh2</div><div class="line"></div><div class="line"># å¦‚æœä»…å®‰è£… agentï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹é…ç½®å‘½ä»¤;</div><div class="line"># ./configure --enable-agent </div><div class="line"></div><div class="line"># è€Œåç¼–è¯‘å®‰è£…zabbix å³å¯;</div><div class="line"># make </div><div class="line"># make install</div></pre></td></tr></table></figure><h3 id="zabbix-agent-çš„å®‰è£…å’Œä½¿ç”¨"><a href="#zabbix-agent-çš„å®‰è£…å’Œä½¿ç”¨" class="headerlink" title="zabbix agent çš„å®‰è£…å’Œä½¿ç”¨"></a>zabbix agent çš„å®‰è£…å’Œä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># vim /etc/zabbix/zabbix_agentd.conf </div><div class="line">ServerActive=127.0.0.1,172.16.55.123</div><div class="line">Hostname=zabbix-test-server</div><div class="line"># systemctl start zabbix-agent</div><div class="line">Congiguration --&gt; Hosts --&gt; (å°†zabbix-serverç«¯çš„agentæœåŠ¡å¯ç”¨)</div></pre></td></tr></table></figure><p><img src="/images/zabbix2.2_server_agent.png" alt=""></p><h3 id="zabbix-æ·»åŠ é¢å¤–çš„agentç«¯"><a href="#zabbix-æ·»åŠ é¢å¤–çš„agentç«¯" class="headerlink" title="zabbix æ·»åŠ é¢å¤–çš„agentç«¯"></a>zabbix æ·»åŠ é¢å¤–çš„agentç«¯</h3><p>åœ¨ä¸€å°éœ€è¦è¢«ç›‘æ§çš„æœåŠ¡å™¨ä¸Šå®‰è£… zabbix-agent </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># rpm -i http://repo.zabbix.com/zabbix/2.2/rhel/7/x86_64/zabbix-release-2.2-1.el7.noarch.rpm</div><div class="line">#  yum clean all </div><div class="line">#  yum -y install zabbix zabbix-agent zabbix-sender</div><div class="line"># vim /etc/zabbix/zabbix_agentd.conf </div><div class="line">Server=172.16.55.123</div><div class="line">ServerActive=172.16.55.123</div><div class="line">Hostname= zabbix-agent-node1</div><div class="line"># systemctl start zabbix-agent</div><div class="line"># netstat  -tnlup | grep zabbix</div><div class="line">tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      30383/zabbix_agentd </div><div class="line">tcp6       0      0 :::10050                :::*                    LISTEN      30383/zabbix_agentd </div><div class="line">æ³¨: æœ€å¥½åœ¨zabbix-server åšä¸€ä¸‹æ¢æµ‹ï¼Œç¡®ä¿åœ¨zabbix-server ç«¯å¯ä»¥æ¢æµ‹é€šagentçš„ç«¯å£</div><div class="line"># telnet 172.16.55.124 10050</div><div class="line">Trying 172.16.55.124...</div><div class="line">Connected to 172.16.55.124.</div><div class="line">Escape character is &apos;^]&apos;.</div></pre></td></tr></table></figure><p><img src="/images/zabbix-agent-host-node1.png" alt=""><br>ç™»å½•zabbix-server çš„webæ¥å£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Configuration --&gt; Hosts --&gt; Create Hosts --&gt;</div><div class="line">[</div><div class="line">Host name: zabbix-agent-node1</div><div class="line">Visible name: zabbix-agent-node1</div><div class="line">Group In goups : Linux servers</div><div class="line">Agent interfaces: è¿™é‡Œé€‰ç”¨çš„æ˜¯ip-&gt; 172.16.55.124</div><div class="line">Templates -&gt; Template OS Linux --&gt; Add -&gt; Save --&gt; </div><div class="line">IPMI -&gt; å…ˆç•™ç©º</div><div class="line">Macros -&gt; å…ˆç•™ç©º</div><div class="line">Host inventory -&gt; å…ˆç•™ç©º</div><div class="line">]</div><div class="line">Host &lt;-- Save</div></pre></td></tr></table></figure><h2 id="zabbix-on-CentOS7"><a href="#zabbix-on-CentOS7" class="headerlink" title="zabbix on CentOS7"></a>zabbix on CentOS7</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Linuxå¼€æºç›‘æ§ç³»ç»Ÿ:</div><div class="line">    nagios</div><div class="line">    cacti</div><div class="line">    zabbix: å†…nagiosï¼Œcacti </div><div class="line">    ganglia: å†…ç½®å¼ºå¤§çš„èšåˆåŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½zabbixæ˜¯ä¸å…·å¤‡çš„</div><div class="line">    åœ¨å¤§å…¬å¸èƒ½äº†è§£åˆ°æ›´å¥½è§„èŒƒ; </div><div class="line">    åœ¨å°å…¬å¸èƒ½å¤Ÿå¾—åˆ°æ›´å¤šçš„ç»éªŒ;</div><div class="line"># vim /etc/my.cnf</div><div class="line">innodb_file_per_table = 1 </div><div class="line">skip_name_reslove =  1</div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">CentOS 7.1 å®‰è£…</div><div class="line"></div><div class="line">~]# yum install zabbix-2.4.6-1.el7.x86_64.rpm zabbix-server-2.4.6-1.el7.x86_64.rpm zabbix-server-mysql-2.4.6-1.el7.x86_64.rpm zabbix-agent-2.4.6-1.el7.x86_64.rpm zabbix-sender-2.4.6-1.el7.x86_64.rpm zabbix-web-2.4.6-1.el7.noarch.rpm zabbix-get-2.4.6-1.el7.x86_64.rpm  zabbix-web-mysql-2.4.6-1.el7.noarch.rpm trousers-0.3.11.2-4.el7_1.x86_64.rpm</div><div class="line"></div><div class="line">è¯´æ˜ï¼šCentOS 7.1å®‰è£…zabbix-2.4.6-1.el7ï¼Œå…¶ä¸trousers-0.3.11.2-3ä¸å…¼å®¹ï¼Œéœ€è¦å‡çº§trousersè‡³0.3.11.2-4.el7_1ã€‚å¦‚æœæ²¡æœ‰zabbix rpmåŒ…ï¼Œå¯ä»¥åœ¨å®˜ç½‘æŸ¥æ‰¾å®‰è£…yumæºrpmåŒ… ï¼Œç±»ä¼¼ä»¥ä¸Šçš„å®‰è£…æ–¹æ³•</div><div class="line"></div><div class="line"></div><div class="line">åˆ›å»ºæ•°æ®åº“ï¼š</div><div class="line"></div><div class="line">serverå’Œproxyçš„è¿è¡Œéƒ½ä¾èµ–äºæ•°æ®åº“ï¼Œagentåˆ™ä¸éœ€è¦ã€‚</div><div class="line"></div><div class="line">ä»¥MySQLæ•°æ®åº“ä¸ºä¾‹ï¼š</div><div class="line">shell&gt; mysql -uroot -p&lt;password&gt;</div><div class="line">mysql&gt; create database zabbix character set utf8 collate utf8_bin;</div><div class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by '&lt;password&gt;';</div><div class="line">mysql&gt; quit;</div><div class="line">shell&gt; mysql -uzabbix -p&lt;password&gt; zabbix &lt; database/mysql/schema.sql</div><div class="line"># stop here if you are creating database for Zabbix proxy</div><div class="line">shell&gt; mysql -uzabbix -p&lt;password&gt; zabbix &lt; database/mysql/images.sql</div><div class="line">shell&gt; mysql -uzabbix -p&lt;password&gt; zabbix &lt; database/mysql/data.sql</div><div class="line"></div><div class="line"></div><div class="line">é…ç½®zabbixï¼š</div><div class="line"></div><div class="line">(1) zabbix_server</div><div class="line">serverçš„é…ç½®æ–‡ä»¶ä¸ºzabbix_server.confï¼Œè‡³å°‘åº”è¯¥ä¸ºå…¶é…ç½®æ•°æ®åº“ç­‰ç›¸å…³çš„ä¿¡æ¯ï¼›ä¾‹å¦‚ï¼š</div><div class="line">LogFile=/var/log/zabbix/zabbix_server.log</div><div class="line">LogFileSize=0</div><div class="line">PidFile=/var/run/zabbix/zabbix_server.pid</div><div class="line">DBHost=172.16.100.67</div><div class="line">DBName=zabbix</div><div class="line">DBUser=zbxuser</div><div class="line">DBPassword=zbxpass</div><div class="line">DBSocket=/var/lib/mysql/mysql.sock</div><div class="line">SNMPTrapperFile=/var/log/snmptt/snmptt.log</div><div class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</div><div class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">(2) é…ç½®phpç¯å¢ƒ</div><div class="line">ç¼–è¾‘/etc/httpd/conf.d/zabbix.confï¼Œæ·»åŠ å¦‚ä¸‹é¡¹ã€‚</div><div class="line">    php_value date.timezone Asia/Shanghai</div><div class="line"></div><div class="line">   å¯åŠ¨httpdæœåŠ¡ï¼šsystemctl <span class="keyword">start</span> httpd.service</div><div class="line"></div><div class="line">   è®¿é—®zabbix web</div><div class="line">   <span class="keyword">http</span>://your_host/zabbix</div><div class="line"></div><div class="line">   ç™»å½•ï¼š<span class="keyword">Admin</span>/zabbix</div><div class="line"></div><div class="line">(<span class="number">3</span>) é…ç½®zabbix_agent</div><div class="line"><span class="keyword">agent</span>çš„é…ç½®æ–‡ä»¶ä¸ºzaabix_agentd.confï¼Œè‡³å°‘åº”è¯¥ä¸ºå…¶æŒ‡å®š<span class="keyword">server</span>çš„IPåœ°å€ï¼›</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">zabbixç»„ä»¶</div><div class="line">    zabbix</div><div class="line">    zabbix-server</div><div class="line">    zabbix-database</div><div class="line">    zabbix-web</div><div class="line">    zabbix-agent</div><div class="line">    zabbix-proxy</div><div class="line">zabbix é€»è¾‘ç»„ä»¶</div><div class="line">    ä¸»æœºç»„ã€ä¸»æœº</div><div class="line">    item(ç›‘æ§é¡¹)ã€appliction(åº”ç”¨)</div><div class="line">    trigger(è§¦å‘å™¨)</div><div class="line">        even(äº‹ä»¶)</div><div class="line">    action</div><div class="line">        notice</div><div class="line">        command</div><div class="line">    media</div><div class="line">    users(media)</div><div class="line">    ç›‘æ§ç³»ç»Ÿ: æ•°æ®é‡‡é›†ã€æ•°æ®å­˜å‚¨ã€æŠ¥è­¦ã€æ•°æ®å¯è§†åŒ–</div><div class="line">    </div><div class="line">    zabbix:</div><div class="line">        database --&gt; zabbix-server (zabbix_server.conf)--&gt; zabbix-web(LAMPå¹³å°) </div><div class="line">        --&gt; http://zabbix-web-server/zabbix/zabbix-agent (zabix-agent.conf)</div></pre></td></tr></table></figure><h3 id="zabbix-æŠ¥è­¦å…¥é—¨é…ç½®"><a href="#zabbix-æŠ¥è­¦å…¥é—¨é…ç½®" class="headerlink" title="zabbix æŠ¥è­¦å…¥é—¨é…ç½®"></a>zabbix æŠ¥è­¦å…¥é—¨é…ç½®</h3><p><code>æ³¨: åœ¨æ·»åŠ ä¸»æœºçš„æ—¶å€™å¦‚æœè¦æƒ³è®©æ”¯æŒsnmpåè®®ï¼Œåˆ™å®‰è£…yum -y install net-snmp</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># vim /etc/snmp/snmp.conf</div><div class="line"># service snmpd start</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># æŸ¥çœ‹æ”¯æŒçš„key MariaDB [zabbix]&gt; SELECT key_,type FROM items ;</div><div class="line"># æŸ¥çœ‹æ”¯æŒçš„items MariaDB [zabbix]&gt; SELECT * FROM items\G;</div><div class="line"># zabbix_get -h å‘æŒ‡å®šçš„ä¸»æœºè·å–æŒ‡å®šçš„å€¼çš„</div><div class="line"># zabbix_get -s 172.16.55.124 -k &quot;net.if.out[ens3]&quot;</div><div class="line">1161497309</div><div class="line"># zabbix_get -s 172.16.55.124 -k &quot;net.if.in[ens3]&quot; </div><div class="line">1390144843</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># æ‰‹åŠ¨åˆ›å»ºitem</div><div class="line"># å…ˆåœ¨zabbixæœåŠ¡å™¨ç«¯å°è¯•è·å–CPUä¸­æ–­æ•° </div><div class="line"># zabbix_get -s 172.16.55.124 -k &quot;system.cpu.intr&quot;</div><div class="line">597504908</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Configuration --&gt; Hosts --&gt; é€‰å®šä¸»æœºçš„Items </div><div class="line">Name: cpu interrupts </div><div class="line">Type: zabbix  </div><div class="line">Key:system.cpu.intr</div><div class="line">Host interface:172.16.100.8:10050</div><div class="line">Type of information: Numeric(unsigned) : æ•°æ®ç±»å‹å†³å®šä»¥ä¸‹é…ç½®æ˜¯å¦å¯ç”¨</div><div class="line">Data type : Decimal </div><div class="line">Units:</div><div class="line">Use custom multipier: åšå•ä½æ¢ç®—</div><div class="line">New flexible interval Interval(in sec)ï¼šæŒ‡å®šç›‘æ§æ—¶é—´</div><div class="line">History storage period (in days): å†å²æ•°æ®çš„å­˜æ”¾å¤©æ•°ï¼Œåªè¦æ»¡è¶³éœ€è¦äº†ï¼Œå°½å¯èƒ½ä¸å¯æ—¶é•¿è¿‡å¤š 90</div><div class="line">Treand storage period (in days): å†å²é‡‡æ ·çš„æ•°æ® 365</div><div class="line">å†å²æ•°æ®:é‡‡æ ·ç”Ÿæˆçš„æ•°æ®;</div><div class="line">å†å²è¶‹åŠ¿æ•°æ® :æ¯å°æ—¶çš„æœ€å¤§å€¼ ã€æœ€å°å€¼ ã€å¹³å‡å€¼ã€ç»Ÿè®¡å€¼</div><div class="line">Sotre valus: æ•°æ®å­˜å‚¨çš„ç»“æœ As isï¼Œä¸åšä»»ä½•å¤„ç†; </div><div class="line">Delta(sppd per second): (value -per_value)/(time - pre_time)</div><div class="line">    10: 1200 , 20: 13000</div><div class="line">æ·»åŠ å®Œä»¥ä¸Šä¿¡æ¯ä¹‹åï¼Œæ·»addå³å¯; å¯ä»¥åœ¨hostsä¸­æŸ¥çœ‹åˆ°çŠ¶æ€æ˜¯enabled</div><div class="line">åŒæ ·çš„æ–¹å¼å¯ä»¥åˆ›å»º å…¶å®ƒItem</div></pre></td></tr></table></figure><p>æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå›¾å½¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Configuration --&gt; Hosts --&gt; --&gt; é€‰å®šä¸»æœºçš„Graph </div><div class="line">Name: cpu interrupts </div><div class="line">Width: 900</div><div class="line">Heig: 200</div><div class="line">Graph type: Normal </div><div class="line">Show legend </div><div class="line">Show working time </div><div class="line">Show triggers</div><div class="line">add Items</div><div class="line">Preview ï¼Œé…ç½®å®Œä¹‹åï¼Œå¯ä»¥é¢„è§ˆåæ·»åŠ ;</div></pre></td></tr></table></figure><p>è§¦å‘å™¨çŠ¶æ€ä¸¥é‡æ€§ï¼Œçº§åˆ«</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Not classfiled Grey  æ— åˆ†ç±»</div><div class="line">Information Light green èµ„è®¯</div><div class="line">Warning Yellow è­¦å‘Š</div><div class="line">Average Orange è§‰è§é—®é¢˜</div><div class="line">High red     é«˜å±</div><div class="line">Disaster bright red æ¯ç­</div></pre></td></tr></table></figure><p>åˆ›å»ºè§¦å‘å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Configuration --&gt; Hosts --&gt; é€‰å®šä¸»æœºçš„Trigger</div><div class="line">Name too many interrupts</div><div class="line">Expression  add </div><div class="line">    --&gt; node1:cpu intterrupts </div><div class="line">    --&gt; last(most recent)T value is &gt; N</div><div class="line">    --&gt; Last of (T) </div><div class="line">    --&gt; Time shift</div><div class="line">        --&gt; N 50</div><div class="line">    --&gt; add</div><div class="line">Description</div><div class="line">    åç§°ä¸­å¯ä»¥ä½¿ç”¨å®:</div><div class="line">        &#123;HOST.HOST&#125;,&#123;HOST.NAME&#125;,&#123;HOST.IP&#125;,&#123;HOST.COMN&#125;,&#123;HOST.DNS&#125;</div><div class="line">    </div><div class="line">    URL: å¯ä»¥ç•™ç©ºï¼Œä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ªurlï¼ŒæŠ¥è­¦åˆ™è¯´æ˜ç”±å“ªä¸ªurlè§¦å‘çš„</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># yum -y install hping3 å¤šä¸ªhping3å¯ä»¥å®ç°DDOSæ”»å‡»</div><div class="line"># hping3 172.16.55.124 --faster </div><div class="line">å¯ä»¥åœ¨124ä¸Šçœ‹åˆ°,cpuä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿåº¦éå¸¸çš„å¿«,cpuä¸­æ–­é£™å‡</div><div class="line"># vmstat 1</div></pre></td></tr></table></figure><p>å®šä¹‰æŠ¥åª’ä»‹ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Administration --&gt; Media types </div><div class="line">    --&gt; Name Email</div><div class="line">    --&gt; Type Email </div><div class="line">    --&gt; SMTP Server å¯ä»¥æŒ‡å®šåˆ°é‚®ä»¶æœåŠ¡å™¨</div><div class="line">    --&gt; SMTP helo localhost æŒ‡å®šæ”¶ä»¶äºº</div><div class="line">    --&gt; SMTP email zabbix@xxxxx.com æŒ‡å®šå‘ä»¶äºº  </div><div class="line"></div><div class="line"># å®šä¹‰æŠ¥è­¦ç”¨æˆ· </div><div class="line">è¿™é‡Œå»ºè®®ä¸åˆ›å»ºæŠ¥è­¦ç”¨æˆ·ï¼Œç›´æ¥ä½¿ç”¨adminå‘</div><div class="line">Media å¯ä»¥å®ç°æŠ¥è­¦å‡çº§åŠŸèƒ½;åœ¨adminç”¨æˆ·ä¸­é…ç½®æŠ¥è­¦åª’ä»‹</div></pre></td></tr></table></figure><p>é…ç½®Actions</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Configure --&gt; Actions--&gt; Create Actions </div><div class="line">    Action--&gt; names</div><div class="line">    ä¿¡æ¯é‡‡ç”¨å®ï¼Œå¯ç”¨æŠ¥æ•…éšœæ¢å¤åå‘é€ä¿¡æ¯;</div><div class="line">    </div><div class="line">Conditions æ¡å®šæ‰§è¡Œæ¡ä»¶</div><div class="line">Operations å®šä¹‰æŠ¥è­¦å‡çº§ (æ¯ä¸€æ¬¡å¯æœ‰å¤šä¸ªè·¨åº¦åŒºé—´)</div></pre></td></tr></table></figure><h3 id="zabbix-å¸¸ç”¨é…ç½®"><a href="#zabbix-å¸¸ç”¨é…ç½®" class="headerlink" title="zabbix å¸¸ç”¨é…ç½®"></a>zabbix å¸¸ç”¨é…ç½®</h3><p>ç”±zabbixç›‘æ§æŸå…³æ³¨çš„æŒ‡æ ‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">host group --&gt; host --&gt; item(å­˜å‚¨äºMySQL) --&gt; graph (zabbix-web)</div><div class="line">--&gt; trigger(è§¦å‘å™¨) --&gt; action(conditon+operation)</div><div class="line">application: æŠŠåŠŸèƒ½ç›¸è¿‘çš„ä¸€ç»„itemå½’ç±»åœ¨ä¸€èµ·ç»Ÿä¸€è¿›è¡Œç®¡ç†ç»„ä»¶:</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ServerActive= 172.16.55.124 ; è¿™é‡Œåœ¨agentä¸­å¦‚æœæŒ‡å®šäº†ï¼Œåˆ™è¯´æ˜æ˜¯ä¸»åŠ¨çš„ç›‘æ§æ–¹å¼;</div><div class="line">Actions å¯ä»¥æ¥æ”¶äº‹ä»¶ï¼Œå¯ä»¥å‘é€åŠ¨ä½œè€Œç”¨æ¥æŠ¥è­¦;</div><div class="line">(Events,Actions,Trigger) æ˜¯zabbixçš„æ ¸å¿ƒç»„ä»¶</div></pre></td></tr></table></figure><p>Zabbix å®Œæ•´çš„ç›‘æ§é…ç½®æµç¨‹å¤§ä½“ç”±å¦‚ä¸‹ç»„æˆ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Host group --&gt; Hosts --&gt; Applications --&gt; Items --&gt; Triggers --&gt; Events --&gt; Actions  (å‘è­¦å‘Š) --&gt; User group </div><div class="line">--&gt; Users --&gt; Medias</div><div class="line"></div><div class="line">graph, screen </div><div class="line">ä¾èµ–å…³ç³»:</div><div class="line">        Host --&gt; Item --&gt; Trigger --&gt; Action</div></pre></td></tr></table></figure><p>æ·»åŠ ä¸»æœºåˆ°zabbix server:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ä¸€å®šä¸è¦è®©æ²¡æœ‰ç›‘æ§çš„æœåŠ¡å™¨ä¸Šçº¿</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">å®šä¹‰å¥½discoevery: å¯ä»¥æ ¹æ®ç»™å®šçš„ç½‘æ®µï¼Œè‡ªåŠ¨æç½‘æ®µï¼Œå¹¶æ·»åŠ ï¼Œæ­¤ç§æ–¹å¼æ˜¯æœåŠ¡å™¨ç«¯ä¸»åŠ¨</div><div class="line">auto_registrion: è¢«ç›‘æ§ä¸»æœºï¼Œè‡ªåŠ¨å‘æœåŠ¡ç«¯æ³¨å†Œ</div><div class="line">low level discovery: åŒºåˆ«ä¸åŒçš„åº•å±‚è®¾å¤‡çš„</div></pre></td></tr></table></figure><p>æ¨¡æ¿(template):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ä¸€èˆ¬æ¨¡æ¿æ˜¯å¥—åœ¨ä¸»æœºä¹‹ä¸Šçš„;(item,application,trigger,graph,action)</div></pre></td></tr></table></figure><p>Item</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">é»˜è®¤çš„Iemsæœ‰å¤šç§ç±»å‹</div><div class="line">    Zabbix-agent</div><div class="line">        å·¥ä½œæ¨¡å¼: passive, active</div><div class="line">    </div><div class="line">    ç½‘å¡æµé‡ç›¸å…³:</div><div class="line">        net.if.in[if,&lt;mode&gt;]</div><div class="line">            if: æ¥å£ï¼Œå¦‚eth0</div><div class="line">            mode:bytes, packets, errors, dropped</div><div class="line">        net.if.out[if,&lt;mode&gt;]</div><div class="line">        net.if.total[if.&lt;mode&gt;]</div><div class="line">    </div><div class="line">    ç«¯å£ç›¸å…³:</div><div class="line">        net.tcp.listen[port]</div><div class="line">        net.tcp.port[&lt;ip&gt;,port]</div><div class="line">        net.tcp.service[service,&lt;ip&gt;,&lt;port&gt;]</div><div class="line">        net.udp.listen[port]</div><div class="line">    ç›‘æ§ç«¯å£æ˜¯å¦å¤„äºç›‘å¬çŠ¶æ€</div><div class="line">        </div><div class="line">    è¿›ç¨‹ç›¸å…³:</div><div class="line">        kernel.maxfiles å†…æ ¸æ‰“å¼€çš„æ–‡ä»¶æ•°</div><div class="line">        kernel.maxproc å†…æ ¸æ‰“å¼€çš„æœ€å¤§è¿›ç¨‹æ•°</div><div class="line">    CPUç›¸å…³:</div><div class="line">        system.cpu.intr ä¸­æ–­æ¬¡æ•°</div><div class="line">        system.cpu.load[&lt;cpu&gt;,&lt;mode&gt;] cpuè´Ÿè½½</div><div class="line">        system.cpu.num[type] cpuä¸ªæ•° </div><div class="line">        system.cpu.switches  cpuåˆ‡æ¢é¢‘ç‡</div><div class="line">        system.cpu.util [&lt;cpu&gt;,&lt;type&gt;,&lt;mode&gt;] cpuå“ªä¸ªæŒ‡æ ‡çš„åˆ©ç”¨ç‡</div><div class="line">        </div><div class="line">    ç£ç›˜IOç›¸å…³:</div><div class="line">        vfs.dev.read[&lt;device&gt;,&lt;type&gt;,&lt;mode&gt;]</div><div class="line">        vfs.dev.write[&lt;device&gt;,&lt;type&gt;,&lt;mode&gt;]</div><div class="line">        vfs.fs.inode [fs,&lt;mode&gt;]</div></pre></td></tr></table></figure><p>ç”¨æˆ·å¯è‡ªå®šä¹‰item:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">å…³é”®:é€‰å–ä¸€ä¸ªæƒŸä¸€çš„key;</div><div class="line">å‘½ä»¤:æ”¶é›†æ•°æ® çš„å‘½ä»¤æˆ–è„šæœ¬;</div></pre></td></tr></table></figure><p>Trigger:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">çŠ¶æ€: </div><div class="line">    OK: äº‹ä»¶è½¬ä¸ºæ­£çŠ¶æ€;</div><div class="line">    PROBLEMï¼šè¡¨ç¤ºæœ‰äº‹ä»¶å‘ç”Ÿ;</div><div class="line">    zabbix server æ¯æ¬¡æ¥æ”¶åˆ°itemsçš„æ–°æ•°æ®æ—¶</div><div class="line">å°±ä¼šå¯¹Itemçš„å½“å‰é‡‡æ ·å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå³ä¸triggerçš„è¡¨è¾¾å¼è¿›è¡Œæ¯”è¾ƒ;</div><div class="line">ä¸€ä¸ªtriggeråªèƒ½å±äºä¸€ä¸ªItemï¼Œä½†ä¸€ä¸ªItemå¯æœ‰æœ‰å¤šä¸ªTrigger;</div><div class="line">Severity:</div><div class="line">    No classfied: æœªçŸ¥çº§åˆ«ï¼Œç°è‰²;</div><div class="line">    Information: ä¸€èˆ¬ä¿¡æ¯ï¼Œäº®ç»¿;</div><div class="line">    Warning: è­¦å‘Šä¿¡æ¯ï¼Œé»„è‰²;</div><div class="line">    Average: ä¸€èˆ¬æ•…éšœï¼Œçº¢è‰²;</div><div class="line">    Disater:è‡´å‘½æ•…éšœï¼Œäº®çº¢;</div></pre></td></tr></table></figure><p>Action:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">è§¦å‘æ¡ä»¶ä¸€èˆ¬ä¸ºäº‹ä»¶:</div><div class="line">    Trigger events: OK --&gt; PROBLEM;</div><div class="line">    Discovery events: zabbixçš„network discoveryå·¥ä½œ;</div><div class="line">    Auto registration events: ä¸»åŠ¨æ¨¡å¼çš„agentæ³¨å†Œæ—¶äº§ç”Ÿçš„äº‹ä»¶;</div><div class="line">    Internal events: Itemå˜æˆä¸å†è¢«æ”¯æŒï¼Œæˆ–Triggerå˜æˆä¸ºæœªçŸ¥é“çŠ¶æ€</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>zabbixä½¿ç”¨è¿›é˜¶</title>
      <link href="/2018/04/02/zabbix%E9%AB%98%E7%BA%A7/"/>
      <url>/2018/04/02/zabbix%E9%AB%98%E7%BA%A7/</url>
      <content type="html"><![CDATA[<h1 id="zabbix-é«˜çº§ç”¨æ³•"><a href="#zabbix-é«˜çº§ç”¨æ³•" class="headerlink" title="zabbix é«˜çº§ç”¨æ³•"></a>zabbix é«˜çº§ç”¨æ³•</h1><p><img src="/images/zabbix_chatu.png" alt=""></p><h2 id="zabbix-æŠ¥è­¦åª’ä»‹"><a href="#zabbix-æŠ¥è­¦åª’ä»‹" class="headerlink" title="zabbix æŠ¥è­¦åª’ä»‹"></a>zabbix æŠ¥è­¦åª’ä»‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># å¯¹äºé‚®ä»¶æŠ¥è­¦æ¥å£ï¼ŒCentOSé»˜è®¤é‚®ä»¶æœåŠ¡å°±æ˜¯å¯åŠ¨çš„ï¼Œä½†æ˜¯ï¼Œåªèƒ½æœåŠ¡æœ¬åœ°åˆ°æœ¬åœ°å‘é‚®ä»¶;  </div><div class="line"># å¦‚æœéœ€è¦å¾€äº’è”ç½‘ä¸Šå‘é‚®ä»¶ï¼Œéœ€è¦æŠŠæœåŠ¡å™¨é…ç½®æˆé‚®ä»¶æœåŠ¡å™¨;</div><div class="line"># ä½†ä¸€èˆ¬æ¥è®²ï¼Œè‡ªå»ºé‚®ä»¶ç³»ç»Ÿï¼Œä»˜å‡ºçš„æˆæœ¬å’ŒæŠ€æœ¯éƒ½è¾ƒé«˜ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ç½‘è”ä¸Šçš„é‚®ä»¶æœåŠ¡;</div><div class="line"># è€Œå¯¹äºæŠ¥è­¦çš„å†…å®¹ï¼Œä¸€èˆ¬æ˜¯æˆ‘ä»¬åœ¨zabbixæœåŠ¡ç«¯é…ç½®çš„å®æ‰€å®šä¹‰çš„å†…å®¹;</div><div class="line"># æ²¡æœ‰itemçš„é…ç½®ï¼Œé‚£ä¹ˆå°†æ„å‘³ç€æ²¡æœ‰ç›‘æ§æ•°æ®;</div></pre></td></tr></table></figure><h2 id="Zabbixæœ¯è¯­ä¸æ“ä½œæ³¨æ„é¡¹"><a href="#Zabbixæœ¯è¯­ä¸æ“ä½œæ³¨æ„é¡¹" class="headerlink" title="Zabbixæœ¯è¯­ä¸æ“ä½œæ³¨æ„é¡¹"></a>Zabbixæœ¯è¯­ä¸æ“ä½œæ³¨æ„é¡¹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line">Item Key </div><div class="line">    å‘½åæ±‚: åªèƒ½ä½¿ç”¨å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹å·ã€è¿æ¥ç¬¦;</div><div class="line">    æ¥å—å‚æ•°: system.cpu.load[&lt;cpu&gt;,&lt;mode&gt;], net.if.inbound[if,&lt;mode&gt;]</div><div class="line">    æ³¨æ„: æ¯ä¸€ä¸ªkeyèƒŒåéƒ½åº”è¯¥æœ‰ä¸€ä¸ªå‘½ä»¤æˆ–è€…è„šæœ¬æ¥è´Ÿè´£å®ç°æ•°æ®æ”¶é›†ï¼›å‘½ä»¤æˆ–è€…è„šæœ¬å¯ä»¥è°ƒç”¨ä¼ é€’ç»™keyçš„å‚æ•°ï¼Œè°ƒç”¨æ–¹å¼ä¸º$1,$2,...</div><div class="line">    åœ¨zabbixä¸­å®šä¹‰itemæ—¶è°ƒç”¨æŸkeyï¼Œè¿˜éœ€è¦é¢å¤–å®šä¹‰æ•°æ®é‡‡é›†é¢‘ç‡(æ¯30ç§’é‡‡é›†ä¸€æ¬¡)ã€å†å²æ•°æ®çš„ä¿å­˜æ—¶é•¿ç­‰;</div><div class="line">Trigger:</div><div class="line">    è§¦å‘å™¨è¡¨è¾¾å¼: &#123;&lt;Server&gt;:&lt;key&gt;.&lt;function&gt;(&lt;parameter&gt;)&#125;&lt;operator&gt;&lt;constant&gt;</div><div class="line">    ä¾‹: &#123;api.transfereasy.com:net.tcp.listen[9991].last()&#125;#1</div><div class="line">    &lt;function&gt;: è¯„ä¼°é‡‡é›†åˆ°çš„æ•°æ®æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…æ—¶æ‰€ä½¿ç”¨çš„å‡½æ•°ï¼Œå…±è¯„ä¼°è¿‡ç¨‹å¯ä»¥æ ¹æ®é‡‡é›†åˆ°çš„æ•°æ®ã€å½“å‰æ—¶é—´æˆ–å…¶å®ƒå› ç´ ;</div><div class="line">        avg:å¹³å‡å€¼;</div><div class="line">        count:æŒ‡å®šæ—¶é—´å†…çš„ç»Ÿè®¡;</div><div class="line">        change:è¿”å›æœ€è¿‘è¿”å›çš„å€¼ï¼Œä¸ä¹‹å‰ä¸€æ¬¡çš„å·®å€¼;</div><div class="line">        date:å½“å¤©çš„å€¼;</div><div class="line">        dayofweek:è¿”å›æœ¬å‘¨çš„ç¬¬å‡ å¤©çš„å€¼;</div><div class="line">        dayofmonth:è¿”å›æœ¬æœˆçš„ç¬¬å‡ å¤©çš„å€¼;</div><div class="line">        delta:æŒ‡å®šæ—¶é—´èŒƒå›´å†…æœ€å¤§å€¼ä¸æœ€å°å€¼ä¹‹å·®;</div><div class="line">        diff:å½“æ–‡ä»¶ä¸ä¸€æ ·æ—¶;</div><div class="line">        iregexp:å¿½ç•¥å¤§å°å†™å®ƒç¬¦çš„æ­£åˆ™è¡¨è¾¾å¼;</div><div class="line">        last:æœ€è¿‘ä¸€æ¬¡é‡‡æ ·;</div><div class="line">        max:æœ€è¿‘é‡‡æ ·çš„æœ€å¤§å€¼;</div><div class="line">        min:æœ€è¿‘é‡‡æ ·çš„æœ€å°å€¼;</div><div class="line">        nodata: è¡¨ç¤ºæ²¡æœ‰æ•°æ®;</div><div class="line">        sum:æœ€åä¸€æ¬¡é‡‡æ ·æ•°æ®ä¹‹å’Œ;</div><div class="line">        regexp:æ£€æŸ¥æœ€åä¸€æ¬¡é‡‡æ ·çš„å€¼æ˜¯å¦èƒ½å¤Ÿè¢«æŒ‡å®šçš„æ¨¡å¼æ‰€åŒ¹é…: 1ã€è¡¨ç¤ºåŒ¹é…, 0è¡¨ç¤ºä¸åŒ¹é…;</div><div class="line">        now:è¿”å›è‡ªUnixå…ƒå¹´è‡³æ­¤åˆ»ç»å†çš„ç§’æ•°;</div><div class="line">        prev:å€’æ•°ç¬¬äºŒä¸ªé‡‡æ ·å€¼:</div><div class="line">        str:ä»æœ€åä¸€æ¬¡çš„é‡‡æ ·ä¸­æŸ¥æ‰¾åˆ°æ­¤å¤„æŒ‡å®šçš„å­ä¸²:</div><div class="line">        strlen: åšå­—ç¬¦ä¸²çš„é•¿åº¦æ¯”è¾ƒ;</div><div class="line">        prev:å€’æ•°ç¬¬äºŒä¸ªé‡‡æ ·å€¼</div><div class="line">    &lt;operator&gt;:</div><div class="line">            &gt;, &lt;, =, #(è¡¨ç¤ºä¸ç­‰äº)äº‹å®ä¸Šæˆ‘ä»¬å¯ä»¥è®©è¡¨è¾¾å¼çš„å€¼ç›´æ¥æ¥åšç®—æœ¯è¿ç®—çš„;</div><div class="line">            / ,* ,- ,+</div><div class="line">            &amp;(ä¸),|(æˆ–)</div><div class="line">    è§¦å‘å™¨ä¹‹é—´çš„å…³ç³»        </div><div class="line"></div><div class="line">Action:</div><div class="line">    message:</div><div class="line">    condition:</div><div class="line">        ä¸€èˆ¬ç”±eventè§¦å‘:</div><div class="line">            trigger</div><div class="line">            discover:</div><div class="line">                Service Up ,Srvice Down ,Host up ,Host down, Service Discovered,Service Lost,Host Discovered, Host Lost</div><div class="line">            auto-registration</div><div class="line">            </div><div class="line">    operation:</div><div class="line">        send message</div><div class="line">            Medis Type</div><div class="line">                Email (å¸¸ç”¨),SMS ,Jabber, Scripts(å¸¸ç”¨), EZ Texting</div><div class="line">            Usser</div><div class="line">        remote command(è¿œç¨‹å‘½ä»¤)</div><div class="line">            è¿è¡Œzabbixè¿›ç¨‹çš„ç”¨æˆ·æ˜¯zabixç”¨æˆ·</div><div class="line">            æ‰€ä»¥è¿™é‡Œè¦æ³¨æ„ï¼Œzabbixæœªå¿…æœ‰æƒé™æ‰§è¡Œ</div><div class="line">            (1) ç»™zabbix å®šä¹‰sudoè§„åˆ™:    </div><div class="line">                zabbix ALL=(ALL) ALL</div><div class="line">            (2) ä¸æ”¯æŒactiveæ¨¡å¼çš„agent:</div><div class="line">            (3) ä¸æ”¯æŒä»£ç†æ¨¡å¼:</div><div class="line">            (4) å‘½ä»¤é•¿åº¦ä¸å¾—è¶…è¿‡255ä¸ªå­—ç¬¦:</div><div class="line">            (5) å¯ä»¥ä½¿ç”¨å®:</div><div class="line">            (6) zabbix-serverä»…æ‰§è¡Œå‘½ä»¤ï¼Œè€Œä¸å…³å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ:</div><div class="line">            </div><div class="line">            å‰æ: zabbix-agentè¦é…ç½®ä¸ºæ”¯æŒæ‰§è¡Œè¿œç¨‹å‘½ä»¤:</div><div class="line">                EanbleRemoteCommands =1  </div><div class="line">                LogRemoteCammands =1  # å¯ç”¨æ‰§è¡Œè¿œç¨‹å‘½ä»¤åè®°å½•</div><div class="line">            # vim /etc/sudoers  æˆ–è€…  visudo </div><div class="line">                zabbix ALL=(ALL)  NOPASSWD:ALL</div><div class="line">                æ³¨: ä»¥ä¸ŠæœåŠ¡å™¨æƒé™çš„æ˜¯æ“ä½œæ˜¯éå¸¸ç”¨é£é™æ€§çš„; </div><div class="line">            Actions --&gt; Operations --&gt; New </div><div class="line">                --&gt; Operation type Remote Command:</div><div class="line">                --&gt; Host  æŒ‘è¿œå‡ºè¿œç¨‹ä¸»æœº</div><div class="line">                --&gt; Global script --&gt;åœ¨æ–¹æ¡†ä¸­åŠ å…¥è¿œç¨‹å‘½ä»¤ </div><div class="line">            Hosts --&gt; Applications --&gt; Create Applications --&gt; Http</div><div class="line">            Hosts --&gt; Items --&gt; Create Items</div><div class="line">            --&gt; Name http server </div><div class="line">            --&gt; Type zabbix aggent </div><div class="line">            --&gt; Key net.tcp.listen[80]</div><div class="line">            --&gt; Applications http service</div><div class="line">            Add Items &lt;--</div><div class="line">            </div><div class="line">            Host --&gt; Triger --&gt; Create Triger</div><div class="line">            --&gt; Name http service is on</div><div class="line">                Expresion --&gt; add </div><div class="line">                    --&gt;Item node2: http service </div><div class="line">                    --&gt; Function: Previous value is =1 </div><div class="line">                    --&gt; Last of(T) 1</div><div class="line">                    --&gt; N 0</div><div class="line">                    --&gt; ä¸¥é‡çº§åˆ«å…ˆHight </div><div class="line">            Configuration --&gt; Actions --&gt; Create Action --&gt;</div><div class="line">                Action Name http service</div><div class="line">                Conditions --&gt; New condition Trigger == node1: httpd serivce is value</div><div class="line">                Operations --&gt; å®šä¹‰æŠ¥è­¦å‡çº§ --&gt; å¯ä»¥å®šä¹‰ç”±ç¬¬ä¸€æ­¥åˆ°ç¬¬å‡ æ­¥æ‰§è¡Œä»€ä¹ˆæ ·çš„æ“ä½œ       </div><div class="line">                æ³¨æ„:</div><div class="line">                    (1) å¦‚æœç”¨åˆ°ä»¥æŸå®ƒç”¨æˆ·èº«ä»½è¿è¡Œå…¶å®ƒå‘½ä»¤çš„è¯ï¼Œè¦åŠ  sudo æ¥è¿è¡Œ;</div><div class="line">                        sudo systemctl restart httpd</div><div class="line">                    (2) åœ¨å„gentä¸Šçš„sudoers æ–‡ä»¶ä¸­ï¼Œè¦æ³¨é‡Šå¦‚ä¸‹è¡Œï¼Œå¦åˆ™å‘½ä»¤ä¾æ—§æ— æ³•æ­£å¸¸è¿è¡Œ;</div><div class="line">                        # Default requiretty </div><div class="line">        Script: Alert Script </div><div class="line">        </div><div class="line">            æ”¾ç½®äºç‰¹å®šç›®å½•ä¸­: AlertScriptsPath=/usr/lib/zabbix/alertscripts</div><div class="line">                zabbix_server.confé…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°:</div><div class="line">                è„šæœ¬ä¸­ä½¿ç”¨$1,$2,$3æ¥è°ƒç”¨Actionå…ˆé¡¹å¡ä¸­çš„æ”¶ä»¶äººåœ°å€, Default Subject , Default Massage:</div><div class="line">                # vim alert_message.sh</div><div class="line">                #!/bin/bash</div><div class="line">                to=$1</div><div class="line">                subject=&quot;$2&quot;</div><div class="line">                body=&quot;$3&quot;</div><div class="line">                echo &quot;$body&quot; | mail -s &quot;$subject&quot; &quot;$to&quot;</div><div class="line">                # chmod +x alert_message.sh </div><div class="line">                å½“ç„¶è¿™é‡Œæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å®ç°è„šæœ¬ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨python,bash,ruby,perl ç­‰è„šæœ¬</div><div class="line">                æ³¨æ„: æ–°æ”¾å…¥æ­¤ç›®å½•ä¸­çš„è„šæœ¬ï¼Œåªæœ‰é‡å¯zabbix æ–¹èƒ½è¢«å®åˆ«;</div><div class="line">                </div><div class="line">                Administration --&gt; Mdedia types --&gt; </div><div class="line">                            --&gt; Name AlterScript</div><div class="line">                            --&gt; Type Script </div><div class="line">                            --&gt; Script name alert_message.sh </div><div class="line">                Administration --&gt; Users ---&gt;</div><div class="line">                            --&gt; Media --&gt; add </div><div class="line">                            --&gt; AlterScripts root@localhost</div><div class="line">                è¿™æ ·çš„è¯ï¼Œé€šè¿‡ä¸¤ç§æ–¹å¼éƒ½èƒ½æ”¶åˆ°é‚®ä»¶</div><div class="line">Escalation </div><div class="line">Template</div><div class="line">Web Scennario</div></pre></td></tr></table></figure><h2 id="ZabbixæœåŠ¡å™¨è¿›ç¨‹"><a href="#ZabbixæœåŠ¡å™¨è¿›ç¨‹" class="headerlink" title="ZabbixæœåŠ¡å™¨è¿›ç¨‹"></a>ZabbixæœåŠ¡å™¨è¿›ç¨‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">housekeeper ç”¨æ¥æ¸…ç†è¿‡æœŸæ•°æ®çš„;</div><div class="line">alter ä¸“é—¨ç”¨æ¥å‘é€è­¦å‘Šçš„è¿›ç¨‹;</div><div class="line">discoverer å®ç°ä¸»æœºå‘ç°çš„; </div><div class="line">httppoller å¯¹webæœåŠ¡å™¨è¿›è¡Œç›‘æ§æ—¶;</div><div class="line">Poller ä¸»åŠ¨å»è¢«ç›‘æ§èŠ‚ç‚¹å»æ‹‰å–æ•°æ®;</div><div class="line">Pinger åŸºäºpingå‘½ä»¤æ¥æ¢æµ‹ä¸»æœºæ˜¯å¦åœ¨çº¿;</div><div class="line">db_config_syncer æœåŠ¡å™¨é…ç½®åŒæ­¥çš„; </div><div class="line">timer è®¡æ—¶å™¨;</div><div class="line">escaltor  æŠ¥è­¦å‡çº§å™¨;</div></pre></td></tr></table></figure><h2 id="zabbix-å¯è§†åŒ–"><a href="#zabbix-å¯è§†åŒ–" class="headerlink" title="zabbix å¯è§†åŒ–"></a>zabbix å¯è§†åŒ–</h2><p>è‡ªå®šä¹‰å›¾å½¢å±æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Name: å›¾å½¢çš„ç‹¬æœ‰åç§°;</div><div class="line">Width: å›¾å½¢çš„å®½åº¦ï¼Œå•ä½ä¸ºåƒç´ ;ä»…é€‚ç”¨äº&quot;é¢„è§ˆ(perview)&quot; æ¨¡å¼ã€é¥¼å›¾æˆ–åˆ†ç¦»å‹é¥¼å›¾; </div><div class="line">Height: å›¾å½¢çš„ç±»å‹, å…±æœ‰å››ç§ï¼Œå³&quot;çº¿çŠ¶å›¾normal&quot;ã€&quot;å †å é¢ç§¯å›¾&quot;ã€&quot;é¥¼å›¾(pie)&quot;ã€ åˆ†ç¦»å‹é¥¼å›¾(exploded);</div><div class="line">Show legend: æ˜¯å¦æ˜¾ç¤ºå›¾ä¾‹ï¼Œå³å›¾å½¢æ•°æ®åºåˆ—è¯´æ˜;</div><div class="line">Show working time: æ˜¯å¦é«˜äº®æ˜¾ç¤ºå·¥ä½œæ—¶é—´åŒºåŸŸ;é€‰å®šæ—¶ï¼Œéå·¥ä½œæ—¶é—´åŒºé—´çš„èƒŒæ™¯ä¸ºç°è‰²;æ­¤åŠŸèƒ½ä¸ç”¨äºpieå’Œexploded;</div><div class="line">Show Triggers: æ˜¯å¦æ˜¾ç¤ºè§¦å‘å™¨;æ­¤åŠŸèƒ½ä¸é€‚ç”¨äºpieå’Œexploded;</div></pre></td></tr></table></figure><p>å¤šå›¾å½¢åˆå¹¶æ˜¾ç¤º </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Configuration --&gt; Screen --&gt; Create Screen </div><div class="line">--&gt; Name Test Screen</div><div class="line">--&gt; Columns 3 # åˆ—</div><div class="line">--&gt; Row 2  # è¡Œ</div><div class="line">        --&gt; Test Screen </div><div class="line">            --&gt; change è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ª2è¡Œ3åˆ—çš„è¡¨æ ¼ï¼Œç„¶åå¾€é‡Œé¢æ·»åŠ å›¾ç‰‡;</div></pre></td></tr></table></figure><p>å¤šå±ç¿»è½¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Slide shows</div><div class="line">Name </div><div class="line">Default delay(in seconds)</div></pre></td></tr></table></figure><p>å¯è§†åŒ–: graph ,screen, slide shows,map</p><p>å®(macros)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># å®å…¶å®è¯´ç™½äº†å°±æ˜¯å˜é‡ï¼Œç±»å‹é€šå¸¸ä¸ºæ–‡æœ¬ç±»å‹; </div><div class="line">#  ä¸ºäº†æ›´å¼ºçš„çµæ´»æ€§,zabbixè¿˜æ”¯æŒåœ¨å…¨å±€ã€æ¨¡æ¿æˆ–ä¸»æœºçº§åˆ«ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å®(user macro);</div><div class="line">#  ç”¨æˆ·è‡ªå®šä¹‰å®è¦ä½¿ç”¨&quot;&#123;$MACRO&#125;&quot;è¿™ç§ç‰¹æ®Šçš„è¯­æ³•æ ¼å¼; </div><div class="line">#  å®å¯ä»¥åº”ç”¨åœ¨item keys å’Œdescriptionsã€ trigger åç§°å’Œè¡¨è¾¾å¼ã€ä¸»æœºæ¥å£IP/DNSåŠç«¯å£ã€ discoveryæœºåˆ¶çš„SNMPåè®®çš„ç›¸å…³ä¿¡æ¯ç­‰;</div><div class="line"># å®çš„åç§°åªèƒ½ä½¿ç”¨å¤§å†™å­—æ¯ã€æ•°å­—åŠä¸‹åˆ’çº¿;</div><div class="line"># ä¸¤ç±»:</div><div class="line">    å†…å»º: &#123;MACRO_NAME&#125;</div><div class="line">    è‡ªå®šä¹‰:&#123;$MACRO_NAME&#125;</div><div class="line"></div><div class="line"># å¯ä»¥åœ¨ä¸‰ä¸ªçº§åˆ«ä½¿ç”¨:</div><div class="line">    Global, Template, Host</div><div class="line"></div><div class="line"># ä¼˜å…ˆçº§: Host --&gt; Template --&gt; Global</div><div class="line">    åœ¨æŸçº§åˆ«æ‰¾åˆ°åå°†ç›´æ¥ä½¿ç”¨: å°†ä¸å†æŸ¥æ‰¾</div><div class="line">    </div><div class="line">    å…¨å±€å®:</div><div class="line">        Adminstration --&gt; General --&gt; Macrios(åœ¨å…ˆé¡¹å¡ä¸­)</div><div class="line">    </div><div class="line">    ä¸»æœºå®:</div><div class="line">        Configuration --&gt; Hosts --&gt; Macrios ä¸»æœºçº§åˆ«çš„å®ä¼˜å…ˆçº§æœ€é«˜;</div><div class="line">    </div><div class="line">    Template:</div><div class="line">        Configuration --&gt; Complation --&gt; Macrios</div></pre></td></tr></table></figure><h2 id="æ¨¡æ¿-Templats"><a href="#æ¨¡æ¿-Templats" class="headerlink" title="æ¨¡æ¿(Templats)"></a>æ¨¡æ¿(Templats)</h2><p>ä¸€ç³»åˆ—é…ç½®çš„é›†åˆï¼Œæ­¤äº›é…ç½®å¯ä»¥é€šè¿‡â€é“¾æ¥â€çš„æ–¹å¼åº”ç”¨äºæŒ‡å®šçš„ä¸»æœº:<br>application, item, trigger, graph, scree åŠå‘ç°è§„åˆ™; </p><p>æ·»åŠ ä¾‹è¡Œæƒ¯å¸¸çš„ç»´æŠ¤æ—¶é—´; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Configuration --&gt; maintenance --&gt; Maintenance</div></pre></td></tr></table></figure><p>User Parameters:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># zabbix å†…ç½®äº†è®¸å¤šitem key:</div><div class="line">å®ç°ç”¨æˆ·è‡ªå®šä¹‰ item key ,å®ç°ç‰¹æœ‰æ•°æ®æŒ‡æ ‡ç›‘æ§;</div><div class="line">è¯­æ³•:</div><div class="line">    UserParameter=&lt;key&gt;,&lt;command&gt;</div><div class="line"># vim  /etc/zabbix/zabbix_agentd.d/os.conf</div><div class="line">UserParameter=os.memory.used, free -m | awk &apos;/^Mem/ &#123;print $3&#125;&apos;</div><div class="line">UserParameter=os.memory.used, free -m | awk &apos;/^Mem/ &#123;print $3&#125;&apos;</div><div class="line">UserParameter=os.memory.used, free -m | awk &apos;/^Mem/ &#123;print $3&#125;&apos;</div><div class="line">æ³¨: éœ€è¦é‡å¯zabbix-agent æ‰èƒ½ä½¿ç”¨</div><div class="line"># systemctl restart zabbix-agent</div><div class="line">è¿™ä¸ªæ—¶å€™å®šä¹‰çš„zabbix-agent keyå°±å¯ä»¥ä½¿ç”¨äº†,åœ¨server web æ¥å£ä¸­æ·»åŠ ; </div><div class="line">å¦‚æœæ‰¾ä¸åˆ°key  åˆ™ç›´æ¥è¾“å…¥å³å¯ os.memory.used</div></pre></td></tr></table></figure><h2 id="ç›‘æ§nginx-status"><a href="#ç›‘æ§nginx-status" class="headerlink" title="ç›‘æ§nginx status"></a>ç›‘æ§nginx status</h2><p>nginx status å¼€å¯æ–¹æ³•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        ...</div><div class="line">        location /status &#123;</div><div class="line">            stub_status on;</div><div class="line">            access_log off;</div><div class="line">            allow 172.16.55.123; # å…è®¸è®¿é—®çš„IP</div><div class="line">            allow 127.0.0.1;</div><div class="line">            deny all;</div><div class="line">            &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">çŠ¶æ€é¡µé¢å„é¡¹æ•°æ®çš„æ„ä¹‰;</div><div class="line">active connections - å½“å‰Nginx æ­£å¤„ç†çš„æ´»åŠ¨è¿æ¥æ•°;</div><div class="line">serveraccepts handled requests - æ€»å…±å¤„ç†äº† 233851ä¸ªè¿æ¥ï¼ŒæˆåŠŸåˆ›å»º 233851æ¬¡æ¡æ‰‹(è¯æ˜ä¸­é—´æ²¡æœ‰å¤±è´¥çš„)</div><div class="line">    æ€»å…±å¤„äº† 687942ä¸ªè¯·æ±‚(å¹³å‡æ¯æ¬¡æ‰¬å¤„ç†äº†  2.94 ä¸ªæ•°æ®è¯·æ±‚)ã€‚</div><div class="line">    reading -nginx è¯»å–åˆ°å®¢æˆ·ç«¯çš„Headerä¿¡æ¯æ•°;</div><div class="line">    writing -nginx è¿”å›ç»™å®¢æˆ·ç«¯çš„Header ä¿¡æ¯æ•°; </div><div class="line">    waiting - å¼€å¯ keep-alive çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ç­‰äº active- (reading +wrting) æ„æ€å°±æ˜¯Nginx å·²ç»å¤„ç†å®Œæ­£ç­‰å€™ä¸€æ¬¡è¯·æ±‚æŒ‡ä»¤çš„é©»ç•™è¿æ¥;</div><div class="line">UserParameter=Mysql.dml[*], /usr/local/mysql/bin/mysql -h$1 -u$2 -p$3 -e &apos;SHOW GLOBAL STATUS&apos; | awk &apos;/Com_$4\&gt;/&#123;print $$2&#125;&apos; # åœ¨/etc/init.d/zabbix_agentd.d/xx.confä¸­å®šä¹‰äº†ä»¥ä¸Šé¡¹å; </div><div class="line">åœ¨zabbix-server ç»ˆç«¯</div><div class="line"></div><div class="line">zabbix_get -s 172.16.55.124 -p 10050 -k &quot;Mysql.dml[172.16.55.124,root,password,delete]&quot;  #æ³¨æ„mysqlç”¨æˆ·çš„æˆæƒ</div><div class="line">zabbix_get -s 172.16.55.124 -p 10050 -k &quot;Mysql.dml[172.16.55.124]&quot;</div><div class="line">UserParameter=Nginx.active[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | awk &apos;/^Active/ &#123;print $NF&#125;&apos;</div><div class="line">UserParameter=Nginx.reading[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | grep &apos;Reading&apos; | cut -d&quot; &quot; -f2</div><div class="line">UserParameter=Nginx.writing[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | grep &apos;Writing&apos; | cut -d&quot; &quot; -f4</div><div class="line">UserParameter=Nginx.waiting[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | grep &apos;Waiting&apos; | cut -d&quot; &quot; -f6</div><div class="line">UserParameter=Nginx.accepted[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | awk &apos;/^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+/ &#123;print $$1&#125;&apos;</div><div class="line">UserParameter=Nginx.handled[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | awk &apos;/^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+/ &#123;print $$2&#125;&apos;</div><div class="line">UserParameter=Nginx.requests[*], /usr/bin/curl -s &quot;http://$1:$2/status&quot; | awk &apos;/^[ \t]+[0-9]+[ \t]+[0-9]+[ \t]+[0-9]+/ &#123;print $$3&#125;&apos;</div><div class="line"></div><div class="line">UserParameter=nginx.access_countaccess, /usr/lib/zabbix/externalscripts/logcheck_nginx.accesslog totalaccess</div><div class="line">UserParameter=nginx.access_count200, /usr/lib/zabbix/externalscripts/logcheck_nginx.accesslog 200access</div><div class="line">UserParameter=nginx.access_count202, /usr/lib/zabbix/externalscripts/logcheck_nginx.accesslog 202access</div><div class="line">UserParameter=nginx.access_count4xx, /usr/lib/zabbix/externalscripts/logcheck_nginx.accesslog 4xxaccess</div><div class="line">UserParameter=nginx.access_count3xx, /usr/lib/zabbix/externalscripts/logcheck_nginx.accesslog 3xxaccess</div><div class="line">UserParameter=nginx.access_count5xx, /usr/lib/zabbix/externalscripts/logcheck_nginx.accesslog 5xxaccess</div><div class="line"></div><div class="line">UserParameter=varnish.stat[*], /usr/lib/zabbix/externalscripts/varnishstatus varnish_stat $1</div><div class="line">UserParameter=varnish.count[*], /usr/lib/zabbix/externalscripts/varnishstatus varnish_count $1</div><div class="line">UserParameter=varnish.hitrate, /usr/lib/zabbix/externalscripts/varnishstatus varnish_hitrate</div></pre></td></tr></table></figure><h2 id="zabbix-è‡ªåŠ¨å‘ç°åŠŸèƒ½"><a href="#zabbix-è‡ªåŠ¨å‘ç°åŠŸèƒ½" class="headerlink" title="zabbix è‡ªåŠ¨å‘ç°åŠŸèƒ½"></a>zabbix è‡ªåŠ¨å‘ç°åŠŸèƒ½</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">zabbix æä¾›ç½‘ç»œå‘ç°åŠŸèƒ½: network discovery</div><div class="line">    åŸºäºHTTPã€ ICMPã€ SSHã€ LDAPã€ TCPã€ SNMPã€ Telnetã€ Zabbix_agentæ‰«ææŒ‡å®šç½‘å†…çš„ä¸»æœº;</div><div class="line">    ä¸€æ—¦ä¸»æœºè¢«å‘ç°ï¼Œå¦‚ä½•å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œå°†ç”±actionæ¥å†³å®š;</div><div class="line">    LLD: low leverl Discovery (åº•çº§ç½‘ç»œå‘ç°åŠŸèƒ½)</div><div class="line">    æ­¤äºŒè€…çš„åŠŸèƒ½:</div><div class="line">        è‡ªåŠ¨æ·»åŠ ä¸»æœºã€é“¾æ¥è‡³æ¨¡æ¿/ç§»é™¤é“¾æ¥ã€è‡ªåŠ¨åˆ†ç»„ã€è‡ªåŠ¨æ·»åŠ ç›‘æ§é¡¹ã€å®šä¹‰è§¦å‘å™¨ç­‰ã€æ‰§è¡Œè¿œç¨‹è„šæœ¬;</div><div class="line">    Discoveryä¸­çš„äº‹ä»¶:</div><div class="line">        Service Up, Service Down, Host Up, Host Down, Service Discovered, Service Lost, Host Discovererd, Host Lost</div><div class="line"></div><div class="line">    ç½‘ç»œå‘ç°æœ‰ä¸¤ä¸ªæ­¥éª¤:</div><div class="line">        discovery --&gt; action</div><div class="line">    actions:</div><div class="line">        Sending notifications</div><div class="line">        Adding/removting hosts</div><div class="line">        Enabling/disabling hosts</div><div class="line">        Adding hosts to a group</div><div class="line">        Removing hosts from a group </div><div class="line">        Linking hosts to/unlinking from a template</div><div class="line">        Executing remote scripts</div><div class="line">        </div><div class="line">        è‡ªåŠ¨å‘ç°åŠŸèƒ½çš„ä½¿ç”¨ï¼Œé¦–å…ˆè¦å°†serverç«¯å’Œagentuç«¯çš„æ—¶é—´è‡ªåŠ¨åŒæ­¥;</div><div class="line">         # vim /etc/zabbix/zabbix_agentd.conf </div><div class="line">         Server = 172.16.55.124</div><div class="line">         ServerActive = 172.16.55.124</div><div class="line">         Hostname = test.xxxxxx.com</div><div class="line">         LogRemoteCommand = 1</div><div class="line">         # systectl start zabbix-agent</div><div class="line">         </div><div class="line">         Configure --&gt; Discovery --&gt; Create discovery rule </div><div class="line">            --&gt; Name Local Linux Servers </div><div class="line">            --&gt; IP range 172.16.55.125-127</div><div class="line">            Delay(in sec)  3600</div><div class="line">            --&gt; Checks  Check type ICMP ping(æœ€æ˜“äºå®ç°çš„æ–¹å¼) --&gt; Add</div><div class="line">            --&gt; Device uniqueness criteria IP address </div><div class="line">            --&gt; Enabled </div><div class="line">            Add &lt;--</div><div class="line">        # å½“è¿”å›åˆ°Discovery æ—¶ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡å™¨å·²ç»è¢«è‡ªåŠ¨å‘ç°;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"> # åˆ›å»ºåŠ¨ä½œ</div><div class="line"> Configuration --&gt; Actions --&gt; Discovery(å’Œä»¥å¾€actionä¸åŒï¼Œåœ¨é€‰é¡¹å¡ä¸­å…ˆæ‹©)</div><div class="line"> ä¸»æœºå‘ç°çš„æ¡ä»¶</div><div class="line">    Conditions: New condition Host IP =</div><div class="line">                        æˆ–è€…æŒ‡å®šç½‘ç»œçš„å‘ç°è§„åˆ™æ¥å®šä¹‰</div><div class="line">    Operations:  è¿™é‡Œå°±å¯ä»¥å®šä¹‰å¯¹åº”çš„æ“ä½œï¼ˆæ·»åŠ åˆ°ç»„ä¸­ï¼‰</div><div class="line"> Configuration --&gt; Templates --&gt; </div><div class="line">    --&gt; Template name Linux Server Memory Stats</div><div class="line">    --&gt; Visible anme</div><div class="line">    --&gt; Groups In groups test group </div><div class="line">    Add &lt;--</div><div class="line"># å¦å¤–éœ€è¦è‡ªå·±å®šä¹‰å¥½ä¸€ä¸ªæ¨¡æ¿</div><div class="line"></div><div class="line">Configuration --&gt; Actions  --&gt; Create Action</div><div class="line">--&gt; Conditions --&gt; Type of calculation And/Or </div><div class="line">--&gt; Conditions --&gt; Host IP = 172.16.55.125-128</div><div class="line">                            --&gt;Discovery rule = Local Linux Servers</div><div class="line">                            --&gt; Discovery status = Discovered</div><div class="line">--&gt; Operations --&gt; New</div><div class="line">        --&gt; Add  To host group  (Test group) # æ·»åŠ åˆ°ç»„ä¸­</div><div class="line">        --&gt; Link to template  Linux Server Memory status  add </div><div class="line">ADD &lt;--</div><div class="line"></div><div class="line">åœ¨ç½‘ç»œçš„è‡ªåŠ¨å‘ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨zabbix-agentæ¥å‘ç° </div><div class="line">åœ¨ç½‘ç»œçš„ä¸»åŠ¨å‘ç°ä¸­ï¼Œç”±äºæ˜¯zabbixä¸»åŠ¨æ‰«æï¼Œå› æ­¤è¿™ç§æ¨¡å‹æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½çš„</div></pre></td></tr></table></figure><p>åœ¨mariadbä¸­æŸ¥çœ‹æ”¯æŒçš„key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MariaDB&gt; use zabbix;</div><div class="line">MariaDB&gt; SELECT key_ FROM items;</div><div class="line">ä½¿ç”¨agent-ping æ¥åšå®ç°ä¸»æœºæ¢æµ‹;</div></pre></td></tr></table></figure><h2 id="auto-registation-ä¸»åŠ¨æ³¨å†ŒåŠŸèƒ½"><a href="#auto-registation-ä¸»åŠ¨æ³¨å†ŒåŠŸèƒ½" class="headerlink" title="auto_registation ä¸»åŠ¨æ³¨å†ŒåŠŸèƒ½"></a>auto_registation ä¸»åŠ¨æ³¨å†ŒåŠŸèƒ½</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Active Agent Auto-Registration</div><div class="line"># é¦–å…ˆä¸»æœºä¹‹é—´è¦æ—¶é—´åŒæ­¥; </div><div class="line"># å®‰è£…zabbix-agent ç«¯;</div><div class="line"># vim /etc/zabbix/zabbix-agent.conf</div><div class="line"># ServerActive=172.16.100.6</div><div class="line"># Hostname=test.xxxxx.com</div><div class="line"># ListenIp=172.16.55.126</div><div class="line"># HostMetdata = test4  (åªç”¨äºè‡ªåŠ¨æ³¨å†Œä¸»æœºçš„å”¯ä¸€æ ‡è¯†)</div><div class="line"> # systemctl restart zabbix-agent</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># æ·»åŠ è‡ªåŠ¨æ³¨å†Œçš„åŠ¨ä½œ</div><div class="line">Configuration --&gt;  Actions --&gt; (Event source Autoregistration) --&gt; Create Action</div><div class="line">--&gt; Actions: auto registration </div><div class="line">--&gt; Condition: Hostname like node4  (æ¯”å¦‚ä¸»æœºåä¸­åŒ…ä¸­åŒ…æ¶µnode4) --&gt; Add</div><div class="line">--&gt; Operations  Add to Host groups --&gt; Link with templates é“¾æ¥è‡³æ¨¡æ¿</div><div class="line"># æ”¯æŒä½¿ç”¨agent(active)ç±»å‹çš„item key:</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># é…ç½®è¿‡ç¨‹:</div><div class="line">    (1)å®šä¹‰agentç«¯:</div><div class="line">        ServerActive=</div><div class="line">        Server=</div><div class="line">        Hostname=</div><div class="line">        ListenIP= è®¾ç½®ä¸ºæœ¬æœºæŸç‰¹å®šIPï¼š</div><div class="line">        ListenPort=</div><div class="line">        HostMetadata=</div><div class="line">        HostMetadataItem= item keyï¼Œ ä¸€èˆ¬ä½¿ç”¨system.uname</div><div class="line">    </div><div class="line">    (2) é…ç½®actionï¼Œè¦æ±‚å…¶äº‹ä»¶ä¸€æºä¸ºauto-registation</div></pre></td></tr></table></figure><p>LLD: low Level Discovery </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># è‡ªåŠ¨å‘ç°ç‰¹å®šå˜æ›´çš„åç§°</div><div class="line">    #IFNAME(æ¥å£åç§°) , #FSNAME(æ–‡ä»¶ç³»ç»Ÿåç§°)</div><div class="line"># ä¸»è¦å°†æœ¬åœ°çš„ä¸€äº›ç‰¹æ®Šæ•°æ®å‘é€åˆ°æœåŠ¡ç«¯ï¼Œæ¯”å¦‚æ¥å£ç±»çš„æ•°æ®;</div><div class="line"># æ·»åŠ é’ˆå¯¹å˜ç†çš„Items:</div><div class="line"># è¿”å›å€¼ä¸ºJSON </div><div class="line"></div><div class="line">Configurations --&gt;Templates --&gt; discovery rules --&gt; create discovery rules</div><div class="line">--&gt; name if lld</div><div class="line">--&gt; Type zabbix agent </div><div class="line">--&gt; Key  net.if.[#IFNAME,bytes]</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># ç™»å½• zabbixæ•°æ®åº“æŸ¥è¯¢å¯¹åº”çš„key</div><div class="line"># use zabbix;</div><div class="line"># SELECT key_ FROM iem WHERE key_ LIKE &apos;%discovery%&apos;;</div></pre></td></tr></table></figure><h2 id="Web-ç›‘æ§"><a href="#Web-ç›‘æ§" class="headerlink" title="Web ç›‘æ§"></a>Web ç›‘æ§</h2><ul><li>Zabbix è¿˜å¯ä»¥è¿›è¡Œweb ç«™ç‚¹çš„å¯ç”¨æ€§æ£€æµ‹; </li><li>åˆ›å»ºwebç›‘æ§éœ€è¦å®šä¹‰ä¸€ä¸ªwebæ–¹æ¡ˆ(scenarios);</li><li>webæ–¹æ¡ˆåŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªHTTPè¯·æ±‚æˆ–â€æ­¥éª¤(step)â€;</li><li>æ­¥éª¤(step)çš„æ‰§è¡Œè¿‡ç¨‹æŒ‰ç…§é¢„å…ˆå®šä¹‰çš„é¡ºåºè¿›è¡Œæ‰§è¡Œ;</li><li>é€šè¿‡webç›‘æ§å¯ä»¥å®æ—¶è·å–ä»¥ä¸‹ä¿¡æ¯;</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># æ•´ä¸ªwebæ–¹æ¡ˆä¸­æ‰€æœ‰çš„æ­¥éª¤çš„å¹³å‡ä¸‹è½½é€Ÿåº¦;</div><div class="line"># å¤±è´¥çš„æ­¥éª¤å·;</div><div class="line"># å¤±è´¥çš„æŠ¥é”™ä¿¡æ¯;</div></pre></td></tr></table></figure><ul><li>åœ¨webæ–¹æ¡ˆçš„å…·ä½“æ­¥éª¤ä¸­ï¼Œå¯ä»¥æŒ‰éœ€è¦ä½¿ç”¨å¦‚ä¸‹ä¿¡æ¯</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># è¯¥æ­¥éª¤çš„ä¸‹è½½é€Ÿåº¦;</div><div class="line"># å›åº”æ—¶é—´;</div><div class="line"># å›åº”çŠ¶æ€ç ;</div></pre></td></tr></table></figure><ul><li>Zabbixä¹Ÿå¯ä»¥æ£€æµ‹è·å–åˆ°HTMLé¡µé¢ä¸­æ˜¯å¦åŒ…å«é¢„è®¾çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥å®ç°ç™»å½•å’Œé¡µé¢ç‚¹å‡»;</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># é¦–å…ˆéœ€è¦å®šæ„ä¸€ä¸ªapplication</div><div class="line"># Configuration --&gt; Hosts --&gt; Web</div><div class="line">    --&gt; Scenario Zabbix server</div><div class="line">    --&gt; google charme</div><div class="line">--&gt; Steps</div><div class="line">    --&gt; zabbix home </div><div class="line">    --&gt; http://172.16.55.123/index.html</div><div class="line">    --&gt; Require status code 200</div></pre></td></tr></table></figure><p>zabbixçš„ç›‘æ§æ–¹å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># zabbix-web æ‰€èƒ½å¤Ÿæ˜¾ç¤ºçš„ä¸”å¯æŒ‡å®šä¸ºç›‘æ§æ¥å£ç±»å‹çš„ç›‘æ§æ–¹å¼:</div><div class="line">Agent: passive active</div><div class="line">SNMP: Simple Network Management Protocol</div><div class="line">IPMI:</div><div class="line">    æ™ºæ…§å¹³å°ç®¡ç†æ¥å£ï¼ˆInterlligent-Platform Management Interfaceï¼‰åŸæœ¬æ˜¯ä¸€ç§Interæ¶æ„çš„ä¼ä¸šç³»ç»Ÿçš„å‘¨è¾¹</div><div class="line">    è®¾å¤‡æ‰€é‡‡ç”¨çš„ä¸€ç§å·¥ä¸šæ ‡å‡†;</div><div class="line">    IPMIäº¦æ˜¯ä¸€å¼€æ”¾çš„å…è´¹æ ‡å‡†ï¼Œä½¿ç”¨è€…æ— éœ€æ”¯ä»˜é¢å¤–çš„è´¹å³å¯ä½¿ç”¨æ­¤æ ‡å‡†;</div><div class="line">JMX: Java Manaement Extensions, ç”¨äºé€šè¿‡Javaè‡ªå·±çš„æ¥å£å¯¹javaç¨‹åºè¿›è¡Œç›‘æ§;</div><div class="line">zabbix-java-getwayç”¨äºè·å–ç›‘æ§æ•°æ®:</div></pre></td></tr></table></figure><p>SNMP ç›‘æ§æ–¹å¼ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># æ“ä½œ: Get, NetNext, Set , Resonse, Trap</div><div class="line">MIB: æ˜¯è¢« ç®¡ç†å¯¹è±¡çš„é›†åˆï¼Œè€Œä¸”è¿˜é¢å¤–å®šä¹‰äº†è¢«ç®¡ç†å¯¹è±¡çš„åç§°ã€è®¿é—®æƒé™ã€æ•°æ®ç±»å‹ç­‰å±æ€§;</div><div class="line">MIBè§†å›¾: MIBçš„å­é›†;</div><div class="line">æˆæƒ:å°†MIBè§†å›¾ä¸Communityç»‘å®šæ¥å®ç°;</div><div class="line">OID: Object ID 1.3.5.1.2.1</div><div class="line">    1: system </div><div class="line">    2: interface</div><div class="line">    4:ip </div><div class="line">    6: tcp </div><div class="line">    7: udp</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># yum -y install net-snmp  net-snmp-libs net-snmp-utils</div><div class="line"># vim /etc/snmp/snmpd.conf </div><div class="line">com2sec notConfigUser default public </div><div class="line">group notConfigGroup v1 notConfigUser </div><div class="line">group notConfigGroup v2c notConfigUser </div><div class="line"></div><div class="line">view  systemview include .1.3.6.1.2.1 </div><div class="line">view systemview include .1.3.6.1.2.1.25.1.1</div><div class="line"></div><div class="line">access notConfigGroup &quot;&quot; any noauth exact systemview none none</div><div class="line"># service smpd start </div><div class="line"># ç¡®å®šudp çš„161ç«¯å£å·²ç»å¯ç”¨;</div><div class="line"># æ­¤æ—¶å¯ä»¥ä½¿ç”¨icmpæ¥æ”¶é›†æ•°æ®äº†;</div></pre></td></tr></table></figure><p>JMXç›‘æ§æ–¹å¼:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(1) å®‰è£…zabbix-java-gateway:</div><div class="line">    é…ç½®æ–‡ä»¶: /etc/zabbix/zabbix_java_gateway.conf</div><div class="line">    Listen_IP = </div><div class="line">    Listen_PORT = 10052</div><div class="line"></div><div class="line">    zabbix serverçš„é…ç½®æ–‡ä»¶ /etc/zabbix/zabbix_server.conf</div><div class="line">        JavaGateWay=</div><div class="line">        JavaGateWayPort= 10052</div><div class="line">        </div><div class="line">    (2) Javaåº”ç”¨ç¨‹åºå¼€æˆ·JMXæ¥å£:</div><div class="line">        java -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port =10053 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremoe.ssl=false</div><div class="line"></div><div class="line">ç›‘æ§Tomcat</div><div class="line">        export CATALINA_OPTS=&quot;$CATALINA_OPTS -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port =10053 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremoe.ssl=false&quot;</div></pre></td></tr></table></figure><h2 id="zabbix-åˆ†å¸ƒå¼ç›‘æ§æ¦‚è¿°"><a href="#zabbix-åˆ†å¸ƒå¼ç›‘æ§æ¦‚è¿°" class="headerlink" title="zabbix åˆ†å¸ƒå¼ç›‘æ§æ¦‚è¿°"></a>zabbix åˆ†å¸ƒå¼ç›‘æ§æ¦‚è¿°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># Zabbixèƒ½é«˜æ•ˆåœ°ç›‘æ§åˆ†å¸ƒå¼ITæ¶æ„;</div><div class="line"># åœ¨å¤§å‹ç¯å¢ƒä¸­Zabbixæä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆ;</div><div class="line">    1ã€ä½¿ç”¨ä»£ç†(proxy);</div><div class="line">    2ã€ä½¿ç”¨èŠ‚ç‚¹(node);</div><div class="line"># ä»£ç†(proxy)ç”¨äºæœ¬åŒºåŸŸæ•°æ®æ”¶é›†ï¼Œå¹¶å°†æ•°æ®å‘é€ç»™server;</div><div class="line"># èŠ‚ç‚¹(node) æä¾›å®Œæ•´çš„Zabbix serverç”¨ä»¥å»ºç«‹åˆ†å¸ƒå¼ç›‘æ§ä¸­çš„å±‚çº§;</div><div class="line"># Server-Node-Clientç‰¹æ€§;</div><div class="line">    è§£å†³hostè¿‡å¤šæ—¶å•å°Serveré¢ä¸´æ€§èƒ½ç“¶é¢ˆçš„é—®é¢˜;</div><div class="line">        ä½¿ç”¨å¤šä¸ªinstance;</div><div class="line">        æ¯ä¸ªinstanceæ˜¯ç‹¬ç«‹çš„ä¸€å¥—zabbixï¼Œæœ‰databaseå’ŒFrontend(optional);</div><div class="line">    æ”¯æŒçƒ­æ’æ‹”ï¼ŒNodeå’ŒServerçš„è¿æ¥å¯ä»¥éšæ—¶æ–­å¼€ï¼Œä½†ä¸å½±å“Nodeçš„æ­£å¸¸è¿è¡Œ;</div><div class="line">    Nodeå®šæ—¶ç»™Serverå‘é€configuration, history,event;</div><div class="line">    Serverå®šæ—¶ç»™Nodeå‘é€configurations</div><div class="line">    æ‰€æœ‰é…ç½®å˜æ›´åªèƒ½åœ¨NodeèŠ‚ç‚¹æ“ä½œï¼Œä¸èƒ½å†Serveræ“ä½œ;</div><div class="line">    æ”¯æŒæ ‘çŠ¶ç»“æ„ï¼ŒNodeåˆå¯ä»¥æ˜¯å¤šä¸ªServer;</div><div class="line"># Proxy vs Node</div><div class="line">        Nodeæœ¬èº«æ˜¯ä¸€å°server,å®ƒæœ‰å®Œæ•´çš„webé¡µé¢ï¼Œå®Œæ•´çš„æ•°æ®åº“ï¼Œå®ƒå°†æ•°æ®æºæºä¸æ–­ä¼ é€ç»™Master;</div><div class="line">        Poxyæ˜¯åªæœ‰ä¸€ä¸ªproxyçš„daemonè¿›ç¨‹ï¼Œproxyä¹Ÿæœ‰è‡ªå·±çš„æ•°æ®åº“ï¼Œä½†å®ƒçš„æ•°æ®åº“åªä¼šä¿å­˜ä¸€å®šæ—¶é—´çš„æ•°æ®;</div><div class="line">        å®ƒä¸Masteré€šä¿¡æ˜¯å°†ä¸€æ‰¹ä¿¡æ¯æ‰“åŒ…åå‘é€åˆ°Masterï¼Œ Masterå°†è¿™äº›æ•°æ®mergeå…¥Materæ•°æ®åº“;</div><div class="line"># Master-Proxy ç›¸æ¯”Master-Nodeçš„ä¼˜ç‚¹æœ‰ä»¥ä¸‹</div><div class="line">        Proxyå‹åŠ›å°ï¼Œæ•°æ®åº“åªå­˜å‚¨ä¸€å®šæ—¶é—´æ•°æ®;</div><div class="line">        Masterå‹åŠ›å˜å°ï¼Œæ•°æ®ä¸æ˜¯æºæºä¸æ–­è·å–ï¼Œå‡å°IOå‹åŠ›;</div><div class="line">        æ¶æ„æ›´æ¸…æ™°ï¼Œæ˜“ç»´æŠ¤ï¼›</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># zabbix-proxy ä¹Ÿéœ€è¦è¢«ç›‘æ§</div><div class="line"># yum -y install zabbix-proxy zabbix-proxy-mysql zabbix zabbix-agent</div><div class="line"># mysql </div><div class="line">CREATE DATABASE zabbix_proxy CHARACTER SET utf8;</div><div class="line">GRANT ALL ON zabbix_proxy.* TO zbxuser@&apos;172.16.%.%&apos; IDENTIFIED BY &apos;xxxxxx&apos;;</div><div class="line">FLUSH PREVILEGES; </div><div class="line"># vim /etc/zabbix/zabbix_proxy.conf</div><div class="line">Server=172.16.55.123</div><div class="line">Hostname=test.xxxx.com</div><div class="line">DBHost=172.16.55.123</div><div class="line">DBName=zabbix_proxy</div><div class="line">DBUser=zbxuser</div><div class="line">DBPassword=xxxxxx</div><div class="line">ConfigFrequency=600  #å¤šä¹…å‘æœåŠ¡å™¨ç«¯æ‹‰å–ä¸€æ¬¡æ•°æ®</div><div class="line"># server zabbix-proxy start</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Administration --&gt; Proxies </div><div class="line">Proxy name test.xxxx.com</div><div class="line">Proxy mode Active</div><div class="line">Hosts Proxy hosts</div><div class="line"># å†æ·»åŠ è¢«ç›‘æ§æœåŠ¡å™¨æ—¶å¯ä»¥åœ¨åˆ›å»ºä¸»æœºæ—¶å¯ä»¥æŒ‡æ˜Monitored by proxy</div></pre></td></tr></table></figure><p>zabbix databaseéœ€è¦ç”¨åˆ°çš„ç©ºé—´:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">60000/60 = 1000æ¡ </div><div class="line">å†å²æ•°æ®=å¤©æ•°xæ¯ç§’é’Ÿå¤„ç†çš„æ•°æ®æ˜¯x24x3600x50Bytes</div><div class="line">    90x1000x8600x50Bytes</div><div class="line">è¶‹åŠ¿æ•°æ®:</div><div class="line">    æ¯ä¸€ä¸ªè¶‹åŠ¿æ•°æ®128Bytes,</div><div class="line">        å¤§å°=å¤©æ•°xç›‘æ§é¡¹x24x128Bytes</div><div class="line">äº‹ä»¶æ•°æ®:</div><div class="line">    æ¯ä¸ªå æ®130Bytes</div><div class="line">        å¤§å°:å¤©æ•°x86400x130</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>è¿è¡Œä¸€ä¸ªç®€å•çš„Fabricç½‘ç»œ</title>
      <link href="/2018/03/21/%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Fabric%E7%BD%91%E7%BB%9C/"/>
      <url>/2018/03/21/%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Fabric%E7%BD%91%E7%BB%9C/</url>
      <content type="html"><![CDATA[<h1 id="è¿è¡Œä¸€ä¸ªç®€å•çš„Fabricç½‘ç»œ"><a href="#è¿è¡Œä¸€ä¸ªç®€å•çš„Fabricç½‘ç»œ" class="headerlink" title="è¿è¡Œä¸€ä¸ªç®€å•çš„Fabricç½‘ç»œ"></a>è¿è¡Œä¸€ä¸ªç®€å•çš„Fabricç½‘ç»œ</h1><p><img src="/images/fabric.png" alt=""><br>è®¾å®šä¸€ä¸ªç®€å•çš„Fabricçš„ç½‘ç»œåœºæ™¯,åŒ…æ‹¬2ä¸ªorganization,æ¯ä¸ªæœ‰2ä¸ªpeer,å¹¶ä½¿ç”¨â€soloâ€ orderingæœåŠ¡;ç½‘ç»œå®ä½“æ‰€éœ€çš„åŠ å¯†ææ–™(x509è¯ä¹¦)å·²é¢„å…ˆç”Ÿæˆå¹¶æ”¾åˆ°ç›¸åº”ç›®å½•å’Œé…ç½®æ–‡ä»¶é‡Œäº†ã€‚æ— éœ€ä¿®æ”¹è¿™äº›é…ç½®; example/e2e_cliæ–‡ä»¶å¤¹é‡ŒåŒ…å«äº†docker-composeæ–‡ä»¶å’Œè¦ç”¨æ¥åˆ›å»ºå’Œæµ‹è¯•çš„ç½‘ç»œçš„è„šæœ¬æ–‡ä»¶;  </p><p>å¦å¤–å¦‚ä½•ä½¿ç”¨é…ç½®ç”Ÿæˆå·¥å…·configtxgenç”Ÿæˆç½‘ç»œé…ç½®;  </p><h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p>å®Œæˆä»¥ä¸‹å®‰è£…Fabricæºç å’Œç¼–è¯‘configtxgenå·¥å…·: </p><ul><li>å®Œæˆç¯å¢ƒï¼Œå¹¶è®¾ç½®æ­£ç¡®çš„$GOPATHç¯å¢ƒå˜é‡;  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">åœ¨/etc/profile/go.sh ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹</div><div class="line">export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/srv/jdk1.8.0_66/bin:/root/bin:/usr/local/go/bin</div><div class="line">export GOPATH=/opt/gopath</div><div class="line">chmod +x /etc/profile/go.sh   &amp;&amp; source /etc/profile/go.sh</div></pre></td></tr></table></figure><ul><li>æ¥å–Fabricæºç ;  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># git clone https://github.com/hyperledger/fabric.git</div></pre></td></tr></table></figure><blockquote><p>å¦‚æœè¿è¡Œåœ¨linuxï¼Œåœ¨Fabricç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd $GOPATH/src/github.com/hyperledger/fabric</span></div><div class="line"><span class="comment"># make configtxgen </span></div><div class="line"><span class="comment"># è¾“å‡º</span></div><div class="line">build/bin/configtxgen</div><div class="line">CGO_CFLAGS=<span class="string">" "</span> GOBIN=/opt/gopath/src/github.com/hyperledger/fabric/build/bin go install -tags <span class="string">"nopkcs11"</span> -ldflags <span class="string">"-X github.com/hyperledger/fabric/common/configtx/tool/configtxgen/metadata.Version=1.0.7-snapshot-84a7e5c"</span> github.com/hyperledger/fabric/common/configtx/tool/configtxgen</div><div class="line">Binary available as build/bin/configtxgen</div></pre></td></tr></table></figure><blockquote><p>å¦‚æœè¿è¡Œåœ¨OSXï¼Œå…ˆå®‰è£…Xcode 8.0æˆ–è€…ä»¥ä¸Šç‰ˆæœ¬ï¼Œç„¶ååœ¨Fabricç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤: </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># å®‰è£… Homebrew,è‹¥macä¸Šæœ‰brewçš„å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤</div><div class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot; </div><div class="line"></div><div class="line">#æ·»åŠ   gnu-tar</div><div class="line"># brew install gnu-tar --with-default-name </div><div class="line"></div><div class="line">#æ·»åŠ  libtool</div><div class="line"># brew install libtool</div><div class="line"></div><div class="line"># ç¼–è¯‘ configtxgen </div><div class="line"># make confgitxgen</div><div class="line">build/bin/configtxgen</div><div class="line">CGO_CFLAGS=&quot; &quot; GOBIN=/Users/johndoe/work/src/github.com/hyperledger/fabric/build/bin go install -ldflags &quot;-X github.com/hyperledger/fabric/common/metadata.Version=1.0.0-snapshot-8d3275f -X github.com/hyperledger/fabric/common /metadata.BaseVersion=0.3.0 -X github.com/hyperledger/fabric/common/metadata.BaseDockerLabel=org.hyperledger.fabric&quot;       github.com/hyperledger/fabric/common/configtx/tool/configtxgen</div><div class="line">Binary available as build/bin/configtxgen``</div></pre></td></tr></table></figure><p>ç¼–è¯‘åæ‰«è¡Œæ–‡ä»¶æ”¾åœ¨Fabricç›®å½•ä¸‹çš„ build/bin/configtxgenä¸­ </p><h2 id="æ‰§è¡Œå®Œæ•´è„šæœ¬"><a href="#æ‰§è¡Œå®Œæ•´è„šæœ¬" class="headerlink" title="æ‰§è¡Œå®Œæ•´è„šæœ¬"></a>æ‰§è¡Œå®Œæ•´è„šæœ¬</h2><p>ä¸ºäº†åŠ å¿«éƒ¨ç½²è¿‡ç¨‹ï¼ŒFabricæä¾›äº†ä¸€ä¸ªè„šæœ¬ æ¥æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡ã€‚æ‰§è¡Œè¯¥è„šæœ¬ ä¼šç”Ÿæˆé…ç½®ç»“æœã€æœ¬åœ°ç½‘ç»œã€Chaincodeæµ‹è¯•;   </p><p>è¿›å…¥ <code>examples/e2e_cli</code>ç›®å½•ï¼Œé¦–å…ˆä»Dcoker Hubæ‘˜å–é•œåƒ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># æ‰§è¡Œè„šæœ¬</div><div class="line">#  bash ./download-dockerimages.sh</div></pre></td></tr></table></figure><p>è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹è€—æ—¶ä¼šæ¯”è¾ƒé•¿ï¼Œè„šæœ¬æ‰§è¡Œåè¾“å‡º: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">===&gt; List out hyperledger docker images</div><div class="line">hyperledger/fabric-ca          latest               35311d8617b4        7 days ago          240 MB</div><div class="line">hyperledger/fabric-ca          x86_64-1.0.0-alpha   35311d8617b4        7 days ago          240 MB</div><div class="line">hyperledger/fabric-couchdb     latest               f3ce31e25872        7 days ago          1.51 GB</div><div class="line">hyperledger/fabric-couchdb     x86_64-1.0.0-alpha   f3ce31e25872        7 days ago          1.51 GB</div><div class="line">hyperledger/fabric-kafka       latest               589dad0b93fc        7 days ago          1.3 GB</div><div class="line">hyperledger/fabric-kafka       x86_64-1.0.0-alpha   589dad0b93fc        7 days ago          1.3 GB</div><div class="line">hyperledger/fabric-zookeeper   latest               9a51f5be29c1        7 days ago          1.31 GB</div><div class="line">hyperledger/fabric-zookeeper   x86_64-1.0.0-alpha   9a51f5be29c1        7 days ago          1.31 GB</div><div class="line">hyperledger/fabric-orderer     latest               5685fd77ab7c        7 days ago          182 MB</div><div class="line">hyperledger/fabric-orderer     x86_64-1.0.0-alpha   5685fd77ab7c        7 days ago          182 MB</div><div class="line">hyperledger/fabric-peer        latest               784c5d41ac1d        7 days ago          184 MB</div><div class="line">hyperledger/fabric-peer        x86_64-1.0.0-alpha   784c5d41ac1d        7 days ago          184 MB</div><div class="line">hyperledger/fabric-javaenv     latest               a08f85d8f0a9        7 days ago          1.42 GB</div><div class="line">hyperledger/fabric-javaenv     x86_64-1.0.0-alpha   a08f85d8f0a9        7 days ago          1.42 GB</div><div class="line">hyperledger/fabric-ccenv       latest               91792014b61f        7 days ago          1.29 GB</div><div class="line">hyperledger/fabric-ccenv       x86_64-1.0.0-alpha   91792014b61f        7 days ago          1.29 GB</div><div class="line">ç°åœ¨è¿è¡Œå®Œæ•´è„šæœ¬ï¼š</div></pre></td></tr></table></figure><p>ç°åœ¨è¿è¡Œå®Œæ•´è„šæœ¬: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash network_setup.sh up mychannel</div></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è®¾ç½® <code>channel-ID</code>å‚æ•°ï¼Œchannelåé»˜è®¤æ˜¯<code>mychannel</code>ã€‚è„šæœ¬æ‰§è¡ŒæˆåŠŸåè¾“å‡º: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">===================== Query on PEER3 on channel &apos;mychannel&apos; is successful =====================</div><div class="line"></div><div class="line">===================== All GOOD, End-2-End execution completed =====================</div></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œç½‘ç»œå¯åŠ¨è¿è¡Œå¹¶æµ‹è¯•æˆåŠŸ</p><h2 id="æ¸…ç†"><a href="#æ¸…ç†" class="headerlink" title="æ¸…ç†"></a>æ¸…ç†</h2><p>åœæ­¢ç½‘ç»œ:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># åœ¨e2e_cliç›®å½•ä¸‹ </span></div><div class="line"><span class="comment"># docker rm -f $(docker ps -aq)</span></div></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œ <code>docker images</code>å‘½ä»¤æŸ¥çœ‹Chaincodeé•œåƒï¼Œç±»ä¼¼è¾“å‡ºå¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">REPOSITORY                     TAG                  IMAGE ID            CREATED             SIZE</div><div class="line">dev-peer3-mycc-1.0             latest               13f6c8b042c6        5 minutes ago       176 MB</div><div class="line">dev-peer0-mycc-1.0             latest               e27456b2bd92        5 minutes ago       176 MB</div><div class="line">dev-peer2-mycc-1.0             latest               111098a7c98c        5 minutes ago       176 MB</div></pre></td></tr></table></figure><p>åˆ é™¤é•œåƒ:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rmi &lt;IMAGE ID&gt; &lt;IMAGE ID&gt; &lt;IMAGE ID&gt;</div></pre></td></tr></table></figure><p>ä¾‹å¦‚:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker rmi -f 13e e122 333</div></pre></td></tr></table></figure><p>æœ€ååˆ é™¤é…ç½®ç»“æœï¼Œ åœ¨<code>crypto/orderer</code> ç›®å½•åˆ é™¤ <code>orderer.block</code>å’Œchannel.tx;   </p><h2 id="configtxgen"><a href="#configtxgen" class="headerlink" title="configtxgen"></a>configtxgen</h2><p>configtxgen å·¥å…·ç”Ÿæˆä¸¤ä¸ªå†…å®¹: Ordererçš„bootstrap blockå’ŒFabricçš„channel configuration transaction;    </p><p>roderer blockæ˜¯orderingæœåŠ¡çš„åˆ›ä¸–åŒºå—; channel transactionæ–‡ä»¶åœ¨create channelæ—¶ä¼šè¢«å¹¿æ’­ç»™orderer;   </p><p><code>configtx.yaml</code>åŒ…å«ç½‘ç»œçš„å®šä¹‰ï¼Œå¹¶ç»™å‡ºäº†ç½‘ç»œç»„ä»¶çš„æ‹“æ‰‘ç»“æ„-2ä¸ªæˆå‘˜(Org0å’ŒOrg1)åˆ†åˆ«ç®¡ç†ç»´æŠ¤2ä¸ªpeerã€‚ è¿˜æŒ‡å‡ºæ¯ä¸ªç½‘ç»œå®ä½“çš„åŠ å¯†ææ–™çš„å­˜å‚¨ä½ç½®ã€‚<code>crypto</code>ç›®å½•åŒ…å«æ¯ä¸ªå®ä½“çš„adminè¯ä¹¦ã€caè¯ä¹¦ã€ç­¾åè¯ä¹¦å’Œç§é’¥;  </p><p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå®˜æ–¹æä¾›äº†ä¸€ä¸ªè„šæœ¬ <code>generateCfgTrx.sh</code>,è¯¥è„šæœ¬æ•´åˆäº†<code>configtxgen</code>çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ‰§è¡Œåä¼šç”Ÿæˆä¸¤ä¸ªé…ç½®ç»“æœ:<code>orderer.block</code>å’Œ<code>channel.tx</code>ã€‚å¦‚æœè¿è¡Œè¿‡ä¸Šè¾¹<code>network_setup.sh</code>åˆ™è¿™ä¸¤ä¸ªé…ç½®ç»“æœå·²ç”Ÿæˆï¼Œè¦å…ˆåˆ°<code>crypto/orderere</code>ç›®å½•å°†ä¹‹åˆ é™¤;  </p><h2 id="æ‰§è¡ŒgenerateCfgTrx-shè„šæœ¬"><a href="#æ‰§è¡ŒgenerateCfgTrx-shè„šæœ¬" class="headerlink" title="æ‰§è¡ŒgenerateCfgTrx.shè„šæœ¬"></a>æ‰§è¡Œ<code>generateCfgTrx.sh</code>è„šæœ¬</h2><p>åœ¨<code>e2e_cli</code>ç›®å½•ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># cd $GOPATH/src/github.com/hyperledger/fabric/examples/e2e_cli</div></pre></td></tr></table></figure><p><code>generateCfgTrx.sh</code>è„šæœ¬æœ‰ä¸ªå¯é€‰èƒ½æ•°channel-ID,å¦‚æœä¸è®¾æ­¤å‚æ•°ï¼Œåˆ™é»˜è®¤ä¸ºmychannelï¼›  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># &lt;channel-ID&gt;å‚æ•°æ˜¯è¦å¯é€‰çš„</div><div class="line"># bash generateCfgTrx.sh &lt;channel-ID&gt;</div></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸåè¾“å‡º:   </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">2017/02/28 17:01:52 Generating new channel configtx</div><div class="line">2017/02/28 17:01:52 Creating no-op MSP instance</div><div class="line">2017/02/28 17:01:52 Obtaining default signing identity</div><div class="line">2017/02/28 17:01:52 Creating no-op signing identity instance</div><div class="line">2017/02/28 17:01:52 Serializing identity</div><div class="line">2017/02/28 17:01:52 signing message</div><div class="line">2017/02/28 17:01:52 signing message</div><div class="line">2017/02/28 17:01:52 Writing new channel tx</div></pre></td></tr></table></figure><p>ç”Ÿæˆçš„<code>orderer.block</code>å’Œ<code>channel.tx</code>ä¸¤ä¸ªæ–‡ä»¶å­˜æ”¾åœ¨<code>corypto/orderer</code>ç›®å½•;  </p><p><code>orderer.block</code>æ˜¯orderingæœåŠ¡çš„åˆ›ä¸–åŒºå—ï¼Œ<code>channel.tx</code>åŒ…å«æ–°channelçš„é…ç½®ä¿¡æ¯ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™ä¿©æ–‡ä»¶ éƒ½æ¥è‡ªconfigtx.yamlåŠå…¶æ‰€åŒ…å«çš„åŠ å¯†ææ–™å’Œç½‘ç»œä¿¡æ¯çš„æ•°æ®;   </p><p>æ³¨: ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬<code>generateCfgTrx.sh</code>é‡Œçš„å‘½ä»¤ã€‚å¦‚æœå‚…è¿™ç§æ–¹å¼ï¼Œåˆ™å¿…éœ€å…ˆç”¨<code>e2e_cli</code>ç›®å½•ä¸‹çš„<code>configtx.yaml</code>æ›¿æ¢Fabric sampleconfgiç›®å½•ä¸‹é»˜è®¤çš„<code>configtx.yaml</code>ï¼Œç„¶åè¿”å›fabricç›®å½•æ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œå‰ææ˜¯åˆ é™¤ä¹‹å‰çš„<code>generateCfgTrx.sh</code>ç”Ÿæˆçš„ä¸¤ä¸ªæ–‡ä»¶;    </p><h2 id="å¯åŠ¨ç½‘ç»œ"><a href="#å¯åŠ¨ç½‘ç»œ" class="headerlink" title="å¯åŠ¨ç½‘ç»œ"></a>å¯åŠ¨ç½‘ç»œ</h2><p>ä½¿ç”¨docker-composeå¯åŠ¨ç½‘ç»œï¼Œå¦‚æœè¿˜æ²¡æœ‰æ‘˜å– Fabricé•œåƒï¼Œåˆ™è¿”å›ä¹‹å‰çš„æ“ä½œå»æ‹‰å–é•œåƒ;  </p><p>è„šæœ¬<code>scrpit.sh</code>åµŒå…¥åˆ°docker-composeæ–‡ä»¶é‡Œï¼Œè¯¥è„šæœ¬å°†peeråŠ å…¥åˆ°channelå¹¶å‘peerå‘é€read/writeè¯·æ±‚ï¼Œå¦‚æ­¤ä¾¿å¯è‡ªåŠ¨æ‰§è¡Œäº¤æ˜“æµç¨‹ã€‚å¦‚æœè¿˜ä¸æƒ³ä½¿ç”¨è¿™ä¸ªè„šæœ¬è‡ªåŠ¨æ‰§è¡Œäº¤æ˜“ï¼Œå¯ä»¥è·³åˆ°ä¸‹é¢â€æ‰‹åŠ¨æ‰§è¡Œäº¤æ˜“â€ä¸€èŠ‚;    </p><p>åœ¨<code>e2e_cli</code>ç›®å½•ä¸‹ä½¿ç”¨docker-composeç”Ÿæˆç½‘ç»œå®ä½“å¹¶æ‰§è¡ŒåµŒå…¥çš„è„šæœ¬:    </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CHANNEL_NAME=&lt;channel-id&gt; docker-compose up -d</div></pre></td></tr></table></figure><p>å¦‚æœä¹‹å‰åˆ›å»ºäº†ä¸ªchannelåï¼Œå°±å¿…é¡»å°†å…¶ä½œä¸ºå‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„mychannelã€‚ä¾‹å¦‚:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CHANNEL_NAME=mychannel dcoker -comopse up -d</div></pre></td></tr></table></figure><p>ç­‰å¾…ä¸€ä¼šå„¿ï¼Œå› ä¸ºèƒŒåæœ‰äº¤æ˜“ä¼šå‘é€åˆ°peerã€‚æ‰§è¡Œ<code>docker ps</code>æŸ¥çœ‹è¿è¡ŒçŠ¶æ€çš„containerï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">vagrant@hyperledger-devenv:v0.3.0-4eec836:/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli$ docker ps</div><div class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED              STATUS              PORTS                                              NAMES</div><div class="line">45e3e114f7a2        dev-peer3-mycc-1.0           &quot;chaincode -peer.a...&quot;   4 seconds ago        Up 4 seconds                                                           dev-peer3-mycc-1.0</div><div class="line">5970f740ad2b        dev-peer0-mycc-1.0           &quot;chaincode -peer.a...&quot;   24 seconds ago       Up 23 seconds                                                          dev-peer0-mycc-1.0</div><div class="line">b84808d66e99        dev-peer2-mycc-1.0           &quot;chaincode -peer.a...&quot;   48 seconds ago       Up 47 seconds                                                          dev-peer2-mycc-1.0</div><div class="line">16d7d94c8773        hyperledger/fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:10051-&gt;7051/tcp, 0.0.0.0:10053-&gt;7053/tcp   peer3</div><div class="line">3561a99e35e6        hyperledger/fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:9051-&gt;7051/tcp, 0.0.0.0:9053-&gt;7053/tcp     peer2</div><div class="line">0baad3047d92        hyperledger/fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:8051-&gt;7051/tcp, 0.0.0.0:8053-&gt;7053/tcp     peer1</div><div class="line">1216896b7b4f        hyperledger/fabric-peer      &quot;peer node start -...&quot;   About a minute ago   Up About a minute   0.0.0.0:7051-&gt;7051/tcp, 0.0.0.0:7053-&gt;7053/tcp     peer0</div><div class="line">155ff8747b4d        hyperledger/fabric-orderer   &quot;orderer&quot;                About a minute ago   Up About a minute   0.0.0.0:7050-&gt;7050/tcp                             orderer</div></pre></td></tr></table></figure><h2 id="èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"><a href="#èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"></a>èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h2><ul><li><p>åœ¨CLIå®¹å™¨ä¸­æ‰§è¡Œäº†è„šæœ¬<code>script.sh</code>ã€‚è¯¥è„šæœ¬ç”¨é»˜è®¤çš„<code>mychannel</code>æ‰§è¡Œ<code>createChannel</code>å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤ç”¨åˆ°äº†ä¹‹å‰<code>configtxgen</code>å·¥å…·ç”Ÿæˆçš„<code>channel.tx</code>ã€‚   </p></li><li><p><code>createChannel</code>æ‰§è¡Œåä¼šç”Ÿæˆä¸€ä¸ªåˆ›ä¸–åŒºå—<code>mychannel.block</code>å¹¶ä¿å­˜åˆ°å½“å‰ç›®å½• ;   </p></li><li><p>å¯¹4ä¸ªpeeråˆ†åˆ«æ‰§è¡Œ<code>joinChannel</code>å‘½ä»¤ï¼Œé€šè¿‡åˆå§‹åŒºå—<code>mychannel.block</code>åŠ å…¥channelã€‚ è‡³æ­¤æœ‰ä¸€ä¸ªchannelåŒ…å«4ä¸ªpeerå’Œ2ä¸ªorganzationï¼›  </p></li><li><p><code>PER0</code>å’Œ<code>PEER1</code>å±äºOrg0, <code>PEER2</code>å’Œ    <code>PEER3</code>å±äºOrg1ã€‚è¿™äº›å…³ç³»çš„å®šä¹‰éƒ½åœ¨<code>confiigtx.yaml</code>ä¸­   </p></li><li><p>Chaincode<code>chaincode_example02</code>è¢« installåˆ°<code>PEER0</code>å’Œ<code>PEER2</code></p></li><li><p>ç„¶åChaincodeåœ¨<code>PEER2</code>ä¸Šinstantiateã€‚å®ä¾‹åŒ–æ˜¯æŒ‡å¯åŠ¨å®¹å™¨å’Œåˆå§‹åŒ–ä¸Chaincodeç›¸å…³çš„é”®å€¼å¯¹ï¼Œæœ¬ä¾‹ä¸­çš„åˆå§‹å€¼ æ˜¯<code>[&quot;a&quot;,&quot;100&quot; &quot;b&quot;,&quot;200&quot;]</code>ã€‚å®ä¾‹åŒ–çš„ç»“æœæ˜¯ä¸€ä¸ªåä¸º<code>dev-peer2-mycc-1.0</code>çš„å®¹å™¨å¯åŠ¨ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªå®¹å™¨ä»…æ˜¯é’ˆå¯¹<code>PEER2</code>;  </p></li><li><p>å®ä¾‹åŒ–æ—¶è¿˜ä¼šå¸¦æœ‰èƒŒä¹¦ç­–ç•¥å‚æ•°ï¼Œæœ¬ä¾‹ä¸­èƒŒä¹¦ç­–ç•¥ä¸ºâ€-Pâ€ OR(â€˜OrgOMSP.memeberâ€,Org1MSP.memberâ€™)â€,æ„æ€æ˜¯ä»»ä½•äº¤æ˜“å¿…é¡»ç”±ç»‘å®šåˆ°Org0æˆ–è€…Org1çš„peerèƒŒä¹¦;   </p></li><li><p>å¯¹äºâ€aâ€çš„queryè¯·æ±‚å‘æ…ˆç¦§å¤ªååˆ°<code>PEER0</code>ã€‚åœ¨ä¹‹å‰Chaincodeè¢«installåˆ°<code>PEER0</code>äº†ï¼Œæ‰€ä»¥å°±å¯ä»¥å¯åŠ¨ä¸€ä¸ªåä¸º<code>dev-peer0-mycc-1.0</code>çš„æ–°å®¹å™¨ï¼Œç„¶åè¿”å›æŸ¥è¯¢ç»“æœã€‚ç”±äºæ²¡æœ‰writeæ“ä½œå‘ç”Ÿï¼Œæ‰€ä»¥â€aâ€çš„å€¼ä¾ç„¶æ˜¯â€100â€ã€‚  </p></li><li><p>ä»â€aâ€è½¬ç§»â€10â€ç»™â€bâ€çš„invokeè¯·æ±‚å‘é€åˆ°<code>PEER0</code></p></li><li><p>Chaincode install åˆ° <code>PEER3</code></p></li><li><p>å¯¹â€aâ€çš„query è¯·æ±‚å‘å…³åˆ°<code>PEER3</code>ã€‚ è¿™å¯åŠ¨äº†ç¬¬ä¸‰ä¸ªåä¸º<code>dev-peer3-mycc-1.0</code>çš„å®¹å™¨ï¼Œå¹¶è¿”å›æŸ¥è¯¢ç»“æœ90ï¼Œæ­£ç¡®çš„ååº”äº†ä¹‹å‰çš„äº¤æ˜“;   </p></li></ul><p>Chaincodeå¿…é¡»è¢« installåˆ°ä¸€ä¸ªpeerä¸Šæ‰èƒ½æˆåŠŸçš„å¯¹è¿™ä¸ªpeerçš„ledgeræ‰§è¡Œread/writeæ“ä½œã€‚æ­¤å¤–ï¼Œåªæœ‰å½“åœ¨peerä¸Šé’ˆå¯¹chaincodeæ‰§è¡Œread/writeræ“ä½œæ—¶ï¼Œè¿™ä¸ªpeerä¸Šæ‰ä¼šå¯è¯¥chaincodeå®¹å™¨(æ¯”å¦‚ï¼ŒæŸ¥è¯¢â€aâ€çš„å€¼)äº¤æ˜“åˆ°å®¹å™¨å¯åŠ¨ã€‚channelä¸­çš„æ‰€æœ‰peerï¼ˆåŒ…æ‹¬é‚£ç»“æ²¡æœ‰install chaincodeçš„peerï¼Œå°±åƒä¸Šä¾‹ä¸­çš„<code>PEER3</code>ï¼‰éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªå‡†ç¡®çš„ledgerï¼ŒledgeråŒ…å«å­˜å‚¨äº†ä¸å¯å˜çš„ã€æœ‰åºçš„äº¤æ˜“è®°å½•çš„blockï¼Œè¿˜æœ‰ç»´æŠ¤current stateçš„statedbã€‚åœ¨peerä¸Šinstall chaincodeä¹‹åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥peerä¸Šçš„chaincodeäº†ï¼ˆå°±åƒä¸Šä¾‹ä¸­çš„<code>PEER3</code>ï¼‰ï¼Œå› ä¸ºä¹‹å‰å·²ç»instantiatedè¿‡äº†;    </p><p>æŸ¥çœ‹äº¤æ˜“</p><p>æŸ¥çœ‹CLIå®¹å™¨çš„log:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker logs -f cli</div></pre></td></tr></table></figure><p>è¾“å‡º: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2017-02-28 04:31:20.841 UTC [logging] InitFromViper -&gt; DEBU 001 Setting default logging level to DEBUG for command &apos;chaincode&apos;</div><div class="line">2017-02-28 04:31:20.842 UTC [msp] GetLocalMSP -&gt; DEBU 002 Returning existing local MSP</div><div class="line">2017-02-28 04:31:20.842 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 003 Obtaining default signing identity</div><div class="line">2017-02-28 04:31:20.843 UTC [msp] Sign -&gt; DEBU 004 Sign: plaintext: 0A8F050A59080322096D796368616E6E...6D7963631A0A0A0571756572790A0161</div><div class="line">2017-02-28 04:31:20.843 UTC [msp] Sign -&gt; DEBU 005 Sign: digest: 52F1A41B7B0B08CF3FC94D9D7E916AC4C01C54399E71BC81D551B97F5619AB54</div><div class="line">Query Result: 90</div><div class="line">2017-02-28 04:31:30.425 UTC [main] main -&gt; INFO 006 Exiting.....</div><div class="line">===================== Query on chaincode on PEER3 on channel &apos;mychannel&apos; is successful =====================</div><div class="line"></div><div class="line">===================== All GOOD, End-2-End execution completed =====================</div></pre></td></tr></table></figure><p>å®æ—¶æŸ¥çœ‹æ—¥å¿—æ—¶ï¼Œéœ€è¦æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯;  </p><p>é¦–å…ˆï¼Œåœæ­¢è¿è¡Œç€çš„dockerå®¹å™¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker rm -f $(docker ps -aq)</div></pre></td></tr></table></figure><p>åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯å¯åŠ¨docker-composeè„šæœ¬:  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CHANNEL_NAME=&lt;channel-id&gt; docker-compose up -d</div></pre></td></tr></table></figure><p>åœ¨ç¬¬äºŒä¸ªç»ˆç«¯æŸ¥çœ‹logï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker logs -f cli</div></pre></td></tr></table></figure><p>è¿™å°†å®æ—¶è¾“å‡ºé€šè¿‡<code>script.sh</code>æ‰§è¡Œçš„äº¤æ˜“ä¿¡æ¯;  </p><h2 id="æŸ¥çœ‹chaincodeæ—¥å¿—"><a href="#æŸ¥çœ‹chaincodeæ—¥å¿—" class="headerlink" title="æŸ¥çœ‹chaincodeæ—¥å¿—"></a>æŸ¥çœ‹chaincodeæ—¥å¿—</h2><p>å¯¹æ¯ä¸ªchaincodeå®¹å™¨å•ç‹¬æŸ¥çœ‹logï¼Œè¾“å‡º:   </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ docker logs dev-peer2-mycc-1.0</div><div class="line">04:30:45.947 [BCCSP_FACTORY] DEBU : Initialize BCCSP [SW]</div><div class="line">ex02 Init</div><div class="line">Aval = 100, Bval = 200</div><div class="line"></div><div class="line">$ docker logs dev-peer0-mycc-1.0</div><div class="line">04:31:10.569 [BCCSP_FACTORY] DEBU : Initialize BCCSP [SW]</div><div class="line">ex02 Invoke</div><div class="line">Query Response:&#123;&quot;Name&quot;:&quot;a&quot;,&quot;Amount&quot;:&quot;100&quot;&#125;</div><div class="line">ex02 Invoke</div><div class="line">Aval = 90, Bval = 210</div><div class="line"></div><div class="line">$ docker logs dev-peer3-mycc-1.0</div><div class="line">04:31:30.420 [BCCSP_FACTORY] DEBU : Initialize BCCSP [SW]</div><div class="line">ex02 Invoke</div><div class="line">Query Response:&#123;&quot;Name&quot;:&quot;a&quot;,&quot;Amount&quot;:&quot;90&quot;&#125;</div></pre></td></tr></table></figure><h2 id="æ‰‹åŠ¨æ‰§è¡Œäº¤æ˜“"><a href="#æ‰‹åŠ¨æ‰§è¡Œäº¤æ˜“" class="headerlink" title="æ‰‹åŠ¨æ‰§è¡Œäº¤æ˜“"></a>æ‰‹åŠ¨æ‰§è¡Œäº¤æ˜“</h2><p>åœæ­¢æ‰€æœ‰å®¹å™¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker rm -f $(docker ps -aq)</div></pre></td></tr></table></figure><p>ç„¶åï¼Œæ‰§è¡Œ<code>docker iamge</code> å‘½ä»¤æŸ¥çœ‹chaincodeé•œåƒï¼Œä¼šæœ‰ç±»ä¼¼ä»¥ä¸‹å†…å®¹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">REPOSITORY                     TAG                  IMAGE ID            CREATED             SIZE</div><div class="line">dev-peer3-mycc-1.0             latest               13f6c8b042c6        5 minutes ago       176 MB</div><div class="line">dev-peer0-mycc-1.0             latest               e27456b2bd92        5 minutes ago       176 MB</div><div class="line">dev-peer2-mycc-1.0             latest               111098a7c98c        5 minutes ago       176 MB</div></pre></td></tr></table></figure><p>åˆ é™¤è¿™äº›é•œåƒï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rmi &lt;IMAGE ID&gt; &lt;IMAGE ID&gt; &lt;IMAGE ID&gt;</div></pre></td></tr></table></figure><p>æ¯”å¦‚:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker rmi -f 12f e27 111</div></pre></td></tr></table></figure><p>ç¡®ä¿ä¹‹å‰ç”Ÿæˆçš„é…ç½®å†…å®¹è¿˜åœ¨ï¼Œå¦‚æœåˆ é™¤äº†å°±å†æ‰§è¡Œè„šæœ¬:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./generatecCfgTrx.sh&lt;channel-ID&gt;</div></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨è„šæœ¬ä¸­çš„å‘½ä»¤æ‰‹åŠ¨ç”Ÿæˆ;   </p><h2 id="ä¿®æ”¹docker-composeæ–‡ä»¶"><a href="#ä¿®æ”¹docker-composeæ–‡ä»¶" class="headerlink" title="ä¿®æ”¹docker-composeæ–‡ä»¶"></a>ä¿®æ”¹docker-composeæ–‡ä»¶</h2><p>æ‰“å¼€docker-composeæ–‡ä»¶æ³¨é‡Šæ‰æ‰§è¡Œ<code>script.sh</code>è„šæœ¬çš„å‘½ä»¤ï¼Œå¦‚ä¸‹:  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer</div><div class="line"># command: /bin/bash -c &apos;./scripts/script.sh $&#123;CHANNEL_NAME&#125;&apos;</div></pre></td></tr></table></figure><p>ä¿å­˜æ–‡ä»¶ ï¼Œé‡å¯ç½‘ç»œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># åœ¨e2e_cliç›®å½•ä¸‹æ‰§è¡Œï¼Œè®¾ç½®æ­£ç¡®çš„CHANNEL_NAME</div><div class="line">CHANNEL_NAME=&lt;channel-id&gt; docker-compose up -d</div></pre></td></tr></table></figure><p>å‘½ä»¤è¯­æ³•</p><p>å‚ç…§ <code>script.sh</code>è„šæœ¬ä¸­çš„creaeteå’Œjoinå‘½ä»¤ã€‚ä¸‹é¢çš„å‘½ä»¤åªæ˜¯é’ˆå¯¹<code>PEER0</code>çš„ï¼Œå½“å¯¹ordererå’Œpeeræ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦ä¿®æ”¹ä¸‹é¢ç»™å‡ºçš„å››ä¸ªç¯å¢ƒå˜é‡çš„å€¼;   </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># å¯¹PEER0æ‰€ç”¨çš„ç¯å¢ƒå˜é‡</div><div class="line">CORE_PEER_MSPCONFIGPATH=$GOPATH/src/github.com/hyperledger/fabric/peer/crypto/peer/peer0/localMspConfig</div><div class="line">CORE_PEER_ADDRESS=peer0:7051</div><div class="line">CORE_PEER_LOCALMSPID=&quot;Org0MSP&quot;</div><div class="line">CORE_PEER_TLS_ROOTCERT_FILE=$GOPATH/src/github.com/hyperledger/fabric/peer/crypto/peer/ peer0/localMspConfig/cacerts/peerOrg0.pem</div></pre></td></tr></table></figure><p>ç¬¬ä¸ªpeerçš„ç¯å¢ƒå˜çš„å€¼éƒ½åœ¨docker-composeæ–‡ä»¶ä¸­</p><h2 id="Create-channel"><a href="#Create-channel" class="headerlink" title="Create channel"></a>Create channel</h2><p>è¿›å»cliå®¹å™¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># docker exec -it cli bash</div></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸè¾“å‡º: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@0d78bb69300d:/opt/gopath/src/github.com/hyperledger/fabric/peer#</div></pre></td></tr></table></figure><p>ç”¨<code>-c</code>æŒ‡å®šchannel name, <code>-f</code>æŒ‡å®šchannel configruation transaction(æ­¤ä¾‹ä¸­æ˜¯<code>channel.tx</code>)å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸åŒçš„åç§°å®‰è£…configuration transaction;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># channel.tx å’Œ orderer.block åœ¨ cli å®¹å™¨çš„ crypto/orderer ç›®å½•ä¸‹</div><div class="line">peer channel create -o orderer0:7050 -c mychannel -f crypto/orderer/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem</div></pre></td></tr></table></figure><p>ç”±äºæ­¤ä¾‹çš„<code>peer channel create</code>å‘½ä»¤æ˜¯é’ˆå¯¹ordererçš„ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¹‹å‰çš„ç¯å¢ƒå˜é‡ï¼Œå› æ­¤ä¸Šè¾¹çš„å‘½ä»¤åº”è¯¥æ˜¯: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_PEER_MSPCONFIGPATH=$GOPATH/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig CORE_PEER_LOCALMSPID=&quot;OrdererMSP&quot; peer channel create -o orderer0:7050 -c mychannel -f crypto/orderer/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem</div></pre></td></tr></table></figure><p>æ³¨æ„:ä¸‹é¢çš„å…¶ä»–å‘½ä»¤ä¾ç„¶åœ¨CLIå®¹ä¸­æ‰§è¡Œï¼Œè€Œä¸”è¦è®°ä½å‘½ä»¤é‡Œæ¯ä¸ªpeerå¯¹åº”çš„ç¯å¢ƒå˜é‡;   </p><p>å°†æŒ‡å®šçš„peeråŠ å…¥åˆ°channel:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#é»˜è®¤åªå°† PEER0 åŠ å…¥ </div><div class="line">peer channel join -b mychannel.block</div></pre></td></tr></table></figure><p>å®Œæ•´çš„å‘½ä»¤åº”è¯¥æ˜¯: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CORE_PEER_MSPCONFIGPATH=$GOPATH/src/github.com/hyperledger/fabric/peer/crypto/peer/peer0/localMspConfig CORE_PEER_ADDRESS=peer0:7051 CORE_PEER_LOCALMSPID=&quot;Org0MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=$GOPATH/src/github.com/hyperledger/fabric/peer/crypto/peer/peer0/localMspConfig/cacerts/peerOrg0.pem peer channel join -b mychannel.block</div></pre></td></tr></table></figure><p>ä¿®æ”¹è¿™å››ä¸ªç¯å¢ƒå˜é‡å°†å…¶ä»–çš„peeråŠ å…¥åˆ°channelä¸­ </p><p>å°†ç¤ºä¾‹chaincodeä»£ç å®‰è£…åˆ°å››ä¸ªå¯¹ç­‰èŠ‚ç‚¹ä¸­çš„ä¸€ä¸ª:</p><p>Install chaincode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># åœ¨å‘½ä»¤å‰é¢è¦åŠ ä¸Špeerå¯¹åº”çš„å››ä¸ªç¯å¢ƒå˜é‡</div><div class="line">peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02</div></pre></td></tr></table></figure></p><p>åœ¨ä¸€ä¸ªpeerä¸Šå®ä¾‹åŒ–chaincodeï¼Œè¿™å°†å¯¹è¯¥peerå¯åŠ¨ä¸€ä¸ªchaincodeå®¹å™¨ï¼Œå¹¶ä¸ºè¯¥chaincodeè®¾ç½®èƒŒä¹¦ç­–ç•¥ã€‚æ­¤ä¾‹ä¸­å®šä¹‰çš„ç­–ç•¥æ˜¯æœ‰<code>org0</code>æˆ–<code>org1</code>ä¸­çš„ä¸€ä¸ªpeerèƒŒä¹¦å³å¯;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># åœ¨å‘½ä»¤å‰é¢è¦åŠ ä¸Špeerå¯¹åº”çš„å››ä¸ªç¯å¢ƒå˜é‡</div><div class="line"># ç”¨ -C å‚æ•°è®¾ç½®æ­£ç¡®çš„channelåï¼Œé»˜è®¤æ˜¯ mychannel</div><div class="line">peer chaincode instantiate -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&apos; -P &quot;OR (&apos;Org0MSP.member&apos;,&apos;Org1MSP.member&apos;)&quot;</div></pre></td></tr></table></figure><p>Invoke chaincode </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># åœ¨å‘½ä»¤å‰é¢è¦åŠ ä¸Špeerå¯¹åº”çš„å››ä¸ªç¯å¢ƒå˜é‡</div><div class="line">peer chaincode invoke -o orderer0:7050  --tls $CORE_PEER_TLS_ENABLED --cafile $GOPATH/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem  -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>Query chaincode </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># åœ¨å‘½ä»¤å‰é¢è¦åŠ ä¸Špeerå¯¹åº”çš„å››ä¸ªç¯å¢ƒå˜é‡</div><div class="line">peer chaincode query -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Query Result: 90</div></pre></td></tr></table></figure><h2 id="æ‰‹åŠ¨æ„å»ºé•œåƒ"><a href="#æ‰‹åŠ¨æ„å»ºé•œåƒ" class="headerlink" title="æ‰‹åŠ¨æ„å»ºé•œåƒ"></a>æ‰‹åŠ¨æ„å»ºé•œåƒ</h2><p>æ„å»ºpeerå’Œordereré•œåƒ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># åœ¨farbicç›®å½•ä¸‹æ‰§è¡Œï¼Œå¦‚æœä¸èƒ½é¡ºåˆ©ç”Ÿæˆé•œåƒï¼Œåˆ™ä½¿ç”¨vagrantç¯å¢ƒ</div><div class="line"># make peer-docker orderer-docker</div></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>docker images</code>å‘½ä»¤è¾“å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">vagrant@hyperledger-devenv:v0.3.0-4eec836:/opt/gopath/src/github.com/hyperledger/fabric$ docker images</div><div class="line">REPOSITORY                     TAG                             IMAGE ID            CREATED             SIZE</div><div class="line">hyperledger/fabric-orderer     latest                          264e45897bfb        10 minutes ago      180 MB</div><div class="line">hyperledger/fabric-orderer     x86_64-0.7.0-snapshot-a0d032b   264e45897bfb        10 minutes ago      180 MB</div><div class="line">hyperledger/fabric-peer        latest                          b3d44cff07c6        10 minutes ago      184 MB</div><div class="line">hyperledger/fabric-peer        x86_64-0.7.0-snapshot-a0d032b   b3d44cff07c6        10 minutes ago      184 MB</div><div class="line">hyperledger/fabric-javaenv     latest                          6e2a2adb998a        10 minutes ago      1.42 GB</div><div class="line">hyperledger/fabric-javaenv     x86_64-0.7.0-snapshot-a0d032b   6e2a2adb998a        10 minutes ago      1.42 GB</div><div class="line">hyperledger/fabric-ccenv       latest                          0ce0e7dc043f        12 minutes ago      1.29 GB</div><div class="line">hyperledger/fabric-ccenv       x86_64-0.7.0-snapshot-a0d032b   0ce0e7dc043f        12 minutes ago      1.29 GB</div><div class="line">hyperledger/fabric-baseimage   x86_64-0.3.0                    f4751a503f02        4 weeks ago         1.27 GB</div><div class="line">hyperledger/fabric-baseos      x86_64-0.3.0                    c3a4cf3b3350        4 weeks ago         161 MB</div></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#ä½¿ç”¨æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶"></a>ä½¿ç”¨æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶</h2><p>è¿›æ”¯vagrantç¯å¢ƒ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd $GOPATH/src/github.com/hyperledger/fabric/devenv</div><div class="line"></div><div class="line"># ç¬¬ä¸€æ¬¡å¯åŠ¨VMç”¨ vagrant up </div><div class="line">vagrant ssh</div></pre></td></tr></table></figure><p>åœ¨fabricç›®å½•ç¼–è¯‘peerå’Œorderer:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make clean</div><div class="line">make native</div></pre></td></tr></table></figure><p>ç”Ÿæˆ<code>ccenv</code>é•œåƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make peer-docker</div></pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€ä¸¤ä¸ªç»ˆç«¯éƒ½è¿›å…¥vagrantï¼Œè‡³æ­¤æœ‰ä¸‰ä¸ªç»ˆç«¯éƒ½åœ¨vagranté‡Œ;<br>é¦–å…ˆæ¸…ç©ºledgeræ–‡ä»¶<code>/var/hyperledger/</code> (æ¯æ¬¡è¿è¡Œåï¼Œä¸ºé¿å…é”™è¯¯æˆ–é‡å¤ï¼Œéƒ½è¦æ¸…ç©º): </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rm -rf /var/hyperledger/*</div></pre></td></tr></table></figure><p>ä½¿ç”¨<code>configtxgen</code>å·¥å…·åˆ›å»ºordereråˆ›ä¸–åŒºå—:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">configtxgen -profile SampleMSPSolo -outputBlock orderer.block</div></pre></td></tr></table></figure><p>ç”¨åˆšç”Ÿæˆçš„åˆ›ä¸–åŒºå—å¯åŠ¨orderer: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ORDERER_GENERAL_GENESISMETHOD=file ORDERER_GENERAL_GENESISFILE=./orderer.block orderer</div></pre></td></tr></table></figure><p>åˆ›å»º channel  configuration transaction: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">configtxgen -profile  SampleSingleMSPSolo -outputCreateChannelTx channel.tx -channelID &lt;channel-ID&gt;</div></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ<code>channel.tx</code></p><p>ä»¥<code>chanless</code>æ¨¡å—å¯åŠ¨peer: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer node start --peer-defaultchain-false</div></pre></td></tr></table></figure><p>ä»¥<code>channel.tx</code>ä¸ºå‚æ•°åˆ›å»ºchannel:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer channel create -o 127.0.0.1:7050 -c mychannel -f channel.tx</div></pre></td></tr></table></figure><p>æ‰§è¡Œååœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ªchannelçš„åˆ›ä¸–åŒºå—<code>mychannel.block</code> </p><p>Join channel<br>é€šè¿‡channelçš„åˆ›ä¸–åŒºå—<code>mychannel.block</code>åŠ å…¥channel: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer channel join -b mychannel.block</div></pre></td></tr></table></figure><p>Install chaincode<br>åœ¨peerä¸Šå®‰è£…chaincode:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode install -o 127.0.0.1:7050 -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02</div></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸåæŸ¥çœ‹æ–‡ä»¶å¯ä»¥çœ‹åˆ°mycc.1.0: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls /var/hyperledger/production/chaincodes</div></pre></td></tr></table></figure><p>Instantiate chaincode </p><p>å®ä¾‹åŒ–chaincode:  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode instantiate -o 127.0.0.1:7050 -C mychannel -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p><code>docker ps</code>æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨ï¼Œå¦‚æœchaincodeå¯åŠ¨æˆåŠŸï¼Œåˆ™æ˜¾ç¤º: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div class="line">bd9c6bda7560        dev-jdoe-mycc-1.0   &quot;chaincode -peer.a...&quot;   5 seconds ago       Up 5 seconds                            dev-jdoe-mycc-1.0</div></pre></td></tr></table></figure><p>Invoke chaincode<br>è°ƒç”¨chaincodeä»â€aâ€è½¬ç§»â€10â€ç»™â€bâ€:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode invoke -o 127.0.0.1:7050 -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>Query chaincode<br>æŸ¥è¯¢â€aâ€çš„å€¼: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># è¿”å›å€¼åº”æ˜¯ 90</div><div class="line">peer chaincode query -o 127.0.0.1:7050 -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>è¿è¡Œå®Œæˆåä¸è¦å¿˜è®°æ¸…ç©ºledgeræ–‡ä»¶å¤¹<code>/var/hyperledger</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rm -rf /var/hyperledger/*</div></pre></td></tr></table></figure><h2 id="ä½¿ç”¨CouchDB"><a href="#ä½¿ç”¨CouchDB" class="headerlink" title="ä½¿ç”¨CouchDB"></a>ä½¿ç”¨CouchDB</h2><p>å¯ä»¥å°†stateDBé»˜è®¤çš„goleveldbæ›¿æ¢æˆCouchDBã€‚å¯¹äºCouchDB, chainocdeå„åŠŸèƒ½ä¾ç„¶å¯ç”¨ï¼Œä½†å°†chaincodeæ•°æ®ä»¥JSONæ–¹å¼å­˜å‚¨çš„è¯å°±å¯ä»¥ä½¿ç”¨CouchDBçš„å¤æ‚æŸ¥è¯¢çš„åŠŸèƒ½;    </p><p>ä¸ºäº†ä½¿ç”¨CouchDBï¼Œé™¤äº†æœ€å‰é¢çš„â€å‰æâ€ä¸€èŠ‚çš„æ“ä½œå¤–ï¼Œè¿˜éœ€è¦ä¸‹è¾¹ä¸¤æ­¥å¯åŠ¨CouchDBå®¹å™¨å¹¶å°†ä¹‹ä¸peerå®¹å™¨å…³è”;   </p><ul><li>æ„å»º CouchDBé•œåƒ </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># make sure you are in the fabric directory</div><div class="line">make couchdb</div></pre></td></tr></table></figure><ul><li>ç¼–è¾‘<code>fabric/example/e2e_cli/docker-compose.yaml</code> å’Œ<code>docker-compose.yam</code> å°†æ‰€æœ‰ä¸CouchDBæœ‰å…³çš„å†…å®¹å–æ¶ˆæ³¨é‡Šã€‚è¿™æ ·  <code>chaincode_xample02</code>å°±å¯ä»¥CouchDBä¸‹è¿è¡Œäº†;   </li></ul><p>æ³¨æ„:å¦‚æœå°†CouchDBå®¹å™¨çš„ç«¯å£æ˜ å°„çš„ä¸»æœºï¼Œè¯·ä¸€å®šè¦æ³¨æ„å®‰å…¨ï¼Œåœ¨å¼€å‘ç¯å¢ƒ ä¸­å°†ç«¯æ˜ å°„å‡ºæ¥å¯ä»¥é€šè¿‡CouchDBçš„webç•Œé¢å¯è§†åŒ–æ“ä½œæ•°æ®ã€‚ç”Ÿäº§ç¯å¢ƒä¸­ä¸€èˆ¬ä¸ä¼šåšç«¯å£æ˜ å°„ï¼Œä»¥é™åˆ¶CouchDBçš„å¤–éƒ¨è®¿é—®;   </p><p>å¯ä»¥ç”¨<code>chaincode_example02</code>åœ¨CouldDBä¸‹æ‰§è¡Œä¸Šè¾¹çš„chaincodeæ“ä½œï¼Œä½†æ˜¯ä¸ºäº†ä½¿ç”¨CouchDBçš„å¤æ‚æŸ¥è¯¢åŠŸèƒ½ï¼Œchaincodeæ•°æ®ä¸€å®šè¦ä»¥JSONæ ¼å¼å­˜å‚¨(ä¾‹å¦‚ fabric/examples/chaincode/go/merbles02);   </p><p>ä½¿ç”¨<code>æ‰‹åŠ¨æ‰§è¡Œäº¤æ˜“</code>è¿™ä¸€èŠ‚ä¸­çš„æ­¥éª¤installã€instantiateã€invokeå’Œquery<code>marbles02</code>ï¼Œæ‰§è¡Œå®Œæˆ<code>join channel</code>è¿™æ­¥åä½¿ç”¨ä¸‹è¾¹çš„å‘½ä»¤æ“ä½œ<code>marbles02</code>: </p><ul><li>åœ¨<code>PEER0</code>ä¸Šå®‰è£…å®ä¾‹åŒ–chaincode</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">peer chaincode install -o orderer0:7050 -n marbles -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02</div><div class="line">peer chaincode instantiate -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;]&#125;&apos; -P &quot;OR (&apos;Org0MSP.member&apos;,&apos;Org1MSP.member&apos;)&quot;</div></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€äº›marbleå¹¶ç§»åŠ¨å®ƒä»¬</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;initMarble&quot;,&quot;marble1&quot;,&quot;blue&quot;,&quot;35&quot;,&quot;tom&quot;]&#125;&apos;</div><div class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;initMarble&quot;,&quot;marble2&quot;,&quot;red&quot;,&quot;50&quot;,&quot;tom&quot;]&#125;&apos;</div><div class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;initMarble&quot;,&quot;marble3&quot;,&quot;blue&quot;,&quot;70&quot;,&quot;tom&quot;]&#125;&apos;</div><div class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;transferMarble&quot;,&quot;marble2&quot;,&quot;jerry&quot;]&#125;&apos;</div><div class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;transferMarblesBasedOnColor&quot;,&quot;blue&quot;,&quot;jerry&quot;]&#125;&apos;</div><div class="line">peer chaincode invoke -o orderer0:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/orderer/localMspConfig/cacerts/ordererOrg0.pem -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;delete&quot;,&quot;marble1&quot;]&#125;&apos;</div></pre></td></tr></table></figure><ul><li><p>å¦‚æœåšäº†CouchDBå®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œå¯ä»¥é€šè¿‡webç•Œé¢æŸ¥çœ‹æ•°æ®ï¼Œå¯ä»¥çœ‹åˆ°åä¸º<code>mychannel</code>çš„æ•°æ®åº“åŠå…¶æ–‡æ¡£ </p></li><li><p>å¦‚æœä½¿ç”¨çš„æ˜¯vagrantç¯å¢ƒ </p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://localhost:15984/_utils</div><div class="line">* å¦‚æœä¸æ˜¯vagrantç¯å¢ƒï¼Œä½¿ç”¨CouchDBå®¹å™¨æŒ‡å®šçš„ç«¯å£</div><div class="line"></div><div class="line">http://localhost:5984/_utils</div></pre></td></tr></table></figure><ul><li>æœ‰å¯è§„å¾‹çš„æŸ¥è¯¢chaincode(ä¾‹å¦‚,è¯»å–marble2) </li></ul><p>peer chaincode query-C mychannel -n marbles -c {â€œArgsâ€:[â€œreadMarbleâ€,â€marble2â€]}â€™</p><p>å¯ä»¥çœ‹åˆ°<code>mable2</code>çš„è¯¦ç»†ä¿¡æ¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Query Result: &#123;&quot;color&quot;:&quot;red&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble2&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:50&#125;</div></pre></td></tr></table></figure><p>è·å– <code>marble1</code>çš„å†å² </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode query -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;getHistoryForMarble&quot;,&quot;marble1&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ“ä½œè¿‡<code>marbel1</code>çš„äº¤æ˜“: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Query Result: [&#123;&quot;TxId&quot;:&quot;1c3d3caf124c89f91a4c0f353723ac736c58155325f02890adebaa15e16e6464&quot;, &quot;Value&quot;:&#123;&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble1&quot;,&quot;color&quot;:&quot;blue&quot;,&quot;size&quot;:35,&quot;owner&quot;:&quot;tom&quot;&#125;&#125;,&#123;&quot;TxId&quot;:&quot;755d55c281889eaeebf405586f9e25d71d36eb3d35420af833a20a2f53a3eefd&quot;, &quot;Value&quot;:&#123;&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble1&quot;,&quot;color&quot;:&quot;blue&quot;,&quot;size&quot;:35,&quot;owner&quot;:&quot;jerry&quot;&#125;&#125;,&#123;&quot;TxId&quot;:&quot;819451032d813dde6247f85e56a89262555e04f14788ee33e28b232eef36d98f&quot;, &quot;Value&quot;:&#125;]</div></pre></td></tr></table></figure><p> è¿˜å¯ä»¥æ‰§è¡Œå¤æ‚æŸ¥è¯¢,æ¯”å–»å¦‚æŸ¥è¯¢<code>jerry</code>æ‰€æ‹¥æœ‰çš„marble:</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode query -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;queryMarblesByOwner&quot;,&quot;jerry&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœä¸º<code>jerry</code>æ‰€æ‹¥æœ‰çš„2ä¸ªmarbleçš„ä¿¡æ¯: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode query -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;queryMarblesByOwner&quot;,&quot;jerry&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœä¸º<code>jerry</code>æ‰€æ‹¥æœ‰çš„2ä¸ªmarbleçš„ä¿¡æ¯:  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Query Result: [&#123;&quot;Key&quot;:&quot;marble2&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;red&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble2&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:50&#125;&#125;,&#123;&quot;Key&quot;:&quot;marble3&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;blue&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble3&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:70&#125;&#125;]</div></pre></td></tr></table></figure><p>é€šè¿‡<code>owner</code>å­—æ®µç­‰äº<code>jerry</code>æŸ¥è¯¢:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode query -C mychannel -n marbles -c &apos;&#123;&quot;Args&quot;:[&quot;queryMarbles&quot;,&quot;&#123;\&quot;selector\&quot;:&#123;\&quot;owner\&quot;:\&quot;jerry\&quot;&#125;&#125;&quot;]&#125;&apos;</div></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Query Result: [&#123;&quot;Key&quot;:&quot;marble2&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;red&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble2&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:50&#125;&#125;,&#123;&quot;Key&quot;:&quot;marble3&quot;, &quot;Record&quot;:&#123;&quot;color&quot;:&quot;blue&quot;,&quot;docType&quot;:&quot;marble&quot;,&quot;name&quot;:&quot;marble3&quot;,&quot;owner&quot;:&quot;jerry&quot;,&quot;size&quot;:70&#125;&#125;]</div></pre></td></tr></table></figure><h2 id="æ•°æ®æŒä¹…åŒ–"><a href="#æ•°æ®æŒä¹…åŒ–" class="headerlink" title="æ•°æ®æŒä¹…åŒ–"></a>æ•°æ®æŒä¹…åŒ–</h2><p>å¦‚æœéœ€è¦å¯¹peeræˆ–CouchDBå®¹å™¨çš„æ•°æ®æŒä¹…åŒ–ï¼Œä¸€ç§æ˜¯é€‰æ‹©æ˜¯å°†å®¹å™¨çš„ç›¸å…³ç›®å½•æŒ‚è½½åˆ°dockerä¸»æœº;<br>ä¾‹å¦‚ï¼Œå°†ä¸‹é¢ä¸¤å†…å®¹å™¨å…¥åˆ°<code>docker-compose.yaml</code>æ–‡ä»¶ä¸­çš„å¯¹åº”peerå¤„:  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">volumes:</div><div class="line"> - /var/hyperledger/peer0:/var/hyperledger/production</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">volumes:</div><div class="line">- /var/hyperledger/couchdb0:/opt/couchdb/data</div></pre></td></tr></table></figure><p>æ•…éšœæ’é™¤ </p><ul><li>æ¯æ¬¡è¿è¡Œåè¦æ¸…ç†æ–‡ä»¶</li><li>å¦‚æœå‡ºç°dockeré”™è¯¯ï¼Œåˆ™åˆ é™¤é•œåƒï¼Œä»å¤´å†æ“ä½œä¸€é;  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">make clean </div><div class="line">make peer-docker orderer-docker</div></pre></td></tr></table></figure><ul><li>å¦‚æœå‡ºç°ä¸‹é¢çš„é”™è¯¯ </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error: Error endorsing chaincode: rpc error: code = 2 desc = Error installing chaincode code mycc:1.0(chaincode /var/hyperledger/production/chaincodes/mycc.1.0 exits)</div></pre></td></tr></table></figure><p>chaincodeé•œåƒ(å¦‚<code>dev-peer0-mycc-1.0</code>æˆ–<code>dev-peer1-mycc-1.0</code>)å¯èƒ½æ˜¯ä»¥å‰è¿è¡Œè¿‡çš„ï¼Œåˆ é™¤å®ƒä»¬ç„¶åé‡è¯•;  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rmi -f $(docker images | grep peer[0-9]-peer[0-9] | awk &apos;&#123;print $3&#125;&apos;)</div></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>down</code>é€‰é¡¹æ¸…ç†ç½‘ç»œ </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./network_setup.sh down </div><div class="line">Next Previous</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Hyperledger Fabric Chaincode for Operators</title>
      <link href="/2018/03/20/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/"/>
      <url>/2018/03/20/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/</url>
      <content type="html"><![CDATA[<h1 id="å®æ“æ™ºèƒ½åˆçº¦"><a href="#å®æ“æ™ºèƒ½åˆçº¦" class="headerlink" title="å®æ“æ™ºèƒ½åˆçº¦"></a>å®æ“æ™ºèƒ½åˆçº¦</h1><p><img src="/images/heyue.jpg" alt=""></p><h2 id="ä»€ä¹ˆæ˜¯Chaincode"><a href="#ä»€ä¹ˆæ˜¯Chaincode" class="headerlink" title="ä»€ä¹ˆæ˜¯Chaincode"></a>ä»€ä¹ˆæ˜¯Chaincode</h2><blockquote><p>chaincodeæ˜¯ä¸€ä¸ªç¨‹åºï¼Œå®ƒæ˜¯ä½¿ç”¨Goè¯­è¨€ç¼–å†™çš„ï¼Œæœ€ç»ˆåœ¨Javaç­‰å…¶å®ƒç¼–ç¨‹è¯­è¨€ä¸­å®ç°äº†æŒ‡å®šçš„æ¥å£ï¼›<br>chaincodeè¿è¡Œä¸€ä¸ªè¢« èƒŒä¹¦peerè¿›ç¨‹ç‹¬ç«‹å‡ºæ¥çš„å®‰å…¨çš„Dockerå®¹å™¨ä¸­;<br>chaincodeé€šè¿‡åº”ç”¨ç¨‹åºæäº¤çš„äº‹åŠ¡åˆå§‹åŒ–å’Œç®¡ç†å¸æœ¬çŠ¶æ€;   </p><p>chaincodeé€šå¸¸å¤„ç†è¢«ç½‘ç»œæˆå‘˜è®¤å¯çš„ä¸šåŠ¡é€»è¾‘;<br>å› æ­¤å®ƒè¢«è®¤ä¸ºæ˜¯ä¸€ç§â€æ™ºèƒ½åˆçº¦â€;<br>ç”±chaincodeåˆ›å»ºçš„çŠ¶æ€åªä½œç”¨äºè¯¥chaincodeï¼Œè€Œä¸èƒ½é€šè¿‡å¦ä¸€ä¸ªchaincodeç›´æ¥è®¿é—®;<br>ä½†æ˜¯ï¼Œåœ¨åŒä¸€ä¸ªç½‘ç»œä¸­ï¼Œç»™å®šé€‚å½“çš„æƒé™;<br>chaincodeå¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªchaincodeæ¥è®¿é—®å®ƒçš„çŠ¶æ€;   </p><p>é€šè¿‡åŒºå—é“¾é€šä¿¡äº§å“åº”ç”¨æ–¹æ¡ˆä¾›åº”å•†è¯ºäºšçš„è§†è§’æ¥æ¢ç´¢chaincode;<br>ä¸»è¦å…³æ³¨è¯ºäºšå¯¹chaincodeç”Ÿå‘½å‘¨æœŸçš„æ“ä½œ;<br>åœ¨åŒºå—é“¾ç½‘ç»œä¸­ï¼Œæ‰“åŒ…ï¼Œå®‰è£…ï¼Œå®ä¾‹åŒ–å’Œå‡çº§chaincodeçš„è¿‡ç¨‹;<br>æ˜¯chaincodeçš„æ“ä½œç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªåŠŸèƒ½;  </p></blockquote><h2 id="Packaging-åŒ…"><a href="#Packaging-åŒ…" class="headerlink" title="Packaging(åŒ…)"></a>Packaging(åŒ…)</h2><p>chaincodeåŒ…ç”±3éƒ¨åˆ†ç»„æˆ: </p><ul><li><p>chaincodeç”±chaincodeéƒ¨ç½²è§„èŒƒ(ChaincodeDeploymentSpec)æˆ–CDSå®šä¹‰ç å’Œå…¶ä»–å±æ€§(å¦‚åç§°å¦‚ç‰ˆæœ¬) å®šä¹‰äº†chaincodeåŒ…; </p></li><li><p>ä¸€ä¸ªå¯é€‰çš„å®ä¾‹åŒ–ç­–ç•¥ï¼Œä»–å¯ä»¥åœ¨ç­–ç•¥ä¸Šç”¨ç›¸åŒçš„ç­–ç•¥æ¥æè¿°;ç”¨äºä¸€æ”¯æŒå’Œåœ¨èƒŒä¹¦ç­–ç•¥ä¸­æè¿°ã€‚  </p></li><li><p>ç”±â€æ‹¥æœ‰â€chaincodeçš„å®ä½“çš„ä¸€ç»„ç­¾å;   </p></li></ul><p>è¿™äº›ç­¾åæœ‰ä»¥ä¸‹ç›®çš„: </p><ul><li>ä¸ºäº†å»ºç«‹chaincodeçš„æ‰€æœ‰æƒ; </li><li>å…è®¸å¯¹åŒ…çš„å†…å®¹è¿›è¡ŒéªŒè¯; </li><li>å…è®¸æ£€æµ‹åŒ…æ˜¯å¦ç¯¡æ”¹;  </li></ul><p>ä¸€ä¸ªchannelä¸Šçš„chaincodeå®ä¾‹åŒ–äº‹åŠ¡çš„åˆ›å»ºè€…æ˜¯é€šè¿‡chaincodeçš„å®ä¾‹åŒ–ç­–ç•¥æ¥éªŒè¯çš„;  </p><h2 id="åˆ›å»ºpackage-åŒ…"><a href="#åˆ›å»ºpackage-åŒ…" class="headerlink" title="åˆ›å»ºpackage(åŒ…)"></a>åˆ›å»ºpackage(åŒ…)</h2><blockquote><p>æ‰“åŒ…chaincodeæœ‰ä¸¤ç§æ–¹æ³•ã€‚ä¸€ç§æ˜¯å½“æƒ³è¦ä¸€ä¸ªchaincodeæ‹¥æœ‰å¤šä¸ªæ‰€æœ‰è€…æ—¶ï¼Œéœ€è¦ä½¿ç”¨å¤šä¸ªèº«ä»½æ ‡è¯†ä¸ºè¯¥chaincodeç­¾å;<br>è¿™ä¸ªå·¥ä½œæµç¨‹éœ€è¦æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªå·²ç­¾åçš„chaincode(ä¸€ä¸ªç­¾ç½²çš„CDS);<br>ç„¶åé€šè¿‡åºåˆ—çš„æ–¹å¼å°†å…¶ä¼ é€’ç»™å…¶ä»–æ‰€æœ‰è€…æ¥ç­¾ç½² ;   </p><p>æ›´ç®€å•çš„å·¥ä½œæµç¨‹æ˜¯æ­£åœ¨å‘è¡Œå®‰è£…äº‹åŠ¡çš„èŠ‚ç‚¹çš„èº«ä»½ç­¾åæ—¶éƒ¨ç½²å·²éƒ¨ç½²çš„CDS;<br>é¦–å…ˆå°†å¤„ç†æ›´å¤æ‚çš„æƒ…å†µï¼Œä½†æ˜¯ï¼Œå¦‚æœä¸éœ€è¦æ‹…å¿ƒå¤šä¸ªæ‰€æœ‰è€…;  é‚£ä¹ˆå¯ä»¥è·³è¿‡ä¸‹åœ¨çš„å®‰è£…chaincodeéƒ¨åˆ†;  </p><p>è¦åˆ›å»ºä¸€ä¸ªå·²ç­¾åçš„chaincodeåŒ…ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤: </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@6edc4e6c7b9c:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode package -n mycc -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -v 0 -s -S -i &quot;AND(&apos;OrgA.admin&apos;)&quot; ccpack.out</div><div class="line">2018-03-20 06:28:29.298 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing local MSP</div><div class="line">2018-03-20 06:28:29.299 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</div><div class="line">2018-03-20 06:28:29.299 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default escc</div><div class="line">2018-03-20 06:28:29.299 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 004 Using default vscc</div><div class="line">2018-03-20 06:28:29.526 UTC [golang-platform] getCodeFromFS -&gt; DEBU 005 getCodeFromFS github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02</div><div class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 006 Discarding GOROOT package fmt</div><div class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 007 Discarding provided package github.com/hyperledger/fabric/core/chaincode/shim</div><div class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 008 Discarding provided package github.com/hyperledger/fabric/protos/peer</div><div class="line">2018-03-20 06:28:29.965 UTC [golang-platform] func1 -&gt; DEBU 009 Discarding GOROOT package strconv</div><div class="line">2018-03-20 06:28:29.965 UTC [golang-platform] GetDeploymentPayload -&gt; DEBU 00a done</div><div class="line">2018-03-20 06:28:29.968 UTC [msp/identity] Sign -&gt; DEBU 00b Sign: plaintext: 0A58080112520A476769746875622E63...0A2D2D2D2D2D454E44202D2D2D2D2D0A </div><div class="line">2018-03-20 06:28:29.968 UTC [msp/identity] Sign -&gt; DEBU 00c Sign: digest: 8A854844B0721EB24D348CC38C19A3D5E182CBE46FDFFE8CB9ECA7C44406F720 </div><div class="line">2018-03-20 06:28:29.969 UTC [chaincodeCmd] chaincodePackage -&gt; DEBU 00d Packaged chaincode into deployment spec of size &lt;3409&gt;, with args = [ccpack.out]</div></pre></td></tr></table></figure><p>-s å‚æ•°æ˜¯æŒ‡å¯ä»¥åˆ›å»ºä¸€ä¸ªç”±å¤šä¸ªæ‰€æœ‰ç­¾ç½²çš„åŒ…ï¼Œè€Œä¸æ˜¯ç®€å•åœ°åˆ›å»ºä¸€ä¸ªæœªå¤„ç†/ä¿®é¥°è¿‡çš„CDSï¼›<br>å½“æŒ‡å®šäº†-sæ—¶ï¼Œå¦‚æœå…¶ä»–æ‰€æœ‰è€…éœ€è¦ç­¾åï¼Œä¹Ÿå¿…éœ€è¦æŒ‡å®š-så‚æ•°; å¦åˆ™ï¼Œè¿™ä¸ªè¿›ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªé™¤äº†CDS<br>å®ä¾‹åŒ–ç­–ç•¥ä¹‹å¤–çš„å·²ç­¾ç½²CDS;  </p><p>-S å‚æ•°ä½¿ç”¨åœ¨core.yamlä¸­ç”±localMspidå±æ€§å€¼æ ‡è¯†çš„MSPæ¥æŒ‡ç¤ºè¯¥ç¨‹åºçš„ç­¾å;   </p><p>-S å‚æ•°æ˜¯å¯é€‰çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªåŒ…æ˜¯åœ¨æ²¡æœ‰ç­¾åçš„æƒ…å†µä¸‹åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½ç”±ä»»ä½•å…¶ä»–<br>æ‰€æœ‰è€…ä½¿ç”¨signpackageæ¥ç­¾ç½²; </p><p>-i å‚æ•°æ˜¯å¯é€‰çš„ï¼Œå³æŒ‡å®š chaincodeå®ä¾‹åŒ–ç­–ç•¥ã€‚å®ä¾‹åŒ–ç­–ç•¥ä¸èƒŒä¹¦ç­–ç•¥å…·æœ‰ç›¸åŒçš„æ ¼å¼ï¼›<br>å¹¶æŒ‡å®šå“ªäº›idå¯ä»¥å®ä¾‹åŒ–chaincodeã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåªå…è®¸ä½¿ç”¨OrgAçš„adminå®ä¾‹åŒ–é“¾ä»£ç ;<br>å¦‚æœæ²¡æœ‰æä¾›ç­–ç•¥ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼Œè¿™å°†åªå…è®¸peerä¸­MSPçš„adminèº«ä»½æ¥å®ä¾‹åŒ–chaincodeï¼›  </p><h2 id="åŒ…ç­¾å-Package-signing"><a href="#åŒ…ç­¾å-Package-signing" class="headerlink" title="åŒ…ç­¾å(Package signing)"></a>åŒ…ç­¾å(Package signing)</h2><p>ä¸€ä¸ªå·²ç»è¢«ç­¾åçš„chaincodeåŒ…åœ¨è¢«åˆ›å»ºæ—¶å€™å¯ä»¥äº¤ç”±å…¶å®ƒæ‰€æœ‰è€…æ£€æŸ¥å¹¶ç­¾å;<br>è¿™ä¸ªå·¥ä½œæµç¨‹æ”¯æŒchaincodeåŒ…å¸¦å¤–ç­¾ç½²;  </p><p>SignedCDSåŒ…å«äº†3ä¸ªå…ƒç´ ;  </p><ol><li>CDSåŒ…å«äº†chaincodeçš„æºç ,å³è¡¨ç¤ºèƒŒä¹¦ç­–ç•¥;  </li><li>chaincodeçš„å®ä¾‹åŒ–ç­–ç•¥ï¼Œå³è¡¨ç¤ºèƒŒä¹¦ç­–ç•¥; </li><li>chaincodeçš„æ‰€æœ‰è€…åˆ—è¡¨,ä»¥èƒŒä¹¦çš„æ–¹å¼å®šä¹‰;  </li></ol><p><code>æ³¨: å½“chaincodeåœ¨æŸäº›channelä¸Šå®ä¾‹åŒ–æ—¶ï¼Œæ­¤èƒŒä¹¦ç­–ç•¥æ˜¯ç”±å¸¦å¤–å†³å®šçš„ï¼Œä»¥æä¾›é€‚å½“çš„MSPåŸåˆ™ã€‚</code><br><code>å¦‚æœæ²¡æœ‰æŒ‡å®šå®ä¾‹åŒ–ç­–ç•¥ï¼Œåˆ™é»˜è®¤ç­–ç•¥æ˜¯channelçš„ä»»ä½•MSPçš„admin</code></p><p>æ¯ä¸ªæ‰€æœ‰éƒ½é€šè¿‡å°†å…¶ä¸æ‰€æœ‰è€…çš„èº«ä»½(ä¾‹å¦‚è¯ä¹¦) ç›¸ç»“åˆï¼Œå¹¶ç­¾ç½²ç»“åˆåçš„ç»“æœæ¥ä¸ºChaincodeDeploymentSpecèƒŒä¹¦;<br>ä¸€ä¸ªcaincodeæ‰€æœ‰è€…å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥ç­¾ç½²ä¸€ä¸ªä»¥å‰åˆ›å»ºçš„ç­¾ååŒ…: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@6edc4e6c7b9c:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode signpackage ccpack.out signedccpack.out</div><div class="line">2018-03-20 06:48:52.479 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing local MSP</div><div class="line">2018-03-20 06:48:52.479 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</div><div class="line">2018-03-20 06:48:52.479 UTC [msp/identity] Sign -&gt; DEBU 003 Sign: plaintext: 0A58080112520A476769746875622E63...0A2D2D2D2D2D454E44202D2D2D2D2D0A </div><div class="line">2018-03-20 06:48:52.479 UTC [msp/identity] Sign -&gt; DEBU 004 Sign: digest: 8A854844B0721EB24D348CC38C19A3D5E182CBE46FDFFE8CB9ECA7C44406F720 </div><div class="line">Wrote signed package to signedccpack.out successfully</div><div class="line">2018-03-20 06:48:52.480 UTC [main] main -&gt; INFO 005 Exiting.....</div></pre></td></tr></table></figure><p>ccpack.out å’Œsignedccpack.outåˆ†åˆ«æ˜¯è¾“å…¥å’Œè¾“å‡ºåŒ…ã€‚signedccpack.outåŒ…å«äº†ä½¿ç”¨çš„åŒ…é™„åŠ ç­¾å;  </p><h2 id="å®‰è£…chaincode"><a href="#å®‰è£…chaincode" class="headerlink" title="å®‰è£…chaincode"></a>å®‰è£…chaincode</h2><p>å®‰è£…äº‹åŠ¡å°†chaincodeçš„æºä»£ç æ‰“åŒ…æˆä¸€ç§æŒ‡å®šçš„æ ¼å¼ï¼Œç§°ä¸ºChaincodeDeploymentSpec(chaincodeéƒ¨ç½²è§„èŒƒæˆ–CDS);<br>å¹¶å°†å…¶å®‰è£…åˆ°è¿è¡Œè¯¥chaincodeçš„peerèŠ‚ç‚¹ä¸Š;   </p><p><code>å¿…é¡»åœ¨channelä¸­çš„æ¯ä¸ªèƒŒä¹¦èŠ‚ç‚¹ä¸Šå®‰è£…chaincodeã€‚ä»¥è¿è¡Œchaincode;</code></p><p>å½“å®‰è£…APIè¢«ç®€å•åœ°ç»™å‡ºä¸€ä¸ªChaincodeDeploymentSpecæ—¶ï¼Œå®ƒä¼šå°†é»˜è®¤å®ä¾‹åŒ–ç­–ç•¥;å¹¶åŒ…å«ä¸€ä¸ªç©ºçš„æ‰€æœ‰è€…åˆ—è¡¨;  </p><p><code>chaincodeåªåº”è¯¥å®‰è£…åœ¨chaincodeæ‹¥æœ‰çš„æˆå‘˜çš„èƒŒä¹¦pperèŠ‚ç‚¹ä¸Š; ä»¥ä¿æŠ¤ç½‘ç»œä¸­å…¶ä»–æˆå‘˜çš„chaincodeé€»è¾‘çš„æœºå¯†æ€§</code>  </p><p><code>é‚£äº›æ²¡æœ‰chaincodeçš„æˆå‘˜ï¼Œä¸èƒ½æˆä¸ºchaincodeäº¤æ˜“çš„èƒŒä¹¦äºº; ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬ä¸èƒ½æ‰§è¡Œchaincode</code></p><p><code>ä½†æ˜¯ï¼Œå®ƒä»¬ä»ç„¶å¯ä»¥éš¾å¹¶å°†äº‹åŠ¡æäº¤åˆ°è´¦æœ¬ä¸Š;</code></p><p>è¦å®‰è£…ä¸€ä¸ªchainocdeï¼Œè¯·å°†ä¸€ä¸ªç­¾ç½²çš„ææ¡ˆå‘é€åˆ°system chaincode(ç³»ç»Ÿæ™ºèƒ½åˆçº¦) å…¶ä¸­è¢«æè¿°ä¸ºç”Ÿå‘½å‘¨æœŸç³»ç»Ÿæ™ºèƒ½åˆçº¦(lifecycle system chaincode â€“LSCC) çš„éƒ¨åˆ†;<br>ä¾‹å¦‚ï¼Œè¦å®‰è£…ä½¿ç”¨CLIçš„ç®€å•èµ„äº§chaincodeä¸­æè¿°çš„saccç¤ºä¾‹chaincodeï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># peer chaincode install -n asset_mgmt -v 1.0 -p sacc</div></pre></td></tr></table></figure><p>CLIå®¹å™¨æ‰§è¡Œåˆ›å»ºçš„SignedChaincodeDeploymentSpec sacc ï¼Œå¹¶å°†å…¶å‘é€ç»™æœ¬åœ°peerï¼›<br>æœ¬åœ°peerä¼šè°ƒç”¨LSCCä¸Šçš„å®‰è£…æ–¹æ³•ã€‚å¯¹-pé€‰é¡¹çš„å‚æ•°æŒ‡å®š äº†chaincodeçš„è·¯å¾„ï¼›<br>å®ƒå¿…éœ€ä»¬ä½äºç”¨æˆ·çš„GOPATHçš„æºç æ ‘ä¸­ï¼Œä¾‹å¦‚ $GOPATH/src/sacc;<br><code>ä¸ºäº†åœ¨peerä¸Šå®‰è£…ï¼Œç­¾ç½²çš„ææ¡ˆçš„ç­¾åå¿…éœ€æ¥è‡ªpeerçš„åœ°æœ¬MSPç®¡ç†å‘˜çš„ä¸€ä¸ªç­¾å</code></p><h2 id="chaincodeå®ä¾‹åŒ–"><a href="#chaincodeå®ä¾‹åŒ–" class="headerlink" title="chaincodeå®ä¾‹åŒ–"></a>chaincodeå®ä¾‹åŒ–</h2><p>å®ä¾‹åŒ–äº‹åŠ¡è°ƒç”¨ç”Ÿå‘½å‡»æœŸç³»ç»Ÿchaincode(LSCC)æ¥åˆ›å»ºå’Œåˆå§‹åŒ–ä¸€ä¸ªchannelçš„chaincode;<br>è¿™æ˜¯ä¸€ä¸ªchaincode-chanelç»‘å®šè¿‡ç¨‹: chaincodeå¯ä»¥ç»‘å®šåˆ°ä»»æ„æ•°é‡çš„channelï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸ªchannelä¸Šç‹¬ç«‹æ“ä½œ;<br>ä¸ç®¡chaincodeå®‰è£…å’Œå®ä¾‹åŒ–äº†å¤šå°‘ä¸ªå…¶ä»–channelï¼ŒçŠ¶æ€éƒ½è¢«éš”ç¦»åˆ°ä¸€ä¸ªäº‹åŠ¡æäº¤åˆ°channelä¸Š; </p><p>å®ä¾‹åŒ–äº‹åŠ¡çš„åˆ›å»ºè€…å¿…éœ€æ»¡è¶³åœ¨SingedCDSä¸­åŒ…å«çš„chincodeçš„å®ä¾‹åŒ–ç­–ç•¥;<br>å¹¶ä¸”è¯¥åˆ›å»ºè€…ä½œä¸ºåˆ›å»ºè¯¥channelé…ç½®ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå¿…éœ€æ˜¯channelä¸Šçš„ä¸€ä¸ªå†™å…¥è€…;<br>è¿™å¯¹äºchannelçš„å®‰å…¨æ€§æ¥è¯´æ˜¯éå¸¸é‡è¦çš„ï¼Œå®ƒå¯ä»¥é˜²æ­¢æ¶æ„å®ä½“éƒ¨ç½²chaincodeæˆ–æ¬ºéª—æˆå‘˜åœ¨ä¸€ä¸ªæœªç»‘å®šçš„channelä¸Šæ‰§è¡Œchaincode; </p><p>ä¾‹å¦‚ï¼Œé»˜è®¤çš„å®ä¾‹åŒ–ç­–ç•¥æ˜¯ä»»ä½•channelçš„MSPç®¡ç†å‘˜ï¼Œå› æ­¤ä¸€ä¸ªchaincodeå®ä¾‹åŒ–äº‹åŠ¡çš„åˆ›å»ºè€…å¿…é¡»æ˜¯channelç®¡ç†å‘˜çš„æˆå‘˜;<br>å½“äº‹åŠ¡ææ¡ˆåˆ°è¾¾èƒŒä¹¦(èŠ‚ç‚¹)çš„æ—¶å€™ï¼Œå®ƒå°†éªŒè¯åˆ›å»ºè€…çš„ç­¾åä¸å®ä¾‹åŒ–ç­–ç•¥; å¹¶ä¸”åœ¨å°†å…¶æäº¤ç»™è´¦æœ¬ä¹‹å‰;<br>åœ¨äº‹åŠ¡éªŒè¯æœŸé—´å†æ¬¡æ‰§è¡Œæ­¤æ“ä½œ;   </p><p>å®ä¾‹åŒ–äº‹åŠ¡è¿˜ä¸ºchannel ä¸Šçš„chaincodeè®¾ç½®äº†èƒŒä¹¦ç­–ç•¥ã€‚èƒŒä¹¦ç­–ç•¥æè¿°äº†äº¤æ˜“ç»“æœçš„è®¤è¯éœ€æ±‚;<br>è¢«è¯¥channelçš„æ‰€æœ‰æˆå‘˜æ‰€æ¥å—;  </p><p>ä¾‹å¦‚,ä½¿ç”¨CLIå®ä¾‹åŒ–sacc chaincodeï¼Œå¹¶ä½¿ç”¨johnå’Œ0åˆå§‹åŒ–çŠ¶æ€ï¼Œå‘½ä»¤å¦‚ä¸‹: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">peer chaincode instantiate -n sacc -v 1.0 -c &apos;&#123;&quot;Args&quot;:[&quot;john&quot;,&quot;0&quot;]&#125;&apos; -P &quot;OR (&apos;Org1.member&apos;,&apos;Org2.member&apos;)&quot;</div></pre></td></tr></table></figure><p><code>ç­¾æ³¨ç­–ç•¥(CLIä½¿ç”¨æ³¢å…°è¡¨ç¤ºæ³•)ï¼Œå®ƒéœ€è¦æ¥è‡ªOrg1æˆ–Org2çš„ä»»æ„æˆå‘˜çš„æ”¯æŒ</code><br><code>ä»¥æ”¯æŒæ‰€æœ‰çš„äº‹åŠ¡åˆ°saccã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºæ˜¯Org1è¿˜æ˜¯Org2éƒ½å¿…é¡»ç­¾ç½²åœ¨saccä¸Šæ‰§è¡Œè°ƒç”¨çš„ç»“æœï¼Œä»¥ä½¿ç”¨äº‹åŠ¡æ˜¯æœ‰æ•ˆçš„</code>  </p><p>æ³¢å…°è¡¨ç¤ºæ³•(Polish notation,æˆ–æ³¢å…°è®°æ³•)ï¼Œæ˜¯ä¸€ç§é€»è¾‘ã€ç®—æœ¯å’Œä»£æ•°è¡¨ç¤ºæ–¹æ³•;<br>å…¶ç‰¹ç‚¹æ˜¯æ“ä½œç¬¦ç½®äºæ“ä½œæ•°çš„å‰é¢,å› æ­¤ä¹Ÿç§°åšå‰ç¼€è¡¨ç¤ºæ³•;<br>å¦‚æœæ“ä½œç¬¦çš„å…ƒæ•°(arity)æ˜¯å›ºå®šçš„ï¼Œåˆ™è¯­æ³•ä¸Šä¸éœ€è¦æ‹¬å·ä»ç„¶èƒ½è¢«æ— æ­§ä¹‰çš„è§£æ;<br>æ³¢å…°è®°æ³•æ˜¯æ³¢å…°æ•°å­¦å®¶æ‰¬. æ­¦å¡è°¢ç»´å¥‡1920å¹´ä»£å¼•å…¥çš„ã€‚ç”¨äºç®€åŒ–å‘½é¢˜é€»è¾‘;  </p><p>åœ¨chaincodeæˆåŠŸå®ä¾‹åŒ–ä¹‹å,chaincodeåœ¨channelä¸Šè¿›å…¥æ´»è·ƒçŠ¶æ€;<br>å¹¶å‡†å¤‡å¤„ç†ä»»ä½•èƒŒä¹¦äº‹åŠ¡ç±»æ­¦æŠ€çš„äº‹åŠ¡åè®®ã€‚ã€‚è¿™äº›äº‹åŠ¡æ˜¯å¹¶å‘å¤„ç†çš„ï¼Œå› ä¸ºå®ƒä»¬åˆ°è¾¾äº†èƒŒä¹¦peer;  </p><h2 id="chaincodeå‡çº§"><a href="#chaincodeå‡çº§" class="headerlink" title="chaincodeå‡çº§"></a>chaincodeå‡çº§</h2><p>ä»»ä½•æ—¶å€™ï¼Œchaincodeéƒ½å¯ä»¥é€šè¿‡æ›´æ”¹å…¶ç‰ˆæœ¬æ¥è¿›è¡Œå‡çº§ï¼Œè¿™æ˜¯SignedCDSçš„ä¸€éƒ¨åˆ†;<br>å…¶ä»–éƒ¨åˆ†ï¼Œä¾‹å¦‚æ‰€æœ‰è€…å’Œå®ä¾‹åŒ–ç­–ç•¥æ˜¯å¯é€‰çš„ã€‚ä½†æ˜¯ï¼Œchaincodeçš„åç§°å¿…éœ€æ˜¯ç›¸åŒçš„;<br>å¦åˆ™ï¼Œå®ƒå°†è¢«è§†ä¸ºå®Œå…¨ä¸åŒçš„chaincode;  </p><p>åœ¨å‡çº§ä¹‹å‰ï¼Œå¿…é¡»å°†chaincodeçš„æ–°ç‰ˆæœ¬å®‰è£…åœ¨éœ€è¦èƒŒä¹¦peerä¸Šï¼Œå‡çº§æ˜¯ä¸€ä¸ªç±»ä¼¼äºå®ä¾‹åŒ–äº‹åŠ¡çš„äº‹åŠ¡;<br>å®ƒå°†chaincodeçš„æ–°ç‰ˆæœ¬ç»‘å®šåˆ°channelã€‚å…¶ä»–channelæ‰€ç»‘å®šçš„æ—§ç‰ˆæœ¬chaincodeå°†ä¼šç»§ç»­è¿è¡Œæ—§ç‰ˆçš„chaincodeï¼›  </p><p>æ¢å¥è¯è¯´ï¼Œå‡çº§äº‹åŠ¡åªä¼šä¸€æ¬¡å½±å“ ä¸€ä¸ªchannelï¼Œå³æäº¤äº‹åŠ¡çš„channel;  </p><p>æ³¨æ„:ç”±äºchaincodeçš„å¤šä¸ªç‰ˆæœ¬å¯èƒ½åŒæ—¶å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ‰€ä»¥å‡çº§è¿‡ç¨‹ä¸ä¼šè‡ªåŠ¨åˆ é™¤æ—§ç‰ˆæœ¬ï¼›<br>å› æ­¤ç”¨æˆ·å¿…éœ€æš‚æ—¶ç®¡ç†è¿™ä¸ªç‰ˆæœ¬;  </p><p>ä¸å®ä¾‹åŒ–äº‹åŠ¡ä¸€ä¸ªå¾®å¦™çš„åŒºåˆ«; å‡çº§äº‹åŠ¡æ˜¯æ ¹æ®å½“å‰çš„chaincode å®ä¾‹åŒ–ç­–ç•¥æ£€æŸ¥çš„ï¼Œè€Œä¸æ˜¯æ–°ç­–ç•¥;<br>è¿™æ˜¯ä¸ºäº†ç¡®ä¿å½“å‰çš„å®ä¾‹åŒ–ç­–ç•¥ä¸­æŒ‡å®šçš„ç°æœ‰æˆå‘˜å¯ä»¥å‡çº§chaincode;  </p><p><code>åœ¨å‡çº§è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨chaincode Initå‡½æ•°æ¥æ‰§è¡Œä»»ä½•ä¸æ•°æ® ç›¸å…³çš„æ›´æ–°æˆ–é‡æ–°åˆå§‹åŒ–å®ƒ;</code><br><code>å› æ­¤åœ¨å‡çº§chaincodeæ—¶å¿…éœ€æ³¨æ„é¿å…é‡æ–°è®¾ç½®çŠ¶æ€;</code></p><h2 id="åœæ­¢å’Œå¯åŠ¨chaincode"><a href="#åœæ­¢å’Œå¯åŠ¨chaincode" class="headerlink" title="åœæ­¢å’Œå¯åŠ¨chaincode"></a>åœæ­¢å’Œå¯åŠ¨chaincode</h2><p><code>åœæ­¢å’Œå¯åŠ¨ç”Ÿå‘½å‘¨æœŸäº‹åŠ¡è¿˜æ²¡æœ‰å®ç°ã€‚ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡æ¯ä¸ªèƒŒä¹¦äººåˆ é™¤chaincodeå®¹å™¨å’ŒSignedCDSåŒ…æ¥æ‰‹åŠ¨åœæ­¢chaincode</code><br><code>è¿™æ˜¯é€šè¿‡peerèŠ‚ç‚¹è¿è¡Œçš„æ¯ä¸ªä¸»æœºæˆ–è™šæ‹Ÿæœºä¸Šåˆ é™¤chaincodeçš„å®¹å™¨æ¥å®Œæˆçš„,ç„¶åä»æ¯ä¸ªèƒŒä¹¦peerèŠ‚ç‚¹ ä¸Šåˆ é™¤SignedCDS</code> </p><p><code>TODO-ä¸ºäº†peerèŠ‚ç‚¹åˆ é™¤CDSï¼Œé¦–å…ˆéœ€è¦è¿›å…¥peerèŠ‚ç‚¹çš„å®¹å™¨ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦æä¾›ä¸€ä¸ªèƒ½å¤Ÿæ‰§è¡ŒåŠŸèƒ½çš„å®ç”¨ç¨‹åºè„šæœ¬</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#docker rm -f &lt;container id&gt;</div><div class="line">rm /var/hyperledger/production/chaincodes/&lt;ccname&gt;:&lt;ccversion&gt;</div></pre></td></tr></table></figure><p> Stopåœ¨å·¥ä½œiytkkæ˜¯æœ‰ç”¨çš„,å¯ä»¥æ§åˆ¶æ–¹å¼ä¸Šè¿›è¡Œå‡çº§ï¼Œåœ¨è¿›è¡Œå‡çº§ä¹‹å‰ï¼Œå¯ä»¥åœ¨æ‰€æœ‰peerä¸Šåœæ­¢ä¸€ä¸ªchaincode ;</p><h2 id="CLI-å®¢æˆ·ç«¯"><a href="#CLI-å®¢æˆ·ç«¯" class="headerlink" title="CLI(å®¢æˆ·ç«¯)"></a>CLI(å®¢æˆ·ç«¯)</h2><p> å®˜æ–¹æ­£åœ¨è¯„ä¼°ä¸ºHyperledger Fabric peeräºŒè¿›åˆ¶æ–‡ä»¶åˆ†å‘ç‰¹å®šå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„éœ€æ±‚;<br> ç›®å‰ï¼Œå¯ä»¥ç®€å•åœ°è¿è¡Œdodcker å®¹å™¨ä¸­è°ƒç”¨å‘½ä»¤; </p><p> æŸ¥çœ‹å½“å‰çš„å¯ç”¨çš„CLIå‘½ä»¤ï¼Œè¿è¡Œçš„fabric-peer Dockerå®¹å™¨ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤: </p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># docker run -it hyperledger/fabric-peer bash</div><div class="line"># peer chaincode --help</div></pre></td></tr></table></figure><p> æ³¨: å¯ä½¿ç”¨docker exec -it cli (å®¹å™¨å) bashå‘½ä»¤è¿›å…¥cli  </p><p> ä¸ä¸‹é¢ç±»ä¼¼çš„è¾“å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">  peer chaincode [command]</div><div class="line"></div><div class="line">Available Commands:</div><div class="line">  install     Package the specified chaincode into a deployment spec and save it on the peer&apos;s path.</div><div class="line">  instantiate Deploy the specified chaincode to the network.</div><div class="line">  invoke      Invoke the specified chaincode.</div><div class="line">  package     Package the specified chaincode into a deployment spec.</div><div class="line">  query       Query using the specified chaincode.</div><div class="line">  signpackage Sign the specified chaincode package</div><div class="line">  upgrade     Upgrade chaincode.</div><div class="line"></div><div class="line">Flags:</div><div class="line">      --cafile string     Path to file containing PEM-encoded trusted certificate(s) for the ordering endpoint</div><div class="line">  -C, --chainID string    The chain on which this command should be executed (default &quot;testchainid&quot;)</div><div class="line">  -c, --ctor string       Constructor message for the chaincode in JSON format (default &quot;&#123;&#125;&quot;)</div><div class="line">  -E, --escc string       The name of the endorsement system chaincode to be used for this chaincode</div><div class="line">  -l, --lang string       Language the chaincode is written in (default &quot;golang&quot;)</div><div class="line">  -n, --name string       Name of the chaincode</div><div class="line">  -o, --orderer string    Ordering service endpoint</div><div class="line">  -p, --path string       Path to chaincode</div><div class="line">  -P, --policy string     The endorsement policy associated to this chaincode</div><div class="line">  -t, --tid string        Name of a custom ID generation algorithm (hashing and decoding) e.g. sha256base64</div><div class="line">      --tls               Use TLS when communicating with the orderer endpoint</div><div class="line">  -u, --username string   Username for chaincode operations when security is enabled</div><div class="line">  -v, --version string    Version of the chaincode specified in install/instantiate/upgrade commands</div><div class="line">  -V, --vscc string       The name of the verification system chaincode to be used for this chaincode</div><div class="line"></div><div class="line">Global Flags:</div><div class="line">      --logging-level string       Default logging level and overrides, see core.yaml for full syntax</div><div class="line">      --test.coverprofile string   Done (default &quot;coverage.cov&quot;)</div><div class="line"></div><div class="line">Use &quot;peer chaincode [command] --help&quot; for more information about a command.</div><div class="line">2018-03-20 07:55:59.840 UTC [main] main -&gt; INFO 003 Exiting.....</div></pre></td></tr></table></figure><p>å…¨å±€flags: â€“logging-level string<br>é»˜è®¤çš„æ—¥å¿—è®°å½•levelå’Œoverrides   </p><ul><li>test.coverprofile string Done(default â€œcoverage.covâ€)<br>-v ,â€“version<br>ä½¿ç”¨â€peer chaincode [command] -helpâ€ è·å–æ›´å¤šå…³äºå‘½ä»¤çš„ä¿¡æ¯;<br>ä¸ºäº†æ–¹ä¾¿åœ¨è„šæœ¬åŒ–çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ï¼Œpeerå‘½ä»¤æ€»æ˜¯åœ¨å‘ç”Ÿå‘½ä»¤å¤±è´¥æ—¶ç”Ÿæˆéé›¶è¿”å›ä»£ç ;  </li></ul><p>chaincodeå‘½ä»¤çš„ä¾‹å­: </p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">peer chaincode install -n mycc -v 0 -p path/to/my/chaincode/v0</div><div class="line">peer chaincode instantiate -n mycc -v 0 -c &apos;&#123;&quot;Args&quot;:[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#125;&apos; -C mychannel</div><div class="line">peer chaincode install -n mycc -v 1 -p path/to/my/chaincode/v1</div><div class="line">peer chaincode upgrade -n mycc -v 1 -c &apos;&#123;&quot;Args&quot;:[&quot;d&quot;, &quot;e&quot;, &quot;f&quot;]&#125;&apos; -C mychannel</div><div class="line">peer chaincode query -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;e&quot;]&#125;&apos;</div><div class="line">peer chaincode invoke -o orderer.example.com:7050  --tls --cafile $ORDERER_CA -C mychannel -n mycc -c &apos;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]&#125;&apos;</div></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿæ™ºèƒ½åˆçº¦-System-chaincode"><a href="#ç³»ç»Ÿæ™ºèƒ½åˆçº¦-System-chaincode" class="headerlink" title="ç³»ç»Ÿæ™ºèƒ½åˆçº¦(System chaincode)"></a>ç³»ç»Ÿæ™ºèƒ½åˆçº¦(System chaincode)</h2><p>ç³»ç»Ÿchaincodeå…·æœ‰ç›¸åŒçš„ç¼–ç¨‹æ¨¡å‹ï¼Œé™¤äº†å®ƒåœ¨peerè¿›ç¨‹ä¸­è¿è¡Œï¼Œè€Œä¸æ˜¯æ™®é€šçš„chaincodeé‚£æ ·åœ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ä¸­è¿è¡Œ; å› æ­¤ï¼Œç³»ç»Ÿchaincodeè¢«æ„å»ºåˆ°peerä¸­å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ä¸éµå¾ªä¸Šé¢æè¿°çš„ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚ç‰¹åˆ«æ˜¯å®‰è£…ã€å®ä¾‹åŒ–å’Œå‡çº§ å¹¶ä¸é€‚ç”¨äºç³»ç»Ÿchaincodeï¼›  </p><p>ç³»ç»Ÿchaincodeçš„ç›®çš„æ˜¯ä¸ºäº†åœ¨peerå’Œchaincodeä¹‹é—´å‡å°‘gRPCçš„é€šä¿¡æˆæœ¬ï¼Œå¹¶æƒè¡¡ç®¡ç† çš„çµæ´»æ€§;<br>ä¾‹å¦‚,ç³»ç»Ÿchaincodeåªèƒ½ç”¨peeräºŒè¿›åˆ¶è¿›è¡Œå‡çº§ã€‚å®ƒè¿˜å¿…é¡»æ³¨å†Œä¸€ä¸ªå›ºå®šçš„å‚æ•°é›†ï¼Œå¹¶ä¸”æ²¡æœ‰èƒŒä¹¦ç­–ç•¥æˆ–èƒŒä¹¦ç­–ç•¥çš„åŠŸèƒ½;  </p><p>ç³»ç»Ÿchaincodeç”¨äºHyperledger Fabricä»¥å®ç°è®¸å¤šç³»ç»Ÿè¡Œä¸ºï¼Œä½¿å®ƒä»¬å¯ä»¥è¢«ç³»ç»Ÿé›†æˆæ‰€å–ä»£æˆ–ä¿®æ”¹;  </p><p>ç³»ç»Ÿchaincodeåˆ—è¡¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1. LSCC(Lifecycle system chaincode): ç”Ÿå‘½å‘¨æœŸç³»ç»Ÿchaindoeå¤„ç†ä¸Šæè¿°çš„ç”Ÿå‘½å‘¨æœŸè¯·æ±‚;  </div><div class="line">2. CSCC(Configuration system chaincode):é…ç½®ç³»ç»Ÿchaincodeåœ¨peerç«¯å¤„ç†channelé…ç½®;  </div><div class="line">3. QSCC(Query system chaincode): æŸ¥è¯¢ç³»ç»Ÿchaincodeæä¾›äº†åˆ†ç±»æŸ¥è¯¢api,ä¾‹å¦‚è·å–å—å’Œäº‹åŠ¡;  </div><div class="line">4. ESCC(Query system chaincode): èƒŒä¹¦ç³»ç»Ÿchaincodeé€šè¿‡ç­¾ç½²äº‹åŠ¡ææ¡ˆå“åº”æ¥å¤„ç†æ”¯æŒ;  </div><div class="line">5. VSCC(Validation system chaincode): éªŒè¯ç³»ç»Ÿchaincodeå¤„ç†äº‹åŠ¡éªŒè¯,ç­–ç•¥å’Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶;</div></pre></td></tr></table></figure><p>åœ¨ä¿®æ”¹æˆ–æ›¿æ¢è¿™äº›ç³»ç»Ÿchaincodeæ—¶å¿…éœ€æ³¨æ„,ç‰¹åˆ«æ˜¯LSCCã€ESCCå’ŒVSCCï¼Œå› ä¸ºå®ƒä»¬åœ¨ä¸»äº‹åŠ¡æ‰§è¡Œè·¯å¾„ ä¸­ï¼›<br>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“VSCCåœ¨å°†å…¶æäº¤åˆ°è´¦æœ¬ä¹‹å‰ä¸€ä¸ªå—ï¼Œé‡è¦çš„æ˜¯ï¼Œchannelä¸­çš„æ‰€æœ‰peerèŠ‚ç‚¹éƒ½è¦è®¡ç®—ç›¸åŒçš„éªŒè¯ï¼Œä»¥é¿å…è´¦æœ¬å·®å¼‚ã€‚å› æ­¤ï¼Œå¦‚æœVSCCè¢«ä¿®æ”¹æˆ–æ›¿æ¢ï¼Œå°±éœ€è¦ç‰¹åˆ«çš„å¤„ç†å’Œç»´æŠ¤;  </p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MariaDBä¹‹SELECTè¯­æ³•ç»ƒä¹ </title>
      <link href="/2018/02/28/MariaDB%E4%B9%8BSELECT%E8%AF%AD%E6%B3%95%E7%BB%83%E4%B9%A0/"/>
      <url>/2018/02/28/MariaDB%E4%B9%8BSELECT%E8%AF%AD%E6%B3%95%E7%BB%83%E4%B9%A0/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€-ã€å¯¼å…¥hellodb-sqlç”Ÿæˆæ•°æ®åº“åå®ç°ä»¥ä¸‹æ“ä½œ"><a href="#ä¸€-ã€å¯¼å…¥hellodb-sqlç”Ÿæˆæ•°æ®åº“åå®ç°ä»¥ä¸‹æ“ä½œ" class="headerlink" title="ä¸€ ã€å¯¼å…¥hellodb.sqlç”Ÿæˆæ•°æ®åº“åå®ç°ä»¥ä¸‹æ“ä½œ"></a>ä¸€ ã€å¯¼å…¥hellodb.sqlç”Ÿæˆæ•°æ®åº“åå®ç°ä»¥ä¸‹æ“ä½œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â mysqlÂ -urootÂ -h172.16.23.23Â -pcento.123Â &lt;Â hellodb.sql</span></div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SHOWÂ DATABASES;Â #å¯ä»¥åˆ—å‡ºå·²å­˜åœ¨çš„æ•°æ®åº“Â </div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">|Â DatabaseÂ Â Â Â Â Â Â Â Â Â Â |</div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">|Â information_schemaÂ |</div><div class="line">|Â NODE1Â Â Â Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â RJYYÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â hellodbÂ Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â mysqlÂ Â Â Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â performance_schemaÂ |</div><div class="line">|Â testÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">+<span class="comment">--------------------+</span></div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â USEÂ hellodb;</div><div class="line">mysql&gt;Â SHOWÂ TABLES;Â </div><div class="line">+<span class="comment">-------------------+</span></div><div class="line">|Â Tables_in_hellodbÂ |</div><div class="line">+<span class="comment">-------------------+</span></div><div class="line">|Â classesÂ Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â cocÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â coursesÂ Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â scoresÂ Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â studentsÂ Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â teachersÂ Â Â Â Â Â Â Â Â Â |</div><div class="line">|Â tocÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â |</div><div class="line">+<span class="comment">-------------------+</span></div></pre></td></tr></table></figure><h3 id="1ã€-åœ¨studentsè¡¨ä¸­ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº25å²ï¼Œä¸”ä¸ºç”·æ€§çš„åŒå­¦çš„åå­—å’Œå¹´é¾„ï¼›"><a href="#1ã€-åœ¨studentsè¡¨ä¸­ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº25å²ï¼Œä¸”ä¸ºç”·æ€§çš„åŒå­¦çš„åå­—å’Œå¹´é¾„ï¼›" class="headerlink" title="1ã€ åœ¨studentsè¡¨ä¸­ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº25å²ï¼Œä¸”ä¸ºç”·æ€§çš„åŒå­¦çš„åå­—å’Œå¹´é¾„ï¼›"></a>1ã€ åœ¨studentsè¡¨ä¸­ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº25å²ï¼Œä¸”ä¸ºç”·æ€§çš„åŒå­¦çš„åå­—å’Œå¹´é¾„ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ Name,AgeÂ FROMÂ studentsÂ WHEREÂ AgeÂ &gt;25Â ANDÂ Gender='M';Â </div><div class="line">+<span class="comment">--------------+-----+</span></div><div class="line">|Â NameÂ Â Â Â Â Â Â Â Â |Â AgeÂ |</div><div class="line">+<span class="comment">--------------+-----+</span></div><div class="line">|Â XieÂ YankeÂ Â Â Â |Â Â 53Â |</div><div class="line">|Â DingÂ DianÂ Â Â Â |Â Â 32Â |</div><div class="line">|Â YuÂ YutongÂ Â Â Â |Â Â 26Â |</div><div class="line">|Â ShiÂ QingÂ Â Â Â Â |Â Â 46Â |</div><div class="line">|Â TianÂ BoguangÂ |Â Â 33Â |</div><div class="line">|Â XuÂ XianÂ Â Â Â Â Â |Â Â 27Â |</div><div class="line">|Â SunÂ DashengÂ Â |Â 100Â |</div><div class="line">+<span class="comment">--------------+-----+</span></div></pre></td></tr></table></figure><h3 id="2ã€-ä»¥ClassIDä¸ºåˆ†ç»„ä¾æ®ï¼Œæ˜¾ç¤ºæ¯ç»„çš„å¹³å‡å¹´é¾„ï¼›"><a href="#2ã€-ä»¥ClassIDä¸ºåˆ†ç»„ä¾æ®ï¼Œæ˜¾ç¤ºæ¯ç»„çš„å¹³å‡å¹´é¾„ï¼›" class="headerlink" title="2ã€ ä»¥ClassIDä¸ºåˆ†ç»„ä¾æ®ï¼Œæ˜¾ç¤ºæ¯ç»„çš„å¹³å‡å¹´é¾„ï¼›"></a>2ã€ ä»¥ClassIDä¸ºåˆ†ç»„ä¾æ®ï¼Œæ˜¾ç¤ºæ¯ç»„çš„å¹³å‡å¹´é¾„ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ avg(age),ClassIDÂ FROMÂ studentsÂ WHEREÂ ClassIDÂ ISÂ NOTÂ NULLÂ GROUPÂ BYÂ ClassIDÂ ;</div><div class="line">+<span class="comment">----------+---------+</span></div><div class="line">|Â avg(age)Â |Â ClassIDÂ |</div><div class="line">+<span class="comment">----------+---------+</span></div><div class="line">|Â Â 20.5000Â |Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â Â 36.0000Â |Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â Â 20.2500Â |Â Â Â Â Â Â Â 3Â |</div><div class="line">|Â Â 24.7500Â |Â Â Â Â Â Â Â 4Â |</div><div class="line">|Â Â 46.0000Â |Â Â Â Â Â Â Â 5Â |</div><div class="line">|Â Â 20.7500Â |Â Â Â Â Â Â Â 6Â |</div><div class="line">|Â Â 19.6667Â |Â Â Â Â Â Â Â 7Â |</div><div class="line">+<span class="comment">----------+---------+</span></div></pre></td></tr></table></figure><h3 id="3ã€-æ˜¾ç¤ºç¬¬2é¢˜ä¸­å¹³å‡å¹´é¾„å¤§äº30çš„åˆ†ç»„åŠå¹³å‡å¹´é¾„ï¼›"><a href="#3ã€-æ˜¾ç¤ºç¬¬2é¢˜ä¸­å¹³å‡å¹´é¾„å¤§äº30çš„åˆ†ç»„åŠå¹³å‡å¹´é¾„ï¼›" class="headerlink" title="3ã€ æ˜¾ç¤ºç¬¬2é¢˜ä¸­å¹³å‡å¹´é¾„å¤§äº30çš„åˆ†ç»„åŠå¹³å‡å¹´é¾„ï¼›"></a>3ã€ æ˜¾ç¤ºç¬¬2é¢˜ä¸­å¹³å‡å¹´é¾„å¤§äº30çš„åˆ†ç»„åŠå¹³å‡å¹´é¾„ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ avg(Age),ClassIDÂ FROMÂ studentsÂ WHEREÂ ClassIDÂ ISÂ NOTÂ NULLÂ Â GROUPÂ BYÂ ClassIDÂ HAVINGÂ avg(Age)Â &gt;Â 30;</div><div class="line">+<span class="comment">----------+---------+</span></div><div class="line">|Â avg(Age)Â |Â ClassIDÂ |</div><div class="line">+<span class="comment">----------+---------+</span></div><div class="line">|Â Â 36.0000Â |Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â Â 46.0000Â |Â Â Â Â Â Â Â 5Â |</div><div class="line">+<span class="comment">----------+---------+</span></div></pre></td></tr></table></figure><h3 id="4ã€-æ˜¾ç¤ºä»¥Lå¼€å¤´çš„åå­—çš„åŒå­¦çš„ä¿¡æ¯ï¼›"><a href="#4ã€-æ˜¾ç¤ºä»¥Lå¼€å¤´çš„åå­—çš„åŒå­¦çš„ä¿¡æ¯ï¼›" class="headerlink" title="4ã€ æ˜¾ç¤ºä»¥Lå¼€å¤´çš„åå­—çš„åŒå­¦çš„ä¿¡æ¯ï¼›"></a>4ã€ æ˜¾ç¤ºä»¥Lå¼€å¤´çš„åå­—çš„åŒå­¦çš„ä¿¡æ¯ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ *Â FROMÂ studentsÂ WHEREÂ NameÂ LIKEÂ 'L%';</div><div class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></div><div class="line">|Â StuIDÂ |Â NameÂ Â Â Â Â Â Â Â |Â AgeÂ |Â GenderÂ |Â ClassIDÂ Â TeacherID Â |</div><div class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></div><div class="line">|Â Â Â Â Â 8Â |Â LinÂ DaiyuÂ Â Â |Â Â 17Â |Â FÂ Â Â Â Â Â |Â Â Â Â Â Â Â 7Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 14Â |Â LuÂ WushuangÂ |Â Â 17Â |Â FÂ Â Â Â Â Â |Â Â Â Â Â Â Â 3Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 17Â |Â LinÂ ChongÂ Â Â |Â Â 25Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></div></pre></td></tr></table></figure><h3 id="5ã€-æ˜¾ç¤ºTeacherIDéç©ºçš„åŒå­¦çš„ç›¸å…³ä¿¡æ¯ï¼›"><a href="#5ã€-æ˜¾ç¤ºTeacherIDéç©ºçš„åŒå­¦çš„ç›¸å…³ä¿¡æ¯ï¼›" class="headerlink" title="5ã€ æ˜¾ç¤ºTeacherIDéç©ºçš„åŒå­¦çš„ç›¸å…³ä¿¡æ¯ï¼›"></a>5ã€ æ˜¾ç¤ºTeacherIDéç©ºçš„åŒå­¦çš„ç›¸å…³ä¿¡æ¯ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ *Â FROMÂ studentsÂ WHEREÂ TeacherIDÂ ISÂ NOTÂ NULL;Â Â Â </div><div class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></div><div class="line">|Â StuIDÂ |Â NameÂ Â Â Â Â Â Â Â |Â AgeÂ |Â GenderÂ |Â ClassIDÂ |Â TeacherIDÂ |</div><div class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></div><div class="line">|Â Â Â Â Â 1Â |Â ShiÂ ZhongyuÂ |Â Â 22Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 2Â |Â Â Â Â Â Â Â Â Â 3Â |</div><div class="line">|Â Â Â Â Â 2Â |Â ShiÂ PotianÂ Â |Â Â 22Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 1Â |Â Â Â Â Â Â Â Â Â 7Â |</div><div class="line">|Â Â Â Â Â 3Â |Â XieÂ YankeÂ Â Â |Â Â 53Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 2Â |Â Â Â Â Â Â Â Â 16Â |</div><div class="line">|Â Â Â Â Â 4Â |Â DingÂ DianÂ Â Â |Â Â 32Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â Â Â Â 4Â |</div><div class="line">|Â Â Â Â Â 5Â |Â YuÂ YutongÂ Â Â |Â Â 26Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 3Â |Â Â Â Â Â Â Â Â Â 1Â |</div><div class="line">+<span class="comment">-------+-------------+-----+--------+---------+-----------+</span></div></pre></td></tr></table></figure><h3 id="6ã€-ä»¥å¹´é¾„æ’åºåï¼Œæ˜¾ç¤ºå¹´é¾„æœ€å¤§çš„å‰10ä½åŒå­¦çš„ä¿¡æ¯ï¼›"><a href="#6ã€-ä»¥å¹´é¾„æ’åºåï¼Œæ˜¾ç¤ºå¹´é¾„æœ€å¤§çš„å‰10ä½åŒå­¦çš„ä¿¡æ¯ï¼›" class="headerlink" title="6ã€ ä»¥å¹´é¾„æ’åºåï¼Œæ˜¾ç¤ºå¹´é¾„æœ€å¤§çš„å‰10ä½åŒå­¦çš„ä¿¡æ¯ï¼›"></a>6ã€ ä»¥å¹´é¾„æ’åºåï¼Œæ˜¾ç¤ºå¹´é¾„æœ€å¤§çš„å‰10ä½åŒå­¦çš„ä¿¡æ¯ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ *Â FROMÂ studentsÂ ORDERÂ BYÂ AgeÂ DESCÂ LIMITÂ 10;</div><div class="line">+<span class="comment">-------+--------------+-----+--------+---------+-----------+</span></div><div class="line">|Â StuIDÂ |Â NameÂ Â Â Â Â Â Â Â Â |Â AgeÂ |Â GenderÂ |Â ClassIDÂ |Â TeacherIDÂ |</div><div class="line">+<span class="comment">-------+--------------+-----+--------+---------+-----------+</span></div><div class="line">|Â Â Â Â 25Â |Â SunÂ DashengÂ Â |Â 100Â |Â MÂ Â Â Â Â Â |Â Â Â Â NULLÂ |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â Â 3Â |Â XieÂ YankeÂ Â Â Â |Â Â 53Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 2Â |Â Â Â Â Â Â Â Â 16Â |</div><div class="line">|Â Â Â Â Â 6Â |Â ShiÂ QingÂ Â Â Â Â |Â Â 46Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 5Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 13Â |Â TianÂ BoguangÂ |Â Â 33Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 2Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â Â 4Â |Â DingÂ DianÂ Â Â Â |Â Â 32Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â Â Â Â 4Â |</div><div class="line">|Â Â Â Â 24Â |Â XuÂ XianÂ Â Â Â Â Â |Â Â 27Â |Â MÂ Â Â Â Â Â |Â Â Â Â NULLÂ |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â Â 5Â |Â YuÂ YutongÂ Â Â Â |Â Â 26Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 3Â |Â Â Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â Â Â Â 17Â |Â LinÂ ChongÂ Â Â Â |Â Â 25Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 23Â |Â MaÂ ChaoÂ Â Â Â Â Â |Â Â 23Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 18Â |Â HuaÂ RongÂ Â Â Â Â |Â Â 23Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 7Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">+<span class="comment">-------+--------------+-----+--------+---------+-----------+</span></div></pre></td></tr></table></figure><h3 id="7ã€-æŸ¥è¯¢å¹´é¾„å¤§äºç­‰äº20å²ï¼Œå°äºç­‰äº25å²çš„åŒå­¦çš„ä¿¡æ¯ï¼›ç”¨ä¸‰ç§æ–¹æ³•ï¼›"><a href="#7ã€-æŸ¥è¯¢å¹´é¾„å¤§äºç­‰äº20å²ï¼Œå°äºç­‰äº25å²çš„åŒå­¦çš„ä¿¡æ¯ï¼›ç”¨ä¸‰ç§æ–¹æ³•ï¼›" class="headerlink" title="7ã€ æŸ¥è¯¢å¹´é¾„å¤§äºç­‰äº20å²ï¼Œå°äºç­‰äº25å²çš„åŒå­¦çš„ä¿¡æ¯ï¼›ç”¨ä¸‰ç§æ–¹æ³•ï¼›"></a>7ã€ æŸ¥è¯¢å¹´é¾„å¤§äºç­‰äº20å²ï¼Œå°äºç­‰äº25å²çš„åŒå­¦çš„ä¿¡æ¯ï¼›ç”¨ä¸‰ç§æ–¹æ³•ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ *Â FROMÂ studentsÂ WHEREÂ AgeÂ &gt;=20Â ANDÂ AgeÂ &lt;=25;Â Â Â Â </div><div class="line">mysql&gt;Â SELECTÂ *Â FROMÂ studentsÂ WHEREÂ AgeÂ Â BETWEENÂ 20Â ANDÂ 25;Â </div><div class="line">mysql&gt;Â SELECTÂ *Â FROMÂ studentsÂ WHEREÂ AgeÂ Â INÂ (20,21,22,23,24,25);</div><div class="line">+<span class="comment">-------+---------------+-----+--------+---------+-----------+</span></div><div class="line">|Â StuIDÂ |Â NameÂ Â Â Â Â Â Â Â Â Â |Â AgeÂ |Â GenderÂ |Â ClassIDÂ |Â TeacherIDÂ |</div><div class="line">+<span class="comment">-------+---------------+-----+--------+---------+-----------+</span></div><div class="line">|Â Â Â Â Â 1Â |Â ShiÂ ZhongyuÂ Â Â |Â Â 22Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 2Â |Â Â Â Â Â Â Â Â Â 3Â |</div><div class="line">|Â Â Â Â Â 2Â |Â ShiÂ PotianÂ Â Â Â |Â Â 22Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 1Â |Â Â Â Â Â Â Â Â Â 7Â |</div><div class="line">|Â Â Â Â Â 9Â |Â RenÂ YingyingÂ Â |Â Â 20Â |Â FÂ Â Â Â Â Â |Â Â Â Â Â Â Â 6Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 11Â |Â YuanÂ ChengzhiÂ |Â Â 23Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 6Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 16Â |Â XuÂ ZhuÂ Â Â Â Â Â Â Â |Â Â 21Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 1Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 17Â |Â LinÂ ChongÂ Â Â Â Â |Â Â 25Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 18Â |Â HuaÂ RongÂ Â Â Â Â Â |Â Â 23Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 7Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 21Â |Â HuangÂ YueyingÂ |Â Â 22Â |Â FÂ Â Â Â Â Â |Â Â Â Â Â Â Â 6Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 22Â |Â XiaoÂ QiaoÂ Â Â Â Â |Â Â 20Â |Â FÂ Â Â Â Â Â |Â Â Â Â Â Â Â 1Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â 23Â |Â MaÂ ChaoÂ Â Â Â Â Â Â |Â Â 23Â |Â MÂ Â Â Â Â Â |Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â NULLÂ |</div><div class="line">+<span class="comment">-------+---------------+-----+--------+---------+-----------+</span></div></pre></td></tr></table></figure><h2 id="äºŒã€-å¯¼å…¥hellodb-sqlï¼Œä»¥ä¸‹æ“ä½œåœ¨studentsè¡¨ä¸Šæ‰§è¡Œ"><a href="#äºŒã€-å¯¼å…¥hellodb-sqlï¼Œä»¥ä¸‹æ“ä½œåœ¨studentsè¡¨ä¸Šæ‰§è¡Œ" class="headerlink" title="äºŒã€  å¯¼å…¥hellodb.sqlï¼Œä»¥ä¸‹æ“ä½œåœ¨studentsè¡¨ä¸Šæ‰§è¡Œ"></a>äºŒã€  å¯¼å…¥hellodb.sqlï¼Œä»¥ä¸‹æ“ä½œåœ¨studentsè¡¨ä¸Šæ‰§è¡Œ</h2><h3 id="1ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºæ¯ç­çš„åŒå­¦çš„äººæ•°ï¼›"><a href="#1ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºæ¯ç­çš„åŒå­¦çš„äººæ•°ï¼›" class="headerlink" title="1ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºæ¯ç­çš„åŒå­¦çš„äººæ•°ï¼›"></a>1ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºæ¯ç­çš„åŒå­¦çš„äººæ•°ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ count(StuID),ClassIDÂ FROMÂ studentsÂ GROUPÂ BYÂ ClassIDÂ ;Â Â </div><div class="line">+<span class="comment">--------------+---------+</span></div><div class="line">Â |Â count(StuID)Â |Â ClassIDÂ |</div><div class="line">+<span class="comment">--------------+---------+</span></div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 2Â |Â Â Â Â NULLÂ |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 3Â |Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â Â 3Â |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â Â 4Â |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 1Â |Â Â Â Â Â Â Â 5Â |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 4Â |Â Â Â Â Â Â Â 6Â |</div><div class="line">|Â Â Â Â Â Â Â Â Â Â Â Â 3Â |Â Â Â Â Â Â Â 7Â |</div><div class="line">+<span class="comment">--------------+---------+</span></div></pre></td></tr></table></figure><h3 id="2ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹´é¾„ä¹‹å’Œï¼›"><a href="#2ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹´é¾„ä¹‹å’Œï¼›" class="headerlink" title="2ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹´é¾„ä¹‹å’Œï¼›"></a>2ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹´é¾„ä¹‹å’Œï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ sum(Age),GenderÂ FROMÂ studentsÂ GROUPÂ BYÂ GenderÂ ;</div><div class="line">+<span class="comment">----------+--------+</span></div><div class="line">|Â sum(Age)Â |Â GenderÂ |</div><div class="line">+<span class="comment">----------+--------+</span></div><div class="line">|Â Â Â Â Â Â 190Â |Â FÂ Â Â Â Â Â |</div><div class="line">|Â Â Â Â Â Â 495Â |Â MÂ Â Â Â Â Â |</div><div class="line">+<span class="comment">----------+--------+</span></div></pre></td></tr></table></figure><h3 id="3ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹³å‡å¹´é¾„å¤§äº25çš„ç­çº§ï¼›"><a href="#3ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹³å‡å¹´é¾„å¤§äº25çš„ç­çº§ï¼›" class="headerlink" title="3ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹³å‡å¹´é¾„å¤§äº25çš„ç­çº§ï¼›"></a>3ã€ä»¥ClassIDåˆ†ç»„ï¼Œæ˜¾ç¤ºå…¶å¹³å‡å¹´é¾„å¤§äº25çš„ç­çº§ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ avg(Age),ClassIDÂ FROMÂ studentsÂ GROUPÂ BYÂ ClassIDÂ HAVINGÂ avg(Age)Â &gt;Â 25;</div><div class="line">+<span class="comment">----------+---------+</span></div><div class="line">|Â avg(Age)Â |Â ClassIDÂ |</div><div class="line">+<span class="comment">----------+---------+</span></div><div class="line">|Â Â 63.5000Â |Â Â Â Â NULLÂ |</div><div class="line">|Â Â 36.0000Â |Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â Â 46.0000Â |Â Â Â Â Â Â Â 5Â |</div><div class="line">+<span class="comment">----------+---------+</span></div></pre></td></tr></table></figure><h3 id="4ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå„ç»„ä¸­å¹´é¾„å¤§äº25çš„å­¦å‘˜çš„å¹´é¾„ä¹‹å’Œï¼›"><a href="#4ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå„ç»„ä¸­å¹´é¾„å¤§äº25çš„å­¦å‘˜çš„å¹´é¾„ä¹‹å’Œï¼›" class="headerlink" title="4ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå„ç»„ä¸­å¹´é¾„å¤§äº25çš„å­¦å‘˜çš„å¹´é¾„ä¹‹å’Œï¼›"></a>4ã€ä»¥Genderåˆ†ç»„ï¼Œæ˜¾ç¤ºå„ç»„ä¸­å¹´é¾„å¤§äº25çš„å­¦å‘˜çš„å¹´é¾„ä¹‹å’Œï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ sum(Age),GenderÂ FROMÂ studentsÂ WHEREÂ AgeÂ &gt;Â 25Â GROUPÂ BYÂ GenderÂ ;</div><div class="line">+<span class="comment">----------+--------+</span></div><div class="line">|Â sum(Age)Â |Â GenderÂ |</div><div class="line">+<span class="comment">----------+--------+</span></div><div class="line">|Â Â Â Â Â Â 317Â |Â MÂ Â Â Â Â Â |</div><div class="line">+<span class="comment">----------+--------+</span></div></pre></td></tr></table></figure><h2 id="ä¸‰ã€-å¯¼å…¥hellodb-sqlï¼Œå®Œæˆä»¥ä¸‹é¢˜ç›®ï¼š"><a href="#ä¸‰ã€-å¯¼å…¥hellodb-sqlï¼Œå®Œæˆä»¥ä¸‹é¢˜ç›®ï¼š" class="headerlink" title="ä¸‰ã€ å¯¼å…¥hellodb.sqlï¼Œå®Œæˆä»¥ä¸‹é¢˜ç›®ï¼š"></a>ä¸‰ã€ å¯¼å…¥hellodb.sqlï¼Œå®Œæˆä»¥ä¸‹é¢˜ç›®ï¼š</h2><h3 id="1ã€æ˜¾ç¤ºå‰5ä½åŒå­¦çš„å§“åã€è¯¾ç¨‹åŠæˆç»©ï¼›"><a href="#1ã€æ˜¾ç¤ºå‰5ä½åŒå­¦çš„å§“åã€è¯¾ç¨‹åŠæˆç»©ï¼›" class="headerlink" title="1ã€æ˜¾ç¤ºå‰5ä½åŒå­¦çš„å§“åã€è¯¾ç¨‹åŠæˆç»©ï¼›"></a>1ã€æ˜¾ç¤ºå‰5ä½åŒå­¦çš„å§“åã€è¯¾ç¨‹åŠæˆç»©ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ s.Name,courses.Course,scores.ScoreÂ FROMÂ (selectÂ *Â fromÂ studentsÂ limitÂ 5)Â </div><div class="line">ASÂ sÂ Â LEFTÂ JOINÂ scoresÂ ONÂ scores.StuIDÂ =Â s.StuIDÂ LEFTÂ JOINÂ coursesÂ ONÂ scores.CourseIDÂ =courses.CourseID;</div><div class="line">mysql&gt;Â SELECTÂ s.name,sc.course,sc.scoreÂ FROMÂ (SELECTÂ *Â FROMÂ studentsÂ LIMITÂ 5Â )Â </div><div class="line">ASÂ sÂ LEFTÂ JOINÂ (<span class="keyword">SELECT</span>Â scores.stuid,courses.course,scores.scoreÂ <span class="keyword">FROM</span>Â scoresÂ <span class="keyword">LEFT</span>Â <span class="keyword">JOIN</span>Â coursesÂ <span class="keyword">ON</span>Â </div><div class="line">courses.CourseID=scores.CourseID)<span class="keyword">AS</span>Â scÂ <span class="keyword">ON</span>Â s.StuId=sc.StuID;</div><div class="line">+<span class="comment">-------------+----------------+-------+</span></div><div class="line">|Â nameÂ Â Â Â Â Â Â Â |Â courseÂ Â Â Â Â Â Â Â Â |Â scoreÂ |</div><div class="line">+<span class="comment">-------------+----------------+-------+</span></div><div class="line">|Â ShiÂ ZhongyuÂ |Â KuihuaÂ BaodianÂ |Â Â Â Â 77Â |</div><div class="line">|Â ShiÂ ZhongyuÂ |Â WeituoÂ ZhangÂ Â Â |Â Â Â Â 93Â |</div><div class="line">|Â ShiÂ PotianÂ Â |Â KuihuaÂ BaodianÂ |Â Â Â Â 47Â |</div><div class="line">|Â ShiÂ PotianÂ Â |Â DaiyuÂ ZanghuaÂ Â |Â Â Â Â 97Â |</div><div class="line">|Â XieÂ YankeÂ Â Â |Â KuihuaÂ BaodianÂ |Â Â Â Â 88Â |</div><div class="line">|Â XieÂ YankeÂ Â Â |Â WeituoÂ ZhangÂ Â Â |Â Â Â Â 75Â |</div><div class="line">|Â DingÂ DianÂ Â Â |Â DaiyuÂ ZanghuaÂ Â |Â Â Â Â 71Â |</div><div class="line">|Â DingÂ DianÂ Â Â |Â KuihuaÂ BaodianÂ |Â Â Â Â 89Â |</div><div class="line">|Â YuÂ YutongÂ Â Â |Â HamoÂ GongÂ Â Â Â Â Â |Â Â Â Â 39Â |</div><div class="line">|Â YuÂ YutongÂ Â Â |Â DagouÂ BangfaÂ Â Â |Â Â Â Â 63Â |</div><div class="line">+<span class="comment">-------------+----------------+-------+</span></div></pre></td></tr></table></figure><h3 id="2ã€æ˜¾ç¤ºå…¶æˆç»©é«˜äº80çš„åŒå­¦çš„åç§°åŠè¯¾ç¨‹ï¼›"><a href="#2ã€æ˜¾ç¤ºå…¶æˆç»©é«˜äº80çš„åŒå­¦çš„åç§°åŠè¯¾ç¨‹ï¼›" class="headerlink" title="2ã€æ˜¾ç¤ºå…¶æˆç»©é«˜äº80çš„åŒå­¦çš„åç§°åŠè¯¾ç¨‹ï¼›"></a>2ã€æ˜¾ç¤ºå…¶æˆç»©é«˜äº80çš„åŒå­¦çš„åç§°åŠè¯¾ç¨‹ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ Name,Course,ScoreÂ FROMÂ (studentsÂ LEFTÂ JOINÂ scoresÂ ONÂ students.StuID=scores.StuIDÂ )Â </div><div class="line">LEFTÂ JOINÂ coursesÂ ONÂ courses.CourseID=scores.CourseIDÂ WHEREÂ ScoreÂ &gt;Â 80;Â </div><div class="line">+<span class="comment">-------------+----------------+-------+</span></div><div class="line">|Â NameÂ Â Â Â Â Â Â Â |Â CourseÂ Â Â Â Â Â Â Â Â |Â ScoreÂ |</div><div class="line">+<span class="comment">-------------+----------------+-------+</span></div><div class="line">|Â ShiÂ ZhongyuÂ |Â WeituoÂ ZhangÂ Â Â |Â Â Â Â 93Â |</div><div class="line">|Â ShiÂ PotianÂ Â |Â DaiyuÂ ZanghuaÂ Â |Â Â Â Â 97Â |</div><div class="line">|Â XieÂ YankeÂ Â Â |Â KuihuaÂ BaodianÂ |Â Â Â Â 88Â |</div><div class="line">|Â DingÂ DianÂ Â Â |Â KuihuaÂ BaodianÂ |Â Â Â Â 89Â |</div><div class="line">|Â ShiÂ QingÂ Â Â Â |Â HamoÂ GongÂ Â Â Â Â Â |Â Â Â Â 96Â |</div><div class="line">|Â XiÂ RenÂ Â Â Â Â Â |Â HamoÂ GongÂ Â Â Â Â Â |Â Â Â Â 86Â |</div><div class="line">|Â XiÂ RenÂ Â Â Â Â Â |Â DagouÂ BangfaÂ Â Â |Â Â Â Â 83Â |</div><div class="line">|Â LinÂ DaiyuÂ Â Â |Â JinsheÂ JianfaÂ Â |Â Â Â Â 93Â |</div><div class="line">+<span class="comment">-------------+----------------+-------+</span></div></pre></td></tr></table></figure><h3 id="3ã€æ±‚å‰8ä½åŒå­¦æ¯ä½åŒå­¦è‡ªå·±ä¸¤é—¨è¯¾çš„å¹³å‡æˆç»©ï¼Œå¹¶æŒ‰é™åºæ’åˆ—ï¼›"><a href="#3ã€æ±‚å‰8ä½åŒå­¦æ¯ä½åŒå­¦è‡ªå·±ä¸¤é—¨è¯¾çš„å¹³å‡æˆç»©ï¼Œå¹¶æŒ‰é™åºæ’åˆ—ï¼›" class="headerlink" title="3ã€æ±‚å‰8ä½åŒå­¦æ¯ä½åŒå­¦è‡ªå·±ä¸¤é—¨è¯¾çš„å¹³å‡æˆç»©ï¼Œå¹¶æŒ‰é™åºæ’åˆ—ï¼›"></a>3ã€æ±‚å‰8ä½åŒå­¦æ¯ä½åŒå­¦è‡ªå·±ä¸¤é—¨è¯¾çš„å¹³å‡æˆç»©ï¼Œå¹¶æŒ‰é™åºæ’åˆ—ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ Name,avg(Score)Â FROMÂ (SELECTÂ Â *Â FROMÂ studentsÂ LIMITÂ 8)Â ASÂ rjÂ LEFTÂ JOINÂ scoresÂ AS</div><div class="line">jrÂ ONÂ rj.StuID=jr.StuIDÂ GROUPÂ BYÂ NameÂ ORDERÂ BYÂ avg(Score)Â DESC;</div><div class="line">+<span class="comment">-------------+------------+</span></div><div class="line">|Â NameÂ Â Â Â Â Â Â Â |Â avg(Score)Â |</div><div class="line">+<span class="comment">-------------+------------+</span></div><div class="line">|Â ShiÂ QingÂ Â Â Â |Â Â Â Â 96.0000Â |</div><div class="line">|Â ShiÂ ZhongyuÂ |Â Â Â Â 85.0000Â |</div><div class="line">|Â XiÂ RenÂ Â Â Â Â Â |Â Â Â Â 84.5000Â |</div><div class="line">|Â XieÂ YankeÂ Â Â |Â Â Â Â 81.5000Â |</div><div class="line">|Â DingÂ DianÂ Â Â |Â Â Â Â 80.0000Â |</div><div class="line">|Â LinÂ DaiyuÂ Â Â |Â Â Â Â 75.0000Â |</div><div class="line">|Â ShiÂ PotianÂ Â |Â Â Â Â 72.0000Â |</div><div class="line">|Â YuÂ YutongÂ Â Â |Â Â Â Â 51.0000Â |</div><div class="line">+<span class="comment">-------------+------------+</span></div></pre></td></tr></table></figure><h3 id="4ã€æ˜¾ç¤ºæ¯é—¨è¯¾ç¨‹è¯¾ç¨‹åç§°åŠå­¦ä¹ äº†è¿™é—¨è¯¾çš„åŒå­¦çš„ä¸ªæ•°ï¼›"><a href="#4ã€æ˜¾ç¤ºæ¯é—¨è¯¾ç¨‹è¯¾ç¨‹åç§°åŠå­¦ä¹ äº†è¿™é—¨è¯¾çš„åŒå­¦çš„ä¸ªæ•°ï¼›" class="headerlink" title="4ã€æ˜¾ç¤ºæ¯é—¨è¯¾ç¨‹è¯¾ç¨‹åç§°åŠå­¦ä¹ äº†è¿™é—¨è¯¾çš„åŒå­¦çš„ä¸ªæ•°ï¼›"></a>4ã€æ˜¾ç¤ºæ¯é—¨è¯¾ç¨‹è¯¾ç¨‹åç§°åŠå­¦ä¹ äº†è¿™é—¨è¯¾çš„åŒå­¦çš„ä¸ªæ•°ï¼›</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ courses.Course,count(rj.StuID)Â FROMÂ scoresÂ ASÂ rjÂ LEFTÂ JOINÂ coursesÂ ONÂ courses.CourseID=rj.CourseIDÂ GROUPÂ BYÂ rj.CourseID;</div><div class="line">+<span class="comment">----------------+-----------------+</span></div><div class="line">|Â CourseÂ Â Â Â Â Â Â Â Â |Â count(rj.StuID)Â |</div><div class="line">+<span class="comment">----------------+-----------------+</span></div><div class="line">|Â HamoÂ GongÂ Â Â Â Â Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 3Â |</div><div class="line">|Â KuihuaÂ BaodianÂ |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 4Â |</div><div class="line">|Â JinsheÂ JianfaÂ Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â TaijiÂ QuanÂ Â Â Â Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â DaiyuÂ ZanghuaÂ Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â WeituoÂ ZhangÂ Â Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â DagouÂ BangfaÂ Â Â |Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 2Â |</div><div class="line">+<span class="comment">----------------+-----------------+</span></div></pre></td></tr></table></figure><h2 id="å››ã€æ€è€ƒé¢˜"><a href="#å››ã€æ€è€ƒé¢˜" class="headerlink" title="å››ã€æ€è€ƒé¢˜"></a>å››ã€æ€è€ƒé¢˜</h2><h3 id="1ã€å¦‚ä½•æ˜¾ç¤ºå…¶å¹´é¾„å¤§äºå¹³å‡å¹´é¾„çš„åŒå­¦çš„åå­—ï¼Ÿ"><a href="#1ã€å¦‚ä½•æ˜¾ç¤ºå…¶å¹´é¾„å¤§äºå¹³å‡å¹´é¾„çš„åŒå­¦çš„åå­—ï¼Ÿ" class="headerlink" title="1ã€å¦‚ä½•æ˜¾ç¤ºå…¶å¹´é¾„å¤§äºå¹³å‡å¹´é¾„çš„åŒå­¦çš„åå­—ï¼Ÿ"></a>1ã€å¦‚ä½•æ˜¾ç¤ºå…¶å¹´é¾„å¤§äºå¹³å‡å¹´é¾„çš„åŒå­¦çš„åå­—ï¼Ÿ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ Name,AgeÂ FROMÂ studentsÂ WHEREÂ AgeÂ &gt;Â (SELECTÂ avg(Age)Â FROMÂ students);</div><div class="line">+<span class="comment">--------------+-----+</span></div><div class="line">|Â NameÂ Â Â Â Â Â Â Â Â |Â AgeÂ |</div><div class="line">+<span class="comment">--------------+-----+</span></div><div class="line">|Â XieÂ YankeÂ Â Â Â |Â Â 53Â |</div><div class="line">|Â DingÂ DianÂ Â Â Â |Â Â 32Â |</div><div class="line">|Â ShiÂ QingÂ Â Â Â Â |Â Â 46Â |</div><div class="line">|Â TianÂ BoguangÂ |Â Â 33Â |</div><div class="line">|Â SunÂ DashengÂ Â |Â 100Â |</div><div class="line">+<span class="comment">--------------+-----+</span></div></pre></td></tr></table></figure><h3 id="2ã€å¦‚ä½•æ˜¾ç¤ºå…¶å­¦ä¹ çš„è¯¾ç¨‹ä¸ºç¬¬1ã€2ï¼Œ4æˆ–ç¬¬7é—¨è¯¾çš„åŒå­¦çš„åå­—ï¼Ÿ"><a href="#2ã€å¦‚ä½•æ˜¾ç¤ºå…¶å­¦ä¹ çš„è¯¾ç¨‹ä¸ºç¬¬1ã€2ï¼Œ4æˆ–ç¬¬7é—¨è¯¾çš„åŒå­¦çš„åå­—ï¼Ÿ" class="headerlink" title="2ã€å¦‚ä½•æ˜¾ç¤ºå…¶å­¦ä¹ çš„è¯¾ç¨‹ä¸ºç¬¬1ã€2ï¼Œ4æˆ–ç¬¬7é—¨è¯¾çš„åŒå­¦çš„åå­—ï¼Ÿ"></a>2ã€å¦‚ä½•æ˜¾ç¤ºå…¶å­¦ä¹ çš„è¯¾ç¨‹ä¸ºç¬¬1ã€2ï¼Œ4æˆ–ç¬¬7é—¨è¯¾çš„åŒå­¦çš„åå­—ï¼Ÿ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ rj.Name,scores.CourseIDÂ FROMÂ studentsÂ ASÂ rjÂ LEFTÂ JOINÂ scoresÂ ONÂ scores.StuIDÂ =Â rj.StuIDÂ WHEREÂ scores.CourseIDÂ INÂ (1,2,4,7);</div><div class="line">+<span class="comment">-------------+----------+</span></div><div class="line">|Â NameÂ Â Â Â Â Â Â Â |Â CourseIDÂ |</div><div class="line">+<span class="comment">-------------+----------+</span></div><div class="line">|Â ShiÂ ZhongyuÂ |Â Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â ShiÂ PotianÂ Â |Â Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â XieÂ YankeÂ Â Â |Â Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â DingÂ DianÂ Â Â |Â Â Â Â Â Â Â Â 2Â |</div><div class="line">|Â YuÂ YutongÂ Â Â |Â Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â YuÂ YutongÂ Â Â |Â Â Â Â Â Â Â Â 7Â |</div><div class="line">|Â ShiÂ QingÂ Â Â Â |Â Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â XiÂ RenÂ Â Â Â Â Â |Â Â Â Â Â Â Â Â 1Â |</div><div class="line">|Â XiÂ RenÂ Â Â Â Â Â |Â Â Â Â Â Â Â Â 7Â |</div><div class="line">|Â LinÂ DaiyuÂ Â Â |Â Â Â Â Â Â Â Â 4Â |</div><div class="line">+<span class="comment">-------------+----------+</span></div></pre></td></tr></table></figure><h3 id="3ã€å¦‚ä½•æ˜¾ç¤ºå…¶æˆå‘˜æ•°æœ€å°‘ä¸º3ä¸ªçš„ç­çº§çš„åŒå­¦ä¸­å¹´é¾„å¤§äºåŒç­åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ï¼Ÿ"><a href="#3ã€å¦‚ä½•æ˜¾ç¤ºå…¶æˆå‘˜æ•°æœ€å°‘ä¸º3ä¸ªçš„ç­çº§çš„åŒå­¦ä¸­å¹´é¾„å¤§äºåŒç­åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ï¼Ÿ" class="headerlink" title="3ã€å¦‚ä½•æ˜¾ç¤ºå…¶æˆå‘˜æ•°æœ€å°‘ä¸º3ä¸ªçš„ç­çº§çš„åŒå­¦ä¸­å¹´é¾„å¤§äºåŒç­åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ï¼Ÿ"></a>3ã€å¦‚ä½•æ˜¾ç¤ºå…¶æˆå‘˜æ•°æœ€å°‘ä¸º3ä¸ªçš„ç­çº§çš„åŒå­¦ä¸­å¹´é¾„å¤§äºåŒç­åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ï¼Ÿ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ students.name,students.age,tp.classid,tp.vgÂ FROMÂ students,(SELECTÂ classid,COUNT(stuid)Â </div><div class="line">ASÂ cs,AVG(age)Â ASÂ vgÂ FROMÂ studentsÂ GROUPÂ BYÂ classidÂ HAVINGÂ csÂ &gt;=3)Â ASÂ tpÂ WHEREÂ Â students.age&gt;tp.vgÂ ANDÂ students.classid=tp.classid;</div><div class="line">+<span class="comment">---------------+-----+---------+---------+</span></div><div class="line">|Â nameÂ Â Â Â Â Â Â Â Â Â |Â ageÂ |Â classidÂ |Â vgÂ Â Â Â Â Â |</div><div class="line">+<span class="comment">---------------+-----+---------+---------+</span></div><div class="line">|Â ShiÂ PotianÂ Â Â Â |Â Â 22Â |Â Â Â Â Â Â Â 1Â |Â 20.5000Â |</div><div class="line">|Â XieÂ YankeÂ Â Â Â Â |Â Â 53Â |Â Â Â Â Â Â Â 2Â |Â 36.0000Â |</div><div class="line">|Â DingÂ DianÂ Â Â Â Â |Â Â 32Â |Â Â Â Â Â Â Â 4Â |Â 24.7500Â |</div><div class="line">|Â YuÂ YutongÂ Â Â Â Â |Â Â 26Â |Â Â Â Â Â Â Â 3Â |Â 20.2500Â |</div><div class="line">|Â YuanÂ ChengzhiÂ |Â Â 23Â |Â Â Â Â Â Â Â 6Â |Â 20.7500Â |</div><div class="line">|Â XuÂ ZhuÂ Â Â Â Â Â Â Â |Â Â 21Â |Â Â Â Â Â Â Â 1Â |Â 20.5000Â |</div><div class="line">|Â LinÂ ChongÂ Â Â Â Â |Â Â 25Â |Â Â Â Â Â Â Â 4Â |Â 24.7500Â |</div><div class="line">|Â HuaÂ RongÂ Â Â Â Â Â |Â Â 23Â |Â Â Â Â Â Â Â 7Â |Â 19.6667Â |</div><div class="line">|Â HuangÂ YueyingÂ |Â Â 22Â |Â Â Â Â Â Â Â 6Â |Â 20.7500Â |</div><div class="line">+<span class="comment">---------------+-----+---------+---------+</span></div></pre></td></tr></table></figure><h3 id="4ã€ç»Ÿè®¡å„ç­çº§ä¸­å¹´é¾„å¤§äºå…¨æ ¡åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ã€‚"><a href="#4ã€ç»Ÿè®¡å„ç­çº§ä¸­å¹´é¾„å¤§äºå…¨æ ¡åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ã€‚" class="headerlink" title="4ã€ç»Ÿè®¡å„ç­çº§ä¸­å¹´é¾„å¤§äºå…¨æ ¡åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ã€‚"></a>4ã€ç»Ÿè®¡å„ç­çº§ä¸­å¹´é¾„å¤§äºå…¨æ ¡åŒå­¦å¹³å‡å¹´é¾„çš„åŒå­¦ã€‚</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt;Â SELECTÂ rj.Name,rj.AgeÂ FROMÂ studentsÂ ASÂ rjÂ LEFTÂ JOINÂ classesÂ ASÂ jrÂ ONÂ Â </div><div class="line">rj.ClassID=jr.ClassIDÂ WHEREÂ rj.ClassID=jr.ClassIDÂ ANDÂ AgeÂ &gt;Â (SELECTÂ AVG(Age)Â FROMÂ students);</div><div class="line">+<span class="comment">--------------+-----+</span></div><div class="line">|Â NameÂ Â Â Â Â Â Â Â Â |Â AgeÂ |</div><div class="line">+<span class="comment">--------------+-----+</span></div><div class="line">|Â XieÂ YankeÂ Â Â Â |Â Â 53Â |</div><div class="line">|Â DingÂ DianÂ Â Â Â |Â Â 32Â |</div><div class="line">|Â ShiÂ QingÂ Â Â Â Â |Â Â 46Â |</div><div class="line">|Â TianÂ BoguangÂ |Â Â 33Â |</div><div class="line">+<span class="comment">--------------+-----+</span></div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ä»å¤´å¼€å§‹äº†è§£Hyperledger</title>
      <link href="/2018/02/15/hyperledger%E5%AD%A6%E4%B9%A0/"/>
      <url>/2018/02/15/hyperledger%E5%AD%A6%E4%B9%A0/</url>
      <content type="html"><![CDATA[<h1 id="ä»å¤´å¼€å§‹äº†è§£Hyperledger"><a href="#ä»å¤´å¼€å§‹äº†è§£Hyperledger" class="headerlink" title="ä»å¤´å¼€å§‹äº†è§£Hyperledger"></a>ä»å¤´å¼€å§‹äº†è§£Hyperledger</h1><p><img src="images/fabric.png" alt=""></p><h2 id="Hyperledgerè¯æ±‡è¡¨"><a href="#Hyperledgerè¯æ±‡è¡¨" class="headerlink" title="Hyperledgerè¯æ±‡è¡¨"></a>Hyperledgerè¯æ±‡è¡¨</h2><ul><li>Anchor Peer -é”šèŠ‚ç‚¹</li></ul><p>é”šèŠ‚ç‚¹æ˜¯é€šé“ä¸­èƒ½è¢«æ‰€æœ‰å¯¹ç­‰èŠ‚ç‚¹æ¢æµ‹ã€å¹¶èƒ½ä¸ä¹‹è¿›è¡Œé€šä¿¡çš„ä¸€ç§å¯¹ç­‰èŠ‚ç‚¹;<br>é€šé“ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½æœ‰ä¸€ä¸ª(æˆ–è€…å¤šä¸ªï¼Œä»¥é˜²å•ç‚¹æ•…éšœ) é”šèŠ‚ç‚¹ ;<br>å…è®¸å±äºä¸åŒæˆå‘˜èº«ä»½çš„èŠ‚ç‚¹æ¥å‘ç°é€šé“ä¸­å­˜åœ¨çš„å…¶å®ƒèŠ‚ç‚¹;   </p><ul><li>Block - åŒºå—</li></ul><p>åœ¨ä¸€ä¸ªé€šé“ä¸Šï¼Œ(åŒºå—æ˜¯)ä¸€ç»„æœ‰åºäº¤æ˜“çš„é›†åˆ;<br>åŒºå—å¾€å¾€é€šè¿‡å¯†ç å­¦æ‰‹æ®µ(Hashå€¼)è¿æ¥åˆ°å‰å¯¼åŒºå—;<br>åŒºå—æ˜¯ä¸€ç»„æœ‰åºçš„äº¤æ˜“é›†åˆï¼Œåœ¨é€šé“ä¸­ç»è¿‡åŠ å¯†ç (å“ˆå¸ŒåŠ å¯†ï¼Œåä¸å‰åºåŒºå—è¿æ¥)ï¼›  </p><ul><li>Chain - é“¾ </li></ul><p>chainå°±æ˜¯blockä¹‹é—´ä»¥hashè¿æ¥ä¸ºç»“æ„çš„äº¤æ˜“æ—¥å¿—ã€‚peerä»order serviceæ¥æ”¶äº¤æ˜“block;<br>å¹¶æ ¹æ®èƒŒä¹¦ç­–å’Œå¹¶å‘å†²çªæ ‡è®°blockä¸Šäº¤æ˜“æ˜¯å¦æœ‰æ•ˆ;<br>ç„¶åå°†è¯¥blockè¿½å›åˆ°pperæ–‡ä»¶ç³»ç»Ÿä¸­çš„hash chain </p><p>å¸æœ¬çš„é“¾æ˜¯ä¸€ä¸ªäº¤æ˜“åŒºå—ç»è¿‡â€å“ˆå¸Œè¿æ¥â€ç»“æ„åŒ–çš„äº¤æ˜“æ—¥å¿—;<br>å¯¹ç­‰èŠ‚ç‚¹ä»æ’åºæœåŠ¡æ”¶åˆ°äº¤äº¤æ˜“åŒºå—;<br>åŸºäºèƒŒä¹¦ç­–ç•¥å’Œå¹¶å‘å†²çªæ¥æ ‡æ³¨åŒºå—çš„äº¤æ˜“ä¸ºæœ‰æ•ˆæˆ–è€…æ— æ•ˆçŠ¶æ€;<br>å¹¶ä¸”å°†åŒºå—è¿½å›åˆ°ç­‰ç»“ç‚¹æ–‡ä»¶ç³»ç»Ÿçš„å“ˆå¸Œé“¾ä¸­;   </p><ul><li>Chaincode-é“¾ç    </li></ul><p>é“¾ç æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨å¸æœ¬ä¸Šçš„è½¯ä»¶ï¼Œå®ƒå¯ä»¥å¯¹èµ„äº§è¿‡è¡Œç¼–ç ;<br>å…¶ä¸­çš„äº¤æ˜“æŒ‡ä»¤(æˆ–è€…å«ä¸šåŠ¡é€»è¾‘)ä¹Ÿå‘†ä»¥ç”¨æ¥ä¿®æ”¹èµ„äº§;  </p><ul><li>Channel-é€šé“ </li></ul><p>é€šé“æ˜¯æ„å»ºåœ¨â€Fabricâ€ç½‘ç»œä¸Šçš„ç§æœ‰åŒºå—é“¾ï¼Œå®ç°äº†æ•°æ®çš„éš”ç¦»å’Œä¿å¯†;<br>é€šé“ç‰¹å®šçš„å¸æœ¬åœ¨é€šé“ä¸­æ˜¯ä¸æ‰€æœ‰å¯¹ç­‰èŠ‚ç‚¹å…±äº«çš„;<br>å¹¶ä¸”äº¤æ˜“æ–¹å¿…é¡»é€šè¿‡è¯¥é€šé“çš„æ­£ç¡®éªŒè¯æ‰èƒ½ä¸è´¦æœ¬è¿›è¡Œäº¤äº’;<br>é€šé“æ˜¯ç”±ä¸€ä¸ªâ€é…ç½®å—â€æ¥å®šä¹‰çš„;  </p><ul><li>Commitment-æäº¤ </li></ul><p>ä¸€ä¸ªé€šé“ä¸­çš„æ¯ä¸ªå¯¹ç­‰èŠ‚ç‚¹éƒ½ä¼šéš¾äº¤æ˜“çš„æœ‰åºåŒºå—ï¼Œç„¶åå°†åŒºå—æäº¤è‡³è¯¥é€šé“ä¸Šå¸æœ¬çš„å„ä¸ªå‰¯æœ¬;<br>å¯¹ç­‰èŠ‚ç‚¹ä¹Ÿä¼šç¥¨æˆ¿æ¯ä¸ªåŒºå—ä¸­çš„æ¯ç¬”äº¤æ˜“çš„çŠ¶æ€ æ˜¯æœ‰æ•ˆæˆ–è€…æ— æ•ˆ;  </p><ul><li>Concurrency Control Version Check- å¹¶å‘æ§åˆ¶ç‰ˆæœ¬æ£€æŸ¥(CCVC)</li></ul><p>CCVCæ˜¯ä¿æŒé€šé“ä¸­å„å¯¹ç­‰èŠ‚ç‚¹çŠ¶æ€åŒæ­¥çš„ä¸€ç§æ–¹æ³•ã€‚å¯¹ç­‰èŠ‚ç‚¹å¹¶è¡Œçš„äº¤æ˜“ï¼›<br>åœ¨äº¤æ˜“æäº¤åˆ°å¸æœ¬ä¹‹å‰ï¼Œå¯¹ç­‰èŠ‚ç‚¹ä¼šæ£€æŸ¥äº¤æ˜“åœ¨æ‰§è¡ŒæœŸé—´è¯»åˆ°çš„æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹;<br>å¦‚æœè¯»å–çš„æ•°æ®åœ¨æ‰§è¡Œå’Œæäº¤ä¹‹é—´è¢«æ”¹å˜ï¼Œå°±ä¼šå¼•å‘CCVCå†²çª;<br>è¯¥äº¤æ˜“å°±ä¼šåœ¨å¸æœ¬ä¸­è¢«æ ‡è®°ä¸ºæ— æ•ˆï¼Œè€Œä¸”å€¼ä¸ä¼šæ›´æ–°åˆ°çŠ¶æ€æ•°æ®åº“;   </p><ul><li>Configuration Block - é…ç½®åŒºå—</li></ul><p>åŒ…å«ä¸ºç³»ç»Ÿé“¾(æ’åºæœåŠ¡)æˆ–é€šé“å®šä¹‰æˆå‘˜å’Œç­–ç•¥çš„é…ç½®æ•°æ®ã€‚å¯¹æŸä¸ªé€šé“æˆ–æ•´ä¸ªç½‘ç»œçš„ä¿®æ”¹;<br>(æ¯”å¦‚ï¼Œæˆå‘˜ç¦»å¼€æˆ–åŠ å…¥)éƒ½å°†å¯¼è‡´ç”Ÿæˆä¸€ä¸ªæ–°çš„é…ç½®åŒºå—å¹¶è¿½å›åˆ°é€‚å½“çš„é“¾ä¸Š;<br>è¿™ä¸ªé…ç½®åŒºå—ä¼šåŒ…å«åˆ›å§‹åŒºå—çš„å†…å®¹åŠ ä¸Šå¢é‡;   </p><ul><li>Consensus - å…±è¯† </li></ul><p>å…±è¯†æ˜¯è´¯ç©¿æ•´ä¸ªäº¤æ˜“æµç¨‹çš„å¹¿ä¹‰æœ¯è¯­ï¼Œå…¶ç”¨äºäº§ç”Ÿä¸ªå¯¹äºæ’åºçš„åŒæ„ä¹¦å’Œç¡®è®¤æ„æˆåŒºå—çš„äº¤æ˜“é›†çš„æ­£ç¡®æ€§;   </p><ul><li>Current State -å½“å‰çŠ¶æ€  </li></ul><p>ledgerçš„current stateè¡¨ç¤ºå…¶chainäº¤æ˜“logä¸­æ‰€æœ‰keyçš„æœ€æ–°å€¼ã€‚peerä¼šå°†å¤„ç†è¿‡çš„blockä¸­çš„æ¯ä¸ªäº¤æ˜“;<br>å¯¹åº”çš„ä¿®æ”¹valueæäº¤åˆ°ledgerå’Œcurrent stateã€‚ç”±äºcurrent state è¡¨ç¤ºchannelæ‰€çŸ¥çš„æ‰€æœ‰æœ€æ–°çš„k-v;<br>æ‰€ä»¥current stateä¹Ÿè¢«ç§°ä¸ºWorld State. Chaincodeæ‰§è¡Œäº¤æ˜“proposalå°±æ˜¯é’ˆå¯¹çš„current state;   </p><ul><li>Dynamic Membership -åŠ¨æ€æˆå‘˜</li></ul><p>Fabricæ”¯æŒåŠ¨æ€æ·»åŠ -ç§»é™¤memberã€peer å’ŒorderingæœåŠ¡èŠ‚ç‚¹ï¼Œè€Œä¸ä¼šå½±å“æ•´ä¸ªç½‘ç»œçš„æ“ä½œæ€§;<br>å½“ä¸šåŠ¡å…³ç³»è°ƒæ•´æˆ–å› å„ç§åŸå› éœ€æ·»åŠ -ç§»é™¤å®ä½“æ—¶ï¼ŒDynamic Membership è‡³å…³é‡è¦ï¼›  </p><ul><li>Endorsement-èƒŒä¹¦</li></ul><p>Endorsementæ˜¯æŒ‡ä¸€ä¸ªpeeræ‰§è¡Œä¸€ä¸ªäº¤æ˜“å¹¶è¿”å›YES-NOç»™ç”Ÿæˆäº¤æ˜“proposalçš„client appçš„è¿‡ç¨‹;<br>chaincodeå…·æœ‰ç›¸åº”çš„endorsement policies.å…¶ä¸­æŒ‡å®šäº†endorsing peer;   </p><ul><li>Endorsement plolicy - èƒŒä¹¦ç­–ç•¥ </li></ul><p>Endorsement policyå®šä¹‰äº†ä¾èµ–äºç‰¹å®šchaincodeæ‰§è¡Œäº¤æ˜“çš„channelä¸Šçš„peerå’Œå“åº”ç»“æœ;<br>(endorsements) çš„å¿…è¦ç»„åˆæ¡ä»¶(å³åå›Yesæˆ–NOçš„æ¡ä»¶)ã€‚ Endorsement policyå¯ä»¥æŒ‡å®šå¯¹äºæŸä¸€chaincode;<br>å¯ä»¥å¯¹äº¤æ˜“èƒŒä¹¦çš„æœ€å°èƒŒä¹¦èŠ‚ç‚¹æˆ–è€…æœ€å°èƒŒä¹¦èŠ‚ç‚¹ç™¾åˆ†æ¯”;<br>èƒŒä¹¦ç­–ç•¥ç”±èƒŒä¹¦èŠ‚ç‚¹åŸºäºåº”ç”¨ç¨‹åºå’Œå¯¹æŠµå¾¡ä¸è‰¯è¡Œä¸ºçš„æœŸæœ›æ°´æ¥æ¥ç»„ç»‡ç®¡ç†;<br>åœ¨installå’Œinstantiate Chaincode (deploy tx)æ—¶éœ€è¦æŒ‡å®šèƒŒä¹¦ç­–ç•¥;   </p><ul><li>Fabric-ca  </li></ul><p>Fabric-caæ˜¯é»˜è®¤çš„è¯ä¹¦ç®¡ç†ç»„ä»¶ï¼Œå®ƒå‘ç½‘ç»œæˆå‘˜åŠå…¶ç”¨æˆ·é¢å‘åŸºäºPKIçš„è¯ä¹¦;<br>CAä¸ºæ¯ä¸ªæˆå‘˜é¢å‘ä¸€ä¸ªæ ¹è¯ä¹¦(RootCert),ä¸ºæ¯ä¸ªæˆæƒç”¨æˆ·é¢å‘ä¸€ä¸ªæ³¨å†Œè¯ä¹¦(eCert);<br>ä¸ºæ¯ä¸ªæ³¨å†Œè¯ä¹¦é¢å‘å¤§é‡äº¤æ˜“è¯ä¹¦(tCerts);   </p><ul><li>Genesis Block - åˆå§‹åŒºå—</li></ul><p>Genesis Blockæ˜¯åˆå§‹åŒ–åŒºå—é“¾ç½‘ç»œæˆ–channelçš„é…ç½®å—ï¼Œä¹Ÿæ˜¯é“¾ä¸Šçš„æ¯ä¸€ä¸ªåŒºå—;   </p><ul><li>Gossip Protocol - Gossip åè®® </li></ul><p>Gossiopæ•°æ®ä¼ è¾“åè®®æœ‰ä¸‰é¡¹åŠŸèƒ½ </p><p>1.ç®¡ç†peerå‘å’Œchannelæˆå‘˜;<br>2.channelä¸Šçš„æ‰€æœ‰peeré—´å¹¿æ’­å¸æœ¬æ•°æ®;<br>3.channelä¸Šçš„æ‰€æœ‰peeré—´åŒæ­¥æ”¶æœ¬æ•°æ®;  </p><ul><li>Initialize- åˆå§‹åŒ– </li></ul><p>ä¸€ä¸ªåˆå§‹åŒ–chaincodeç¨‹åºçš„æ–¹æ³•;  </p><ul><li>Install -å®‰è£… </li></ul><p>å°†chaincodeæ”¾åˆ°peerçš„æ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹;</p><ul><li>Instantiate - å®ä¾‹åŒ–</li></ul><p>å¯åŠ¨chaincodeå®¹å™¨çš„è¿‡ç¨‹; </p><ul><li>Invoke - è°ƒç”¨</li></ul><p>ç”¨äºè°ƒç”¨ chaincodeå†…çš„å‡½æ•°; Chaincode invokeå°±æ˜¯ä¸€ä¸ªäº¤æ˜“proposal;<br>ç„¶åæ‰§è¡Œæ¨¡å—åŒ–çš„æµç¨‹(èƒŒä¹¦ã€å…±è¯†ã€éªŒè¯ã€æäº¤);<br>invokeçš„ç»“æ„å°±æ˜¯ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªå‚æ•°æ•°ç»„;   </p><ul><li>Leading Peer - ä¸»å¯¼èŠ‚ç‚¹</li></ul><p>æ¯ä¸€ä¸ªMemberåœ¨å…¶è®¢é˜…çš„channelä¸Šå¯ä»¥æ‹¥æœ‰å¤šä¸ªpeerï¼›<br>å…¶ä¸­ä¸€ä¸ªpeerä¼šä½œä¸ºchanelçš„leading peer ä»£è¡¨è¯¥Memberä¸ordering service é€šä¿¡;<br>ordering service å°†blockä¼ é€’ç»™leading peerdï¼Œ è¯¥peerå†å°†æ­¤blockåˆ†å‘ç»™åŒä¸€memerä¸‹çš„å…¶ä»–peer; </p><ul><li>Ledger - å¸æœ¬</li></ul><p>Ledgeræ˜¯ä¸ªchannelçš„chainå’Œç”±channelä¸­æ¯ä¸ªpeerç»´æŠ¤ çš„world stateï¼›  </p><ul><li>Member- æˆå‘˜ </li></ul><p>æ‹¥æœ‰ç½‘ç»œå”¯ä¸€æ ¹è¯ä¹¦çš„åˆæ³•ç‹¬ç«‹å®ä½“ã€‚åƒpeerèŠ‚ç‚¹å’Œapp clientè¿™æ ·çš„ç½‘ç»œç»„ä»¶ä¼šé“¾æ¥åˆ°ä¸€ä¸ªMember;   </p><ul><li>Membership Service Provider -MSP </li></ul><p>MSPæ˜¯æŒ‡ä¸ºclientå’Œpeeræä¾›è¯ä¹¦çš„ç³»ç»ŸæŠ½è±¡çº¿ä»¶ã€‚Cientç”¨è¯ä¹¦æ¥è°ä»–ä»¬çš„äº¤æ˜“;<br>peerç”¨è¯ä¹¦è®¤è¯å…¶äº¤æ˜“èƒŒä¹¦ã€‚è¯¥æ¥å£ä¸ç³»ç»Ÿçš„äº¤æ˜“å¤„ç†ç»„ä»¶å¯†åˆ‡ç›¸å…³;<br>æ—¨åœ¨ä½¿å·²å®šä¹‰çš„æˆå‘˜èº«ä»½æœåŠ¡ç»„ä»¶ä»¥è¿™ç§æ–¹å¼é¡ºåˆ©æŒºå¥½å…¥è€Œä¸ä¼šä¿®æ”¹ç³»ç»Ÿçš„äº¤æ˜“å¤„ç†ç»„ä»¶çš„æ ¸å¿ƒ;  </p><ul><li>Membership Services - æˆå‘˜æœåŠ¡  </li></ul><p>æˆå‘˜æœåŠ¡åœ¨è®¸å¯çš„åŒºå—é“¾ç½‘ç»œä¸Šè®¤è¯ã€æˆæƒå’Œç®¡ç†èº«ä»½ ;<br>åœ¨peerå’Œorderè¿è¡Œçš„æˆå‘˜æœåŠ¡çš„ä»£ç è€…ä¼šè®¤è¯å’ŒæˆæƒåŒºå—é“¾æ“ä½œ;<br>å®ƒæ˜¯åŸºäºPKIçš„MSPå®ç°; </p><p>fabric-caç»„ä»¶å®ç°äº†æˆå‘˜æœåŠ¡ï¼Œæ¥ç®¡ç†èº«ä»½ã€‚ç‰¹åˆ«çš„ï¼Œå®ƒå¤„ç†ECertå’ŒTCertçš„é¢å‘å’Œæ’¤é”€;  </p><p>ECertæ˜¯é•¿æœŸçš„èº«ä»½ä»»è¯; TCertæ˜¯çŸ­æœŸçš„èº«ä»½å‡­è¯ï¼Œæ˜¯åŒ¿åå’Œä¸å¯é“¾æ¥çš„;  </p><ul><li>Ordering Service -æ’åºæœåŠ¡æˆ–å…±è¯†æœåŠ¡ </li></ul><p>å°†äº¤æ˜“æ’åºæ”¾å…¥blockçš„èŠ‚ç‚¹çš„é›†åˆã€‚ordering service ç‹¬ç«‹äºpeeræµç¨‹ä¹‹å¤–;<br>å¹¶ä»¥å…ˆåˆ°å…ˆå¾—çš„æ–¹å¼ä¸ºç½‘ç»œä¸Šæ‰€æœ‰çš„channelä½œäº¤æ˜“æ’åº;<br>ordering service æ”¯æŒå¯æ’æ‹”å®ç°ï¼Œç›®å‰é»˜è®¤å®ç°äº†SOLOå’ŒKafka;<br>ordering serviceæ˜¯æ•´ä¸ªç½‘ç»œçš„å…¬ç”¨bindingï¼Œ åŒ…å«æ¯ä¸ªMemberç›¸å…³çš„åŠ å¯†ææ–™;  </p><ul><li>Peer -èŠ‚ç‚¹</li></ul><p>ä¸€ä¸ªç½‘ç»œå®ä½“ï¼Œç»´æŠ¤ledgerå¹¶è¿è¡ŒChaincodeå®¹å™¨æ¥å¯¹ledgerå¾ˆä¹–read-writeæ“ä½œ;<br>peerç”±Memberæ‹¥æœ‰å’Œç»´æŠ¤;  </p><ul><li>Policy-ç­–ç•¥  </li></ul><p>æœ‰èƒŒä¹¦ç­–ç•¥;æ ¡éªŒç­–ç•¥;åŒºå—æäº¤ç­–ç•¥;Chaincodeç®¡ç†ç­–ç•¥å’Œç½‘ç»œ-é€šé“ç®¡ç†ç­–ç•¥;  </p><ul><li>Proposal - ææ¡ˆ</li></ul><p>ä¸€ç§é’ˆå¯¹channelä¸­æŸpeerçš„èƒŒä¹¦è¯·æ±‚ã€‚æ¯ä¸ªproposalè¦ä¹ˆæ˜¯Chaincode instantiate è¦ä¹ˆæ˜¯Chaincode inovke;   </p><ul><li>Query- æŸ¥è¯¢ </li></ul><p>å¯¹äºcurrent stateä¸­æŸä¸ªkeyçš„valueçš„æŸ¥è¯¢è¯·æ±‚;  </p><ul><li>Software Development Kit -SDK </li></ul><p>SDkä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ä¸ªç»“æ„åŒ–çš„åº“ç¯å¢ƒï¼Œç”¨äºç¼–å†™å’Œæµ‹è¯•é“¾ç åº”ç”¨ç¨‹åºï¼›<br>SDKå®Œå…¨å¯ä»¥é€šè¿‡æ ‡å‡†æ¥å£å®ç°é…ç½®å’Œæ‰©å±•ï¼Œåƒç­¾åçš„åŠ å¯†ç®—æ³•;<br>æ—¥å¿—æ¡†æ¶å’Œstateå­˜å‚¨è¿™æ ·çš„ç»„ä»¶éƒ½å¯ä»¥è½»æ¾åœ°å®ç°æ›¿æ¢;<br>SDK API ä½¿ç”¨gRPCè¿›è¡Œäº¤æ˜“å¤„ç†ï¼Œæˆå‘˜æœåŠ¡ã€èŠ‚ç‚¹éå†ä»¥åŠäº‹ä»¶å¤„ç†éƒ½æ˜¯æ®æ­¤ä¸fabricé€šä¿¡;<br>ç›®å‰SDKæ”¯æŒNode.js Java å’Œpython ;  </p><ul><li>State Database - stateDB</li></ul><p>ä¸ºäº†ä»Chainncodeä¸­é«˜æ•ˆçš„è¯»å†™,Current stateæ•°æ®ç¤åœ¨stateDBä¸­ï¼Œ åŒ…æ‹¬levelDBå’ŒsouchDB; </p><ul><li>System chain-ç³»ç»Ÿé“¾</li></ul><p>åŒ…å«åœ¨ç³»ç»Ÿçº§å®šä¹‰ç½‘ç»œçš„é…ç½®åŒºå—ã€‚ç³»ç»Ÿé“¾å­˜åœ¨äºordering serviceä¸­;<br>å…·æœ‰åŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„åˆå§‹é…ç½®:MSPä¿¡æ¯ã€ç­–ç•¥å’Œä¿¡æ¯é…ç½®ã€‚å¯¹æ•´ä¸ªç½‘ç»œçš„ä»»ä½•å˜åŒ–;<br>(ä¾‹å¦‚æ–°çš„OråŠ å…¥æˆ–è€…æ·»åŠ æ–°çš„Ordering èŠ‚ç‚¹)å°†å¯¼è‡´æ–°çš„é…ç½®åŒºå—è¢«æ·»åŠ åˆ°ç³»ç»Ÿé“¾;   </p><p>Transaction- äº¤æ˜“</p><p>Caincodeçš„invokeæˆ–instantiateæ“ä½œ; Invokeæ˜¯ä»ledgerä¸­è¯·æ±‚read-write setï¼›<br>Instantiateæ˜¯è¯·æ±‚åœ¨peerä¸Šå¯åŠ¨Chaincodeå®¹å™¨;   </p><h2 id="äº†è§£Hyperledger-Farbic"><a href="#äº†è§£Hyperledger-Farbic" class="headerlink" title="äº†è§£Hyperledger Farbic"></a>äº†è§£Hyperledger Farbic</h2><p>Hyperledger Fabricæ˜¯ä¸€ä¸ªæä¾› åˆ†å¸ƒå¼è´¦æœ¬æ–¹æ¡ˆçš„å¹³å°ã€‚Hyperledger Fabricç”±æ¨¡å—åŒ–æ¶æ„æ”¯æ’‘;  å¹¶å…·å¤‡æä½³çš„ä¿å¯†æ€§ã€å¯ä¼¸ç¼©æ€§ã€çµæ´»æ€§å’Œå¯æ‰©å±•å¹³å°; Hyperledger Fabircè¢«è®¾è®¡æˆæ”¯æŒä¸åŒçš„æ¨¡å—ç»„ä»¶ç›´æ¥æ‹”æ’å¯åŠ¨;  å¹¶èƒ½é€‚åº”åœ¨ç»æµç”Ÿæ€ç³»ç»Ÿä¸­é”™ç»¼å¤æ‚çš„å’Œç§åœºæ™¯;   </p><p>Hyperledger Fabricæä¾›äº†ä¸€ä¸ªç‹¬ç‰¹çš„å¯ä¼¸ç¼©ã€å¯æ‰©å±•çš„æ¶æ„ï¼Œè¿™ä¹Ÿæ˜¯Hyperledger Fabricä¸å…¶ä»–åŒºå—çš„é“¾è§£å†³æ–¹æ¡ˆçš„æ˜¾è‘—åŒºåˆ«;å¦‚æœæ­£è®¡åˆ’éƒ¨ç½²å…·å¤‡å®Œæ•´å®¡æŸ¥æœºåˆ¶ä»¥åŠå¼€æºæ¶æ„çš„ä¼ä¸šçº§åŒºå—é“¾; Hyperledger Fabricæ˜Œä¸€ä¸ªä¸é”™çš„èµ·ç‚¹;   </p><h2 id="åŒºå—é“¾"><a href="#åŒºå—é“¾" class="headerlink" title="åŒºå—é“¾"></a>åŒºå—é“¾</h2><h3 id="åˆ†å¸ƒå¼è´¦æœ¬"><a href="#åˆ†å¸ƒå¼è´¦æœ¬" class="headerlink" title="åˆ†å¸ƒå¼è´¦æœ¬"></a>åˆ†å¸ƒå¼è´¦æœ¬</h3><p>ä¸€ä¸ªåŒºé“¾ç½‘ç»œçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è´¦æœ¬ï¼Œåœ¨è¿™ä¸ªè´¦æœ¬ä¸­è®°å½•äº†ç½‘ç»œå‘ç”Ÿçš„æ‰€æœ‰äº¤æ˜“ä¿¡æ¯;   </p><p>åŒºå—é“¾è´¦æœ¬é€šå¸¸è¢«å®šä¹‰ä¸ºå»ä¸­å¿ƒåŒ–ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ•´ä¸ªç½‘ç»œä¸­ï¼Œæ¯ä¸ªå‚ä¸è€…éƒ½ä¿å­˜ç€ä¸€ä¸ªåŒºå—é“¾è´¦æœ¬çš„å‰¯æœ¬ï¼Œæ‰€æœ‰å‚ä¸è€…é€šè¿‡åä½œ å…±åŒç»´æŠ¤ç€è´¦æœ¬; å»ä¸­å¿ƒåŒ–ä¸åä½œ è¿™ä¸¤ä¸ªç‰¹ç‚¹åœ¨ç°å®ä¸–ç•Œçš„å•†ä¸šè´§ç‰©äº¤æ˜“å’Œå•†åŠ¡æœåŠ¡ä¸­å±•å‡ºç°çš„æ˜¾è‘—ä¼˜ç‚¹;  </p><p>é™¤äº†å»ä¸­å¿ƒåŒ–ä¸åä½œï¼ŒåŒºé“¾é“¾çš„å¦ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹æ˜¯ä¿¡æ¯åœ¨åªèƒ½ä»¥â€é™„åŠ â€çš„æ–¹å¼è®°å½•åœ¨åŒºå—é“¾ä¸­;   åŒæ—¶ä½¿ç”¨åŠ å¯†ç æŠ€æœ¯ä¿éšœäº†äº¤æ˜“ä¸€æ—¦è¢«æ·»åŠ è¿›è´¦æœ¬ä¸­ï¼Œå°±æ— æ³•è¢«ç¯¡æ”¹ã€‚åŒºå—é“¾çš„è¿™ç§ä¸å¯ç¯¡æ”¹æ€§ä½¿å¾—ä¿¡æ¯æ¥æºçš„ç¡®è®¤å˜å¾—å¼‚å¸¸å®¹æ˜“ï¼Œè¿™æ˜¯ç”±äºå‚ä¸è€…å¯ä»¥è‚¯å®šä¿¡æ¯ä¸€æ—¦è¢«å†™å…¥åŒºå—é“¾ä¸­å°±å‡ ä¹ä¸å¯è¢« ç¯¡æ”¹ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåŒºå—é“¾å¸¸å¸¸ä¹Ÿè¢«ç§°ä¸ºè¯æ˜çš„ç³»ç»Ÿçš„åŸå› ;  </p><h3 id="æ™ºèƒ½åˆçº¦"><a href="#æ™ºèƒ½åˆçº¦" class="headerlink" title="æ™ºèƒ½åˆçº¦"></a>æ™ºèƒ½åˆçº¦</h3><p>ä¸ºäº†æŒç»­çš„è¿›è¡Œä¿¡æ¯çš„æ›´æ–°ï¼Œä»¥åŠå¸æœ¬è¿›è¡Œç®¡ç†(å†™å…¥äº¤æ˜“ï¼Œè¿›è¡ŒæŸ¥è¯¢ç­‰)ï¼ŒåŒºå—é“¾ç½‘ç»œå¼•å…¥äº†æ™ºèƒ½åˆçº¦æ¥å®ç°å¯¹è´¦æœ¬çš„è®¿é—®å’Œæ§åˆ¶;  </p><p>æ™ºèƒ½åˆçº¦ä¸ä»…ä»…å¯ç”¨äºåœ¨åŒºå—é“¾ç½‘ç»œä¸­æ‰“åŒ…ä¿¡æ¯ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥è¢«ç”¨äºè‡ªåŠ¨çš„æ‰§è¡Œç”±å‚ä¸è€…å®šä¹‰çš„ç‰¹å®šäº¤æ˜“æ“ä½œ;   </p><p>ä¾‹å¦‚,ä¹°å–åŒæ–¹è¦ä»¥å®šä¹‰ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œä»¥ä¿è¯å½“å–æ–¹å‘è´§çš„ç«¯å£è¿é€åˆ°è¾¾æ—¶ï¼Œä¹°æ–¹æ”¯ä»˜çš„è´§æ¬¾ä¼šè‡ªäºŒç”²åŒèƒè½¬å¸ç»™å–æ–¹;   </p><h3 id="å…±è¯†"><a href="#å…±è¯†" class="headerlink" title="å…±è¯†"></a>å…±è¯†</h3><p>ä¿æŒç½‘ç»œä¸­æ‰€æœ‰è´¦æœ¬äº¤æ˜“çš„åŒæ­¥æµç¨‹ï¼Œå°±æ˜¯å…±è¯†ã€‚å…±è¯†ä¿è¯ äº†è´¦æœ¬åªä¼šåœ¨äº¤æ˜“åŒæ–¹éƒ½ç¡®è®¤åæ‰è¿›è¡Œæ›´æ–°ã€‚åŒæ—¶åœ¨è´¦æœ¬æ›´æ–°æ—¶ï¼Œäº¤æ˜“åŒæ–¹èƒ½å¤Ÿåœ¨åœ¨è´¦æœ¬ä¸­çš„ç›¸åŒä½ç½® ï¼Œæ›´æ–°ä¸€ä¸ªç›¸åŒçš„äº¤æ˜“ä¿¡æ¯;   </p><p>##åŒºå—é“¾å› ä½•å¯è¡Œ </p><h3 id="å½“å‰çš„è®°å½•ç³»ç»Ÿ"><a href="#å½“å‰çš„è®°å½•ç³»ç»Ÿ" class="headerlink" title="å½“å‰çš„è®°å½•ç³»ç»Ÿ"></a>å½“å‰çš„è®°å½•ç³»ç»Ÿ</h3><p>è‡ªä»å•†ä¸šæ•°æ®è®°å½•ç½‘ç»œç³»ç»Ÿè¯ç”Ÿä»¥æ¥ï¼Œç›´åˆ°ä»Šå¤©çš„äº¤æ˜“ç½‘ç»œå¹¶ä¸éª¨å‘ç”Ÿå¤ªå¤§çš„å˜åŒ–;   åœ¨å•†ä¸šç½‘ç»œä¸­çš„æˆå‘˜è¿›è¡Œç›¸äº’äº¤æ˜“æ—¶ï¼Œä»–ä»¬å„è‡ªç»´æŠ¤ç€è‡ªå·±ç‹¬ç«‹çš„äº¤æ˜“è®°å½•ã€‚åŒæ—¶ï¼Œäººä»¬äº¤æ˜“çš„ç‰©å“â€“æ— è®ºæ˜¯16ä¸–çºªä½›å…°å¾·çš„æŒ‚æ¯¯ï¼Œè¿˜æ˜¯ç°ä»£çš„æœ‰ä»·è¯åˆ¸â€“éƒ½ä»»ç„¶éœ€è¦åœ¨æ¯æ¬¡å–å‡ºäº¤æ˜“è¿‡ç¨‹ä¸­æä¾›æ¥æºä¿¡æ¯ï¼Œä»¥ç¡®ä¿å–æ–¹æ‹¥æœ‰æ‰€å‡ºå”®ç«¯å£çš„æ‰€æœ‰æƒ;   </p><p>éšç€ç§‘æŠ€çš„è¿›æ­¥ï¼Œäº¤æ˜“æµç¨‹ä¸æ–­æ·±åŒ–å‘å±•ï¼Œç»å†äº†ä»ä½¿ç”¨ç”¨çŸ³ç¢‘ã€ä½¿ç”¨çº¸è´¨è´¦æœ¬ã€ä½¿ç”¨ç¡¬ç›˜å­˜å‚¨å™¨ç›´åˆ°ä½¿ç”¨äº‘è®¡ç®—å¹³å°çš„ä¸åŒé˜¶æ®µï¼Œä½†æµç¨‹çš„åº•å±‚æ¶æ„å¹¶æ²¡æœ‰å‘ç”Ÿä»»ä½•å˜åŒ–ã€‚å¹¶ä¸å­˜ä¸€ä¸ªå¯ä»¥ç»Ÿä¸€ç®¡ç†ç½‘ç»œå‚ä¸è€…èº«ä»½çš„ç³»ç»Ÿï¼Œç¡®è®¤å•†å“æ¥æºååˆ†è´¹åŠ²,å¸¸å¸¸ä¼šè€—è´¹æ•°å¤©çš„æ—¶é—´ æ˜ç¡®è¯åˆ¸çš„äº¤æ˜“(åŒ…å«æ•°ä»¥ä¸‡è®¡ç¾å…ƒçš„æ•°é‡)ã€‚äººä»¬å¿…éœ€ç­¾è®¢åˆçº¦å¹¶æ‰‹åŠ¨æ‰§è¡Œï¼Œæ¯ä¸€ä¸ªç³»ç»Ÿä¸­çš„æ•°æ®åº“éƒ½åŒ…å«ç€ç‹¬ç«‹ çš„ä¿¡æ¯å¹¶æœ€ç»ˆä»£è¡¨ä¸€ä¸ªå•ç‚¹çš„é”™è¯¯ã€‚  </p><p>åœ¨ä»Šå¤©çš„ä¿¡æ¯å’Œè¿‡ç¨‹å…±äº«æ–­è£‚çš„æ–¹æ³•ä¸­ï¼Œå»ºç«‹ä¸€ä¸ªè·¨è¶Šå•†ä¸šç½‘ç»œçš„è®°å½•ç³»ç»Ÿæ˜¯ä¸å¯èƒ½çš„ï¼Œå°½ç®¡å¯è§æ€§å’Œä¿¡ä»»çš„éœ€æ±‚æ˜¯æ˜ç¡®çš„;   </p><p>åŒºå—é“¾çš„ä¸åŒç‚¹</p><p>ä¸ºä»€ä¹ˆä¸ç”¨â€ç°ä»£â€çš„äº¤æ˜“ç³»ç»Ÿæ¥æ›¿ä»£è¿™ç§æ•ˆç‡ä½ä¸‹çš„ç½‘ç»œï¼Ÿæ–°çš„å•†ä¸šç½‘ç»œå¯ä»¥å…·æœ‰æ ‡å‡†çš„æ–¹æ³•å»ºç«‹èº«ä»½ä¿¡æ¯ï¼Œæ‰§è¡Œäº¤æ˜“ï¼Œå¹¶ä¸”å­˜å‚¨æ•°æ®ã€‚ä¸ºä»€ä¹ˆä¸å»ºç«‹ä¸€ä¸ªå¯ä½çš„äº¤æ˜“é“¾æ¡è®°å½•ï¼Ÿé€šè¿‡æŸ¥è¯¢è¿™ä¸ªé“¾æ¡ä¸Šçš„æ‰€æœ‰äº¤æ˜“ï¼Œæ¥ç¡®å®šäº¤æ˜“å•†å“æ¥æºï¼Œå¹¶ä¸”è¿™ä¸ªé“¾æ¡ä¸Šçš„ä¿¡æ¯ä¸€æ—¦è¢«å†™å…¥ï¼Œå°±æ— æ³•è¢«å†æ¬¡ç¯¡æ”¹;  </p><p>è¿™å°±æ˜¯åŒºå—é“¾ç½‘ç»œã€‚åœ¨åŒºå—é“¾ç½‘ç»œä¸­ï¼Œæ¯ä¸€ä¸ªå‚ä¸è€…éƒ½ä¿æœ‰ä¸€ä»½è´¦æœ¬çš„å‰¯æœ¬ã€‚åœ¨åŒºå—é“¾ç½‘ç»œä¸­ï¼Œä¸ä»…ä»…æ˜¯è´¦æœ¬ä¿¡æ¯ä¼šè¢«å…±äº«ï¼Œæ›´æ–°è´¦æœ¬çš„æµç¨‹æ˜¯å…±äº«çš„ã€‚ä¸åŒäºç›®å‰çš„ç³»ç»Ÿâ€“å‚ä¸è€…ä½¿ç”¨ç§æœ‰çš„ç¨‹åºå¯¹ç§èƒ¡çš„è´¦æœ¬è¿›è¡Œæ›´æ–°ï¼Œè€ŒåŒºå—é“¾ç³»ç»Ÿä½¿ç”¨å…±äº«çš„ç¨‹åºå¯¹å…±äº«çš„è´¦æœ¬è¿›è¡Œæ›´æ–°;   </p><p>é€šè¿‡ä½¿ç”¨å…±äº«è´¦åè°ƒæ•´ä¸ªå•†ä¸šç½‘ç»œï¼ŒåŒºå—é“¾ç½‘ç»œèƒ½å…å‡å°‘æ—¶é—´ã€æˆæœ¬ä»¥åŠéšç§ä¿¡æ¯æ³„éœ²çš„é£é™©ï¼Œå¹¶ä¸”èƒ½ä½¿ç”¨æµç¨‹æ›´åŠ å¯ä¿¡å’Œé€æ˜;   </p><h3 id="Hyperledger-Fabric"><a href="#Hyperledger-Fabric" class="headerlink" title="Hyperledger Fabric"></a>Hyperledger Fabric</h3><p>2015å¹´ï¼ŒLinuxåŸºé‡‘ä¼šå¯åŠ¨äº†Hyperledgeré¡¹ç›®ï¼Œhhsfiæ˜¯å‘å±•è·¨è¡Œä¸šçš„åŒºå—é“¾æŠ€æœ¯ã€‚Hyperledgeré¡¹ç›®å¹¶ä¸ä»…ä»…æ˜¯å®šä¹‰ä¸€ä¸ªå•ä¸€çš„åŒºå—é“¾æ ‡å‡†ï¼Œå®ƒæ›´é¼“åŠ±èƒ½è¿‡å¼€æºç¤¾åŒºçš„åŠ›é‡åä½œå¼€å‘åŒºå—é“¾æŠ€æœ¯ ;   </p><p>Hyperledger Fabricæ˜¯Hyperledgerä¸­çš„ä¸€ä¸ªåŒºå—é“¾é¡¹ç›®ã€‚ä¸å…¶ä»–åŒºå—é“¾æŠ€æœ¯ç±»ä¼¼, Hyperledger FabricåŒ…å«ä¸€ä¸ªè´¦æœ¬ï¼Œä½¿ç”¨æ™ºèƒ½åˆçº¦å¹¶ä¸”æ˜¯ä¸€ä¸ªé€šè¿‡æ‰€æœ‰å‚ä¸è€…ç®¡ç† äº¤æ˜“çš„ç³»ç»Ÿ;  </p><p>Hyperledger Fabric ä¸å…¶ä»–åŒºå—é“¾ç³»ç»Ÿæœ€å¤§çš„ä¸åŒä½“ç°åœ¨ç§æœ‰å’Œè®¸å¯ã€‚ä¸å¼€æ”¾æ— éœ€è®¸å¯çš„ç½‘ç»œç³»ç»Ÿå…è®¸æœªçŸ¥èº«ä»½çš„å‚ä¸è€…åŠ å…¥ç½‘ç»œä¸åŒ(éœ€è¦èƒ½è¿‡å·¥ä½œé‡è¯æ˜åè®®æ¥ä¿è¯äº¤æ˜“æœ‰æ•ˆå¹¶ç»´æŠ¤ç½‘ç»œçš„å®‰å…¨)ï¼ŒHyperledger Fabricé€šè¿‡Membership Service Provider(MSP)æ¥ç™»è®°æ‰€æœ‰çš„æˆå‘˜;   </p><p>Hyperledger Fabricä¹Ÿæä¾›äº†å¤šä¸ªå¯æ‹”æ’é€‰é¡¹ã€‚è´¦æœ¬æ•°æ®å¯è¢«å­˜å‚¨ä¸ºå¤šç§æ ¼å¼ï¼Œå…±è¯†æœºåˆ¶å¯è¢«æ¥å…¥æˆ–è€…æ–­å¼€ï¼ŒåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„MSPã€‚ </p><p>Hyperledger Fabricæä¾›äº†å»ºç«‹ channelçš„åŠŸèƒ½ï¼Œè¿™å…è®¸å‚ä¸è€…ä¸ºäº¤æ˜“æ–°å»ºä¸€ä¸ªå•ç‹¬çš„è´¦æœ¬ã€‚å½“ç½‘ç»œä¸­çš„ä¸€äº›å‚ä¸è€…æ˜¯ç«äº‰å¯¹æ‰‹æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½å˜å¾—å°¤ä¸ºé‡è¦ã€‚å› ä¸ºè¿™äº›å‚ä¸è€…å¹¶ä¸å¸Œæœ›æ‰€æœ‰çš„äº¤æ˜“ä¿¡æ¯â€“æ¯”å¦‚æä¾›ç»™éƒ¨åˆ†å®¢æˆ·çš„ç‰¹å®šä»·æ ¼ä¿¡æ¯â€“éƒ½å¯¹ç½‘ç»œä¸­æ‰€æœ‰å‚ä¸è€…å…¬å¼€ã€‚åªæœ‰åœ¨åŒä¸€ä¸ªchannelä¸­çš„å‚ä¸è€…ï¼Œæ‰ä¼šæ‹¥æœ‰è¯¥channelä¸­çš„è´¦æœ¬ï¼Œè€Œå…¶ä»–ä¸åœ¨æ­¤channelä¸­çš„å‚ä¸è€…åˆ™çœ‹ä¸åˆ°è¿™ä¸ªè´¦æœ¬;   </p><h2 id="å…±äº«è´¦æœ¬"><a href="#å…±äº«è´¦æœ¬" class="headerlink" title="å…±äº«è´¦æœ¬"></a>å…±äº«è´¦æœ¬</h2><p>Hyperledger FabricåŒ…å«ä¸€ä¸ªè´¦æœ¬å­ç³»ç»Ÿï¼Œè¿™ä¸ªå­ç³»ç»ŸåŒ…å«ä¸¤ä¸ªç»„ä»¶:ä¸–ç•ŒçŠ¶æ€(world state) å’Œäº¤æ˜“è®°å½•ã€‚åœ¨Hyperledger Fabricç½‘ç»œä¸­çš„æ¯ä¸€ä¸ªå‚ä¸è€…éƒ½æ‹¥æœ‰ä¸€ä¸ªè´¦æœ¬çš„å‰¯æœ¬;  </p><p>ä¸–ç•ŒçŠ¶æ€ç»„ä»¶æè¿°äº†è´¦æœ¬åœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„çŠ¶æ€ï¼Œå®ƒæ˜¯è´¦æœ¬çš„æ•°æ®åº“ã€‚äº¤æ˜“è®°å½•ç»„ä»¶è®°å½•äº†äº§ç”Ÿä¸–ç•ŒçŠ¶æ€å½“å‰å€¼çš„æ‰€æœ‰äº¤æ˜“ï¼Œå®ƒæ˜¯ä¸–ç•ŒçŠ¶æ€çš„æ›´æ–°å†å²ã€‚é‚£ä¹ˆï¼Œè´¦æœ¬åˆ™æ˜¯ä¸–ç•ŒçŠ¶æ€æ•°æ®åº“å’Œäº¤æ˜“å†å²è®°å½•çš„é›†åˆ;   </p><p>è´¦æœ¬çš„ä¸–ç•ŒçŠ¶æ€å­˜å‚¨æ•°æ®åº“æ˜¯å¯æ›´æ¢çš„ã€‚é»˜è®¤é…ç½®ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªkey-valueå­˜å‚¨æ•°æ®åº“ã€‚äº¤æ˜“è®°å½•æ¨¡ å—ä¸éœ€è¦è¢«ä¸æ¥å…¥ã€‚åªéœ€è¦è®°å½•åœ¨åŒºå—é“¾ç½‘ç»œä¸­æ›²æ£çƒæ•°æ®åº“è¢« ä½¿ç”¨æ—¶ä¹‹å‰å’Œä¹‹åçš„å€¼å°±å¯ä»¥äº†;   </p><h2 id="æ™ºèƒ½åˆçº¦-1"><a href="#æ™ºèƒ½åˆçº¦-1" class="headerlink" title="æ™ºèƒ½åˆçº¦"></a>æ™ºèƒ½åˆçº¦</h2><p>Hyperledger Fabricæ™ºèƒ½åˆçº¦è¢«ç§°ä¸ºchaincodeï¼Œå½“ä¸€ä¸ªåŒºå—é“¾å¤–éƒ¨çš„ä¸€ä¸ªåº”ç”¨ç¨‹åºéœ€è¦è®¿é—®è´¦æœ¬æ—¶,å°±ä¼šè°ƒç”¨chaincodeã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œchaincodeåªä¼šè®¿é—®è´¦æœ¬çš„æ•°æ®åº“ç»„ä»¶å’Œä¸–ç•ŒçŠ¶æ€(world sate)(æ¯”å¦‚æŸ¥è¯¢)ï¼Œä½†ä¸ä¼šæŸ¥è¯¢äº¤æ˜“è®°å½•;  </p><p>chaincodeå¯é€šè¿‡å¤šç§ä¸åŒç¼–ç¨‹è¯­è¨€å®ç°ã€‚ç›®å‰æ”¯æŒchaincodeçš„è¯­è¨€æ˜¯Go(åŒ…å«å¯¹javaçš„æ”¯æŒ) </p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Installing and Accessing Mysql Server</title>
      <link href="/2018/02/09/Installing-and-Accessing-Mysql-Server/"/>
      <url>/2018/02/09/Installing-and-Accessing-Mysql-Server/</url>
      <content type="html"><![CDATA[<h2 id="MariaDB-or-MySQL"><a href="#MariaDB-or-MySQL" class="headerlink" title="MariaDB or MySQL"></a>MariaDB or MySQL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">DBMS: æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œåªæ˜¯ä¸€ä¸ªç¨‹åºï¼Œè€Œéæ•°æ®</div><div class="line">RDBMS: å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</div><div class="line">     C/S: ä¸“æœ‰åè®®</div><div class="line">     å…³ç³»æ¨¡å‹: è¡¨(è¡Œï¼Œåˆ—) ç»„æˆçš„äºŒç»´å…³ç³»</div><div class="line">     èŒƒå¼:ç¬¬ä¸€èŒƒå¼ã€ç¬¬äºŒèŒƒå¼ã€ç¬¬ä¸‰èŒƒå¼</div><div class="line">     å…³ç³»è¿ç®—:</div><div class="line">        é€‰æ‹©</div><div class="line">        æŠ•å½±</div><div class="line">     æ•°æ®åº“: è¡¨ï¼Œç´¢å¼•ï¼Œè§†å›¾(è™šè¡¨)</div><div class="line">        SQL: Structure Query Language (ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€)</div><div class="line">            DDL(æ•°æ®å®šä¹‰è¯­è¨€),DML(æ•°æ®æ“çºµè¯­è¨€ï¼Œæ“ä½œè¡¨ä¸­çš„æ•°æ®)</div><div class="line">            ç¼–ç¨‹æ¥å£:</div><div class="line">                å­˜å‚¨è¿‡ç¨‹</div><div class="line">                å­˜å‚¨å‡½æ•°</div><div class="line">                è§¦å‘å™¨ </div><div class="line">                äº‹ä»¶è°ƒè¯•å™¨ (Event scheduling)</div><div class="line">                è¿‡ç¨‹å¼ç¼–è¾‘: é€‰æ‹©ã€å¾ªç¯</div><div class="line">ä¸‰å±‚æ¨¡å‹:</div><div class="line">    ç‰©ç†å±‚(ä¸€å¼ è¡¨ï¼Œæˆ–è€…å¤šå¼ è¡¨ï¼Œè¡¨ç°ä¸ºä¸€ä¸ªæ–‡ä»¶)</div><div class="line">    é€»è¾‘å±‚(è¡¨ï¼Œç´¢å¼•ï¼Œè§†å›¾ï¼Œç­‰ç­‰)</div><div class="line">    è§†å›¾å±‚(æœ€ç»ˆç”¨æˆ·æ‰€çœ‹åˆ°çš„æ ·å­ï¼Œæˆæƒç”¨æˆ·æ‰€çœ‹åˆ°çš„)</div><div class="line">    åšä¸ºDBAéœ€è¦:  è®¾è®¡/åˆ›å»ºè¡¨  è®¾è®¡/åˆ›å»ºç´¢å¼• è®¾è®¡/åˆ›å»ºè§†å›¾  </div><div class="line">        æ•°æ®åº“çš„å¯¼å…¥å¯¼å‡ºç­‰</div><div class="line"></div><div class="line">è§£å†³æ–¹æ¡ˆ:</div><div class="line">    ä»˜è´¹: Oracle ,Sybase ,Infomix(IBM) ,DB2(IBM)</div><div class="line">    å¼€æº: MySQL ,MariaDB ,PostgreSQL , SQLite(æ˜¯ä¸€ç§åµŒå…¥å¼çš„è§£å†³æ–¹æ¡ˆ)</div><div class="line">        ç›®å‰MySQLå·²ç»è¢«Oracleæ”¶è´­</div><div class="line">    æœ‰ä¸‰æˆæŠŠæ¡çš„æ—¶å€™ï¼Œå°±è¦äº‰å–ã€‚ä¸ç„¶æœºä¼šå°±é”™è¿‡äº†ï¼Œä½†è¦åšå¥½å……ä»½å‡†å¤‡ã€‚</div><div class="line">    æ²¡æœ‰è°å¥½è°åï¼Œåªè¦å‘å¾€è‡ªå·±çš„ç†æƒ³å°±å¥½äº†ã€‚</div><div class="line"> </div><div class="line"> MySQL --&gt; 5.1 --&gt; 5.5 --&gt; 5.6 --&gt; 5.7</div><div class="line"> MariaDB </div><div class="line">    æ’ä»¶å¼å­˜å‚¨å¼•æ“(æ”¯æŒä¼—å¤šç±»å‹çš„å­˜å‚¨å¼•æ“)</div><div class="line">    MySQLæ˜¯å¦æ”¯æŒäº‹ç‰©ï¼Œåˆ™éœ€è¦æŸ¥çœ‹å­˜å‚¨å¼•æ“æ˜¯å¦æ”¯æŒäº‹ç‰© </div><div class="line">    å•è¿›ç¨‹å¤šçº¿ç¨‹</div><div class="line">        è¿æ¥çº¿ç¨‹</div><div class="line">        å®ˆæŠ¤çº¿ç¨‹</div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">MariaDB [mysql]&gt; SHOW ENGINES ;</div><div class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span></div><div class="line">| Engine             | Support | <span class="keyword">Comment</span>                                                                    | Transactions | XA   | Savepoints |</div><div class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span></div><div class="line">| CSV                | YES     | CSV <span class="keyword">storage</span> <span class="keyword">engine</span>                                                         | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| MRG_MYISAM         | YES     | Collection <span class="keyword">of</span> identical MyISAM <span class="keyword">tables</span>                                      | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| <span class="keyword">MEMORY</span>             | YES     | <span class="keyword">Hash</span> based, <span class="keyword">stored</span> <span class="keyword">in</span> <span class="keyword">memory</span>, useful <span class="keyword">for</span> <span class="keyword">temporary</span> <span class="keyword">tables</span>                  | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| BLACKHOLE          | YES     | /dev/<span class="literal">null</span> <span class="keyword">storage</span> <span class="keyword">engine</span> (anything you write <span class="keyword">to</span> it disappears)             | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| MyISAM             | YES     | MyISAM <span class="keyword">storage</span> <span class="keyword">engine</span>                                                      | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| <span class="keyword">InnoDB</span>             | <span class="keyword">DEFAULT</span> | Percona-XtraDB, Supports transactions, <span class="keyword">row</span>-<span class="keyword">level</span> locking, <span class="keyword">and</span> foreign <span class="keyword">keys</span> | YES          | YES  | YES        |</div><div class="line">| <span class="keyword">ARCHIVE</span>            | YES     | <span class="keyword">Archive</span> <span class="keyword">storage</span> <span class="keyword">engine</span>                                                     | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| FEDERATED          | YES     | FederatedX <span class="keyword">pluggable</span> <span class="keyword">storage</span> <span class="keyword">engine</span>                                        | YES          | <span class="keyword">NO</span>   | YES        |</div><div class="line">| PERFORMANCE_SCHEMA | YES     | <span class="keyword">Performance</span> <span class="keyword">Schema</span>                                                         | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">| Aria               | YES     | Crash-<span class="keyword">safe</span> <span class="keyword">tables</span> <span class="keyword">with</span> MyISAM heritage                                     | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</div><div class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span></div><div class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">MySQLé…ç½®æ–‡ä»¶:é›†ä¸­å¼çš„é…ç½®ï¼Œèƒ½å¤Ÿä¸ºmysqlçš„å„åº”ç”¨ç¨‹åºæä¾›é…ç½®ä¿¡æ¯</div><div class="line">    [mysqld] ä¸“ç”¨äºmysqldåº”ç”¨ç¨‹åº</div><div class="line">    [mysqld_safe] çº¿ç¨‹å®‰å…¨çš„mysqldä¸“æœ‰é…ç½®</div><div class="line">    [mysqld_multi] å¤šå®ä¾‹å…±ç¦»çš„mysql</div><div class="line">    [server] åªè¦æœ‰æ˜¯mysqlæœåŠ¡ç«¯çš„éƒ½æœ‰æ•ˆçš„</div><div class="line">    [mysql] mysqlå®¢æˆ·ç«¯çš„</div><div class="line">    [mysqldump] æ•°æ®å¯¼å…¥å¯¼å‡ºçš„</div><div class="line">    [client] å¯¹äºå®¢æˆ·ç«¯å·¥å…·çš„</div><div class="line">        parameter = value  æ”¯æŒ_ - ä¸¤ç§</div><div class="line">        skip-name-reslove</div><div class="line">        skip_name_reslove ä¸¤ç§æ–¹å¼éƒ½æ˜¯å¯ä»¥çš„</div><div class="line">mysqlå¯åŠ¨æ—¶æŸ¥æ‰¾è·¯å¾„</div><div class="line">    /etc/my.cnf  --&gt; /etc/mysql/my.cnf  --&gt; $MYSQL_HOME/my.cnf </div><div class="line">    --&gt; default-extra-file=/path/to/somdir/my.cnf --&gt; ~/.my.cnf</div><div class="line">    åæ‰¾åˆ°çš„ï¼Œè¡Œä¼šè¦†ç›–å…ˆæ‰¾åˆ°çš„ï¼Œäºæ˜¯ï¼Œè¶Šä½åçš„æ˜¯ï¼Œè¶Šæ˜¯å…ˆç”Ÿæ•ˆ</div><div class="line">    </div><div class="line">å®‰è£…æ–¹æ³•</div><div class="line">    os vendor: rpm  ubuntuæœ€æˆåŠŸçš„é¢†åŸŸåœ¨æ¡Œé¢</div><div class="line">    æœåŠ¡å™¨å»ºè®®ä½¿ç”¨CentOS, SUSE,OpenSUSE,Debianç­‰ç­‰ </div><div class="line">    Debian è¦æ±‚æŠ€æœ¯èƒ½åŠ›åé«˜</div><div class="line">    </div><div class="line">    MySQL:</div><div class="line">        rpm </div><div class="line">        å±•å¼€å¯ç”¨ï¼Œä¸€èˆ¬å®‰è£…å°±ç”¨çš„è¿™ç§æ–¹å¼</div><div class="line">        æºç ï¼Œæºç å®‰è£…æ—¶éœ€è¦å¯¹ä»£ç æ‰“å¸ƒä¸ï¼Œå¯¹MySQLè®¢åˆ¶</div><div class="line">    å®‰è£…åçš„è®¾è®¡:</div><div class="line">        ï¼ˆ1ï¼‰ä¸ºæ‰€æœ‰rootç”¨æˆ·è®¾å®šå¯†ç </div><div class="line">            mysql&gt; SET PASSWORD</div><div class="line">            mysql&gt; update mysql.user  SET password= PASSWORD(&apos;your_pass&apos;) WHERE cluase;</div><div class="line">            mysql&gt; FLUSH PRIVILEGES ;</div><div class="line">            # mysqladmin ç”¨è¿™ä¸ªå‘½ä»¤æ¥ä¿®æ”¹</div><div class="line">         (2) åˆ é™¤æ‰€æœ‰åŒ¿åç”¨æˆ·</div><div class="line">            mysql&gt; DROP USER &apos;&apos;@ &apos;localhost&apos;;</div><div class="line">            ä¸Šæœ¯ä¸¤æ­¥éª¤å¯è¿è¡Œå‘½ä»¤: mysql_secure_installation</div><div class="line">         (3) å»ºè®®å…³é—­ä¸»æœºååè§£åŠŸèƒ½</div><div class="line">å…ƒæ•°æ®æ•°æ®åº“: mysql</div><div class="line">    user,host ç­‰</div><div class="line">mysql å®¢æˆ·ç«¯å·¥å…· mysql</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>linux å¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§</title>
      <link href="/2018/02/08/linux-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E6%8A%80%E5%B7%A7/"/>
      <url>/2018/02/08/linux-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E6%8A%80%E5%B7%A7/</url>
      <content type="html"><![CDATA[<h1 id="linux-å¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§"><a href="#linux-å¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§" class="headerlink" title="linux å¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§"></a>linux å¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§</h1><p><img src="/images/bash.png" alt=""></p><h2 id="1-æ£€æŸ¥è¿œç¨‹ç«¯å£æ˜¯å¦å¯¹bashå¼€æ”¾ï¼š"><a href="#1-æ£€æŸ¥è¿œç¨‹ç«¯å£æ˜¯å¦å¯¹bashå¼€æ”¾ï¼š" class="headerlink" title="1.æ£€æŸ¥è¿œç¨‹ç«¯å£æ˜¯å¦å¯¹bashå¼€æ”¾ï¼š"></a>1.æ£€æŸ¥è¿œç¨‹ç«¯å£æ˜¯å¦å¯¹bashå¼€æ”¾ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> &gt;/dev/tcp/8.8.8.8/53 &amp;&amp; <span class="built_in">echo</span> <span class="string">"open"</span></div></pre></td></tr></table></figure><h2 id="2-è®©è¿›ç¨‹è½¬å…¥åå°ï¼š"><a href="#2-è®©è¿›ç¨‹è½¬å…¥åå°ï¼š" class="headerlink" title="2.è®©è¿›ç¨‹è½¬å…¥åå°ï¼š"></a>2.è®©è¿›ç¨‹è½¬å…¥åå°ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl + z</div></pre></td></tr></table></figure><h2 id="3-å°†è¿›ç¨‹è½¬åˆ°å‰å°ï¼š"><a href="#3-å°†è¿›ç¨‹è½¬åˆ°å‰å°ï¼š" class="headerlink" title="3.å°†è¿›ç¨‹è½¬åˆ°å‰å°ï¼š"></a>3.å°†è¿›ç¨‹è½¬åˆ°å‰å°ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">fg</span></div></pre></td></tr></table></figure><h2 id="4-äº§ç”Ÿéšæœºçš„åå…­è¿›åˆ¶æ•°ï¼Œå…¶ä¸­næ˜¯å­—ç¬¦æ•°ï¼š"><a href="#4-äº§ç”Ÿéšæœºçš„åå…­è¿›åˆ¶æ•°ï¼Œå…¶ä¸­næ˜¯å­—ç¬¦æ•°ï¼š" class="headerlink" title="4.äº§ç”Ÿéšæœºçš„åå…­è¿›åˆ¶æ•°ï¼Œå…¶ä¸­næ˜¯å­—ç¬¦æ•°ï¼š"></a>4.äº§ç”Ÿéšæœºçš„åå…­è¿›åˆ¶æ•°ï¼Œå…¶ä¸­næ˜¯å­—ç¬¦æ•°ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl rand -hex n</div></pre></td></tr></table></figure><h2 id="5-åœ¨å½“å‰shellé‡Œæ‰§è¡Œä¸€ä¸ªæ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼š"><a href="#5-åœ¨å½“å‰shellé‡Œæ‰§è¡Œä¸€ä¸ªæ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼š" class="headerlink" title="5.åœ¨å½“å‰shellé‡Œæ‰§è¡Œä¸€ä¸ªæ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼š"></a>5.åœ¨å½“å‰shellé‡Œæ‰§è¡Œä¸€ä¸ªæ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> /home/user/file.name</div></pre></td></tr></table></figure><h2 id="6-æˆªå–å‰5ä¸ªå­—ç¬¦ï¼š"><a href="#6-æˆªå–å‰5ä¸ªå­—ç¬¦ï¼š" class="headerlink" title="6.æˆªå–å‰5ä¸ªå­—ç¬¦ï¼š"></a>6.æˆªå–å‰5ä¸ªå­—ç¬¦ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$&#123;variable:0:5&#125;</span></div></pre></td></tr></table></figure><h2 id="7-SSH-debug-æ¨¡å¼"><a href="#7-SSH-debug-æ¨¡å¼" class="headerlink" title="7.SSH debug æ¨¡å¼:"></a>7.SSH debug æ¨¡å¼:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -vvv user@ip_address</div></pre></td></tr></table></figure><h2 id="8-SSH-with-pem-key"><a href="#8-SSH-with-pem-key" class="headerlink" title="8.SSH with pem key:"></a>8.SSH with pem key:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh user@ip_address -i key.pem</div></pre></td></tr></table></figure><h2 id="9-ç”¨wgetæŠ“å–å®Œæ•´çš„ç½‘ç«™ç›®å½•ç»“æ„ï¼Œå­˜æ”¾åˆ°æœ¬åœ°ç›®å½•ä¸­ï¼š"><a href="#9-ç”¨wgetæŠ“å–å®Œæ•´çš„ç½‘ç«™ç›®å½•ç»“æ„ï¼Œå­˜æ”¾åˆ°æœ¬åœ°ç›®å½•ä¸­ï¼š" class="headerlink" title="9.ç”¨wgetæŠ“å–å®Œæ•´çš„ç½‘ç«™ç›®å½•ç»“æ„ï¼Œå­˜æ”¾åˆ°æœ¬åœ°ç›®å½•ä¸­ï¼š"></a>9.ç”¨wgetæŠ“å–å®Œæ•´çš„ç½‘ç«™ç›®å½•ç»“æ„ï¼Œå­˜æ”¾åˆ°æœ¬åœ°ç›®å½•ä¸­ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -r --no-parent --reject <span class="string">"index.html*"</span> http://hostname/ -P /home/user/<span class="built_in">dirs</span></div></pre></td></tr></table></figure><h2 id="10-ä¸€æ¬¡åˆ›å»ºå¤šä¸ªç›®å½•ï¼š"><a href="#10-ä¸€æ¬¡åˆ›å»ºå¤šä¸ªç›®å½•ï¼š" class="headerlink" title="10.ä¸€æ¬¡åˆ›å»ºå¤šä¸ªç›®å½•ï¼š"></a>10.ä¸€æ¬¡åˆ›å»ºå¤šä¸ªç›®å½•ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p /home/user/&#123;<span class="built_in">test</span>,test1,test2&#125;</div></pre></td></tr></table></figure><h2 id="11-åˆ—å‡ºåŒ…æ‹¬å­è¿›ç¨‹çš„è¿›ç¨‹æ ‘ï¼š"><a href="#11-åˆ—å‡ºåŒ…æ‹¬å­è¿›ç¨‹çš„è¿›ç¨‹æ ‘ï¼š" class="headerlink" title="11.åˆ—å‡ºåŒ…æ‹¬å­è¿›ç¨‹çš„è¿›ç¨‹æ ‘ï¼š"></a>11.åˆ—å‡ºåŒ…æ‹¬å­è¿›ç¨‹çš„è¿›ç¨‹æ ‘ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps axwef</div></pre></td></tr></table></figure><h2 id="12-åˆ›å»º-war-æ–‡ä»¶"><a href="#12-åˆ›å»º-war-æ–‡ä»¶" class="headerlink" title="12.åˆ›å»º war æ–‡ä»¶:"></a>12.åˆ›å»º war æ–‡ä»¶:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar -cvf name.war file</div></pre></td></tr></table></figure><h2 id="13-æµ‹è¯•ç¡¬ç›˜å†™å…¥é€Ÿåº¦ï¼š"><a href="#13-æµ‹è¯•ç¡¬ç›˜å†™å…¥é€Ÿåº¦ï¼š" class="headerlink" title="13.æµ‹è¯•ç¡¬ç›˜å†™å…¥é€Ÿåº¦ï¼š"></a>13.æµ‹è¯•ç¡¬ç›˜å†™å…¥é€Ÿåº¦ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dd <span class="keyword">if</span>=/dev/zero of=/tmp/output.img bs=8k count=256k; rm -rf /tmp/output.img</div></pre></td></tr></table></figure><h2 id="14-æµ‹è¯•ç¡¬ç›˜è¯»å–é€Ÿåº¦ï¼š"><a href="#14-æµ‹è¯•ç¡¬ç›˜è¯»å–é€Ÿåº¦ï¼š" class="headerlink" title="14.æµ‹è¯•ç¡¬ç›˜è¯»å–é€Ÿåº¦ï¼š"></a>14.æµ‹è¯•ç¡¬ç›˜è¯»å–é€Ÿåº¦ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hdparm -Tt /dev/sda</div></pre></td></tr></table></figure><h2 id="15-è·å–æ–‡æœ¬çš„md5-hashï¼š"><a href="#15-è·å–æ–‡æœ¬çš„md5-hashï¼š" class="headerlink" title="15.è·å–æ–‡æœ¬çš„md5 hashï¼š"></a>15.è·å–æ–‡æœ¬çš„md5 hashï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> -n <span class="string">"text"</span> | md5sum</div></pre></td></tr></table></figure><h2 id="16-æ£€æŸ¥xmlæ ¼å¼ï¼š"><a href="#16-æ£€æŸ¥xmlæ ¼å¼ï¼š" class="headerlink" title="16.æ£€æŸ¥xmlæ ¼å¼ï¼š"></a>16.æ£€æŸ¥xmlæ ¼å¼ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xmllint --noout file.xml</div></pre></td></tr></table></figure><h2 id="17-å°†tar-gzæå–åˆ°æ–°ç›®å½•é‡Œï¼š"><a href="#17-å°†tar-gzæå–åˆ°æ–°ç›®å½•é‡Œï¼š" class="headerlink" title="17.å°†tar.gzæå–åˆ°æ–°ç›®å½•é‡Œï¼š"></a>17.å°†tar.gzæå–åˆ°æ–°ç›®å½•é‡Œï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar zxvf package.tar.gz -C new_dir</div></pre></td></tr></table></figure><h2 id="18-ä½¿ç”¨curlè·å–HTTPå¤´ä¿¡æ¯ï¼š"><a href="#18-ä½¿ç”¨curlè·å–HTTPå¤´ä¿¡æ¯ï¼š" class="headerlink" title="18.ä½¿ç”¨curlè·å–HTTPå¤´ä¿¡æ¯ï¼š"></a>18.ä½¿ç”¨curlè·å–HTTPå¤´ä¿¡æ¯ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -I http://www.example.com</div></pre></td></tr></table></figure><h2 id="19-ä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æ—¶é—´æˆ³-YYMMDDhhmm"><a href="#19-ä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æ—¶é—´æˆ³-YYMMDDhhmm" class="headerlink" title="19.ä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æ—¶é—´æˆ³(YYMMDDhhmm):"></a>19.ä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•çš„æ—¶é—´æˆ³(YYMMDDhhmm):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">touch -t 0812250000 file</div></pre></td></tr></table></figure><h2 id="20-ç”¨wgetå‘½ä»¤æ‰§è¡Œftpä¸‹è½½ï¼š"><a href="#20-ç”¨wgetå‘½ä»¤æ‰§è¡Œftpä¸‹è½½ï¼š" class="headerlink" title="20.ç”¨wgetå‘½ä»¤æ‰§è¡Œftpä¸‹è½½ï¼š"></a>20.ç”¨wgetå‘½ä»¤æ‰§è¡Œftpä¸‹è½½ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -m ftp://username:password@hostname</div></pre></td></tr></table></figure><h2 id="21-ç”Ÿæˆéšæœºå¯†ç -ä¾‹å­é‡Œæ˜¯16ä¸ªå­—ç¬¦é•¿"><a href="#21-ç”Ÿæˆéšæœºå¯†ç -ä¾‹å­é‡Œæ˜¯16ä¸ªå­—ç¬¦é•¿" class="headerlink" title="21.ç”Ÿæˆéšæœºå¯†ç (ä¾‹å­é‡Œæ˜¯16ä¸ªå­—ç¬¦é•¿):"></a>21.ç”Ÿæˆéšæœºå¯†ç (ä¾‹å­é‡Œæ˜¯16ä¸ªå­—ç¬¦é•¿):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LANG=c &lt; /dev/urandom tr -dc _A-Z<span class="_">-a</span>-z-0-9 | head -c<span class="variable">$&#123;1:-16&#125;</span>;<span class="built_in">echo</span>;</div></pre></td></tr></table></figure><h2 id="22-å¿«é€Ÿå¤‡ä»½ä¸€ä¸ªæ–‡ä»¶ï¼š"><a href="#22-å¿«é€Ÿå¤‡ä»½ä¸€ä¸ªæ–‡ä»¶ï¼š" class="headerlink" title="22.å¿«é€Ÿå¤‡ä»½ä¸€ä¸ªæ–‡ä»¶ï¼š"></a>22.å¿«é€Ÿå¤‡ä»½ä¸€ä¸ªæ–‡ä»¶ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp some_file_name&#123;,.bkp&#125;</div></pre></td></tr></table></figure><h2 id="23-è®¿é—®Windowså…±äº«ç›®å½•ï¼š"><a href="#23-è®¿é—®Windowså…±äº«ç›®å½•ï¼š" class="headerlink" title="23.è®¿é—®Windowså…±äº«ç›®å½•ï¼š"></a>23.è®¿é—®Windowså…±äº«ç›®å½•ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">smbclient -U <span class="string">"DOMAIN\user"</span> //dc.domain.com/share/<span class="built_in">test</span>/dir</div></pre></td></tr></table></figure><h2 id="24-æ‰§è¡Œå†å²è®°å½•é‡Œçš„å‘½ä»¤-è¿™é‡Œæ˜¯ç¬¬100è¡Œ"><a href="#24-æ‰§è¡Œå†å²è®°å½•é‡Œçš„å‘½ä»¤-è¿™é‡Œæ˜¯ç¬¬100è¡Œ" class="headerlink" title="24.æ‰§è¡Œå†å²è®°å½•é‡Œçš„å‘½ä»¤(è¿™é‡Œæ˜¯ç¬¬100è¡Œ):"></a>24.æ‰§è¡Œå†å²è®°å½•é‡Œçš„å‘½ä»¤(è¿™é‡Œæ˜¯ç¬¬100è¡Œ):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!100</div></pre></td></tr></table></figure><h2 id="25-è§£å‹"><a href="#25-è§£å‹" class="headerlink" title="25.è§£å‹:"></a>25.è§£å‹:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">unzip package_name.zip -d dir_name</div><div class="line">tar xvf package_name.tar.gz -d dir_name</div><div class="line">tar cvf package_name.tar.gz /path/to/file/</div></pre></td></tr></table></figure><h2 id="26-è¾“å…¥å¤šè¡Œæ–‡å­—-CTRL-d-é€€å‡º"><a href="#26-è¾“å…¥å¤šè¡Œæ–‡å­—-CTRL-d-é€€å‡º" class="headerlink" title="26.è¾“å…¥å¤šè¡Œæ–‡å­—(CTRL + d é€€å‡º):"></a>26.è¾“å…¥å¤šè¡Œæ–‡å­—(CTRL + d é€€å‡º):</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat &lt; &gt;&gt; test.txt</div></pre></td></tr></table></figure><h2 id="27-åˆ›å»ºç©ºæ–‡ä»¶æˆ–æ¸…ç©ºä¸€ä¸ªç°æœ‰æ–‡ä»¶ï¼š"><a href="#27-åˆ›å»ºç©ºæ–‡ä»¶æˆ–æ¸…ç©ºä¸€ä¸ªç°æœ‰æ–‡ä»¶ï¼š" class="headerlink" title="27.åˆ›å»ºç©ºæ–‡ä»¶æˆ–æ¸…ç©ºä¸€ä¸ªç°æœ‰æ–‡ä»¶ï¼š"></a>27.åˆ›å»ºç©ºæ–‡ä»¶æˆ–æ¸…ç©ºä¸€ä¸ªç°æœ‰æ–‡ä»¶ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\&gt; test.txt</div></pre></td></tr></table></figure><h2 id="28-ä¸Ubuntu-NTP-serveråŒæ­¥æ—¶é—´ï¼š"><a href="#28-ä¸Ubuntu-NTP-serveråŒæ­¥æ—¶é—´ï¼š" class="headerlink" title="28.ä¸Ubuntu NTP serveråŒæ­¥æ—¶é—´ï¼š"></a>28.ä¸Ubuntu NTP serveråŒæ­¥æ—¶é—´ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ntpdate ntp.ubuntu.com</div></pre></td></tr></table></figure><h2 id="29-ç”¨netstatæ˜¾ç¤ºæ‰€æœ‰tcp4ç›‘å¬ç«¯å£ï¼š"><a href="#29-ç”¨netstatæ˜¾ç¤ºæ‰€æœ‰tcp4ç›‘å¬ç«¯å£ï¼š" class="headerlink" title="29.ç”¨netstatæ˜¾ç¤ºæ‰€æœ‰tcp4ç›‘å¬ç«¯å£ï¼š"></a>29.ç”¨netstatæ˜¾ç¤ºæ‰€æœ‰tcp4ç›‘å¬ç«¯å£ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -lnt4 | awk <span class="string">'&#123;print $4&#125;'</span> | cut -f2 -d: | grep -o <span class="string">'[0-9]*'</span></div></pre></td></tr></table></figure><h2 id="30-qcow2é•œåƒæ–‡ä»¶è½¬æ¢ï¼š"><a href="#30-qcow2é•œåƒæ–‡ä»¶è½¬æ¢ï¼š" class="headerlink" title="30.qcow2é•œåƒæ–‡ä»¶è½¬æ¢ï¼š"></a>30.qcow2é•œåƒæ–‡ä»¶è½¬æ¢ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-img convert -f qcow2 -O raw precise-server-cloudimg-amd64-disk1.img \precise-server-cloudimg-amd64-disk1.raw</div></pre></td></tr></table></figure><h2 id="31-é‡å¤è¿è¡Œæ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¶è¾“å‡ºï¼ˆç¼ºçœæ˜¯2ç§’ä¸€æ¬¡ï¼‰ï¼š"><a href="#31-é‡å¤è¿è¡Œæ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¶è¾“å‡ºï¼ˆç¼ºçœæ˜¯2ç§’ä¸€æ¬¡ï¼‰ï¼š" class="headerlink" title="31.é‡å¤è¿è¡Œæ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¶è¾“å‡ºï¼ˆç¼ºçœæ˜¯2ç§’ä¸€æ¬¡ï¼‰ï¼š"></a>31.é‡å¤è¿è¡Œæ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¶è¾“å‡ºï¼ˆç¼ºçœæ˜¯2ç§’ä¸€æ¬¡ï¼‰ï¼š</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">watch ps -ef</div><div class="line">watch -n1 &quot;df -h&quot;</div></pre></td></tr></table></figure><h2 id="32-æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼š"><a href="#32-æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼š" class="headerlink" title="32.æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼š"></a>32.æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">getent passwd</div><div class="line">awk -F: <span class="string">'&#123;print $1&#125;'</span> /etc/passwd </div><div class="line">cat /etc/passwd | cut -d <span class="string">':'</span> -f 1</div></pre></td></tr></table></figure><h2 id="33-Mount-root-in-read-write-mode"><a href="#33-Mount-root-in-read-write-mode" class="headerlink" title="33.Mount root in read/write mode:"></a>33.Mount root in read/write mode:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -o remount,rw /</div></pre></td></tr></table></figure><h2 id="34-æŒ‚è½½ä¸€ä¸ªç›®å½•ï¼ˆè¿™æ˜¯ä¸èƒ½ä½¿ç”¨é“¾æ¥çš„æƒ…å†µï¼‰"><a href="#34-æŒ‚è½½ä¸€ä¸ªç›®å½•ï¼ˆè¿™æ˜¯ä¸èƒ½ä½¿ç”¨é“¾æ¥çš„æƒ…å†µï¼‰" class="headerlink" title="34.æŒ‚è½½ä¸€ä¸ªç›®å½•ï¼ˆè¿™æ˜¯ä¸èƒ½ä½¿ç”¨é“¾æ¥çš„æƒ…å†µï¼‰:"></a>34.æŒ‚è½½ä¸€ä¸ªç›®å½•ï¼ˆè¿™æ˜¯ä¸èƒ½ä½¿ç”¨é“¾æ¥çš„æƒ…å†µï¼‰:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount --<span class="built_in">bind</span> /<span class="built_in">source</span> /destination</div></pre></td></tr></table></figure><h2 id="35-åŠ¨æ€æ›´æ–°DNS-server"><a href="#35-åŠ¨æ€æ›´æ–°DNS-server" class="headerlink" title="35.åŠ¨æ€æ›´æ–°DNS server:"></a>35.åŠ¨æ€æ›´æ–°DNS server:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">nsupdate &lt; &lt;EOF</div><div class="line">update add <span class="variable">$HOST</span> 86400 A <span class="variable">$IP</span></div><div class="line">send</div><div class="line">EOF</div></pre></td></tr></table></figure><h2 id="36-é€’å½’grepæ‰€æœ‰ç›®å½•ï¼š"><a href="#36-é€’å½’grepæ‰€æœ‰ç›®å½•ï¼š" class="headerlink" title="36.é€’å½’grepæ‰€æœ‰ç›®å½•ï¼š"></a>36.é€’å½’grepæ‰€æœ‰ç›®å½•ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -r <span class="string">"some_text"</span> /path/to/dir</div></pre></td></tr></table></figure><h2 id="37-åˆ—å‡ºå‰10ä¸ªæœ€å¤§çš„æ–‡ä»¶ï¼š"><a href="#37-åˆ—å‡ºå‰10ä¸ªæœ€å¤§çš„æ–‡ä»¶ï¼š" class="headerlink" title="37.åˆ—å‡ºå‰10ä¸ªæœ€å¤§çš„æ–‡ä»¶ï¼š"></a>37.åˆ—å‡ºå‰10ä¸ªæœ€å¤§çš„æ–‡ä»¶ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsof / | awk <span class="string">'&#123; if($7 &gt; 1048576) print $7/1048576 "MB "$9 &#125;'</span> | sort -n -u | tail</div></pre></td></tr></table></figure><h2 id="38-æ˜¾ç¤ºå‰©ä½™å†…å­˜-MB"><a href="#38-æ˜¾ç¤ºå‰©ä½™å†…å­˜-MB" class="headerlink" title="38.æ˜¾ç¤ºå‰©ä½™å†…å­˜(MB):"></a>38.æ˜¾ç¤ºå‰©ä½™å†…å­˜(MB):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free -m | grep cache | awk <span class="string">'/[0-9]/&#123; print $4" MB" &#125;'</span></div></pre></td></tr></table></figure><h2 id="39-æ‰“å¼€Vimå¹¶è·³åˆ°æ–‡ä»¶æœ«ï¼š"><a href="#39-æ‰“å¼€Vimå¹¶è·³åˆ°æ–‡ä»¶æœ«ï¼š" class="headerlink" title="39.æ‰“å¼€Vimå¹¶è·³åˆ°æ–‡ä»¶æœ«ï¼š"></a>39.æ‰“å¼€Vimå¹¶è·³åˆ°æ–‡ä»¶æœ«ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim + some_file_name</div></pre></td></tr></table></figure><h2 id="40-Git-å…‹éš†æŒ‡å®šåˆ†æ”¯-master"><a href="#40-Git-å…‹éš†æŒ‡å®šåˆ†æ”¯-master" class="headerlink" title="40.Git å…‹éš†æŒ‡å®šåˆ†æ”¯(master):"></a>40.Git å…‹éš†æŒ‡å®šåˆ†æ”¯(master):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git@github.com:name/app.git -b master</div></pre></td></tr></table></figure><h2 id="41-Git-åˆ‡æ¢åˆ°å…¶å®ƒåˆ†æ”¯-develop"><a href="#41-Git-åˆ‡æ¢åˆ°å…¶å®ƒåˆ†æ”¯-develop" class="headerlink" title="41.Git åˆ‡æ¢åˆ°å…¶å®ƒåˆ†æ”¯(develop):"></a>41.Git åˆ‡æ¢åˆ°å…¶å®ƒåˆ†æ”¯(develop):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout develop</div></pre></td></tr></table></figure><h2 id="42-Git-åˆ é™¤åˆ†æ”¯-myfeature"><a href="#42-Git-åˆ é™¤åˆ†æ”¯-myfeature" class="headerlink" title="42.Git åˆ é™¤åˆ†æ”¯(myfeature):"></a>42.Git åˆ é™¤åˆ†æ”¯(myfeature):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git branch -d myfeature</div></pre></td></tr></table></figure><h2 id="43-Git-åˆ é™¤è¿œç¨‹åˆ†æ”¯"><a href="#43-Git-åˆ é™¤è¿œç¨‹åˆ†æ”¯" class="headerlink" title="43.Git åˆ é™¤è¿œç¨‹åˆ†æ”¯"></a>43.Git åˆ é™¤è¿œç¨‹åˆ†æ”¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push origin :branchName</div></pre></td></tr></table></figure><h2 id="44-Git-å°†æ–°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š"><a href="#44-Git-å°†æ–°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š" class="headerlink" title="44.Git å°†æ–°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š"></a>44.Git å°†æ–°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push -u origin mynewfeature</div></pre></td></tr></table></figure><h2 id="45-æ‰“å°å†å²è®°å½•ä¸­æœ€åä¸€æ¬¡catå‘½ä»¤ï¼š"><a href="#45-æ‰“å°å†å²è®°å½•ä¸­æœ€åä¸€æ¬¡catå‘½ä»¤ï¼š" class="headerlink" title="45.æ‰“å°å†å²è®°å½•ä¸­æœ€åä¸€æ¬¡catå‘½ä»¤ï¼š"></a>45.æ‰“å°å†å²è®°å½•ä¸­æœ€åä¸€æ¬¡catå‘½ä»¤ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!cat:p</div></pre></td></tr></table></figure><h2 id="46-è¿è¡Œå†å²è®°å½•é‡Œæœ€åä¸€æ¬¡catå‘½ä»¤ï¼š"><a href="#46-è¿è¡Œå†å²è®°å½•é‡Œæœ€åä¸€æ¬¡catå‘½ä»¤ï¼š" class="headerlink" title="46.è¿è¡Œå†å²è®°å½•é‡Œæœ€åä¸€æ¬¡catå‘½ä»¤ï¼š"></a>46.è¿è¡Œå†å²è®°å½•é‡Œæœ€åä¸€æ¬¡catå‘½ä»¤ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!cat</div></pre></td></tr></table></figure><h2 id="47-æ‰¾å‡º-home-userä¸‹æ‰€æœ‰ç©ºå­ç›®å½•"><a href="#47-æ‰¾å‡º-home-userä¸‹æ‰€æœ‰ç©ºå­ç›®å½•" class="headerlink" title="47.æ‰¾å‡º/home/userä¸‹æ‰€æœ‰ç©ºå­ç›®å½•:"></a>47.æ‰¾å‡º/home/userä¸‹æ‰€æœ‰ç©ºå­ç›®å½•:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find /home/user -maxdepth 1 -<span class="built_in">type</span> d -empty</div></pre></td></tr></table></figure><h2 id="48-è·å–test-txtæ–‡ä»¶ä¸­ç¬¬50-60è¡Œå†…å®¹ï¼š"><a href="#48-è·å–test-txtæ–‡ä»¶ä¸­ç¬¬50-60è¡Œå†…å®¹ï¼š" class="headerlink" title="48.è·å–test.txtæ–‡ä»¶ä¸­ç¬¬50-60è¡Œå†…å®¹ï¼š"></a>48.è·å–test.txtæ–‡ä»¶ä¸­ç¬¬50-60è¡Œå†…å®¹ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt; test.txt sed -n <span class="string">'50,60p'</span></div></pre></td></tr></table></figure><h2 id="49-è¿è¡Œæœ€åä¸€ä¸ªå‘½ä»¤-å¦‚æœæœ€åä¸€ä¸ªå‘½ä»¤æ˜¯mkdir-root-test-ä¸‹é¢å°†ä¼šè¿è¡Œ-sudo-mkdir-root-test-ï¼š"><a href="#49-è¿è¡Œæœ€åä¸€ä¸ªå‘½ä»¤-å¦‚æœæœ€åä¸€ä¸ªå‘½ä»¤æ˜¯mkdir-root-test-ä¸‹é¢å°†ä¼šè¿è¡Œ-sudo-mkdir-root-test-ï¼š" class="headerlink" title="49.è¿è¡Œæœ€åä¸€ä¸ªå‘½ä»¤(å¦‚æœæœ€åä¸€ä¸ªå‘½ä»¤æ˜¯mkdir /root/test, ä¸‹é¢å°†ä¼šè¿è¡Œ: sudo mkdir /root/test)ï¼š"></a>49.è¿è¡Œæœ€åä¸€ä¸ªå‘½ä»¤(å¦‚æœæœ€åä¸€ä¸ªå‘½ä»¤æ˜¯mkdir /root/test, ä¸‹é¢å°†ä¼šè¿è¡Œ: sudo mkdir /root/test)ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo !!</div></pre></td></tr></table></figure><h2 id="50-åˆ›å»ºä¸´æ—¶RAMæ–‡ä»¶ç³»ç»Ÿ-â€“-ramdisk-å…ˆåˆ›å»º-tmpramç›®å½•"><a href="#50-åˆ›å»ºä¸´æ—¶RAMæ–‡ä»¶ç³»ç»Ÿ-â€“-ramdisk-å…ˆåˆ›å»º-tmpramç›®å½•" class="headerlink" title="50.åˆ›å»ºä¸´æ—¶RAMæ–‡ä»¶ç³»ç»Ÿ â€“ ramdisk (å…ˆåˆ›å»º/tmpramç›®å½•):"></a>50.åˆ›å»ºä¸´æ—¶RAMæ–‡ä»¶ç³»ç»Ÿ â€“ ramdisk (å…ˆåˆ›å»º/tmpramç›®å½•):</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -t tmpfs tmpfs /tmpram -o size=512m</div></pre></td></tr></table></figure><h2 id="51-Grep-whole-words"><a href="#51-Grep-whole-words" class="headerlink" title="51.Grep whole words:"></a>51.Grep whole words:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -w <span class="string">"name"</span> test.txt</div></pre></td></tr></table></figure><h2 id="52-åœ¨éœ€è¦æå‡æƒé™çš„æƒ…å†µä¸‹å¾€ä¸€ä¸ªæ–‡ä»¶é‡Œè¿½åŠ æ–‡æœ¬ï¼š"><a href="#52-åœ¨éœ€è¦æå‡æƒé™çš„æƒ…å†µä¸‹å¾€ä¸€ä¸ªæ–‡ä»¶é‡Œè¿½åŠ æ–‡æœ¬ï¼š" class="headerlink" title="52.åœ¨éœ€è¦æå‡æƒé™çš„æƒ…å†µä¸‹å¾€ä¸€ä¸ªæ–‡ä»¶é‡Œè¿½åŠ æ–‡æœ¬ï¼š"></a>52.åœ¨éœ€è¦æå‡æƒé™çš„æƒ…å†µä¸‹å¾€ä¸€ä¸ªæ–‡ä»¶é‡Œè¿½åŠ æ–‡æœ¬ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"some text"</span> | sudo tee -a /path/file</div></pre></td></tr></table></figure><h2 id="53-åˆ—å‡ºæ‰€æœ‰kill-signalå‚æ•°"><a href="#53-åˆ—å‡ºæ‰€æœ‰kill-signalå‚æ•°" class="headerlink" title="53.åˆ—å‡ºæ‰€æœ‰kill signalå‚æ•°:"></a>53.åˆ—å‡ºæ‰€æœ‰kill signalå‚æ•°:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span> -l</div></pre></td></tr></table></figure><h2 id="54-åœ¨bashå†å²è®°å½•é‡Œç¦æ­¢è®°å½•æœ€åä¸€æ¬¡ä¼šè¯ï¼š"><a href="#54-åœ¨bashå†å²è®°å½•é‡Œç¦æ­¢è®°å½•æœ€åä¸€æ¬¡ä¼šè¯ï¼š" class="headerlink" title="54.åœ¨bashå†å²è®°å½•é‡Œç¦æ­¢è®°å½•æœ€åä¸€æ¬¡ä¼šè¯ï¼š"></a>54.åœ¨bashå†å²è®°å½•é‡Œç¦æ­¢è®°å½•æœ€åä¸€æ¬¡ä¼šè¯ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">kill</span> -9 $$</div></pre></td></tr></table></figure><h2 id="55-æ‰«æç½‘ç»œå¯»æ‰¾å¼€æ”¾çš„ç«¯å£ï¼š"><a href="#55-æ‰«æç½‘ç»œå¯»æ‰¾å¼€æ”¾çš„ç«¯å£ï¼š" class="headerlink" title="55.æ‰«æç½‘ç»œå¯»æ‰¾å¼€æ”¾çš„ç«¯å£ï¼š"></a>55.æ‰«æç½‘ç»œå¯»æ‰¾å¼€æ”¾çš„ç«¯å£ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap -p 8081 172.20.0.0/16</div></pre></td></tr></table></figure><h2 id="56-è®¾ç½®git-email"><a href="#56-è®¾ç½®git-email" class="headerlink" title="56.è®¾ç½®git email:"></a>56.è®¾ç½®git email:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global user.email <span class="string">"me@example.com"</span></div></pre></td></tr></table></figure><h2 id="57-To-sync-with-master-if-you-have-unpublished-commits"><a href="#57-To-sync-with-master-if-you-have-unpublished-commits" class="headerlink" title="57.To sync with master if you have unpublished commits:"></a>57.To sync with master if you have unpublished commits:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git pull --rebase origin master</div></pre></td></tr></table></figure><h2 id="58-å°†æ‰€æœ‰æ–‡ä»¶åä¸­å«æœ‰â€txtâ€çš„æ–‡ä»¶ç§»å…¥-home-userç›®å½•"><a href="#58-å°†æ‰€æœ‰æ–‡ä»¶åä¸­å«æœ‰â€txtâ€çš„æ–‡ä»¶ç§»å…¥-home-userç›®å½•" class="headerlink" title="58.å°†æ‰€æœ‰æ–‡ä»¶åä¸­å«æœ‰â€txtâ€çš„æ–‡ä»¶ç§»å…¥/home/userç›®å½•:"></a>58.å°†æ‰€æœ‰æ–‡ä»¶åä¸­å«æœ‰â€txtâ€çš„æ–‡ä»¶ç§»å…¥/home/userç›®å½•:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find -iname <span class="string">"*txt*"</span> -<span class="built_in">exec</span> mv -v &#123;&#125; /home/user \;</div></pre></td></tr></table></figure><h2 id="59-å°†æ–‡ä»¶æŒ‰è¡Œå¹¶åˆ—æ˜¾ç¤ºï¼š"><a href="#59-å°†æ–‡ä»¶æŒ‰è¡Œå¹¶åˆ—æ˜¾ç¤ºï¼š" class="headerlink" title="59.å°†æ–‡ä»¶æŒ‰è¡Œå¹¶åˆ—æ˜¾ç¤ºï¼š"></a>59.å°†æ–‡ä»¶æŒ‰è¡Œå¹¶åˆ—æ˜¾ç¤ºï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">paste test.txt test1.txt</div></pre></td></tr></table></figure><h2 id="60-shellé‡Œçš„è¿›åº¦æ¡"><a href="#60-shellé‡Œçš„è¿›åº¦æ¡" class="headerlink" title="60.shellé‡Œçš„è¿›åº¦æ¡:"></a>60.shellé‡Œçš„è¿›åº¦æ¡:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pv data.log</div></pre></td></tr></table></figure><h2 id="61-ä½¿ç”¨netcatå°†æ•°æ®å‘é€åˆ°Graphite-server"><a href="#61-ä½¿ç”¨netcatå°†æ•°æ®å‘é€åˆ°Graphite-server" class="headerlink" title="61.ä½¿ç”¨netcatå°†æ•°æ®å‘é€åˆ°Graphite server:"></a>61.ä½¿ç”¨netcatå°†æ•°æ®å‘é€åˆ°Graphite server:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"hosts.sampleHost 10 `date +%s`"</span> | nc </div><div class="line">192.168.200.2 3000</div></pre></td></tr></table></figure><h2 id="62-å°†tabsè½¬æ¢æˆç©ºæ ¼ï¼š"><a href="#62-å°†tabsè½¬æ¢æˆç©ºæ ¼ï¼š" class="headerlink" title="62.å°†tabsè½¬æ¢æˆç©ºæ ¼ï¼š"></a>62.å°†tabsè½¬æ¢æˆç©ºæ ¼ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">expand test.txt &gt; test1.txt</div></pre></td></tr></table></figure><h2 id="63-Skip-bash-history"><a href="#63-Skip-bash-history" class="headerlink" title="63.Skip bash history:"></a>63.Skip bash history:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt; space &gt;cmd</div></pre></td></tr></table></figure><h2 id="64-å»ä¹‹å‰çš„å·¥ä½œç›®å½•ï¼š"><a href="#64-å»ä¹‹å‰çš„å·¥ä½œç›®å½•ï¼š" class="headerlink" title="64.å»ä¹‹å‰çš„å·¥ä½œç›®å½•ï¼š"></a>64.å»ä¹‹å‰çš„å·¥ä½œç›®å½•ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> -</div></pre></td></tr></table></figure><h2 id="65-æ‹†åˆ†å¤§ä½“ç§¯çš„tar-gzæ–‡ä»¶-æ¯ä¸ª100MB-ï¼Œç„¶ååˆå¹¶å›å»ï¼š"><a href="#65-æ‹†åˆ†å¤§ä½“ç§¯çš„tar-gzæ–‡ä»¶-æ¯ä¸ª100MB-ï¼Œç„¶ååˆå¹¶å›å»ï¼š" class="headerlink" title="65.æ‹†åˆ†å¤§ä½“ç§¯çš„tar.gzæ–‡ä»¶(æ¯ä¸ª100MB)ï¼Œç„¶ååˆå¹¶å›å»ï¼š"></a>65.æ‹†åˆ†å¤§ä½“ç§¯çš„tar.gzæ–‡ä»¶(æ¯ä¸ª100MB)ï¼Œç„¶ååˆå¹¶å›å»ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">split â€“b 100m /path/to/large/archive /path/to/output/files</div><div class="line">cat files* &gt; archive</div></pre></td></tr></table></figure><h2 id="66-ä½¿ç”¨curlè·å–HTTP-status-code"><a href="#66-ä½¿ç”¨curlè·å–HTTP-status-code" class="headerlink" title="66.ä½¿ç”¨curlè·å–HTTP status code:"></a>66.ä½¿ç”¨curlè·å–HTTP status code:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -sL -w <span class="string">"%&#123;http_code&#125;\\n"</span> www.example.com -o /dev/null</div></pre></td></tr></table></figure><h2 id="67-è®¾ç½®rootå¯†ç ï¼Œå¼ºåŒ–MySQLå®‰å…¨å®‰è£…"><a href="#67-è®¾ç½®rootå¯†ç ï¼Œå¼ºåŒ–MySQLå®‰å…¨å®‰è£…" class="headerlink" title="67.è®¾ç½®rootå¯†ç ï¼Œå¼ºåŒ–MySQLå®‰å…¨å®‰è£…:"></a>67.è®¾ç½®rootå¯†ç ï¼Œå¼ºåŒ–MySQLå®‰å…¨å®‰è£…:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/mysql_secure_installation</div></pre></td></tr></table></figure><h2 id="68-å½“Ctrl-cä¸å¥½ä½¿æ—¶"><a href="#68-å½“Ctrl-cä¸å¥½ä½¿æ—¶" class="headerlink" title="68.å½“Ctrl + cä¸å¥½ä½¿æ—¶:"></a>68.å½“Ctrl + cä¸å¥½ä½¿æ—¶:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl + \</div></pre></td></tr></table></figure><h2 id="69-è·å–æ–‡ä»¶owner"><a href="#69-è·å–æ–‡ä»¶owner" class="headerlink" title="69.è·å–æ–‡ä»¶owner:"></a>69.è·å–æ–‡ä»¶owner:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">stat</span> -c %U file.txt</div></pre></td></tr></table></figure><h2 id="70-blockè®¾å¤‡åˆ—è¡¨ï¼š"><a href="#70-blockè®¾å¤‡åˆ—è¡¨ï¼š" class="headerlink" title="70.blockè®¾å¤‡åˆ—è¡¨ï¼š"></a>70.blockè®¾å¤‡åˆ—è¡¨ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsblk -f</div></pre></td></tr></table></figure><h2 id="71-æ‰¾å‡ºæ–‡ä»¶åç»“å°¾æœ‰ç©ºæ ¼çš„æ–‡ä»¶ï¼š"><a href="#71-æ‰¾å‡ºæ–‡ä»¶åç»“å°¾æœ‰ç©ºæ ¼çš„æ–‡ä»¶ï¼š" class="headerlink" title="71.æ‰¾å‡ºæ–‡ä»¶åç»“å°¾æœ‰ç©ºæ ¼çš„æ–‡ä»¶ï¼š"></a>71.æ‰¾å‡ºæ–‡ä»¶åç»“å°¾æœ‰ç©ºæ ¼çš„æ–‡ä»¶ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> egrep -l <span class="string">" +$"</span> &#123;&#125; \;</div></pre></td></tr></table></figure><h2 id="72-æ‰¾å‡ºæ–‡ä»¶åæœ‰tabç¼©è¿›ç¬¦çš„æ–‡ä»¶"><a href="#72-æ‰¾å‡ºæ–‡ä»¶åæœ‰tabç¼©è¿›ç¬¦çš„æ–‡ä»¶" class="headerlink" title="72.æ‰¾å‡ºæ–‡ä»¶åæœ‰tabç¼©è¿›ç¬¦çš„æ–‡ä»¶"></a>72.æ‰¾å‡ºæ–‡ä»¶åæœ‰tabç¼©è¿›ç¬¦çš„æ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> egrep -l $<span class="string">'\t'</span> &#123;&#125; \;</div></pre></td></tr></table></figure><h2 id="73-ç”¨â€-â€æ‰“å°å‡ºæ¨ªçº¿-å…¨é€‰å¤åˆ¶æ”¾è¿›ç¬”è®°"><a href="#73-ç”¨â€-â€æ‰“å°å‡ºæ¨ªçº¿-å…¨é€‰å¤åˆ¶æ”¾è¿›ç¬”è®°" class="headerlink" title="73.ç”¨â€=â€æ‰“å°å‡ºæ¨ªçº¿:å…¨é€‰å¤åˆ¶æ”¾è¿›ç¬”è®°"></a>73.ç”¨â€=â€æ‰“å°å‡ºæ¨ªçº¿:å…¨é€‰å¤åˆ¶æ”¾è¿›ç¬”è®°</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">printf</span> <span class="string">'%100s\n'</span> | tr <span class="string">' '</span> =</div></pre></td></tr></table></figure><h2 id="74-å½“ä¸€ä¸ªæ–‡ä»¶è¾ƒå¤§ï¼Œrm-rf-ä¹Ÿæ— æ³•åˆ é™¤æ—¶"><a href="#74-å½“ä¸€ä¸ªæ–‡ä»¶è¾ƒå¤§ï¼Œrm-rf-ä¹Ÿæ— æ³•åˆ é™¤æ—¶" class="headerlink" title="74.å½“ä¸€ä¸ªæ–‡ä»¶è¾ƒå¤§ï¼Œrm -rf ä¹Ÿæ— æ³•åˆ é™¤æ—¶"></a>74.å½“ä¸€ä¸ªæ–‡ä»¶è¾ƒå¤§ï¼Œrm -rf ä¹Ÿæ— æ³•åˆ é™¤æ—¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">''</span> &gt; filename</div><div class="line">rm -rf filename</div></pre></td></tr></table></figure><h2 id="75-ç»Ÿè®¡è®¿é—®é‡å‰5çš„ip"><a href="#75-ç»Ÿè®¡è®¿é—®é‡å‰5çš„ip" class="headerlink" title="75.ç»Ÿè®¡è®¿é—®é‡å‰5çš„ip"></a>75.ç»Ÿè®¡è®¿é—®é‡å‰5çš„ip</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cat /var/<span class="built_in">log</span>/nginx/access.log| cut -d <span class="string">" "</span> -f 1  | sort -r | uniq  -c | sort -nr | head -n5</div><div class="line">awk &#123;<span class="string">'print $1'</span>&#125; /var/<span class="built_in">log</span>/nginx/access.log | sort -r | uniq -c  | sort -nr  | head -5</div></pre></td></tr></table></figure><h2 id="76-CPUå ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ï¼š"><a href="#76-CPUå ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ï¼š" class="headerlink" title="76.CPUå ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ï¼š"></a>76.CPUå ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹ï¼š</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps auxw|head -1;ps auxw|sort -rn -k3|head -10</div></pre></td></tr></table></figure><h2 id="78-å†…å­˜æ¶ˆè€—æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹"><a href="#78-å†…å­˜æ¶ˆè€—æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹" class="headerlink" title="78.å†…å­˜æ¶ˆè€—æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹"></a>78.å†…å­˜æ¶ˆè€—æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps auxw|head -1;ps auxw|sort -rn -k4|head -10</div></pre></td></tr></table></figure><h2 id="79-è™šæ‹Ÿå†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹"><a href="#79-è™šæ‹Ÿå†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹" class="headerlink" title="79.è™šæ‹Ÿå†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹"></a>79.è™šæ‹Ÿå†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰10ä¸ªè¿›ç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps auxw|head -1;ps auxw|sort -rn -k5|head -10</div></pre></td></tr></table></figure><h2 id="80-å°†443ç«¯å£è½¬å‘åˆ°8080ç«¯å£"><a href="#80-å°†443ç«¯å£è½¬å‘åˆ°8080ç«¯å£" class="headerlink" title="80.å°†443ç«¯å£è½¬å‘åˆ°8080ç«¯å£"></a>80.å°†443ç«¯å£è½¬å‘åˆ°8080ç«¯å£</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 8080</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir -p /root/config</div><div class="line">touch /root/config/postfix-accounts.cf</div><div class="line">docker run --rm \</div><div class="line"> -e MAIL_USER=renjin@ssjinyao.com \</div><div class="line"> -e MAIL_PASS=centos.123\</div><div class="line"> -ti tvial/docker-mailserver:latest \</div><div class="line"> /bin/sh -c &apos;echo &quot;$MAIL_USER|$(doveadm pw -s SHA512-CRYPT -u $MAIL_USER -p $MAIL_PASS)&quot;&apos; &gt;&gt; /root/config/postfix-accounts.cf</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx è´Ÿè½½å‡è¡¡å¤šä¸ªnmmpä¸»æœº</title>
      <link href="/2018/02/07/Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%A4%9A%E4%B8%AAnmmp%E4%B8%BB%E6%9C%BA/"/>
      <url>/2018/02/07/Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%A4%9A%E4%B8%AAnmmp%E4%B8%BB%E6%9C%BA/</url>
      <content type="html"><![CDATA[<h2 id="è®¾è®¡æ‹“æ‰‘å›¾"><a href="#è®¾è®¡æ‹“æ‰‘å›¾" class="headerlink" title="è®¾è®¡æ‹“æ‰‘å›¾"></a>è®¾è®¡æ‹“æ‰‘å›¾</h2><p><img src="/images/nginx_upstream_lnmp.png" alt=""></p><h2 id="ä¸€ã€Memcacheç®€ä»‹"><a href="#ä¸€ã€Memcacheç®€ä»‹" class="headerlink" title="ä¸€ã€Memcacheç®€ä»‹"></a>ä¸€ã€Memcacheç®€ä»‹</h2><h3 id="cache-ç¼“å­˜ç³»ç»Ÿ"><a href="#cache-ç¼“å­˜ç³»ç»Ÿ" class="headerlink" title="cache(ç¼“å­˜ç³»ç»Ÿ)"></a>cache(ç¼“å­˜ç³»ç»Ÿ)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">é«˜æ€§èƒ½åˆ†å¸ƒå¼ç¼“å­˜æœåŠ¡å™¨ï¼Œç¼“å­˜æ‰€æœ‰çš„â€œå¯æµå¼åŒ–â€æ•°æ®</div><div class="line">livejournalæ——ä¸‹Danga Interaciveå…¬å¸ </div><div class="line">ç¨‹åº=æŒ‡ä»¤+æ•°æ®</div><div class="line">æŒ‡ä»¤ï¼šç¨‹åº</div><div class="line">æ•°æ®ï¼šIOæ“ä½œ</div><div class="line">æ–‡ä»¶ç³»ç»Ÿï¼š</div><div class="line">ç‰¹å¾ï¼šåè®®ç®€å•</div><div class="line">åŸºäºlibeventçš„äº‹ä»¶å¤„ç†</div><div class="line">å†…ç½®å†…å­˜å­˜å‚¨æ–¹å¼</div><div class="line">memcached ä¸äº’é€šä¿¡çš„åˆ†å¸ƒå¼</div><div class="line">ç”±äºä¸€å°memcachedå˜åŠ¨æ—¶ä¼šå¯¼è‡´æ•°æ®æ— æ³•æŸ¥è¯¢åˆ°ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ä¸€è‡´æ€§hashç®—æ³•</div><div class="line">ä¸€å°memcachedå˜åŠ¨æ—¶ï¼Œæ•°æ®ä¼šä¸¢å¤±ã€‚memcachedä¹‹é—´ä¸èƒ½äº’ç›¸é€šä¿¡ï¼Œæ‰€ä»¥ä¸æ”¯æŒå†—ä½™ã€‚</div><div class="line">æ³¨:memcacchedæœåŠ¡é‡å¯æ—¶ï¼Œç¼“å­˜çš„æ•°æ®ä¼šä¸¢å¤±ï¼›</div><div class="line">CentOS 7 memcachedçš„å®‰è£…æµç¨‹ï¼›</div><div class="line">base repository;</div><div class="line">æœåŠ¡ç«¯ç¨‹åº:memcached</div></pre></td></tr></table></figure><h3 id="ç¨‹åºç¯å¢ƒ"><a href="#ç¨‹åºç¯å¢ƒ" class="headerlink" title="ç¨‹åºç¯å¢ƒ"></a>ç¨‹åºç¯å¢ƒ</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">é…ç½®æ–‡ä»¶ï¼› /etc/sysconfig/memcached</div><div class="line">ä¸»ç¨‹åº:/usr/bin/memcached</div><div class="line">å·¥å…·/usr/bin/memcached-tool</div><div class="line">unitfile /usr/lib/systemd/system/memcached.service</div><div class="line">libmemcached:libmemcached æ˜¯ä¸€ä¸ªC/C++å¯¹äºmemcachedæœåŠ¡å™¨çš„å®¢æˆ·ç«¯åº“å’Œå·¥å…·</div><div class="line">libmemcached-devel:è¿™ä¸ªåŒ…ä¸­åŒ…æ¶µlibmemcachedçš„å¤´æ–‡ä»¶å’Œåº“</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">    Memcachedå‘½ä»¤è¯¦è§£ </div><div class="line">    memcached</div><div class="line">memcached [options]:</div><div class="line">-l &lt;ip_addr&gt;:ç›‘å¬çš„åœ°å€</div><div class="line">-d Run memcahched as a daemon</div><div class="line">-m &lt;num&gt; ç¼“å­˜ç©ºé—´æœ€å¤§å€¼</div><div class="line">-u &lt;username&gt;:è¿›ç¨‹å±ä¸»</div><div class="line">-p &lt;num&gt;:ç›‘å¬çš„tcpç«¯å£ï¼Œé»˜è®¤ä¸º11211</div><div class="line">-U &lt;num&gt;:ç›‘å¬çš„udpç«¯å£ï¼Œ0è¡¨ç¤ºå…³é—­</div><div class="line">-M å½“ç¼“å­˜æ»¡æ—¶ï¼Œç¦æ­¢å¯¹ç¼“å­˜æ¸…ç†</div><div class="line">-c æœ€å¤§å¹¶å‘è¿æ¥æ•°</div><div class="line">-t &lt;threads&gt;ç”¨äºæŒ‡å®šæœåŠ¡å™¨å¯åŠ¨çš„çº¿ç¨‹æ•°ï¼›æ¯ä¸ªçº¿ç¨‹æ•°å“åº”å¤šä¸ªè¯·æ±‚</div><div class="line">Slab Allocator:å†…å­˜åˆ†é…å™¨</div><div class="line">é¢„å…ˆåˆ†é…å¥½å›ºå®šå¤§å°ï¼ˆslab classï¼‰å†…å­˜å—ï¼Œæ¯ç§å¤§å°çš„å—ï¼ˆchunkï¼‰æœ‰1 æˆ–å¤šä¸ªï¼›</div><div class="line">ç›¸ä¿¡çš„slab classçš„å¤§å°å·®åˆ«ç”±å¢é•¿å› å­æ§åˆ¶;-f&lt;factor&gt;,é»˜è®¤ä¸º1.25</div><div class="line"># vim /etc/sysconfig/memcached</div><div class="line">OPITONS=&quot; -f 1.1 -U 0&quot; å¯ä»¥æ›´æ”¹</div></pre></td></tr></table></figure><h3 id="phpè¿æ¥memcachedç¨‹åº"><a href="#phpè¿æ¥memcachedç¨‹åº" class="headerlink" title="phpè¿æ¥memcachedç¨‹åº"></a>phpè¿æ¥memcachedç¨‹åº</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">php-pecl-memcache</div><div class="line">php-pecl-memcached</div><div class="line">Clusterä¿æŒä¼šè¯çš„æ–¹æ³•</div><div class="line">session sticky</div><div class="line">session cluster</div><div class="line">session server</div></pre></td></tr></table></figure><h2 id="äºŒã€å®‰è£…é…ç½®memcached-php-fpm-nginx"><a href="#äºŒã€å®‰è£…é…ç½®memcached-php-fpm-nginx" class="headerlink" title="äºŒã€å®‰è£…é…ç½®memcached,php-fpm,nginx"></a>äºŒã€å®‰è£…é…ç½®memcached,php-fpm,nginx</h2><h3 id="node3-å®‰è£…memcached"><a href="#node3-å®‰è£…memcached" class="headerlink" title="node3 å®‰è£…memcached"></a>node3 å®‰è£…memcached</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ansible node3 -m yum -a "name=memcached state=present"</span></div><div class="line"><span class="comment"># ansible node3 -m command -a "rpm -ql memcached"</span></div><div class="line"><span class="comment"># ansible node3 -m service -a "name=memcached state=started"</span></div></pre></td></tr></table></figure><h3 id="node0-1-2å®‰è£…nginx"><a href="#node0-1-2å®‰è£…nginx" class="headerlink" title="node0,1,2å®‰è£…nginx"></a>node0,1,2å®‰è£…nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m copy -a "src=/root/nginx-1.10.0-1.el7.ngx.x86_64.rpm dest=/root/ " ; done</span></div><div class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ssh node$i yum -y install  /root/nginx-1.10.0-1.el7.ngx.x86_64.rpm ; done</span></div><div class="line">node1,2å®‰è£…php-fpm mariadb php-pecl-memcached php-memcache php-memcached</div><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m yum -a "name=mariadb-server state=present" ; done</span></div><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m yum -a "name=php-fpm state=present" ; done</span></div><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m service -a "name=mariadb enabled=on" ; done</span></div><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m yum -a "name=php-pecl-memcached state=present" ; done</span></div><div class="line"><span class="comment"># ll /usr/lib64/php/modules/ å®‰è£…å®Œ php-peclmemcached åå¯ä»¥çœ‹åˆ° memcached.so</span></div><div class="line">-rwxr-xr-x 1 root root Â 118160 Apr Â 2 Â 2014 memcached.so</div><div class="line">-rwxr-xr-x 1 root root Â 106160 Jun 10 Â 2014 memcache.so</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ansible node$i -m yum -a "name=php-memcache state=present";done;</span></div><div class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ansible node$i -m yum -a "name=php-memcached state=present";done;</span></div><div class="line"><span class="comment"># vim /etc/php.ini </span></div><div class="line"><span class="comment"># æ³¨è¿™é‡Œç”¨çš„æ˜¯ansible æ‰€ä»¥å¯ä»¥ä¿®æ”¹æˆ–ç¼–è¾‘å¥½ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åå¤åˆ¶åˆ°å…¶å®ƒçš„ä¸¤ä¸ªåœ¨çº¿çš„ç»“ç‚¹</span></div><div class="line">[PHP]  </div><div class="line">extension = <span class="string">"/usr/lib64/php/modules/memcache.so"</span>  æ³¨ï¼šè¦ä¿®æ”¹çš„åœ°æ–¹</div><div class="line">extension = <span class="string">"/usr/lib64/php/modules/memcached.so"</span> æ³¨ï¼šè¦ä¿®æ”¹çš„åœ°æ–¹</div><div class="line">session.save_handler = memcached  æ³¨:éœ€è¦ä¿®æ”¹</div><div class="line">session.save_path = <span class="string">"tcp://node3:11211 æ³¨ï¼šéœ€è¦ä¿®æ”¹ </span></div><div class="line"><span class="string"># for i in &#123;1..2&#125;; do ansible node<span class="variable">$i</span> -m copy -a "</span>src=/etc/php.ini dest=/etc/ <span class="string">" ; done</span></div><div class="line"><span class="string"># for i in &#123;1..2&#125;; do ansible node<span class="variable">$i</span> -m service -a "</span>name=php-fpm state=started <span class="string">" ; done</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/nginx/conf.d/default.conf</span></div><div class="line">server &#123;</div><div class="line">listen       80;</div><div class="line">server_name  localhost;</div><div class="line">location / &#123;</div><div class="line">       root   /usr/share/nginx/html;</div><div class="line">       index  index.html index.htm index.php;</div><div class="line">&#125;</div><div class="line">error_page   500 502 503 504  /50x.html;</div><div class="line">location = /50x.html &#123;</div><div class="line">root   /usr/share/nginx/html;</div><div class="line">&#125;</div><div class="line">location ~ \.php$ &#123;</div><div class="line">root           /usr/share/nginx/html;</div><div class="line">fastcgi_pass   127.0.0.1:9000;</div><div class="line">fastcgi_index  index.php;</div><div class="line">fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html<span class="variable">$fastcgi_script_name</span>;</div><div class="line">include        fastcgi_params;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#vim /usr/share/nginx/html/index.php</span></div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">phpinfo() ;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure><h3 id="å°†nignxçš„é…ç½®æ–‡ä»¶å’Œphpçš„æµ‹è¯•é¡µå¤åˆ¶åˆ°ä¸¤ä¸ªç»“ç‚¹ä¸Š"><a href="#å°†nignxçš„é…ç½®æ–‡ä»¶å’Œphpçš„æµ‹è¯•é¡µå¤åˆ¶åˆ°ä¸¤ä¸ªç»“ç‚¹ä¸Š" class="headerlink" title="å°†nignxçš„é…ç½®æ–‡ä»¶å’Œphpçš„æµ‹è¯•é¡µå¤åˆ¶åˆ°ä¸¤ä¸ªç»“ç‚¹ä¸Š"></a>å°†nignxçš„é…ç½®æ–‡ä»¶å’Œphpçš„æµ‹è¯•é¡µå¤åˆ¶åˆ°ä¸¤ä¸ªç»“ç‚¹ä¸Š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m copy -a "src=/etc/nginx/conf.d/default.conf dest=/etc/nginx/conf.d/ " ; done</span></div><div class="line"><span class="comment"># for i in &#123;1..2&#125;; do ansible node$i -m copy -a "src=/usr/share/nginx/html/index.php dest=/usr/share/nginx/html/ " ; done</span></div><div class="line">å¯åŠ¨ä¸¤ä¸ªç»“ç‚¹(node1,node2)çš„nginx</div><div class="line"><span class="comment"># for i in &#123;1..2&#125; ; do ansible node$i -m service -a "name=nginx state=started";done;</span></div></pre></td></tr></table></figure><p><code>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ http://172.16.23.11/index.php</code><br>æŸ¥çœ‹ä¸¤ä¸ªç»“ç‚¹çš„phpæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå¹¶ä¸”æŸ¥çœ‹å…¶index.phpä¸­æä¾›çš„phpinfo(); php<br>é…ç½®ä¿¡æ¯ ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°memcache å’Œmemcachedä¸¤é¡¹<br><img src="/images/nginx_upstream_test1.png" alt=""><br><img src="/images/nginx_upstream_test2.png" alt=""></p><p><code>è®¿é—® http://172.16.23.12/index.php</code></p><p><img src="/images/nginx_upstream_test3.png" alt=""><br><img src="/images/nginx_upstream_test4.png" alt=""></p><h2 id="ä¸‰ã€åœ¨node0ç»“ç‚¹ä¸Šé…ç½®nginxè´Ÿè½½å‡è¡¡"><a href="#ä¸‰ã€åœ¨node0ç»“ç‚¹ä¸Šé…ç½®nginxè´Ÿè½½å‡è¡¡" class="headerlink" title="ä¸‰ã€åœ¨node0ç»“ç‚¹ä¸Šé…ç½®nginxè´Ÿè½½å‡è¡¡"></a>ä¸‰ã€åœ¨node0ç»“ç‚¹ä¸Šé…ç½®nginxè´Ÿè½½å‡è¡¡</h2><p>åå°ä¸¤å°(node1,node2)ä¸»æœºï¼Œä¸ºä¸¤ç»“ç‚¹é€šè¿‡phpç¨‹åºæµ‹è¯•mariadb<br>æ³¨ï¼š</p><ol><li>ç”±äºansibleå°±åœ¨node0ä¸Šï¼Œæ‰€ä»¥æ­¤å¤„ç›´æ¥ç”¨ç³»ç»Ÿè‡ªèº«çš„å‘½ä»¤æ¥è¿›è¡Œé…ç½®ï¼Œè€Œéè¿œç¨‹æ‰§è¡Œ;</li><li>æŠŠåˆšåˆšç»™node1,node2è¿œç¨‹å¤åˆ¶çš„default.confé…ç½®è¿˜åŸè¿˜å»;</li><li>ç”±äºnode0çš„nginxæ— å…¶å®ƒå°†é…ç½®æ–‡ä»¶åˆ äº†é‡æ–°å®‰è£…ä¸€ä¸‹nignx ä¹Ÿè¡Œï¼›</li></ol><h3 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment"># åœ¨httpæ®µä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹</span></div><div class="line">upstream mem &#123;</div><div class="line">server node1:80;</div><div class="line">server node2:80;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/nginx/conf.d/default.conf</span></div><div class="line"><span class="comment"># åœ¨æ¯ä¸€ä¸ªlocationä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹</span></div><div class="line">proxy_pass http://mem;</div><div class="line"><span class="comment"># systemctrl start nginx</span></div></pre></td></tr></table></figure><p>æ­¤æ—¶nginxå·²ç»å¯ä»¥è´Ÿè½½å‡è¡¡åé¢çš„ä¸¤å°æœåŠ¡å™¨äº†<br>ä¸ºnode1,node2æä¾›ä¸¤ä¸ªphpè¿æ¥mysqlçš„æµ‹è¯•é¡µ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;h1&gt;www.rj.com NODE2&lt;/h1&gt;</div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$link=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"centos.123"</span>);</div><div class="line"><span class="keyword">if</span>(!$link)<span class="keyword">echo</span><span class="string">"CNONNECT FILED!"</span>;</div><div class="line"><span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"CAN CNONNECT !"</span>;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure><p>æ­¤æ—¶è®¿é—®nginxçš„è´Ÿè½½å‡è¡¡çš„ç»“ç‚¹172.16.23.10åå¯æµ‹è¯•ç»“æœå¦‚ä¸‹</p><p><img src="/images/nginx_upstream_test5.png" alt=""><br><img src="/images/nginx_upstream_test6.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MariaDBä¹‹åŸºäºopensslçš„ä¸»ä»å¤åˆ¶</title>
      <link href="/2018/02/07/MariaDB%E4%B9%8B%E5%9F%BA%E4%BA%8Eopenssl%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
      <url>/2018/02/07/MariaDB%E4%B9%8B%E5%9F%BA%E4%BA%8Eopenssl%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€é…ç½®openssl"><a href="#ä¸€ã€é…ç½®openssl" class="headerlink" title="ä¸€ã€é…ç½®openssl"></a>ä¸€ã€é…ç½®openssl</h2><h3 id="1ã€-åœ¨master-server-node0-ä¸Šæ ¹CAçš„æ­å»º-åŠç”Ÿæˆè‡ªç­¾åè¯ä¹¦"><a href="#1ã€-åœ¨master-server-node0-ä¸Šæ ¹CAçš„æ­å»º-åŠç”Ÿæˆè‡ªç­¾åè¯ä¹¦" class="headerlink" title="1ã€   åœ¨master server(node0)ä¸Šæ ¹CAçš„æ­å»º(åŠç”Ÿæˆè‡ªç­¾åè¯ä¹¦)"></a>1ã€   åœ¨master server(node0)ä¸Šæ ¹CAçš„æ­å»º(åŠç”Ÿæˆè‡ªç­¾åè¯ä¹¦)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@node0 ~]<span class="comment"># cd /etc/pki/CA/</span></div><div class="line">[root@node0 CA]<span class="comment"># (umask 077;openssl genrsa -out private/cakey.pem 2048)</span></div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">.................+++</div><div class="line">..................+++</div><div class="line">e is 65537 (0x10001)</div><div class="line">[root@node0 CA]<span class="comment"># touch index.txt </span></div><div class="line">[root@node0 CA]<span class="comment"># echo 01 &gt; serial</span></div><div class="line">[root@node0 CA]<span class="comment"># openssl req -new -x509 -key private/cakey.pem -out ./cacert.pem -days 3650</span></div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [XX]:CN</div><div class="line">State or Province Name (full name) []:BJ</div><div class="line">Locality Name (eg, city) [Default City]:BJ</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:rj</div><div class="line">Organizational Unit Name (eg, section) []:rj</div><div class="line">Common Name (eg, your name or your server<span class="string">'s hostname) []:www.rj.com</span></div><div class="line"><span class="string">Email Address []:</span></div></pre></td></tr></table></figure><h3 id="2ã€ä¸ºmasterä¸»æœºç”Ÿæˆå¯†é’¥ï¼Œå¹¶åä¸ºä¹‹ç­¾å"><a href="#2ã€ä¸ºmasterä¸»æœºç”Ÿæˆå¯†é’¥ï¼Œå¹¶åä¸ºä¹‹ç­¾å" class="headerlink" title="2ã€ä¸ºmasterä¸»æœºç”Ÿæˆå¯†é’¥ï¼Œå¹¶åä¸ºä¹‹ç­¾å"></a>2ã€ä¸ºmasterä¸»æœºç”Ÿæˆå¯†é’¥ï¼Œå¹¶åä¸ºä¹‹ç­¾å</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@node0 CA]<span class="comment"># cd /etc/my.cnf.d/</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># (umask 077;openssl genrsa -out master.key 2048)</span></div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">...............................................+++</div><div class="line">................+++</div><div class="line">e is 65537 (0x10001)</div><div class="line">[root@node0 my.cnf.d]<span class="comment"># openssl req -new -key /etc/my.cnf.d/master.key -out /etc/my.cnf.d/master.csr</span></div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [XX]:CN</div><div class="line">State or Province Name (full name) []:BJ  </div><div class="line">Locality Name (eg, city) [Default City]:BJ</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:rj</div><div class="line">Organizational Unit Name (eg, section) []:rj</div><div class="line">Common Name (eg, your name or your server<span class="string">'s hostname) []:www.rj.com</span></div><div class="line"><span class="string">Email Address []:</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">Please enter the following '</span>extra<span class="string">' attributes</span></div><div class="line"><span class="string">to be sent with your certificate request</span></div><div class="line"><span class="string">A challenge password []:</span></div><div class="line"><span class="string">An optional company name []:</span></div></pre></td></tr></table></figure><h3 id="3ã€æ ¹CAç­¾å‘masterè¯·æ±‚"><a href="#3ã€æ ¹CAç­¾å‘masterè¯·æ±‚" class="headerlink" title="3ã€æ ¹CAç­¾å‘masterè¯·æ±‚"></a>3ã€æ ¹CAç­¾å‘masterè¯·æ±‚</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[root@node0 my.cnf.d]<span class="comment"># openssl ca -in master.csr -out master.crt -days 3650</span></div><div class="line">Using configuration from /etc/pki/tls/openssl.cnf</div><div class="line">Check that the request matches the signature</div><div class="line">Signature ok</div><div class="line">Certificate Details:</div><div class="line">        Serial Number: 1 (0x1)</div><div class="line">        Validity</div><div class="line">            Not Before: Feb 16 06:55:06 2017 GMT</div><div class="line">            Not After : Feb 14 06:55:06 2027 GMT</div><div class="line">        Subject:</div><div class="line">            countryName               = CN</div><div class="line">            stateOrProvinceName       = BJ</div><div class="line">            organizationName          = rj</div><div class="line">            organizationalUnitName    = rj</div><div class="line">            commonName                = www.rj.com</div><div class="line">        X509v3 extensions:</div><div class="line">            X509v3 Basic Constraints: </div><div class="line">                CA:FALSE</div><div class="line">            Netscape Comment: </div><div class="line">                OpenSSL Generated Certificate</div><div class="line">            X509v3 Subject Key Identifier: </div><div class="line">                B4:A1:66:8C:5B:2B:F9:59:9D:F6:4F:F7:35:72:E2:87:9C:A5:95:F9</div><div class="line">            X509v3 Authority Key Identifier: </div><div class="line">                keyid:71:DD:03:78:51:12:5F:58:C2:1B:53:76:A0:2B:E9:BF:60:D8:67:36</div><div class="line"></div><div class="line">Certificate is to be certified until Feb 14 06:55:06 2027 GMT (3650 days)</div><div class="line">Sign the certificate? [y/n]:y</div><div class="line"></div><div class="line"></div><div class="line">1 out of 1 certificate requests certified, commit? [y/n]y</div><div class="line">Write out database with 1 new entries</div><div class="line">Data Base Updated</div></pre></td></tr></table></figure><h3 id="4ã€ä¸ºslaveç»“ç‚¹-node1-é…ç½®openssl"><a href="#4ã€ä¸ºslaveç»“ç‚¹-node1-é…ç½®openssl" class="headerlink" title="4ã€ä¸ºslaveç»“ç‚¹(node1)é…ç½®openssl"></a>4ã€ä¸ºslaveç»“ç‚¹(node1)é…ç½®openssl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@node1 CA]<span class="comment"># cd /etc/my.cnf.d/</span></div><div class="line">[root@node1 my.cnf.d]<span class="comment"># (umask 077;openssl genrsa -out slave.key 2048)</span></div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">.............+++</div><div class="line">......................................................................................................................................................................................................................................................+++</div><div class="line">e is 65537 (0x10001)</div><div class="line">[root@node1 my.cnf.d]<span class="comment"># openssl req -new -key slave.key -out slave.csr</span></div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [XX]:CN</div><div class="line">State or Province Name (full name) []:BJ</div><div class="line">Locality Name (eg, city) [Default City]:BJ</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:rj</div><div class="line">Organizational Unit Name (eg, section) []:rj</div><div class="line">Common Name (eg, your name or your server<span class="string">'s hostname) []:www.rj.com</span></div><div class="line"><span class="string">Email Address []:</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">Please enter the following '</span>extra<span class="string">' attributes</span></div><div class="line"><span class="string">to be sent with your certificate request</span></div><div class="line"><span class="string">A challenge password []:</span></div><div class="line"><span class="string">An optional company name []:</span></div><div class="line"><span class="string">[root@node1 my.cnf.d]# scp slave.csr node0:/tmp</span></div><div class="line"><span class="string">The authenticity of host '</span>node0 (172.16.23.10)<span class="string">' can'</span>t be established.</div><div class="line">ECDSA key fingerprint is 2b:98:49:35:5b:78:24:ed:f0:ab:fa:54:b1:8e:df:29.</div><div class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</div><div class="line">Warning: Permanently added <span class="string">'node0,172.16.23.10'</span> (ECDSA) to the list of known hosts.</div><div class="line">root@node0<span class="string">'s password: </span></div><div class="line"><span class="string">slave.csr</span></div></pre></td></tr></table></figure><h3 id="5ã€ä¸ºslaveç»“ç‚¹ç­¾å‘è¯·æ±‚"><a href="#5ã€ä¸ºslaveç»“ç‚¹ç­¾å‘è¯·æ±‚" class="headerlink" title="5ã€ä¸ºslaveç»“ç‚¹ç­¾å‘è¯·æ±‚"></a>5ã€ä¸ºslaveç»“ç‚¹ç­¾å‘è¯·æ±‚</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@node0 my.cnf.d]<span class="comment"># mv /etc/pki/CA/serial /root/</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># mv /etc/pki/CA/index.txt /root/</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># touch /etc/pki/CA/index.txt</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># echo 01 &gt; /etc/pki/CA/serial</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># openssl ca -in /tmp/slave.csr -out slave.crt -days 3650</span></div><div class="line">Using configuration from /etc/pki/tls/openssl.cnf</div><div class="line">Check that the request matches the signature</div><div class="line">Signature ok</div><div class="line">Certificate Details:</div><div class="line">        Serial Number: 1 (0x1)</div><div class="line">        Validity</div><div class="line">            Not Before: Feb 16 07:07:14 2017 GMT</div><div class="line">            Not After : Feb 14 07:07:14 2027 GMT</div><div class="line">        Subject:</div><div class="line">            countryName               = CN</div><div class="line">            stateOrProvinceName       = BJ</div><div class="line">            organizationName          = rj</div><div class="line">            organizationalUnitName    = rj</div><div class="line">            commonName                = www.rj.com</div><div class="line">        X509v3 extensions:</div><div class="line">            X509v3 Basic Constraints: </div><div class="line">                CA:FALSE</div><div class="line">            Netscape Comment: </div><div class="line">                OpenSSL Generated Certificate</div><div class="line">            X509v3 Subject Key Identifier: </div><div class="line">                A5:FE:11:EB:4D:B5:F1:85:61:E7:18:E3:1D:B7:25:C6:1B:24:97:AF</div><div class="line">            X509v3 Authority Key Identifier: </div><div class="line">                keyid:71:DD:03:78:51:12:5F:58:C2:1B:53:76:A0:2B:E9:BF:60:D8:67:36</div><div class="line"></div><div class="line">Certificate is to be certified until Feb 14 07:07:14 2027 GMT (3650 days)</div><div class="line">Sign the certificate? [y/n]:y</div><div class="line"></div><div class="line"></div><div class="line">1 out of 1 certificate requests certified, commit? [y/n]y</div><div class="line">Write out database with 1 new entries</div><div class="line">Data Base Updated</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node0 my.cnf.d]<span class="comment"># scp slave.crt node1:/etc/my.cnf.d/</span></div><div class="line">slave.crt                                                                                                                                                    100% 4382     4.3KB/s   00:00    </div><div class="line"><span class="comment"># æ­¤æ—¶ä¸»ä»ç»“ç‚¹çš„è¯ä¹¦éƒ½å·²ç»å‡†å¤‡å¥½</span></div></pre></td></tr></table></figure><h2 id="äºŒã€é…ç½®mariadbä¸»ä»æœåŠ¡å™¨"><a href="#äºŒã€é…ç½®mariadbä¸»ä»æœåŠ¡å™¨" class="headerlink" title="äºŒã€é…ç½®mariadbä¸»ä»æœåŠ¡å™¨"></a>äºŒã€é…ç½®mariadbä¸»ä»æœåŠ¡å™¨</h2><h3 id="1ã€å·¥ä½œæ‹“æ‰‘å›¾"><a href="#1ã€å·¥ä½œæ‹“æ‰‘å›¾" class="headerlink" title="1ã€å·¥ä½œæ‹“æ‰‘å›¾"></a>1ã€å·¥ä½œæ‹“æ‰‘å›¾</h3><p><img src="/images/mariadb_openssl.png" alt=""></p><h3 id="2ã€ä¸»æœåŠ¡å™¨é…ç½®"><a href="#2ã€ä¸»æœåŠ¡å™¨é…ç½®" class="headerlink" title="2ã€ä¸»æœåŠ¡å™¨é…ç½®"></a>2ã€ä¸»æœåŠ¡å™¨é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@node0 ~]<span class="comment"># yum -y install mariadb</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># vim /etc/my.cnf</span></div><div class="line">å°†mysqldæ®µä¸­çš„é…ç½®ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">datadir=/var/lib/mysql</div><div class="line">socket=/var/lib/mysql/mysql.sock</div><div class="line">symbolic-links=0</div><div class="line">innodb-file-per-table = ON</div><div class="line">skip-name-resolve = ON</div><div class="line">server-id = 1Â </div><div class="line"><span class="built_in">log</span>-bin = master-log</div><div class="line">ssl</div><div class="line">ssl_ca=/etc/my.cnf.d/cacert.pemÂ </div><div class="line">ssl_cert=/etc/my.cnf.d/master.crt</div><div class="line">ssl_key=/etc/my.cnf.d/master.key </div><div class="line">[root@node0 my.cnf.d]<span class="comment"># cp /etc/pki/CA/cacert.pem Â .</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># chown mysql.mysql cacert.pem master.*</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># systemctl start mariadb</span></div></pre></td></tr></table></figure><h3 id="3ã€ä»æœåŠ¡é…ç½®"><a href="#3ã€ä»æœåŠ¡é…ç½®" class="headerlink" title="3ã€ä»æœåŠ¡é…ç½®"></a>3ã€ä»æœåŠ¡é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@node0 ~]<span class="comment"># yum -y install mariadb</span></div><div class="line">[root@node0 my.cnf.d]<span class="comment"># vim /etc/my.cnf</span></div><div class="line">å°†mysqldæ®µä¸­çš„é…ç½®ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹</div><div class="line">[mysqld]</div><div class="line">datadir=/var/lib/mysql</div><div class="line">socket=/var/lib/mysql/mysql.sock</div><div class="line">symbolic-links=0</div><div class="line">skip_name_resolve = ON </div><div class="line">relay-log = relay-log</div><div class="line">server-id = 2 æ³¨idå·ä¸èƒ½ä¸ä¸»æœåŠ¡çš„ä¸€æ ·</div><div class="line">ssl</div><div class="line">ssl-ca = /etc/my.cnf.d/cacert.pem</div><div class="line">ssl-cert = /etc/my.cnf.d/slave.crt</div><div class="line">ssl-key = /etc/my.cnf.d/slave.key</div><div class="line">[root@node0 my.cnf.d]<span class="comment"># scp /etc/pki/CA/cacert.pem node1:/etc/my.cnf.d/</span></div><div class="line">cacert.pemÂ </div><div class="line">[root@node1 my.cnf.d]<span class="comment"># cd /etc/my.cnf.d/ &amp;&amp; chown mysql.mysql cacert.pem slave.*</span></div><div class="line">[root@node1 my.cnf.d]<span class="comment"># systemctl start mariadb</span></div></pre></td></tr></table></figure><h3 id="4ã€ä¸»æœåŠ¡å™¨æˆæƒä¸€ä¸ªç”¨æˆ·å¯è¿æ¥mysqlæ‹‰å–äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#4ã€ä¸»æœåŠ¡å™¨æˆæƒä¸€ä¸ªç”¨æˆ·å¯è¿æ¥mysqlæ‹‰å–äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="4ã€ä¸»æœåŠ¡å™¨æˆæƒä¸€ä¸ªç”¨æˆ·å¯è¿æ¥mysqlæ‹‰å–äºŒè¿›åˆ¶æ–‡ä»¶"></a>4ã€ä¸»æœåŠ¡å™¨æˆæƒä¸€ä¸ªç”¨æˆ·å¯è¿æ¥mysqlæ‹‰å–äºŒè¿›åˆ¶æ–‡ä»¶</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO 'rj'@'172.16.23.11' IDENTIFIED BY 'centos.123' REQUIRE ssl;</div></pre></td></tr></table></figure><h3 id="5ã€é…ç½®ä»æœåŠ¡å™¨è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼Œå¹¶æ‹‰å–æ•°æ®"><a href="#5ã€é…ç½®ä»æœåŠ¡å™¨è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼Œå¹¶æ‹‰å–æ•°æ®" class="headerlink" title="5ã€é…ç½®ä»æœåŠ¡å™¨è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼Œå¹¶æ‹‰å–æ•°æ®"></a>5ã€é…ç½®ä»æœåŠ¡å™¨è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼Œå¹¶æ‹‰å–æ•°æ®</h3><p>å…ˆæŸ¥çœ‹ä¸»ç»“ç‚¹çš„äºŒè¿›åˆ¶æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; Â SHOW MASTER STATUS; </div><div class="line">+-------------------+----------+--------------+------------------+</div><div class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+-------------------+----------+--------------+------------------+</div><div class="line">| master-log.000007 |      342 |              |                  |</div><div class="line">+-------------------+----------+--------------+------------------+</div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST='172.16.23.10', MASTER_USER='rj', MASTER_PASSWORD='centos.123', MASTER_LOG_FILE='master-log.000007', MASTER_LOG_POS=245, MASTER_SSL=1, MASTER_SSL_CA='/etc/my.cnf.d/cacert.pem', MASTER_SSL_CERT='/etc/my.cnf.d/slave.crt', MASTER_SSL_KEY='/etc/my.cnf.d/slave.key';</div><div class="line">Query OK, 0 rows affected (0.03 sec)</div><div class="line">æŸ¥çœ‹ä¸»ä»æœåŠ¡å™¨çš„opensslçš„æ˜¯ç”¨å¦ç”¨</div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE '%ssl%';</div><div class="line">+<span class="comment">---------------+--------------------------+</span></div><div class="line">| Variable_name | Value                    |</div><div class="line">+<span class="comment">---------------+--------------------------+</span></div><div class="line">| have_openssl  | YES                      |</div><div class="line">| have_ssl      | YES                      |</div><div class="line">| ssl_ca        | /etc/my.cnf.d/cacert.pem |</div><div class="line">| ssl_capath    |                          |</div><div class="line">| ssl_cert      | /etc/my.cnf.d/master.crt |</div><div class="line">| ssl_cipher    |                          |</div><div class="line">| ssl_key       | /etc/my.cnf.d/master.key |</div><div class="line">+<span class="comment">---------------+--------------------------+</span></div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE '%ssl%';</div><div class="line">+<span class="comment">---------------+--------------------------+</span></div><div class="line">| Variable_name | Value                    |</div><div class="line">+<span class="comment">---------------+--------------------------+</span></div><div class="line">| have_openssl  | YES                      |</div><div class="line">| have_ssl      | YES                      |</div><div class="line">| ssl_ca        | /etc/my.cnf.d/cacert.pem |</div><div class="line">| ssl_capath    |                          |</div><div class="line">| ssl_cert      | /etc/my.cnf.d/slave.crt  |</div><div class="line">| ssl_cipher    |                          |</div><div class="line">| ssl_key       | /etc/my.cnf.d/slave.key  |</div><div class="line">+<span class="comment">---------------+--------------------------+</span></div></pre></td></tr></table></figure><h3 id="6ã€å¯ç”¨ä»æœåŠ¡å™¨"><a href="#6ã€å¯ç”¨ä»æœåŠ¡å™¨" class="headerlink" title="6ã€å¯ç”¨ä»æœåŠ¡å™¨"></a>6ã€å¯ç”¨ä»æœåŠ¡å™¨</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; START SLAVE;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS \G</div><div class="line">*************************** 1. row ***************************</div><div class="line">               Slave_IO_State: Waiting for master to send event</div><div class="line">                  Master_Host: 172.16.23.10</div><div class="line">                  Master_User: rj</div><div class="line">                  Master_Port: 3306</div><div class="line">                Connect_Retry: 60</div><div class="line">              Master_Log_File: master-log.000007</div><div class="line">          Read_Master_Log_Pos: 245</div><div class="line">               Relay_Log_File: relay-log.000003</div><div class="line">                Relay_Log_Pos: 530</div><div class="line">        Relay_Master_Log_File: master-log.000007</div><div class="line">             Slave_IO_Running: Yes  æ³¨:IO SQLè¿™ä¸¤é¡¹è¡¨ç¤ºä¸»ä»åŒæ­¥å·²ç»æ­£å­¦è¿›è¡Œ</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">              Replicate_Do_DB: </div><div class="line">          Replicate_Ignore_DB: </div><div class="line">           Replicate_Do_Table: </div><div class="line">       Replicate_Ignore_Table: </div><div class="line">      Replicate_Wild_Do_Table: </div><div class="line">  Replicate_Wild_Ignore_Table: </div><div class="line">                   Last_Errno: 0</div><div class="line">                   Last_Error: </div><div class="line">                 Skip_Counter: 0</div><div class="line">          Exec_Master_Log_Pos: 245</div><div class="line">              Relay_Log_Space: 818</div><div class="line">              Until_Condition: None</div><div class="line">               Until_Log_File: </div><div class="line">                Until_Log_Pos: 0</div><div class="line">           Master_SSL_Allowed: Yes</div><div class="line">           Master_SSL_CA_File: /etc/my.cnf.d/cacert.pem</div><div class="line">           Master_SSL_CA_Path: </div><div class="line">              Master_SSL_Cert: /etc/my.cnf.d/slave.crt</div><div class="line">            Master_SSL_Cipher: </div><div class="line">               Master_SSL_Key: /etc/my.cnf.d/slave.key</div><div class="line">        Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">                Last_IO_Errno: 0</div><div class="line">                Last_IO_Error: </div><div class="line">               Last_SQL_Errno: 0</div><div class="line">               Last_SQL_Error: </div><div class="line">  Replicate_Ignore_Server_Ids: </div><div class="line">             Master_Server_Id: 1</div><div class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure><h3 id="7ã€ç”±äºä»æœåŠ¡å™¨åªèƒ½è¯»ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯mariadbçš„åªè¯»"><a href="#7ã€ç”±äºä»æœåŠ¡å™¨åªèƒ½è¯»ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯mariadbçš„åªè¯»" class="headerlink" title="7ã€ç”±äºä»æœåŠ¡å™¨åªèƒ½è¯»ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯mariadbçš„åªè¯»"></a>7ã€ç”±äºä»æœåŠ¡å™¨åªèƒ½è¯»ï¼Œæ‰€ä»¥éœ€è¦å¼€å¯mariadbçš„åªè¯»</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt;  SHOW VARIABLES LIKE 'read_only';</div><div class="line">+<span class="comment">---------------+-------+</span></div><div class="line">| Variable_name | Value |</div><div class="line">+<span class="comment">---------------+-------+</span></div><div class="line">| read_only     | ON    |</div><div class="line">+<span class="comment">---------------+-------+</span></div><div class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; SET GLOBAL read_only=ON;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure><h3 id="8ã€opensslè¿›è¡Œæµ‹è¯•"><a href="#8ã€opensslè¿›è¡Œæµ‹è¯•" class="headerlink" title="8ã€opensslè¿›è¡Œæµ‹è¯•"></a>8ã€opensslè¿›è¡Œæµ‹è¯•</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@node1 my.cnf.d]# mysql -urj -pcentos.123 -h172.16.23.10 --ssl-ca=/etc/my.cnf.d/cacert.pem --ssl-cert=/etc/my.cnf.d/slave.crt --ssl-key=/etc/my.cnf.d/slave.key</div><div class="line">Welcome to the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; or \g.</div><div class="line">Your MariaDB connection id is 7</div><div class="line">Server version: 5.5.44-MariaDB-log MariaDB Server</div><div class="line"></div><div class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type '<span class="keyword">help</span>;' or '\h' for help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> <span class="keyword">clear</span> the <span class="keyword">current</span> <span class="keyword">input</span> statement.</div><div class="line"></div><div class="line">MariaDB [(<span class="keyword">none</span>)]&gt; <span class="keyword">SHOW</span> <span class="keyword">DATABASES</span>;</div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">| Database           |</div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">| information_schema |</div><div class="line">| test               |</div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure><h3 id="9ã€ä¸»ä»åŒæ­¥æµ‹è¯•"><a href="#9ã€ä¸»ä»åŒæ­¥æµ‹è¯•" class="headerlink" title="9ã€ä¸»ä»åŒæ­¥æµ‹è¯•"></a>9ã€ä¸»ä»åŒæ­¥æµ‹è¯•</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; CREATE DATABASE node0create;åœ¨ä¸»æœåŠ¡ä¸Šåˆ›å»ºäº†ä¸€ä¸ªåº“</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line">MariaDB [(none)]&gt; SHOW DATABASES; åœ¨ä»æœåŠ¡å™¨ä¸Šä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°äº†</div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">| Database           |</div><div class="line">+<span class="comment">--------------------+</span></div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| node0create        |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+<span class="comment">--------------------+</span></div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>corosync v2 + pacemaker + crmsh å®ç°mariadbé«˜å¯ç”¨</title>
      <link href="/2018/02/07/corosync-v2-pacemaker-crmsh-%E5%AE%9E%E7%8E%B0mariadb%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
      <url>/2018/02/07/corosync-v2-pacemaker-crmsh-%E5%AE%9E%E7%8E%B0mariadb%E9%AB%98%E5%8F%AF%E7%94%A8/</url>
      <content type="html"><![CDATA[<p>é«˜å¯ç”¨mariadbæ‹“æ‰‘å›¾</p><p><img src="/images/corosync_mariadb_rhca.png" alt=""></p><h2 id="ä¸€ã€è®¾è®¡å‰æ"><a href="#ä¸€ã€è®¾è®¡å‰æ" class="headerlink" title="ä¸€ã€è®¾è®¡å‰æ"></a>ä¸€ã€è®¾è®¡å‰æ</h2><p>1ã€æ—¶é—´åŒæ­¥ # ntpdate 172.16.0.1 æˆ–è€… # chronyc sources<br>2ã€æ‰€æœ‰çš„ä¸»æœºå¯¹åº”çš„IPåœ°å€è§£æå¯ä»¥æ­£å¸¸å·¥ä½œï¼Œ ä¸»æœºåè¦ä¸å‘½ä»¤#uname -n æ‰€å¾—çš„ç»“æœä¸€è‡´</p><p>å› æ­¤ï¼Œ/etc/hostsä¸­çš„å†…å®¹ä¸ºä»¥ä¸‹å†…å®¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">172.16.23.10Â node1.rj.comÂ node1Â </div><div class="line">172.16.23.11Â node2.rj.comÂ node2Â </div><div class="line">172.16.23.12Â node3.rj.comÂ node3</div></pre></td></tr></table></figure><h2 id="äºŒã€ç¯å¢ƒçš„å»ºç«‹åŠå®‰è£…orosync-pacemaker-crmsh"><a href="#äºŒã€ç¯å¢ƒçš„å»ºç«‹åŠå®‰è£…orosync-pacemaker-crmsh" class="headerlink" title="äºŒã€ç¯å¢ƒçš„å»ºç«‹åŠå®‰è£…orosync ,pacemaker ,crmsh"></a>äºŒã€ç¯å¢ƒçš„å»ºç«‹åŠå®‰è£…orosync ,pacemaker ,crmsh</h2><p>ä¸‰å°æœºå™¨éƒ½å®‰è£…å¥½ansible ï¼ˆå¯¹äºansibleé›†ç¾¤ç®¡ç†å·¥å…·è€Œè¨€éœ€è¦åŒæœºäº’ä¿¡,å…¶ä¸­node1å½“åšå ¡å’æœºï¼‰</p><h3 id="å®‰è£…é…ç½®"><a href="#å®‰è£…é…ç½®" class="headerlink" title="å®‰è£…é…ç½®"></a>å®‰è£…é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â ssh-keygenÂ Â </span></div><div class="line"><span class="comment">#Â forÂ iÂ inÂ &#123;10..12&#125;;Â doÂ ssh-copy-idÂ -iÂ 172.16.23.$iÂ ;Â doneÂ ;Â </span></div><div class="line"><span class="comment"># æ­¤æ¡å‘½ä»¤å°†å…¬é’¥å‘é€ç»™ä¸‰å°æœºå™¨ï¼Œå…¶ä¸­åŒ…æ‹¬è‡ªå·±ä¹Ÿå°±æ˜¯å ¡å’æœº</span></div><div class="line"><span class="comment">#Â vimÂ /etc/ansible/hostsÂ </span></div><div class="line">[mariadb]</div><div class="line">172.16.23.10</div><div class="line">172.16.23.11</div><div class="line">172.16.23.12</div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ pingÂ </span></div><div class="line"><span class="comment"># æµ‹è¯•ä¸‰å°ä¸»æœºä¸å ¡å’æœºä¹‹é—´çš„è¿é€šæ€§Â </span></div><div class="line"><span class="comment">#Â vimÂ /etc/hostsÂ ä¸»æœºåè§£æé…ç½®</span></div><div class="line">172.16.23.10Â node1.rj.comÂ node1</div><div class="line">172.16.23.11Â node2.rj.comÂ node2</div><div class="line">172.16.23.12Â node3.rj.comÂ node3</div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ commandÂ -aÂ "ntpdateÂ 172.16.0.1"Â Â åŒæ­¥ä¸‰å°ä¸»æœºçš„æ—¶é—´Â </span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ yumÂ -aÂ "name=pacemaker,mariadb-serverÂ state=present"Â åœ¨ä¸‰å°ä¸»æœºä¸Šå®‰è£…Â mariadbÂ ,corosyncÂ å’ŒÂ pacemaker</span></div></pre></td></tr></table></figure><pre><code>æ³¨ï¼šyum å®‰è£…pacemaker çš„æ—¶å€™ï¼Œå…¶corosyncä¹Ÿä¼šè‡ªåŠ¨å®‰è£…ä¸Š</code></pre><h3 id="corosyncé…ç½®"><a href="#corosyncé…ç½®" class="headerlink" title="corosyncé…ç½®"></a>corosyncé…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â vimÂ /etc/corosync/corosync.confÂ </span></div><div class="line">åŠ å…¥ä»¥ä¸‹ä¿¡æ¯</div><div class="line">totemÂ &#123;</div><div class="line">version:Â 2</div><div class="line">crypto_cipher:Â aes256</div><div class="line">crypto_hash:Â sha1</div><div class="line">interfaceÂ &#123;</div><div class="line">ringnumber:Â 0</div><div class="line">bindnetaddr:Â 172.16.0.0</div><div class="line">mcastaddr:Â 239.255.23.1</div><div class="line">mcastport:Â 5405</div><div class="line">ttl:Â 1</div><div class="line">&#125;</div><div class="line">loggingÂ &#123;</div><div class="line">fileline:Â off</div><div class="line">to_stderr:Â no</div><div class="line">to_logfile:Â yes</div><div class="line">logfile:Â /var/<span class="built_in">log</span>/cluster/corosync.log</div><div class="line">to_syslog:Â no</div><div class="line">debug:Â off</div><div class="line">timestamp:Â on</div><div class="line">logger_subsysÂ &#123;</div><div class="line">subsys:Â QUORUM</div><div class="line">debug:Â off</div><div class="line">&#125;</div><div class="line">quorumÂ &#123;</div><div class="line">provider:Â corosync_votequorum</div><div class="line">nodeÂ &#123;</div><div class="line">ring0_addr:Â node1.rj.com</div><div class="line">nodeid:1Â </div><div class="line">&#125;</div><div class="line">nodeÂ &#123;</div><div class="line">ring0_addr:Â node2.rj.com</div><div class="line">nodeid:2Â </div><div class="line">&#125;</div><div class="line"></div><div class="line">nodeÂ &#123;</div><div class="line"></div><div class="line">ring0_addr:Â node3.rj.com</div><div class="line">nodeid:3</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â corosync-keygenÂ </span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ copyÂ -aÂ "src=/etc/corosync/authkeyÂ dest=/etc/corosync/"</span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ copyÂ -aÂ "src=/etc/corosync/corosync.confÂ dest=/etc/corosync/"</span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ serviceÂ -aÂ "name=corosyncÂ state=persent"</span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ serviceÂ -aÂ "name=pacemakerÂ state=persent"</span></div><div class="line"><span class="comment">#Â Â tcpdumpÂ -iÂ eno16777736Â -nnÂ portÂ 5405</span></div></pre></td></tr></table></figure><h3 id="æŠ“åŒ…åˆ†æ"><a href="#æŠ“åŒ…åˆ†æ" class="headerlink" title="æŠ“åŒ…åˆ†æ"></a>æŠ“åŒ…åˆ†æ</h3><p>ä½¿ç”¨tcpdumpæŠ“åŒ…å·¥å…·å¯ä»¥æ¥æŸ¥çœ‹ä¸‰å°ä¸»æœºä¹‹é—´ä¼ é€’çš„å¿ƒè·³ä¿¡æ¯</p><p><img src="/images/corosync_mariadb_tcpdump.png" alt=""><br>æ³¨:mariadbåœ¨é›†ç¾¤èµ„æºçš„é…ç½®ä¸­å¿…éœ€æ˜¯å¼€æœºè‡ªå¯åŠ¨çš„<br>è¿™æ ·corosyncæ‰èƒ½å®åˆ«å…¶Unitfile æ–‡ä»¶ï¼Œè€Œä¸èƒ½åœ¨é…ç½®å‰å¯åŠ¨æ‰€ä»¥æœåŠ¡ä¸€å®šæ˜¯å…³é—­çš„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ serviceÂ -aÂ "name=mariadbÂ enabled=on"</span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ serviceÂ -aÂ "name=corosyncÂ enabled=on"</span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ serviceÂ -aÂ "name=pacemakerÂ enabled=on"</span></div><div class="line"><span class="comment">#Â mkdirÂ rpmÂ &amp;&amp;Â cdÂ rpmÂ </span></div><div class="line"><span class="comment">#Â wgetÂ 172.18.0.1/pub/Sources/7.x86_64/crmsh/crmsh-2.1.4-1.1.x86_64.rpmÂ ä¸‹è½½crmshåŠå…¶æ‰€ä¾èµ–çš„rpmåŒ…Â </span></div><div class="line"><span class="comment">#Â wgetÂ 172.18.0.1/pub/Sources/7.x86_64/crmsh/pssh*.rpm</span></div><div class="line"><span class="comment">#Â wgetÂ 172.18.0.1/pub/Sources/7.x86_64/crmsh/python-passh*.rpmÂ </span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ copyÂ -aÂ "src=/root/rpmÂ dest=/root/"</span></div><div class="line"><span class="comment">#Â forÂ iÂ inÂ &#123;1..3&#125;;Â doÂ sshÂ node$iÂ yumÂ -yÂ installÂ /root/rpm/*;Â done</span></div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹corosyncå¼•æ“æ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨"><a href="#æŸ¥çœ‹corosyncå¼•æ“æ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨" class="headerlink" title="æŸ¥çœ‹corosyncå¼•æ“æ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨"></a>æŸ¥çœ‹corosyncå¼•æ“æ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -eÂ commandÂ -aÂ "grepÂ -eÂ 'CorosyncÂ ClusterÂ Engine'Â -eÂ 'configurationÂ file'Â /var/log/messages"Â </span></div><div class="line">FebÂ 13Â 11:27:35Â node1Â systemd:Â StoppedÂ CorosyncÂ ClusterÂ Engine.</div><div class="line">FebÂ 13Â 14:08:03Â node1Â systemd:Â StartingÂ CorosyncÂ ClusterÂ Engine...</div><div class="line">FebÂ 13Â 14:08:04Â node1Â corosync:Â StartingÂ CorosyncÂ ClusterÂ EngineÂ (corosync):Â [Â Â OKÂ Â ]</div><div class="line">FebÂ 13Â 14:08:04Â node1Â systemd:Â StartedÂ CorosyncÂ ClusterÂ Engine.</div><div class="line">FebÂ 13Â 14:28:16Â node1Â systemd:Â MountedÂ NFSDÂ configurationÂ filesystem.</div><div class="line">FebÂ 13Â 14:28:44Â node1Â smartd[787]:Â OpenedÂ configurationÂ fileÂ /etc/smartmontools/smartd.conf</div><div class="line">FebÂ 13Â 14:32:12Â node1Â systemd:Â StartingÂ CorosyncÂ ClusterÂ Engine...</div><div class="line">Â Â Â Â Â Â Â Â FebÂ 13Â 14:32:13Â node1Â corosync:Â StartingÂ CorosyncÂ ClusterÂ EngineÂ (corosync):Â [Â Â OKÂ Â ]</div><div class="line">FebÂ 13Â 14:32:13Â node1Â systemd:Â StartedÂ CorosyncÂ ClusterÂ Engine.</div><div class="line">FebÂ 13Â 14:43:03Â node1Â systemd:Â StartedÂ CorosyncÂ ClusterÂ Engine.</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹å…¶æˆå‘˜ä¹‹é—´çš„ç»“ç‚¹é€šçŸ¥ä¿¡æ¯æ˜¯å¦æ­£å¸¸"><a href="#æŸ¥çœ‹å…¶æˆå‘˜ä¹‹é—´çš„ç»“ç‚¹é€šçŸ¥ä¿¡æ¯æ˜¯å¦æ­£å¸¸" class="headerlink" title="æŸ¥çœ‹å…¶æˆå‘˜ä¹‹é—´çš„ç»“ç‚¹é€šçŸ¥ä¿¡æ¯æ˜¯å¦æ­£å¸¸"></a>æŸ¥çœ‹å…¶æˆå‘˜ä¹‹é—´çš„ç»“ç‚¹é€šçŸ¥ä¿¡æ¯æ˜¯å¦æ­£å¸¸</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -eÂ commandÂ -aÂ "grepÂ TOTEMÂ /var/log/messages"</span></div><div class="line">æŸ¥çœ‹å¯åŠ¨è¿‡ç¨‹ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯äº§ç”ŸÂ </div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -eÂ commandÂ -aÂ "grepÂ 'ERROR'Â /var/log/messages"</span></div><div class="line">æŸ¥çœ‹pacemakeræ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨</div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -eÂ commandÂ -aÂ "grepÂ 'pacemaker'Â /var/log/messagesÂ "</span></div><div class="line">Â ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç»“ç‚¹çš„çŠ¶æ€</div><div class="line"><span class="comment">#Â crmÂ statusÂ Â </span></div><div class="line">LastÂ updated:Â MonÂ FebÂ 13Â 15:43:08Â 2017</div><div class="line">LastÂ change:Â MonÂ FebÂ 13Â 14:33:58Â 2017Â byÂ haclusterÂ viaÂ crmdÂ onÂ node3.rj.com</div><div class="line">Stack:Â corosyncCurrentÂ DC:Â node3.rj.comÂ (versionÂ 1.1.13-10.el7-44eb2dd)Â -Â partitionÂ withÂ quorum</div><div class="line">3Â nodesÂ andÂ 0Â resourcesÂ configuredOnline:Â [Â node1.rj.comÂ node2.rj.comÂ node3.rj.comÂ ]</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹pacemaker-å’Œä¸corosyncæ‰€å¯åŠ¨çš„è¿›ç¨‹"><a href="#æŸ¥çœ‹pacemaker-å’Œä¸corosyncæ‰€å¯åŠ¨çš„è¿›ç¨‹" class="headerlink" title="æŸ¥çœ‹pacemaker å’Œä¸corosyncæ‰€å¯åŠ¨çš„è¿›ç¨‹"></a>æŸ¥çœ‹pacemaker å’Œä¸corosyncæ‰€å¯åŠ¨çš„è¿›ç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ commandÂ -aÂ "psÂ auxfÂ "Â |Â grepÂ pacemaker</span></div><div class="line">rootÂ Â Â Â Â Â Â 1720Â Â 0.0Â Â 1.3Â 130484Â Â 6384Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:00Â /usr/sbin/pacemakerdÂ -f</div><div class="line">haclust+Â Â Â 1729Â Â 0.0Â Â 2.7Â 132816Â 13268Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:01Â Â \_Â /usr/libexec/pacemaker/cib</div><div class="line">rootÂ Â Â Â Â Â Â 1730Â Â 0.0Â Â 1.4Â 133968Â Â 6956Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:00Â Â \_Â /usr/libexec/pacemaker/stonithd</div><div class="line">rootÂ Â Â Â Â Â Â 1731Â Â 0.0Â Â 0.8Â 102936Â Â 4108Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:00Â Â \_Â /usr/libexec/pacemaker/lrmd</div><div class="line">haclust+Â Â Â 1732Â Â 0.0Â Â 1.3Â 124780Â Â 6736Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:00Â Â \_Â /usr/libexec/pacemaker/attrd</div><div class="line">haclust+Â Â Â 1733Â Â 0.0Â Â 0.7Â 114896Â Â 3668Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:00Â Â \_Â /usr/libexec/pacemaker/pengine</div><div class="line">haclust+Â Â Â 1734Â Â 0.0Â Â 1.5Â 143160Â Â 7484Â ?Â Â Â Â Â Â Â Â SsÂ Â Â 14:33Â Â Â 0:00Â Â \_Â /usr/libexec/pacemaker/crmd</div><div class="line"><span class="comment">#Â ansibleÂ marriadbÂ -mÂ commandÂ -aÂ "psÂ auxf"Â |Â grepÂ corosyncÂ </span></div><div class="line">rootÂ Â Â Â Â Â Â 1483Â Â 0.6Â Â 7.9Â 134848Â 38436Â ?Â Â Â Â Â Â Â Â SslÂ Â 14:32Â Â Â 0:28Â corosync</div></pre></td></tr></table></figure><h2 id="ä¸‰ã€åˆ©ç”¨crmshæ¥é…ç½®corosyncçš„IPåœ°å€èµ„æºåŠmariadbèµ„æº"><a href="#ä¸‰ã€åˆ©ç”¨crmshæ¥é…ç½®corosyncçš„IPåœ°å€èµ„æºåŠmariadbèµ„æº" class="headerlink" title="ä¸‰ã€åˆ©ç”¨crmshæ¥é…ç½®corosyncçš„IPåœ°å€èµ„æºåŠmariadbèµ„æº"></a>ä¸‰ã€åˆ©ç”¨crmshæ¥é…ç½®corosyncçš„IPåœ°å€èµ„æºåŠmariadbèµ„æº</h2><pre><code>å¦‚æœæƒ³è¦æŸ¥çœ‹æŸç§ç±»åˆ«ä¸‹çš„æ‰€ç”¨èµ„æºä»£ç†çš„åˆ—è¡¨ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹çš„å‘½ä»¤æ¥å®ç°</code></pre><h3 id="å®‰è£…é…ç½®-1"><a href="#å®‰è£…é…ç½®-1" class="headerlink" title="å®‰è£…é…ç½®"></a>å®‰è£…é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#crmÂ raÂ listÂ lsbÂ </span></div><div class="line"><span class="comment">#crmÂ raÂ listÂ ocfÂ heartbeatÂ </span></div><div class="line"><span class="comment">#crmÂ raÂ listÂ ocfÂ pacemakerÂ </span></div><div class="line"><span class="comment">#crmÂ raÂ listÂ ocfÂ stonith</span></div></pre></td></tr></table></figure><h3 id="é…ç½®vip"><a href="#é…ç½®vip" class="headerlink" title="é…ç½®vip"></a>é…ç½®vip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Â <span class="comment">#Â crmÂ configureÂ propertyÂ stonith-enabled=falseÂ #å…³é—­stonsthè®¾å¤‡</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â crmÂ configureÂ primitiveÂ DBIPÂ ocf:heartbeat:IPaddrÂ paramsÂ ip=172.16.23.23Â æ·»åŠ vipèµ„æºä»£ç†Â Â </span></div><div class="line"><span class="comment">#Â crmÂ configureÂ verifyÂ æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯</span></div><div class="line"><span class="comment">#Â crmÂ configureÂ commitÂ ç”¨æ¥æäº¤é…ç½®ä¿¡æ¯Â </span></div><div class="line"><span class="comment">#Â crmÂ configureÂ showÂ Â å¯ä»¥ç”¨æ¥æŸ¥çœ‹é…ç½®ä¿¡æ¯</span></div><div class="line">nodeÂ 1:Â node1.rj.com</div><div class="line">nodeÂ 2:Â node2.rj.com</div><div class="line">nodeÂ 3:Â node3.rj.com</div><div class="line">primitiveÂ DBIPÂ IPaddrÂ \</div><div class="line">paramsÂ ip=172.16.23.23</div><div class="line">propertyÂ cib-bootstrap-options:Â \</div><div class="line">have-watchdog=<span class="literal">false</span>Â \</div><div class="line">dc-version=1.1.13-10.el7-44eb2ddÂ \</div><div class="line">cluster-infrastructure=corosyncÂ \</div><div class="line">stonith-enabled=<span class="literal">false</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â crmÂ nodeÂ standbyÂ node1.rj.comå½“å°†node1ç»“ç‚¹æˆä¸ºå¤‡ç”¨ç»“ç‚¹æ—¶Â </span></div><div class="line"><span class="comment">#Â ansibleÂ mariadbÂ -mÂ commandÂ -aÂ "ipÂ addrÂ list"Â æŸ¥çœ‹å…¶vipçš„å˜åŒ–ä¿¡æ¯</span></div><div class="line"><span class="comment">#Â crmÂ raÂ infoÂ systemd:mairadbÂ ç”¨æ¥æŸ¥çœ‹systemdç±»å‹çš„mariadbèµ„æºçš„è¯­æ³•æ ¼å¼Â </span></div><div class="line">systemdÂ unitÂ fileÂ <span class="keyword">for</span>Â mariadbÂ (systemd:mariadb)</div><div class="line">MariaDBÂ databaseÂ server</div><div class="line">Operations<span class="string">'Â defaultsÂ (advisoryÂ minimum):</span></div><div class="line"><span class="string">startÂ Â Â Â Â Â Â Â Â timeout=15</span></div><div class="line"><span class="string">stopÂ Â Â Â Â Â Â Â Â Â timeout=15</span></div><div class="line"><span class="string">statusÂ Â Â Â Â Â Â Â timeout=15</span></div><div class="line"><span class="string">restartÂ Â Â Â Â Â Â timeout=15</span></div><div class="line"><span class="string">monitorÂ Â Â Â Â Â Â timeout=15Â interval=15Â start-delay=15</span></div></pre></td></tr></table></figure><h3 id="vipèµ„æº"><a href="#vipèµ„æº" class="headerlink" title="vipèµ„æº"></a>vipèµ„æº</h3><p><img src="/images/corosync_mariadb_test1.png" alt=""></p><pre><code>å½“node1 # crm node standby node1.rj.com æ—¶</code></pre><p><img src="/images/corosync_mariadb_test2.png" alt=""></p><h3 id="å®šä¹‰mariadbgèµ„æºå¹¶è®¾å®šç›‘æ§"><a href="#å®šä¹‰mariadbgèµ„æºå¹¶è®¾å®šç›‘æ§" class="headerlink" title="å®šä¹‰mariadbgèµ„æºå¹¶è®¾å®šç›‘æ§"></a>å®šä¹‰mariadbgèµ„æºå¹¶è®¾å®šç›‘æ§</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â crmÂ configureÂ primitiveÂ MDBÂ systemd:mariadbÂ opÂ startÂ timeout=15sÂ opÂ stopÂ timeout=15sÂ opÂ monitorÂ interval=15sÂ timeout=15sÂ </span></div><div class="line"><span class="comment">#Â crmÂ configureÂ groupÂ DBserviceÂ DBIPÂ MDB</span></div><div class="line"><span class="comment">#Â crmÂ configureÂ verifyÂ </span></div><div class="line"><span class="comment">#Â crmÂ configureÂ commitÂ </span></div><div class="line"><span class="comment">#Â crmÂ configureÂ showÂ Â </span></div><div class="line">nodeÂ 1:Â node1.rj.comÂ \</div><div class="line">attributesÂ standby=on</div><div class="line">nodeÂ 2:Â node2.rj.comÂ \</div><div class="line">attributesÂ standby=off</div><div class="line">nodeÂ 3:Â node3.rj.comÂ \</div><div class="line">attributesÂ standby=off</div><div class="line">primitiveÂ DBIPÂ IPaddrÂ \</div><div class="line">paramsÂ ip=172.16.23.23</div><div class="line">primitiveÂ MDBÂ systemd:mariadbÂ \</div><div class="line">opÂ startÂ timeout=15sÂ interval=0Â \</div><div class="line">opÂ stopÂ timeout=15sÂ interval=0Â \</div><div class="line">opÂ monitorÂ interval=15sÂ timeout=15s</div><div class="line">groupÂ DBserviceÂ DBIPÂ MDB</div><div class="line">propertyÂ cib-bootstrap-options:Â \</div><div class="line">have-watchdog=<span class="literal">false</span>Â \</div><div class="line">dc-version=1.1.13-10.el7-44eb2ddÂ \</div><div class="line">cluster-infrastructure=corosyncÂ \</div><div class="line">stonith-enabled=<span class="literal">false</span>Â \</div><div class="line">no-quorum-policy=ignore</div></pre></td></tr></table></figure><pre><code>ä¸ºmariadbæœåŠ¡åŠ å…¥æ•°æ®åº“èµ„æºï¼Œå¹¶é…ç½®è¿œç¨‹ç”¨æˆ·è¿œç¨‹æ¥å…¥è¿›è¡Œæµ‹è¯• </code></pre><p>æ³¨ï¼šæ­¤æ—¶æœ‰ä¸€ä¸ªèµ„æºå·²ç»å¯åŠ¨ï¼Œä½†å…¶å®ƒçš„ä¸¤ä¸ªmariadbæœåŠ¡å¯åŠ¨ä¹‹åæ‰èƒ½è¿›è¡Œå¯¹æ•°æ®åº“çš„æ›´æ”¹</p><pre><code>           ä½†æ›´æ”¹å®Œåæ—‹å¾—å†å°†é‚£ä¸¤ä¸ªç»“ç‚¹çš„æ•°æ®åº“åœæ­¢è°ƒnode1 node2 node3ä¸Šæ‰§è¡Œ: #  mysql -e &quot;GRANT ALL  ON *.* TO &apos;root&apos;@&apos;%.%.%.%&apos; IDENTIFIED BY &apos;centos.123&apos;;&quot; node1 # mysql -e &quot;CREATE DATABASE NODE1&quot;node2 # mysql -e &quot;CREATE DATABASE NODE2&quot;node3 # mysql -e &quot;CREATE DATABASE NODE3&quot;</code></pre><h3 id="å¯ç”¨ä¸€å°æµ‹è¯•æœºè¿›è¡Œæµ‹è¯•"><a href="#å¯ç”¨ä¸€å°æµ‹è¯•æœºè¿›è¡Œæµ‹è¯•" class="headerlink" title="å¯ç”¨ä¸€å°æµ‹è¯•æœºè¿›è¡Œæµ‹è¯•"></a>å¯ç”¨ä¸€å°æµ‹è¯•æœºè¿›è¡Œæµ‹è¯•</h3><p><img src="/images/corosync_mariadb_test3.png" alt=""></p><pre><code>node1    </code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â systemctlÂ stopÂ corosync.serviceÂ pacemaker.serviceÂ </span></div><div class="line"><span class="comment"># å½“node1çš„æœåŠ¡åœæ­¢æ—¶</span></div></pre></td></tr></table></figure><p><img src="/images/corosync_mariadb_test4.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â systemctlÂ stopÂ corosync.serviceÂ pacemaker.serviceÂ </span></div><div class="line"><span class="comment"># å½“node2çš„æœåŠ¡åœæ­¢æ—¶</span></div></pre></td></tr></table></figure><p><img src="/images/corosync_mariadb_test5.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CentOS 7 tomcat 7.0.54 çš„åŠŸèƒ½å®ç°åŠè¯¦è§£</title>
      <link href="/2018/02/07/CentOS-7-tomcat-7-0-54-%E7%9A%84%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%8F%8A%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/02/07/CentOS-7-tomcat-7-0-54-%E7%9A%84%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%8F%8A%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€-jdk-å®‰è£…é…ç½®"><a href="#ä¸€ã€-jdk-å®‰è£…é…ç½®" class="headerlink" title="ä¸€ã€ jdk å®‰è£…é…ç½®"></a>ä¸€ã€ jdk å®‰è£…é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â yumÂ installÂ java-1.8.0-openjdk-develÂ (ä¾èµ–çš„java-1.8.0-openjdk,java-1.8.0-openjdk,headlessä¹Ÿä¼šè¢«å®‰è£…Â )</span></div><div class="line"><span class="comment">#Â alternativesÂ -h</span></div><div class="line"><span class="comment">#Â vimÂ /etc/profile.d/java.sh</span></div><div class="line">Â Â Â <span class="comment"># åŠ å…¥Â exportÂ JAVA_HOME=/usr</span></div><div class="line"><span class="comment">#Â .Â /etc/profile.d/java.shÂ </span></div><div class="line"><span class="comment">#Â printenvÂ æŸ¥çœ‹ç¯å¢ƒå˜é‡</span></div><div class="line"><span class="comment">#ç”¨rpmåŒ…å®‰è£…Â </span></div><div class="line"></div><div class="line"><span class="comment">#Â wgetÂ ftp://172.16.0.1/pub/Sources/7.x86_64/jdk/jdk-8u25-linux-x64.rpm</span></div><div class="line"><span class="comment">#Â rpmÂ -ivhÂ jdk-8u25-linux-x64.rpm</span></div><div class="line"><span class="comment">#Â rpmÂ -qlÂ jdk1.8.0_25-1.8.0_25-fcs</span></div><div class="line"><span class="comment">#Â cdÂ /usr/java/default</span></div><div class="line"><span class="comment">#Â vimÂ /etc/profile.d/javad.sh</span></div><div class="line">JAVA_HOME=/usr/java/latest</div><div class="line">PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">export</span>Â JAVA_HOMEÂ PATH</div><div class="line"><span class="comment">#Â .Â /etc/profile.d/javad.shÂ </span></div><div class="line"><span class="comment">#Â javaÂ -version</span></div></pre></td></tr></table></figure><p>tomcat:è¿è¡ŒäºJDKä¹‹ä¸Šï¼Œè¡¨ç°ä¸ºä¸€ä¸ªç‹¬ç«‹è€Œå®Œæ•´çš„javaè¿›ç¨‹ï¼Œå¯ä¸ç”¨æˆ·äº¤äº’çš„webæœåŠ¡å™¨<br>ä½¿ç”¨Javaè¯­è¨€ç¼–å†™<br>Tomcatçš„æ ¸å¿ƒç»„ä»¶:server.xmlï¼Œå…¶é…ç½®çš„æ ¼å¼ä¸º </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Server</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Serivce</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">connector</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">connecotr</span>/&gt;</span></div><div class="line">...</div><div class="line"><span class="tag">&lt;<span class="name">Engine</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Host</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Context</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Context</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Host</span>&gt;</span></div><div class="line">...</div><div class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></div><div class="line">...</div><div class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></div></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><ul><li>é¡¶çº§ç»„ä»¶:Server</li><li>æœåŠ¡ç±»ç»„ä»¶:Service </li><li>ç±» è¿æ¥ç±»ç»„ä»¶:http,https,ajp t</li><li>å®¹å™¨ç±»:Engine,Host,Context </li><li>è¢«åµŒå¥—ç±»:value,logger,realm,loader,manager </li><li>é›†ç¾¤ç±»ç»„ä»¶:listener,cluster,â€¦ </li><li>cluster,â€¦ </li></ul><h2 id="äºŒã€Tomcatå®‰è£…é…ç½®"><a href="#äºŒã€Tomcatå®‰è£…é…ç½®" class="headerlink" title="äºŒã€Tomcatå®‰è£…é…ç½®"></a>äºŒã€Tomcatå®‰è£…é…ç½®</h2><h3 id="1ã€å®‰è£…tomcat"><a href="#1ã€å®‰è£…tomcat" class="headerlink" title="1ã€å®‰è£…tomcat:"></a>1ã€å®‰è£…tomcat:</h3><h4 id="aã€äºŒè¿›åˆ¶æ ¼å¼å®‰è£…"><a href="#aã€äºŒè¿›åˆ¶æ ¼å¼å®‰è£…" class="headerlink" title="aã€äºŒè¿›åˆ¶æ ¼å¼å®‰è£…"></a>aã€äºŒè¿›åˆ¶æ ¼å¼å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â tarÂ xvfÂ apache-tomcat-VERSION.tar.gzÂ -CÂ /usr/local/Â </span></div><div class="line"><span class="comment">#Â cdÂ /usr/local/Â </span></div><div class="line"><span class="comment">#Â lnÂ -svÂ apache-tomcat-VERSIONÂ tomcatÂ </span></div><div class="line"><span class="comment">#vimÂ /etc/profile.d/tomcat.shÂ </span></div><div class="line"><span class="built_in">export</span>Â CATALINA_BASE=/usr/<span class="built_in">local</span>/tomcatÂ </div><div class="line"><span class="built_in">export</span>Â PATH=<span class="variable">$CATALINA_BASE</span>/bin:<span class="variable">$PATH</span></div><div class="line"><span class="comment">#Â .Â /etc/profile.d/tomcat.sh</span></div></pre></td></tr></table></figure><h4 id="bã€yumæºå®‰è£…"><a href="#bã€yumæºå®‰è£…" class="headerlink" title="bã€yumæºå®‰è£…"></a>bã€yumæºå®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â yumÂ -yÂ installÂ tomcat-webappsÂ tomcat-docs-webappÂ tomcat-admin-webappsÂ tomcatÂ tomcat-lib</span></div><div class="line"><span class="comment"># å®‰è£…å®Œåå¯ä»¥ä½¿ç”¨å‘½ä»¤</span></div><div class="line"><span class="comment">#Â systemctlÂ startÂ tomcatÂ &amp;&amp;Â ssÂ -tnl</span></div></pre></td></tr></table></figure><p>å¯åŠ¨tomcatæœåŠ¡å¹¶ä¸”æŸ¥çœ‹8080ç«¯å£æ˜¯å¦å¯ç”¨<br><code>åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œæµ‹è¯• http://172.16.254.248:8080/</code></p><p><img src="/images/tomcat_master.png" alt=""></p><h3 id="2ã€tomcatç¨‹åºç›®å½•ç»“æ„"><a href="#2ã€tomcatç¨‹åºç›®å½•ç»“æ„" class="headerlink" title="2ã€tomcatç¨‹åºç›®å½•ç»“æ„"></a>2ã€tomcatç¨‹åºç›®å½•ç»“æ„</h3><ul><li>bin:è„šæœ¬åŠå¯åŠ¨æ—¶ç”¨åˆ°çš„ç±» </li><li>conf:é…ç½®æ–‡ä»¶ç›®å½• </li><li>lib:åº“æ–‡ä»¶ï¼Œjavaç±»åº“</li><li>logs:æ—¥å¿—æ–‡ä»¶ç›®å½•</li><li>temp:ä¸´æ—¶æ–‡ä»¶ç›®å½• </li><li>webapps:webappçš„é»˜è®¤ç›®å½• </li><li>work:å·¥ä½œç›®å½• </li></ul><h3 id="3ã€tomcatçš„é…ç½®æ–‡ä»¶è¯´æ˜"><a href="#3ã€tomcatçš„é…ç½®æ–‡ä»¶è¯´æ˜" class="headerlink" title="3ã€tomcatçš„é…ç½®æ–‡ä»¶è¯´æ˜"></a>3ã€tomcatçš„é…ç½®æ–‡ä»¶è¯´æ˜</h3><ul><li>server.xmlï¼šä¸»é…ç½®æ–‡ä»¶;</li><li>web.xmlï¼šæ¯ä¸ªwebappåªæœ‰éƒ¨ç½²åæ‰èƒ½è¢«è®¿é—®ï¼Œå®ƒçš„éƒ¨ç½²æ–¹å¼é€šè¿‡ç”±web.xmlè¿›è¡Œå®šä¹‰ï¼Œå…¶å­˜ä½ç½®ä¸ºWEB-INF/ç›®å½•ä¸­ï¼Œæ­¤æ–‡ä»¶ä¸ºæ‰€æœ‰çš„webappsæä¾›é»˜è®¤é…ç½®;</li><li>context.xml:æ¯ä¸ªwebéƒ½å¯ä¸“ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒé€šå¸¸ç”±ä¸“ç”¨çš„é…ç½®æ–‡ä»¶context.xmlæ¥å®šä¹‰ï¼Œå…¶å­˜æ”¾ä½ç½®ä¸ºWEB-INF/ç›®å½•ä¸­ï¼Œæ­¤æ–‡ä»¶ä¸ºæ‰€æœ‰çš„webappsæä¾›é»˜è®¤é…ç½®;</li><li>tomcat-users.xml:ç”¨æˆ·çš„è´¦å·å’Œæ–‡ä»¶;</li><li>catalina.policy:å½“ä½¿ç”¨securityé€‰é¡¹å¯åŠ¨tomcatæ—¶ï¼Œç”¨äºä¸ºtomcatè®¾ç½®å®‰å…¨ç­–ç•¥ï¼› </li><li>catalina.propreteis:javaç‰©å®šä¹‰æ–‡ä»¶ï¼Œç”¨äºè®¾å®šç±»åŠ è½½å™¨è·¯å¾„ï¼Œä»¥åŠä¸€äº›ä¸JVMé«˜ä¼°ç›¸å…³å‚æ•°ï¼› </li><li>logging.properties:æ—¥å¿—ç³»ç»Ÿç›¸å…³çš„é…ç½® ;</li></ul><h3 id="4ã€tomcat-users-xmlé…ç½®"><a href="#4ã€tomcat-users-xmlé…ç½®" class="headerlink" title="4ã€tomcat-users.xmlé…ç½®"></a>4ã€tomcat-users.xmlé…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vimÂ /etc/tomcat/tomcat-users.xml</span></div></pre></td></tr></table></figure><p>åœ¨<tomcat-users>æ®µä¸­åŠ å…¥ä»¥äº”å†…å®¹ </tomcat-users></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">role</span>Â <span class="attr">rolename</span>=<span class="string">"manager-gui"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">user</span>Â <span class="attr">username</span>=<span class="string">"centos"</span>Â <span class="attr">password</span>=<span class="string">"centos"</span>Â <span class="attr">roles</span>=<span class="string">"manager-gui"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">role</span>Â <span class="attr">rolename</span>=<span class="string">"admin-gui"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">user</span>Â <span class="attr">username</span>=<span class="string">"centos"</span>Â <span class="attr">password</span>=<span class="string">"centos"</span>Â <span class="attr">roles</span>=<span class="string">"admin-gui"</span>/&gt;</span></div></pre></td></tr></table></figure><p><code>é‡å¯æœåŠ¡åå¹¶é‡æ–°è®¿é—®http://172.16.254.248:8080/</code></p><p><img src="/images/tomcat_server1.png" alt=""></p><p><img src="/images/tomcat_server2.png" alt=""><br>ç‚¹Server Statusã€Manager Appã€ Host Manageræ—¶è¾“å…¥ç”¨æˆ·åcentoså¯†ç centosè¿›è¡Œè®¿é—®</p><h3 id="5ã€æä¾›ä¸€æµ‹è¯•ç±»åº”ç”¨ï¼Œå¹¶å†·éƒ¨ç½²ï¼›"><a href="#5ã€æä¾›ä¸€æµ‹è¯•ç±»åº”ç”¨ï¼Œå¹¶å†·éƒ¨ç½²ï¼›" class="headerlink" title="5ã€æä¾›ä¸€æµ‹è¯•ç±»åº”ç”¨ï¼Œå¹¶å†·éƒ¨ç½²ï¼›"></a>5ã€æä¾›ä¸€æµ‹è¯•ç±»åº”ç”¨ï¼Œå¹¶å†·éƒ¨ç½²ï¼›</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#mkdirÂ -pvÂ /usr/share/tomcat/webapps/test/&#123;classes,lib,WEB-INF&#125;</span></div></pre></td></tr></table></figure><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#Â vimÂ /usr/share/tomcat/webapps/test/index.jspÂ </div><div class="line">Â &lt;%@Â pageÂ language=<span class="string">"java"</span>Â %&gt;</div><div class="line">Â &lt;%@Â pageÂ <span class="keyword">import</span>=<span class="string">"java.util.*"</span>Â %&gt;</div><div class="line">Â &lt;html&gt;</div><div class="line">Â &lt;head&gt;</div><div class="line">&lt;title&gt;Â TestÂ PageÂ &lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;%Â out.println(<span class="string">"hellowÂ world"</span>);</div><div class="line">%&gt;</div><div class="line">Â Â &lt;/body&gt;</div><div class="line">Â Â Â &lt;/html&gt;</div><div class="line">é‡æ–°è®¿é—®http:<span class="comment">//172.16.254.248:8080/test/æ—¶ä¼šæ˜¾ç¤ºhellow world</span></div></pre></td></tr></table></figure><h3 id="6ã€nginx-tomcat-cluster"><a href="#6ã€nginx-tomcat-cluster" class="headerlink" title="6ã€nginx + tomcat cluster"></a>6ã€nginx + tomcat cluster</h3><p>ç”¨nginx åä»£ä¸¤å°tomcatä¸»æœº ï¼Œcluster(172.16.254.248[nginx]) ,node1(172.16.251.232[Tomcat A]),node2(172.16.251.74[Tomcat B])</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">cluster<span class="comment">#Â yumÂ -yÂ installÂ nginxÂ &amp;&amp;Â systemctlÂ startÂ nginxÂ </span></div><div class="line"><span class="comment">#Â vimÂ /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment"># åœ¨httpæ®µä¸­åŠ å…¥</span></div><div class="line">upstreamÂ tomcatÂ &#123;</div><div class="line">serverÂ 172.16.251.232:8080;</div><div class="line">serverÂ 172.16.251.74:8080;</div><div class="line">&#125;</div><div class="line"><span class="comment">#Â vimÂ /etc/nginx/conf.d/default.conf</span></div><div class="line"><span class="comment"># åœ¨locationä¸­åŠ å…¥Â </span></div><div class="line">proxy_passÂ http://tomcat/;</div><div class="line">nod1Â Â Â Â <span class="comment">#Â mkdirÂ -pvÂ /usr/share/tomcat/webapps/test/&#123;WEB-INF,classes,lib&#125;</span></div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#Â vimÂ /usr/share/tomcat/pwebapps/test/index.jspÂ </div><div class="line">&lt;%@Â pageÂ language=<span class="string">"java"</span>Â %&gt;</div><div class="line">&lt;html&gt;</div><div class="line">Â Â &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</div><div class="line">Â Â &lt;body&gt;</div><div class="line">&lt;h1&gt;&lt;fontÂ color="red"&gt;TomcatA.rj.com&lt;/font&gt;&lt;/h1&gt;</div><div class="line">&lt;tableÂ align=<span class="string">"centre"</span>Â border=<span class="string">"1"</span>&gt;</div><div class="line">Â Â &lt;tr&gt;</div><div class="line">&lt;td&gt;SessionÂ ID&lt;/td&gt;</div><div class="line">&lt;%Â session.setAttribute(<span class="string">"magedu.com"</span>,<span class="string">"magedu.com"</span>);Â %&gt;</div><div class="line">&lt;td&gt;&lt;%=Â session.getId()Â %&gt;&lt;/td&gt;</div><div class="line">Â Â &lt;/tr&gt;</div><div class="line">Â Â &lt;tr&gt;</div><div class="line">&lt;td&gt;CreatedÂ on&lt;/td&gt;</div><div class="line">&lt;td&gt;&lt;%=Â session.getCreationTime()Â %&gt;&lt;/td&gt;</div><div class="line">Â &lt;/tr&gt;</div><div class="line">&lt;/table&gt;</div><div class="line">Â Â &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line">nod2Â Â Â Â #Â mkdirÂ -pvÂ /usr/share/tomcat/webapps/test/&#123;WEB-INF,classes,lib&#125;</div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#Â vimÂ /usr/share/tomcat/pwebapps/test/index.jspÂ </div><div class="line">&lt;%@Â pageÂ language=<span class="string">"java"</span>Â %&gt;</div><div class="line">&lt;html&gt;</div><div class="line">Â Â &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</div><div class="line">Â Â &lt;body&gt;</div><div class="line">&lt;h1&gt;&lt;fontÂ color="red"&gt;TomcatB.rj.com&lt;/font&gt;&lt;/h1&gt;</div><div class="line">&lt;tableÂ align=<span class="string">"centre"</span>Â border=<span class="string">"1"</span>&gt;</div><div class="line">Â Â &lt;tr&gt;</div><div class="line">&lt;td&gt;SessionÂ ID&lt;/td&gt;</div><div class="line">&lt;%Â session.setAttribute(<span class="string">"magedu.com"</span>,<span class="string">"magedu.com"</span>);Â %&gt;</div><div class="line">&lt;td&gt;&lt;%=Â session.getId()Â %&gt;&lt;/td&gt;</div><div class="line">Â Â &lt;/tr&gt;</div><div class="line">Â Â &lt;tr&gt;</div><div class="line">&lt;td&gt;CreatedÂ on&lt;/td&gt;</div><div class="line">&lt;td&gt;&lt;%=Â session.getCreationTime()Â %&gt;&lt;/td&gt;</div><div class="line">Â &lt;/tr&gt;</div><div class="line">&lt;/table&gt;</div><div class="line">Â Â &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure><p><code>è®¿é—®http://172.16.254.248/test/æ—¶æ•ˆæœå¦‚æœä¸‹</code></p><p><img src="/images/tomcat_test1.png" alt=""></p><p><img src="/images/tomcat_test2.png" alt=""></p><h3 id="7ã€-httpd-proxy-http-module-tomcat-cluster"><a href="#7ã€-httpd-proxy-http-module-tomcat-cluster" class="headerlink" title="7ã€ httpd(proxy_http_module) + tomcat cluster"></a>7ã€ httpd(proxy_http_module) + tomcat cluster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cluster<span class="comment">#systemctlÂ disableÂ nginxÂ &amp;&amp;Â systemctlÂ stopÂ nginx</span></div><div class="line">Â Â Â <span class="comment">#Â yumÂ -yÂ installÂ httpd</span></div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#Â vimÂ /etc/httpd/conf.d/tomcat.confÂ </div><div class="line">&lt;proxyÂ balancer:<span class="comment">//tomcat&gt;</span></div><div class="line">BalancerMemberÂ http:<span class="comment">//172.16.251.232:8080</span></div><div class="line">BalancerMemberÂ http:<span class="comment">//172.16.251.74:8080</span></div><div class="line">ProxySetÂ Â lbmethod=byrequests</div><div class="line">&lt;/proxy&gt;</div><div class="line">&lt;VirtualHostÂ *:<span class="number">80</span>&gt;</div><div class="line">ServerNameÂ www.rj.com</div><div class="line">ProxyViaÂ On</div><div class="line">ProxyRequestsÂ Off</div><div class="line">ProxyPreserveHostÂ On</div><div class="line">&lt;ProxyÂ *&gt;</div><div class="line">RequireÂ allÂ granted</div><div class="line">&lt;/Proxy&gt;</div><div class="line">ProxyPassÂ /Â balancer:<span class="comment">//tomcat/</span></div><div class="line">ProxyPassReverseÂ /Â balancer:<span class="comment">//tomcat/</span></div><div class="line">&lt;LocationÂ /&gt;</div><div class="line">RequireÂ allÂ granted</div><div class="line">&lt;/Location&gt;</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure><p><code>è®¿é—®http://172.16.254.248/test/æ—¶æ•ˆæœå¦‚ä¸‹</code></p><p><img src="/images/tomcat_test3.png" alt=""></p><p><img src="/images/tomcat_test4.png" alt=""><br>å¯ç”¨balancerç®¡ç†æ¥å£</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cluster#Â vimÂ /etc/httpd/conf.d/balancer-manager.confÂ </div><div class="line">&lt;LocationÂ /balancer-manager&gt;</div><div class="line">SethandlerÂ balancer-managerÂ </div><div class="line">ProxyPassÂ !</div><div class="line">RequireÂ allÂ grantedÂ </div><div class="line">&lt;/Location&gt;</div></pre></td></tr></table></figure><pre><code>`è®¿é—®å…¶ç®¡ç†æ¥å£http://172.16.254.248/balancer-manageræ•ˆæœå¦‚ä¸‹`</code></pre><p><img src="/images/tomcat_manager1.png" alt=""></p><h3 id="8ã€-httpd-proxy-ajp-module-tomcat-cluster"><a href="#8ã€-httpd-proxy-ajp-module-tomcat-cluster" class="headerlink" title="8ã€ httpd(proxy_ajp_module)+tomcat cluster"></a>8ã€ httpd(proxy_ajp_module)+tomcat cluster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â cpÂ /etc/httpd/conf.d/tomcat.confÂ /etc/httpd/conf.d/tomcat.conf.bak</span></div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#Â vimÂ /etc/httpd/conf.d/tomcat.confÂ </div><div class="line">&lt;proxyÂ balancer:<span class="comment">//tomcat&gt;</span></div><div class="line">BalancerMemberÂ ajp:<span class="comment">//172.16.251.232:8009</span></div><div class="line">BalancerMemberÂ ajp:<span class="comment">//172.16.251.74:8009</span></div><div class="line">ProxySetÂ Â lbmethod=byrequests</div><div class="line">&lt;/proxy&gt;</div><div class="line">&lt;VirtualHostÂ *:<span class="number">80</span>&gt;</div><div class="line">ServerNameÂ www.rj.com</div><div class="line">ProxyViaÂ OnÂ </div><div class="line">ProxyRequestsÂ OffÂ </div><div class="line">ProxyPreserveHostÂ OnÂ </div><div class="line">&lt;ProxyÂ *&gt;</div><div class="line">RequireÂ allÂ grantedÂ </div><div class="line">&lt;/Proxy&gt;</div><div class="line">ProxyPassÂ /Â balancer:<span class="comment">//tomcat/</span></div><div class="line">ProxyPassReverseÂ /Â balancer:<span class="comment">//tomcat/</span></div><div class="line">&lt;LocationÂ /&gt;</div><div class="line">RequireÂ allÂ grantedÂ </div><div class="line">&lt;/Location&gt;</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure><p>è®¿é—®<a href="http://172.16.254.248/test/æ—¶æ•ˆæœå¦‚ä¸‹" target="_blank" rel="external">http://172.16.254.248/test/æ—¶æ•ˆæœå¦‚ä¸‹</a></p><p><img src="/images/tomcat_test5.png" alt=""></p><p><img src="/images/tomcat_test6.png" alt=""></p><h2 id="ä¸‰ã€å¸¸ç”¨ç»„ä»¶é…ç½®"><a href="#ä¸‰ã€å¸¸ç”¨ç»„ä»¶é…ç½®" class="headerlink" title="ä¸‰ã€å¸¸ç”¨ç»„ä»¶é…ç½®"></a>ä¸‰ã€å¸¸ç”¨ç»„ä»¶é…ç½®</h2><p>Server:ä»£è¡¨tomcat instance, å³è¡¨ç°å‡ºä¸€ä¸ªJavaè¿›ç¨‹ï¼šç›‘å¬åœ¨8005ç«¯å£ï¼Œåªæ¥æ”¶â€œSHUTDOWNâ€ï¼›<br>å„serverç›‘å¬çš„ç«¯å£ä¸èƒ½ç›¸åŒï¼Œå› æ­¤ï¼Œåœ¨åŒä¸€ç‰©ç†ä¸»æœºå¯åŠ¨å¤šä¸ªå®ä¾‹æ—¶ï¼Œéœ€è¦ä¸ªæ”¹å…¶ç›‘å¬ç«¯å£ä¸ºä¸åŒçš„ç«¯å£ï¼› </p><p>serviceï¼šç”¨äºå®ç°å°†ä¸€ä¸ªæˆ–å¤šä¸ªconnectorç»„ä»¶å…³è”è‡³ä¸€ä¸ªengineç»„ä»¶ï¼›<br>Connectorç»„ä»¶<br>è´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œå¸¸è§çš„æœ‰ä¸‰ç±»http/https/ajp:<br>è¿›å…¥tomcatçš„è¯·æ±‚å¯åˆ†ä¸ºä¸¤ç±»ï¼› </p><h3 id="1-standalone-è¯·æ±‚æ¥è‡ªäºå®¢æˆ·ç«¯çš„åä»£ç†æœåŠ¡å™¨ï¼š"><a href="#1-standalone-è¯·æ±‚æ¥è‡ªäºå®¢æˆ·ç«¯çš„åä»£ç†æœåŠ¡å™¨ï¼š" class="headerlink" title="(1)standalone:è¯·æ±‚æ¥è‡ªäºå®¢æˆ·ç«¯çš„åä»£ç†æœåŠ¡å™¨ï¼š"></a>(1)standalone:è¯·æ±‚æ¥è‡ªäºå®¢æˆ·ç«¯çš„åä»£ç†æœåŠ¡å™¨ï¼š</h3><ul><li>nginx â€“&gt; http connector â€“&gt; tomcat </li><li>httpd(proxy_http_module) â€“&gt; http connector â€“&gt; tomcat </li><li>httpd(proxy_ajp_module) â€“&gt; ajp connecetor â€“&gt; tomcat </li></ul><p>å±æ€§ï¼š</p><ul><li>port=â€8080â€</li><li>protocol=â€HTTP/1.1â€</li><li>connectionTimeout=â€20000â€</li><li>addressï¼šç›‘å¬çš„IPåœ°å€ï¼›é»˜è®¤ä¸ºæœ¬æœºæ‰€æœ‰å¯ç”¨åœ°å€ï¼›</li><li>maxThreadsï¼šæœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º150ï¼›</li><li>enableLookupsï¼šæ˜¯å¦å¯ç”¨DNSæŸ¥è¯¢åŠŸèƒ½ï¼›</li><li>acceptCountï¼šç­‰å¾…é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼›</li><li>secureï¼š</li><li>sslProtocolï¼š</li></ul><p>Engineç»„ä»¶ï¼šServletå®ä¾‹ï¼Œå³servletå¼•æ“ï¼Œå…¶å†…éƒ¨å¯ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªhostç»„ä»¶æ¥å®šä¹‰ç«™ç‚¹ï¼› é€šå¸¸éœ€è¦é€šè¿‡defaultHostæ¥å®šä¹‰é»˜è®¤çš„è™šæ‹Ÿä¸»æœºï¼›</p><p>å±æ€§ï¼š</p><ul><li>name=</li><li>defaultHost=â€localhostâ€</li><li>jvmRoute=</li></ul><p>Hostç»„ä»¶ï¼šä½äºengineå†…éƒ¨ç”¨äºæ¥æ”¶è¯·æ±‚å¹¶è¿›è¡Œç›¸åº”å¤„ç†çš„ä¸»æœºæˆ–è™šæ‹Ÿä¸»æœºï¼Œç¤ºä¾‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;Host name=<span class="string">"localhost"</span> Â appBase=<span class="string">"webapps"</span></div><div class="line">unpackWARs=<span class="string">"true"</span> autoDeploy=<span class="string">"true"</span>&gt;</div><div class="line">&lt;/Host&gt;</div></pre></td></tr></table></figure><h3 id="å¸¸ç”¨å±æ€§è¯´æ˜ï¼š"><a href="#å¸¸ç”¨å±æ€§è¯´æ˜ï¼š" class="headerlink" title="å¸¸ç”¨å±æ€§è¯´æ˜ï¼š"></a>å¸¸ç”¨å±æ€§è¯´æ˜ï¼š</h3><p>(1) appBaseï¼šæ­¤Hostçš„webappsçš„é»˜è®¤å­˜æ”¾ç›®å½•ï¼ŒæŒ‡å­˜æ”¾éå½’æ¡£çš„webåº”ç”¨ç¨‹åºçš„ç›®å½•æˆ–å½’æ¡£çš„WARæ–‡ä»¶ç›®å½•è·¯å¾„ï¼›å¯ä»¥ä½¿ç”¨åŸºäº$CATALINA_BASEå˜é‡æ‰€å®šä¹‰çš„è·¯å¾„çš„ç›¸å¯¹è·¯å¾„ï¼›</p><p>(2) autoDeployï¼šåœ¨Tomcatå¤„äºè¿è¡ŒçŠ¶æ€æ—¶ï¼Œå°†æŸwebappæ”¾ç½®äºappBaseæ‰€å®šä¹‰çš„ç›®å½•ä¸­æ—¶ï¼Œæ˜¯å¦è‡ªåŠ¨å°†å…¶éƒ¨ç½²è‡³tomcatï¼›</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;Host name=<span class="string">"tc1.magedu.com"</span> appBase=<span class="string">"/appdata/webapps"</span> unpackWARs=<span class="string">"true"</span> autoDeploy=<span class="string">"true"</span>&gt;</div><div class="line">&lt;/Host&gt;</div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># mkdir -pv /appdata/webapps</div><div class="line"># mkdir -pv /appdata/webapps/ROOT/&#123;lib,classes,WEB-INF&#125;</div></pre></td></tr></table></figure><p>æä¾›ä¸€ä¸ªæµ‹è¯•é¡µå³å¯ï¼›</p><h2 id="å››ã€tomcat-cluster-å‡çº§ä¸ºsession-clusterï¼Œä½¿ç”¨deltaManager"><a href="#å››ã€tomcat-cluster-å‡çº§ä¸ºsession-clusterï¼Œä½¿ç”¨deltaManager" class="headerlink" title="å››ã€tomcat cluster å‡çº§ä¸ºsession clusterï¼Œä½¿ç”¨deltaManager"></a>å››ã€tomcat cluster å‡çº§ä¸ºsession clusterï¼Œä½¿ç”¨deltaManager</h2><p>é…ç½®node1,å’Œnode2 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node1<span class="comment"># vim /etc/tomcat/server.xml</span></div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">Â &lt;EngineÂ name=<span class="string">"Catalina"</span>Â defaultHost=<span class="string">"localhost"</span>Â jvmRoute=<span class="string">"TomcatA"</span>&gt;</div><div class="line">&lt;ClusterÂ className=<span class="string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span></div><div class="line">channelSendOptions=<span class="string">"8"</span>&gt;</div><div class="line">&lt;ManagerÂ className=<span class="string">"org.apache.catalina.ha.session.DeltaManager"</span></div><div class="line">expireSessionsOnShutdown=<span class="string">"false"</span></div><div class="line">notifyListenersOnReplication=<span class="string">"true"</span>/&gt;</div><div class="line">&lt;ChannelÂ className=<span class="string">"org.apache.catalina.tribes.group.GroupChannel"</span>&gt;</div><div class="line">&lt;MembershipÂ className=<span class="string">"org.apache.catalina.tribes.membership.McastService"</span></div><div class="line">address=<span class="string">"228.0.32.4"</span></div><div class="line">port=<span class="string">"45564"</span></div><div class="line">frequency=<span class="string">"500"</span></div><div class="line">dropTime=<span class="string">"3000"</span>/&gt;</div><div class="line">&lt;ReceiverÂ className=<span class="string">"org.apache.catalina.tribes.transport.nio.NioReceiver"</span></div><div class="line">address=<span class="string">"192.168.254.130"</span></div><div class="line">port=<span class="string">"4000"</span></div><div class="line">autoBind=<span class="string">"100"</span></div><div class="line">selectorTimeout=<span class="string">"5000"</span></div><div class="line">maxThreads=<span class="string">"6"</span>/&gt;</div><div class="line">&lt;SenderÂ className=<span class="string">"org.apache.catalina.tribes.transport.ReplicationTransmitter"</span>&gt;</div><div class="line">&lt;TransportÂ className=<span class="string">"org.apache.catalina.tribes.transport.nio.PooledParallelSender"</span>/&gt;</div><div class="line">&lt;/Sender&gt;</div><div class="line">&lt;InterceptorÂ className=<span class="string">"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"</span>/&gt;</div><div class="line">&lt;InterceptorÂ className=<span class="string">"org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"</span>/&gt;</div><div class="line">&lt;/Channel&gt;</div><div class="line">&lt;ValveÂ className=<span class="string">"org.apache.catalina.ha.tcp.ReplicationValve"</span></div><div class="line">filter=<span class="string">""</span>/&gt;</div><div class="line">&lt;ValveÂ className=<span class="string">"org.apache.catalina.ha.session.JvmRouteBinderValve"</span>/&gt;</div><div class="line">&lt;DeployerÂ className=<span class="string">"org.apache.catalina.ha.deploy.FarmWarDeployer"</span></div><div class="line">tempDir=<span class="string">"/tmp/war-temp/"</span></div><div class="line">deployDir=<span class="string">"/tmp/war-deploy/"</span></div><div class="line">watchDir=<span class="string">"/tmp/war-listen/"</span></div><div class="line">watchEnabled=<span class="string">"false"</span>/&gt;</div><div class="line">&lt;ClusterListenerÂ className=<span class="string">"org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener"</span>/&gt;</div><div class="line">&lt;ClusterListenerÂ className=<span class="string">"org.apache.catalina.ha.session.ClusterSessionListener"</span>/&gt;</div><div class="line">&lt;/Cluster&gt;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#Â scpÂ /etc/tomcat/server.xmlÂ 172.16.251.74:/etc/tomcat/server.xml</span></div><div class="line"><span class="comment">#Â cpÂ /etc/tomcat/web.xmlÂ /var/lib/tomcat/webapps/test/WEB-INF/</span></div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#Â vimÂ /var/lib/tomcat/webapps/test/WEB-INF/web.xml</div><div class="line">åœ¨Â &lt;!--Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â listingsÂ isÂ enabled?Â [<span class="keyword">true</span>]Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â --&gt;çš„åé¢åŠ å…¥</div><div class="line">&lt;distributable/&gt;</div><div class="line">#Â scpÂ /var/lib/tomcat/webapps/test/WEB-INF/web.xmlÂ 172.16.251.74:/var/lib/tomcat/webapps/test/WEB-INF/</div><div class="line">Â Â Â node2#Â vimÂ /etc/tomcat/server.xmlÂ </div><div class="line">æ›´æ”¹Â Â &lt;EngineÂ name=<span class="string">"Catalina"</span>Â defaultHost=<span class="string">"localhost"</span>Â jvmRoute=<span class="string">"TomcatB"</span>&gt;</div><div class="line">address=<span class="string">"172.16.251.74"</span></div><div class="line">node1,2Â #systemctlÂ restartÂ tomcat</div></pre></td></tr></table></figure><p><code>è¿›å…¥é¡µæµ‹è¯•http://172.16.254.248/test/</code></p><p><img src="/images/tomcat_test7.png" alt=""></p><p><img src="/images/tomcat_test8.png" alt=""></p><h2 id="äº”ã€clusterå°†ä¼šè¯ä¿å­˜è‡³memcachedä¸­"><a href="#äº”ã€clusterå°†ä¼šè¯ä¿å­˜è‡³memcachedä¸­" class="headerlink" title="äº”ã€clusterå°†ä¼šè¯ä¿å­˜è‡³memcachedä¸­"></a>äº”ã€clusterå°†ä¼šè¯ä¿å­˜è‡³memcachedä¸­</h2><p>node1,2éœ€è¦çš„æ“ä½œ<br>å°†deltaManagerçš„é…ç½®è¿˜åŸ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Â Â <span class="comment">#Â cdÂ /usr/share/tomcat/lib/</span></div><div class="line">Â Â Â <span class="comment">#Â wgetÂ ftp://172.16.0.1/pub/Sources/7.x86_64/msm/*Â &amp;&amp;Â rmÂ -rfÂ memcached-session-manager-tc8-1.8.3.jar</span></div><div class="line">Â Â Â <span class="comment">#Â yumÂ -yÂ installÂ memcachedÂ libmemcachedÂ </span></div><div class="line">Â Â Â <span class="comment">#Â systemctlÂ startÂ memcachedÂ </span></div><div class="line">Â Â Â <span class="comment">#Â sustemctlÂ enableÂ memcached</span></div><div class="line">node1(tomcat1,memcached1)</div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Â # memcached 1é…ç½®Â </div><div class="line"># vimÂ /etc/tomcat/server.xml</div><div class="line"># ä¿®æ”¹Â </div><div class="line">&lt;EngineÂ name=<span class="string">"Catalina"</span>Â defaultHost=<span class="string">"localhost"</span>Â jvmRoute=<span class="string">"rjTomcat1"</span>&gt;</div><div class="line">åœ¨Hostæ®µä¸­æ·»åŠ </div><div class="line">Â Â Â Â Â Â Â Â &lt;ContextÂ path=<span class="string">"/test"</span>Â docBase=<span class="string">"test"</span>Â reloadable=<span class="string">"true"</span>&gt;</div><div class="line">&lt;ManagerÂ className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></div><div class="line">memcachedNodes=<span class="string">"n1:172.16.251.232:11211,n2:172.16.251.74:11211"</span></div><div class="line">failoverNodes=<span class="string">"n1"</span></div><div class="line">requestUriIgnorePattern=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></div><div class="line">transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory"</span></div><div class="line">/&gt;</div><div class="line">&lt;/Context&gt;</div><div class="line">node2(tomcat,memcached2)</div><div class="line">Â # memcached 2é…ç½®Â </div><div class="line">&lt;EngineÂ name=<span class="string">"Catalina"</span>Â defaultHost=<span class="string">"localhost"</span>Â jvmRoute=<span class="string">"rjTomcat2"</span>&gt;</div><div class="line"># åœ¨Hostæ®µä¸­æ·»åŠ </div><div class="line">Â &lt;ContextÂ path=<span class="string">"/test"</span>Â docBase=<span class="string">"test"</span>Â reloadable=<span class="string">"true"</span>&gt;</div><div class="line">&lt;ManagerÂ className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></div><div class="line">memcachedNodes=<span class="string">"n1:172.16.251.232:11211,n2:172.16.251.74:11211"</span></div><div class="line">failoverNodes=<span class="string">"n1"</span></div><div class="line">requestUriIgnorePattern=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span></div><div class="line">transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory"</span></div><div class="line">/&gt;</div><div class="line">&lt;/Context&gt;</div></pre></td></tr></table></figure><p>å…³äºtomcat memcached sessionç»‘å®šé…ç½®è¯¦è§£åœ°å€</p><p><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#configure-memcached-session-manager-as--context-manager" target="_blank" rel="external">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#configure-memcached-session-manager-as--context-manager</a><br>æ­¤æ—¶clusterå°†ä¼šè¯ä¿å­˜äºmemcached ä¸­ </p><p><code>è®¿é—®http://172.16.254.248/test/æ•ˆæœå¦‚ä¸‹</code></p><p><img src="/images/tomcat_test9.png" alt=""><br><img src="/images/tomcat_test10.png" alt=""></p><h2 id="å…­ã€Tomcatçš„å¸¸ç”¨ä¼˜åŒ–é…ç½®"><a href="#å…­ã€Tomcatçš„å¸¸ç”¨ä¼˜åŒ–é…ç½®" class="headerlink" title="å…­ã€Tomcatçš„å¸¸ç”¨ä¼˜åŒ–é…ç½®"></a>å…­ã€Tomcatçš„å¸¸ç”¨ä¼˜åŒ–é…ç½®</h2><h3 id="ï¼ˆ1ï¼‰å†…å­˜ç©ºé—´ï¼š"><a href="#ï¼ˆ1ï¼‰å†…å­˜ç©ºé—´ï¼š" class="headerlink" title="ï¼ˆ1ï¼‰å†…å­˜ç©ºé—´ï¼š"></a>ï¼ˆ1ï¼‰å†…å­˜ç©ºé—´ï¼š</h3><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#vim /etc/sysyconfig/tomcatÂ </div><div class="line">JAVA_OPTS=<span class="string">"-server -Xms -Xmx -XX:NewSize= -XX:MaxNewSize= -XX:PermSize= -XX:MaxPermSize="</span></div></pre></td></tr></table></figure><ol><li>-server:æœåŠ¡å™¨æ¨¡å‹ </li><li>-Xms:å †å†…å­˜åˆå§‹åŒ–å¤§å°ï¼› </li><li>-Xmx:å †å†…å­˜ç©ºé—´ä¸Šé™ï¼› </li><li>-XX:NewSize=:æ–°ç”Ÿä»£ç©ºé—´åˆå§‹åŒ–å¤§å° ï¼› </li><li>-XX:MaxNewSize=:æ–°ç”Ÿä»£ç©ºé—´æœ€å¤§å€¼ ï¼› </li><li>-XX:PermSize=:æŒä¹…ä»£ç©ºé—´åˆå§‹åŒ–å¤§å°ï¼› </li><li>-XX:MaxPermSize=:æŒä¹…ä»£ç©ºé—´æœ€å¤§å€¼ï¼›  </li></ol><h3 id="ï¼ˆ2ï¼‰çº¿ç¨‹æ± è®¾ç½®ï¼š"><a href="#ï¼ˆ2ï¼‰çº¿ç¨‹æ± è®¾ç½®ï¼š" class="headerlink" title="ï¼ˆ2ï¼‰çº¿ç¨‹æ± è®¾ç½®ï¼š"></a>ï¼ˆ2ï¼‰çº¿ç¨‹æ± è®¾ç½®ï¼š</h3><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span> connectionTimeout=<span class="string">"200000"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div></pre></td></tr></table></figure><p>å¸¸ç”¨å±æ€§ï¼š</p><ol><li>maxThreads:æœ€å¤§çº¿ç¨‹æ•°ï¼› </li><li>minSpareThreads:æœ€å°ç©ºé—²çº¿ç¨‹æ•°ï¼› </li><li>maxSpareThreads:æœ€å¤§ç©ºé—²çº¿ç¨‹æ•°ï¼› </li><li>acceptCount:ç­‰å¾…é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼› </li><li>URIEnconding:URIåœ°å€ç¼–ç æ ¼å¼ï¼Œå»ºè®®ä½¿ç”¨UTF-8ï¼› </li><li>enableLookups:æ˜¯å¦å¯ç”¨dnsè§£æï¼Œå»ºè®®ç¦ç”¨ï¼› </li><li>compression:æ˜¯å¦å¯ç”¨ä¼ è¾“å‹ç¼©æœºåˆ¶ï¼Œå»ºè®®â€onâ€;</li><li>compressionMinSize:å¯ç”¨å‹ç¼©ä¼ è¾“çš„æ•°æ®æµæœ€å°å€¼ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼›</li><li>compressableMimeType:å®šä¹‰å¯ç”¨å‹ç¼©åŠŸèƒ½çš„MIMEç±»å‹;<br>text/html,text/xml,text/css,text/javascript;</li></ol><h3 id="ï¼ˆ3ï¼‰ç¦ç”¨8005ç«¯å£"><a href="#ï¼ˆ3ï¼‰ç¦ç”¨8005ç«¯å£" class="headerlink" title="ï¼ˆ3ï¼‰ç¦ç”¨8005ç«¯å£"></a>ï¼ˆ3ï¼‰ç¦ç”¨8005ç«¯å£</h3><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;Server port=<span class="string">"-1"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;Â </div><div class="line">Server=<span class="string">"SOME STRING"</span></div></pre></td></tr></table></figure><h3 id="ï¼ˆ4ï¼‰éšè—ç‰ˆæœ¬ä¿¡æ¯"><a href="#ï¼ˆ4ï¼‰éšè—ç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="ï¼ˆ4ï¼‰éšè—ç‰ˆæœ¬ä¿¡æ¯"></a>ï¼ˆ4ï¼‰éšè—ç‰ˆæœ¬ä¿¡æ¯</h3><figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span> connection Timeout=<span class="string">"20000"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div><div class="line">Server=<span class="string">"SOME STRING"</span></div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>keepalivedåŒä¸»æ¨¡å‹çš„å®ç°</title>
      <link href="/2018/02/07/keepalived%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/2018/02/07/keepalived%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><blockquote><p>keepalived ç®€ä»‹:æ˜¯æœåŠ¡å™¨é«˜å¯ç”¨çš„ä¸€ä¸ªé‡è¦è½¯ä»¶;<br>å®ƒçš„æ ¸å¿ƒç»„ä»¶æœ‰vrrp ï¼Œstackï¼Œ checker ï¼Œipvsï¼Œwarpperï¼Œ watch dog ;</p><p>å®ƒæ˜¯vrrpåè®®çš„å®ç°ï¼ŒåŸç”Ÿè®¾è®¡ç›®çš„ä¸ºé«˜å¯ç”¨ipvsæœåŠ¡ï¼›<br>keepalivedèƒ½å¤Ÿé€šè¿‡é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ç”Ÿæˆipvsè§„åˆ™;</p><p>å¹¶èƒ½å¤Ÿå¯¹RSçš„å¥åº·çŠ¶æ€è¿›è¡Œæ£€æµ‹ï¼›vrrp_script,vrrp_track; </p></blockquote><ul><li>åŒä¸»æ¨¡å‹çš„å®ç°</li></ul><blockquote><p>ç®€ä»‹:<br>åŒæ–¹æ¨¡å‹(ä¸»/å¤‡ï¼Œå¤‡/ä¸»)çš„è¿™é‡Œçš„æ„æ€æ˜¯ï¼Œä¸€ä¸ªkeepalivedé…ç½®ä¸­;<br>ä¸€ä¸ªè™šæ‹ŸIPåœ°å€ä¸ºä¸»ï¼Œå¦ä¸€ä¸ªä¸ºå¤‡ã€‚è€Œåœ¨å¦ä¸€ä¸ªkeepalivedçš„é…ç½®ä¸­;<br>ä¸å…¶å®ƒä¸»æœºåˆ™æ°æ°ç›¸åï¼Œä¸€ä¸ªè™šæ‹ŸIPåœ°å€ä¸ºå¤‡ï¼Œå¦ä¸€ä¸ªä¸ºä¸»;</p></blockquote><p>ä»¥ä¸‹ä¸ºæ­¤æ¬¡åŒä¸»æ¨¡å‹å®ç°çš„æ‹“æ‰‘<br><img src="/images/keepalived_rhca.jpg" alt=""></p><h2 id="äºŒã€HA-Clusteré…ç½®çš„å‰æï¼›"><a href="#äºŒã€HA-Clusteré…ç½®çš„å‰æï¼›" class="headerlink" title="äºŒã€HA Clusteré…ç½®çš„å‰æï¼›"></a>äºŒã€HA Clusteré…ç½®çš„å‰æï¼›</h2><h3 id="1-è¦ç‚¹-å„èŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´ç§˜éœ€è¦åŒæ­¥"><a href="#1-è¦ç‚¹-å„èŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´ç§˜éœ€è¦åŒæ­¥" class="headerlink" title="(1)è¦ç‚¹:å„èŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´ç§˜éœ€è¦åŒæ­¥:"></a>(1)è¦ç‚¹:å„èŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´ç§˜éœ€è¦åŒæ­¥:</h3><blockquote><p>ntpdate 172.16.0.1 (æ³¨æ­¤:å¤„å¯è‡ªå·±åœ¨ç½‘ä¸Šæ‰¾ä¸ªæ—¶é—´åŒæ­¥æœåŠ¡å™¨)</p></blockquote><h3 id="2-ç¡®ä¿iptablesåŠselinuxä¸ä¼šé˜»ç¢"><a href="#2-ç¡®ä¿iptablesåŠselinuxä¸ä¼šé˜»ç¢" class="headerlink" title="(2)ç¡®ä¿iptablesåŠselinuxä¸ä¼šé˜»ç¢:"></a>(2)ç¡®ä¿iptablesåŠselinuxä¸ä¼šé˜»ç¢:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#iptables -F &amp;&amp; setenforce 0</span></div></pre></td></tr></table></figure><p>###(3)å„èŠ‚ç‚¹ä¹‹é—´å¯é€šè¿‡ä¸»æœºåäº’ç›¸é€šä¿¡(å¯¹keepalivedå¹¶éå¿…é¡»):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/hostsÂ </span></div><div class="line"></div><div class="line">172.16.250.140 kpl1</div><div class="line"></div><div class="line">172.16.250.158 kpl2 ä¸¤å°keepalivedä¸»æœºéƒ½è¦ä¿®æ”¹</div></pre></td></tr></table></figure><p>###(4)å„èŠ‚ç‚¹ä¹‹é—´rootç”¨æˆ·å¯ä»¥åŸºäºå¯†é’¥è®¤è¯çš„sshé€šä¿¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ssh-copy-id -i 172.16.250.140</span></div><div class="line"></div><div class="line"><span class="comment"># ssh-copy-id -i 172.16.250.158</span></div></pre></td></tr></table></figure><h2 id="ä¸‰ã€dré›†ç¾¤é…ç½®"><a href="#ä¸‰ã€dré›†ç¾¤é…ç½®" class="headerlink" title="ä¸‰ã€dré›†ç¾¤é…ç½®"></a>ä¸‰ã€dré›†ç¾¤é…ç½®</h2><p>æ­¤å¤„ä½¿ç”¨dré›†ç¾¤ç±»å‹</p><p>é¦–å…ˆå°†dræ¨¡å‹é…ç½®å¥½ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim setkp.sh</span></div><div class="line"><span class="comment"># !/bin/bashÂ </span></div><div class="line">vip=172.16.26.126</div><div class="line">vip2=172.16.26.127</div><div class="line">mask=255.255.255.255</div><div class="line">interface=<span class="string">'lo:0'</span></div><div class="line">interface2=<span class="string">'lo:1'</span></div><div class="line">eth=<span class="string">'eno16777736:0'</span>Â </div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span>Â </div><div class="line">start)Â </div><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line">ifconfig <span class="variable">$interface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> upÂ </div><div class="line">ifconfig <span class="variable">$interface2</span> <span class="variable">$vip2</span> netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip2</span> upÂ </div><div class="line">route add -host <span class="variable">$vip</span> dev <span class="variable">$interface</span>Â </div><div class="line">route add -host <span class="variable">$vip2</span> dev <span class="variable">$interface2</span></div><div class="line">;;Â </div><div class="line">dstart)Â </div><div class="line">ifconfig <span class="variable">$eth</span> <span class="variable">$vip</span>/32 netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up</div><div class="line">;;</div><div class="line">dstop)</div><div class="line">ifconfig <span class="variable">$eth</span> down</div><div class="line">;;</div><div class="line">stop)</div><div class="line">ifconfig <span class="variable">$interface</span> downÂ </div><div class="line">ifconfig <span class="variable">$interface2</span> down</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line">;;Â </div><div class="line">status)Â </div><div class="line">ifconfigÂ </div><div class="line">cat /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line">cat /proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line">cat /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line">cat /proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line">;;Â </div><div class="line">*)</div><div class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$(basename $0)</span> &#123;dstart|dstop|start|stop&#125;"</span></div><div class="line"><span class="built_in">exit</span> 1Â </div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure><p>RS1ã€RS2ä¸»æœºä¸­éƒ½æ‰§è¡Œæ‰§è¡Œæ­¤è„šæœ¬ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sh setkp.sh startÂ </span></div><div class="line"><span class="comment"># sh setkp.sh status å¯ç”¨æ¥æŸ¥çœ‹å½“å‰ç½‘ç»œçš„é…ç½®çŠ¶æ€Â </span></div><div class="line"><span class="comment">#RS1ã€RS2ä¸»æœºä¸­å®‰è£…httpdå¹¶å¯åŠ¨Â </span></div><div class="line"><span class="comment"># yum -y install httpd &amp;&amp; systemctl start httpd Â </span></div><div class="line">RS1<span class="comment"># echo "&lt;h1&gt;RS1&lt;/h1&gt;" &gt; /usr/share/nginx/html/index.htmlÂ </span></div><div class="line">RS2 <span class="comment"># echo "&lt;h1&gt;RS2&lt;/h1&gt;" &gt; /usr/share/nginx/html/index.html</span></div></pre></td></tr></table></figure><h2 id="å››ã€keepalivedé…ç½®"><a href="#å››ã€keepalivedé…ç½®" class="headerlink" title="å››ã€keepalivedé…ç½®"></a>å››ã€keepalivedé…ç½®</h2><p>keepalived,keepalived2 ä¸­å®‰è£…nginx<br>(httpdå’Œnginxéƒ½å¯ä»¥,æ­¤å¤„ç”¨æ¥åšä¸ºkeepalivedçš„æœ¬èº«çš„æä¾›sorry server)<br>å½“dré›†ç¾¤çš„ä¸¤å°èŠ‚ç‚¹éƒ½åœæ­¢æ—¶ï¼Œä¼šç”±keepalivedæœ¬èº«æ¥æä¾›ä¸€ä¸ªé¡µé¢</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum -y install nginx keepalived ipvsadm &amp;&amp; systemctl start nginxÂ </span></div><div class="line"><span class="comment"># echo "&lt;h1&gt;sorry server keepalived 1 &lt;/h1&gt;" &gt; /usr/share/nginx/html/index.htmlÂ </span></div><div class="line"><span class="comment"># echo "&lt;h1&gt;sorry server keepalived 2 &lt;/h2&gt;" &gt; /usr/share/nginx/html/index.htmlÂ </span></div><div class="line">```bash</div><div class="line"></div><div class="line">åœ¨ä¸€å°keepalivedä¸»æœºä¸Šè¿›è¡Œæµ‹è¯•</div><div class="line"></div><div class="line">```bash</div><div class="line"><span class="comment"># curl 172.16.251.232</span></div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line"><span class="comment"># curl 172.16.250.159</span></div><div class="line">&lt;h1&gt;RS2&lt;/h1&gt;</div></pre></td></tr></table></figure><p>keepalived,keepalived2 ä¸­åœ¨ /etc/keepalived/ç›®å½•ä¸‹ç¼–è¾‘ä¸€ä¸ªè„šæœ¬æ¥ç”¨æ¥åœ¨ä¸»å¤‡å˜åŒ–<br>æˆ–æœåŠ¡downæ‰æ—¶å‘é‚®ä»¶ç»™ç³»ç»Ÿç”¨æˆ· </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim kmail.shÂ </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">contact=<span class="string">'root@localhost'</span></div><div class="line"><span class="function"><span class="title">notify</span></span>()&#123;</div><div class="line">mailsubject=<span class="string">"<span class="variable">$(hostname)</span> to be <span class="variable">$1</span>:vip floating"</span></div><div class="line">mailbody=<span class="string">"<span class="variable">$(date +'%F %T')</span>:vrrp transition, <span class="variable">$(hostname)</span> change to be <span class="variable">$1</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="variable">$mailbody</span> | mail -s <span class="string">"<span class="variable">$mailsubject</span>"</span> <span class="variable">$contact</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span>Â </div><div class="line">master )</div><div class="line">notify master</div><div class="line">;;</div><div class="line">backup )</div><div class="line">notify backupÂ </div><div class="line">;;</div><div class="line">fault )</div><div class="line">notify faultÂ </div><div class="line">;;</div><div class="line">*)</div><div class="line"><span class="built_in">echo</span> <span class="string">"Usage:<span class="variable">$(basename $0)</span> &#123;master |backup|fault&#125;"</span></div><div class="line">;;</div><div class="line"><span class="keyword">esac</span></div><div class="line"><span class="comment">#chmod +x kmail.sh</span></div></pre></td></tr></table></figure><blockquote><p>æ³¨:keepalivedçš„ä¸¤å°ä¸»æœºçš„é…ç½®åŸºæœ¬ç›¸åŒï¼Œå½“é…ç½®æ¨¡å‹ä¸ºä¸»/å¤‡æ¨¡å‹çš„æ—¶å€™ï¼Œä¸»å¤‡ä¹‹é—´éœ€è¦ä¿®æ”¹ä¸‰ä¸ªæŒ‡ä»¤ </p></blockquote><p>åˆ†åˆ«ä¸º router_id kpl1 åœ¨keepalived2ä¸Šæ—¶éœ€è¦ä¿®æ”¹ä¸º router_id kpl2<br>state MASTER åœ¨keepalived2ä¸Šæ—¶éœ€è¦ä¿®æ”¹ä¸º state BACKUP<br>priority 100 åœ¨keepalived2ä¸Šæ—¶éœ€è¦ä¿®æ”¹ä¸º  priority 90 (æ­¤å¤„çš„å€¼æ¯”ä¸»æœåŠ¡å™¨çš„å°ä¾¿å¯ä»¥)<br>ä»¥ä¸‹ä¸»/å¤‡çš„é…ç½®ç¤ºä¾‹</p><p><img src="/images/keepalived_master.jpg" alt=""><br><img src="/images/keepalived_slave.jpg" alt=""></p><p>###å…ˆæŠŠå¤‡çš„æœåŠ¡å™¨å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tcpdump -i eno33554984 -nn host 224.0.61.61</span></div></pre></td></tr></table></figure><p>å¯ä½¿ç”¨tcpdump æŠ“å–ç»„æ’­åœ°å€ æ¥æŸ¥çœ‹å…¶é€šè¿‡ç»„æ’­æ–¹å¼ä¼ é€’çš„å¿ƒè·³ä¿¡æ¯<br>ä»¥ä¸‹çš„é…ç½®æ–‡ä»¶ä¾¿æ˜¯keepavliedåŒä¸»æ¨¡å‹çš„å®ç°<br>å¯¹é˜²ç«å¢™æ‰“æ ‡è®°<br>keepalived 1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.126 -p tcp --dport 80 -j MARK --set-mark 3Â </span></div><div class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.127 -p tcp --dport 80 -j MARK --set-mark 3</span></div><div class="line"><span class="comment"># vim /etc/keepalived/keepalived.conf</span></div><div class="line">! Configuration File <span class="keyword">for</span> keepalivedÂ </div><div class="line">global_defs &#123;</div><div class="line">Â  notification_email &#123;</div><div class="line">root@localhost</div><div class="line">&#125;</div><div class="line">Â  notification_email_from Alexandre.Cassen@firewall.loc</div><div class="line">Â  smtp_server 127.0.0.1</div><div class="line">Â  smtp_connect_timeout 30</div><div class="line">Â  router_id kpl1</div><div class="line">Â  vrrp_mcast_group4 224.0.61.61</div><div class="line">&#125;</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">state MASTER</div><div class="line">interface eno33554984</div><div class="line">virtual_router_id 55</div><div class="line">priority 100</div><div class="line">advert_int 1</div><div class="line">notify_master <span class="string">"/etc/keepalived/kmail.sh master"</span></div><div class="line">notify_backup <span class="string">"/etc/keepalived/kmail.sh backup"</span></div><div class="line">notify_fault Â <span class="string">"/etc/keepalived/kmail.sh fault"</span></div><div class="line">authentication &#123;</div><div class="line">auth_type PASS</div><div class="line">auth_pass zE2kNsRQ</div><div class="line">&#125;</div><div class="line"></div><div class="line">virtual_ipaddress &#123;</div><div class="line">172.16.26.126 dev eno33554984 label eno33554984:0 Â  Â </div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">vrrp_instance VI_2 &#123;</div><div class="line">state BACKUP</div><div class="line">interface eno33554984</div><div class="line">virtual_router_id 66</div><div class="line">priority 90</div><div class="line">advert_int 1</div><div class="line">notify_master <span class="string">"/etc/keepalived/kmail.sh master"</span></div><div class="line">notify_backup <span class="string">"/etc/keepalived/kmail.sh backup"</span></div><div class="line">notify_fault Â <span class="string">"/etc/keepalived/kmail.sh fault"</span></div><div class="line">authentication &#123;</div><div class="line">auth_type PASS</div><div class="line">auth_pass zE2kfsRQ</div><div class="line">&#125;</div><div class="line">virtual_ipaddress &#123;</div><div class="line">172.16.26.127 dev eno33554984 label eno33554984:1 Â  Â </div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">virtual_server fwmark 3 &#123;</div><div class="line">delay_loop 2</div><div class="line">lb_algo wrrÂ </div><div class="line">lb_kind DR</div><div class="line">nat_mask 255.255.0.0</div><div class="line">protocol TCP</div><div class="line">sorry_server 127.0.0.1 80</div><div class="line">Â </div><div class="line">real_server 172.16.251.232 80 &#123;</div><div class="line">weight 3</div><div class="line">HTTP_GET &#123;</div><div class="line">url &#123;Â </div><div class="line">Â path /</div><div class="line">Â status_code 200 Â </div><div class="line">Â &#125;</div><div class="line">connect_timeout 2</div><div class="line">nb_get_retry 3</div><div class="line">delay_before_retry 3</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">real_server 172.16.250.159 80 &#123;</div><div class="line">weight 1</div><div class="line">HTTP_GET &#123;</div><div class="line">url &#123;Â </div><div class="line">path /</div><div class="line">status_code 200 Â u</div><div class="line">Â &#125;</div><div class="line">oconnect_timeout 2e</div><div class="line">nb_get_retry n</div><div class="line">delay_before_retry 3</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p> keepalived 2 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.126 -p tcp --dport 80 -j MARK --set-mark 3</span></div><div class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.26.127 -p tcp --dport 80 -j MARK --set-mark 3</span></div><div class="line"><span class="comment"># vim /etc/keepavlied/keepalived.confÂ </span></div><div class="line">! Configuration File <span class="keyword">for</span> keepalived</div><div class="line">global_defs &#123;</div><div class="line">Â  notification_email &#123;</div><div class="line">root@localhost</div><div class="line">&#125;</div><div class="line">Â  notification_email_from Alexandre.Cassen@firewall.loc</div><div class="line">Â  smtp_server 127.0.0.1</div><div class="line">Â  smtp_connect_timeout 30</div><div class="line">Â  router_id kpl2</div><div class="line">Â  vrrp_mcast_group4 224.0.61.61</div><div class="line">&#125;</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">state BACKUP</div><div class="line">interface eno33554984</div><div class="line">virtual_router_id 55</div><div class="line">priority 90</div><div class="line">advert_int 1</div><div class="line">notify_master <span class="string">"/etc/keepalived/kmail.sh master"</span></div><div class="line">notify_backup <span class="string">"/etc/keepalived/kmail.sh backup"</span></div><div class="line">notify_fault Â <span class="string">"/etc/keepalived/kmail.sh fault"</span></div><div class="line">authentication &#123;</div><div class="line">auth_type PASS</div><div class="line">auth_pass zE2kNsRQ</div><div class="line">&#125;</div><div class="line">virtual_ipaddress &#123;</div><div class="line">172.16.26.126 dev eno33554984 label eno33554984:0 Â  Â </div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">vrrp_instance VI_2 &#123;</div><div class="line">state MASTER</div><div class="line">interface eno33554984</div><div class="line">virtual_router_id 66</div><div class="line">priority 100</div><div class="line">advert_int 1</div><div class="line">notify_master <span class="string">"/etc/keepalived/kmail.sh master"</span></div><div class="line">notify_backup <span class="string">"/etc/keepalived/kmail.sh backup"</span></div><div class="line">notify_fault Â <span class="string">"/etc/keepalived/kmail.sh fault"</span></div><div class="line">authentication &#123;</div><div class="line">auth_type PASS</div><div class="line">auth_pass zE2kfsRQ</div><div class="line">&#125;</div><div class="line">virtual_ipaddress &#123;</div><div class="line">172.16.26.127 dev eno33554984 label eno33554984:1 Â  Â </div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">virtual_server fwmark 3 Â &#123;</div><div class="line">delay_loop &#123;</div><div class="line">lb_algo wrr</div><div class="line">lb_kind DR</div><div class="line">nat_mask 255.255.0.0</div><div class="line">protocol TCP</div><div class="line">sorry_server 127.0.0.1 80</div><div class="line">real_server 172.16.251.232 80 &#123;</div><div class="line">weight 3</div><div class="line">HTTP_GET &#123;</div><div class="line">url &#123;</div><div class="line">Â path /</div><div class="line">Â status_code 200</div><div class="line">Â &#125;</div><div class="line">connect_timeout 2</div><div class="line">nb_get_retry 3</div><div class="line">delay_before_retry 3</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">real_server 172.16.250.159 80 &#123;</div><div class="line">weight 1</div><div class="line">HTTP_GET &#123;</div><div class="line">url &#123;</div><div class="line">Â path /</div><div class="line">Â status_code 200</div><div class="line">Â &#125;</div><div class="line">connect_timeout 2</div><div class="line">nb_get_retry 3</div><div class="line">delay_before_retry 3</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="äº”ã€æµ‹è¯•"><a href="#äº”ã€æµ‹è¯•" class="headerlink" title="äº”ã€æµ‹è¯•"></a>äº”ã€æµ‹è¯•</h2><p>æ­¤æ—¶å¯ä»¥æµ‹è¯•å…¶è®¿é—®</p><p><img src="/images/keepalived_test1.jpg" alt=""><br>å½“ä¸€ä¸ªkeepavliedåœæ­¢æ—¶<br><img src="/images/keepalived_test2.jpg" alt=""><br>å½“RS2åœæ­¢æ—¶<br><img src="/images/keepalived_test3.jpg" alt=""><br>å½“RS1ï¼ŒRS2éƒ½åœæ­¢æ—¶<br><img src="/images/keepalived_test4.jpg" alt=""></p><p>##å…­ã€keepavliedé…ç½®æŒ‡ä»¤è¯´æ˜ </p><p>è™šæ‹Ÿè·¯ç”±å™¨æ®µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">state MASTERï¼šå½“å‰èŠ‚ç‚¹åœ¨è™šæ‹Ÿè·¯ç”±å™¨ä¸­çš„åˆå§‹çŠ¶æ€ï¼›</div><div class="line">interface ETHERCARD: vrrpå®é™…å·¥ä½œçš„ç½‘å¡æ¥å£</div><div class="line">virtual_route_id 51 :è™šæ‹Ÿè·¯ç”±å™¨IDï¼ŒèŒƒå›´0-255ï¼›</div><div class="line">priority 100 :å½“å‰ç‰©ç†èŠ‚ç‚¹åœ¨æ­¤è™šæ‹Ÿè·¯ç”±å™¨ä¸­çš„ä¼˜å…ˆçº§ï¼›</div><div class="line">advert_int 1:æ¯éš”å¤šä¹…å‘é€å¿ƒè·³(é€šè¡Œçš„æ—¶é—´é—´éš”)</div><div class="line">auth_type PASS ï¼šé€‰æ‹©è®¤è¯æœºåˆ¶Â </div><div class="line">auth_pass 1111 ï¼šå¯†ç  å…«ä½æœ‰æ•ˆ</div><div class="line">virtual_ipaddress ï¼šå®šä¹‰è™šæ‹ŸIPÂ </div><div class="line">track_interface ï¼š å®šä¹‰è¦ç›‘æ§çš„æ¥å£</div><div class="line">notify_master &lt;STRING&gt; | &lt;QUOTED-STRING&gt; ï¼šå½“å‰èŠ‚ç‚¹å˜ä¸ºä¸»èŠ‚ç‚¹æ—¶ç”¨STRINGè„šæœ¬é€šå‘Š</div><div class="line">notfy_backup&lt;STRING&gt; | &lt;QUOTED-STRING&gt; : å½“å‰èŠ‚ç‚¹å˜ä¸ºä¸»èŠ‚æ—¶ç”¨ STRINGè„šæœ¬é€šå‘Š</div><div class="line">notify_fault&lt;STRING&gt; | &lt;QUOTED-STRING&gt; : å½“å‰èŠ‚ç‚¹ä¸Šä¸äº†çº¿æ—¶ç”¨STRINGè„šæœ¬é€šå‘Š</div><div class="line">notify&lt;STRING&gt; | &lt;QUOTED-STRING&gt; : å¦‚æœä¸‰ç§çŠ¶æ€ç”¨ä¸€ä¸ªè„šæœ¬æ¥å®ç°ç”¨STRINGè„šæœ¬é€šå‘Š</div></pre></td></tr></table></figure><p>è™šæ‹ŸæœåŠ¡æ®µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">lb_algo rr | wrr|lc|lblc|sh|dh :å®šä¹‰è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•</div><div class="line">delay_loop&lt;INT&gt;ï¼šï¼šå®šä¹‰æœåŠ¡è½®è¯¢æ—¶é—´é—´éš”</div><div class="line">bl_kind NAT |DR |TUN ï¼šé›†ç¾¤çš„ç±»å‹</div><div class="line">persistence_time_out&lt;INT&gt; ï¼šæŒä¹…è¿æ¥æ—¶é•¿</div><div class="line">protocol TCP : æœåŠ¡åè®®</div><div class="line">sorry_server&lt;IPADDR&gt;&lt;PORT&gt;ï¼šæ‰€æœ‰RSå‡æ•…éšœæ—¶ï¼Œæä¾›sorry serverçš„æœåŠ¡å™¨ï¼›</div><div class="line">real_server&lt;IPADDR&gt;&lt;PORT&gt;:</div><div class="line">weight&lt;INT&gt;ï¼šæƒé‡</div><div class="line">notify_up&lt;STRING&gt;|&lt;QUOTED-STRING&gt; ï¼š èŠ‚ç‚¹ä¸Šçº¿é€šçŸ¥è„šæœ¬</div><div class="line">notify_down &lt;STRING&gt;|&lt;QUOTED-STRNG&gt;ï¼šèŠ‚ç‚¹ç¦»çº¿é€šçŸ¥è„šæœ¬ï¼›</div><div class="line"><span class="comment">#HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK ï¼šæ”¯æŒçš„æ‰€ä»¥å¥åº·çŠ¶æ€çš„æ£€æµ‹æ–¹å¼</span></div><div class="line">url:å¥åº·çŠ¶æ€æ£€æµ‹æ—¶è¯·æ±‚çš„èµ„æºçš„URLÂ </div><div class="line">delay_before_retry&lt;INT&gt; ï¼šä¸¤æ¬¡å°è¯•ä¹‹é—´çš„æ—¶é—´é—´éš”Â </div><div class="line">connect_timeoute&lt;STRING&gt;ï¼šè¿æ¥çš„è¶…æ—¶æ—¶é•¿</div><div class="line">connect_ip&lt;IP ADDRESS&gt;ï¼šå‘æ­¤å¤„æŒ‡å®šçš„åœ°å€å‘æµ‹è¯•è¯·æ±‚</div><div class="line">connect_port&lt;PORT&gt;ï¼šå‘æ­¤å¤„æŒ‡å®šçš„PORTå‘æµ‹è¯•è¯·æ±‚</div><div class="line">bindto&lt;IP ADDRESS&gt;ï¼šæŒ‡å®šæµ‹è¯•è¯·æ±‚æŠ¥æ–‡çš„æºIPÂ </div><div class="line">bind_port&lt;PORT&gt;ï¼š æŒ‡å®šæµ‹è¯•è¯·æ±‚æŠ¥æ–‡çš„æºPORT</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MariaDBä¹‹MHAé…ç½®</title>
      <link href="/2018/02/06/MariaDB%E4%B9%8BMHA%E9%85%8D%E7%BD%AE/"/>
      <url>/2018/02/06/MariaDB%E4%B9%8BMHA%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="å·¥ä½œæ‹“æ‰‘"><a href="#å·¥ä½œæ‹“æ‰‘" class="headerlink" title="å·¥ä½œæ‹“æ‰‘"></a>å·¥ä½œæ‹“æ‰‘</h2><p><img src="/images/mariadb_mha.png" alt=""></p><h2 id="ä¸€ã€MHAç®€æ˜"><a href="#ä¸€ã€MHAç®€æ˜" class="headerlink" title="ä¸€ã€MHAç®€æ˜"></a>ä¸€ã€MHAç®€æ˜</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">MHAï¼ˆMaster HAï¼‰æ˜¯ä¸€æ¬¾å¼€æºçš„MySQLçš„é«˜å¯ç”¨ç¨‹åºï¼Œå®ƒä¸ºMySQLä¸»ä»å¤åˆ¶æ¶æ„æä¾›äº†</div><div class="line">    automating master failover åŠŸèƒ½ã€‚MHAåœ¨ç›‘æ§åˆ°masterèŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä¼šæå‡å…¶ä¸­</div><div class="line">    æ‹¥æœ‰æœ€æ–°æ•°æ®çš„slaveèŠ‚ç‚¹æ¥æˆä¸ºæ–°çš„masterèŠ‚ç‚¹ã€‚åœ¨æ­¤æœŸé—´ï¼ŒMHAä¼šé€šè¿‡äºå…¶å®ƒä»èŠ‚ç‚¹</div><div class="line">    è·å–é¢å¤–ä¿¡æ¯æ¥é¿å…ä¸€è‡´æ€§æ–¹é¢çš„é—®é¢˜ã€‚MHAè¿˜æä¾›äº†masterèŠ‚ç‚¹çš„åœ¨çº¿åˆ‡æ¢åŠŸèƒ½ï¼Œå³æŒ‰</div><div class="line">    éœ€åˆ‡æ¢master/slaveèŠ‚ç‚¹ã€‚</div><div class="line">MHAæœåŠ¡æœ‰ä¸¤å’±è§’è‰²ã€‚MHA Mangager(ç®¡ç†èŠ‚ç‚¹)å’ŒMHA Node(æ•°æ®èŠ‚ç‚¹)ï¼š</div><div class="line">Â Â  Â MHA Managerï¼šé€šå¸¸å•ç‹¬éƒ¨ç½²åœ¨ä¸€å°ç‹¬ç«‹æœºå™¨ä¸Šç®¡ç†å¤šä¸ªmaster/slaveé›†ç¾¤ï¼Œæ¯ä¸ª</div><div class="line">Â Â  Â master/slaveé›†ç¾¤ç§°ä½œä¸€ä¸ªapplication:</div><div class="line">Â Â  Â MHA node:è¿è¡Œåœ¨æ¯å°MySQLæœåŠ¡å™¨ä¹‹ä¸Š(master/slave/manager),å®ƒé€šè¿‡ç›‘æ§</div><div class="line">Â Â  Â å…·åŠ¡è§£æå’Œæ¸…ç†logsåŠŸèƒ½æ¥è„šæœ¬æ¥åŠ å¿«æ•…éšœè½¬ç§»ã€‚</div></pre></td></tr></table></figure><h2 id="äºŒã€MHA-ç»„ä»¶"><a href="#äºŒã€MHA-ç»„ä»¶" class="headerlink" title="äºŒã€MHA ç»„ä»¶"></a>äºŒã€MHA ç»„ä»¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Â Â  Â MHAä¼šæä¾›è¯¸å¤šå·¥å…·ç¨‹åºï¼Œå…¶å¸¸è§çš„å¦‚ä¸‹æ‰€ç¤ºã€‚ </div><div class="line">Â Â  Â ManagerèŠ‚ç‚¹:</div><div class="line">Â Â  Â Â Â  masterha_check_ssh:MHAä¾èµ–çš„SSHç¯å¢ƒæ£€æµ‹å·¥å…·ï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_check_repl:MySQLå¤åˆ¶ç¯å¢ƒæ£€æµ‹å·¥å…·ï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_mamager:MHAæœåŠ¡ä¸»ç¨‹åºï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_check_status:MHAè¿è¡ŒçŠ¶æ€æ¢æµ‹å·¥å…·ï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_master_monitor:MySQL masterèŠ‚ç‚¹å¯ç”¨æ€§ç›‘æµ‹å·¥å…·ï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_master_swith:masterèŠ‚ç‚¹åˆ‡æ¢å·¥å…·ï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_conf_host:æ·»åŠ æˆ–åˆ é™¤é…ç½®çš„èŠ‚ç‚¹ï¼›</div><div class="line">Â Â  Â Â Â  Â masterha_stop:æ–—é—­MHAæœåŠ¡çš„å·¥å…· ï¼›</div><div class="line">Â Â  Â Â Â  Â </div><div class="line"></div><div class="line">Â Â  Â Node èŠ‚ç‚¹:</div><div class="line">Â Â  Â Â Â  Â save_binary_logs:ä¿å­˜å’Œå¤åˆ¶Masterçš„äºŒè¿›åˆ¶æ—¥å¿— ï¼›</div><div class="line">Â Â  Â Â Â  Â apply_diff_replay_logs:è¯†åˆ«å·®å¼‚çš„ä¸­ç»§æ—¥å¿—äº‹ä»¶å¹¶åº”ç”¨äºå…¶å®ƒslave;</div><div class="line">Â Â  Â Â Â  Â filter_mysqlbinlog:å»é™¤ä¸å¿…è¦çš„ROLLBACKäº‹ä»¶(MHAå·²ä¸å†ä½¿ç”¨è¿™ä¸ªå·¥å…·)ï¼›</div><div class="line">Â Â  Â Â Â  Â purge_replay_logs:æ¸…é™¤ä¸­ç»§æ—¥å¿—(ä¸ä¼šé˜»å¡SQLçº¿ç¨‹)ï¼›</div><div class="line">Â Â  Â Â Â  Â </div><div class="line">Â Â  Â è‡ªå®šä¹‰æ‰©å±•:</div><div class="line">Â Â  Â Â Â  Â secondary_check_script:é€šè¿‡å¤šæ¡ç½‘ç»œè·¯ç”±æ£€æµ‹masterçš„å¯ç”¨æ€§ï¼›</div><div class="line">Â Â  Â Â Â  Â master_ip_failover_scipt:æ›´æ–°applicationä½¿ç”¨çš„masterip;</div><div class="line">Â Â  Â Â Â  Â shutdown_scriptï¼šå¼ºåˆ¶å…³é—­masterèŠ‚ç‚¹ï¼›</div><div class="line">Â Â  Â Â Â  Â report_scipt:å‘é€æŠ¥å‘Šï¼›</div><div class="line">Â Â  Â Â Â  Â init_conf_load_script:åŠ è½½åˆå§‹é…ç½®å‚æ•°ï¼›</div><div class="line">Â Â  Â Â Â  Â master_ip_online_change_scipt:æ›´æ–°masterèŠ‚ç‚¹ipåœ°å€ï¼›</div></pre></td></tr></table></figure><h2 id="ä¸‰ã€å‡†å¤‡MySQL-Replicatinç¯å¢ƒ"><a href="#ä¸‰ã€å‡†å¤‡MySQL-Replicatinç¯å¢ƒ" class="headerlink" title="ä¸‰ã€å‡†å¤‡MySQL Replicatinç¯å¢ƒ"></a>ä¸‰ã€å‡†å¤‡MySQL Replicatinç¯å¢ƒ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Â Â  Â MHAå¯¹MySQLå¤åˆ¶ç¯å¢ƒæœ‰ç‰¹æ®Šè¦æ±‚ï¼Œä¾‹å¦‚å„èŠ‚ç‚¹éƒ½è¦å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠä¸­ç»§æ—¥å¿—ï¼Œ</div><div class="line">Â Â  Â å„ä»èŠ‚ç‚¹ å¿…é¡»å¯ç”¨å…¶read-only skip_name_resolve innodb_file_per_table=ON å±æ€§ï¼Œ</div><div class="line">Â Â  Â å¹¶å…³é—­relay_log_purgeåŠŸèƒ½ç­‰ï¼Œè¿˜æœ‰ä½“é›†äº‹ç‰©æ‰€å¿…éœ€çš„åŒæ­¥ï¼›</div></pre></td></tr></table></figure><h3 id="åŒæ­¥ä¸»æœº"><a href="#åŒæ­¥ä¸»æœº" class="headerlink" title="åŒæ­¥ä¸»æœº"></a>åŒæ­¥ä¸»æœº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;0..3&#125; ; do ssh node$i ntpdate 172.16.0.1 ; done</span></div><div class="line">Â Â Â  <span class="comment"># æœ¬å®éªŒå¢ƒå…±æœ‰å››ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­è§’è‰²åˆ†é…å¦‚ä¸‹ï¼›</span></div><div class="line">node0 :MHA Manager(172.16.23.10);</div><div class="line">node1 :MariaDB master</div><div class="line">node2 :MariaDB slave</div><div class="line">node3 :MariaDB slave</div><div class="line">Â Â Â <span class="comment"># å„èŠ‚ç‚¹çš„/etc/hostsæ–‡ä»¶é…ç½®å†…å®¹æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼›</span></div><div class="line">172.16.23.10 node0 node0.rj.com</div><div class="line">172.16.23.11 node1 node1.rj.com</div><div class="line">172.16.23.12 node2 node2.rj.com</div><div class="line">172.16.23.13 node3 node3.rj.com</div></pre></td></tr></table></figure><h3 id="åˆå§‹ä¸»èŠ‚ç‚¹çš„masteré…ç½®"><a href="#åˆå§‹ä¸»èŠ‚ç‚¹çš„masteré…ç½®" class="headerlink" title="åˆå§‹ä¸»èŠ‚ç‚¹çš„masteré…ç½®"></a>åˆå§‹ä¸»èŠ‚ç‚¹çš„masteré…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">node1 # vim /etc/my.cnf</div><div class="line">        innodb_file_per_table=ON # æ­¤é¡¹å†…å®¹ä¸ä¸‹é¢ä¸€é¡¹å†…å®¹ä¸€èˆ¬åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶ä¾¿åŠ ä¸Š</div><div class="line">        skip_name_resolve=ON</div><div class="line">        server_id=1</div><div class="line">        relay_log=relay-bin</div><div class="line">        log-bin=log-bin</div><div class="line">        symbolic-links=0</div></pre></td></tr></table></figure><h3 id="æ‰€æœ‰slaveèŠ‚ç‚¹ä¾èµ–çš„é…ç½®"><a href="#æ‰€æœ‰slaveèŠ‚ç‚¹ä¾èµ–çš„é…ç½®" class="headerlink" title="æ‰€æœ‰slaveèŠ‚ç‚¹ä¾èµ–çš„é…ç½®"></a>æ‰€æœ‰slaveèŠ‚ç‚¹ä¾èµ–çš„é…ç½®</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">node(2,3)# vim /etc/my.cnf    </div><div class="line">    innodb_file_per_table=ON</div><div class="line">    skip_name_resolve=ON</div><div class="line">    server_id=2 #æ³¨ æ­¤å¤„çš„ç»“ç‚¹åˆ°äº†åˆ«çš„èŠ‚ç‚¹ä¸­ä¸€å®šè¦æ”¹ï¼Œå„èŠ‚ç‚¹çš„idå¿…éœ€å”¯ä¸€ï¼›</div><div class="line">    relay-log=relay-bin</div><div class="line">    log-bin=master-bin</div><div class="line">    relay-log-purge=OFF</div><div class="line">    read-only=ON</div></pre></td></tr></table></figure><pre><code>æŒ‰ä¸Šè¿°è¦æ±‚åˆ†åˆ«é…ç½®å¥½ä¸»ä»èŠ‚ç‚¹ä¹‹å,æŒ‰MySQLå¤åˆ¶é…ç½®æ¶æ„çš„é…ç½®æ–¹å¼å°†å…¶é…ç½®å®Œæˆå¹¶å‚åŠ¨masterèŠ‚ç‚¹å’Œå„slaveèŠ‚ç‚¹ï¼Œä»¥åŠå„slaveèŠ‚ç‚¹å¯åŠ¨å…¶IOå’ŒSQLçº¿ç¨‹ï¼Œç¡®ä¿ä¸»ä»å¤åˆ¶è¿è¡Œæ— è¯¯</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">node1     mysql&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO 'rj'@'172.16.%.%' IDENTIFIED BY 'centos.123' ;</div><div class="line">node(2,3) mysql&gt; CHANGE MASTER TO MASTER_HOST='172.16.23.11',MASTER_USER='rj',MASTER_PASSWORD='centos.123',MASTER_LOG_FILE='log-bin.000001',MASTER_LOG_POS=492;</div><div class="line">          mysql&gt; START SLAVE;</div><div class="line">          mysql&gt; SHOW SLAVE STATUS;</div><div class="line">              Slave_IO_Running: Yes</div><div class="line">              Slave_SQL_Running: Yes</div><div class="line">              # ä»¥ä¸‹ä¸¤é¡¹æ˜¯å¦ä¸ºyes</div></pre></td></tr></table></figure><pre><code>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸»ç»“ç‚¹ä¸Šåˆ›å»ºä¸ªåº“æˆ–è¡¨ï¼ŒæŸ¥çœ‹å…¶æ˜¯å¦å¯å°å®ç°ä¸»ä»åŒæ­¥ï¼› è€Œåï¼Œåœ¨æ‰€æœ‰MySQLèŠ‚ç‚¹æˆæƒæ‹¥æœ‰ç®¡ç†æƒé™çš„ç”¨æˆ·å¯åœ¨æœ¬åœ°ç½‘ç»œä¸­æœ‰å…¶å®ƒèŠ‚ç‚¹ä¸Šè¿œç¨‹æ–¹é—®ã€‚å½“ç„¶ï¼Œæ­¤æ—¶ä»…éœ€è¦ä¸”åªèƒ½åœ¨masterèŠ‚ç‚¹è¿è¡Œç±»ä¼¼å¦‚ä¸‹SQLè¯­å¥å³å¯ã€‚</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;  GRANT ALL ON *.* to 'rjyy'@'172.16.%.%' IDENTIFIED BY 'centos.123';</div></pre></td></tr></table></figure><h2 id="ä¸‰ã€å®‰è£…é…ç½®MHA"><a href="#ä¸‰ã€å®‰è£…é…ç½®MHA" class="headerlink" title="ä¸‰ã€å®‰è£…é…ç½®MHA"></a>ä¸‰ã€å®‰è£…é…ç½®MHA</h2><h3 id="å‡†å¤‡åŸºäºsshäº’ä¿¡é€šä¿¡ç¯å¢ƒ"><a href="#å‡†å¤‡åŸºäºsshäº’ä¿¡é€šä¿¡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡åŸºäºsshäº’ä¿¡é€šä¿¡ç¯å¢ƒ"></a>å‡†å¤‡åŸºäºsshäº’ä¿¡é€šä¿¡ç¯å¢ƒ</h3><pre><code>MHAé›†ç¾¤ä¸­çš„å„èŠ‚ç‚¹å½¼æ­¤ä¹‹é—´å‡éœ€åŸºäºsshäº’ä¿¡é€šä¿¡ï¼Œä»¥å®ç°è¿œç¨‹æ§åˆ¶åŠæ•°æ®ç®¡ç†åŠŸèƒ½ã€‚ç®€å•èµ·è§ï¼Œå¯åœ¨ManagerèŠ‚ç‚¹ç”Ÿæˆå¯†é’¥å¯¹ï¼Œå¹¶è®¾ç½®å…¶å¯è¿œç¨‹è¿æ¥æœ¬åœ°ä¸»æœºåï¼Œå°†ç§é’¥æ–‡ä»¶åŠauthorized_keysæ–‡ä»¶å¤åˆ¶ç»™ä½™ä¸‹çš„æ‰€æœ‰ç»“ç‚¹å³å¯ã€‚ä¸‹é¢çš„çš„æ“ä½œåœ¨managerï¼ˆnode0ï¼‰èŠ‚ç‚¹æ“ä½œå®Œæˆã€‚</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;0..3&#125; ; do scp -p .ssh/id_rsa .ssh/authorized_keys node$i:/root/.ssh/; done</span></div></pre></td></tr></table></figure><h3 id="å®‰è£…MHA"><a href="#å®‰è£…MHA" class="headerlink" title="å®‰è£…MHA"></a>å®‰è£…MHA</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">node0 <span class="comment"># yum install  mha4mysql-manager-0.56-0.el6.noarch.rpm mha4mysql-node-0.56-0.el6.noarch.rpm</span></div><div class="line">      <span class="comment">#  for i in &#123;1..3&#125;; do scp mha4mysql-node-0.56-0.el6.noarch.rpm node$i:/root/ ; done</span></div><div class="line">node(1,2,3) <span class="comment"># yum -y install  mha4mysql-node-0.56-0.el6.noarch.rpm    </span></div><div class="line">    [root@node0 ~]<span class="comment"># rpm -ql mha4mysql-manager</span></div><div class="line">    /usr/bin/masterha_check_repl</div><div class="line">    /usr/bin/masterha_check_ssh</div><div class="line">    /usr/bin/masterha_check_status</div><div class="line">    /usr/bin/masterha_conf_host</div><div class="line">    /usr/bin/masterha_manager</div><div class="line">    /usr/bin/masterha_master_monitor</div><div class="line">    /usr/bin/masterha_master_switch</div><div class="line">    /usr/bin/masterha_secondary_check</div><div class="line">    /usr/bin/masterha_stop                ä»¥ä¸Šä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå°±æ˜¯ä¸Šé¢æ‰€åˆ—å‡ºçš„å‘½ä»¤</div><div class="line">    /usr/share/man/man1/masterha_check_repl.1.gz</div><div class="line">    /usr/share/man/man1/masterha_check_ssh.1.gz</div><div class="line">    /usr/share/man/man1/masterha_check_status.1.gz</div><div class="line">    /usr/share/man/man1/masterha_conf_host.1.gz</div><div class="line">    /usr/share/man/man1/masterha_manager.1.gz</div><div class="line">    /usr/share/man/man1/masterha_master_monitor.1.gz</div><div class="line">    /usr/share/man/man1/masterha_master_switch.1.gz</div><div class="line">    /usr/share/man/man1/masterha_secondary_check.1.gz</div><div class="line">    /usr/share/man/man1/masterha_stop.1.gz</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/Config.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/DBHelper.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/FileStatus.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerAdmin.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerAdminWrapper.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerConst.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/MasterFailover.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/MasterRotate.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/SSHCheck.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/Server.pm</div><div class="line">    /usr/share/perl5/vendor_perl/MHA/ServerManager.pm</div></pre></td></tr></table></figure><pre><code>ManagerèŠ‚ç‚¹éœ€è¦ä¸ºæ¯ä¸ªç›‘æ§çš„master/slaveé›†ç¾¤æä¾›ä¸€ä¸ªä¸“ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œè€Œæ‰€æœ‰çš„master/salveé›†ç¾¤ä¹Ÿå¯å…±äº«å…¨å±€é…ç½®ã€‚å…¨å±€é…ç½®æ–‡ä»¶é»˜è®¤ä¸º/etc/masterha_default.cnf,å…¶ä¸ºå¯å…ˆé…ç½®ã€‚å¦‚æœä»…ç›‘æ§ä¸€ç»„ master/slaveé›†ç¾¤ï¼Œä¹Ÿå¯ç›´æ¥é€šè¿‡applicationçš„é…ç½®æä¾›å„æœåŠ¡å™¨çš„é»˜è®¤é…ç½®ä¿¡æ¯ã€‚è€Œæ¯ä¸ªapplicationçš„é…ç½®æ–‡ä»¶è·¯å¾„ä¸ºè‡ªå®šä¹‰ï¼Œæœ¬ç¤ºä¾‹å°†ä½¿ç”¨/etc/masterha/appl.cnf  </code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/masterha/appl.cnf</span></div><div class="line">  [server default]</div><div class="line">  user=rjrj</div><div class="line">  password=centos.123</div><div class="line">  manager_workdir=/data/masterha/app1</div><div class="line">  manager_log=/data/masterha/app1/manager.log</div><div class="line">  remote_workdir=/data/masterha/app1</div><div class="line">  ssh_user=root</div><div class="line">  repl_user=rjrj</div><div class="line">  repl_password=centos.123</div><div class="line">  ping_interval=1</div><div class="line"></div><div class="line">  [server1]</div><div class="line">  hostname=172.16.23.11</div><div class="line">  candidate_master=1</div><div class="line"></div><div class="line">  [server2]</div><div class="line">  hostname=172.16.23.12</div><div class="line">  candidate_master=1</div><div class="line"></div><div class="line">  [server3]</div><div class="line">  hostname=172.16.23.13</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@node0 ~]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf</span></div><div class="line">Tue Feb 21 23:13:48 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Tue Feb 21 23:13:48 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</div><div class="line">Tue Feb 21 23:13:48 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</div><div class="line">Tue Feb 21 23:13:48 2017 - [info] Starting SSH connection tests..</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]</div><div class="line">Tue Feb 21 23:13:48 2017 - [debug]  Connecting via SSH from root@172.16.23.11(172.16.23.11:22) to root@172.16.23.12(172.16.23.12:22)..</div><div class="line">Tue Feb 21 23:13:48 2017 - [debug]   ok.</div><div class="line">Tue Feb 21 23:13:48 2017 - [debug]  Connecting via SSH from root@172.16.23.11(172.16.23.11:22) to root@172.16.23.13(172.16.23.13:22)..</div><div class="line">Tue Feb 21 23:13:48 2017 - [debug]   ok.</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]</div><div class="line">Tue Feb 21 23:13:48 2017 - [debug]  Connecting via SSH from root@172.16.23.12(172.16.23.12:22) to root@172.16.23.11(172.16.23.11:22)..</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]   ok.</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]  Connecting via SSH from root@172.16.23.12(172.16.23.12:22) to root@172.16.23.13(172.16.23.13:22)..</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]   ok.</div><div class="line">Tue Feb 21 23:13:50 2017 - [debug]</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]  Connecting via SSH from root@172.16.23.13(172.16.23.13:22) to root@172.16.23.11(172.16.23.11:22)..</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]   ok.</div><div class="line">Tue Feb 21 23:13:49 2017 - [debug]  Connecting via SSH from root@172.16.23.13(172.16.23.13:22) to root@172.16.23.12(172.16.23.12:22)..</div><div class="line">Tue Feb 21 23:13:50 2017 - [debug]   ok.</div><div class="line">Tue Feb 21 23:13:50 2017 - [info] All SSH connection tests passed successfully.</div></pre></td></tr></table></figure><p> æœ€åæ˜¾ç¤ºä¸ºsuccessfullyè¡¨ç¤ºå·²ç»æˆåŠŸäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">[root@node0 ~]<span class="comment"># masterha_check_repl --conf=/etc/masterha/app1.cnf</span></div><div class="line">Wed Feb 22 10:18:40 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed Feb 22 10:18:40 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Feb 22 10:18:40 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</div><div class="line">Wed Feb 22 10:18:40 2017 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] GTID failover mode = 0</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Dead Servers:</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Alive Servers:</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.11(172.16.23.11:3306)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.12(172.16.23.12:3306)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.13(172.16.23.13:3306)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Alive Slaves:</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.12(172.16.23.12:3306)  Version=5.5.44-MariaDB-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]     Replicating from 172.16.23.11(172.16.23.11:3306)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]   172.16.23.13(172.16.23.13:3306)  Version=5.5.44-MariaDB-log (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]     Replicating from 172.16.23.11(172.16.23.11:3306)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Current Alive Master: 172.16.23.11(172.16.23.11:3306)</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Checking slave configurations..</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Checking replication filtering settings..</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]  binlog_do_db= , binlog_ignore_db=</div><div class="line">Wed Feb 22 10:18:41 2017 - [info]  Replication filtering check ok.</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] GTID (with auto-pos) is not supported</div><div class="line">Wed Feb 22 10:18:41 2017 - [info] Starting SSH connection tests..</div><div class="line">Wed Feb 22 10:18:43 2017 - [info] All SSH connection tests passed successfully.</div><div class="line">Wed Feb 22 10:18:43 2017 - [info] Checking MHA Node version..</div><div class="line">Wed Feb 22 10:18:48 2017 - [info]  Version check ok.</div><div class="line">Wed Feb 22 10:18:48 2017 - [info] Checking SSH publickey authentication settings on the current master..</div><div class="line">Wed Feb 22 10:18:48 2017 - [info] HealthCheck: SSH to 172.16.23.11 is reachable.</div><div class="line">Wed Feb 22 10:18:49 2017 - [info] Master MHA Node version is 0.56.</div><div class="line">Wed Feb 22 10:18:49 2017 - [info] Checking recovery script configurations on 172.16.23.11(172.16.23.11:3306)..</div><div class="line">Wed Feb 22 10:18:49 2017 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/var/lib/mysql,/var/<span class="built_in">log</span>/mysql --output_file=/data/masterha/app1/save_binary_logs_test --manager_version=0.56 --start_file=<span class="built_in">log</span>-bin.000003</div><div class="line">Wed Feb 22 10:18:49 2017 - [info]   Connecting to root@172.16.23.11(172.16.23.11:22)..</div><div class="line">  Creating /data/masterha/app1 <span class="keyword">if</span> not exists.. Creating directory /data/masterha/app1.. <span class="keyword">done</span>.</div><div class="line">   ok.</div><div class="line">  Checking output directory is accessible or not..</div><div class="line">   ok.</div><div class="line">  Binlog found at /var/lib/mysql, up to <span class="built_in">log</span>-bin.000003</div><div class="line">Wed Feb 22 10:18:50 2017 - [info] Binlog setting check <span class="keyword">done</span>.</div><div class="line">Wed Feb 22 10:18:50 2017 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</div><div class="line">Wed Feb 22 10:18:50 2017 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">'rjyy'</span> --slave_host=172.16.23.12 --slave_ip=172.16.23.12 --slave_port=3306 --workdir=/data/masterha/app1 --target_version=5.5.44-MariaDB-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</div><div class="line">Wed Feb 22 10:18:50 2017 - [info]   Connecting to root@172.16.23.12(172.16.23.12:22)..</div><div class="line">Creating directory /data/masterha/app1.. <span class="keyword">done</span>.</div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</div><div class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to relay-bin.000009</div><div class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/relay-bin.000009</div><div class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</div><div class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</div><div class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</div><div class="line">Wed Feb 22 10:18:51 2017 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">'rjyy'</span> --slave_host=172.16.23.13 --slave_ip=172.16.23.13 --slave_port=3306 --workdir=/data/masterha/app1 --target_version=5.5.44-MariaDB-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</div><div class="line">Wed Feb 22 10:18:51 2017 - [info]   Connecting to root@172.16.23.13(172.16.23.13:22)..</div><div class="line">Creating directory /data/masterha/app1.. <span class="keyword">done</span>.</div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</div><div class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to relay-bin.000007</div><div class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/relay-bin.000007</div><div class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</div><div class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</div><div class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</div><div class="line">Wed Feb 22 10:18:52 2017 - [info] Slaves settings check <span class="keyword">done</span>.</div><div class="line">Wed Feb 22 10:18:52 2017 - [info]</div><div class="line">172.16.23.11(172.16.23.11:3306) (current master)</div><div class="line"> +--172.16.23.12(172.16.23.12:3306)</div><div class="line"> +--172.16.23.13(172.16.23.13:3306)</div><div class="line"></div><div class="line">Wed Feb 22 10:18:52 2017 - [info] Checking replication health on 172.16.23.12..</div><div class="line">Wed Feb 22 10:18:52 2017 - [info]  ok.</div><div class="line">Wed Feb 22 10:18:52 2017 - [info] Checking replication health on 172.16.23.13..</div><div class="line">Wed Feb 22 10:18:52 2017 - [info]  ok.</div><div class="line">Wed Feb 22 10:18:52 2017 - [warning] master_ip_failover_script is not defined.</div><div class="line">Wed Feb 22 10:18:52 2017 - [warning] shutdown_script is not defined.</div><div class="line">Wed Feb 22 10:18:52 2017 - [info] Got <span class="built_in">exit</span> code 0 (Not master dead).</div><div class="line"></div><div class="line">MySQL Replication Health is OK.</div></pre></td></tr></table></figure><pre><code>æ£€æŸ¥ç®¡ç†çš„MySQLå¤åˆ¶é›†ç¾¤çš„è¿æ¥é…ç½®å‚æ•°æ˜¯æ­£å¸¸çš„ï¼›</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &gt; /data/master/app1/manager.log 2&gt;&amp;1 &amp; </span></div><div class="line">Â Â  <span class="comment">#Â è®©masterha_managerè¿›ç¨‹å·¥ä½œäºåå°</span></div></pre></td></tr></table></figure><h2 id="å››ã€å¼€å§‹æµ‹è¯•"><a href="#å››ã€å¼€å§‹æµ‹è¯•" class="headerlink" title="å››ã€å¼€å§‹æµ‹è¯•"></a>å››ã€å¼€å§‹æµ‹è¯•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># systemctl stop mariadb # è®©ä¸»æœåŠ¡å™¨åœæ‰ï¼›</span></div><div class="line">[root@node2 ~]<span class="comment"># mysql</span></div><div class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</div><div class="line">Your MariaDB connection id is 50</div><div class="line">Server version: 5.5.44-MariaDB-log MariaDB Server</div><div class="line"></div><div class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</div><div class="line">+-------------------+----------+--------------+------------------+</div><div class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+-------------------+----------+--------------+------------------+</div><div class="line">| master-bin.000005 |      245 |              |                  |</div><div class="line">+-------------------+----------+--------------+------------------+</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</div><div class="line">Empty <span class="built_in">set</span> (0.00 sec)</div><div class="line"></div><div class="line">ERROR: No query specified</div></pre></td></tr></table></figure><p>  æ­¤æ—¶node2è¢«æå‡ä¸ºä¸»æœåŠ¡å™¨ ,node3æ‹‰å–æ•°æ®èµ°å‘node2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">[11:12:41root@node3~]<span class="comment">#mysql</span></div><div class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</div><div class="line">Your MariaDB connection id is 33</div><div class="line">Server version: 5.5.44-MariaDB-log MariaDB Server</div><div class="line"></div><div class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</div><div class="line">                  Master_Host: 172.16.23.12</div><div class="line">                  Master_User: rj</div><div class="line">                  Master_Port: 3306</div><div class="line">                Connect_Retry: 60</div><div class="line">              Master_Log_File: master-bin.000008</div><div class="line">          Read_Master_Log_Pos: 245</div><div class="line">               Relay_Log_File: relay-bin.000002</div><div class="line">                Relay_Log_Pos: 530</div><div class="line">        Relay_Master_Log_File: master-bin.000008</div><div class="line">             Slave_IO_Running: Yes</div><div class="line">            Slave_SQL_Running: Yes</div><div class="line">              Replicate_Do_DB:</div><div class="line">          Replicate_Ignore_DB:</div><div class="line">           Replicate_Do_Table:</div><div class="line">       Replicate_Ignore_Table:</div><div class="line">      Replicate_Wild_Do_Table:</div><div class="line">  Replicate_Wild_Ignore_Table:</div><div class="line">                   Last_Errno: 0</div><div class="line">                   Last_Error:</div><div class="line">                 Skip_Counter: 0</div><div class="line">          Exec_Master_Log_Pos: 245</div><div class="line">              Relay_Log_Space: 818</div><div class="line">              Until_Condition: None</div><div class="line">               Until_Log_File:</div><div class="line">                Until_Log_Pos: 0</div><div class="line">           Master_SSL_Allowed: No</div><div class="line">           Master_SSL_CA_File:</div><div class="line">           Master_SSL_CA_Path:</div><div class="line">              Master_SSL_Cert:</div><div class="line">            Master_SSL_Cipher:</div><div class="line">               Master_SSL_Key:</div><div class="line">        Seconds_Behind_Master: 0</div><div class="line">Master_SSL_Verify_Server_Cert: No</div><div class="line">                Last_IO_Errno: 0</div><div class="line">                Last_IO_Error:</div><div class="line">               Last_SQL_Errno: 0</div><div class="line">               Last_SQL_Error:</div><div class="line">  Replicate_Ignore_Server_Ids:</div><div class="line">             Master_Server_Id: 2</div><div class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CentOS 7 ELK(Elasticsearch Logstash Kibana) æ­å»º</title>
      <link href="/2018/01/30/CentOS-7-ELK-Elasticsearch-Logstash-Kibana-%E6%90%AD%E5%BB%BA/"/>
      <url>/2018/01/30/CentOS-7-ELK-Elasticsearch-Logstash-Kibana-%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<h1 id="CentOS-7-ELK-Elasticsearch-Logstash-Kibana-æ­å»º"><a href="#CentOS-7-ELK-Elasticsearch-Logstash-Kibana-æ­å»º" class="headerlink" title="CentOS 7 ELK(Elasticsearch Logstash Kibana) æ­å»º"></a>CentOS 7 ELK(Elasticsearch Logstash Kibana) æ­å»º</h1><blockquote><p>ä¸ç®¡æ˜¯ç”¨äºè®°å½•ï¼Œç›‘æ§æˆ–è€…ç¨‹åºçš„Debugï¼Œæ—¥å¿—ï¼Œå¯¹äºä»»ä½•ç³»ç»Ÿæ¥è¯´éƒ½æ˜¯ä¸€ä¸ªåŠå…¶é‡è¦çš„éƒ¨åˆ†;<br>ä½†ä¸€èˆ¬æ—¥å¿—çš„æ•°æ®é‡ä¼šæ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”åˆ†æ•£åœ¨å„ä¸ªåœ°æ–¹ã€‚å¦‚æœç®¡ç†çš„æœåŠ¡å™¨æˆ–è€…ç¨‹åºæ¯”è¾ƒå°‘çš„æƒ…å†µ;<br>æˆ‘ä»¬è¿˜å¯ä»¥é€ä¸€ç™»å½•åˆ°å„ä¸ªæœåŠ¡å™¨å»æŸ¥çœ‹ï¼Œåˆ†æã€‚ä½†å¦‚æœæœåŠ¡å™¨æˆ–è€…ç¨‹åºçš„æ•°é‡æ¯”è¾ƒå¤šäº†;<br>ä¹‹åè¿™ç§æ–¹æ³•å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚åŸºäºæ­¤ï¼Œä¸€äº›é›†ä¸­å¼çš„æ—¥å¿—ç³»ç»Ÿä¹Ÿå°±åº”ç”¨è€Œç”Ÿ;<br>ç›®å‰æ¯”è¾ƒæœ‰åæˆç†Ÿçš„æœ‰ï¼ŒSentryã€Splunk(å•†ä¸š)ã€FaceBook çš„Scribeã€Apache çš„ Chukwa;<br>Cloudera çš„ Fluentdã€è¿˜æœ‰ELK ç­‰ç­‰;  </p></blockquote><h1 id="Sentry-ä¸-ELKçš„å¯¹æ¯”"><a href="#Sentry-ä¸-ELKçš„å¯¹æ¯”" class="headerlink" title="Sentry ä¸ ELKçš„å¯¹æ¯”"></a>Sentry ä¸ ELKçš„å¯¹æ¯”</h1><p>1ã€ sentry  </p><blockquote><p>sentry æ˜¯ç”±pythonå¼€å‘ä¸”å¼€æºçš„æ—¥å¿—å­˜å‚¨å·¥å…·ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œæ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢ï¼Œé€‚åˆå°‘é‡æ—¥å¿—å­˜å‚¨;<br>php pythonç­‰ç¨‹åºå¯ä»¥ç›´æ¥è°ƒç”¨sentry url å°†æ—¥å¿—å†™å…¥ï¼Œä¸æ”¯æŒsentryä¸»åŠ¨å»é¢å¤–çš„æ”¶é›†æ—¥å¿—;<br>ä¸æ”¯æŒåˆ†å¸ƒå¼ä¸æ¨ªå‘æ‰©å±•;<br>åªèƒ½æŸ¥æ‰¾é”™è¯¯æ—¥å¿—ï¼Œä¸æ”¯æŒå…¨å±€æœç´¢;<br>ä¸€èˆ¬è¿è¡Œåœ¨dockerä¸­ï¼Œéƒ¨ç½²æ–¹ä¾¿ã€‚å‡ºç°é—®é¢˜æ’æŸ¥è´¹åŠ²;<br>æœ€åº•é…ç½®1æ ¸1G;</p></blockquote><p>2ã€ ELK </p><blockquote><p>ELKå³(Elasticsearch[æœç´¢å¼•æ“]ï¼ŒLogstash[æ—¥å¿—æ”¶é›†]ï¼ŒKibana [å®¢æˆ·ç«¯æ¥å…¥çš„webå¹³å°]);<br>ELK æ˜¯ç”±JAVAå¼€å‘ä¸”å¼€æºçš„æ—¥å¿—å­˜å‚¨å¥—ä»¶ï¼Œå ç”¨å†…å­˜è¾ƒå¤§ï¼Œæ‰§è¡Œé€Ÿåº¦è¾ƒå¿«ï¼Œé€‚åˆå¤§é‡å¿—æ—¥å¿—é«˜å¹¶å‘å­˜å‚¨;<br>æ”¯æŒåˆ†å­˜å¼ä¸æ¨ªå‘æ‰©å±•;<br>æ”¯æŒå…¨å±€æœç´¢ï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æœç´¢ï¼Œæ”¯æŒå›¾å½¢ç»Ÿè®¡, æ”¯æŒæ—¥å¿—jsonã€è¡¨æ ¼å½¢å¼;<br>ä¸€èˆ¬è¿è¡Œåœ¨ç³»ç»Ÿå±‚é¢ï¼Œéƒ¨ç½²è´¹åŠ²ã€‚å‡ºç°é—®é¢˜æ˜“äºæ‹†åˆ†ï¼Œæ’æŸ¥;<br>æœ€åº•é…ç½®2æ ¸4G;</p></blockquote><p><img src="/images/elk.png" alt=""></p><h1 id="æ­¤æ¬¡éƒ¨ç½²è¿‡ç¨‹"><a href="#æ­¤æ¬¡éƒ¨ç½²è¿‡ç¨‹" class="headerlink" title="æ­¤æ¬¡éƒ¨ç½²è¿‡ç¨‹"></a>æ­¤æ¬¡éƒ¨ç½²è¿‡ç¨‹</h1><ul><li>æ³¨: äºŒè¿›åˆ¶åŒ…Elasticsearch ä¸èƒ½ç”¨rootç”¨æˆ·å¯åŠ¨æœåŠ¡ </li></ul><h2 id="JDK-8-çš„å®‰è£…ä¸é…ç½®"><a href="#JDK-8-çš„å®‰è£…ä¸é…ç½®" class="headerlink" title="JDK 8 çš„å®‰è£…ä¸é…ç½®"></a>JDK 8 çš„å®‰è£…ä¸é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># useradd  elasticsearch</span></div><div class="line"><span class="comment"># passwd elasticsearch</span></div><div class="line"><span class="comment"># vim /etc/profile #åœ¨æœ€ååŠ å…¥ä»¥ä¸‹å†…å®¹ </span></div><div class="line"><span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64</div><div class="line"><span class="built_in">export</span> JRE_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre</div><div class="line"><span class="built_in">export</span> PATH=/usr/share/logstash/bin/:<span class="variable">$PATH</span></div><div class="line"></div><div class="line"><span class="comment"># source /etc/profile </span></div><div class="line"><span class="comment"># yum -y install yum -y install java</span></div><div class="line">[root@iz8vbap8o8nj8n6yoc05n6z logstash-5.3.0]<span class="comment"># java -version</span></div><div class="line">openjdk version <span class="string">"1.8.0_161"</span></div><div class="line">OpenJDK Runtime Environment (build 1.8.0_161-b14)</div><div class="line">OpenJDK 64-Bit Server VM (build 25.161-b14, mixed mode)</div><div class="line">[root@iz8vbap8o8nj8n6yoc05n6z logstash-5.3.0]<span class="comment"># echo $JAVA_HOME </span></div><div class="line">/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64</div></pre></td></tr></table></figure><h2 id="ElasticSearch-å®‰è£…ä¸é…ç½®"><a href="#ElasticSearch-å®‰è£…ä¸é…ç½®" class="headerlink" title="ElasticSearch å®‰è£…ä¸é…ç½®"></a>ElasticSearch å®‰è£…ä¸é…ç½®</h2><p>1ã€å®‰è£… ElasticSearch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.3.0.zip</span></div><div class="line"></div><div class="line"><span class="comment"># unzip elasticsearch-5.3.0.zip</span></div><div class="line"><span class="comment"># mv elasticsearch-5.3.0 /usr/local/</span></div><div class="line"><span class="comment"># chown elasticsearch.elasticsearch /usr/local/elasticsearch-5.3.0/ -R</span></div><div class="line"><span class="comment"># vim /usr/local/elasticsearch-5.3.0/config/elasticsearch.yml #å¯ç”¨å˜æ›´ä»¥ä¸‹é…ç½®</span></div><div class="line"></div><div class="line">cluster.name: transfereasy-elk</div><div class="line">node.master: <span class="literal">true</span></div><div class="line">node.data: <span class="literal">true</span></div><div class="line">path.data: /data/elasticData</div><div class="line"></div><div class="line">path.logs: /data/logs</div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div></pre></td></tr></table></figure><p>2ã€å®‰è£…x-packæ’ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /usr/local/elasticsearch-5.3.0/bin/elasticsearch-plugin  install x-pack</span></div></pre></td></tr></table></figure><p>3ã€å¯åŠ¨ ElasticSearch </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># su - elasticsearch </span></div><div class="line">$ /usr/<span class="built_in">local</span>/elasticsearch-5.3.0/bin/elasticsearch -d</div><div class="line">$ <span class="built_in">exit</span> </div><div class="line"></div><div class="line"><span class="comment"># æœåŠ¡å¯åŠ¨éªŒè¯</span></div><div class="line"><span class="comment"># netstat -tnlup | egrep "9200|9300"</span></div><div class="line">tcp        0      0 0.0.0.0:9200            0.0.0.0:*               LISTEN      14459/java          </div><div class="line">tcp        0      0 0.0.0.0:9300            0.0.0.0:*               LISTEN      14459/java</div></pre></td></tr></table></figure><p>4ã€api éªŒè¯ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl http://localhost:9200 -u elastic</span></div><div class="line"><span class="comment"># é»˜è®¤ç”¨æˆ· elastic é»˜è®¤å¯†ç :changeme</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span> : <span class="string">"RXHIrkw"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ssjinyao-elk"</span>,</div><div class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"xxxxxxxxxxxxxxxxxx"</span>,</div><div class="line">  <span class="string">"version"</span> : &#123;</div><div class="line">    <span class="string">"number"</span> : <span class="string">"5.3.0"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"3adb13b"</span>,</div><div class="line">    <span class="string">"build_date"</span> : <span class="string">"2017-03-23T03:31:50.652Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.4.1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>5ã€æ·»åŠ å¼€æœºå¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/elasticsearch-5.3.0/bin/elasticsearch -d"</span> &gt; /etc/rc.local</div></pre></td></tr></table></figure><p>6ã€é—®é¢˜è§£å†³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">aã€can not run elasticsearch as root <span class="comment"># éœ€æ–°å»ºå¯åŠ¨ElasticSearchçš„ç”¨æˆ·</span></div><div class="line">bã€max file descriptors [65535] <span class="keyword">for</span> elasticsearch process is too low, increase to at least [65536]</div><div class="line"><span class="comment"># vim /etc/sercurity/limits.conf</span></div><div class="line">* soft nofile 655350</div><div class="line">* hard nofile 655350</div><div class="line">$ su - elasticsearch <span class="comment"># å†æ¬¡åˆå¯¹æ˜¯å¦å¯ä»¥æ‰“å¼€655350ä¸ªæ–‡ä»¶ </span></div><div class="line">cã€max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144] </div><div class="line"><span class="comment"># vim /etc/sysctl.conf æ·»åŠ ä»¥ä¸‹å†…å®¹</span></div><div class="line">vm.max_map_count=655300</div><div class="line"><span class="comment"># sysctl -p</span></div></pre></td></tr></table></figure><h2 id="Kibanaçš„å®‰è£…ä¸é…ç½®"><a href="#Kibanaçš„å®‰è£…ä¸é…ç½®" class="headerlink" title="Kibanaçš„å®‰è£…ä¸é…ç½®"></a>Kibanaçš„å®‰è£…ä¸é…ç½®</h2><p>1ã€ å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/kibana/kibana-5.3.0-linux-x86_64.tar.gz </span></div><div class="line"><span class="comment"># tar -zxf kibana-5.3.0-linux-x86_64.tar.gz</span></div><div class="line"><span class="comment"># mv kibana-5.3.0-linux-x86_64 /usr/local/</span></div><div class="line"><span class="comment"># chown elasticsearch.elasticsearch /usr/local/kibana-5.3.0-linux-x86_64/ -R</span></div><div class="line"><span class="comment"># cd /usr/local/kibana-5.3.0-linux-x86_64/</span></div><div class="line"><span class="comment"># bin/kibana-plugin  install x-pack</span></div></pre></td></tr></table></figure><p>2ã€ é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /usr/local/kibana-5.3.0-linux-x86_64/config/kibana.yml  # å˜æ›´ä»¥ä¸‹é…ç½®</span></div><div class="line">elasticsearch.url: <span class="string">"http://localhost:9200"</span></div><div class="line"></div><div class="line"><span class="comment"># su - elasticsearch</span></div><div class="line">$ nohup /usr/<span class="built_in">local</span>/kibana-5.3.0-linux-x86_64/bin/kibana &amp;</div><div class="line"><span class="comment"># exit </span></div><div class="line"><span class="comment"># netstat  -tnlup | grep 5601</span></div><div class="line">tcp        0      0 127.0.0.1:5601          0.0.0.0:*               LISTEN      14132/node</div></pre></td></tr></table></figure><h2 id="Nginx-çš„å®‰è£…ä¸é…ç½®"><a href="#Nginx-çš„å®‰è£…ä¸é…ç½®" class="headerlink" title="Nginx çš„å®‰è£…ä¸é…ç½®"></a>Nginx çš„å®‰è£…ä¸é…ç½®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum install nginx -y </span></div><div class="line"><span class="comment"># nginx -t </span></div><div class="line"><span class="comment"># vim /etc/nginx/conf.d/kibana.conf</span></div><div class="line">server &#123;</div><div class="line">    listen       80 default_server;</div><div class="line">    listen       [::]:80 default_server;</div><div class="line">    server_name _;</div><div class="line">    location / &#123;</div><div class="line">        proxy_pass http://127.0.0.1:5601;</div><div class="line">        proxy_http_version 1.1;</div><div class="line">        proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</div><div class="line">        proxy_set_header Connection <span class="string">'upgrade'</span>;</div><div class="line">        proxy_set_header Host <span class="variable">$host</span>;</div><div class="line">        proxy_cache_bypass <span class="variable">$http_upgrade</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"># vim /etc/nginx/nginx.conf  æ³¨é‡Šé»˜è®¤è™šæ‹Ÿä¸»æœº</span></div><div class="line"><span class="comment">#    server &#123;</span></div><div class="line"><span class="comment">#        listen       80 default_server;</span></div><div class="line"><span class="comment">#        listen       [::]:80 default_server;</span></div><div class="line"><span class="comment">#        server_name  _;</span></div><div class="line"><span class="comment">#        root         /usr/share/nginx/html;</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#        # Load configuration files for the default server block.</span></div><div class="line"><span class="comment">#        include /etc/nginx/default.d/*.conf;</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#        location / &#123;</span></div><div class="line"><span class="comment">#        &#125;</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#        error_page 404 /404.html;</span></div><div class="line"><span class="comment">#            location = /40x.html &#123;</span></div><div class="line"><span class="comment">#        &#125;</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#        error_page 500 502 503 504 /50x.html;</span></div><div class="line"><span class="comment">#            location = /50x.html &#123;</span></div><div class="line"><span class="comment">#        &#125;</span></div><div class="line"><span class="comment">#    &#125;</span></div><div class="line"></div><div class="line"><span class="comment"># nginx -t </span></div><div class="line"><span class="comment"># systemctl restart nginx</span></div></pre></td></tr></table></figure><p>æµè§ˆå™¨è®¿é—® <a href="http://xxx.ssjinyao.com/" target="_blank" rel="external">http://xxx.ssjinyao.com/</a></p><p><img src="/images/kibana.png" alt=""></p><h2 id="Logstash-çš„å®‰è£…ä¸é…ç½®"><a href="#Logstash-çš„å®‰è£…ä¸é…ç½®" class="headerlink" title="Logstash çš„å®‰è£…ä¸é…ç½®"></a>Logstash çš„å®‰è£…ä¸é…ç½®</h2><ul><li>æ³¨:ç”±äºlogstash-5.3çš„äºŒè¿›åˆ¶åŒ…æ— æ³•å®åˆ«ç³»ç»Ÿç¯å¢ƒPASHå˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œç”¨rpmåŒ…ï¼Œyumå®‰è£…  </li></ul><p>1ã€ ä¸‹è½½å¹¶å®‰è£…Logstash rpm åŒ… </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/logstash/logstash-6.1.2.rpm</span></div><div class="line"><span class="comment"># yum -y install logstash-6.1.2.rpm</span></div></pre></td></tr></table></figure><p>2ã€ é…ç½®Logstash æ”¶é›†è¿œç¨‹æ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim first-pipeline.conf</span></div><div class="line">input &#123;</div><div class="line">  udp &#123;</div><div class="line">    port =&gt; 5959</div><div class="line">    codec =&gt; json</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        match =&gt; &#123; <span class="string">"message"</span> =&gt; <span class="string">"%&#123;COMBINEDAPACHELOG&#125;"</span>&#125;</div><div class="line">    &#125;</div><div class="line">    geoip &#123;</div><div class="line">        <span class="built_in">source</span> =&gt; <span class="string">"clientip"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">    <span class="comment">#stdout &#123; codec =&gt; rubydebug &#125;</span></div><div class="line">    elasticsearch &#123;</div><div class="line">        hosts =&gt; [<span class="string">"127.0.0.1:9200"</span>]</div><div class="line">        user =&gt; <span class="string">"elastic"</span></div><div class="line">        password =&gt; <span class="string">"xxxxxxxxx"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"># logstash -f first-pipeline.conf --path.settings=/etc/logstash/ --config.reload.automatic &amp;</span></div></pre></td></tr></table></figure><h2 id="beats-çš„å®‰è£…ä¸é…ç½®"><a href="#beats-çš„å®‰è£…ä¸é…ç½®" class="headerlink" title="beats çš„å®‰è£…ä¸é…ç½®"></a>beats çš„å®‰è£…ä¸é…ç½®</h2><blockquote><p>Beatsæ˜¯ä½œä¸ºä»£ç†åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…çš„å¼€æºçš„ data shippersï¼Œèƒ½å°†å„ç§ä¸åŒç±»å‹çš„æ“ä½œæ•°æ®;<br>ï¼ˆå¦‚ï¼Œ wireDataã€LogFilesã€Metricsã€WinEventï¼‰ç›´æ¥å‘é€åˆ° Elasticsearch;<br>æˆ–è€…é€šè¿‡Logstashå°†å…¶å‘é€åˆ°Elasticsearchã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥è§£æå’Œè½¬æ¢æˆ‘ä»¬éœ€è¦æ”¶é›†çš„å„ç§æ•°æ®;  </p></blockquote><p>1ã€ å®‰è£… </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-5.3.1-x86_64.rpm</span></div><div class="line"><span class="comment"># yum -y install  metricbeat-5.3.1-x86_64.rpm</span></div></pre></td></tr></table></figure><p>2ã€ é…ç½® </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/metricbeat/metricbeat.yml</span></div><div class="line">metricbeat.modules:</div><div class="line">- module: system</div><div class="line">  metricsets:</div><div class="line">    - cpu</div><div class="line">    - load</div><div class="line">    - core</div><div class="line">    - diskio</div><div class="line">    - filesystem</div><div class="line">    - fsstat</div><div class="line">    - memory</div><div class="line">    - network</div><div class="line">    - process</div><div class="line">    - socket</div><div class="line">  enabled: <span class="literal">true</span></div><div class="line">  period: 10s</div><div class="line">  processes: [<span class="string">'.*'</span>]</div><div class="line">- module: nginx</div><div class="line">  metricsets: [<span class="string">"stubstatus"</span>]</div><div class="line">  enabled: <span class="literal">true</span></div><div class="line">  period: 10s</div><div class="line">  hosts: [<span class="string">"http://127.0.0.1"</span>]</div><div class="line">  server_status_path: <span class="string">"NginxStatus"</span></div><div class="line">output.elasticsearch:</div><div class="line">  hosts: [<span class="string">"127.0.0.1:9200"</span>]</div><div class="line">  username: <span class="string">"elastic"</span></div><div class="line">  password: <span class="string">"changeme"</span></div><div class="line">logging.level: debug</div><div class="line">output.elasticsearch:</div><div class="line">  hosts: [<span class="string">"localhost:9200"</span>]</div><div class="line"><span class="comment"># metricbeat.sh -c metricbeat.yml  -configtest</span></div><div class="line">Config OK</div></pre></td></tr></table></figure><h2 id="ç™»å½•æŸ¥è¯¢æ—¥å¿—"><a href="#ç™»å½•æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="ç™»å½•æŸ¥è¯¢æ—¥å¿—"></a>ç™»å½•æŸ¥è¯¢æ—¥å¿—</h2><p>1ã€ ç›¸çœ‹æ—¥å¿—æºipåŒºåŸŸåˆ†å¸ƒ</p><p><img src="/images/kibana_ditu.png" alt=""></p><p>2ã€ Nginx æ—¥å¿—æ ¼å¼å¦‚ä¸‹</p><p><img src="/images/kibana_nginx.png" alt=""></p><p>3ã€ ä½¿ç”¨æ­£åˆ™æœç´¢</p><p><img src="/images/kibana_zhengze.png" alt=""></p><p>4ã€ ç›´æ¥å†™å…¥Logstashçš„pythonæ—¥å¿—è¡¨æ ¼å¼</p><p><img src="/images/kibana_table.png" alt=""></p><p>5ã€ ç›´æ¥å†™å…¥Logstashçš„pythonæ—¥å¿—jsonæ ¼å¼</p><p><img src="/images/kibana_json.png" alt=""></p><h2 id="è¿œç¨‹æ—¥å¿—æ”¶é›†"><a href="#è¿œç¨‹æ—¥å¿—æ”¶é›†" class="headerlink" title="è¿œç¨‹æ—¥å¿—æ”¶é›†"></a>è¿œç¨‹æ—¥å¿—æ”¶é›†</h2><p>1ã€ filebeat çš„å®‰è£…  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$ curl -L -O https://download.elastic.co/beats/filebeat/filebeat_1.3.0_amd64.deb</div><div class="line">$ sudo dpkg -i filebeat_1.3.0_amd64.deb</div><div class="line">$ sudo vim /etc/filebeat/filebeat.yml </div><div class="line">filebeat:</div><div class="line">  prospectors:</div><div class="line">    -</div><div class="line">      paths:</div><div class="line">        - /var/log/nginx/*.log</div><div class="line">        - /var/log/cashier/logs/*.log</div><div class="line">        - /var/log/topen/logs/*.log</div><div class="line">        - /var/log/xbasement/logs/*log</div><div class="line">      input_type: log</div><div class="line">      document_type: nginx-access-testapi.transfereasy.com</div><div class="line">  registry_file: /var/lib/filebeat/registry</div><div class="line">output:</div><div class="line">  logstash:</div><div class="line">          hosts: [&quot;xxx.xx.xxx.xx:5959&quot;]</div><div class="line">shipper:</div><div class="line">logging:</div><div class="line">  files:</div></pre></td></tr></table></figure><p>2ã€ å°†æ•°æ®åŒæ­¥åˆ°elk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo /etc/init.d/filebeat start</div><div class="line">$ sudo /etc/init.d/filebeat status</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> rhca </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>python ä¹‹ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£(å››)</title>
      <link href="/2018/01/23/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E5%9B%9B/"/>
      <url>/2018/01/23/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E5%9B%9B/</url>
      <content type="html"><![CDATA[<h2 id="å®ç°å›¾æ–‡æ ¼å¼çš„æœåŠ¡å™¨æ€§èƒ½æŠ¥è¡¨é‚®ä»¶"><a href="#å®ç°å›¾æ–‡æ ¼å¼çš„æœåŠ¡å™¨æ€§èƒ½æŠ¥è¡¨é‚®ä»¶" class="headerlink" title="å®ç°å›¾æ–‡æ ¼å¼çš„æœåŠ¡å™¨æ€§èƒ½æŠ¥è¡¨é‚®ä»¶"></a>å®ç°å›¾æ–‡æ ¼å¼çš„æœåŠ¡å™¨æ€§èƒ½æŠ¥è¡¨é‚®ä»¶</h2><p>é€šè¿‡MIMEText ä¸ MIMEImageç±»çš„ç»„åˆï¼Œå®ç°å›¾æ–‡é‚®ä»¶æ ¼å¼ã€‚<br>å¦é€šè¿‡MIMETextç±»å†å®šä¹‰Content-Disposition å±æ€§æ¥å®ç°é™„ä»¶çš„é‚®ä»¶ã€‚<br>å¯ä»¥åˆ©ç”¨è¿™äº›ç‰¹æ€§æ¥å®šè´¨æœåŠ¡å™¨å‘¨æŠ¥ã€‚   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">âœ  test cat email_open.py </div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> smtplib</div><div class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart <span class="comment"># å¯¼å…¥MIMEMultipartç±» </span></div><div class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText <span class="comment"># å¯¼å…¥MIMETextç±» </span></div><div class="line"><span class="keyword">from</span> email.mime.image <span class="keyword">import</span> MIMEImage <span class="comment"># å¯¼å…¥MIMEImae ç±»</span></div><div class="line"></div><div class="line">HOST = <span class="string">"smtp.139.com"</span> <span class="comment"># å®šä¹‰é‚®ä»¶ stmp ä¸»æœº</span></div><div class="line">SUBJECT = <span class="string">u"ä¸šåŠ¡æ€§èƒ½æ•°æ®æŠ¥è¡¨"</span> <span class="comment"># å®šä¹‰é‚®ä»¶ä¸»é¢˜</span></div><div class="line">TO = <span class="string">"1922006891@qq.com"</span>  <span class="comment"># å®šä¹‰é‚®ä»¶æ”¶ä»¶äºº</span></div><div class="line">FROM = <span class="string">"15822097176@139.com"</span> <span class="comment"># å®šä¹‰é‚®ä»¶å‘ä»¶äºº</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">addimg</span><span class="params">(src,imgid)</span>:</span>  <span class="comment"># æ·»åŠ ç‰‡å‡½æ•°ï¼Œå‚æ•°1:å›¾ç‰‡è·¯å¾„,å‚æ•°2: å›¾ç‰‡id</span></div><div class="line">    fp = open(src, <span class="string">'rb'</span>) <span class="comment"># æ‰“å¼€æ–‡ä»¶</span></div><div class="line">    msgImage = MIMEImage(fp.read()) <span class="comment"># åˆ›å»ºMIMEImageå¯¹è±¡ï¼Œè¯»å–å›¾ç‰‡å†…å®¹å¹¶ä½œä¸ºå‚æ•°</span></div><div class="line">    fp.close() <span class="comment"># å…³é—­æ–‡ä»¶ </span></div><div class="line">    msgImage.add_header(<span class="string">'Content-ID'</span>, imgid) <span class="comment"># æŒ‡å®šå›¾ç‰‡æ–‡ä»¶çš„Content-ID,&lt;img&gt; æ ‡ç­¾srcç”¨åˆ°</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> msgImage <span class="comment"># è¿”å›msgImage å¯¹è±¡</span></div><div class="line"></div><div class="line">msg = MIMEMultipart(<span class="string">'related'</span>) <span class="comment"># åˆ›å»ºMIMEMultipartå¯¹è±¡ï¼Œé‡‡ç”¨relatedå®šä¹‰å†…åµŒèµ„æºçš„é‚®ä»¶ä½“</span></div><div class="line"><span class="comment">#åˆ›å»ºMIMETextå¯¹è±¡ï¼ŒHTMLå…ƒç´ åŒ…æ‹¬è¡¨æ ¼&lt;stable&gt;åŠå›¾ç‰‡&lt;img&gt;</span></div><div class="line">msgtext = MIMEText(<span class="string">""" </span></div><div class="line"><span class="string">&lt;table width="600" border="0"  cellspacing="0" cellpadding="4"&gt;</span></div><div class="line"><span class="string">      &lt;tr bgcolor="#CECFAD" height="20" style="font-size:14px"&gt;</span></div><div class="line"><span class="string">        &lt;td colspan=2&gt; * å®˜ç½‘æ€§èƒ½æ•°æ® &lt;a href="www.ssinyao.com"&gt; æ›´å¤š&gt;&gt; &lt;/a&gt;&lt;/td&gt;</span></div><div class="line"><span class="string">      &lt;/tr&gt;</span></div><div class="line"><span class="string">      &lt;tr bgcolor="#EFEBDE" height="100" style="font-size:13px"&gt;</span></div><div class="line"><span class="string">        &lt;td&gt;</span></div><div class="line"><span class="string">        &lt;img src="cid:systemload"&lt;/td&gt;&lt;td&gt;</span></div><div class="line"><span class="string">        &lt;img src="cid:cpu"&lt;td&gt;</span></div><div class="line"><span class="string">      &lt;/tr&gt;</span></div><div class="line"><span class="string">      &lt;tr bgcolor="#EFEBDE" height="100" sytle="font-size:13px"&gt;</span></div><div class="line"><span class="string">        &lt;td&gt;</span></div><div class="line"><span class="string">        &lt;img src="cid:eth0"&gt;&lt;/td&gt;&lt;td&gt;</span></div><div class="line"><span class="string">        &lt;img src="cid:eth1"&gt;&lt;/td&gt;</span></div><div class="line"><span class="string">      &lt;/tr&gt;</span></div><div class="line"><span class="string">    &lt;/table&gt;"""</span>, <span class="string">"html"</span>,<span class="string">"utf-8"</span>) <span class="comment">#&lt;img&gt; æ ‡ç­¾çš„srcå±æ€§æ˜¯é€šè¿‡Content-ID æ¥å¼•ç”¨çš„</span></div><div class="line"></div><div class="line">msg.attach(msgtext) </div><div class="line">msg.attach(addimg(<span class="string">"./systemload.png"</span>, <span class="string">"systemload"</span>)) </div><div class="line">msg.attach(addimg(<span class="string">"./cpu.png"</span>, <span class="string">"cpu"</span>)) </div><div class="line">msg.attach(addimg(<span class="string">"./eth0.png"</span>, <span class="string">"eth0"</span>)) </div><div class="line">msg.attach(addimg(<span class="string">"./eth1.png"</span>, <span class="string">"eth1"</span>)) </div><div class="line">msg[<span class="string">'Subject'</span>] = SUBJECT <span class="comment"># é‚®ä»¶ä¸»é¢˜</span></div><div class="line">msg[<span class="string">'From'</span>] = FROM <span class="comment"># é‚®ä»¶å‘é€äººï¼Œé‚®ä»¶å¤´éƒ¨å¯è§</span></div><div class="line">msg[<span class="string">'TO'</span>] = TO <span class="comment"># é‚®ä»¶æ”¶ä»¶äººï¼Œé‚®ä»¶å¤´éƒ¨å¯è§</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    server = smtplib.SMTP()  <span class="comment"># åˆ›å»ºä¸€ä¸ªSMTP()å¯¹è±¡ </span></div><div class="line">    server.connect(HOST, <span class="string">"25"</span>) <span class="comment"># é€šè¿‡connectæ–¹æ³•è¿æ¥smtpä¸»æœº</span></div><div class="line">    server.starttls() <span class="comment">#å¯åŠ¨å®‰å…¨ä¼ è¾“æ¨¡å¼</span></div><div class="line">    server.login(<span class="string">"15822097176@139.com"</span>,<span class="string">"xxxxxxxx"</span>) <span class="comment"># é‚®ç®±å¸å·ç™»å½•æ ¡éªŒ</span></div><div class="line">    server.sendmail(FROM, TO, msg.as_string()) <span class="comment">#é‚®ä»¶å‘é€ </span></div><div class="line">    server.quit() <span class="comment"># æ–­å¼€stmpè¿æ¥</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"é‚®ä»¶å‘é€æˆåŠŸ"</span></div><div class="line"><span class="keyword">except</span> Exception, e:</div><div class="line">    <span class="keyword">print</span> <span class="string">"å¤±è´¥:"</span> +str(e)</div><div class="line">âœ  test ./email_open.py </div><div class="line">é‚®ä»¶å‘é€æˆåŠŸ</div></pre></td></tr></table></figure><h2 id="å®ç°çš„åŠŸèƒ½å¦‚ä¸‹"><a href="#å®ç°çš„åŠŸèƒ½å¦‚ä¸‹" class="headerlink" title="å®ç°çš„åŠŸèƒ½å¦‚ä¸‹"></a>å®ç°çš„åŠŸèƒ½å¦‚ä¸‹</h2><p><img src="http://ssjinyao.oss-cn-beijing.aliyuncs.com/ssjinyao/hexo_file/message_table.png" alt="Alt text"></p><h2 id="åŒæ ·åŠŸèƒ½çš„å®ç°-muttrc-msmtp-å‘é€é‚®ä»¶"><a href="#åŒæ ·åŠŸèƒ½çš„å®ç°-muttrc-msmtp-å‘é€é‚®ä»¶" class="headerlink" title="åŒæ ·åŠŸèƒ½çš„å®ç° muttrc + msmtp å‘é€é‚®ä»¶"></a>åŒæ ·åŠŸèƒ½çš„å®ç° muttrc + msmtp å‘é€é‚®ä»¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># yum -y install msmtp mutt  </div><div class="line"></div><div class="line"># cat /etc/muttrc </div><div class="line">et sendmail=&quot;/usr/bin/msmtp&quot;</div><div class="line">set use_from=yes</div><div class="line">set realname=&quot;15822097176@139.com&quot;</div><div class="line">set editor=&quot;vim&quot;</div><div class="line"></div><div class="line"># cat /etc/msmtprc</div><div class="line">account default</div><div class="line">host smtp.139.com</div><div class="line">port 25</div><div class="line">from 15822097176@139.com</div><div class="line">auth login</div><div class="line">tls off</div><div class="line">user 15822097176@139.com</div><div class="line">password xxxxxxxx</div><div class="line"></div><div class="line"># echo &quot;test&quot; | mutt -s &quot;test&quot; -a /path/to/file</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>python ä¹‹ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£(ä¸‰)</title>
      <link href="/2018/01/22/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%B8%89/"/>
      <url>/2018/01/22/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%B8%89/</url>
      <content type="html"><![CDATA[<h2 id="DNSå¤„ç†æ¨¡å—dnspython"><a href="#DNSå¤„ç†æ¨¡å—dnspython" class="headerlink" title="DNSå¤„ç†æ¨¡å—dnspython"></a>DNSå¤„ç†æ¨¡å—dnspython</h2><blockquote><p>dnspython(<a href="https://www.dnspython.org/)æ˜¯Pythonå®ç°çš„ä¸€ä¸ªDNSå¼å…·åŒ…ï¼Œå®ƒæ”¯æŒå‡ ä¹æ‰€æœ‰çš„" target="_blank" rel="external">https://www.dnspython.org/)æ˜¯Pythonå®ç°çš„ä¸€ä¸ªDNSå¼å…·åŒ…ï¼Œå®ƒæ”¯æŒå‡ ä¹æ‰€æœ‰çš„</a><br>è®°å½•ç±»å‹ ï¼Œå¯ä»¥ç”¨äºæŸ¥è¯¢ã€ä¼ è¾“å¹¶åŠ¨æ€æ›´æ–°ZONEä¿¡æ¯ï¼Œ åŒæ—¶æ”¯æŒTSIG(äº‹åŠ¡ç­¾å)éªŒè¯æ¶ˆæ¯å’Œ<br>EDNS0(æ‰©å±•DNS)ã€‚åœ¨ç³»ç»Ÿç®¡ç†æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¶æŸ¥è¯¢åŠŸèƒ½æ¥å®ç°DNSæœåŠ¡ç›‘æ§ä»¥åŠè§£æ<br>ç»“æœçš„æ ¡éªŒï¼Œå¯ä»¥ä»£æ›¿nslookupåŠdigç­‰ï¼Œè½»æ¾åšåˆ°ä¸ç°æœ‰å¹³å°çš„æ•´åˆ</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># pip install dnspython </div><div class="line"># easy_install dnspython </div><div class="line"># wget http://www.dnspython.org/kits/1.9.4/dnspython-1.9.4.tar.gz</div><div class="line"># tar -zxvf dnspython-1.9.4.tar.gz</div><div class="line"># cd dnspython-1.9.4</div><div class="line"># python setuppy install</div></pre></td></tr></table></figure><h2 id="æ¨¡å—åŸŸåè§£ææ–¹æ³•è¯¦è§£"><a href="#æ¨¡å—åŸŸåè§£ææ–¹æ³•è¯¦è§£" class="headerlink" title="æ¨¡å—åŸŸåè§£ææ–¹æ³•è¯¦è§£"></a>æ¨¡å—åŸŸåè§£ææ–¹æ³•è¯¦è§£</h2><blockquote><p>dnspython æ¨¡å—æä¾›äº†å¤§é‡çš„DNSå¤„ç†æ–¹æ³•ï¼Œæœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯åŸŸåæŸ¥è¯¢ã€‚dnspythonæä¾›äº†ä¸€ä¸ª<br>DNSè§£æå™¨ç±»â€“resolverï¼Œä½¿ç”¨å®ƒçš„uqueryæ–¹æ³•æ¥å®ç°åŸŸåçš„æŸ¥è¯¢åŠŸèƒ½ã€‚queryæ–¹æ³•å®šä¹‰å¦‚ä¸‹;  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">query(self, qname, rdtype=<span class="number">1</span>, rdclass=<span class="number">1</span>, tcp=<span class="keyword">False</span>, source=<span class="keyword">None</span>, </div><div class="line">raise_on_no_answer=<span class="keyword">True</span>, source_port=<span class="number">0</span>)</div></pre></td></tr></table></figure><blockquote><p>å…¶ä¸­ï¼Œqnaeå‚æ•°ä¸ºæŸ¥è¯¢çš„åŸŸåã€‚rdtypeå‚æ•°ç”¨æ¥æŒ‡å®šRRèµ„æºçš„ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§:  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># A è®°å½•ï¼Œå°†ä¸»æœºåè½¬æ¢æˆIPåœ°å€:  </span></div><div class="line"><span class="comment"># MX è®°å½•ï¼Œé‚®ä»¶äº¤æ¢è®°å½•ï¼Œå®šä¹‰é‚®ä»¶æœåŠ¡å™¨çš„åŸŸåï¼› </span></div><div class="line"><span class="comment"># CNAMEè®°å½•ï¼ŒæŒ‡åˆ«åè®°å½•ï¼Œå®ç°åŸŸåé—´çš„æ˜ å°„; </span></div><div class="line"><span class="comment"># NSè®°å½•ï¼Œæ ‡è®°åŒºåŸŸçš„åŸŸåæœåŠ¡å™¨åŠæˆæƒå­åŸŸ; </span></div><div class="line"><span class="comment"># PTRè®°å½•ï¼Œåå‘è§£æï¼Œä¸Aè®°å½•ç›¸åï¼Œå°†IPè½¬æ¢æˆä¸»æœºå;   </span></div><div class="line"><span class="comment"># SOAè®°å½•ï¼ŒSOAæ ‡è®°ï¼Œä¸€ä¸ªèµ·å¦ˆæˆæƒåŒºçš„å®šä¹‰;</span></div></pre></td></tr></table></figure><blockquote><p>rdclasså‚æ•°ç”¨äºæŒ‡å®šç½‘ç»œç±»å‹ï¼Œå¯é€‰çš„å€¼æœ‰INã€CHä¸HSã€å…¶ä¸­INä¸ºé»˜è®¤ï¼Œä½¿ç”¨æœ€å¹¿æ³›;<br>tcpå‚æ•°ç”¨äºæŒ‡å®šæŸ¥è¯¢æ˜¯å¦å¯ç”¨TCPåè®®ï¼Œé»˜è®¤ä¸ºFalse(ä¸å¯ç”¨);<br>source ä¸source_port å‚æ•°ä½œä¸ºæŒ‡å®šæŸ¥è¯¢æºåœ°å€ä¸ç«¯å£;<br>é»˜è®¤å€¼ä¸ºæŸ¥è¯¢è®¾å¤‡IPåœ°å€å’Œ0ã€‚raise_on_no_answer;<br>å‚å½“ç”¨äºæŒ‡å®šå½“æŸ¥è¯¢æ— åº”ç­”æ—¶æ˜¯å¦è§¦å‘å¼‚å¸¸ã€‚é»˜è®¤ä¸ºTrue;  </p></blockquote><h2 id="å¸¸è§è§£æç±»å‹"><a href="#å¸¸è§è§£æç±»å‹" class="headerlink" title="å¸¸è§è§£æç±»å‹"></a>å¸¸è§è§£æç±»å‹</h2><blockquote><p>å¸¸è§çš„DNSè§£æç±»å‹åŒ…æ‹¬Aã€MXã€NSã€CNAMEç­‰ã€‚åˆ©ç”¨dnspythonå’Œdns.resolver.queryæ–¹æ³•<br>å¯ä»¥ç®€å•å®ç°è¿™äº›DNSç±»å‹çš„æŸ¥è¯¢ï¼Œä¸ºåé¢è¦å®ç°çš„åŠŸèƒ½æä¾›æ•°æ®æ¥æºï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªä½¿ç”¨DNSè½®å¾ª<br>ä¸šåŠ¡çš„åŸŸåè¿›è¡Œå¯ç”¨æ€§å¯ç”¨æ€§ï¼Œéœ€è¦å¾—åˆ°å½“å‰çš„è§£æç»“æœã€‚  </p></blockquote><p>1ã€å®ç°Aè®°å½•æŸ¥è¯¢æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">âœ  test cat dns_domain.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#from dns import resolver</span></div><div class="line"><span class="keyword">import</span> dns.resolver</div><div class="line">domain = raw_input(<span class="string">"Please input an domain: "</span>)  <span class="comment"># è¾“å…¥åŸŸååœ°å€</span></div><div class="line">A = dns.resolver.query(domain, <span class="string">'A'</span>) <span class="comment"># æŒ‡å®šæŸ¥è¯¢ç±»å‹ä¸ºAè®°å½• </span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> A.response.answer: <span class="comment"># é€šè¿‡ response.answer æ–¹æ³•è·å–æŸ¥è¯¢å›åº”ä¿¡æ¯</span></div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i.items: <span class="comment"># éå†å›åº”ä¿¡æ¯</span></div><div class="line">        <span class="keyword">print</span> j.address</div><div class="line">âœ  test ./dns_domain.py </div><div class="line">Please input an domain: www.ssjinyao.com</div><div class="line"><span class="number">47.94</span><span class="number">.3</span><span class="number">.76</span></div></pre></td></tr></table></figure><p>2ã€å®ç°MXè®°å½•æŸ¥è¯¢æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">âœ  test ./dns_mx.py</div><div class="line">Please input an domain: ^CTraceback (most recent call last):</div><div class="line">  File <span class="string">"./dns_mx.py"</span>, line <span class="number">4</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    domain = raw_input(<span class="string">"Please input an domain: "</span>)</div><div class="line">KeyboardInterrupt</div><div class="line">âœ  test cat ./dns_mx.py</div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> dns.resolver </div><div class="line">domain = raw_input(<span class="string">"Please input an domain: "</span>)</div><div class="line">MX = dns.resolver.query(domain, <span class="string">'MX'</span>)  <span class="comment"># æŒ‡å®šæŸ¥è¯¢ç±»å‹ä¸ºMXè®°å½•</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> MX: <span class="comment"># éå†å›åº”ç»“æœï¼Œè¾“å‡ºMXè®°å½•çš„preference åŠexchangerä¿¡æ¯</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'MX preference ='</span> , i.preference, <span class="string">'mail exchanger='</span> , i.exchange</div><div class="line">âœ  test ./dns_mx.py</div><div class="line">Please input an domain: <span class="number">139.</span>com</div><div class="line">MX preference = <span class="number">10</span> mail exchanger= mx2.mail<span class="number">.139</span>.com.</div><div class="line">MX preference = <span class="number">20</span> mail exchanger= mx3.mail<span class="number">.139</span>.com.</div><div class="line">MX preference = <span class="number">5</span> mail exchanger= mx1.mail<span class="number">.139</span>.com.</div></pre></td></tr></table></figure><p>3ã€ å®ç° NS è®°å½•æŸ¥è¯¢æ–¹æ³•æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">âœ  test cat dns_ns.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> dns.resolver </div><div class="line">domain = raw_input(<span class="string">'Please input an domain: '</span>)</div><div class="line">ns = dns.resolver.query(domain, <span class="string">'NS'</span>)  <span class="comment"># æŒ‡å®šæŸ¥è¯¢ç±»å‹ä¸ºNSè®°å½•</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ns.response.answer:</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i.items:</div><div class="line">        <span class="keyword">print</span> j.to_text()</div><div class="line">âœ  test ./dns_ns.py            </div><div class="line">Please input an domain: ssjinyao.com</div><div class="line">dns30.hichina.com.</div><div class="line">dns29.hichina.com.</div><div class="line">âœ  test ./dns_ns.py</div><div class="line">Please input an domain: baidu.com</div><div class="line">ns2.baidu.com.</div><div class="line">ns7.baidu.com.</div><div class="line">dns.baidu.com.</div><div class="line">ns3.baidu.com.</div><div class="line">ns4.baidu.com.</div></pre></td></tr></table></figure><p>4ã€ å®ç°CNAMEè®°å½•æŸ¥è¯¢æ–¹æ³• </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">âœ  test cat dns_cname.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> dns.resolver </div><div class="line">domain = raw_input(<span class="string">"Please input an domain: "</span>)</div><div class="line">cname = dns.resolver.query(domain, <span class="string">'CNAME'</span>) <span class="comment"># æŒ‡å®šæŸ¥è¯¢ç±»å‹ä¸ºCNAMEè®°å½•</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cname.response.answer:  <span class="comment"># ç»“æœå°†å›åº” cname åçš„ç›®æ ‡åŸŸå</span></div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i.items:</div><div class="line">        <span class="keyword">print</span> j.to_text()</div><div class="line">âœ  test ./dns_cname.py  </div><div class="line">Please input an domain: mail.ssjinyao.com</div><div class="line">mail.mxhichina.com.</div><div class="line">âœ  test ./dns_cname.py</div><div class="line">Please input an domain: ll.ssjinyao.com</div><div class="line">www.leleol.com.</div></pre></td></tr></table></figure><p>5ã€ DNSåŸŸåè½®å¾ªä¸šåŠ¡ç›‘æ§ </p><blockquote><p>å¤§éƒ¨åˆ†çš„DNSè§£æéƒ½æ˜¯ä¸€ä¸ªåŸŸåå¯¹åº”ä¸€ä¸ªIPåœ°å€ï¼Œä½†æ˜¯é€šè¿‡DNSè½®å¾ªå¯ä»¥åšåˆ°ä¸€ä¸ªåŸŸåå¯¹åº”å¤šä¸ªIP<br>ä»è€Œå®ç°æœ€ç®€å•ä¸”æœ€é«˜æ•ˆçš„è´Ÿè½½å‡è¡¡ï¼Œä¸è¿‡æ­¤æ–¹æ¡ˆæœ€å¤§çš„å¼Šç«¯æ˜¯ç›®æ ‡ä¸»æœºä¸å¯ä»¥ç”¨æ—¶ï¼Œæ— æ³•è¢«è‡ªåŠ¨<br>å‰”é™¤ï¼Œå› æ­¤åšå¥½ä¸šåŠ¡ä¸»æœºçš„æœåŠ¡å¯ç”¨ç›‘æ§æ˜¯è‡³å…³é‡è¦çš„ï¼Œé€šè¿‡åˆ†æå½“å‰åŸŸåçš„è§£æIP<br>å†ç»“åˆæœåŠ¡ç«¯å£æ¢æµ‹æ¥å®ç°è‡ªåŠ¨ç›‘æ§ï¼Œåœ¨åŸŸåè§£æä¸­æ·»åŠ ã€åˆ é™¤IPæ—¶æ— é¡»å¯¹ç›‘æ§è„šæœ¬è¿›è¡Œæ›´æ”¹  </p></blockquote><p>aã€ æ­¥éª¤ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®ç°å¯¹åŸŸåçš„è§£æï¼Œè·å–åŸŸå æ‰€æœ‰çš„Aè®°å½•è§£æIPåˆ—è¡¨; </span></div><div class="line"><span class="comment"># å¯¹IP åˆ—è¡¨è¿›è¡ŒHTTPçº§åˆ«çš„æ¢æµ‹;</span></div></pre></td></tr></table></figure><p>bã€ å®ç°æ‹“æ‰‘å›¾ </p><p><img src="/images/dnspython.png" alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> dns.resolver </div><div class="line"><span class="keyword">import</span> os </div><div class="line"><span class="keyword">import</span> httplib</div><div class="line"></div><div class="line">iplist = [] <span class="comment"># å®šä¹‰åŸŸåIPåˆ—è¡¨å˜é‡</span></div><div class="line">appdomain = <span class="string">"www.qqlilin.com"</span> <span class="comment"># å®šä¹‰ä¸šåŠ¡åŸŸå</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_iplist</span><span class="params">(domain=<span class="string">""</span>)</span>:</span> <span class="comment"># åŸŸåè§£æå‡½æ•°ï¼Œè§£ææˆåŠŸIPå°†è¢«è¿½åŠ åˆ°iplist</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        A = dns.resolver.query(domain, <span class="string">'A'</span>) <span class="comment"># è§£æAè®°å½•ç±»å‹</span></div><div class="line">    <span class="keyword">except</span> Exception, e:</div><div class="line">        <span class="keyword">print</span> <span class="string">"dns resolver error:"</span> + str(e)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> A.response.answer:</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i.items:</div><div class="line">                iplist.append(j.address)  <span class="comment"># è¿½åŠ åˆ°iplist</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkip</span><span class="params">(ip)</span>:</span></div><div class="line">    checkurl=ip+<span class="string">":80"</span></div><div class="line">    getcontent=<span class="string">""</span></div><div class="line">    httplib.socket.setdefaulttimeout(<span class="number">5</span>) <span class="comment"># å®šä¹‰httpè¿æ¥è¶…æ—¶é—´ä¸º5ç§’</span></div><div class="line">    conn=httplib.HTTPConnection(checkurl) <span class="comment"># åˆ›å»ºhttpè¿æ¥å¯¹è±¡</span></div><div class="line">    </div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        conn.request(<span class="string">"GET"</span>, <span class="string">"/"</span>, headers = &#123;<span class="string">"Host"</span>: appdomain&#125;)  <span class="comment"># å‘èµ·URLè¯·æ±‚ï¼Œæ·»åŠ host ä¸»æœºå¤´</span></div><div class="line">        r=conn.getresponse()</div><div class="line">        getcontent = r.read(<span class="number">15</span>) <span class="comment"># è·å–URLé¡µé¢å‰15ä¸ªå­—ç¬¦ï¼Œä»¥ä¾¿åšå¯ç”¨æ€§æ ¡éªŒ</span></div><div class="line"></div><div class="line">    <span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">if</span> getcontent==<span class="string">"&lt;!doctype html&gt;"</span>: <span class="comment"># ç›‘æ§URLé¡µçš„å†…å®¹ä¸€èˆ¬æ˜¯äº‹å…ˆå®šä¹‰å¥½çš„ï¼Œæ¯”å¦‚ "HTTP200" ç­‰ </span></div><div class="line">            <span class="keyword">print</span> (getcontent)</div><div class="line">            <span class="keyword">print</span> ip + <span class="string">" [OK]"</span></div><div class="line">        </div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> ip + <span class="string">" [Error]"</span> <span class="comment"># æ­¤å¤„å¯æ”¾å‘Šè­¦ç¨‹åºï¼Œå¯ä»¥æ˜¯é‚®ä»¶ï¼ŒçŸ­ä¿¡é€šçŸ¥</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    <span class="keyword">if</span> get_iplist(appdomain) <span class="keyword">and</span> len(iplist) &gt; <span class="number">0</span>:  <span class="comment"># æ¡ä»¶:åŸŸåè§£ææ­£ç¡®è‡³å°‘è¿”å›ä¸€ä¸ªIP</span></div><div class="line">        <span class="keyword">for</span> ip <span class="keyword">in</span> iplist:</div><div class="line">            checkip(ip)</div><div class="line">        </div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"dns resolver error"</span></div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>python ä¹‹ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£(äºŒ)</title>
      <link href="/2018/01/19/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%BA%8C/"/>
      <url>/2018/01/19/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%BA%8C/</url>
      <content type="html"><![CDATA[<h2 id="æ–‡ä»¶-ç›®å½•å·®å¼‚å¯¹æ¯”æ³•"><a href="#æ–‡ä»¶-ç›®å½•å·®å¼‚å¯¹æ¯”æ³•" class="headerlink" title="æ–‡ä»¶/ç›®å½•å·®å¼‚å¯¹æ¯”æ³•"></a>æ–‡ä»¶/ç›®å½•å·®å¼‚å¯¹æ¯”æ³•</h2><blockquote><p>å½“æˆ‘ä»¬è¿›è¡Œä»£ç å®¡è®¡æˆ–æ ¡éªŒå¤‡ä»½æ—¶ï¼Œå¾€å¾€éœ€è¦æ£€æŸ¥åŸå§‹ä¸ç›®æ ‡ç›®å½•çš„ä¸€è‡´æ€§;<br>Pythonçš„æ ‡å‡†åº“å·²ç»è‡ªå¸¦äº†æ»¡è¶³æ­¤éœ€æ±‚çš„æ¨¡å—filecmp;<br>filecmpå¯ä»¥å®ç°æ–‡ä»¶ã€ç›®å½•éå†å­ç›®å½•çš„å·®å¼‚å¯¹æ¯”åŠŸèƒ½;<br>æ¯”å¦‚æŠ¥å‘Šä¸­è¾“å‡ºç›®å½•ç›®å½•æ¯”åŸå§‹å¤šå‡ºçš„æ–‡ä»¶æˆ–å­ç›®å½•;<br>å³ä½¿æ–‡ä»¶åŒåä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ä¸ªæ–‡ä»¶(å†…å®¹çº§æ¯”å¯¹)ç­‰;<br>python2.3 æˆ–æ›´é«˜ç‰ˆæœ¬é»˜è®¤è‡ªå¸¦fileempæ¨¡å—,æ— éœ€é¢å¤–å®‰è£…;  </p></blockquote><h2 id="æ¨¡å—å¸¸ç”¨æ–¹æ³•è¯´æ˜"><a href="#æ¨¡å—å¸¸ç”¨æ–¹æ³•è¯´æ˜" class="headerlink" title="æ¨¡å—å¸¸ç”¨æ–¹æ³•è¯´æ˜"></a>æ¨¡å—å¸¸ç”¨æ–¹æ³•è¯´æ˜</h2><blockquote><p>filecmp æä¾›äº†ä¸‰ä¸ªæ“ä½œæ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºcmpï¼ˆå•æ–‡ä»¶å¯¹æ¯”ï¼‰ã€cmpfiles(å¤šæ–‡ä»¶å¯¹æ¯”ï¼‰<br>dircmpï¼ˆç›®å½•å¯¹æ¯”) </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">å•æ–‡ä»¶å¯¹æ¯”ï¼Œé‡‡ç”¨filecmp.cmp(f1,f2[,shallow])æ–¹æ³•ï¼Œæ¯”è¾ƒæ–‡ä»¶åä¸ºf1å’Œf2çš„æ–‡ä»¶   </div><div class="line">ç›¸åŒåå›Trueï¼Œä¸ç›¸åŒè¿”å›False,shallowé»˜è®¤ä¸ºTrueï¼Œæ„æ€æ˜¯åªæ ¹æ®os.stat()æ–¹æ³•  </div><div class="line">è¿”å›çš„æ–‡ä»¶åŸºæœ¬ä¿¡æ¯è¿›è¡Œå¯¹æ¯”ï¼Œæ¯”å¦‚æœ€åè®¿é—®æ—¶é—´ã€ä¿®æ”¹æ—¶é—´ã€çŠ¶æ€æ”¹å˜æ—¶é—´ç­‰  </div><div class="line">å¿½ç•¥å¯¹æ–‡ä»¶å†…å®¹çš„å¯¹æ¯”ã€‚å½“shallowä¸ºFalseæ—¶ï¼Œåˆ™os.stat()ä¸æ–‡ä»¶å†…å®¹åŒæ—¶è¿›è¡Œæ ¡éªŒ</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å¯¹æ¯”æ–‡ä»¶çš„å·®å¼‚</span></div><div class="line">âœ  test echo <span class="string">"good user"</span> &gt; f1   </div><div class="line">âœ  test echo <span class="string">"good user"</span> &gt; f3</div><div class="line">âœ  test echo <span class="string">"good user2"</span> &gt; f2</div><div class="line">In [<span class="number">2</span>]: <span class="keyword">import</span> filecmp</div><div class="line"></div><div class="line">In [<span class="number">3</span>]: filecmp.cmp(<span class="string">"/Users/macbookdzsbe/Desktop/MyPython/test/f1"</span>,<span class="string">"/Users/macbookdzsbe/Desktop/MyPython/test/f3"</span>)</div><div class="line">Out[<span class="number">3</span>]: <span class="keyword">True</span></div><div class="line"></div><div class="line">In [<span class="number">4</span>]: filecmp.cmp(<span class="string">"/Users/macbookdzsbe/Desktop/MyPython/test/f1"</span>,<span class="string">"/Users/macbookdzsbe/Desktop/MyPython/test/f2"</span>)</div><div class="line">Out[<span class="number">4</span>]: <span class="keyword">False</span></div></pre></td></tr></table></figure><h2 id="dir1-ä¸-dir2ç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶æ¸…å•å¯¹æ¯”"><a href="#dir1-ä¸-dir2ç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶æ¸…å•å¯¹æ¯”" class="headerlink" title="dir1 ä¸ dir2ç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶æ¸…å•å¯¹æ¯”"></a>dir1 ä¸ dir2ç›®å½•ä¸­æŒ‡å®šæ–‡ä»¶æ¸…å•å¯¹æ¯”</h2><blockquote><p>ä¸¤ç›®å½•ä¸‹æ–‡ä»¶çš„ md5 ä¿¡æ¯å¦‚ä¸‹<br>ä¸¤ç›®å½•ä¸‹æ–‡ä»¶çš„ md5 ä¿¡æ¯å¦‚ä¸‹,å…¶ä¸­f1ã€f2åŒ¹é…; f3ä¸åŒ¹é…<br>f4,f5å¯¹åº”çš„ç›®å½•ä¸­ä¸å­˜åœ¨æ— æ³•æ¯”è¾ƒ</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@test dir2]<span class="comment"># md5sum ../dir1/*</span></div><div class="line"><span class="number">1</span>a9dbd408f626389539e9feb1d234df7  ../dir1/f1</div><div class="line"><span class="number">235</span>dce31eebce0213322102f698bc249  ../dir1/f2</div><div class="line"><span class="number">1</span>a9dbd408f626389539e9feb1d234df7  ../dir1/f3</div><div class="line">d41d8cd98f00b204e9800998ecf8427e  ../dir1/f5</div><div class="line">[root@test dir2]<span class="comment"># md5sum *</span></div><div class="line"><span class="number">1</span>a9dbd408f626389539e9feb1d234df7  f1</div><div class="line"><span class="number">235</span>dce31eebce0213322102f698bc249  f2</div><div class="line"><span class="number">68e51</span>baf228d447b199a75268dd5634b  f3</div><div class="line"><span class="number">764</span>c976782dec989b043d08714ec21a5  f4</div><div class="line"><span class="comment"># ä½¿ç”¨cmpfiles å¯¹æ¯”çš„ç»“æœå¦‚ä¸‹ï¼Œç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸ </span></div><div class="line">In [<span class="number">4</span>]: <span class="keyword">import</span> filecmp</div><div class="line"></div><div class="line">In [<span class="number">5</span>]: filecmp.cmpfiles(<span class="string">"/root/test/dir1"</span>, <span class="string">"/root/test/dir2"</span>,[<span class="string">'f1'</span>,<span class="string">'f2'</span>,<span class="string">'f3'</span>,<span class="string">'f4'</span>,<span class="string">'f5'</span>])</div><div class="line">Out[<span class="number">5</span>]: ([<span class="string">'f1'</span>, <span class="string">'f2'</span>], [<span class="string">'f3'</span>], [<span class="string">'f4'</span>, <span class="string">'f5'</span>])</div></pre></td></tr></table></figure><blockquote><p>ç›®å½•å¯¹æ¯”ï¼Œèƒ½è¿‡dircmp(a,b[,ingore[,hide]]) ç±»åˆ›å»ºä¸€ä¸ªç›®å½•æ¯”è¾ƒå¯¹è±¡;<br>å…¶ä¸­aå’Œbæ˜¯å‚åŠ æ¯”è¾ƒçš„ç›®å½•åã€‚ignoreä»£è¡¨æ–‡ä»¶åå¿½ç•¥çš„åˆ—è¡¨ï¼Œå¹¶é»˜è®¤ä¸º[â€˜RCSâ€™,â€™CVSâ€™,â€™â€™tags];<br>hideä»£è¡¨éšè—çš„åˆ—è¡¨ï¼Œé»˜è®¤ä¸º[os.curdir, os.pardir]ã€‚dircmpç±»å¯ä»¥è·å¾—ç›®å½•æ¯”è¾ƒçš„è¯¦ç»†ä¿¡æ¯;<br>å¦‚åªæœ‰åœ¨aç›®å½•ä¸­åŒ…æ‹¬çš„æ–‡ä»¶ã€aä¸béƒ½å­˜åœ¨çš„å­ç›®å½•ã€åŒ¹é…çš„æ–‡ä»¶ç­‰ï¼ŒåŒæ—¶æ”¯æŒé€’å½’;  </p></blockquote><h2 id="dircmpæä¾›äº†ä¸‰ä¸ªè¾“å‡ºæŠ¥çš„æ–¹æ³•"><a href="#dircmpæä¾›äº†ä¸‰ä¸ªè¾“å‡ºæŠ¥çš„æ–¹æ³•" class="headerlink" title="dircmpæä¾›äº†ä¸‰ä¸ªè¾“å‡ºæŠ¥çš„æ–¹æ³•"></a>dircmpæä¾›äº†ä¸‰ä¸ªè¾“å‡ºæŠ¥çš„æ–¹æ³•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># report()ï¼Œæ¯”è¾ƒå½“å‰æŒ‡å®šç›®å½•ä¸­çš„å†…å®¹;  </span></div><div class="line"><span class="comment"># report_partial_closure(),æ¯”è¾ƒå½“å‰æŒ‡å®šç›®å½• åŠç¬¬ä¸€çº§å­ç›®å½•ä¸­çš„å†…å®¹;  </span></div><div class="line"><span class="comment"># report_full_closure(),é€’å½’æ¯”è¾ƒæ‰€æœ‰æŒ‡å®šç›®å½•çš„å†…å®¹;  </span></div><div class="line"><span class="comment"># ä¸ºè¾“å‡ºæ›´åŠ è¯¦ç»†çš„æ¯”è¾ƒå†…å®¹ï¼Œdircmpç±»è¿˜æä¾›äº†ä»¥ä¸‹å±æ€§;  </span></div><div class="line"><span class="comment"># left, å·¦ç›®å½•,å¦‚ç±»å®šä¹‰çš„a; </span></div><div class="line"><span class="comment"># right, å³ç›®å½•,å¦‚ç±»å®šä¹‰ä¸­çš„b; </span></div><div class="line"><span class="comment"># left_list, å·¦ç›®å½•ä¸­çš„æ–‡ä»¶åŠç›®å½•åˆ—è¡¨;  </span></div><div class="line"><span class="comment"># right_list, å³ç›®å½•ä¸­çš„æ–‡ä»¶åŠç›®å½•åˆ—è¡¨; </span></div><div class="line"><span class="comment"># common, ä¸¤è¾¹ç›®å½•å…±åŒå­˜åœ¨çš„æ–‡ä»¶æˆ–è€…ç›®å½•;  </span></div><div class="line"><span class="comment"># left_only, åªåœ¨å·¦ç›®å½•ä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•; </span></div><div class="line"><span class="comment"># right_only, åªåœ¨å³ç›®å½•çš„æ–‡ä»¶æˆ–è€…ç›®å½•; </span></div><div class="line"><span class="comment"># common_dirs, ä¸¤è¾¹ç›®å½•éƒ½å­˜åœ¨çš„å­ç›®å½•; </span></div><div class="line"><span class="comment"># common_files, ä¸¤è¾¹ç›®å½•éƒ½å­˜åœ¨çš„å­æ–‡ä»¶;  </span></div><div class="line"><span class="comment"># common_funny, ä¸¤è¾¹ç›®å½•éƒ½å­˜åœ¨çš„å­ç›®å½•(ä¸åŒç›®å½•ç±»å‹æˆ–os.stat()è®°å½•çš„é”™è¯¯);  </span></div><div class="line"><span class="comment"># same_files, åŒ¹é…ç›¸åŒçš„æ–‡ä»¶;  </span></div><div class="line"><span class="comment"># diff_files, ä¸åŒ¹é…çš„æ–‡ä»¶;  </span></div><div class="line"><span class="comment"># funny_files, ä¸¤è¾¹ç›®å½•ä¸­éƒ½å­˜åœ¨ï¼Œä½†æ— æ³•æ¯”è¾ƒçš„æ–‡ä»¶; </span></div><div class="line"><span class="comment"># subdirs, å°†common_dirsç›®å½•åæ˜ èº«åˆ°æ–°çš„dircmpå¯¹è±¡ï¼Œæ ¼å¼ä¸ºå­—å…¸ç±»å‹;</span></div></pre></td></tr></table></figure><h2 id="å¯¹æ¯”dir1ä¸dir2ç›®å½•å·®å¼‚"><a href="#å¯¹æ¯”dir1ä¸dir2ç›®å½•å·®å¼‚" class="headerlink" title="å¯¹æ¯”dir1ä¸dir2ç›®å½•å·®å¼‚"></a>å¯¹æ¯”dir1ä¸dir2ç›®å½•å·®å¼‚</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@<span class="built_in">test</span> <span class="built_in">test</span>]<span class="comment"># mkdir dir1/&#123;a/&#123;a1,b/&#123;b1,b2,b3&#125;&#125;,f1,f2,f3,f4&#125; -pv</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/a"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/a/a1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/a/b"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/a/b/b1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/a/b/b2"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/a/b/b3"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/f1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/f2"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/f3"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir1/f4"</span></div><div class="line">[root@<span class="built_in">test</span> <span class="built_in">test</span>]<span class="comment"># touch dir1/test.py</span></div><div class="line">[root@<span class="built_in">test</span> <span class="built_in">test</span>]<span class="comment"># tree  dir1/</span></div><div class="line">dir1/</div><div class="line">â”œâ”€â”€ a</div><div class="line">â”‚Â Â  â”œâ”€â”€ a1</div><div class="line">â”‚Â Â  â””â”€â”€ b</div><div class="line">â”‚Â Â      â”œâ”€â”€ b1</div><div class="line">â”‚Â Â      â”œâ”€â”€ b2</div><div class="line">â”‚Â Â      â””â”€â”€ b3</div><div class="line">â”œâ”€â”€ f1</div><div class="line">â”œâ”€â”€ f2</div><div class="line">â”œâ”€â”€ f3</div><div class="line">â”œâ”€â”€ f4</div><div class="line">â””â”€â”€ test.py</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@tf-test <span class="built_in">test</span>]<span class="comment"># mkdir dir2/&#123;a/&#123;a1,b/&#123;b1,b2,b3&#125;&#125;,aa&#123;/aa1&#125;,f1,f2,f3,f5&#125; -pv</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/a"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/a/a1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/a/b"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/a/b/b1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/a/b/b2"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/a/b/b3"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/aa&#123;"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/aa&#123;/aa1&#125;"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/f1"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/f2"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/f3"</span></div><div class="line">mkdir: å·²åˆ›å»ºç›®å½• <span class="string">"dir2/f5"</span></div><div class="line">[root@tf-test <span class="built_in">test</span>]<span class="comment"># touch dir2/test.py</span></div><div class="line">[root@tf-test <span class="built_in">test</span>]<span class="comment"># tree dir2/</span></div><div class="line">dir2/</div><div class="line">â”œâ”€â”€ a</div><div class="line">â”‚Â Â  â”œâ”€â”€ a1</div><div class="line">â”‚Â Â  â””â”€â”€ b</div><div class="line">â”‚Â Â      â”œâ”€â”€ b1</div><div class="line">â”‚Â Â      â”œâ”€â”€ b2</div><div class="line">â”‚Â Â      â””â”€â”€ b3</div><div class="line">â”œâ”€â”€ aa&#123;</div><div class="line">â”‚Â Â  â””â”€â”€ aa1&#125;</div><div class="line">â”œâ”€â”€ f1</div><div class="line">â”œâ”€â”€ f2</div><div class="line">â”œâ”€â”€ f3</div><div class="line">â”œâ”€â”€ f5</div><div class="line">â””â”€â”€ test.py</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@test test]<span class="comment"># cat cmpy.py </span></div><div class="line"><span class="comment">#!/usr/bin/env python </span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*- </span></div><div class="line"></div><div class="line"><span class="keyword">import</span> filecmp</div><div class="line">a = <span class="string">"/root/test/dir1"</span> <span class="comment"># å®šä¹‰å·¦ç›®å½• </span></div><div class="line">b = <span class="string">"/root/test/dir2"</span> <span class="comment"># å®šä¹‰å³ç›®å½• </span></div><div class="line"></div><div class="line">dirobj=filecmp.dircmp(a,b,[<span class="string">'test.y'</span>]) <span class="comment"># ç›®å½•æ¯”è¾ƒï¼Œå¿½ç•¥test.pyæ–‡ä»¶ </span></div><div class="line"><span class="comment">#è¾“å‡ºå¯¹æ¯”ç»“æœæ•°æ®æŠ¥è¡¨</span></div><div class="line"></div><div class="line">dirobj.report()</div><div class="line">dirobj.report_partial_closure()</div><div class="line">dirobj.report_full_closure() </div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"left_list:"</span> + str(dirobj.left_list)</div><div class="line"><span class="keyword">print</span> <span class="string">"right_list"</span> + str(dirobj.right_list)</div><div class="line"><span class="keyword">print</span> <span class="string">"common:"</span> + str(dirobj.common)</div><div class="line"><span class="keyword">print</span> <span class="string">"left_only:"</span> + str(dirobj.left_only)</div><div class="line"><span class="keyword">print</span> <span class="string">"right_only:"</span> + str(dirobj.right_only)</div><div class="line"><span class="keyword">print</span> <span class="string">"common_dirs:"</span> + str(dirobj.common_dirs)</div><div class="line"><span class="keyword">print</span> <span class="string">"common_files:"</span> + str(dirobj.common_files)</div><div class="line"><span class="keyword">print</span> <span class="string">"common_funny:"</span> + str(dirobj.common_funny)</div><div class="line"><span class="keyword">print</span> <span class="string">"same_file:"</span> + str(dirobj.same_files)</div><div class="line"><span class="keyword">print</span> <span class="string">"diff_files:"</span> + str(dirobj.diff_files)</div><div class="line"><span class="keyword">print</span> <span class="string">"funny_files:"</span> + str(dirobj.funny_files)</div></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">diff /root/test/dir1 /root/test/dir2</div><div class="line">Only in /root/test/dir1 : ['f4']</div><div class="line">Only in /root/test/dir2 : ['aa&#123;', 'f5']</div><div class="line">Identical files : ['test.py']</div><div class="line">Common subdirectories : ['a', 'f1', 'f2', 'f3']</div><div class="line">diff /root/test/dir1 /root/test/dir2</div><div class="line">Only in /root/test/dir1 : ['f4']</div><div class="line">Only in /root/test/dir2 : ['aa&#123;', 'f5']</div><div class="line">Identical files : ['test.py']</div><div class="line">Common subdirectories : ['a', 'f1', 'f2', 'f3']</div><div class="line"></div><div class="line">diff /root/test/dir1/a /root/test/dir2/a</div><div class="line">Common subdirectories : ['a1', 'b']</div><div class="line"></div><div class="line">diff /root/test/dir1/f1 /root/test/dir2/f1</div><div class="line"></div><div class="line">diff /root/test/dir1/f2 /root/test/dir2/f2</div><div class="line"></div><div class="line">diff /root/test/dir1/f3 /root/test/dir2/f3</div><div class="line">diff /root/test/dir1 /root/test/dir2</div><div class="line">Only in /root/test/dir1 : ['f4']</div><div class="line">Only in /root/test/dir2 : ['aa&#123;', 'f5']</div><div class="line">Identical files : ['test.py']</div><div class="line">Common subdirectories : ['a', 'f1', 'f2', 'f3']</div><div class="line"></div><div class="line">diff /root/test/dir1/a /root/test/dir2/a</div><div class="line">Common subdirectories : ['a1', 'b']</div><div class="line"></div><div class="line">diff /root/test/dir1/a/a1 /root/test/dir2/a/a1</div><div class="line"></div><div class="line">diff /root/test/dir1/a/b /root/test/dir2/a/b</div><div class="line">Common subdirectories : ['b1', 'b2', 'b3']</div><div class="line"></div><div class="line">diff /root/test/dir1/a/b/b1 /root/test/dir2/a/b/b1</div><div class="line"></div><div class="line">diff /root/test/dir1/a/b/b2 /root/test/dir2/a/b/b2</div><div class="line"></div><div class="line">diff /root/test/dir1/a/b/b3 /root/test/dir2/a/b/b3</div><div class="line"></div><div class="line">diff /root/test/dir1/f1 /root/test/dir2/f1</div><div class="line"></div><div class="line">diff /root/test/dir1/f2 /root/test/dir2/f2</div><div class="line"></div><div class="line">diff /root/test/dir1/f3 /root/test/dir2/f3</div><div class="line">left_list:['a', 'f1', 'f2', 'f3', 'f4', 'test.py']</div><div class="line">right_list['a', 'aa&#123;', 'f1', 'f2', 'f3', 'f5', 'test.py']</div><div class="line">common:['a', 'f1', 'f2', 'f3', 'test.py']</div><div class="line">left_only:['f4']</div><div class="line">right_only:['aa&#123;', 'f5']</div><div class="line">common_dirs:['a', 'f1', 'f2', 'f3']</div><div class="line">common_files:['test.py']</div><div class="line">common_funny:[]</div><div class="line">same_file:['test.py']</div><div class="line">diff_files:[]</div><div class="line">funny_files:[]</div></pre></td></tr></table></figure><h2 id="æ ¡éªŒæºä¸å¤‡ä»½ç›®å½•å·®å¼‚"><a href="#æ ¡éªŒæºä¸å¤‡ä»½ç›®å½•å·®å¼‚" class="headerlink" title="æ ¡éªŒæºä¸å¤‡ä»½ç›®å½•å·®å¼‚"></a>æ ¡éªŒæºä¸å¤‡ä»½ç›®å½•å·®å¼‚</h2><blockquote><p>æœ‰æ—¶å€™æˆ‘ä»¬æ— æ³•ç¡®è®¤å¤‡ä»½ç›®å½•ä¸æºç›®å½•æ–‡ä»¶æ˜¯å¦ä¿æŒä¸€è‡´ï¼ŒåŒ…æ‹¬æºç›®å½•ä¸­çš„æ–°æ–‡ä»¶æˆ–ç›®å½•;<br>æ›´æ–°æ–‡ä»¶æˆ–ç›®å½• æœ‰æ— æˆåŠŸåŒæ­¥ï¼Œå®šæœŸè¿›è¡Œæ ¡éªŒï¼Œæ²¡æœ‰æˆåŠŸåˆ™å¸Œæœ›æœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œè¡¥å¤‡ä»½;<br>æœ¬æœªä¾‹ä½¿ç”¨äº†filecmpæ¨¡å—çš„left_onlyã€diff_filesæ–¹æ³•é€’å½’è·å–ç›®å½•çš„æ›´æ–°é¡¹;<br>å†é€šè¿‡shuti.copyfileã€ os.makedirs æ–¹æ³•å¯¹æ›´æ–°é¡¹è¿›è¡Œå¤åˆ¶ï¼Œæœ€ç»ˆä¿æŒä¸€è‡´çŠ¶æ€;  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">âœ  test cat dir_contrast.py </div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os, sys </div><div class="line"><span class="keyword">import</span> filecmp</div><div class="line"><span class="keyword">import</span> re </div><div class="line"><span class="keyword">import</span> shutil </div><div class="line"><span class="keyword">import</span> difflib</div><div class="line">holderlist = []</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">compareme</span><span class="params">(dir1,dir2)</span>:</span>   <span class="comment"># é€’å½’è·å–æ›´æ–°é¡¹å‡½æ•°</span></div><div class="line">    dircomp=filecmp.dircmp(dir1,dir2)</div><div class="line">    only_in_one=dircomp.left_only  <span class="comment"># æºç›®å½•æ–°æ–‡ä»¶æˆ–ç›®å½•</span></div><div class="line">    diff_in_one=dircomp.diff_files <span class="comment"># ä¸åŒ¹é…æ–‡ä»¶ï¼Œæºç›®å½•æ–‡ä»¶å·²å‘ç”Ÿå˜åŒ–</span></div><div class="line">    dirath=os.path.abspath(dir1)   <span class="comment"># å®šä¹‰æºç›®å½•ç»å¯¹è·¯å¾„</span></div><div class="line">    <span class="comment">#å°†æ›´æ–°æ–‡ä»¶åæˆ–ç›®å½•è¿½å›åˆ°holderlist </span></div><div class="line">    [holderlist.append(os.path.abspath(os.path.join(dir1,x))) <span class="keyword">for</span> x <span class="keyword">in</span> only_in_one]</div><div class="line">    [holderlist.append(os.path.abspath(os.path.join(dir1,x))) <span class="keyword">for</span> x <span class="keyword">in</span> diff_in_one]</div><div class="line">    <span class="keyword">if</span> len (dircomp.common_dirs) &gt; <span class="number">0</span>: <span class="comment"># åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸åŒå­ç›®å½•ï¼Œä»¥ä¾¿é€’å½’</span></div><div class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> dircomp.common_dirs: <span class="comment">#é€’å½’å­ç›®å½•</span></div><div class="line">            compareme(os.path.abspath(os.path.join(dir1, item)), \</div><div class="line">            os.path.abspath(os.path.join(dir2,item)))</div><div class="line">    <span class="keyword">return</span> holderlist </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> len(sys.argv) &gt;<span class="number">2</span>: <span class="comment">#  è¦æ±‚è¾“å…¥æºç›®å½•ä¸å¤‡ä»½ç›®å½•</span></div><div class="line">        dir1 = sys.argv[<span class="number">1</span>]</div><div class="line">        dir2 = sys.argv[<span class="number">2</span>]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Usage:"</span>, sys.argv[<span class="number">0</span>], <span class="string">"datadir backupdir"</span></div><div class="line">        sys.exit()</div><div class="line">    </div><div class="line">    source_files = compareme(dir1,dir2)</div><div class="line">    dir1 = os.path.abspath(dir1)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> dir2.endswith(<span class="string">'/'</span>): dir2=dir2+<span class="string">'/'</span> <span class="comment">#å¤‡ä»½ç›®å½•è·¯å¾„åŠ "/"ç¬¦</span></div><div class="line">    dir2=os.path.abspath(dir2)</div><div class="line">    destination_files=[]</div><div class="line">    createdir_bool = <span class="keyword">False</span> </div><div class="line"></div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> source_files:   <span class="comment"># éå†è¿”å›çš„å·®å¼‚æ–‡ä»¶æˆ–ç›®å½•æ¸…å•</span></div><div class="line">        destination_dir= re.sub(dir1,dir2, item) <span class="comment"># å°†æºç›®å½•å·®å¼‚è·¯å¾„æ¸…å•å¯¹åº”æ›¿æ¢æˆå¤‡ä»½ç›®å½•</span></div><div class="line">    </div><div class="line">        destination_files.append(destination_dir)</div><div class="line">        <span class="keyword">if</span> os.path.isdir(item): <span class="comment"># å¦‚æœå·®å¼‚è·¯å¾„ ä¸ºç›®å½•ä¸”ä¸å­˜åœ¨,åˆ™åœ¨å¤‡ä»½ç›®å½•ä¸­åˆ›å»º</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(destination_dir):</div><div class="line">                os.makedirs(destination_dir)</div><div class="line">                createdir_bool = <span class="keyword">True</span> <span class="comment">#å†æ¬¡è°ƒç”¨compareme å‡½æ•°æ ‡è®°</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> createdir_bool: <span class="comment">#é‡æ–°è°ƒç”¨comparemeå‡½æ•°,é‡æ–°éå†æ–°åˆ›å»ºç›®å½•çš„å†…å®¹</span></div><div class="line">        destination_files = [] </div><div class="line">        source_files=[]</div><div class="line">        source_files=compareme(dir1,dir2) <span class="comment"># è°ƒç”¨comparemeå‡½æ•°</span></div><div class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> source_files: <span class="comment">#è·å–ç›®å½•å·®å¼‚è·¯å¾„æ¸…å•ï¼Œå¯¹åº”æ›¿æ¢æˆå¤‡åˆ†ç›®å½•</span></div><div class="line">            destination_dir = re.sub(dir1,dir2, item)</div><div class="line">            destination_files.append(destination_dir)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"update item:"</span></div><div class="line">    <span class="keyword">print</span> source_files <span class="comment">#è¾“å‡ºæ›´æ–°é¡¹åˆ—è¡¨æ¸…å•</span></div><div class="line">    copy_pair = zip(source_files,destination_files) <span class="comment">#å°†æºç›®å½•ä¸å¤‡ä»½ç›®å½•æ–‡ä»¶æ‹†åˆ†æˆæ— ç»„</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> copy_pair:</div><div class="line">        <span class="keyword">if</span> os.path.isfile(item[<span class="number">0</span>]): </div><div class="line">            shutil.copyfile(item[<span class="number">0</span>], item[<span class="number">1</span>])</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>python ä¹‹ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£(ä¸€)</title>
      <link href="/2018/01/18/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%B8%80/"/>
      <url>/2018/01/18/python-%E4%B9%8B%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E8%AF%A6%E8%A7%A3-%E4%B8%80/</url>
      <content type="html"><![CDATA[<h2 id="ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£"><a href="#ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£" class="headerlink" title="ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£"></a>ä¸šåŠ¡æœåŠ¡ç›‘æ§è¯¦è§£</h2><blockquote><p>ä¸šåŠ¡æœåŠ¡ç›‘æ§æ˜¯è¿ç»´ä½“ç³»ä¸­æœ€é‡è¦çš„ç¯èŠ‚ï¼Œæ˜¯ä¿è¯ä¸šåŠ¡æœåŠ¡è´¨é‡çš„å…³é”®æ‰‹æ®µã€‚å¦‚ä½•æ›´æœ‰æ•ˆåœ°å®ç°ä¸šåŠ¡æœåŠ¡<br>æ˜¯æ¯ä¸ªè¿ç»´äººå‘˜åº”è¯¥æ€è€ƒçš„é—®é¢˜ï¼Œä¸åŒä¸šåŠ¡åœºæ™¯éœ€å®šåˆ¶ä¸åŒçš„ç›‘æ§ç­–ç•¥ã€‚Pythonåœ¨ç›‘æ§æ–¹é¢æä¾›äº†å¤§é‡<br>çš„ç¬¬ä¸‰æ–¹å¼å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿã€æœ‰æ•ˆåœ°å¼€å‘ä¼ä¸šçº§æœåŠ¡ç›‘æ§å¹³å°ï¼Œä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡ä¿é©¾æŠ¤èˆªã€‚  </p></blockquote><h2 id="æ–‡ä»¶å†…å®¹å·®å¼‚å¯¹æ¯”æ–¹æ³•"><a href="#æ–‡ä»¶å†…å®¹å·®å¼‚å¯¹æ¯”æ–¹æ³•" class="headerlink" title="æ–‡ä»¶å†…å®¹å·®å¼‚å¯¹æ¯”æ–¹æ³•"></a>æ–‡ä»¶å†…å®¹å·®å¼‚å¯¹æ¯”æ–¹æ³•</h2><blockquote><p>é€šè¿‡difflibæ¨¡å—å®ç°æ–‡ä»¶å†…å®¹å·®å¼‚æ¯”å¯¹ã€‚difflibä½œä¸ºPythonçš„æ ‡å‡†åº“æ¨¡å—ï¼Œæ— éœ€å®‰è£…ï¼Œä½œç”¨æ˜¯å¯¹æ¯”<br>æ–‡æœ¬ä¹‹é—´çš„å·®å¼‚ï¼Œä¸”æ”¯æŒè¾“å‡ºå¯è¯»æ€§è¾ƒå¼ºçš„HTMLæ¡£ï¼Œä¸linuxä¸‹çš„diffå‘½ä»¤ç›¸ä¼¼ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<br>difflibå¯¹æ¯”ä»£ç ã€é…ç½®æ–‡ä»¶çš„å·®åˆ«ï¼Œåœ¨ç‰ˆæœ¬æ§åˆ¶æ–¹åœ¨æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚python2.3æˆ–è€…æ›´é«˜ç‰ˆæœ¬é»˜è®¤<br>è‡ªå¸¦difflibæ¨¡å—  </p></blockquote><h2 id="ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚å¯¹æ¯”"><a href="#ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚å¯¹æ¯”" class="headerlink" title="ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚å¯¹æ¯”"></a>ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚å¯¹æ¯”</h2><blockquote><p>é€šè¿‡ä½¿ç”¨difflibæ¨¡å—å®ç°ä¸¤ä¸ªå­—ç¬¦ä¸²çš„å·®å¼‚å¯¹æ¯”ï¼Œç„¶åä»¥ç‰ˆæœ¬æ§åˆ¶é£æ ¼è¿›è¡Œè¾“å‡º  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">âœ  test cat diff.py </div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> difflib</div><div class="line">text1 = <span class="string">"""text1: </span></div><div class="line"><span class="string">This module provides classes and funcitons for compring sequences.</span></div><div class="line"><span class="string">including HTML and context and unified diffs. </span></div><div class="line"><span class="string">difflib document v7.4</span></div><div class="line"><span class="string">add sring </span></div><div class="line"><span class="string">"""</span></div><div class="line">text1_lines = text1.splitlines() <span class="comment">#ä»¥è¡Œè¿›è¡Œåˆ†éš”ï¼Œä»¥ä¾¿è¿›è¡Œå¯¹æ¯”  </span></div><div class="line">text2 = <span class="string">"""text2</span></div><div class="line"><span class="string">This module provides classes and functions for Comparing sequences. </span></div><div class="line"><span class="string">including HTML and context and unified diffs. </span></div><div class="line"><span class="string">difflib document v7.5</span></div><div class="line"><span class="string">"""</span></div><div class="line">text2_lines = text2.splitlines() </div><div class="line">d = difflib.Differ()</div><div class="line">diff = d.compare(text1_lines, text2_lines) <span class="comment"># é‡‡ç”¨compareæ–¹æ³•å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ</span></div><div class="line"><span class="keyword">print</span> <span class="string">'\n'</span> .join(list(diff))</div><div class="line"></div><div class="line"><span class="comment"># ç¤ºä¾‹ç»“æœ</span></div><div class="line">âœ  test python diff.py </div><div class="line">- text1: </div><div class="line">+ text2</div><div class="line">- This module provides classes <span class="keyword">and</span> funcitons <span class="keyword">for</span> compring sequences.</div><div class="line">?                                       -        ^</div><div class="line"></div><div class="line">+ This module provides classes <span class="keyword">and</span> functions <span class="keyword">for</span> Comparing sequences. </div><div class="line">?                                      +         ^   +               +</div><div class="line"></div><div class="line">  including HTML <span class="keyword">and</span> context <span class="keyword">and</span> unified diffs. </div><div class="line">- difflib document v7<span class="number">.4</span></div><div class="line">?                     ^</div><div class="line"></div><div class="line">+ difflib document v7<span class="number">.5</span></div><div class="line">?                     ^</div><div class="line"></div><div class="line">- add sring </div><div class="line">âœ  test </div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## ç¬¦å·è¯´æ˜</span></div></pre></td></tr></table></figure><p>â€˜_â€™   â€˜åŒ…å«åœ¨ç¬¬ä¸€ä¸ªåºåˆ—è¡Œä¸­ï¼Œä½†ä¸åŒ…å«åœ¨ç¬¬äºŒä¸ªåºåˆ—è¡Œâ€™<br>â€˜+â€™   â€˜åŒ…å«åœ¨ç¬¬äºŒä¸ªåºåˆ—è¡Œä¸­ï¼Œä½†ä¸åŒ…å«åœ¨ç¬¬ä¸€ä¸ªåºåˆ—è¡Œâ€™<br>â€˜â€™      â€˜ä¸¤ä¸ªåºåˆ—è¡Œä¸€è‡´â€™<br>â€˜?â€™   â€˜æ ‡å¿—ä¸¤ä¸ªåºåˆ—è¡Œå­˜åœ¨å¢é‡å·®å¼‚â€™<br>â€˜^â€™      â€˜æ ‡å¿—å‡ºä¸¤ä¸ªåºåˆ—è¡Œå­˜åœ¨çš„å·®å¼‚å­—ç¬¦â€™<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## ç”Ÿæˆç¾è§‚çš„å¯¹æ¯”HTMLæ ¼å¼æ–‡æ¡£</div><div class="line"></div><div class="line">&gt; é‡‡ç”¨HtmlDiff()ç±»çš„make_file() æ–¹æ³•å°±å¯ä»¥ç”Ÿæˆç¾è§‚çš„HTMLæ–‡æ¡£  </div><div class="line"></div><div class="line">```python</div><div class="line">d  = difflib.Differ()</div><div class="line">diff = d.compare(text1_lines, text2_lines)</div><div class="line">print &apos;\n&apos; .join(list(diff))</div><div class="line"></div><div class="line">æ›¿æ¢æˆ:</div><div class="line"></div><div class="line">d = difflib.HtmlDiff()</div><div class="line">print d.make_file(text1_lines, text2_lines)</div></pre></td></tr></table></figure></p><h2 id="å¯¹æ¯”Nginxé…ç½®æ–‡ä»¶å·®å¼‚"><a href="#å¯¹æ¯”Nginxé…ç½®æ–‡ä»¶å·®å¼‚" class="headerlink" title="å¯¹æ¯”Nginxé…ç½®æ–‡ä»¶å·®å¼‚"></a>å¯¹æ¯”Nginxé…ç½®æ–‡ä»¶å·®å¼‚</h2><blockquote><p>å½“æˆ‘ä»¬ç»´æŠ¤å¤šä¸ªNginxé…ç½®æ—¶ï¼Œæ—¶å¸¸ä¼šå¯¹æ¯”ä¸åŒç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶çš„å·®å¼‚ï¼Œä½¿ç”¨è¿ç»´äººå‘˜æ›´åŠ æ¸…æ™°åœ°<br>äº†è§£ä¸åŒç‰ˆæœ¬è¿­ä»£çš„æ›´æ–°é¡¹ï¼Œå®ç°çš„æ€è·¯æ˜¯è¯»å–ä¸¤ä¸ªéœ€å¯¹æ¯”çš„é…ç½®æ–‡ä»¶ï¼Œå†ä»¥æ¢è¡Œç¬¦ä½œä¸ºåˆ†éš”ç¬¦<br>è°ƒç”¨ difflib.HtmlDiff() ç”ŸæˆHTMLæ ¼å¼çš„å·®å¼‚æ–‡æ¡£  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">scp diff_nginx.py root@www.ssjinyao.com:/root/</div><div class="line">diff_nginx.py                                                                                                                                                                                               <span class="number">100</span>% <span class="number">1035</span>     <span class="number">1.0</span>KB/s   <span class="number">00</span>:<span class="number">00</span>    </div><div class="line">âœ  test ssh root@www.ssjinyao.com       </div><div class="line">Last failed login: Thu Jan <span class="number">18</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">31</span> CST <span class="number">2018</span> <span class="keyword">from</span> <span class="number">140.205</span><span class="number">.201</span><span class="number">.39</span> on ssh:notty</div><div class="line">There were <span class="number">48</span> failed login attempts since the last successful login.</div><div class="line">Last login: Tue Jan <span class="number">16</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">45</span> <span class="number">2018</span> <span class="keyword">from</span> <span class="number">111.198</span><span class="number">.29</span><span class="number">.81</span></div><div class="line"></div><div class="line">Welcome to Alibaba Cloud Elastic Compute Service !</div><div class="line"></div><div class="line">[root@iz2zearhdmowvugecyh820z ~]<span class="comment"># vim diff_nginx.py </span></div><div class="line">[root@iz2zearhdmowvugecyh820z ~]<span class="comment"># python diff_nginx.py /etc/nginx/conf.d/leleol.conf  /etc/nginx/conf.d/hexo.conf &gt; /var/www/ssjinyao/diff_nginx.html</span></div><div class="line">[root@iz2zearhdmowvugecyh820z ~]<span class="comment"># cat diff_nginx.py </span></div><div class="line"><span class="comment">#!/bin/bash/env python </span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> difflib</div><div class="line"><span class="keyword">import</span> sys </div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    textfile1 = sys.argv[<span class="number">1</span>] <span class="comment">#ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶è·¯å¾„å‚æ•° </span></div><div class="line">    textfile2 = sys.argv[<span class="number">2</span>] <span class="comment">#ç¬¬äºŒä¸ªé…ç½®æ–‡ä»¶è·¯å¾„å‚æ•°</span></div><div class="line"></div><div class="line"><span class="keyword">except</span> Exception, e:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Error:"</span> + str(e)</div><div class="line">    <span class="keyword">print</span> <span class="string">"Usage: diff_nginx.py filename1 filename2"</span></div><div class="line">    sys.exit()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">readfile</span><span class="params">(filename)</span>:</span>  <span class="comment"># æ–‡ä»¶è¯»å–åˆ†éš”å‡½æ•°</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        fileHandle = open (filename, <span class="string">'rb'</span> )</div><div class="line">        text=fileHandle.read() .splitlines() <span class="comment">#è¯»å–åä»¥è¡Œè¿›è¡Œåˆ†éš”</span></div><div class="line">        fileHandle.close()</div><div class="line">        <span class="keyword">return</span> text </div><div class="line"></div><div class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> error: </div><div class="line">        <span class="keyword">print</span> (<span class="string">'Read file Error:'</span> +str(error))</div><div class="line">        sys.exit()</div><div class="line">    <span class="keyword">if</span> textfile1 == <span class="string">""</span> <span class="keyword">or</span> textfile2 == <span class="string">""</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Usage: diff_nginx.py filename1 filename2 "</span></div><div class="line">        sys.exit()</div><div class="line"></div><div class="line">text1_lines = readfile(textfile1) <span class="comment">#è°ƒç”¨readfileå‡½æ•°ï¼Œè·å–åˆ†éš”åçš„å­—ç¬¦ä¸²</span></div><div class="line">text2_lines = readfile(textfile2) </div><div class="line"></div><div class="line">d = difflib.HtmlDiff() <span class="comment">#åˆ›å»ºHtmlDiff()ç±»å¯¹è±¡</span></div><div class="line"><span class="keyword">print</span> d.make_file(text1_lines,text2_lines)  <span class="comment">#é€šè¿‡make_fileæ–¹æ³•è¾“å‡ºHTMLçš„å¯¹æ¯”ç»“æœ</span></div><div class="line">https://www.ssjinyao.com/diff_nginx.html</div></pre></td></tr></table></figure><p><img src="/images/python_diff_nginx.png" alt=""></p>]]></content>
      
      
        <tags>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>python wxpy æ¨¡å—å®ç°å¾®ä¿¡é€šçŸ¥ä¸å‘Šè­¦</title>
      <link href="/2018/01/16/python-wxpy-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5%E4%B8%8E%E5%91%8A%E8%AD%A6/"/>
      <url>/2018/01/16/python-wxpy-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5%E4%B8%8E%E5%91%8A%E8%AD%A6/</url>
      <content type="html"><![CDATA[<h2 id="python-wxpy-æ¨¡å—å®ç°å¾®ä¿¡é€šçŸ¥ä¸å‘Šè­¦"><a href="#python-wxpy-æ¨¡å—å®ç°å¾®ä¿¡é€šçŸ¥ä¸å‘Šè­¦" class="headerlink" title="python wxpy æ¨¡å—å®ç°å¾®ä¿¡é€šçŸ¥ä¸å‘Šè­¦"></a>python wxpy æ¨¡å—å®ç°å¾®ä¿¡é€šçŸ¥ä¸å‘Šè­¦</h2><p>1ã€python wxpyçš„å®‰è£…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pip install wxpy -i "https://pypi.doubanio.com/simple/"</span></div><div class="line"><span class="comment"># pip install wechat_sender -i "https://pypi.doubanio.com/simple/"</span></div></pre></td></tr></table></figure><p>2ã€ wxpyç™»å½•åå‘æ–‡ä»¶åŠ©æ‰‹å‘é€ä¸€æ¡ä¿¡æ¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">âœ  test cat wechat.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</div><div class="line">bot = Bot()</div><div class="line">bot.file_helper.send(<span class="string">'hello world'</span>)</div><div class="line">print(<span class="string">"ending"</span>)</div></pre></td></tr></table></figure><p>3ã€wxpyç™»å½•åå®ç°ä¸å¥½å‹/ç¾¤èŠ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">âœ  test cat wechat_friends.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> time </div><div class="line">reload (sys)</div><div class="line">sys.setdefaultencoding(<span class="string">"utf-8"</span>)</div><div class="line"><span class="comment"># è¿™é‡Œè¦æ³¨æ„ä¸­æ–‡ç¼–ç çš„é—®é¢˜</span></div><div class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</div><div class="line">bot = Bot()</div><div class="line"></div><div class="line"><span class="comment"># è·å–æ‰€æœ‰å¥½å‹</span></div><div class="line">friends = bot.friends()</div><div class="line"></div><div class="line"><span class="comment"># éå†è¾“å‡ºå¥½å‹åç§°</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> friend <span class="keyword">in</span> friends: </div><div class="line">    print(friend)</div><div class="line"></div><div class="line"><span class="comment"># æ‰¾åˆ°å¥½å‹ </span></div><div class="line"></div><div class="line">friend = bot.friends() .search(unicode(<span class="string">'æœ‰ä½ '</span>))[<span class="number">0</span>]</div><div class="line"></div><div class="line">print(friend)</div><div class="line">friend.send(<span class="string">'ä½ åœ¨å¹²å˜›äº†?'</span>)</div><div class="line"></div><div class="line"><span class="comment"># è·å–æ‰€æœ‰èŠå¤©ç¾¤ </span></div><div class="line"></div><div class="line">groups = bot.groups()</div><div class="line"></div><div class="line"><span class="comment"># éå†è¾“å‡ºæ‰€æœ‰èŠå¤©ç¾¤</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> group <span class="keyword">in</span> groups:</div><div class="line">    print(group)</div><div class="line"></div><div class="line"><span class="comment"># æ‰¾åˆ°ç›®æ ‡ç¾¤</span></div><div class="line"><span class="comment"># æœç´¢èŠå¤©ç¾¤æ—¶ï¼Œè¦ç¡®ä¿å°†è¦æœç´¢çš„ç¾¤ç»„ä¿å­˜åœ¨é€šè®¯å½•ä¸­</span></div><div class="line">group = bot.groups() .search(unicode(<span class="string">"an"</span>))[<span class="number">0</span>]</div><div class="line"></div><div class="line">i = <span class="number">0</span></div><div class="line"><span class="keyword">while</span> i&lt;= <span class="number">999</span>:</div><div class="line">    group.send(<span class="string">"This is bug ï¼ï¼ï¼"</span>)</div><div class="line">    i +=<span class="number">1</span></div><div class="line">    time.sleep(<span class="number">0.5</span>)</div></pre></td></tr></table></figure><p>4ã€ å®ç°è‡ªåŠ¨å¯¹æ¶ˆæ¯å¤„ç†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">âœ  test cat wechat_message.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7 </span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> sys</div><div class="line">reload (sys)</div><div class="line">sys.setdefaultencoding(<span class="string">"utf-8"</span>)</div><div class="line">bot = Bot()</div><div class="line"><span class="comment"># è·å–å¥½å‹ </span></div><div class="line">my_friend = bot.friends() .search(unicode(<span class="string">'æœ‰ä½ çœŸå¥½'</span>))[<span class="number">0</span>]</div><div class="line"></div><div class="line"><span class="comment"># æœç´¢ä¿¡æ¯</span></div><div class="line">messages = bot.messages.search(keywords=<span class="string">'æµ‹è¯•'</span>, sender=bot.self)</div><div class="line"></div><div class="line"><span class="keyword">for</span> message <span class="keyword">in</span> messages:</div><div class="line">    print(message)</div><div class="line"></div><div class="line"><span class="comment"># å‘é€æ–‡æœ¬</span></div><div class="line">my_friend.send(<span class="string">'hello,yangyang!'</span>)</div><div class="line"></div><div class="line"><span class="comment"># å‘é€å›¾ç‰‡</span></div><div class="line">my_friend.send_image(<span class="string">'yangyang.png'</span>)</div><div class="line"></div><div class="line"><span class="comment"># å‘é€è§†é¢‘</span></div><div class="line"><span class="comment">#my_friend.send_video('yangyang.mov')</span></div><div class="line"></div><div class="line"><span class="comment"># å‘ç£…æ–‡ä»¶</span></div><div class="line">my_friend.send_file(<span class="string">'yangyang.zip'</span>)</div><div class="line"></div><div class="line"><span class="comment"># ä»¥åŠ¨æ€çš„æ–¹å¼å‘é€å›¾ç‰‡</span></div><div class="line"></div><div class="line">my_friend.send(<span class="string">'yangyang.png'</span>)</div><div class="line"></div><div class="line"><span class="comment"># å‘é€å…¬ä¼—å·</span></div><div class="line">my_friend.send_raw_msg(</div><div class="line">    <span class="comment">#åç‰‡åŸå§‹æ¶ˆæ¯ç±»å‹</span></div><div class="line">    raw_type=<span class="number">42</span>,</div><div class="line">    <span class="comment"># æ³¨æ„`ussername` è¿™é‡Œåº”ä¸ºå¾®ä¿¡IDï¼Œä¸”è¢«å‘é€çš„åç‰‡å¿…é¡»ä¸ºè‡ªå·±çš„å¥½å‹</span></div><div class="line">    raw_content = <span class="string">'&lt;msg username="wxpy_bot" nickname="wxpy æœºå™¨äºº"/&gt;'</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment"># æ¶ˆæ¯æ¥æ”¶ç›‘å¬å™¨</span></div><div class="line"><span class="meta">@bot.register()</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_others</span><span class="params">(msg)</span>:</span></div><div class="line">    <span class="comment"># è¾“å‡ºç›‘å¬åˆ°çš„æ¶ˆæ¯</span></div><div class="line">    print(msg)</div><div class="line">    <span class="comment">#å›å¤æ¶ˆæ¯</span></div><div class="line">    msg.reply(<span class="string">"hello world"</span>)</div><div class="line"></div><div class="line">embed()</div></pre></td></tr></table></figure><p>5ã€ wxpyå›¾çµæœºå™¨äºº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">âœ  test cat wechat_tulin.py </div><div class="line"><span class="comment">#!/usr/bin/env python2.7</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> wxpy <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> time</div><div class="line">reload (sys)</div><div class="line">sys.setdefaultencoding(<span class="string">"utf-8"</span>)</div><div class="line"></div><div class="line">bot = Bot() </div><div class="line"><span class="comment"># è·å–å¥½å‹ </span></div><div class="line">dear =  bot.friends() .search(unicode(<span class="string">'æœ‰ä½ çœŸå¥½'</span>))[<span class="number">0</span>]</div><div class="line"></div><div class="line"><span class="comment"># æ³¨å†Œè·å¾—ä¸ªäººçš„å›¾å½•æœºå™¨äººkeyå¡«å…¥ </span></div><div class="line">tuling = Tuling(api_key=<span class="string">'45a3c4xxxxxxxxx043a126a7119363d9fe'</span>)</div><div class="line"></div><div class="line"><span class="comment"># ä½¿ç”¨å›¾çµæœºå™¨äººè‡ªåŠ¨ä¸æŒ‡å®šå¥½å‹èŠå¤©</span></div><div class="line"><span class="meta">@bot.register(dear)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">reply_my_friend</span><span class="params">(msg)</span>:</span></div><div class="line">    print(msg)</div><div class="line">    tuling.do_reply(msg)</div><div class="line"></div><div class="line"></div><div class="line">embed()</div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>python è‡ªåŠ¨åŒ–ä¹‹paramiko</title>
      <link href="/2018/01/12/python-%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bparamiko/"/>
      <url>/2018/01/12/python-%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bparamiko/</url>
      <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><blockquote><p>paramiko æ˜¯åŸºäºPythonå®ç°çš„SSH2è¿œç¨‹å®‰å…¨è¿æ¥ï¼Œæ”¯æ”¯è®¤è¯åŠå¯†é’¥æ–¹å¼ ã€‚å¯ä»¥å®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œ;<br>æ–‡ä»¶ä¼ è¾“ã€ä¸­é—´SSHä»£ç†ç­‰åŠŸèƒ½ï¼Œç›¸å¯¹äºPexpectï¼Œå°è£…çš„å±‚æ¬¡æ›´é«˜ï¼Œæ›´è´´è¿‘SSHåè®®çš„åŠŸèƒ½;  </p></blockquote><h2 id="paramiko-çš„å®‰è£…"><a href="#paramiko-çš„å®‰è£…" class="headerlink" title="paramiko çš„å®‰è£…"></a>paramiko çš„å®‰è£…</h2><p>1ã€ paramiko æ”¯æŒpipã€ easy_install æˆ–è€…æºå®‰è£…æ–¹å¼ï¼Œå¾ˆæ–¹ä¾¿è§£å†³ä¾èµ–çš„é—®é¢˜ï¼Œå…·ä½“å®‰è£…å‘½ä»¤å¦‚ä¸‹;   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pip easy_install paramiko</span></div><div class="line"><span class="comment"># easy_install paramiko</span></div></pre></td></tr></table></figure><p>2ã€ paramiko ä¾èµ–ç¬¬ä¸‰æ–¹çš„Cryptoã€EcdsaåŒ…åŠPythonå¼€å‘åŒ…python-develçš„æ”¯æŒï¼Œæºç å¦‚ä¸‹;  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum -y install python-devel </span></div><div class="line"><span class="comment"># wget http://ftp.dlitz.net/pub/dlitz/crypto/pycrypto/pycrypto-2.6.tar.gz</span></div><div class="line"><span class="comment"># tar -zxvf pycrypto-2.6.tar.gz</span></div><div class="line"><span class="comment"># cd pycrypto-2.6</span></div><div class="line"><span class="comment"># python setup.py install</span></div><div class="line"><span class="comment"># cd ..</span></div><div class="line"><span class="comment"># wget https://pypi.python.org/packages/source/e/ecdsa/ecdsa-0.10.tar.gz --no-check-certificate </span></div><div class="line"><span class="comment"># tar -zxvf ecdsa-0.10.tar.gz</span></div><div class="line"><span class="comment"># cd ecdsa-0.10</span></div><div class="line"><span class="comment"># python setup.py install </span></div><div class="line"><span class="comment"># cd ..</span></div><div class="line"><span class="comment"># git clone https://github.com/paramiko/paramiko.git</span></div><div class="line"><span class="comment"># cd paramiko</span></div><div class="line"><span class="comment"># python setup.py install</span></div></pre></td></tr></table></figure><p>3ã€ æ ¡éªŒå®‰è£…ç»“æœï¼Œå¯¼å…¥æ¨¡å— æ²¡æœ‰æç¤ºå¼‚å¸¸ï¼Œåˆ™è¯´æ˜è¯¥åŒ…å®‰è£…æˆåŠŸ;   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">âœ  ~ ipython</div><div class="line">Python <span class="number">2.7</span><span class="number">.14</span> (default, Sep <span class="number">25</span> <span class="number">2017</span>, <span class="number">09</span>:<span class="number">53</span>:<span class="number">22</span>) </div><div class="line">Type <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</div><div class="line"></div><div class="line">IPython <span class="number">5.5</span><span class="number">.0</span> -- An enhanced Interactive Python.</div><div class="line">?         -&gt; Introduction and overview of IPython's features.</div><div class="line">%quickref -&gt; Quick reference.</div><div class="line">help      -&gt; Python's own help system.</div><div class="line">object?   -&gt; Details about 'object', use 'object??' for extra details.</div><div class="line"></div><div class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> paramiko </div><div class="line"></div><div class="line">In [<span class="number">2</span>]:</div></pre></td></tr></table></figure><p>4ã€ä½¿ç”¨å¯†ç è®¤è¯æ–¹å¼ï¼Œé€šè¿‡exec_command()æ–¹æ³•æ‰§è¡Œå‘½ä»¤;   </p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">âœ  test cat paramiko_ssh.py </div><div class="line"><span class="comment">#!/usr/bin/env python </span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> paramiko</div><div class="line"></div><div class="line">hostname = <span class="string">'192.168.0.78'</span></div><div class="line">username = <span class="string">'root'</span></div><div class="line">password = <span class="string">'paramiko_test*5'</span></div><div class="line">paramiko.util.log_to_file(<span class="string">'syslogin.log'</span>) <span class="comment"># å‘é€paramiko æ—¥å¿—åˆ°syslog æ–‡ä»¶</span></div><div class="line">ssh=paramiko.SSHClient() <span class="comment"># åˆ›å»ºä¸€ä¸ªsshå®¢æˆ·ç«¯ clientå¯¹è±¡</span></div><div class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</div><div class="line">ssh.load_system_host_keys()</div><div class="line"><span class="comment"># è·å–å®¢æˆ·ç«¯host_keysï¼Œé»˜è®¤ ~/.ssh/known_hosts</span></div><div class="line"><span class="comment">#ssh.load_system_host_keys(filname='/Users/macbookdzsbe/.ssh/known_hosts')  # è·å–å®¢æˆ·ç«¯host_keysï¼Œé»˜è®¤ ~/.ssh/known_hosts</span></div><div class="line"><span class="comment"># ssh.load_host_keys(filename='/root/.ssh/known_hosts')</span></div><div class="line">ssh.connect(hostname=hostname,username=username,password=password)<span class="comment"># åˆ›å»ºsshè¿æ¥</span></div><div class="line">stdin,stdout,stderr=ssh.exec_command(<span class="string">'netstat -tnlup'</span>) <span class="comment">#è°ƒç”¨è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ–¹æ³•exec_command</span></div><div class="line"><span class="comment"># æ‰“å°å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå¾—åˆ°Pyhtonåˆ—è¡¨å½¢ï¼Œå¯ä»¥ä½¿ç”¨stdout.readlines()</span></div><div class="line"><span class="keyword">print</span> stdout.read()</div><div class="line">stdin,stdout,stderr=ssh.exec_command(<span class="string">'date'</span>)</div><div class="line"><span class="keyword">print</span> stdout.readlines()</div><div class="line">ssh.close <span class="comment"># å…³é—­ ssh è¿æ¥</span></div><div class="line">âœ  test python paramiko_ssh.py </div><div class="line">Active Internet connections (only servers)</div><div class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">22</span>              <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">885</span>/sshd            </div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">25</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">1341</span>/master         </div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">18341</span>/mongod        </div><div class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">3306</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">1266</span>/mysqld         </div><div class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">22</span>                   :::*                    LISTEN      <span class="number">885</span>/sshd            </div><div class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">25</span>                  :::*                    LISTEN      <span class="number">1341</span>/master         </div><div class="line">udp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">323</span>           <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*                           <span class="number">624</span>/chronyd         </div><div class="line">udp6       <span class="number">0</span>      <span class="number">0</span> ::<span class="number">1</span>:<span class="number">323</span>                 :::*                                <span class="number">624</span>/chronyd         </div><div class="line"></div><div class="line">[<span class="string">u'2018\u5e74 01\u6708 12\u65e5 \u661f\u671f\u4e94 16:50:33 CST\n'</span>]</div></pre></td></tr></table></figure><p>5ã€ paramiko çš„æ ¸ç»„ä»¶</p><blockquote><p>paramiko åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œä¸€ä¸ªä¸ºSSHClientç±»ï¼Œå¦ä¸€ä¸ªä¸ºSFTPClientç±» </p></blockquote><p>6ã€ SSHClientç±» </p><blockquote><p>SSHClientç±»æ˜¯SSHæœåŠ¡ä¼šè¯çš„é«˜çº§è¡¨ç¤ºï¼Œè¯¥ç±»å°è£…äº†ä¼ è¾“(transport)ã€é€šé“(channel)<br>åŠSFTPClientçš„æ£€éªŒã€å»ºç«‹çš„æ–¹æ³•ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œè¿œç¨‹å‘½ä»¤</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ä¾‹ </span></div><div class="line">client = SSHClient() </div><div class="line">client.load_system_host_keys()</div><div class="line">client.connect(<span class="string">'ssh.example.com'</span>)</div><div class="line">stdin, stdout, stderr = client.exec_command(<span class="string">'ls -l'</span>)</div></pre></td></tr></table></figure><h2 id="SSHClientç±»æ–¹æ³•ä½¿ç”¨"><a href="#SSHClientç±»æ–¹æ³•ä½¿ç”¨" class="headerlink" title="SSHClientç±»æ–¹æ³•ä½¿ç”¨"></a>SSHClientç±»æ–¹æ³•ä½¿ç”¨</h2><p>1ã€ connect æ–¹æ³•</p><blockquote><p>connect æ–¹æ³•å®ç°äº†è¿œç¨‹SSHè¿æ¥å¹¶æ£€éªŒ</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ–¹æ³•å®šä¹‰</span></div><div class="line">connect(self, hostname, port=<span class="number">22</span>, username=<span class="keyword">None</span>, password=<span class="keyword">None</span>, pkey=<span class="keyword">None</span>,</div><div class="line">key_filename=<span class="keyword">None</span>, timeout=<span class="keyword">None</span>, allow_agent=<span class="keyword">True</span>, look_for_keys=<span class="keyword">True</span>, compress=<span class="keyword">False</span>)</div><div class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></div><div class="line"><span class="comment"># hostname (strç±»å‹)ï¼Œè¿æ¥çš„ç›®æ ‡ä¸»æœºåœ°å€ï¼›</span></div><div class="line"><span class="comment"># prot (int ç±»å‹)ï¼Œè¿æ¥ç›®å½•ä¸»æœºçš„ç«¯å£ï¼Œé»˜è®¤ä¸º22;  </span></div><div class="line"><span class="comment"># username (str ç±»å‹), æ ¡éªŒçš„ç”¨æˆ·å (é»˜è®¤ä¸ºå½“å‰çš„æœ¬åœ°ç”¨æˆ·å);  </span></div><div class="line"><span class="comment"># password (str ç±»å‹), å¯†ç ç”¨äºèº«ä»½æ£€éªŒæˆ–è§£é”ç§é’¥; </span></div><div class="line"><span class="comment"># pkey (PKey ç±»å‹), ç§é’¥æ–¹å¼ç”¨äºèº«ä»½éš¾; </span></div><div class="line"><span class="comment"># key_filename(str or list(str) ç±»å‹),ä¸€ä¸ªæ–‡ä»¶åæˆ–è€…æ–‡ä»¶åçš„åˆ—è¡¨ï¼Œç”¨äºç§é’¥çš„èº«ä»½éªŒè¯;</span></div><div class="line"><span class="comment"># timeout (float ç±»å‹),ä¸€ä¸ªå¯é€‰ çš„è¶…æ—¶æ—¶é—´(ä»¥ç§’ä¸ºå•ä½)çš„TCPè¿æ¥;</span></div><div class="line"><span class="comment"># allow_agent (bool ç±»å‹)ï¼Œè®¾ç½®ä¸ºFalseæ—¶ç”¨äºç¦ç”¨è¿æ¥åˆ°SSHä»£ç†; </span></div><div class="line"><span class="comment"># look_for_keys (bool ç±»å‹)ï¼Œè®¾ç½®Falseæ—¶ç”¨æ¥ç¦ç”¨åœ¨~/.sshä¸­æœç´¢ç§é’¥æ–‡ä»¶; </span></div><div class="line"><span class="comment"># compress (bool ç±»å‹), è®¾ç½®ä¸ºTrueæ—¶æ‰“å¼€å‹ç¼©</span></div></pre></td></tr></table></figure><p>2ã€ exec_command æ–¹æ³•</p><blockquote><p>è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ–¹æ³•ï¼Œè¯¥å‘½ä»¤çš„è¾“å…¥ä¸è¾“å‡ºæµä¸ºæ ‡å‡†è¾“å…¥(stdin)ã€è¾“å‡º(stdout)ã€é”™è¯¯(stderr)</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ–¹æ³•å®šä¹‰ </span></div><div class="line">exec_command(self, command, bufsize=<span class="number">-1</span>)</div><div class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></div><div class="line"><span class="comment"># command (str ç±»å‹), æ‰§è¡Œçš„å‘½ä»¤ä¸²;</span></div><div class="line"><span class="comment"># bufsize (int ç±»å‹), æ–‡ä»¶ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ä¸º-1ï¼ˆä¸å±€é™ï¼‰;</span></div></pre></td></tr></table></figure><p>3ã€loa_syste_host_keys æ–¹æ³• </p><blockquote><p>åŠ è½½æœ¬åœ°å…¬é’¥æ ¡éªŒæ–‡ä»¶ï¼Œé»˜è®¤ä¸º~/.ssh/known_hostsï¼Œéé»˜è®¤è·¯å¾„éœ€è¦æ‰‹å·¥æŒ‡å®š;  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">load_system_host_keys(self, filename=<span class="keyword">None</span>)</div><div class="line"></div><div class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></div><div class="line">fiename(strç±»å‹ ),æŒ‡å®šè¿œç¨‹ä¸»æœºå…¬é’¥è®°å½•æ–‡ä»¶;</div></pre></td></tr></table></figure><p>4ã€ set_missing_host_key_policy æ–¹æ³•</p><blockquote><p>è®¾ç½®è¿æ¥çš„è¿œç¨‹ä¸»æœºæ²¡æœ‰æœ¬åœ°ä¸»æœºå¯†é’¥æˆ–HostKeyså¯¹è±¡æ—¶çš„ç­–ç•¥ï¼Œç›®å‰æ”¯æŒä¸‰ç§<br>åˆ†åˆ«æ˜¯ AutoAddPolicyã€RejectPolicy(é»˜è®¤),WarnningPolicyï¼Œä»…é™äºSSHClientç±»  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹</span></div><div class="line">ssh=paramiko.SSHClient() </div><div class="line">ssh.set_missing_host_keypolicy(paramiko.AutoAddPolicy)</div><div class="line"></div><div class="line"><span class="comment"># AutoAddPolicy,è‡ªåŠ¨æ·»åŠ ä¸»æœºååŠä¸»æœºå¯†é’¥åˆ°æœ¬åœ°HostKeyså¯¹è±¡ï¼Œå¹¶å°†å…¶ä¿å­˜</span></div><div class="line"><span class="comment"># ä¸ä¾èµ–load_system_host_keys()çš„é…ç½®ï¼Œå³ä½¿ ~/.ssh/known_hostsä¸å­˜åœ¨ä¹Ÿä¸äº§ç”Ÿå½±å“  </span></div><div class="line"><span class="comment"># RejectPolicy,è‡ªåŠ¨æ‹’ç»æœªçŸ¥çš„ä¸»æœºåå’Œå¯†é’¥ï¼Œä¾èµ–load_system_host_keys()çš„é…ç½®</span></div><div class="line"><span class="comment"># WarningPolicy,ç”¨äºè®°å½•ä¸€ä¸ªæœªçŸ¥çš„ä¸»æœºå¯†é’¥çš„Pythonè­¦å‘Šå¹¶æ¥å—å®ƒï¼ŒåŠŸèƒ½ä¸Šä¸AutoAddPolicyç›¸ä¼¼</span></div><div class="line"><span class="comment"># ä½†åŒºåˆ«åœ¨äºï¼ŒæœªçŸ¥çš„ä¸»æœºä¼šæœ‰è­¦å‘Š</span></div></pre></td></tr></table></figure><h2 id="SFTPClientç±»"><a href="#SFTPClientç±»" class="headerlink" title="SFTPClientç±»"></a>SFTPClientç±»</h2><blockquote><p>SFTPClient ä½œä¸ºä¸€ä¸ªSFTPå®¢æˆ·ç«¯å¯¹è±¡,æ ¹æ®SSHä¼ è¾“åè®®çš„sftpä¼šè¯ï¼Œå®ç°è¿œå®¢ç¨‹æ–‡ä»¶æ“ä½œ<br>æ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€æƒé™ã€çŠ¶æ€ç­‰æ“ä½œ; </p></blockquote><p>1ã€ from_transport æ–¹æ³•</p><blockquote><p>åˆ›å»ºä¸€ä¸ªå·²è¿æ¥é€šçš„SFTPå®¢æˆ·ç«¯é€šé“;  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ–¹æ³•å®šä¹‰ </span></div><div class="line">from_transport(cls, t)</div><div class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></div><div class="line">t(Transport),ä¸€ä¸ªå·²ç»é€šè¿‡éªŒè¯çš„ä¼ è¾“å¯¹è±¡ã€‚</div><div class="line">t = paramiko.Transport((<span class="string">"192.168.0.78"</span>, <span class="number">22</span>))</div><div class="line">t.connect(username=<span class="string">"root"</span>,password=<span class="string">"paramiko_test*5"</span>)</div><div class="line">sftp =paramiko.SFTPClient.from_transport(t)</div></pre></td></tr></table></figure><p>2ã€ put æ–¹æ³• </p><blockquote><p>ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°è¿œç¨‹SFTPæœåŠ¡ç«¯;  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">put(self, localpath, remotepath, callback=<span class="keyword">None</span>, confirm=<span class="keyword">True</span>)</div><div class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></div><div class="line"><span class="comment"># localpath (str ç±»å‹)ï¼Œéœ€ä¸Šä¼ çš„æœ¬åœ°æ–‡ä»¶(æº);</span></div><div class="line"><span class="comment"># remotepath (str ç±»å‹),è¿œç¨‹è·¯å¾„(ç›®æ ‡); </span></div><div class="line"><span class="comment"># collback(functioin(int,int))ï¼Œè·å–å·²æ¥æ”¶çš„å­—å­—æ•°åŠæ€»ä¼ è¾“å­—èŠ‚æ•°ï¼Œä»¥ä¾¿å›è°ƒå‡½æ•°é«˜ç”¨,é»˜è®¤ä¸ºNone;  </span></div><div class="line"><span class="comment"># connfirm (boolç±»å‹),æ–‡ä»¶ä¸Šä¼ å®Œæ¯•åæ˜¯å¦è°ƒç”¨ stat()æ–¹æ³•ï¼Œä»¥ä¾¿ç¡®è®¤æ–‡ä»¶çš„å¤§å°ã€‚ </span></div><div class="line">localpath=<span class="string">'/var/log/httpd/access.log'</span></div><div class="line">remotepath=<span class="string">'/data/bak/log/httpd/access.log'</span></div><div class="line">sftp.put(localpath,remotepath)</div></pre></td></tr></table></figure><p>3ã€ getæ–¹æ³•</p><blockquote><p>ä»è¿œç¨‹SFTPæœåŠ¡ç«¯ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°;  </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">get(self, remotepth, localpath, callbak=<span class="keyword">None</span>)</div><div class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></div><div class="line"><span class="comment"># remotepath (strç±»å‹)ï¼Œéœ€ä¸‹è½½çš„è¿œç¨‹æ–‡ä»¶ (æºæ–‡ä»¶); </span></div><div class="line"><span class="comment"># localpath (strç±»å‹)ï¼Œæœ¬åœ°è·¯å¾„(ç›®æ ‡);</span></div><div class="line"><span class="comment"># callback(function(int, int)),è·å–å·²æ¥æ”¶çš„å­—èŠ‚æ•°åŠæ€»ä¼ è¾“å­—èŠ‚æ•°ï¼Œä»¥ä¾¿å›è°ƒå‡½æ•°åŠè°ƒç”¨ï¼Œé»˜è®¤ä¸ºNone</span></div><div class="line">remotepath=<span class="string">'/var/log/httpd/access.og'</span></div><div class="line">localpath=<span class="string">'/data/bak/log/httpd/access.log'</span></div><div class="line">sftp.get(remotepath,localpath)</div></pre></td></tr></table></figure><p>4ã€å…¶ä»–æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdirï¼Œåœ¨SFTPæœåŠ¡å™¨ç«¯åˆ›å»ºç›®å½•ï¼Œå¦‚sftp.mkdir(<span class="string">"/home/testdir"</span>,<span class="number">0700</span>)</div><div class="line">remove, åˆ é™¤SFTPæœåŠ¡ç«¯åˆ›æŒ‡å®šç›®å½•ï¼Œå¦‚sftp.remove(<span class="string">"/home/testdir"</span>)</div><div class="line">rename, é‡å‘½åSFTPæœåŠ¡å™¨ç«¯æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¦‚sftp.rename(<span class="string">"/home/testdir"</span>,<span class="string">"/home/test"</span>)</div><div class="line">state, è·å–è¿œç¨‹SFTPæœåŠ¡å™¨æŒ‡å®šæ–‡ä»¶ä¿¡æ¯ï¼Œå¦‚sftp.stat(<span class="string">"/home/test"</span>) </div><div class="line">listdir, è·å–è¿œç¨‹SFTPæœåŠ¡å™¨ç«¯æŒ‡å®šç›®å½•åˆ—è¡¨, ä»¥Pythonçš„(List)å½¢å¼è¿”å›, å¦‚sftp.listdir(<span class="string">"/home"</span>)</div></pre></td></tr></table></figure><p>5ã€SFTPClientç±»åº”ç”¨ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python </span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> paramiko</div><div class="line"><span class="keyword">import</span> os</div><div class="line">username = <span class="string">"root"</span></div><div class="line">password = <span class="string">"paramiko_test*5"</span></div><div class="line">hostname = <span class="string">"10.180.55.118"</span></div><div class="line">port = <span class="number">22</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">t = paramiko.Transport((hostname, port))</div><div class="line">t.connect(username=username, password=password)</div><div class="line">sftp =paramiko.SFTPClient.from_transport(t)</div><div class="line"></div><div class="line">sftp.put(<span class="string">"/tmp/next.vim.log"</span>, <span class="string">"/home/root/next.vim.log"</span>) <span class="comment">#ä¸Šä¼ æ–‡ä»¶ </span></div><div class="line">sftp.get(<span class="string">"/etc/hosts"</span>, <span class="string">"/tmp/hosts"</span>) <span class="comment">#ä¸‹è½½æ–‡ä»¶ </span></div><div class="line">sftp.mkdir(<span class="string">"/home/testdir"</span>,<span class="number">0700</span>) <span class="comment">#åˆ›å»ºæ–‡ä»¶ </span></div><div class="line">sftp.rmdir(<span class="string">"/home/root/test5.sql"</span>) <span class="comment">#åˆ é™¤ç›®å½• </span></div><div class="line">sftp.rename(<span class="string">"/home/root/test1.sql"</span>, <span class="string">"/home/root/test5.sql"</span>) <span class="comment">#æ–‡ä»¶é‡å‘½å</span></div><div class="line"><span class="keyword">print</span> sftp.stat(<span class="string">"/home/root/test5.sql"</span>) <span class="comment">#æ‰“å°æ–‡ä»¶ä¿¡æ¯</span></div><div class="line"><span class="keyword">print</span> sftp.listdir(<span class="string">"/home/root"</span>) <span class="comment"># æ‰“å°ç›®å½•åˆ—è¡¨</span></div><div class="line">t.close();</div><div class="line"><span class="keyword">except</span> Exception, e:</div><div class="line"><span class="keyword">print</span> str(e)</div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>è‡ªä¹ ä¹‹pythonåŸºç¡€è¯­æ³•</title>
      <link href="/2018/01/07/%E8%87%AA%E4%B9%A0%E4%B9%8Bpython%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/"/>
      <url>/2018/01/07/%E8%87%AA%E4%B9%A0%E4%B9%8Bpython%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
      <content type="html"><![CDATA[<h1 id="åŸºç¡€è¯­æ³•"><a href="#åŸºç¡€è¯­æ³•" class="headerlink" title="åŸºç¡€è¯­æ³•"></a>åŸºç¡€è¯­æ³•</h1><h2 id="å¸¸é‡ï¼å˜é‡"><a href="#å¸¸é‡ï¼å˜é‡" class="headerlink" title="å¸¸é‡ï¼å˜é‡"></a>å¸¸é‡ï¼å˜é‡</h2><ul><li>å­—é¢å¸¸é‡ </li><li>å˜é‡<br>å˜é‡ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€å—å†…å­˜ï¼›</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">v = <span class="number">1</span></div></pre></td></tr></table></figure><p>è¿™æ ·å°±å®šä¹‰äº†vè¿™ä¸ªå˜é‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">v2 = v</div></pre></td></tr></table></figure><ul><li>å˜é‡çš„å‘½åè§„åˆ™<br>1 åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿<br>2 åªèƒ½ä»¥å­—æ¯æˆ–è€…ä¸‹åˆ’çº¿å¼€å¤´<br>3 ä¸èƒ½æ˜¯Pythonè§£é‡Šå™¨çš„ä¿ç•™å­—</li><li>ä¸èƒ½ä»¥ç±»ä¼¼ for if in æ¥åšå˜é‡åï¼ŒåŠ ä¸ªåç¼€ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚ä½†ä¸å»ºè®®è¿™æ ·ä½¿ç”¨ï¼›  </li></ul><h2 id="è¿ç®—ç¬¦è·Ÿè¡¨è¾¾å¼"><a href="#è¿ç®—ç¬¦è·Ÿè¡¨è¾¾å¼" class="headerlink" title="è¿ç®—ç¬¦è·Ÿè¡¨è¾¾å¼"></a>è¿ç®—ç¬¦è·Ÿè¡¨è¾¾å¼</h2><ul><li><p>ç®—æœ¯ç¬¦<br>1 ç®—æœ¯è¿ç®—ç¬¦<br>2 é€»è¾‘è¿ç®—ç¬¦<br>3 æ¯”è¾ƒè¿ç®—ç¬¦<br>4 å…¶å®ƒè¿ç®—ç¬¦ ï¼ˆèµ‹å€¼ã€æˆå‘˜è¿ç®—ç¬¦ã€èº«ä»½è¿ç®—ç¬¦ï¼‰</p></li><li><p>ç®—æœ¯è¿ç®—ç¬¦<br>1 ç®—æœ¯è¿ç®—ç¬¦é€šå¸¸åªé’ˆå¯¹æ•°å€¼ç±»å‹<br>1+1  3 <em> 5 3/5 3//5 5%3 2*</em>4</p></li><li><p>æ¯”è¾ƒè¿ç®—ç¬¦<br>1 == ç›¸ç­‰<br>2 != ä¸ç­‰äº<br>3 &gt; å¤§äº<br>4 &gt;= å¤§äºç­‰äº<br>5 &lt; å°äº<br>6 &lt;= å°äºç­‰äº</p></li></ul><p>æ¯”è¾ƒè¿ç®—ï¼Œæœ€å¥½æ˜¯è®©ä»–çš„ç±»å‹æ˜¯ç›¸åŒçš„<br>é™¤äº†  == å’Œ !=æœ€å¥½ç±»å‹ç›¸åŒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">float (<span class="number">3</span>)/<span class="number">5</span> <span class="comment"># python2</span></div></pre></td></tr></table></figure><ul><li>é€»è¾‘è¿ç®—ç¬¦ ï¼ˆå‚ä¸è¿ç®—çš„æˆå‘˜åªèƒ½æ˜¯boolç±»å‹ï¼Œæˆ–è€…å¯ä»¥éšå¼è½¬åŒ–ä¸ºboolä¸ºç±»å‹çš„ç±»å‹ï¼‰<br>True False</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">1</span>]: <span class="keyword">True</span> <span class="keyword">and</span> <span class="keyword">True</span></div><div class="line">Out[<span class="number">1</span>]: <span class="keyword">True</span></div><div class="line"><span class="comment"># and éœ€è¦è¿ç®—ç¬¦ä¸¤è¾¹éƒ½æ˜¯Trueç»“æœæ‰ä¸ºTrue</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">2</span>]: <span class="keyword">True</span> <span class="keyword">or</span> <span class="keyword">False</span></div><div class="line">Out[<span class="number">2</span>]: <span class="keyword">True</span></div><div class="line"><span class="comment"># or åªè¦è¿ç®—ç¬¦ä¸¤è¾¹ä»»æ„ä¸€ä¸ªä¸ºTrue,ç»“æœå°±æ˜¯True</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">3</span>]: <span class="keyword">not</span> <span class="keyword">True</span></div><div class="line">Out[<span class="number">3</span>]: <span class="keyword">False</span></div><div class="line"><span class="comment"># not ç±»ä¼¼çŸ­è·¯çš„</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">4</span>]: <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x,y)</span>:</span></div><div class="line">   ...:     print(<span class="string">"&#123;0&#125; + &#123;1&#125;"</span>.format(x,y))</div><div class="line">   ...:     <span class="keyword">return</span> x + y</div><div class="line">   ...: </div><div class="line"></div><div class="line">In [<span class="number">5</span>]: </div><div class="line"></div><div class="line">In [<span class="number">5</span>]: add(<span class="number">1</span>,<span class="number">3</span>)</div><div class="line"><span class="number">1</span> + <span class="number">3</span></div><div class="line">Out[<span class="number">5</span>]: <span class="number">4</span></div><div class="line"></div><div class="line">In [<span class="number">6</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &gt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">and</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</div><div class="line"><span class="number">1</span> + <span class="number">3</span></div><div class="line"><span class="number">1</span> + <span class="number">2</span></div><div class="line"><span class="number">2</span> + <span class="number">4</span></div><div class="line"><span class="number">3</span> + <span class="number">4</span></div><div class="line">Out[<span class="number">6</span>]: <span class="keyword">True</span></div><div class="line"></div><div class="line">In [<span class="number">7</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &lt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">and</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</div><div class="line"><span class="number">1</span> + <span class="number">3</span></div><div class="line"><span class="number">1</span> + <span class="number">2</span></div><div class="line">Out[<span class="number">7</span>]: <span class="keyword">False</span></div><div class="line"><span class="comment"># æ€»æ˜¯ä»å·¦åˆ°å³çš„è®¡ç®—ï¼Œä¸€æ—¦èƒ½å¤Ÿæ–›å†³å®šè¡¨è¾¾å¼çš„æœ€ç»ˆçš„å€¼ï¼Œå°†ç«‹åˆ»åœæ­¢è®¡ç®—</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">8</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &gt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">or</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</div><div class="line"><span class="number">1</span> + <span class="number">3</span></div><div class="line"><span class="number">1</span> + <span class="number">2</span></div><div class="line">Out[<span class="number">8</span>]: <span class="keyword">True</span></div><div class="line"></div><div class="line">In [<span class="number">9</span>]: add(<span class="number">1</span>,<span class="number">3</span>) &lt; add(<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">or</span> add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</div><div class="line"><span class="number">1</span> + <span class="number">3</span></div><div class="line"><span class="number">1</span> + <span class="number">2</span></div><div class="line"><span class="number">2</span> + <span class="number">4</span></div><div class="line"><span class="number">3</span> + <span class="number">4</span></div><div class="line">Out[<span class="number">9</span>]: <span class="keyword">True</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">10</span>]: left =  add(<span class="number">1</span>,<span class="number">3</span>) &lt; add(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line"><span class="number">1</span> + <span class="number">3</span></div><div class="line"><span class="number">1</span> + <span class="number">2</span></div><div class="line"></div><div class="line">In [<span class="number">11</span>]: right  = add(<span class="number">2</span>,<span class="number">4</span>) &lt; add(<span class="number">3</span>,<span class="number">4</span>)</div><div class="line"><span class="number">2</span> + <span class="number">4</span></div><div class="line"><span class="number">3</span> + <span class="number">4</span></div><div class="line"></div><div class="line">In [<span class="number">12</span>]: left <span class="keyword">or</span> right</div><div class="line">Out[<span class="number">12</span>]: <span class="keyword">True</span></div></pre></td></tr></table></figure><ul><li>ä½è¿ç®—ç¬¦</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">12</span>]: bin(<span class="number">60</span>)</div><div class="line">Out[<span class="number">12</span>]: <span class="string">'0b111100'</span></div><div class="line"></div><div class="line">In [<span class="number">13</span>]: bin(<span class="number">12</span>)</div><div class="line">Out[<span class="number">13</span>]: <span class="string">'0b1100'</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">14</span>]: <span class="number">60</span> &amp; <span class="number">12</span></div><div class="line">Out[<span class="number">14</span>]: <span class="number">12</span></div><div class="line"><span class="comment"># 0011 1100</span></div><div class="line"><span class="comment"># 0000 1100</span></div><div class="line"><span class="comment"># 0000 1100</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">15</span>]: <span class="number">60</span> | <span class="number">12</span></div><div class="line">Out[<span class="number">15</span>]: <span class="number">60</span></div><div class="line"><span class="comment"># 0011 1100</span></div><div class="line"><span class="comment"># 0000 1100</span></div><div class="line"><span class="comment"># 0011 1100</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">16</span>]: <span class="number">60</span> ^ <span class="number">12</span></div><div class="line">Out[<span class="number">16</span>]: <span class="number">48</span></div><div class="line"><span class="comment"># 0011 1100</span></div><div class="line"><span class="comment"># 0000 1100</span></div><div class="line"><span class="comment"># 0011 0000</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">18</span>]: int(<span class="string">'0b110000'</span>,<span class="number">2</span>)</div><div class="line">Out[<span class="number">18</span>]: <span class="number">48</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">19</span>]: ~<span class="number">60</span></div><div class="line">Out[<span class="number">19</span>]: <span class="number">-61</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">20</span>]: <span class="number">60</span> &gt;&gt;<span class="number">2</span> </div><div class="line">Out[<span class="number">20</span>]: <span class="number">15</span></div><div class="line"></div><div class="line">In [<span class="number">21</span>]: <span class="number">60</span> &lt;&lt;<span class="number">2</span></div><div class="line">Out[<span class="number">21</span>]: <span class="number">240</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">22</span>]: a = <span class="number">1</span></div><div class="line"></div><div class="line">In [<span class="number">23</span>]: a</div><div class="line">Out[<span class="number">23</span>]: <span class="number">1</span></div><div class="line"><span class="comment"># å·¦è¾¹æ˜¯ä¸€ä¸ªæ ‡å®ç¬¦  å³è¾¹æ˜¯ä¸€ä¸ªå€¼ï¼ˆæˆ–è€…å¯ä»¥è®¡ç®—ä¸ºä¸€ä¸ªå€¼ï¼‰</span></div><div class="line"><span class="comment"># è®©è¿™ä¸ªæ ‡å®ç¬¦æŒ‡å‘è¿™ä¸ªå€¼æ‰€åœ¨çš„å†…å­˜</span></div><div class="line">In [<span class="number">24</span>]: a = <span class="number">3</span>+<span class="number">4</span></div><div class="line"></div><div class="line">In [<span class="number">25</span>]: a</div><div class="line">Out[<span class="number">25</span>]: <span class="number">7</span></div></pre></td></tr></table></figure><ul><li>è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§  </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">26</span>]: <span class="number">1</span>+<span class="number">2</span>*<span class="number">3</span></div><div class="line">Out[<span class="number">26</span>]: <span class="number">7</span></div><div class="line"></div><div class="line">In [<span class="number">27</span>]: <span class="number">2</span> * <span class="number">3</span> **<span class="number">2</span></div><div class="line">Out[<span class="number">27</span>]: <span class="number">18</span></div><div class="line"></div><div class="line">In [<span class="number">28</span>]: <span class="number">2</span> * <span class="number">3</span> &gt; <span class="number">1</span>+<span class="number">2</span></div><div class="line">Out[<span class="number">28</span>]: <span class="keyword">True</span></div><div class="line"><span class="comment"># ç®—æœ¯è¿ç®—ç¬¦ä¼˜å…ˆçº§é«˜äºæ¯”è¾ƒè¿ç®—ç¬¦</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">29</span>]: <span class="number">2</span>* <span class="number">3</span> &gt; <span class="number">1</span>+<span class="number">2</span> <span class="keyword">and</span> <span class="keyword">True</span></div><div class="line">Out[<span class="number">29</span>]: <span class="keyword">True</span></div><div class="line"><span class="comment"># æ¯”è¾ƒè¿ç®—ç¬¦çš„ä¼˜å…ˆçº§é«˜äºé€»è¾‘è¿ç®—ç¬¦</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">30</span>]: (<span class="number">2</span> * <span class="number">3</span> &gt; <span class="number">1</span>+<span class="number">2</span>) <span class="keyword">and</span> <span class="keyword">True</span> </div><div class="line">Out[<span class="number">30</span>]: <span class="keyword">True</span></div><div class="line"><span class="comment"># æ‹¿ä¸å‡†çš„æ—¶å€™åŠ æ‹¬å·ï¼Œæˆ–è€…æˆ‘ä»¬çš„ä»£ç è¡¨ç°åŠ›æ›´æ¸…æ™°çš„æ—¶å€™</span></div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">32</span>]: ((<span class="number">2</span>*<span class="number">3</span>) &gt; (<span class="number">1</span>+<span class="number">2</span>)) <span class="keyword">and</span> <span class="keyword">True</span></div><div class="line">Out[<span class="number">32</span>]: <span class="keyword">True</span></div><div class="line"><span class="comment"># è¡¨è¾¾å¼ç”±å˜é‡/å¸¸é‡ å’Œè¿ç®—ç¬¦ç»„æˆ</span></div></pre></td></tr></table></figure><ul><li>ç¨‹åºæ§åˆ¶ç»“æ„</li></ul><blockquote><p>é¡ºåº<br>åˆ†æ”¯<br>å¾ªç¯</p></blockquote><ul><li>é¡ºåºç»“æ„</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">33</span>]: a = <span class="number">0</span></div><div class="line">In [<span class="number">34</span>]: a = a+<span class="number">1</span></div><div class="line">In [<span class="number">35</span>]: print(a)</div><div class="line"><span class="number">1</span></div></pre></td></tr></table></figure><ul><li>åˆ†æ”¯ç»“æ„</li><li>å•åˆ†æ”¯<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> cond:</div><div class="line">block</div></pre></td></tr></table></figure></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">36</span>]: <span class="keyword">if</span> <span class="number">1</span> &lt; <span class="number">2</span>:</div><div class="line">    ...:     <span class="keyword">print</span> (<span class="string">'1 less 2'</span>)</div><div class="line"><span class="number">1</span> less <span class="number">2</span></div><div class="line">In [<span class="number">37</span>]: <span class="keyword">if</span> <span class="number">1</span> &lt; <span class="number">2</span>:</div><div class="line">    ...:     <span class="keyword">print</span> (<span class="string">'1 less 2'</span>)</div><div class="line">    ...: <span class="keyword">print</span> (<span class="string">'main block'</span>)</div><div class="line"><span class="number">1</span> less <span class="number">2</span></div><div class="line">main block</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">In [<span class="number">39</span>]: bool(<span class="number">0</span>)</div><div class="line">Out[<span class="number">39</span>]: <span class="keyword">False</span></div><div class="line"></div><div class="line">In [<span class="number">40</span>]: bool(<span class="number">-0</span>)</div><div class="line">Out[<span class="number">40</span>]: <span class="keyword">False</span></div><div class="line"></div><div class="line">In [<span class="number">41</span>]: bool(<span class="number">1</span>)</div><div class="line">Out[<span class="number">41</span>]: <span class="keyword">True</span></div><div class="line"></div><div class="line">In [<span class="number">42</span>]: bool(<span class="keyword">None</span>)</div><div class="line">Out[<span class="number">42</span>]: <span class="keyword">False</span></div><div class="line"></div><div class="line">In [<span class="number">43</span>]: bool([])</div><div class="line">Out[<span class="number">43</span>]: <span class="keyword">False</span></div><div class="line"></div><div class="line">In [<span class="number">44</span>]: bool(<span class="string">''</span>)</div><div class="line">Out[<span class="number">44</span>]: <span class="keyword">False</span></div><div class="line"><span class="comment"># 0\ç©ºçš„å†…ç½®ç»“æ„\None boolçš„ç»“æ„éƒ½æ˜¯False,é0éç©ºçš„å†…ç½®ç»“æ„éƒ½æ˜¯True</span></div></pre></td></tr></table></figure><ul><li>åŒåˆ†æ”¯</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> cond:</div><div class="line">true_block</div><div class="line"><span class="keyword">else</span>:</div><div class="line">false_block</div><div class="line"></div><div class="line">In [<span class="number">45</span>]: <span class="keyword">if</span> <span class="number">1</span>&lt;<span class="number">2</span>:</div><div class="line">    ...:     <span class="keyword">print</span> (<span class="string">'1&lt;2'</span>)</div><div class="line">    ...: <span class="keyword">else</span>:</div><div class="line">    ...:     <span class="keyword">print</span> (<span class="string">'2&lt;1'</span>)</div><div class="line">    ...:     </div><div class="line"><span class="number">1</span>&lt;<span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> cond:</div><div class="line">true_block</div><div class="line"><span class="keyword">elif</span> cond:</div><div class="line">true_block</div><div class="line"><span class="keyword">elif</span> cond:</div><div class="line">true_block</div><div class="line"><span class="keyword">elif</span> cond:</div><div class="line">true_block</div><div class="line"><span class="keyword">else</span>:</div><div class="line">false_block</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">In [<span class="number">5</span>]: a = <span class="number">5</span></div><div class="line"></div><div class="line">In [<span class="number">6</span>]: <span class="keyword">if</span> a &lt; <span class="number">0</span>:</div><div class="line">   ...:     <span class="keyword">print</span> (<span class="string">'less 0'</span>)</div><div class="line">   ...: <span class="keyword">elif</span> a &lt; <span class="number">3</span>:</div><div class="line">   ...:     <span class="keyword">print</span> (<span class="string">'less 3'</span>)</div><div class="line">   ...: <span class="keyword">elif</span> a &lt; <span class="number">5</span>:</div><div class="line">   ...:     <span class="keyword">print</span> (<span class="string">'less 5'</span>)</div><div class="line">   ...: <span class="keyword">elif</span> a &lt; <span class="number">7</span>:</div><div class="line">   ...:     <span class="keyword">print</span> (<span class="string">'less 7'</span>)</div><div class="line">   ...: <span class="keyword">else</span>:</div><div class="line">   ...:     <span class="keyword">print</span> (<span class="string">'oops'</span>)</div><div class="line">   ...:     </div><div class="line">less <span class="number">7</span></div><div class="line"><span class="comment"># åˆ†æ”¯ç»“æ„æ°¸è¿œåªæœ‰ä¸€ä¸ªåˆ†æ”¯å¯æ‰§è¡Œï¼›</span></div></pre></td></tr></table></figure><ul><li>å¾ªç¯æœ‰while for ä¸¤ç§è¯­å¥</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> cond:</div><div class="line">block</div><div class="line"></div><div class="line">In [<span class="number">8</span>]: <span class="keyword">while</span> a &lt; <span class="number">10</span>:</div><div class="line">   ...:     print(a)</div><div class="line">   ...:     a +=<span class="number">1</span> <span class="comment"># a = a + 1</span></div><div class="line">   ...:     </div><div class="line"><span class="number">0</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="number">4</span></div><div class="line"><span class="number">5</span></div><div class="line"><span class="number">6</span></div><div class="line"><span class="number">7</span></div><div class="line"><span class="number">8</span></div><div class="line"><span class="number">9</span></div><div class="line"><span class="comment"># é€šå¸¸åœ¨whileå¾ªç¯ä¸­ï¼Œå¾ªç¯ä½“åªéœ€è¦ä¿®æ”¹æ¡ä»¶ï¼Œä»¥ä½¿å¾—æ¡ä»¶ä¸ºå‡</span></div><div class="line">In [<span class="number">34</span>]: i = <span class="number">1</span> </div><div class="line"></div><div class="line">In [<span class="number">35</span>]: s =<span class="number">0</span></div><div class="line"></div><div class="line">In [<span class="number">36</span>]: <span class="keyword">while</span> i &lt;= <span class="number">100</span>:</div><div class="line">    ...:     s +=i</div><div class="line">    ...:     i +=<span class="number">1</span></div><div class="line">    ...:     <span class="keyword">print</span> (s)</div><div class="line">    ...:</div></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> element <span class="keyword">in</span> itrator:</div><div class="line">block</div><div class="line">In [<span class="number">26</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">    ...:     <span class="keyword">print</span> (i)</div><div class="line">    ...:     </div><div class="line"><span class="number">0</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="number">4</span></div><div class="line">In [<span class="number">38</span>]: <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    ...:     <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</div><div class="line">    ...:         <span class="keyword">print</span> (i)</div><div class="line">    ...:         </div><div class="line"><span class="number">0</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">4</span></div><div class="line"><span class="number">6</span></div><div class="line"><span class="number">8</span></div><div class="line">In [<span class="number">1</span>]: <span class="keyword">for</span>  i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">   ...:     <span class="keyword">if</span> i &gt; <span class="number">3</span>:</div><div class="line">   ...:         <span class="keyword">break</span></div><div class="line">   ...:     <span class="keyword">print</span> (i)</div><div class="line">   ...:     </div><div class="line"><span class="number">0</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="comment"># break ç”¨äºæå‰ç»“æŸå¾ªç¯ï¼›</span></div><div class="line">In [<span class="number">3</span>]: <span class="keyword">for</span>  i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">   ...:     <span class="keyword">if</span> i == <span class="number">3</span>:</div><div class="line">   ...:         <span class="keyword">continue</span></div><div class="line">   ...:     <span class="keyword">print</span> (i)</div><div class="line">   ...:     </div><div class="line"><span class="number">0</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">4</span></div><div class="line"><span class="number">5</span></div><div class="line"><span class="number">6</span></div><div class="line"><span class="number">7</span></div><div class="line"><span class="number">8</span></div><div class="line"><span class="number">9</span></div><div class="line"><span class="comment"># continue ç”¨äºè·³è¿‡ä¹‹åçš„è¯­å¥</span></div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>è‡ªä¹ ä¹‹pythonç¯å¢ƒåˆå‡†å¤‡</title>
      <link href="/2018/01/07/%E8%87%AA%E4%B9%A0%E4%B9%8Bpython%E7%8E%AF%E5%A2%83%E5%88%9D%E5%87%86%E5%A4%87/"/>
      <url>/2018/01/07/%E8%87%AA%E4%B9%A0%E4%B9%8Bpython%E7%8E%AF%E5%A2%83%E5%88%9D%E5%87%86%E5%A4%87/</url>
      <content type="html"><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><h2 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h2><ul><li>å®‰è£…Pythonè§£é‡Šå™¨</li><li>ç®¡ç†Pythonç‰ˆæœ¬ </li><li>ç®¡ç†Pythonè™šæ‹Ÿç¯å¢ƒ<br>ç›¸å½“äºä¸€ä¸ªç‹¬ç«‹çš„ç‰ˆæœ¬,æ˜¯bashå†™çš„ä¸€ä¸ªç¨‹åºï¼Œæ‰€ä»¥æ²¡æœ‰ä¾èµ–ï¼›</li></ul><ul><li>pyenv githubåœ°å€</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/yyuu/pyenv-installer</div></pre></td></tr></table></figure><ul><li>è‹¹æœç³»ç»Ÿå®‰è£…pyenv</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash</span></div><div class="line"><span class="comment"># sudo vim /etc/bashrc</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="string">"/Users/ssjinyao/.pyenv/bin:<span class="variable">$PATH</span>"</span></div><div class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv init -)</span>"</span></div><div class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv virtualenv-init -)</span>"</span></div><div class="line"><span class="comment"># source  /etc/bashrc</span></div></pre></td></tr></table></figure><ul><li>linuxç³»ç»Ÿå®‰è£…pyenv </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash</span></div><div class="line"><span class="comment"># vim /etc/profile.d/pyenv.sh</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="string">"/Users/ssjinyao/.pyenv/bin:<span class="variable">$PATH</span>"</span></div><div class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv init -)</span>"</span></div><div class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv virtualenv-init -)</span>"</span></div></pre></td></tr></table></figure><ul><li>å®‰è£…ä¸€ä¸ªpythonçš„ä¾èµ–ï¼ˆCentOSï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum -y install. gcc make patch gdbm-devel openssl-devel sqlite-devel zlib-devel bzip2-devel readline-devel</span></div><div class="line"><span class="comment"># æ³¨ï¼šåœ¨ä¸åŒçš„linuxç³»ç»Ÿä¸Šå®‰è£…åŒ…çš„åå­—ä¸ä¸€æ ·</span></div></pre></td></tr></table></figure><ul><li>pyenvå®‰è£…ä¸€ä¸ªpythonç‰ˆæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pyenv update #ç”¨æ¥æ›´æ–°pyenv</span></div><div class="line"><span class="comment"># pyenv install 3.5.2</span></div></pre></td></tr></table></figure><ul><li>åˆ‡æ¢python 3.5.3</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> 3.5.2</div><div class="line">bogon:~ ssjinyao$ pyenv version</div><div class="line">3.5.2 (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</div><div class="line">bogon:~ ssjinyao$ cat .python-version </div><div class="line">3.5.2</div></pre></td></tr></table></figure><ul><li>åˆ‡æ¢pythonåˆ°ç³»ç»Ÿç‰ˆæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> system</div><div class="line">bogon:~ ssjinyao$ pyenv version</div><div class="line">system (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</div></pre></td></tr></table></figure><ul><li>åˆ‡æ¢å…¨å±€pythonå˜é‡ï¼ˆå¸Œæœ›æ°¸è¿œä¸è¦æ‰§è¡Œï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pyenv global x.x.x</span></div></pre></td></tr></table></figure><h2 id="ä½¿ç”¨pyenv"><a href="#ä½¿ç”¨pyenv" class="headerlink" title="ä½¿ç”¨pyenv"></a>ä½¿ç”¨pyenv</h2><ul><li><p>local å‘½ä»¤<br>local å‘½ä»¤åˆ‡æ¢å½“å‰ç›®å½•åŠå…¶å­ç›®å½•çš„Pythonç‰ˆæœ¬<br>å¦‚ä½•æ¢å¤ï¼Œå¯ä»¥é€šè¿‡åˆ é™¤ â€˜.python-versionâ€™æ¢å¤é»˜è®¤çš„Pythonç‰ˆæœ¬</p></li><li><p>global å‘½ä»¤<br>globalå‘½ä»¤åˆ‡æ¢å…¨å±€é»˜è®¤pythonç‰ˆæœ¬</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">bogon:~ ssjinyao$ pyenv commands</div><div class="line">--version</div><div class="line">activate</div><div class="line">commands</div><div class="line">completions</div><div class="line">deactivate</div><div class="line">doctor</div><div class="line"><span class="built_in">exec</span></div><div class="line">global</div><div class="line"><span class="built_in">help</span></div><div class="line">hooks</div><div class="line">init</div><div class="line">install</div><div class="line">installer</div><div class="line"><span class="built_in">local</span></div><div class="line">offline-installer</div><div class="line">prefix</div><div class="line"><span class="built_in">rehash</span></div><div class="line">root</div><div class="line">shell</div><div class="line">shims</div><div class="line">uninstall</div><div class="line">update</div><div class="line">version</div><div class="line">version-file</div><div class="line">version-file-read</div><div class="line">version-file-write</div><div class="line">version-name</div><div class="line">version-origin</div><div class="line">versions</div><div class="line">virtualenv</div><div class="line">virtualenv-delete</div><div class="line">virtualenv-init</div><div class="line">virtualenv-prefix</div><div class="line">virtualenvs</div><div class="line"><span class="built_in">whence</span></div><div class="line"><span class="built_in">which</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">bogon:~ ssjinyao$ pyenv  virtualenv 3.5.2 magedu</div><div class="line">Ignoring indexes: https://pypi.python.org/simple</div><div class="line">Requirement already satisfied (use --upgrade to upgrade): setuptools <span class="keyword">in</span> /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu/lib/python3.5/site-packages</div><div class="line">Requirement already satisfied (use --upgrade to upgrade): pip <span class="keyword">in</span> /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu/lib/python3.5/site-packages  </div><div class="line">bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> 3.5.2/envs/magedu </div><div class="line">(3.5.2/envs/magedu) bogon:~ ssjinyao$ </div><div class="line">(3.5.2/envs/magedu) bogon:~ ssjinyao$ pyenv <span class="built_in">local</span> 3.5.2</div><div class="line">bogon:~ ssjinyao$ </div><div class="line">bogon:~ ssjinyao$ ls -l ~/.pyenv/versions/ </div><div class="line">total 8</div><div class="line">drwxr-xr-x  7 ssjinyao  staff  238 11 19 10:30 3.5.2</div><div class="line">lrwxr-xr-x  1 ssjinyao  staff   49 11 19 10:35 magedu -&gt; /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">bogon:~ ssjinyao$ pyenv versions</div><div class="line">  system</div><div class="line">* 3.5.2 (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</div><div class="line">  3.5.2/envs/magedu</div><div class="line">  magedu</div><div class="line">bogon:~ ssjinyao$ pyenv uninstall magedu</div><div class="line">pyenv-virtualenv: remove /Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu? y</div><div class="line">bogon:~ ssjinyao$ pyenv versions</div><div class="line">  system</div><div class="line">* 3.5.2 (<span class="built_in">set</span> by /Users/ssjinyao/.python-version)</div></pre></td></tr></table></figure><ul><li><p>virtualenv å‘½ä»¤<br>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ <code>pyenv virtualenv $bash_version $name</code></p></li><li><p>uninstall å‘½ä»¤<br>å¸è½½æŸä¸ªç‰ˆæœ¬ï¼ŒåŒ…æ‹¬è™šæ‹Ÿç¯å¢ƒï¼›</p></li></ul><h2 id="é€‰æ‹©pythonç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥è¿™æ ·é€‰æ‹©"><a href="#é€‰æ‹©pythonç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥è¿™æ ·é€‰æ‹©" class="headerlink" title="é€‰æ‹©pythonç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥è¿™æ ·é€‰æ‹©"></a>é€‰æ‹©pythonç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥è¿™æ ·é€‰æ‹©</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bogon:~ ssjinyao$ ls ~/.pyenv/versions/3.5.2/envs/magedu/bin/python</div><div class="line">/Users/ssjinyao/.pyenv/versions/3.5.2/envs/magedu/bin/python</div></pre></td></tr></table></figure><h2 id="vim-pythonæ’ä»¶ï¼ˆjediï¼‰"><a href="#vim-pythonæ’ä»¶ï¼ˆjediï¼‰" class="headerlink" title="vim pythonæ’ä»¶ï¼ˆjediï¼‰"></a>vim pythonæ’ä»¶ï¼ˆjediï¼‰</h2><h2 id="vim-pythonæ’ä»¶åŒ…-ï¼ˆmaximum-awesomeï¼‰"><a href="#vim-pythonæ’ä»¶åŒ…-ï¼ˆmaximum-awesomeï¼‰" class="headerlink" title="vim pythonæ’ä»¶åŒ… ï¼ˆmaximum-awesomeï¼‰%"></a>vim pythonæ’ä»¶åŒ… ï¼ˆmaximum-awesomeï¼‰%</h2>]]></content>
      
      
    </entry>
    
    <entry>
      <title>è‡ªä¹ ä¹‹ Linux HA Cluster 2</title>
      <link href="/2018/01/03/Linux-HA-Cluster-2/"/>
      <url>/2018/01/03/Linux-HA-Cluster-2/</url>
      <content type="html"><![CDATA[<h2 id="æ¸©æ•…è€ŒçŸ¥æ–°"><a href="#æ¸©æ•…è€ŒçŸ¥æ–°" class="headerlink" title="æ¸©æ•…è€ŒçŸ¥æ–°"></a>æ¸©æ•…è€ŒçŸ¥æ–°</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Messaaging Layer:</div><div class="line">heartbaet v1,v2,v3 </div><div class="line">corosync v1, v2(votequorum)</div><div class="line">OpenAIS</div><div class="line">CRM:</div><div class="line">pacemaker éœ€è¦ä¸€ä¸ªé…ç½®æ¥å£</div><div class="line">é…ç½®æ¥å£:crmsh (ç”±SUSEç ”å‘çš„),ç”±psshç®¡ç†å·¥å…·æ¥å®ç°</div><div class="line"> pcs (agent c/s ),pcsdæ¥å®ç°</div><div class="line"> conga(ricciè¿è¡Œåœ¨å„ç»“ç‚¹ä¸Šçš„è¿›ç¨‹/luciå‘é€æŒ‡ä»¤åˆ°å„èŠ‚ç‚¹)ç»„æˆ</div><div class="line"> </div><div class="line"> group,constraint(åŸºäºçº¦æŸ)</div><div class="line"> </div><div class="line"> rgmanager(cman)</div><div class="line"> resouce group(èµ„æºç»„):</div><div class="line"> failover domain</div><div class="line">RA:</div><div class="line">LSB: /etc/rc.d/init.d</div><div class="line">systemd: /etc/systemd/system/multi-user.wants</div><div class="line">æœåŠ¡å¼€æœºå¤„äº<span class="built_in">enable</span>çŠ¶æ€;</div><div class="line">OCF:[provider]</div><div class="line">heartbeat</div><div class="line">pacemaker </div><div class="line">linbit åŸºäºå†…æ ¸è·¨èŠ‚ç‚¹çš„å—è®¾å¤‡</div><div class="line">service</div><div class="line">stonith</div><div class="line">é«˜å¯ç”¨é›†ç¾¤çš„å¯ç”¨æ–¹æ¡ˆ:</div><div class="line">heartbeat v1</div><div class="line">heartbeat v2</div><div class="line">heartbeat v3 + pacemaker X </div><div class="line">corosync + pacemaker </div><div class="line">cman + rgmanager </div><div class="line">corosync + cman + pacemaker</div><div class="line">keepalived</div></pre></td></tr></table></figure><h2 id="Linux-HA-Cluster-2"><a href="#Linux-HA-Cluster-2" class="headerlink" title="Linux-HA-Cluster 2"></a>Linux-HA-Cluster 2</h2><blockquote><p>Heartbeaté›†ç¾¤ä¹‹é—´ä¼ é€’å¿ƒè·³çš„æ–¹æ³•<br>1ã€ä½¿ç”¨ä¸²å‹çº¿ç¼†<br>2ã€ä½¿ç”¨ä»¥å¤ªç½‘é€šä¿¡<br>3ã€Unicast  å•æ’­ï¼Œä½¿ç”¨udpuï¼Œä¸€èˆ¬åœ¨ä¸æ”¯æŒå¤šæ’­çš„ç½‘ç»œä¸­ä½¿ç”¨çš„<br>4ã€Mutlicast  å¤šæ’­/ç»„æ’­, ä½¿ç”¨udp<br>5ã€Broadcast  å¹¿æ’­ï¼Œå ç”¨è¿‡é«˜çš„ç½‘ç»œèµ„æº    </p></blockquote><p>1ã€ç»„æ’­åœ°å€:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ç”¨äºæ ‡è¯†ä¸€ä¸ªIPç»„æ’­åŸŸ:IANAæŠŠDç±»åœ°å€ç•™ç»™ç»„æ’­ä½¿ç”¨:224.0.0.0-239.255.255.255 </div><div class="line">æ°¸ä¹…ç»„æ’­åœ°å€:224.0.0.0-224.0.0.255</div><div class="line">ä¸´æ—¶ç»„æ’­åœ°å€:224.0.1.0-238.255.255.255  å»ºè®®ä½¿ç”¨ä¸´æ—¶ç»„æ’­åœ°å€</div><div class="line">æœ¬åœ°ç»„æ’­åœ°å€:239.0.0.0-239.255.255.255</div></pre></td></tr></table></figure><p>2ã€é…ç½®ä»¥ç»„æ’­æ–¹å¼è¿›è¡Œé«˜å¯ç”¨é›†ç¾¤é€šä¿¡  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># åœ¨Node1 å’Œ Node2ä¸­æ‰§è¡Œ</span></div><div class="line"><span class="comment"># yum -y install corosync pacemaker</span></div><div class="line"><span class="comment"># rpm -ql corosync #æŸ¥çœ‹corosyncå®‰è£…å®Œä¹‹åæ‰€ç”Ÿæˆçš„é…ç½®æ–‡ä»¶;</span></div><div class="line">/etc/corosync</div><div class="line">/etc/corosync/corosync.conf.example</div><div class="line">/etc/corosync/corosync.conf.example.udpu</div><div class="line">/etc/corosync/corosync.xml.example</div><div class="line">/etc/corosync/uidgid.d</div><div class="line">/etc/dbus-1/system.d/corosync-signals.conf</div><div class="line">/etc/logrotate.d/corosync</div><div class="line">/etc/sysconfig/corosync</div><div class="line">/etc/sysconfig/corosync-notifyd</div><div class="line">/usr/bin/corosync-blackbox</div><div class="line">/usr/bin/corosync-xmlproc</div><div class="line">/usr/lib/systemd/system/corosync-notifyd.service</div><div class="line">/usr/lib/systemd/system/corosync.service</div><div class="line">/usr/sbin/corosync</div><div class="line">/usr/sbin/corosync-cfgtool</div><div class="line">/usr/sbin/corosync-cmapctl</div><div class="line">/usr/sbin/corosync-cpgtool</div><div class="line">/usr/sbin/corosync-keygen</div><div class="line">/usr/sbin/corosync-notifyd</div><div class="line">/usr/sbin/corosync-quorumtool</div><div class="line">/usr/share/corosync</div><div class="line">/usr/share/corosync/corosync</div><div class="line">/usr/share/corosync/corosync-notifyd</div><div class="line">/usr/share/corosync/xml2conf.xsl</div><div class="line">/usr/share/doc/corosync-2.4.0</div><div class="line">/usr/share/doc/corosync-2.4.0/LICENSE</div><div class="line">/usr/share/doc/corosync-2.4.0/SECURITY</div><div class="line">/usr/share/man/man5/corosync.conf.5.gz</div><div class="line">/usr/share/man/man5/corosync.xml.5.gz</div><div class="line">/usr/share/man/man5/votequorum.5.gz</div><div class="line">/usr/share/man/man8/cmap_keys.8.gz</div><div class="line">/usr/share/man/man8/corosync-blackbox.8.gz</div><div class="line">/usr/share/man/man8/corosync-cfgtool.8.gz</div><div class="line">/usr/share/man/man8/corosync-cmapctl.8.gz</div><div class="line">/usr/share/man/man8/corosync-cpgtool.8.gz</div><div class="line">/usr/share/man/man8/corosync-keygen.8.gz</div><div class="line">/usr/share/man/man8/corosync-notifyd.8.gz</div><div class="line">/usr/share/man/man8/corosync-quorumtool.8.gz</div><div class="line">/usr/share/man/man8/corosync-xmlproc.8.gz</div><div class="line">/usr/share/man/man8/corosync.8.gz</div><div class="line">/usr/share/man/man8/corosync_overview.8.gz</div><div class="line">/usr/share/snmp/mibs/COROSYNC-MIB.txt</div><div class="line">/var/lib/corosync</div><div class="line">/var/<span class="built_in">log</span>/cluster</div><div class="line"><span class="comment"># rpm -ql pacemaker #æŸ¥çœ‹pacemakeræ‰€ç”Ÿæˆçš„é…ç½®æ–‡ä»¶;</span></div><div class="line">/etc/sysconfig/pacemaker</div><div class="line">/usr/lib/ocf/resource.d/.isolation</div><div class="line">/usr/lib/ocf/resource.d/.isolation/docker-wrapper</div><div class="line">/usr/lib/ocf/resource.d/pacemaker/controld</div><div class="line">/usr/lib/ocf/resource.d/pacemaker/remote</div><div class="line">/usr/lib/systemd/system/pacemaker.service</div><div class="line">/usr/libexec/pacemaker/attrd</div><div class="line">/usr/libexec/pacemaker/cib</div><div class="line">/usr/libexec/pacemaker/cibmon</div><div class="line">/usr/libexec/pacemaker/crmd</div><div class="line">/usr/libexec/pacemaker/lrmd</div><div class="line">/usr/libexec/pacemaker/lrmd_internal_ctl</div><div class="line">/usr/libexec/pacemaker/pengine</div><div class="line">/usr/libexec/pacemaker/stonith-test</div><div class="line">/usr/libexec/pacemaker/stonithd</div><div class="line">/usr/sbin/crm_attribute</div><div class="line">/usr/sbin/crm_master</div><div class="line">/usr/sbin/crm_node</div><div class="line">/usr/sbin/pacemakerd</div><div class="line">/usr/sbin/stonith_admin</div><div class="line">/usr/share/doc/pacemaker-1.1.16</div><div class="line">/usr/share/doc/pacemaker-1.1.16/COPYING</div><div class="line">/usr/share/doc/pacemaker-1.1.16/ChangeLog</div><div class="line">/usr/share/licenses/pacemaker-1.1.16</div><div class="line">/usr/share/licenses/pacemaker-1.1.16/GPLv2</div><div class="line">/usr/share/man/man7/crmd.7.gz</div><div class="line">/usr/share/man/man7/ocf_pacemaker_controld.7.gz</div><div class="line">/usr/share/man/man7/ocf_pacemaker_remote.7.gz</div><div class="line">/usr/share/man/man7/pengine.7.gz</div><div class="line">/usr/share/man/man7/stonithd.7.gz</div><div class="line">/usr/share/man/man8/crm_attribute.8.gz</div><div class="line">/usr/share/man/man8/crm_master.8.gz</div><div class="line">/usr/share/man/man8/crm_node.8.gz</div><div class="line">/usr/share/man/man8/pacemakerd.8.gz</div><div class="line">/usr/share/man/man8/stonith_admin.8.gz</div><div class="line">/usr/share/pacemaker/alerts</div><div class="line">/usr/share/pacemaker/alerts/alert_file.sh.sample</div><div class="line">/usr/share/pacemaker/alerts/alert_smtp.sh.sample</div><div class="line">/usr/share/pacemaker/alerts/alert_snmp.sh.sample</div><div class="line">/var/lib/pacemaker/cib</div><div class="line">/var/lib/pacemaker/pengine</div></pre></td></tr></table></figure><p>2ã€é…ç½®corosync  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cd /etc/corosync/</span></div><div class="line"><span class="comment"># cp corosync.conf.example </span></div><div class="line"><span class="comment"># cp corosync.conf.example corosync.conf</span></div><div class="line"><span class="comment"># æŸäº›ç¯å¢ƒä¸­å¯èƒ½ä¸æ”¯æŒç»„æ’­ã€‚è¿™æ—¶åº”è¯¥é…ç½®Corosyncä½¿ç”¨å•æ’­;  </span></div><div class="line"><span class="comment"># ä¸‹é¢æ˜¯ä½¿ç”¨å•æ’­çš„Corosync é…ç½®æ–‡ä»¶çš„ä¸€éƒ¨åˆ†;</span></div><div class="line"></div><div class="line">totem &#123;</div><div class="line"> <span class="comment">#...</span></div><div class="line"> interface &#123;</div><div class="line"> ringnumber: 0</div><div class="line"> bindnetaddr: 10.180.22.0</div><div class="line"> broadcast: yes (1) </div><div class="line"> mcastport: 5405</div><div class="line"> &#125;</div><div class="line"> interface &#123;</div><div class="line"> ringnumber: 1 </div><div class="line"> bindnetaddr: 10.180.22.0</div><div class="line"> brodcast: yes</div><div class="line"> mcastport: 5405</div><div class="line"> &#125;</div><div class="line"> transport: udpu (2)</div><div class="line">&#125;</div><div class="line"></div><div class="line">nodelist&#123; (3)</div><div class="line">node &#123;</div><div class="line">ring0_addr: 10.180.22.166</div><div class="line">ring1_addr:10.180.55.1</div><div class="line">nodedid: 1</div><div class="line">&#125;</div><div class="line">node &#123; </div><div class="line">ring0_addr: 10.180.22.167</div><div class="line">ring1_addr: 10.180.55.2</div><div class="line">nodeid: 2</div><div class="line"> &#125;</div><div class="line"><span class="comment"># å¦‚æœå°† broadcast è®¾ç½®ä¸ºyes,é›†ç¾¤å¿ƒè·³å°†é€šè¿‡å¹¿æ’­å®ç°ã€‚è®¾ç½®è¯¥å‚æ•°æ—¶,ä¸èƒ½è®¾ç½®mcastaddr;</span></div><div class="line"><span class="comment"># transport é…ç½®é¡¹å†³å®šé›†ç¾¤é€šä¿¡æ–¹å¼ï¼Œè¦å®Œå…¨ç¦ç”¨ç»„æ’­ï¼Œåº”è¯¥é…ç½®å•æ’­ä¼ è¾“å‚æ•° udpu;</span></div><div class="line"><span class="comment"># è¿™è¦æ±‚å°†æ‰€æœ‰çš„èŠ‚ç‚¹æœåŠ¡å™¨ä¿¡æ¯å†™å…¥nodelist;</span></div><div class="line"><span class="comment"># ä¹Ÿå°±æ˜¯éœ€è¦åœ¨é…ç½®HA é›†ç¾¤ä¹‹å‰ç¡®å®šèŠ‚ç‚¹ç»„æˆã€‚é»˜è®¤é…ç½®æ˜¯udpã€‚ é€šä¿¡æ–¹å¼ç±»å‹è¿˜æ”¯æŒudpuå’Œiba;</span></div><div class="line"><span class="comment"># åœ¨nodelist ä¹‹ä¸‹å¯ä»¥ä¸ºæ ½ä¸€èŠ‚ç‚¹è®¾ç½®åªä¸è¯¥èŠ‚ç‚¹ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›è®¾ç½®é¡¹åªèƒ½åŒ…å«åœ¨nodeä¹‹ä¸­;</span></div><div class="line"><span class="comment"># å³åªèƒ½å¯¹å±äºé›†ç¾¤çš„èŠ‚ç‚¹æœåŠ¡å™¨è¿›è¡Œè®¾ç½®ï¼Œè€Œä¸”åªåº”åŒ…æ‹¬é‚£äº›ä¸é»˜è®¤è®¾ç½®ä¸åŒçš„å‚æ•°;</span></div><div class="line"><span class="comment"># æ¯å°æœåŠ¡å™¨éƒ½å¿…éœ€é…ç½® ring0_addr; </span></div><div class="line"></div><div class="line"><span class="comment"># å®éªŒä¸­é…ç½®ä¿¡æ¯å¦‚ä¸‹</span></div><div class="line"><span class="comment"># Please read the corosync.conf.5 manual page</span></div><div class="line">totem &#123;</div><div class="line">version: 2</div><div class="line"></div><div class="line"><span class="comment"># crypto_cipher and crypto_hash: Used for mutual node authentication.</span></div><div class="line"><span class="comment"># If you choose to enable this, then do remember to create a shared</span></div><div class="line"><span class="comment"># secret with "corosync-keygen".</span></div><div class="line"><span class="comment"># enabling crypto_cipher, requires also enabling of crypto_hash.</span></div><div class="line">crypto_cipher: aes128</div><div class="line">crypto_hash: sha1</div><div class="line">secauth: on</div><div class="line"><span class="comment"># interface: define at least one interface to communicate</span></div><div class="line"><span class="comment"># over. If you define more than one interface stanza, you must</span></div><div class="line"><span class="comment"># also set rrp_mode.</span></div><div class="line">interface &#123;</div><div class="line">                <span class="comment"># Rings must be consecutively numbered, starting at 0.</span></div><div class="line">ringnumber: 0</div><div class="line"><span class="comment"># This is normally the *network* address of the</span></div><div class="line"><span class="comment"># interface to bind to. This ensures that you can use</span></div><div class="line"><span class="comment"># identical instances of this configuration file</span></div><div class="line"><span class="comment"># across all your cluster nodes, without having to</span></div><div class="line"><span class="comment"># modify this option.</span></div><div class="line">bindnetaddr: 10.180.0.0</div><div class="line"><span class="comment"># However, if you have multiple physical network</span></div><div class="line"><span class="comment"># interfaces configured for the same subnet, then the</span></div><div class="line"><span class="comment"># network address alone is not sufficient to identify</span></div><div class="line"><span class="comment"># the interface Corosync should bind to. In that case,</span></div><div class="line"><span class="comment"># configure the *host* address of the interface</span></div><div class="line"><span class="comment"># instead:</span></div><div class="line"><span class="comment"># bindnetaddr: 192.168.1.1</span></div><div class="line"><span class="comment"># When selecting a multicast address, consider RFC</span></div><div class="line"><span class="comment"># 2365 (which, among other things, specifies that</span></div><div class="line"><span class="comment"># 239.255.x.x addresses are left to the discretion of</span></div><div class="line"><span class="comment"># the network administrator). Do not reuse multicast</span></div><div class="line"><span class="comment"># addresses across multiple Corosync clusters sharing</span></div><div class="line"><span class="comment"># the same network.</span></div><div class="line">mcastaddr: 239.185.1.31</div><div class="line"><span class="comment"># Corosync uses the port you specify here for UDP</span></div><div class="line"><span class="comment"># messaging, and also the immediately preceding</span></div><div class="line"><span class="comment"># port. Thus if you set this to 5405, Corosync sends</span></div><div class="line"><span class="comment"># messages over UDP ports 5405 and 5404.</span></div><div class="line">mcastport: 5405</div><div class="line"><span class="comment"># Time-to-live for cluster communication packets. The</span></div><div class="line"><span class="comment"># number of hops (routers) that this ring will allow</span></div><div class="line"><span class="comment"># itself to pass. Note that multicast routing must be</span></div><div class="line"><span class="comment"># specifically enabled on most network routers.</span></div><div class="line">ttl: 1</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">nodelist&#123; </div><div class="line">node &#123;</div><div class="line">ring0_addr: 10.180.22.166</div><div class="line">nodedid: 1</div><div class="line">&#125;</div><div class="line">node &#123; </div><div class="line">ring0_addr: 10.180.22.167</div><div class="line">nodeid: 2</div><div class="line">   &#125;</div><div class="line">   node &#123;</div><div class="line">   ring0_addr: 10.180.22.168</div><div class="line">   nodeid: 3</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line">logging &#123;</div><div class="line"><span class="comment"># Log the source file and line where messages are being</span></div><div class="line"><span class="comment"># generated. When in doubt, leave off. Potentially useful for</span></div><div class="line"><span class="comment"># debugging.</span></div><div class="line">fileline: off</div><div class="line"><span class="comment"># Log to standard error. When in doubt, set to no. Useful when</span></div><div class="line"><span class="comment"># running in the foreground (when invoking "corosync -f")</span></div><div class="line">to_stderr: no</div><div class="line"><span class="comment"># Log to a log file. When set to "no", the "logfile" option</span></div><div class="line"><span class="comment"># must not be set.</span></div><div class="line">to_logfile: yes</div><div class="line">logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</div><div class="line"><span class="comment"># Log to the system log daemon. When in doubt, set to yes.</span></div><div class="line">to_syslog: no</div><div class="line"><span class="comment"># Log debug messages (very verbose). When in doubt, leave off.</span></div><div class="line">debug: off</div><div class="line"><span class="comment"># Log messages with time stamps. When in doubt, set to on</span></div><div class="line"><span class="comment"># (unless you are only logging to syslog, where double</span></div><div class="line"><span class="comment"># timestamps can be annoying).</span></div><div class="line">timestamp: on</div><div class="line">logger_subsys &#123;</div><div class="line">subsys: QUORUM</div><div class="line">debug: off</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">quorum &#123;</div><div class="line"><span class="comment"># Enable and configure quorum subsystem (default: off)</span></div><div class="line"><span class="comment"># see also corosync.conf.5 and votequorum.5</span></div><div class="line">provider: corosync_votequorum</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># ç”Ÿæˆå¯†é’¥æ–‡ä»¶  </span></div><div class="line"><span class="comment"># corosync-keygen</span></div><div class="line"><span class="comment"># scp -p authkey coronsync.conf root@node2.ssjinyao.com:/etc/corosync</span></div><div class="line"></div><div class="line"><span class="comment"># corosync å¯åŠ¨é›†ç¾¤æŠ•ç¥¨ç³»ç»Ÿé»˜è®¤å¿…éœ€éœ€è¦ä¸‰äººç»“ç‚¹;</span></div><div class="line"><span class="comment"># systemctl start corosync.serivce #è¿™ä¸ªæ—¶å€™å¯åŠ¨æ˜¯å¤±è´¥çš„;</span></div><div class="line"><span class="comment"># systemctl status corosync.serivce #æŸ¥çœ‹corosyncçš„çŠ¶æ€ä¿¡æ¯;</span></div><div class="line"></div><div class="line"><span class="comment"># æ­¤æ—¶éœ€è¦å¼€å¯å¦ä¸€ä¸ªç»“ç‚¹</span></div><div class="line"><span class="comment"># yum -y install corosync pacemaker </span></div><div class="line"><span class="comment"># Node1 ä¸­æ‰§è¡Œ</span></div><div class="line"><span class="comment"># scp -p  /etc/coronsync.conf /etc/authkey root@node2.ssjinyao.com:/etc/corosync</span></div></pre></td></tr></table></figure><p>3ã€éªŒè¯ç»“ç‚¹ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># corosync-cfgtool -s  # éªŒè¯ç»“ç‚¹</div><div class="line"># corosync-cmapctl  #æŸ¥çœ‹ç»“ç‚¹é—´çš„ä¿¡æ¯;</div><div class="line"># grep -v &apos;^[[:space:]]*#&apos; /etc/corosync.conf  # ä¿å­˜å®ç”¨çš„é…ç½®ç¤ºä¾‹</div></pre></td></tr></table></figure><p>4ã€ç¼–è¾‘pacemaker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># vim /etc/sysconfig/pacemaker</div><div class="line">PCMK_logfile= /var/log/pacemaker.log</div><div class="line"># å„ä¸ªèŠ‚ç‚¹é—´éœ€è¦å¯åŠ¨pacemaker</div><div class="line"># systemctl start pacemaker.service</div><div class="line"># crm_mon  # è¿›è¡ŒéªŒè¯</div></pre></td></tr></table></figure><p>5ã€ crm å·¥å…·çš„ä½¿ç”¨ç®€æ˜ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># crm_node -n  # æŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¿¡æ¯</div><div class="line"># crm_node -l  # ä¾‹å‡ºé›†ç¾¤æ‰€æœ‰çš„èŠ‚ç‚¹ä¿¡æ¯</div><div class="line"># crm_verify -L -V # ä½†çœ‹æŠ¥é”™ä¿¡æ¯</div><div class="line"># crm shell çš„å®‰è£…ä¸ä½¿ç”¨ï¼Œè‹¥æ— rpmåŒ…ï¼Œå¯åœ¨ç½‘ä¸Šæ‰¾ç›¸å…³çš„rpmåŒ…</div><div class="line"># yum -y install crmsh pssh python-pssh</div></pre></td></tr></table></figure><h2 id="HA-Web-Service"><a href="#HA-Web-Service" class="headerlink" title="HA Web Service"></a>HA Web Service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vip: 10.180.xx.xxx, ocf:hearbeat:IPaddr </div><div class="line">httpd: systemd </div><div class="line">nfs shared storage: ocf:heartbeat:Filesystem</div><div class="line">Ha Cluster å·¥ä½œæ¨¡å‹:</div><div class="line">A/P: ä¸¤èŠ‚ç‚¹é›†ç¾¤; active/apsslve;</div><div class="line">without-quorum-policy=(stop|ignore|suicide|freeze)</div><div class="line">A/A:</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># node0 </div><div class="line"># mkdir -pv  /www/htdocs </div><div class="line"># echo &quot;&lt;h1&gt; Test Page on NFS Server&lt;/h1&gt;&quot; &gt; /www/htdocs/index.html</div><div class="line"># vim /etc/exports </div><div class="line">/www/htdocs 10.180.xx.xxx/16(rw)</div><div class="line"># iptables -L -n  # æŸ¥çœ‹æ˜¯å¦æœ‰é˜²ç«å¢™è§„åˆ™</div><div class="line"># checkconfig nfs on </div><div class="line"># systemctl start nfs</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># node 1 </div><div class="line"># showmount -e 10.180.xx.xxx</div><div class="line"># mount -t nfs 10.180.xx.xxx:/www/htdocs /var/www/html # æŒ‚è½½ç½‘ç»œå­˜å‚¨NFS </div><div class="line"># systemctl start httpd </div><div class="line"># systemctl enable httpd</div><div class="line"># æ­¤æ—¶ä¾¿å¯ä»¥æŸ¥çœ‹èƒ½å¦å¯ä»¥èƒ½å¦è®¿é—®åˆ°ä»¥ä¸Šçš„æµ‹è¯•ä¿¡æ¯</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># node 2 </div><div class="line"># systemctl start httpd </div><div class="line"># systemctl enabl httpd</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"># crm configure </div><div class="line">crm(live)configure# show</div><div class="line">crm(live)# configure property </div><div class="line">crm(live)# configure property stonith-enabled=false</div><div class="line">crm(live)# configrue verify </div><div class="line">crm(live)# show </div><div class="line">crm(live)# configure commit</div><div class="line">crm(live)# configure </div><div class="line">crm(live)configure# primitive webip ocf:heartbeat:IPaddr2 params ip=&quot;10.180.xx.xxx&quot; op monitor interval=30s timeout=20s</div><div class="line">crm(live)# configure show </div><div class="line">crm(live)# configure commit</div><div class="line">crm(live)# configure edit  # å¯ä»¥æ‰“å¼€vimç¼–è¾‘é…ç½®æ–‡ä»¶ </div><div class="line">crm(live)# configure verify</div><div class="line">crm(live)# configure primitive webstore ocf:heartbat:Filesystem params device=&quot;10.180.xx.xxx:/www/htdocs&quot; directory=&quot;/var/www/html&quot; fstype=&quot;nfs&quot; op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=40s </div><div class="line">crm(live)# configure verify</div><div class="line">crm(live)configure# colocation webserver_with_webstore_and_webip inf: webserver </div><div class="line">( webip webstore )</div><div class="line">crm(live)# show xmls # æŸ¥çœ‹xmlæ ¼å¼çš„é…ç½®</div><div class="line">crm(live)configure# order webstore_afer_webip Mandatory: webip webstore</div><div class="line">crm(live)configure# order webserver_after_webstore Manadatory: webstore webserver </div><div class="line">crm(live)configure# verify </div><div class="line">crm(live)configure# commit </div><div class="line">crm(live)configure# location webservice_perf_node1 webip 100: node1.ssjinao.com</div><div class="line">crm(live)configure# verify </div><div class="line">crm(live)configure# commit</div><div class="line"></div><div class="line">crom(live)configure# property default-resource-sticklines = 50</div><div class="line"></div><div class="line"># systemctl stop httpd.service </div><div class="line"># systemctl enable httpd.service </div><div class="line"># crm_verify -V -L</div><div class="line"># crm node standby  </div><div class="line"># crm onde online</div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>è‡ªä¹ ä¹‹Linux HA Cluster</title>
      <link href="/2018/01/01/Linux-HA-Cluster/"/>
      <url>/2018/01/01/Linux-HA-Cluster/</url>
      <content type="html"><![CDATA[<h2 id="Linux-HA-Cluster"><a href="#Linux-HA-Cluster" class="headerlink" title="Linux HA Cluster"></a>Linux HA Cluster</h2><h2 id="ä¸€ã€ç†è®ºä»‹ç»"><a href="#ä¸€ã€ç†è®ºä»‹ç»" class="headerlink" title="ä¸€ã€ç†è®ºä»‹ç»"></a>ä¸€ã€ç†è®ºä»‹ç»</h2><blockquote><p>LB,HA,HP,hadoop  </p></blockquote><p>1ã€LBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰:  </p><blockquote><p>ä¼ è¾“å±‚:lvs<br>åº”ç”¨å±‚:nginx,haproxy,httpd,perlbal,ats,varnish   </p></blockquote><p>2ã€HA(é«˜å¯ç”¨ï¼‰:</p><blockquote><p>vrrp: keepalived<br>HA Cluster: heartbeat,OpenAIS corosync/pacemaker,cman,RHCSï¼ˆçº¢å¸½é›†ç¾¤å¥—ä»¶ï¼‰<br>corosync/pacemaker,cman  æ˜¯ä» OpenAISä¸­ç‹¬ç«‹å‡ºæ¥çš„  </p></blockquote><p>3ã€HA:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">æ•…éšœåœºæ™¯:  </div><div class="line">ç¡¬ä»¶æ•…éšœ:è®¾è®¡ç¼ºé™·ï¼Œä½¿ç”¨è¿‡ä¹…è‡ªç„¶æŸåï¼Œäººä¸ºæ•…éšœ  </div><div class="line">è½¯ä»¶æ•…éšœ:è®¾è®¡ç¼ºé™·ï¼Œbug,äººä¸ºè¯¯æ“ä½œ  </div><div class="line">A(å¯ç”¨æ€§)=MTBF[å¹³å‡æ— æ•…éšœæ—¶é—´]/(MTBF[å¹³å‡æ— æ•…éšœæ—¶é—´]+MTTR[å¹³å‡ä¿®å¤æ—¶é—´])  </div><div class="line">MTBF:Mean Time Between Failre</div><div class="line">MTTR:Mean Time To Repair  </div><div class="line">å¯ç”¨æ€§åŒºé—´:0&lt;A&lt;1  </div><div class="line">ç™¾åˆ†æ¯”:90%,95%,99%  </div><div class="line">é€šå¸¸ä¼šç”¨å‡ ä¸ª9æ¥è¡¡é‡å¯ç”¨æ€§</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">æä¾›å†—ä½™: </div><div class="line">    Messaging Layer (åŒå¯ç”¨ç»“æ„é—´çš„ä¿¡æ¯ä¼ é€’å±‚)  </div><div class="line">    Resource Manager (åœ¨Messaging Layerä¹‹ä¸Šï¼Œç®¡ç†å¤šä¸ªèµ„æº)  </div><div class="line">    Local Resource Manager (åœ¨Resource Messaging Layerä¹‹ä¸Šï¼Œå†³å®šåœ¨å“ªä¸ªç»“ç‚¹ä¸Šå¯åŠ¨æœåŠ¡)  </div><div class="line">    <span class="built_in">local</span> Resource agent: å››ç§åŸºæœ¬åŠŸèƒ½(start,stop,restart,status)</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">network partition: å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒº  </div><div class="line">éš”ç¦»ï¼š  </div><div class="line">STONITH: shoot the other node on the head (èŠ‚ç‚¹çº§åˆ«çš„éš”ç¦»)  </div><div class="line">Fence:èµ„æºçº§åˆ«çš„éš”ç¦»  </div><div class="line">é€šè¿‡äº¤æ¢æœºæ–­æ‰ç½‘ç»œï¼Œæˆ–è€…é€šè¿‡ç”µæºäº¤æ¢æœºï¼ŒæŠŠæœåŠ¡å™¨çš„ç”µæºåœä¸¢</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">é›†ç¾¤èŠ‚ç‚¹å¿…é¡»å¤§äºåŠæ•°ï¼Œè€Œéç­‰äº  </div><div class="line">æˆ–è€…åŠ ä¸€ä¸ªä»²è£è®¾å¤‡  </div><div class="line">é«˜å¯ç”¨èŠ‚ç‚¹ï¼Œåªèƒ½æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å·¥ä½œçš„çŠ¶æ€  </div><div class="line">ä½†å¯ä»¥åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œé…ç½®å‡ºæ¥å¤šä¸ªæœåŠ¡ï¼ŒN-Mæ¨¡å‹</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">failover domain: </div><div class="line">æ•…éšœè½¬ç§»åŸŸ </div><div class="line">fda: node1,node5  </div><div class="line">fdb: node2,node5 </div><div class="line">fdc: node3,node5 </div><div class="line">fdd: node4,node5</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">èµ„æºçš„çº¦æŸæ€§:</div><div class="line">ä½ç½®çº¦æŸï¼Œèµ„æºå¯¹èŠ‚ç‚¹çš„å€¾å‘æ€§; </div><div class="line">æ’åˆ—çº¦æŸï¼Œèµ„æºå½¼æ­¤é—´æ˜¯å¦èƒ½è¿è¡ŒäºåŒä¸€èŠ‚ç‚¹çš„å€¾å‘æ€§ï¼› </div><div class="line">é¡ºåºçº¦æŸï¼Œå¤šä¸ªèµ„æºå¯åŠ¨é¡ºåºä¾èµ–å…³ç³»ï¼›</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vote system:</div><div class="line">å°‘æ•°æœä»å¤šæ•°:quorum </div><div class="line">with quorum:æ‹¥æœ‰æ³•å®šç¥¨æ•°ï¼Œ( &gt; total/2 )</div><div class="line">without quorum:ä¸æ‹¥æœ‰æ³•å®šç¥¨æ•°  </div><div class="line">ä¸¤ä¸ªèŠ‚ç‚¹(å¶æ•°ä¸ªèŠ‚ç‚¹):</div><div class="line">Ping node </div><div class="line">qdisk </div><div class="line">failover (èµ„æºå°†è¦è½¬ç§»å‡ºå»)</div><div class="line">failback (èµ„æºå°†è¦è½¬ç§»å›æ¥)</div></pre></td></tr></table></figure><p>4ã€Messaging Layer:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">heartbeat,</div><div class="line">v1</div><div class="line">v2</div><div class="line">v3</div><div class="line">corosync,cman</div></pre></td></tr></table></figure><p>5ã€Cluster Resource Manager (CRM):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">heartbeat v1 haresources (é…ç½®æ¥å£:é…ç½®æ–‡ä»¶[haresources])</div><div class="line">heartbeat v2 crmï¼ˆåœ¨æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªcrmdå®ˆæŠ¤è¿›ç¨‹ï¼ˆ5560/tcpï¼‰ï¼Œæœ‰å‘½ä»¤è¡Œæ¥å£[crmsh],å¾ˆå¤§ç¨‹åº¦ä¸Šéœ€è¦ç¼–è¾‘xmlçš„é…ç½®æ–‡ä»¶ï¼‰; GUI;hb_gui</div><div class="line">heartbeat v3 pacemaker (å¿ƒè·³å¯è¯»å™¨) ï¼ˆé…ç½®æ¥å£:crmsh,pcs;GUI: hawk(suse),LCMC,pacemaker-gui)</div><div class="line">rgmanager ï¼ˆé…ç½®æ–‡ä»¶:cluster.conf,system-config-cluster,congaï¼ˆwebguiï¼‰, cman_tool, clustat,ï¼‰</div></pre></td></tr></table></figure><p>6ã€ç»„åˆæ–¹å¼: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">heartbeat v1 (haresources)</div><div class="line">heartbeat v2 (crm)</div><div class="line">heartbeat v3 + pacemaker </div><div class="line">heartbeat + pacemaker</div><div class="line">corosync + pacemaker </div><div class="line">corosync v1 + pacemaker (plugin)</div><div class="line">corosync v2 + pacemaker (standalone service)</div><div class="line">cman + rgmanger </div><div class="line">CentOS 6 cman + pacemaker  </div><div class="line">CentOS 6 (corosync v1 + cman +pacemaker) </div><div class="line">RHCS: Red Hat Cluster Suite</div><div class="line">RHEL5: cman + rgmanager + conga (ricci/luci)</div><div class="line">RHEL6: cman + rgmanager + conga (ricci/luci)</div><div class="line">corosync + pacemaker </div><div class="line">corosync + cman + pacemaker </div><div class="line">RHEL7: corosync + pacemaker</div></pre></td></tr></table></figure><p>7ã€èµ„æºä»£ç†: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Resource Agent:</div><div class="line">hearteat legacy: /etc/ha.d/haresources.d/ç›®å½•ä¸‹çš„è„šæœ¬ï¼›</div><div class="line">LSB: /etc/rc.d/init.d/ ç›®å½•ä¸‹çš„è„šæœ¬ï¼›</div><div class="line">OCF: Open Cluster Framework;</div><div class="line">provider: </div><div class="line">STONITHè®¾å¤‡:</div><div class="line">Systemctl:</div></pre></td></tr></table></figure><p>8ã€èµ„æºç±»å‹: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">primitive: ä¸»èµ„æºï¼ŒåŸå§‹èµ„æº:åœ¨é›†ç¾¤ä¸­åªèƒ½è¿è¡Œä¸€ä¸ªå®ä¾‹;</div><div class="line"><span class="built_in">clone</span>:å…‹éš†èµ„æºï¼Œåœ¨é›†ç¾¤ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªå®ä¾‹: </div><div class="line">åŒ¿åå…‹éš†ï¼Œå…¨å±€æƒŸä¸€å…‹éš†ã€çŠ¶æ€å…‹éš†(ä¸»åŠ¨ã€è¢«åŠ¨)</div><div class="line">multi-state(master/slave);å…‹éš†èµ„æºçš„ç‰¹æ®Šå®ç°;å¤šçŠ¶æ€èµ„æº:</div><div class="line">group: ç»„èµ„æº:</div><div class="line">å¯åŠ¨æˆ–åœæ­¢:</div><div class="line">èµ„æºç›‘è§†;</div><div class="line">ç›¸å…³æ€§;</div><div class="line">èµ„æºå±æ€§:</div><div class="line">priority:ä¼˜å…ˆçº§;</div><div class="line">target-role:started,stopped,master ç›®æ ‡è§’è‰²;</div><div class="line">is-managed:æ˜¯å¦å…è®¸ç¾¤é›†ç®¡ç†æ­¤èµ„æº;</div><div class="line">resource-stickiness: èµ„æºç²˜æ€§; </div><div class="line">allow-migrate:æ˜¯å¦å…è®¸èµ„æºè¿ç§»;</div><div class="line">çº¦æŸ:score</div><div class="line">ä½ç½®çº¦æŸ:èµ„æºå¯¹èŠ‚ç‚¹çš„å€¾å‘æ€§ï¼›</div><div class="line">(-oo,+oo)</div><div class="line">ä»»ä½•å€¼+æ— ç©·å¤§=æ— ç©·å¤§</div><div class="line">ä»»ä½•å€¼+è´Ÿæ— ç©·å¤§=è´Ÿæ— ç©·å¤§</div><div class="line">æ— ç©·å¤§+è´Ÿæ— ç©·å¤§=è´Ÿæ— ç©·å¤§</div><div class="line">æ’åˆ—çº¦æŸ:èµ„æºå½¼æ­¤é—´æ˜¯å¦èƒ½è¿è¡ŒåŒä¸€èŠ‚ç‚¹çš„å€¾å‘æ€§;</div><div class="line">(-oo,+oo)</div><div class="line">é¡ºåºçš„çº¦æŸ:å¤šä¸ªèµ„æºå¯åŠ¨é¡ºåºä¾èµ–å…³ç³»;</div><div class="line">(-oo,+oo)</div><div class="line">Mandatory</div></pre></td></tr></table></figure><h2 id="äºŒã€å®‰è£…é…ç½®"><a href="#äºŒã€å®‰è£…é…ç½®" class="headerlink" title="äºŒã€å®‰è£…é…ç½®"></a>äºŒã€å®‰è£…é…ç½®</h2><p>1ã€ CentOS 7: corosync v2 + pacemaker<br>        corosync v2: vote system<br>        pacemaker:ç‹¬ç«‹æœåŠ¡<br>    é›†ç¾¤çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å·¥å…·:<br>        pcs: agent(pcsd)<br>        crmsh : agentless (pssh)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum info pcs</span></div></pre></td></tr></table></figure><p>2ã€é›†ç¾¤é…ç½®å‰æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">aã€æ—¶é—´åŒæ­¥;</div><div class="line">bã€åŸºäºå½“å‰æ­£åœ¨ä½¿ç”¨çš„ä¸»æœºåäº’ç›¸è®¿é—®; </div><div class="line">cã€æ˜¯å¦ä¼šç”¨åˆ°ä»²è£è®¾å¤‡; </div><div class="line">eã€åŒæœºäº’ä¿¡</div></pre></td></tr></table></figure><p>3.1å®‰è£…å¹¶å¯åŠ¨pcsd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/hosts </span></div><div class="line">xx.xxx.xx.xxx node1.ssjinyao.com</div><div class="line">xx.xxx.xx.xxx node2.ssjinyao.com</div><div class="line"><span class="comment"># scp /etc/hosts root@node2.ssjinyao.com:/etc/</span></div><div class="line"><span class="comment"># date ; ssh root@node2.ssjinyao.com 'date' #æŸ¥çœ‹ä¸¤ä¸ªèŠ‚ç‚¹æœåŠ¡å™¨æ—¶é—´æ˜¯å¦ä¸€è‡´</span></div><div class="line"><span class="comment"># ntpdate date.xxx.com #è‹¥æœåŠ¡å™¨æ—¶é—´ä¸åŒæ­¥ï¼Œåˆ™åŒæ­¥æœåŠ¡å™¨çš„æ—¶é—´</span></div><div class="line"></div><div class="line">Node1 AND Node2</div><div class="line"><span class="comment"># yum install -y pacemaker pcs psmisc policycoreutils-python</span></div><div class="line"><span class="comment"># ä¹Ÿå¯ä»¥ yum insetall -y pcs </span></div><div class="line"><span class="comment"># systemctl start pcsd.service </span></div><div class="line"><span class="comment"># systemctl enable pcsd.service</span></div></pre></td></tr></table></figure><p>3.2 å„èŠ‚ç‚¹ç»Ÿä¸€æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/ansible</span></div><div class="line">[ha]</div><div class="line">node1.ssjinyao.com</div><div class="line">node2.ssjinyao.com</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Node1 AND Node2</div><div class="line"><span class="comment"># ansible ha -m service -a "name=pcsd state=started enabled=yes"</span></div><div class="line"><span class="comment"># systemctl status pcsd </span></div><div class="line"><span class="comment"># ansible ha -m shell -a 'echo "xxxxxx" | passwd --stdin hacluster'</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pcs help </span></div><div class="line"><span class="comment"># pcs cluster --help </span></div><div class="line"><span class="comment"># pcs cluster auth node1.ssjinyao.com node2.ssjinyao.com -u hacluster # pcsè®¤è¯é€šè¿‡</span></div><div class="line"><span class="comment"># pcs cluster setup --name jycluster node1.ssjinyao.com node2.ssjinyao.com</span></div><div class="line"><span class="comment"># cd /etc/corosync/</span></div><div class="line"><span class="comment"># cat corosync.conf </span></div><div class="line"><span class="comment"># æ³¨ totemæ˜¯ä¸“é—¨ä¼ é€’é›†ç¾¤é—´çš„å¿ƒè·³ä¿¡æ¯;</span></div><div class="line">     nodelist é›†ç¾¤ä¸­ç›®å‰å­˜çš„èŠ‚ç‚¹;</div><div class="line">     quorum æ³•å®šç¥¨æ•°çš„æŠ•ç¥¨æœºåˆ¶; corosync_votequorum; </div><div class="line"><span class="comment"># cd /etc/corosync/ &amp;&amp; cat corosync.conf.example.udpu # é†’çœ‹é›†ç¾¤é…ç½®å®ä¾‹; </span></div><div class="line"><span class="comment"># vim corosync.conf </span></div><div class="line">ä¿®æ”¹ loggin</div><div class="line">logging &#123;</div><div class="line">to_logfile:yes </div><div class="line">logfile: /var/<span class="built_in">log</span>/cluster/corosync.log </div><div class="line">&#125;</div><div class="line"><span class="comment"># scp corosync.conf node2.ssjinyao.com:/etc/corosync/</span></div></pre></td></tr></table></figure><p>3.3 å¯åŠ¨é›†ç¾¤ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">Node1 Or Node2 </div><div class="line"><span class="comment"># pcs cluster  start --all </span></div><div class="line"><span class="comment"># corosync-cfgtool --help </span></div><div class="line">æ£€æŸ¥å„èŠ‚ç‚¹é€šä¿¡çŠ¶æ€(æ˜¾ç¤ºä¸ºno faultså³ä¸ºOK):</div><div class="line"><span class="comment"># corosync-cfgtool -s </span></div><div class="line">Printing ring status.</div><div class="line">Local node ID 1 </div><div class="line">RING ID 0 </div><div class="line"> id = xx.xxx.xx.xxx</div><div class="line"> status = ring 0 active with no faults s</div><div class="line">åŒæ—¶ä¹Ÿå¯ä»¥åœ¨node2.ssjinyao.comä¸ŠæŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ </div><div class="line">æ£€æŸ¥é›†ç¾¤æˆå‘˜å…³åŠQuorum API:</div><div class="line"><span class="comment"># corosync-cmapctl | grep members </span></div><div class="line"><span class="comment"># pcs staus corosync </span></div><div class="line"><span class="comment"># pcs staus </span></div><div class="line">æŸ¥çœ‹pcsèµ„æºå¯é…ç½®é€‰é¡¹æœ‰å“ªäº›</div><div class="line"><span class="comment"># pcs property list --all</span></div><div class="line">æŸ¥çœ‹pcsé…ç½®æ˜¯å¦å­˜åœ¨é—®é¢˜</div><div class="line"><span class="comment"># crm_verify -L -V  </span></div><div class="line"><span class="comment"># pcs property se stonith-enabled=false </span></div><div class="line"><span class="comment"># pcs property list </span></div><div class="line"><span class="comment"># crm_verify -L -V</span></div></pre></td></tr></table></figure><p>3.4 crmsh ä¸‹è½½å¹¶å®‰è£… </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget crmsh-2.1.4.x86_64.rpm </span></div><div class="line"><span class="comment"># wget pssh-2.3.1-4.2.x86_64.rpm</span></div><div class="line"><span class="comment"># wget python-pssh-2.3.1-4.2.x86_64.rpm</span></div><div class="line"><span class="comment"># yum install -y *rpm </span></div><div class="line">æ³¨ crmsh æ‰¾ä¸€ä¸ªç»“ç‚¹å®‰è£…å°±å¯ä»¥ï¼Œå½“ç„¶ä¸¤ä¸ªèŠ‚ç‚¹å¯ä»¥éƒ½å®‰è£… </div><div class="line">pssh æ˜¯å¹¶è¡Œæ‰§è¡Œsshå‘½ä»¤</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># crm help </span></div><div class="line"><span class="comment"># crm status </span></div><div class="line"><span class="comment"># crm å¯ä»¥ç›´æ¥è¿›å…¥äº¤äº’å¼æ¥å£ </span></div><div class="line"><span class="comment"># help start </span></div><div class="line">&gt;crm(live)node<span class="comment"># configure </span></div><div class="line">&gt;crm(live)configure<span class="comment"># help </span></div><div class="line">&gt;crm(live)configure<span class="comment"># show</span></div><div class="line">&gt;crm(live)configure<span class="comment"># edit</span></div></pre></td></tr></table></figure><p>3.5 åˆ©ç”¨crmshé…ç½®ä¸€ä¸ªweb serice:<br>        vip:10.180.xxx.xx<br>        httpd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Node1 AND Node2</div><div class="line"><span class="comment"># yum -y install httpd </span></div><div class="line">Node1</div><div class="line"><span class="comment"># echo "&lt;h1&gt;node1.ssjinyao.com&lt;/h1&gt;" &gt; /var/www/html/index.html</span></div><div class="line"><span class="comment"># systemctl enabled httpd </span></div><div class="line">æ³¨:å¯¹äºCentOS 6 æ¥è¯´å¿…éœ€è¦ç¦ç”¨ </div><div class="line"><span class="comment"># systemctl stop httpd  </span></div><div class="line">Node2 </div><div class="line"><span class="comment"># echo "&lt;h1&gt;nodd2.ssjinyao.com&lt;/h1&gt;" &gt; /var/www/html/index.html</span></div><div class="line"><span class="comment"># systemctl enabled httpd </span></div><div class="line"><span class="comment"># systemctl stop httpd  </span></div><div class="line">æµ‹è¯•æœåŠ¡å™¨å¯ä»¥è®¿é—®åï¼Œå†å°†httpdæœåŠ¡åœæ­¢</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># crm    æˆ–è€… # crm ra </span></div><div class="line">&gt;crm(live)<span class="comment"># ra</span></div><div class="line">&gt;crm(live)ra<span class="comment"># list systemd</span></div><div class="line">&gt;crm(live)ra<span class="comment"># list ocf heartbeat </span></div><div class="line">&gt;crm(live)ra<span class="comment"># info ocf:heartbeat:IPaddr </span></div><div class="line">&gt;crm(live)ra<span class="comment"># info ocf:heartbeat:IPaddr </span></div><div class="line">&gt;crm(live)ra<span class="comment"># cd ..</span></div><div class="line">&gt;crm(live)<span class="comment"># configure </span></div><div class="line">&gt;crm(live)configure<span class="comment"># primitive webip ocf:heartbeat:IPaddr params ip=10.xxx.xx.xxx</span></div><div class="line">&gt;crm(live)<span class="comment"># status </span></div><div class="line"><span class="comment"># ifconfig å¯ä»¥çœ‹åˆ°èµ„æºå·²ç»é…ç½®å¥½äº† </span></div><div class="line">æŠŠå½“å‰ç»“ç‚¹å˜æˆå¤‡ç”¨æ¨¡å¼</div><div class="line">&gt;crm(live)node<span class="comment"># standby # è½¯ä¸‹çº¿</span></div><div class="line">&gt;crm(live)node<span class="comment"># status</span></div><div class="line">&gt;crm(live)<span class="comment"># node only</span></div><div class="line">&gt;crm(live)<span class="comment"># configure </span></div><div class="line">&gt;crm(live)configure <span class="comment"># primitive webserver systemd:httpd</span></div><div class="line">&gt;crm(live)configure <span class="comment"># verify</span></div><div class="line">&gt;crm(live)configure <span class="comment"># commit </span></div><div class="line">&gt;crm(live)configure <span class="comment"># group</span></div><div class="line">&gt;crm(live)configure <span class="comment"># grouop webservice webip webserivce </span></div><div class="line">&gt;crm(live)configure <span class="comment"># verfy</span></div><div class="line">&gt;crm(live)configure <span class="comment"># commit </span></div><div class="line"><span class="comment"># crm node standby </span></div><div class="line">æ³¨:å¯ä»¥æŸ¥çœ‹webè¯·æ±‚çš„åå›å†…å®¹ï¼Œä¸èµ„æºå®šä¹‰æƒ…å†µ;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># crm node onlie </span></div><div class="line"><span class="comment"># crm </span></div><div class="line">&gt;crm(live) <span class="comment"># configure</span></div><div class="line">&gt;crm(live)configure <span class="comment"># verify</span></div><div class="line"><span class="comment"># crm status </span></div><div class="line"><span class="comment"># systemctl stop  pacemaker.service corosync.serivce </span></div><div class="line"><span class="comment"># crm status </span></div><div class="line">åœ¨CentOS 6çš„æƒ…å†µä¸‹ï¼Œå‡å¦‚å°†æœåŠ¡å™¨ç›´æ¥å…³æœºåï¼Œä¼šé€ æˆ partition with quorum </div><div class="line"><span class="comment"># crm configure </span></div><div class="line">&gt;crm(live)configure <span class="comment"># property no-quorum-policy=ignore</span></div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>pythonè‡ªåŠ¨åŒ–ä¹‹adminè‡ªåŠ¨åˆ‡æ¢root</title>
      <link href="/2017/12/07/python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Badmin%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2root/"/>
      <url>/2017/12/07/python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Badmin%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2root/</url>
      <content type="html"><![CDATA[<h2 id="pythonè‡ªåŠ¨åŒ–ä¹‹adminè‡ªåŠ¨åˆ‡æ¢root"><a href="#pythonè‡ªåŠ¨åŒ–ä¹‹adminè‡ªåŠ¨åˆ‡æ¢root" class="headerlink" title="pythonè‡ªåŠ¨åŒ–ä¹‹adminè‡ªåŠ¨åˆ‡æ¢root"></a>pythonè‡ªåŠ¨åŒ–ä¹‹adminè‡ªåŠ¨åˆ‡æ¢root</h2><blockquote><p>sshç™»å½•ç³»ç»Ÿï¼Œå¦‚æœæ˜¯érootå¸å·(æ™®é€šå¸å·)ç™»å½•é‡‡å–è¡ŒåŠ¨ï¼Œåˆ™suåˆ‡æ¢åˆ°root</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/env/bin python</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># des:sshç™»å½•ç³»ç»Ÿï¼Œå¦‚æœæ˜¯érootå¸å·(æ™®é€šå¸å·)ç™»å½•é‡‡å–è¡ŒåŠ¨ï¼Œåˆ™suåˆ‡æ¢åˆ°root</span></div><div class="line"></div><div class="line"><span class="comment"># python çš„SSHV2 protocolåè®®å®ç°ï¼Œç”¨äºpythonè°ƒç”¨å„ç§sshåŠŸèƒ½;</span></div><div class="line"><span class="keyword">import</span> paramiko </div><div class="line"><span class="comment"># pythonå†…ç½®æ—¶é—´æ¨¡å—</span></div><div class="line"><span class="keyword">import</span> time </div><div class="line"></div><div class="line"><span class="comment">#æ ¹æ®ç”¨æˆ·åå¯†ç ä»æ™®é€šç”¨æˆ·æ½æƒåˆ°rootç”¨è®°æ‰§è¡Œç»™å®šå‘½ä»¤</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssh_su_root</span><span class="params">(ip,username,password,root_pwd,cmd)</span>:</span></div><div class="line"><span class="comment">#å»ºç«‹SSHClientå¯¹è±¡</span></div><div class="line">    myssh = paramiko.SSHClient()</div><div class="line"><span class="comment">#è®¾ç½®è‡ªåŠ¨æ¥æ”¶å…¬é’¥</span></div><div class="line">    myssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</div><div class="line">    <span class="keyword">try</span>:</div><div class="line"><span class="comment">#ä½¿ç”¨ç»™å®šç”¨æˆ·åå¯†ç å°è¯•è¿æ¥æœåŠ¡å™¨</span></div><div class="line">         myssh.connect(ip, <span class="number">22</span>, username=username, password=password, timeout=<span class="number">4</span>)</div><div class="line">    <span class="keyword">except</span> Exception, ex:</div><div class="line">        <span class="keyword">print</span> str(ex)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="comment"># å¦‚æœé»˜è®¤rootä¸å…è®¸è¿œç¨‹ç™»å½•ï¼Œæä¾›çš„æ˜¯æ™®é€šç”¨æˆ·å¸å·+rootå¸å·,</span></div><div class="line">    <span class="comment">#åˆ™è°ƒç”¨invoke_shell,ä½¿ç”¨äº¤äº’å¼shellæ–¹å¼åˆ‡æ¢åŒåˆ°rootå¸å·ï¼Œå¹¶æ‰§è¡Œå‘½ä»¤ã€‚</span></div><div class="line">    <span class="keyword">if</span> username != <span class="string">'root'</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"I am NOT root"</span></div><div class="line">        ssh = myssh.invoke_shell()</div><div class="line">        time.sleep(<span class="number">0.2</span>)</div><div class="line">        ssh.send(<span class="string">'su -\n'</span>)</div><div class="line">        buff = <span class="string">''</span></div><div class="line">    <span class="comment">#å¾ªç¯æ£€æµ‹å¯†ç è¾“å…¥æç¤ºï¼Œå‡ºç°åå‘é€rootå£ä»¤ï¼Œ</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> (buff.endswith(<span class="string">'Password:'</span>) <span class="keyword">or</span> buff.endswith(<span class="string">'å¯†ç : '</span>)):</div><div class="line">    <span class="comment">#ä»æ¥æ”¶ç¼“å­˜ä¸­è¯»å…¥æœ€å¤š9999bytesæ•°æ®ã€‚</span></div><div class="line">            resp = ssh.recv(<span class="number">9999</span>)</div><div class="line">            buff += resp </div><div class="line">        ssh.send(root_pwd)</div><div class="line">        ssh.send(<span class="string">'\n'</span>)</div><div class="line">        buff = <span class="string">''</span></div><div class="line">    <span class="comment">#å¾ªç¯æ£€æµ‹#æç¤ºç¬¦ï¼Œå‡ºç°åæ‰§è¡Œä¼ å…¥çš„å‘½ä»¤ã€‚</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> buff.endwith(<span class="string">'# '</span>):</div><div class="line">            resp = ssh.recv(<span class="number">9999</span>)</div><div class="line">            buff += resp </div><div class="line">        ssh.send[cmd]</div><div class="line">        ssh.send(<span class="string">'\n'</span>)</div><div class="line">        </div><div class="line">        buff =<span class="string">''</span></div><div class="line">    <span class="comment">#å¾ªç¯æ£€æµ‹#æç¤ºç¬¦ï¼Œæ„å‘³ç€å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œå‡ºç°åå…³é—­sshè¿æ¥å¹¶è¾“å‡ºç»“æœã€‚</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> buff.endswith(<span class="string">'# '</span>):</div><div class="line">            resp = ssh.recv(<span class="number">9999</span>)</div><div class="line">            buff += resp</div><div class="line">        myssh.close()</div><div class="line">        result = buff</div><div class="line">        <span class="keyword">print</span> <span class="string">"su root result ---&gt;"</span>,result </div><div class="line"></div><div class="line">        myssh.close()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">    <span class="comment">#å¦‚æœæä¾›çš„æ˜¯rootå¸å·ï¼Œåˆ™ç›´æ¥è°ƒç”¨paramiko exec_command æ–¹æ³•ï¼Œæ‰§è¡Œå‘½ä»¤ã€‚</span></div><div class="line">        </div><div class="line">        <span class="keyword">print</span> <span class="string">"I am root"</span></div><div class="line">        stdin, stdout, stderr = myssh.exec_command(cmd)</div><div class="line">        stdin,write(<span class="string">"Y"</span>)</div><div class="line">        <span class="keyword">print</span> <span class="string">"stdout.readlines() ---&gt;"</span>, stdout.readlines()</div><div class="line">        myssh.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    cmd = <span class="string">'date'</span></div><div class="line">    ip = <span class="string">'xx.xxx.xx.xxx'</span></div><div class="line">    username = <span class="string">'admin'</span></div><div class="line">    password = <span class="string">'xxxxxxxxxx'</span></div><div class="line">    ssh_su_root(ip, username, password, <span class="string">'xxxxxxxxxxxx'</span>, cmd)</div><div class="line">    username = <span class="string">'root'</span></div><div class="line">    ssh_su_root(ip, username, password, <span class="string">'xxxxxxxxxxxx'</span>, cmd)</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å®‰å…¨åŠ å›º</title>
      <link href="/2017/12/03/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"/>
      <url>/2017/12/03/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/</url>
      <content type="html"><![CDATA[<h1 id="å®‰å…¨åŠ å›º"><a href="#å®‰å…¨åŠ å›º" class="headerlink" title="å®‰å…¨åŠ å›º"></a>å®‰å…¨åŠ å›º</h1><h2 id="å®‰å…¨åŠ å›ºè„šæœ¬V1"><a href="#å®‰å…¨åŠ å›ºè„šæœ¬V1" class="headerlink" title="å®‰å…¨åŠ å›ºè„šæœ¬V1"></a>å®‰å…¨åŠ å›ºè„šæœ¬V1</h2><ul><li>ç”¨æ¥åšiptables sshåœ°å€ç™½åå•é™åˆ¶</li><li>openssh-server sshç”¨æˆ·ç™½åå•é™åˆ¶</li><li>æ›´æ”¹ç™»å½•æ¬¢è¿ä¿¡æ¯ä¸ºè­¦å‘Šä¿¡æ¯</li><li>åº”ç”¨æ ¹ç›®å½•æƒé™æœ€å°åŒ–</li><li>zabbix agentå®‰è£…é…ç½®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç¨‹åºç”±å‰å¾€åæ‰§è¡Œï¼Œæ¬¡é¡ºåºéå¸¸é‡è¦ï¼Œä¸€ä¸å°å¿ƒä¼šå°†è‡ªå·±æ‹’åœ¨å¤–é¢ï¼Œé‡åˆ°è¿™ç§æƒ…å†µè®©è§„åˆ™å¤±æ•ˆçš„å¤„ç†æ–¹å¼æ˜¯é‡å¯æœå™¨ï¼Œæˆ–è€…ä»é˜¿é‡Œäº‘æ¥æ¥å£æ¥å…¥æ¸…ç©ºè§„åˆ™ï¼Œå¯é€‰åè€…ï¼›</span></div><div class="line"><span class="comment">#æ³¨zabbix(xxx.xx.xxx.xx)\xx.xx.xx.xxxä¸»æœºä¸åŠ å…¥iptablesè§„åˆ™ </span></div><div class="line"><span class="function"><span class="title">IP_TABLES</span></span> () &#123;</div><div class="line">/sbin/iptables -A INPUT -p tcp --dport 22 -s xxx.xxx.xx.xx -j ACCEPT <span class="comment">#é¦–å…ˆæ”¾è¡Œ xxx.xxx.xxx.xxx æˆ‘ä»¬å†…ç½‘è·¯ç”±åœ°å€</span></div><div class="line">/sbin/iptables -A INPUT -p tcp --dport 22 -s xxx.xxx.xx.xx -j ACCEPT <span class="comment">#æ”¾è¡Œå¤‡ç”¨åœ°å€ xxx.xxx.xx.xxx åŒæ—¶ä¹Ÿæ˜¯æˆ‘ä»¬çš„zabbixåœ°å€</span></div><div class="line">/sbin/iptables -A INPUT -p tcp --dport 22 -s xxx.xxx.xx.xx  -j ACCEPT <span class="comment">#æ­¤æœåŠ¡å™¨ä¸ºæˆ‘ä»¬é—²ç½®çš„ä¸€å°æœåŠ¡å™¨</span></div><div class="line">/sbin/iptables -A INPUT -p tcp --dport 22 -j DROP <span class="comment">#ä¸¢å¼ƒæ‰€æœ‰å¯¹22å·ç«¯å£çš„è¯·æ±‚</span></div><div class="line">iptables -vnL <span class="comment">#æŸ¥çœ‹é˜²ç«å¢™è®¾ç½®</span></div><div class="line">&#125;</div><div class="line"><span class="comment">#æ·»åŠ å”¯ä¸€å¯ä»¥ç™»å½•æœåŠ¡å™¨çš„ç”¨æˆ·</span></div><div class="line"><span class="function"><span class="title">SSH_INIT</span></span> () &#123;</div><div class="line">useradd xxxxxxxx <span class="comment">#æ·»åŠ ç”¨æˆ·</span></div><div class="line">cp -a /etc/skel /home/xxxxxxxx</div><div class="line">chown -R xxxxxxxx.xxxxxxxx /home/TransferEasyd0--01 </div><div class="line">usermod -s /bin/bash xxxxxxxx </div><div class="line">PASS=<span class="string">'xxxxxxxxxx'</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"xxxxxxxx:<span class="variable">$PASS</span>"</span> | chpasswd <span class="comment">#ç»™ç”¨æˆ·è®¾ç½®å¯†ç  </span></div><div class="line"><span class="built_in">echo</span> <span class="string">"AllowUsers xxxxxxxx"</span> &gt;&gt; /etc/ssh/sshd_config <span class="comment">#æ·»åŠ ç™½åå•åˆ°sshd_configä¸­</span></div><div class="line">service  ssh restart   <span class="comment">#é‡å¯æœåŠ¡å™¨</span></div><div class="line">&#125;</div><div class="line"><span class="comment">#Webæ ¹ç›®å½•æƒé™æœ€å°åŒ–</span></div><div class="line"><span class="function"><span class="title">PY_INIT</span></span> () &#123;</div><div class="line">chmod 700 /home/admin/</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">WEB_INIT</span></span> () &#123;</div><div class="line">chown www-data.www-data  /var/www/html &amp;&amp; chmod 700 /var/www/html <span class="comment">#è®¾ç½®å¯åŠ¨ç”¨æˆ·å’Œç”¨å¯åŠ¨ç»„éƒ½ä¸ºwww-dataç”¨æˆ·ï¼Œè®¾ç½®æ‰€æœ‰è€…æƒé™è¯»\å†™\æ‰§è¡Œ; æ‰€å±ç»„0; å…¶å®ƒäºº0;</span></div><div class="line">usermod -s /sbin/nologin www-data  <span class="comment">#å®Œå…¨ç¦æ­¢www-dataç”¨æˆ·ç™»å½•</span></div><div class="line">cat /etc/passwd | grep --color www-data  <span class="comment">#æŸ¥çœ‹ä¿®æ”¹ç™»å½• </span></div><div class="line">ls -ld /var/www/html  <span class="comment">#æŸ¥çœ‹ä¿®æ”¹æƒé™</span></div><div class="line">&#125;</div><div class="line"><span class="comment">#æ›´æ”¹æ¬¢è¿ä¿¡æ¯ä¸ºè­¦å‘Šä¿¡æ¯</span></div><div class="line"><span class="function"><span class="title">MO_TD</span></span> () &#123;</div><div class="line">[ -e /etc/.motd.bak ] || cp /etc/motd /etc/.motd.bak</div><div class="line">cat &lt;&lt;EOF &gt; /etc/motd</div><div class="line">éxxxxxxxxç®¡ç†äººå‘˜è¯·å‹¿ç™»å½•ç³»ç»Ÿï¼Œå¦åˆ™åæœè‡ªè´Ÿ</div><div class="line">éxxxxxxxxç®¡ç†äººå‘˜è¯·å‹¿ç™»å½•ç³»ç»Ÿï¼Œå¦åˆ™åæœè‡ªè´Ÿ</div><div class="line">Non xxxxxxxx administrators are not allowed to <span class="built_in">log</span> on to the system, otherwise they may be affected</div><div class="line">EOF</div><div class="line">[ -e /etc/update-motd.d/.00-header.bak ] || cp /etc/update-motd.d/00-header /etc/update-motd.d/.00-header.bak</div><div class="line">cat &lt;&lt;EOF &gt; /etc/update-motd.d/00-header</div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">[ -r /etc/lsb-release ] &amp;&amp; . /etc/lsb-release</div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$DISTRIB_DESCRIPTION</span>"</span> ] &amp;&amp; [ -x /usr/bin/lsb_release ]; <span class="keyword">then</span></div><div class="line"><span class="comment"># Fall back to using the very slow lsb_release utility</span></div><div class="line">DISTRIB_DESCRIPTION=$(lsb_release -s -d)</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"xxxxxxxx %s (%s %s %s)\n"</span> <span class="string">"<span class="variable">$DISTRIB_DESCRIPTION</span>"</span> <span class="string">"<span class="variable">$(uname -o)</span>"</span> <span class="string">"<span class="variable">$(uname -r)</span>"</span> <span class="string">"<span class="variable">$(uname -m)</span>"</span></div><div class="line">EOF</div><div class="line">[ -e /etc/.lsb-release.bak ] || cp /etc/lsb-release /etc/.lsb-release.bak</div><div class="line">cat &lt;&lt;EOF &gt; /etc/lsb-release </div><div class="line">DISTRIB_ID=CentOS</div><div class="line">DISTRIB_RELEASE=10000</div><div class="line">DISTRIB_CODENAME=trusty</div><div class="line">DISTRIB_DESCRIPTION=<span class="string">"CentOS 1000"</span></div><div class="line">EOF</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">ZAB_BBIX</span></span> () &#123;</div><div class="line">   apt-get install zabbix-agent </div><div class="line">mv /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak</div><div class="line">cp /home/admin/zabbix_agentd.conf /etc/zabbix/</div><div class="line">cp /home/admin/zabbix_agentd.conf /tmp</div><div class="line">service zabbix-agent restart </div><div class="line">&#125;</div><div class="line">IP_TABLES</div><div class="line">SSH_INIT</div><div class="line">PY_INIT</div><div class="line">WEB_INIT</div><div class="line">MO_TD</div><div class="line">ZAB_BBIX</div></pre></td></tr></table></figure><h2 id="å¯¹åº”å›æ»šè„šæœ¬"><a href="#å¯¹åº”å›æ»šè„šæœ¬" class="headerlink" title="å¯¹åº”å›æ»šè„šæœ¬"></a>å¯¹åº”å›æ»šè„šæœ¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#å®‰å…¨åŠ å›ºåï¼ŒæœåŠ¡å™¨å¦‚æœ‰é—®é¢˜æ—¶çš„å›æ»šæ–¹æ¡ˆï¼›</span></div><div class="line"><span class="function"><span class="title">IP_TABLES_F</span></span> () &#123;</div><div class="line">iptables -F</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">SSH_INIT_F</span></span> () &#123;</div><div class="line">sed -i <span class="string">'s/AllowUsers xxxxxxxx//g'</span> /etc/ssh/sshd_config</div><div class="line">userdel xxxxxxxx</div><div class="line">service ssh restart</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">WEB_INIT_F</span></span> () &#123;</div><div class="line">chmod 700 /var/www/html</div><div class="line">chown admin.admin /var/www/html</div><div class="line">usermod -s /sbin/<span class="literal">false</span> www-data</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">PY_INIT_F</span></span> () &#123;</div><div class="line">chmod 700 /home/admin</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">MO_TD_F</span></span>() &#123;</div><div class="line">rm -rf /etc/motd</div><div class="line">mv /etc/.motd.bak /etc/motd</div><div class="line">rm -rf /etc/update-motd.d/00-header</div><div class="line">mv  /etc/update-motd.d/.00-header.bak /etc/update-motd.d/00-header</div><div class="line">rm -rf /etc/lsb-release</div><div class="line">mv /etc/.lsb-release.bak /etc/lsb-release</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="title">ZA_BBIX_F</span></span> () &#123;</div><div class="line">service zabbix-agent stop</div><div class="line">apt-get remove zabbix-agent</div><div class="line">rm -rf /etc/zabbix/</div><div class="line">&#125;</div><div class="line"></div><div class="line">IP_TABLES_F</div><div class="line">SSH_INIT_F</div><div class="line">WEB_INIT_F</div><div class="line">MO_TD_F</div><div class="line">ZA_BBIX_F</div><div class="line">PY_INIT_F</div></pre></td></tr></table></figure><h1 id="å¯¹æ— agentæ¢é’ˆçš„RDSç½‘ç»œç›‘æ§"><a href="#å¯¹æ— agentæ¢é’ˆçš„RDSç½‘ç»œç›‘æ§" class="headerlink" title="å¯¹æ— agentæ¢é’ˆçš„RDSç½‘ç»œç›‘æ§"></a>å¯¹æ— agentæ¢é’ˆçš„RDSç½‘ç»œç›‘æ§</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#ç”¨æˆ·RDSé€šçŸ¥åŠæŠ¥è­¦</span></div><div class="line"><span class="comment">#ä½œè€…ï¼šä»»é”¦</span></div><div class="line"><span class="comment">#RDS_IP="localhost"</span></div><div class="line">RDS_IP=<span class="string">"www.xxxxxxxx.com"</span></div><div class="line"><span class="function"><span class="title">TOOL_S</span></span> () &#123; </div><div class="line">    rpm -qa nc &amp;&gt; /dev/null || yum -y install nc</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">ON_LINE</span></span> () &#123;</div><div class="line">    DATE=`date | awk <span class="string">'&#123;print $4&#125;'</span> | cut -d<span class="string">":"</span> -f3`</div><div class="line">        <span class="built_in">echo</span> -e <span class="string">"\n\n"</span> |nc -w 5 <span class="variable">$RDS_IP</span> 3306 &amp;&gt; /dev/null || STATP=<span class="string">"RDS æœåŠ¡å™¨å·²ç»åœæ­¢äº†è¿è¡Œï¼Œè¯·æ‚¨å°½å¿«æ¥å¤„ç† ğŸ˜°  ğŸ˜°  ğŸ˜°  ğŸ˜°  ğŸ˜°  ğŸ˜°  "</span></div><div class="line">        <span class="comment">#echo $STATP</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">WEI_XIN</span></span> () &#123;</div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$STATP</span>"</span> --user=xxx@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$STATP</span>"</span> --user=xxx2@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$STATP</span>"</span> --user=xxx3@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$STATP</span>"</span> --user=xxx4@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null  </div><div class="line"></div><div class="line"><span class="keyword">while</span> sleep 60 ; <span class="keyword">do</span> </div><div class="line">TOOL_S</div><div class="line">ON_LINE</div><div class="line">WEI_XIN </div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure><h1 id="é™¤çº¿ä¸Šzabbixå¤šè§’åº¦çš„ç›‘æ§ç½‘ç»œçŠ¶æ€"><a href="#é™¤çº¿ä¸Šzabbixå¤šè§’åº¦çš„ç›‘æ§ç½‘ç»œçŠ¶æ€" class="headerlink" title="é™¤çº¿ä¸Šzabbixå¤šè§’åº¦çš„ç›‘æ§ç½‘ç»œçŠ¶æ€"></a>é™¤çº¿ä¸Šzabbixå¤šè§’åº¦çš„ç›‘æ§ç½‘ç»œçŠ¶æ€</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="function"><span class="title">HOSTS</span></span> ()  &#123;</div><div class="line">        CN=<span class="string">'xxx.xxx.xxx.xxx xxx.xxx.xx.xx.xxx xxx.xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx'</span></div><div class="line">        HK=<span class="string">'xxx.xxx.xxx.xxx xxx.xxx.xx.xx.xxx xxx.xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx'</span></div><div class="line">        XN=<span class="string">'xxx.xxx.xxx.xxx xxx.xxx.xx.xx.xxx xxx.xxx.xxx.xxx.xxx xxx.xxx.xxx.xxx'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">MESSAGES</span></span> () &#123;</div><div class="line">        OK_MESSAGES_CN=<span class="string">'é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œæ­£å¸¸'</span></div><div class="line">        OK_MESSAGES_HK=<span class="string">'é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œæ­£å¸¸'</span></div><div class="line">        OK_MESSAGES_XN=<span class="string">'é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œæ­£å¸¸'</span></div><div class="line">        CN_MES=<span class="string">'é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œä¸é€šï¼'</span></div><div class="line">        HK_MES=<span class="string">'é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œä¸é€šï¼'</span></div><div class="line">        XN_MES=<span class="string">'é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œä¸é€šï¼'</span></div><div class="line">        CN_MES_TIME=<span class="string">"é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œè¶…æ—¶è¾ƒé«˜ï¼Œè¶…æ—¶æ—¶é—´åŠä¸¢åŒ…ç‡ä¸º"</span></div><div class="line">        HK_MES_TIME=<span class="string">"é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œè¶…æ—¶è¾ƒé«˜ï¼Œè¶…æ—¶æ—¶é—´åŠä¸¢åŒ…ç‡ä¸º"</span></div><div class="line">        XN_MES_TIME=<span class="string">"é˜¿é‡Œäº‘xxåŒºåŸŸECSä¸»æœºç½‘ç»œè¶…æ—¶è¾ƒé«˜ï¼Œè¶…æ—¶æ—¶é—´åŠä¸¢åŒ…ç‡ä¸º"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">WEIXIN_E-<span class="function"><span class="title">MAIL_API</span></span> () &#123;</div><div class="line"><span class="comment">#       echo "$1</span></div><div class="line"><span class="comment">#       $2" | mutt -s "Zabbix æŠ¥è­¦" xxx@xxxxxxxxxxx.com  xxx2.xxxxxxxxxxxx.com  xxx3@xxxxxxxxxxx.com</span></div><div class="line"></div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --</div><div class="line">corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$1</span></span></div><div class="line"><span class="string"><span class="variable">$2</span>"</span> --user=xxx@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </div><div class="line"></div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$1</span></span></div><div class="line"><span class="string"><span class="variable">$2</span>"</span> --user=xxx2@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </div><div class="line"></div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$1</span></span></div><div class="line"><span class="string"><span class="variable">$2</span>"</span> --user=xxx3@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </div><div class="line"></div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"<span class="variable">$1</span></span></div><div class="line"><span class="string"><span class="variable">$2</span>"</span> --user=xxx4@xxxxxxxxxxx.com --agentid=xxxxxx02 &amp;&gt; /dev/null </div><div class="line">&#125;</div><div class="line">HOSTS</div><div class="line">MESSAGES</div><div class="line"></div><div class="line"><span class="keyword">for</span> HOSTS_NET_CN <span class="keyword">in</span> <span class="variable">$CN</span></div><div class="line">        <span class="keyword">do</span></div><div class="line">                STATE_CN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_CN</span> | tail -n 2 | head -n 1 | awk &#123;<span class="string">'print $6'</span>&#125;`</div><div class="line">                TIME_CN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_CN</span> | head -n 3 | tail -n2 | awk &#123;<span class="string">'print $7,$8'</span>&#125;`</div><div class="line">                <span class="keyword">if</span> ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_CN</span> &amp;&gt; /dev/null ;<span class="keyword">then</span></div><div class="line">                        <span class="built_in">echo</span> <span class="string">"<span class="variable">$OK_MESSAGES_CN</span> `date` <span class="variable">$HOSTS_NET_CN</span>  OK"</span> &amp;&gt;&gt; /tmp/<span class="variable">$HOSTS_NET_CN</span></div><div class="line">                <span class="keyword">else</span></div><div class="line">                        WEIXIN_E-MAIL_API <span class="string">"<span class="variable">$CN_MES</span> `date` <span class="variable">$HOSTS_NET_CN</span> <span class="variable">$CN_MES_TIME</span> <span class="variable">$STATE_CN</span></span></div><div class="line"><span class="string">                        <span class="variable">$TIME_CN</span>"</span> <span class="string">"PROBLEM"</span></div><div class="line">                <span class="keyword">fi</span></div><div class="line">        <span class="keyword">done</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">for</span> HOSTS_NET_HK <span class="keyword">in</span> <span class="variable">$HK</span></div><div class="line">        <span class="keyword">do</span></div><div class="line">                STATE_HK=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_HK</span> | tail -n 2 | head -n 1 | awk &#123;<span class="string">'print $6'</span>&#125;`</div><div class="line">                TIME_HK=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_HK</span> | head -n 3 | tail -n2 | awk &#123;<span class="string">'print $7,$8'</span>&#125;`</div><div class="line">                <span class="keyword">if</span> ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_HK</span> &amp;&gt; /dev/null ; <span class="keyword">then</span></div><div class="line">                        <span class="built_in">echo</span> <span class="string">"<span class="variable">$OK_MESSAGES_HK</span> `date` <span class="variable">$HOSTS_NET_HK</span>  OK"</span> &amp;&gt;&gt; /tmp/<span class="variable">$HOSTS_NET_HK</span></div><div class="line">                <span class="keyword">else</span></div><div class="line">                        WEIXIN_E-MAIL_API <span class="string">"<span class="variable">$HK_MES</span> `date` <span class="variable">$HOSTS_NET_HK</span> <span class="variable">$HK_MES_TIME</span> <span class="variable">$STATE_HK</span></span></div><div class="line"><span class="string">                <span class="variable">$TIME_HK</span>"</span> <span class="string">"PROBLEM"</span></div><div class="line">                <span class="keyword">fi</span></div><div class="line">        <span class="keyword">done</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">for</span> HOSTS_NET_XN <span class="keyword">in</span> <span class="variable">$XN</span></div><div class="line">        <span class="keyword">do</span></div><div class="line">                STATE_XN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_XN</span> | tail -n 2 | head -n 1 | awk &#123;<span class="string">'print $6'</span>&#125;`</div><div class="line">                TIME_XN=`ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_XN</span> | head -n 3 | tail -n2 | awk &#123;<span class="string">'print $7,$8'</span>&#125;`</div><div class="line">                <span class="keyword">if</span> ping -c 2  -W 1  -S 1 <span class="variable">$HOSTS_NET_XN</span> &amp;&gt; /dev/null ; <span class="keyword">then</span></div><div class="line">                        <span class="built_in">echo</span> <span class="string">"<span class="variable">$OK_MESSAGES_XN</span> `date` <span class="variable">$HOSTS_NET_XN</span>  OK"</span> &amp;&gt;&gt; /tmp/<span class="variable">$HOSTS_NET_XN</span></div><div class="line">                <span class="keyword">else</span></div><div class="line">                        WEIXIN_E-MAIL_API <span class="string">"<span class="variable">$XN_MES</span> `date` <span class="variable">$HOSTS_NET_XN</span> <span class="variable">$XN_MES_TIME</span> <span class="variable">$STATE_XN</span></span></div><div class="line"><span class="string">                <span class="variable">$TIME_XN</span>"</span> <span class="string">"PROBLEM"</span></div><div class="line">                <span class="keyword">fi</span></div><div class="line">        <span class="keyword">done</span></div></pre></td></tr></table></figure><h2 id="å°†å¯¹åº”çš„è„šæœ¬åŠ å…¥å®šæ—¶è®¡åˆ’"><a href="#å°†å¯¹åº”çš„è„šæœ¬åŠ å…¥å®šæ—¶è®¡åˆ’" class="headerlink" title="å°†å¯¹åº”çš„è„šæœ¬åŠ å…¥å®šæ—¶è®¡åˆ’"></a>å°†å¯¹åº”çš„è„šæœ¬åŠ å…¥å®šæ—¶è®¡åˆ’</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">crontab -e</div><div class="line">*/3 * * * * /bin/bash /root/bin/ds.sh</div></pre></td></tr></table></figure><h2 id="å…³äº-bin-weixin"><a href="#å…³äº-bin-weixin" class="headerlink" title="å…³äº/bin/weixin"></a>å…³äº/bin/weixin</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">é“¾æ¥:http://pan.baidu.com/s/1slcAlTb  å¯†ç :f3gz</div><div class="line">weixinæ¥å£çš„è°ƒç”¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä¼ä¸šå¾®ä¿¡æ¥é…ç½®ä¸€ä¸ªæ¥å£</div><div class="line">muttå‘çŸ­ä¿¡ï¼Œmutt+msmtpé…ç½®ä½¿ç”¨</div></pre></td></tr></table></figure><h2 id="åˆ é™¤mongoè¡¨ä¸­çš„æŸä¸€å­—æ®µ"><a href="#åˆ é™¤mongoè¡¨ä¸­çš„æŸä¸€å­—æ®µ" class="headerlink" title="åˆ é™¤mongoè¡¨ä¸­çš„æŸä¸€å­—æ®µ"></a>åˆ é™¤mongoè¡¨ä¸­çš„æŸä¸€å­—æ®µ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.screening_sections.remove(&#123;<span class="string">'no'</span>:<span class="string">'5a279c19756a7'</span>&#125;)</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>gitlabå¤‡ä»½ä¸è¿ç§»</title>
      <link href="/2017/11/22/gitlab%E5%A4%87%E4%BB%BD%E4%B8%8E%E8%BF%81%E7%A7%BB/"/>
      <url>/2017/11/22/gitlab%E5%A4%87%E4%BB%BD%E4%B8%8E%E8%BF%81%E7%A7%BB/</url>
      <content type="html"><![CDATA[<h1 id="gitlabçš„å¤‡ä»½ä¸åŒæ­¥"><a href="#gitlabçš„å¤‡ä»½ä¸åŒæ­¥" class="headerlink" title="gitlabçš„å¤‡ä»½ä¸åŒæ­¥"></a>gitlabçš„å¤‡ä»½ä¸åŒæ­¥</h1><h2 id="gitlabå¤‡ä»½"><a href="#gitlabå¤‡ä»½" class="headerlink" title="gitlabå¤‡ä»½"></a>gitlabå¤‡ä»½</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sudo gitlab-rake gitlab:backup:create</span></div><div class="line"><span class="comment"># sudo scp -r /var/opt/gitlab/backups/ root@xx.xxx.xx.xxx:/root</span></div></pre></td></tr></table></figure><h2 id="ç”±äºç‰ˆæœ¬é—®é¢˜ï¼Œåœ¨è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…åŒæ ·ç‰ˆæœ¬"><a href="#ç”±äºç‰ˆæœ¬é—®é¢˜ï¼Œåœ¨è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…åŒæ ·ç‰ˆæœ¬" class="headerlink" title="ç”±äºç‰ˆæœ¬é—®é¢˜ï¼Œåœ¨è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…åŒæ ·ç‰ˆæœ¬"></a>ç”±äºç‰ˆæœ¬é—®é¢˜ï¼Œåœ¨è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…åŒæ ·ç‰ˆæœ¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># scp gitlab-ci-multi-runner_1.4.2_amd64.deb gitlab-ce_8.6.2-ce.0_amd64.deb root@xx.xxx.xx.xxx:/root</span></div><div class="line"><span class="comment"># è‹¥æ— æ­¤ç‰ˆæœ¬çš„å¤‡ä»½åŒ…æ—¶é€‰æ‹©ä»¥ä¸‹æ–¹å¼ä¸‹è½½</span></div><div class="line">é“¾æ¥:http://pan.baidu.com/s/1eS4H6NK  å¯†ç :e7i6</div></pre></td></tr></table></figure><h2 id="è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…ä¸æ¢å¤"><a href="#è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…ä¸æ¢å¤" class="headerlink" title="è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…ä¸æ¢å¤"></a>è¿ç§»ç›®æ ‡ä¸»æœºå®‰è£…ä¸æ¢å¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># dpkg -i /root/gitlab-ci-multi-runner_1.4.2_amd64.deb</span></div><div class="line"><span class="comment"># dpkg -i /root/gitlab-ce_8.6.2-ce.0_amd64.deb </span></div><div class="line"><span class="comment"># mv /root/1510889754_gitlab_backup.tar /var/opt/gitlab/backups/</span></div><div class="line"><span class="comment"># gitlab-rake gitlab:backup:restore BACKUP=1510889754</span></div><div class="line"><span class="comment"># gitlab-ctl start</span></div><div class="line"><span class="comment"># vim /etc/gitlab/gitlab.rb</span></div><div class="line"> unicorn[<span class="string">'listen'</span>] = <span class="string">'0.0.0.0'</span></div><div class="line"> unicorn[<span class="string">'port'</span>] = 8080</div><div class="line"><span class="comment"># gitlab-ctl reconfigure</span></div><div class="line"><span class="comment"># gitlab-ctl start</span></div></pre></td></tr></table></figure><h2 id="æ£€æŸ¥8080ç«¯å£æ˜¯å¦å¯åŠ¨"><a href="#æ£€æŸ¥8080ç«¯å£æ˜¯å¦å¯åŠ¨" class="headerlink" title="æ£€æŸ¥8080ç«¯å£æ˜¯å¦å¯åŠ¨"></a>æ£€æŸ¥8080ç«¯å£æ˜¯å¦å¯åŠ¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># netstat  -tnlup | grep 8080</span></div><div class="line">tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      3290/config.ru</div></pre></td></tr></table></figure><h2 id="æºä¸»æœºåˆ©ç”¨bashè„šæœ¬-å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤‡ä»½ä¸åŒæ­¥å¤‡ä»½"><a href="#æºä¸»æœºåˆ©ç”¨bashè„šæœ¬-å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤‡ä»½ä¸åŒæ­¥å¤‡ä»½" class="headerlink" title="æºä¸»æœºåˆ©ç”¨bashè„šæœ¬+å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤‡ä»½ä¸åŒæ­¥å¤‡ä»½"></a>æºä¸»æœºåˆ©ç”¨bashè„šæœ¬+å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤‡ä»½ä¸åŒæ­¥å¤‡ä»½</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># æ•°æ®åŒæ­¥ï¼Œé¦–è¦åšçš„å°±æ˜¯åŒæœºäº’ä¿¡ï¼›</span></div><div class="line"><span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@xx.xxx.xx.xxx</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#Can Bakup gitlab to xx.xxx.xx.xxx</span></div><div class="line"></div><div class="line"><span class="function"><span class="title">FileBack</span></span> () &#123; </div><div class="line">[ -d /var/opt/gitlab/backups/.bak ] || mkdir /var/opt/gitlab/backups/.bak -p</div><div class="line">mv /var/opt/gitlab/backups/*tar /var/opt/gitlab/backups/.bak/</div><div class="line">find /var/opt/gitlab/backups/.bak/  -<span class="built_in">type</span> f -mtime +7 -<span class="built_in">exec</span> rm -rf &#123;&#125; \;</div><div class="line">/usr/bin/gitlab-rake gitlab:backup:create &amp;&gt; /dev/null</div><div class="line">sleep 240</div><div class="line">ssh root@xx.xxx.xx.xxx <span class="string">"[ -d /var/opt/gitlab/backups/.bak ] || mkdir /var/opt/gitlab/backups/.bak -p"</span></div><div class="line">ssh root@xx.xxx.xx.xxx <span class="string">"mv /var/opt/gitlab/backups/*tar /var/opt/gitlab/backups/.bak/"</span></div><div class="line">ssh root@xx.xxx.xx.xxx <span class="string">"find /var/opt/gitlab/backups/.bak/  -type f -mtime +7 -exec rm -rf &#123;&#125; \;"</span></div><div class="line">scp  /var/opt/gitlab/backups/*tar root@xx.xxx.xx.xxx:/var/opt/gitlab/backups/</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">Message</span></span> () &#123;</div><div class="line"></div><div class="line">MESSAGE=<span class="string">"gitlab å·²å¤‡ä»½æˆåŠŸ `ls -l /var/opt/gitlab/backups/` &amp;&amp; `ls -ld /var/opt/gitlab/backups/` gitlabå½“å‰ä¸»æœåŠ¡å™¨xx.xxx.xx.xxx"</span></div><div class="line">MESSAGE_2=`ssh root@xx.xxx.xx.xxx <span class="string">"ls -l /var/opt/gitlab/backups/;ls -ld /var/opt/gitlab/backups/; ifconfig | sed -n '/inet addr/s/^[^:]*:\([0-9.]\&#123;7,15\&#125;\) .*/\1/p' | head -1"</span>`</div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.  --msg=<span class="string">"<span class="variable">$MESSAGE</span></span></div><div class="line"><span class="string">gitlabå½“å‰ä»æœåŠ¡å™¨<span class="variable">$MESSAGE_2</span>"</span> --user=15822097176@139.com --agentid=100000x</div><div class="line">&#125;</div><div class="line"></div><div class="line">FileBack &amp;&amp; Message</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#Can rolebak gitlab</span></div><div class="line"><span class="function"><span class="title">FILE_BAK</span></span> () &#123;</div><div class="line">scp /var/opt/gitlab/backups/*tar root@xx.xxx.xx.xxx:/volume1/skill-operation/bakup/gitlab/</div><div class="line">ssh root@xx.xxx.xx.xxx <span class="string">"find /volume1/skill-operation/bakup/gitlab/  -type f -mtime +7 -exec rm -rf &#123;&#125; \;"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">GIT_ROLBAK</span></span> () &#123;</div><div class="line">BAKID=`<span class="built_in">cd</span> /var/opt/gitlab/backups/ &amp;&amp; ls | tr -dc <span class="string">"[:digit:]"</span>`</div><div class="line"><span class="built_in">cd</span> /var/opt/gitlab/backups/ &amp;&amp; chmod 666 *</div><div class="line">/usr/bin/gitlab-rake gitlab:backup:restore BACKUP=<span class="variable">$BAKID</span> &lt;&lt;EOF &amp;&gt; /dev/null</div><div class="line">yes</div><div class="line">yes</div><div class="line">EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">MESSAGE</span></span> () &#123;</div><div class="line">/bin/weixin --corpid=xxxxxxxxxxxxx --corpsecret=xxxxxxxxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --msg=<span class="string">"ID ä¸º <span class="variable">$BAKID</span> çš„gitlabå‹ç¼©åŒ…æ¢å¤å®Œæ¯•"</span> --user=15822097176@139.com --agentid=100000x</div><div class="line">&#125;</div><div class="line"></div><div class="line">FILE_BAK</div><div class="line">GIT_ROLBAK &amp;&amp; MESSAGE</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># å®šæ—¶ä»»åŠ¡è¿›è¡Œå®æ—¶å¤‡ä»½ä¸åŒæ­¥</span></div><div class="line">su - root</div><div class="line">crontab -e</div><div class="line">10 22 * * * /bin/bash /bin/GITLAB_BAK.sh</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">su - root</div><div class="line">crontab -e</div><div class="line">30 22 * * * /bin/bash /bin/GIT_ROL.sh</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> database </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>pythonè‡ªåŠ¨åŒ–ä¹‹fabric</title>
      <link href="/2017/11/21/python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bfabric-lnmp%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
      <url>/2017/11/21/python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8Bfabric-lnmp%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
      <content type="html"><![CDATA[<p>#lnmpç¯å¢ƒçš„å»ºç«‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"></div><div class="line">env.user=<span class="string">'root'</span></div><div class="line">env.roledefs = &#123;  <span class="comment">#å®šä¹‰ä¸šåŠ¡è§’è‰²åˆ†ç»„</span></div><div class="line"><span class="string">'webservers'</span>: [ <span class="string">'xx.xxx.xx.xxx'</span> ],</div><div class="line">   <span class="string">'dbservers'</span>: [<span class="string">'xx.xxx.xx.xxx'</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line">env.passwords = &#123;</div><div class="line">    <span class="string">'root@xxx.xx.xx.xxx:22'</span> : <span class="string">'passwd'</span>,</div><div class="line">    <span class="string">'root@xxx.xx.xx.xxx:22'</span> : <span class="string">'passwd'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@roles('webservers') #webtaskä»»åŠ¡å‡½æ•°å¼•ç”¨'webservers'è§’è‰²ä¿®é¥°ç¬¦</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">webtask</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> yellow(<span class="string">"Install webtask packages class ! "</span>)</div><div class="line">    <span class="keyword">with</span> settings(warn_only=<span class="keyword">True</span>):</div><div class="line">        run(<span class="string">"yum -y install nginx"</span>)</div><div class="line">        run(<span class="string">"yum -y install php-fpm php-mysql php-mbstring php-xml php-mcrypt php-gd"</span>)</div><div class="line">        run(<span class="string">"chkconfig --levels 235 php-fpm on"</span>)</div><div class="line">        run(<span class="string">"chkconfig --levels 235 nginx on"</span>)</div><div class="line">        run(<span class="string">"systemctl start php-fpm"</span>)</div><div class="line">        run(<span class="string">"systemctl start nginx"</span>)</div><div class="line"></div><div class="line"><span class="meta">@roles('dbservers') # dbtaskä»»åŠ¡å‡½å¼•ç”¨'dbservers'è§’è‰²ä¿®é¥°ç¬¦</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbtask</span><span class="params">()</span>:</span> <span class="comment">#éƒ¨ç½²mysqlç¯å¢ƒ</span></div><div class="line">    <span class="keyword">print</span> green(<span class="string">"Install mariadb server !"</span>)</div><div class="line">    <span class="keyword">with</span> settings(warn_only=<span class="keyword">True</span>):</div><div class="line">        run(<span class="string">"yum -y install mariadb mariadb-server"</span>)</div><div class="line">        run(<span class="string">"chkconfig --levels 235 mariadb on"</span>)</div><div class="line">        run(<span class="string">"systemctl start mariadb"</span>)</div><div class="line"></div><div class="line"><span class="meta">@roles('webservers','dbservers') # publictaskä»»åŠ¡å‡½æ•°åŒæ—¶å¼•ç”¨ä¸¤ä¸ªè§’è‰²ä¿®é¥°ç¬¦</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">publictask</span><span class="params">()</span>:</span>  <span class="comment"># éƒ¨ç½²å…¬å…±ç¯å¢ƒï¼Œå¦‚epelã€ntpç­‰</span></div><div class="line">    <span class="keyword">print</span> blue(<span class="string">"Install epel ntp !"</span>)</div><div class="line">    <span class="keyword">with</span> settings(warn_only=<span class="keyword">True</span>):</div><div class="line">        run(<span class="string">"rpm -Uvh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm"</span>)</div><div class="line">        run(<span class="string">"rpm -y install ntp ntpdate"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">deploy</span><span class="params">()</span>:</span></div><div class="line">    execute(publictask)</div><div class="line">    execute(webtask)</div><div class="line">    execute(dbtask)</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#vim åº•è¡Œæ¨¡å¼çš„æ‰§è¡Œ</span></div><div class="line">: ! fab -f NGINX_DPL.py deploy</div></pre></td></tr></table></figure><h1 id="è‡ªåŠ¨éƒ¨ç½²"><a href="#è‡ªåŠ¨éƒ¨ç½²" class="headerlink" title="è‡ªåŠ¨éƒ¨ç½²"></a>è‡ªåŠ¨éƒ¨ç½²</h1><p>æ³¨:ç›®å‰ä»£ç è¿˜æœ‰äº›é—®é¢˜ï¼Œå°å¿ƒå‚è€ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.colors <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.context_managers <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> fabric.contrib.console <span class="keyword">import</span> confirm</div><div class="line"><span class="keyword">import</span> time </div><div class="line"></div><div class="line">env.user = <span class="string">'root'</span></div><div class="line">env.hosts = [<span class="string">'xx.xxx.xx.xxx'</span>,<span class="string">'xx.xxx.xx.xxx'</span>]</div><div class="line">env.password = <span class="string">'test.......'</span></div><div class="line">env.project_dev_source = <span class="string">'/var/www/html'</span>  <span class="comment">#å¼€å‘æœºé¡¹ç›®ä¸»ç›®å½•</span></div><div class="line">env.project_tar_source = <span class="string">'/var/www/releases'</span> <span class="comment">#å¼€å‘æœºé¡¹ç›®å‹ç¼©åŒ…å­˜å‚¨ç›®å½•</span></div><div class="line">env.project_pack_name = <span class="string">'release'</span>  <span class="comment"># é¡¹ç›®å‹ç¼©åŒ…å‰ç¼€ï¼Œæ–‡ä»¶åä¸º release.tar.gz</span></div><div class="line"></div><div class="line">env.deploy_project_root = <span class="string">'/var/www/data'</span> <span class="comment">#é¡¹ç›®ç”Ÿäº§ç¯å¢ƒä¸»ç›®å½•</span></div><div class="line">env.deploy_release_dir = <span class="string">'release'</span> <span class="comment">#é¡¹ç›®å‘å¸ƒç›®å½•ï¼Œä½äºä¸»ç›®å½•ä¸‹é¢</span></div><div class="line">env.deploy_current_dir = <span class="string">'current'</span> <span class="comment">#å¯¹å¤–æœåŠ¡çš„å½“å‰ç‰ˆæœ¬è½¯é“¾æ¥</span></div><div class="line">env.deploy_version = time.strftime (<span class="string">"%Y%m%d"</span>) +<span class="string">"V2"</span> <span class="comment">#ç‰ˆæœ¬å·</span></div><div class="line"></div><div class="line"><span class="meta">@runs_once #ç›¸å½“äºä¸€ä¸ªæ¨¡å—</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_versionid</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> prompt (<span class="string">"please input project rollbak version ID:"</span>,default=<span class="string">""</span>)</div><div class="line"><span class="meta">@task</span></div><div class="line"><span class="meta">@runs_once</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">tar_source</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> yellow(<span class="string">"Creating source package..."</span>)</div><div class="line">    <span class="keyword">with</span> lcd(env.project_dev_source):</div><div class="line">        local(<span class="string">"tar -czf %s.tar.gz."</span> % (env.project_tar_source + env.project_pack_name))</div><div class="line">        <span class="keyword">print</span> green(<span class="string">"Creating source package success!"</span>)</div><div class="line"></div><div class="line"><span class="meta">@task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_packages</span><span class="params">()</span>:</span> <span class="comment">#ä¸Šä¼ ä»»åŠ¡å‡½æ•°</span></div><div class="line">    <span class="keyword">print</span> yellow(<span class="string">"Start put package..."</span>)</div><div class="line">    <span class="keyword">with</span> settings(warn_only=<span class="keyword">True</span>):</div><div class="line">        <span class="keyword">with</span> cd(env.deploy_project_root+env.deploy_release_dir):</div><div class="line">            run(<span class="string">"mkdir %s"</span> % (env.deploy_version))</div><div class="line">    env.deploy_full_path = env.deploy_project_root + env.deploy_release_dir + <span class="string">"/"</span> + env.deploy_version</div><div class="line">    <span class="keyword">with</span> setting(warn_only=<span class="keyword">True</span>):</div><div class="line">        result = put(env.project_tar_source + env.project_pack_name + <span class="string">".tar.gz"</span>, env.deploy_full_path)</div><div class="line">    <span class="keyword">if</span> result.failed <span class="keyword">and</span> <span class="keyword">not</span>(<span class="string">"put file failed, Continue[Y/N]?"</span>):</div><div class="line">        abort(<span class="string">"Aborting file put task!"</span>)</div><div class="line">    <span class="keyword">with</span> cd(env.deploy_full_path):</div><div class="line">        run(<span class="string">"tar -zxvf %s.tar.gz"</span> % (env.project_pack_name))</div><div class="line">        run(<span class="string">"rm -rf %s.tar.gz"</span> % (env.project_pack_name))</div><div class="line"></div><div class="line">    <span class="keyword">print</span> green(<span class="string">"Put &amp; untar packages success!"</span>)</div><div class="line"></div><div class="line"><span class="meta">@task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_symlink</span><span class="params">()</span>:</span>   <span class="comment">#ä¸ºå½“å‰ç‰ˆæœ¬ç›®å½•åšè½¯é“¾æ¥</span></div><div class="line">    <span class="keyword">print</span> yellow(<span class="string">"update current sylink"</span>)</div><div class="line">    env.deploy_full_path = env.deploy_project_root + env.deploy_release_dir + <span class="string">"/"</span> +env.deploy_version</div><div class="line">    <span class="keyword">with</span> settings(warn_only=<span class="keyword">True</span>): <span class="comment">#åˆ é™¤è½¯é“¾æ¥ï¼Œé‡æ–°åˆ›å»ºå¹¶æŒ‡å®šè½¯é“¾æ¥æºç›®å½•ï¼Œæ–°ç‰ˆæœ¬ç”Ÿæ•ˆ</span></div><div class="line">        run(<span class="string">"rm -rf %s"</span> % (env.deploy_project_root + env.deploy_current_dir))</div><div class="line">        run(<span class="string">"ls -s %s %s"</span> % (env.deploy_full_path, env.deploy_project_root + env.deploy_current_dir))</div><div class="line">    <span class="keyword">print</span> green(<span class="string">"make symlink success!"</span>)</div><div class="line"><span class="meta">@task </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rollback</span><span class="params">()</span>:</span>  <span class="comment">#ç‰ˆæœ¬å›æ»šä»»åŠ¡å‡½æ•°</span></div><div class="line">    <span class="keyword">print</span> yellow(<span class="string">"rollback project version"</span>)</div><div class="line">    versionid= input_versionid()</div><div class="line">    <span class="keyword">if</span> versionod==<span class="string">''</span>:</div><div class="line">        abort(<span class="string">"Project version ID error,abort!"</span>)</div><div class="line">    env.deploy_full_path=env.deploy_project_root + env.deploy_release_dir + <span class="string">"/"</span> +versionid</div><div class="line">    run(<span class="string">"rm -f %s"</span> % env.deploy_project_root +env.deploy_current_dir)</div><div class="line">    run(<span class="string">"ln -s %s %s"</span> % (env.deploy_full_path, env.deploy_project_root + env.deploy_current_dir))</div><div class="line"><span class="comment">#åˆ é™¤è½¯é“¾æ¥,é‡æ–°åˆ›å»ºå¹¶æŒ‡å®šè½¯é“¾æ¥æºç›®å½•ï¼Œæ–°ç‰ˆæœ¬ç”Ÿæ•ˆ</span></div><div class="line">    <span class="keyword">print</span> green(<span class="string">"rollback success!"</span>)</div><div class="line"></div><div class="line"><span class="meta">@task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span><span class="params">()</span>:</span></div><div class="line">    tar_source()</div><div class="line">    put_packages()</div><div class="line">    make_symlink()</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> program </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å½“æˆ‘å¹´è½»çš„æ—¶å€™</title>
      <link href="/2017/11/20/%E5%BD%93%E6%88%91%E5%B9%B4%E8%BD%BB%E7%9A%84%E6%97%B6%E5%80%99/"/>
      <url>/2017/11/20/%E5%BD%93%E6%88%91%E5%B9%B4%E8%BD%BB%E7%9A%84%E6%97%B6%E5%80%99/</url>
      <content type="html"><![CDATA[<h2 id="å½“æˆ‘å¹´è½»çš„æ—¶å€™"><a href="#å½“æˆ‘å¹´è½»çš„æ—¶å€™" class="headerlink" title="å½“æˆ‘å¹´è½»çš„æ—¶å€™"></a>å½“æˆ‘å¹´è½»çš„æ—¶å€™</h2><p><img src="/images/ssjinyao.jpg" alt=""></p><p>å½“æˆ‘å¹´è½»çš„æ—¶å€™ï¼Œæˆ‘çš„æƒ³è±¡åŠ›ä»æ²¡æœ‰å—è¿‡é™åˆ¶ï¼Œæˆ‘æ¢¦æƒ³æ”¹å˜è¿™ä¸ªä¸–ç•Œ;<br>å½“æˆ‘æˆç†Ÿä¹‹åï¼Œæˆ‘å‘ç°æˆ‘ä¸èƒ½å¤Ÿæ”¹å˜è¿™ä¸ªä¸–ç•Œï¼Œæˆ‘å°†ç›®å…‰ç¼©çŸ­äº†äº›ï¼Œå†³å®šåªæ”¹å˜æˆ‘çš„å›½å®¶;<br>å½“æˆ‘è¿›å…¥æš®å¹´ä»¥åï¼Œæˆ‘å‘ç°æˆ‘ä¸èƒ½å¤Ÿæ”¹å˜æˆ‘çš„å›½å®¶ï¼Œæˆ‘æœ€åæ„¿æœ›ä»…ä»…æ˜¯æ”¹å˜ä¸€ä¸‹æˆ‘çš„å®¶åº­ã€‚ä½†æ˜¯è¿™ä¹Ÿä¸å¯èƒ½;<br>å½“æˆ‘ç°åœ¨èººåœ¨åºŠä¸Šï¼Œè¡Œå°†å°±æœ¨æ—¶ï¼Œæˆ‘çªç„¶æ„è¯†åˆ°: å¦‚æœä¸€å¼€å§‹æˆ‘ä»…ä»…å»æ”¹å˜æˆ‘è‡ªå·±ï¼Œç„¶åä½œä¸ºä¸€ä¸ªæ¦œæ ·;<br>æˆ‘å¯èƒ½æ”¹å˜æˆ‘çš„å®¶åº­;åœ¨å®¶äººçš„å¸®åŠ©å’Œé¼“åŠ±ä¸‹ï¼Œæˆ‘å¯èƒ½ä¸ºå›½å®¶åšä¸€äº›äº‹æƒ…;<br>ç„¶è€Œï¼Œè°çŸ¥é“å‘¢ ï¼Ÿ æˆ‘ç”šè‡³å¯èƒ½æ”¹å˜è¿™ä¸ªä¸–ç•Œ;  </p><h2 id="ä»–ä»¬çš„å¥½"><a href="#ä»–ä»¬çš„å¥½" class="headerlink" title="ä»–ä»¬çš„å¥½"></a>ä»–ä»¬çš„å¥½</h2><ol><li>èèå§: å¼•é¢†è‡ªå·±è¿›å…¥ITè¡Œä¸šï¼Œæä¾›æœ€æ–°çš„ä¿¡æ¯èµ„æ–™è®©è‡ªå·±åœ¨å¤§å­¦å­¦ä¹ ï¼Œæä¾›åˆåˆ°åŒ—äº¬ç»æµä¸Šçš„æ”¯æŒã€‚å¼•å¯¼å°±ä¸šä¸å­¦ä¹ æ–¹å‘ã€‚</li><li>æµ·ç”Ÿéƒ­: æ¨èå°±ä¸šï¼Œå¸®åŠ©å­¦ä¹ æŠ€æœ¯çŸ¥è¯†ã€‚</li><li>æ´‹æ´‹:  å›°éš¾æ—¶æœŸçš„é¼“åŠ±ä¸æ”¯æŒã€‚</li><li>å¨œå¨œ:  å¸®ç€å­¦ä¹ é«˜æ•°ï¼Œé¼“åŠ±Linux å‘å±•ä¹‹è·¯ ï¼Œå¸®ç€è‡ªå·±æ’å¿§è§£éš¾ã€‚</li><li>é˜¿ç‹—: æœ€ç¾çš„å¹´åé¼“åŠ±ä¸ç›¸ä¼´ã€‚</li><li>å°èƒ–éƒ­: å¼•é¢†è¿ç»´å…¥é—¨ï¼Œç›¸é‡ç›´ç‡ã€‚</li><li>çº¢å…µå“¥: å¸®ç€çœ‹æˆ¿ï¼Œä¸€èµ·å­¦ä¹ ä¸“ä¸šçŸ¥è¯†ã€‚</li></ol><h2 id="ä¸å¯å¤šå¾—çš„æŒšå‹"><a href="#ä¸å¯å¤šå¾—çš„æŒšå‹" class="headerlink" title="ä¸å¯å¤šå¾—çš„æŒšå‹"></a>ä¸å¯å¤šå¾—çš„æŒšå‹</h2><p>æ¨ä¸­xinã€ æ¢hao ã€ è‘£san ã€ç‹—jiang ã€å‹‡gangã€ æµ·tuan ã€ èŠ³mei ã€ æŒ¯xin</p><h2 id="ç«è½¦è·‘çš„å¿«ï¼Œå…¨é è½¦å¤´å¸¦"><a href="#ç«è½¦è·‘çš„å¿«ï¼Œå…¨é è½¦å¤´å¸¦" class="headerlink" title="ç«è½¦è·‘çš„å¿«ï¼Œå…¨é è½¦å¤´å¸¦"></a>ç«è½¦è·‘çš„å¿«ï¼Œå…¨é è½¦å¤´å¸¦</h2><p>è®¸ç«‹å®½ã€ ç‹æ˜¥å…°ã€å´”å¿˜åã€é›·ä¸½ç´ã€é©¬æ°¸äº®ã€ç‹æ™“æ˜¥</p><h2 id="åŠ±å¿—è¯­"><a href="#åŠ±å¿—è¯­" class="headerlink" title="åŠ±å¿—è¯­"></a>åŠ±å¿—è¯­</h2><ol><li>æœ‰æ™ºè€Œæ€§ç¼“è€…æ€å¤§æ™ºã€æœ‰æ‰è€Œæ°”å’Œè€…ä¸ºå¤§æ‰;</li><li>æˆ‘ä¸èƒ½æŠŠè¿™ä¸ªä¸–ç•Œè®©ç»™æˆ‘æ‰€é„™è§†çš„äººï¼Œå†¬ä¸¥å¯’ã€å¤é…·æš‘ã€æ˜¥ç§‹äº¦ä¸æ­»å¾å¿ƒï¼Œå¿ƒæœ‰æ‰€å‘ï¼Œå°†æœ‰æ‰€æˆ;</li><li>ä¸ç®¡èµ°åˆ°å“ªé‡Œï¼Œéƒ½è¦ç›¸ä¿¡è‡ªå·±çš„å‹‡æ•¢å’Œæ¯…åŠ›ï¼Œä¸ç®¡é‡åˆ°ä»€ä¹ˆäº‹æƒ…éƒ½ä¸è¦å‡»å®è‡ªå·±çš„å¿ƒæ€;</li></ol><h2 id="é«˜ä¸­è¯­å½•"><a href="#é«˜ä¸­è¯­å½•" class="headerlink" title="é«˜ä¸­è¯­å½•"></a>é«˜ä¸­è¯­å½•</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">çƒˆ ç« </div><div class="line">é€æ°´é”¦é¥</div><div class="line">èµ›è€…å¥”äºé“ä¸­å¤®ï¼Œåªä¸ºå°–å³°ç”Ÿçƒˆç«ã€‚</div><div class="line">è§‚è€…ç«‹äºè·¯ä¸¤å‚ï¼Œæ±‚å¾—ä¸ºæ­¤æ¥é¼“æŒã€‚</div><div class="line">é£å¹çƒˆç«ç«ä¼¼ç®­ï¼Œå¼ºå‹çƒˆç«ç«å†²å¤©ã€‚</div><div class="line">çƒ­è¡€é’æ˜¥åº¦æ— æ‚”ï¼Œè°äººæ­¤ç”Ÿå¦‚çƒˆç«ï¼Ÿ</div><div class="line">ä¸è§†å‰æ–¹æ¸ºæˆ‘è€…ï¼Œæ— é¡»å†å“äººç”Ÿå‘³ã€‚</div><div class="line">çƒˆç«æ€’å†²äººç”Ÿè·¯ï¼Œå¤®è‰ç•™äºæˆ‘èŠ³é¦™ã€‚</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> å ‚ å¼Ÿ </div><div class="line">é€æ°´é”¦é¥</div><div class="line">åŒå ‚å åœ°è¿‡ä¸ƒç§‹ï¼Œä¼´æˆ‘åŒåº¦åƒç™¾æ—¥ã€‚</div><div class="line">å ‚å¼Ÿä¹±å…¥æ¸¸æˆç½‘ï¼Œæ‚”äºå½“åˆæˆ‘æ²‰æ²¦ã€‚</div><div class="line">èµ›é“å¿™äºç„å³°æ ‡ï¼Œä¸“äºæŠ€è‰ºç»ˆä¸å›ã€‚</div><div class="line">æ¸¸æˆäººç”ŸæŠ›æ¶¯åº•ï¼Œå ‚å¼ŸåŸºçŸ³å¿™æ‰“ç´§ã€‚</div><div class="line">ä¸å…¶ç›¸éš”è™½é¥è¿œï¼Œå›ä¹¡ä¹‹æ—¥æŒ¤æ—¶é—´ã€‚</div><div class="line">æ–­è½å„è¡Œåƒç™¾äº‹ï¼Œå¸¸ç«‹å¤©åœ°æ°¸ä¸è¡°ã€‚</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> æ·¡éœè¿½å¿†</div><div class="line">é€æ°´é”¦é¥</div><div class="line">æ˜Ÿåˆ’ä¸€é¢—æ³„ä¸‡é‡Œï¼Œå…‰æ´’æš—å¤œæš–ä¸€å¿ƒã€‚</div><div class="line">åŒäº²ä¼¼æœ‰ç¦»åˆ«æ„ï¼Œå­è‹¥å¿ƒå¼¦å¼¦æ‹‰ç´§ã€‚</div><div class="line">ä»Šæ—¥å®¶å’Œä¸‡äº‹å…´ï¼Œå¤©é—´ç©ºç•™æ·¡éœå¿†ã€‚</div><div class="line">é™è§‚åº­å°èŠ±è½å»ï¼ŒåŠ¨å¬æ³ªé›¨çŒç§‹ç”°ã€‚</div><div class="line">é¥æœ›å‰ç¨‹èŠ±ä¸é”¦ï¼Œè¿½å¿†æ·¡éœç•™æˆ‘æƒ…ã€‚</div><div class="line">ç¬‘çœ‹ä¸–é—´è·¯é™©ä¹‰ï¼Œç—›ç»æ­¤ç”Ÿå†¬çœ äººã€‚</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">é”¦é¥æ±‚ä½³å­£ </div><div class="line">é€æ°´é”¦é¥</div><div class="line">åˆæ˜¯ä¸€å¹´å†¬å­£ </div><div class="line">æ„¿åŒåº¦é’æ˜¥çš„æœ‹å‹ä»¬</div><div class="line">å¤–ç¾å¦‚èŠ±ï¼Œå†…ç§€å¦‚ç«¹</div><div class="line">è®©æˆ‘ä»¬çš„å¿ƒçµ</div><div class="line">å±±é«˜æ°´é˜”ï¼Œå¤©åœ°æ¾„æ˜</div><div class="line">çœŸæ­£çš„è‡ªå·±</div><div class="line">æ²¡æœ‰å·¦å³å¤©æ°”çš„èƒ½åŠ›</div><div class="line">æ²¡æœ‰åŠ›æŒ½ç‹‚æ¾œçš„é­„åŠ›</div><div class="line">æ²¡æœ‰ä¸¤è‚‹æ’åˆ€çš„å‹‡æ°”</div><div class="line">ä½†å´æœ‰ä¸€é¢—å¿ƒ</div><div class="line">æœ‰æƒ…æœ‰ä¹‰</div><div class="line">åœ¨è¿™ä¸ªå¯’å†·çš„å†¬å­£é‡Œ</div><div class="line">æ„¿åŒåº¦é’æ˜¥çš„æœ‹å‹ä»¬</div><div class="line">å¦‚åœ¨æ˜¥å¤©è¿‡çš„ç¾ä¸½</div><div class="line">å¦‚åœ¨å¤å¤©è¿‡çš„æ¸©æš–</div><div class="line">å¦‚åœ¨ç§‹å¤©è¿‡çš„å……å®</div><div class="line">åŒåœ¨å†¬å¤©è¿‡çš„è¿·äºº</div><div class="line">æˆ‘æœ‰æˆ‘çš„è‡ªæˆ‘èŠ¬èŠ³</div><div class="line">æˆ‘æœ‰æˆ‘çš„çƒ­è¡€å†…å¿ƒ</div><div class="line">ä¸æœ‹å‹åŒäº«å†¬å­£</div><div class="line">æœ‰å¯’è€Œé™ä¸çŸ¥å¯’å†·</div><div class="line">æœ‰éš¾åŒåº¦ä¸æ„Ÿç—›è‹¦</div><div class="line">æœ‰æ³ªå¯è½ä¸è§‰æ‚²å‡‰</div><div class="line">æ„¿åŒåº¦é’æ˜¥çš„æœ‹å‹</div><div class="line">ä¸€åˆ‡éƒ½å¥½</div><div class="line">ä¸€åˆ‡éƒ½å¥½ï¼</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">èµ¤å­ä½³äºº</div><div class="line">é€æ°´é”¦é¥</div><div class="line">çœ‹å¤§åœ°å±±æ²³ä¹‹ç§€   </div><div class="line">å“é”¦ç‘Ÿå¹´åä¹‹ç››</div><div class="line">æ„¿ä¸å°”åŒåº¦å››å­£</div><div class="line">æ˜¥èµèŠ±</div><div class="line">å¤è§‚ç€‘</div><div class="line">ç§‹é‡‡çº¢å¶</div><div class="line">å†¬è¸é›ª</div><div class="line">é—²é€‚çš„è‡ªå·±</div><div class="line">æµªæ¼«çš„ä½³äºº</div><div class="line">ä¸€é—ªä¸€æ˜Ÿå…‰</div><div class="line">ä¸€é”¦ä¸€äººç”Ÿ</div><div class="line">æœ›å‰ç¨‹å¦‚æµ·ä¹‹èŒ«</div><div class="line">å®šå³°æ ‡åŠ›æ±‚çŒ›è¿›</div><div class="line">æ„¿ä¸å°”åŒåº¦é’æ˜¥</div><div class="line">å–œå¬æ­Œ</div><div class="line">æ€’ç»½æ”¾</div><div class="line">å“€é¸£é¸Ÿä¹</div><div class="line">ä¹å¼€æ€€</div><div class="line">æ¿€æ‰¬çš„çƒ­è¡€</div><div class="line">èˆåŠ¨çš„é’æ˜¥</div><div class="line">æ»¡æœˆæ»¡æ–œé˜³</div><div class="line">è½åœ°è½èŠ¬èŠ³</div><div class="line">è§†å¤©é•¿åœ°ä¹…ä¹‹äºº</div><div class="line">ç•™ä½™ç”Ÿä½™ä¸–ä¹‹çˆ±</div><div class="line">æ„¿ä¸å°”åŒåº¦ä½™ç”Ÿ</div><div class="line">é’å­¦ä¹ </div><div class="line">é•¿ç§¯è“„</div><div class="line">å¹´ç«‹äº‹ä¸š</div><div class="line">è€æ‰¶å­</div><div class="line">èšé›†çš„çƒ¦æ¼</div><div class="line">æ— å°½çš„å¿§æ„</div><div class="line">å…±è‹¦å…±æ¬¢ä¹</div><div class="line">å…±æ¶¯å…±æ­¤ç”Ÿ</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">é€æ°´äººç”Ÿå½•</div><div class="line">é€æ°´é”¦é¥</div><div class="line">æ›¾å¿†æ—§æ—¶å…‰ï¼Œåƒç™¾æ›²æ‚²æ­Œå”±å“ï¼›</div><div class="line">æ—¶äººå¤šæ€è‹¦æ¥šï¼Œæ— å¥ˆå“€ä¼¤é—­åŒç›®ã€‚</div><div class="line">å›è¡äººç”Ÿè·¯ï¼Œå¤šå°‘æ¬¡äº‰é”‹æ•Œå¯¹ï¼›</div><div class="line">æœé˜³å†·äºå¯’å…‰ï¼Œå¿ äºä»ä¹‰å­˜å–„è‰¯ã€‚</div><div class="line">åŠ›æŒ½å®¶å¹¸ç¦ï¼Œæ— æ•°å°æ—¥å¤œéš¾çœ ï¼›</div><div class="line">åŒå­æå¿§çˆ¶æ¯ï¼Œæœ‰å®¶ä¸å’Œå¤©åœ°ä¹±ã€‚</div><div class="line">åœç•™ä»–äººè¨€ï¼Œå¬ä¸å°½ä¸‘é—»è¯½è¯­ï¼›</div><div class="line">å…³é—¨æåŠ›å‡€å¿ƒï¼Œç©ºç•™é”¦é¥æœ‰æƒ…äººã€‚</div><div class="line"></div><div class="line">å¤©ä¸äºˆä»¥æˆ‘å®¶å’Œï¼Œç‹¬ç«‹å…¶èº«ä¿®è‡ªå¼ºã€‚</div><div class="line">è‡ªå¹¼è‡³ä»Šæ— å¥ä½“ï¼Œå”¯æœ‰ä¸€é¢—å‚²éª¨å¿ƒã€‚</div><div class="line">å®¶ä¹¡å¦‚å†°æ— æ¸©æƒ…ï¼Œæ˜Ÿå…‰ç…§æˆ‘ç•™æš–å¿†ã€‚</div><div class="line">çˆ±æ„å—å†·å†°æˆ‘å¿ƒï¼Œå­¤å‹ä¹…æ’­å…³çˆ±ç§ã€‚</div><div class="line">å­¦ä¹ ä¸è¿›æŠ€ä¸æˆï¼Œä¿¡å¿ƒç™¾æˆå‰©ä¸¤æˆã€‚</div><div class="line">æ„¿å¯»å¤§å­¦å¿ƒè¿½æ±‚ï¼ŒæŸ”æƒ…é‡è¿”äººä¸–é—´ã€‚</div><div class="line">å‹¿å¿˜æœ‹å‹æƒ…ï¼Œå…³æ€€è§£éš¾é›ªé€ç¢³ã€‚</div><div class="line">å‹¿å¿˜æ©å¸ˆè‚²ï¼Œç«‹å®½æ˜¥å…°å´”å¿˜åã€‚</div><div class="line">å‹¿å¿˜æ¯äº²æ³ªï¼Œå¸çƒŸå–é…’ä¸äº‰æ°”ã€‚</div><div class="line">å‹¿å¿˜é”¦é¥é­‚ï¼Œåˆšæ¯…å€”å¼ºæ‰¬æ–—å¿—ã€‚</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">é†‰æ— æ¸©æ„</div><div class="line">é€æ°´é”¦é¥</div><div class="line">å“ªè®¤å¹æ¥å¸ƒè°·é¸Ÿï¼Œæ— æ„ç‰µèµ·å®¶ä¹¡æƒ…ã€‚</div><div class="line">ä¸ºå¾—è·¯äººä¸€å›çœ¸ï¼Œæ— åŠ›æ¶ˆæˆ‘å®¶ä¹¡æ„ã€‚</div><div class="line">æ™¨é™ªèŠ±ç“£ç“£ç•™éœ²ï¼Œæš—å¤œæ— æ˜Ÿæ˜Ÿç‚¹ç¼€ã€‚</div><div class="line">æŠ±è´Ÿå­˜å¿ƒå¿—åœ¨å¤©ï¼Œæˆ˜åœºä¸€æˆ˜ç‚®æ‰“å“ã€‚</div><div class="line">ç©¿è‚ çƒˆé…’æ— æ¸©æ„ï¼Œä¸½äººå¦‚èŠ±é…’ä¸ºæ„ã€‚</div></pre></td></tr></table></figure><h2 id="ç¦»åˆ«å"><a href="#ç¦»åˆ«å" class="headerlink" title="ç¦»åˆ«å"></a>ç¦»åˆ«å</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">é€æ°´äººç”Ÿå½• </div><div class="line">é€æ°´é”¦é¥ </div><div class="line">æ›¾å¿µæ—§ç›¸è¯†ï¼Œä¸€é¢æ¬¢å¿«ä¸€é¢æ„ã€‚</div><div class="line">æ—¶äººæœ‰æ¢¦ç«‹å¤§å¿—ï¼Œå„å¥”å‰ç¨‹è‡ªæ‹¼æã€‚</div><div class="line">å›è¡äººç”Ÿè·¯ï¼Œå¤šå°‘æ¬¡æ—¥å¤œç›¸ä¼´ã€‚</div><div class="line">èº«è´Ÿä½ æˆ‘æœªæ¥æ¢¦ï¼Œæ‹¾èµ·åšå¼ºä¸æ€•ç—›ã€‚</div><div class="line">è½»æ‹‚å¿ƒä¸­ä¼¤ï¼Œæ‹¥æŠ±ä¸€æ—¶ä¸å“­æ³£ã€‚</div><div class="line">çˆ±å¿§æ¨å¿§ä¸æŒ‚å¿ƒï¼Œç‰µæ‰‹ç›¸ä¼´é£é›¨ä¸­ã€‚</div><div class="line">ç¾å¥½ç»ˆé€å¾€ï¼ŒåŠ³ç‡•åˆ†é£å¯å›é¦–ï¼Ÿ</div><div class="line">ç›¸ä¿¡æŠ€è‰ºä¸ç›¸è¿œï¼Œä½•å¿…æ€¥äºå·¥ä½œå¿™ã€‚</div><div class="line">é‡é‡æ€ç»ªç»•æ¢¦è¦ï¼Œæ‚„ç„¶é’»å…¥æ²‰å¯‚é‡Œã€‚</div><div class="line">åŒ†åŒ†æ—¶å…‰å°½é€æ°´ï¼Œä¸€æ—¶ä½è½æ€è¿‡å¾€ã€‚</div><div class="line">åµåµé—¹é—¹ä¸€ä¸‰ä¹ï¼Œå¿«ä¹å’Œå¥½ä¸‹ä¸€ç§’ã€‚</div><div class="line">å½±å½±ç›¸ä¼´ä¸æ›¾æ€•ï¼Œä¿¡ä»°ä¸æ­»ç«‹å¿ƒå¤´ã€‚</div><div class="line">è¨€è¨€ç›¸éšå¥½çˆ±äººï¼Œæ‚å¿µåœç•™ä¹±æˆ‘å¿ƒã€‚</div><div class="line">è‹¥è‹¥æ¬£é˜³ç¬‘å½’æ¥ï¼Œæ— è§£æ— æ€å¤§ç¥åœ¨ã€‚</div><div class="line">å‹¿å¿˜å¾€æ—¥æ¸¸ï¼Œæ•…å®«åé—¨ä¼¼ç¥é¾Ÿã€‚</div><div class="line">å‹¿å¿˜æ·¡å¼€æ”¾ï¼Œä¸æ™“å¿ƒæ€æ²³è¾¹ä¹±ã€‚</div><div class="line">å‹¿å¿˜æœæ—¥ä¼´ï¼Œèª“è¨€æ¢¦æƒ³ä¿±ç—´ç‹‚ã€‚</div><div class="line">å‹¿å¿˜åˆ«æ—¶ç—›ï¼Œä½ æˆ‘æ³ªåˆ«åŒ—äº¬å—ã€‚</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> renjin </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>kvmä¹‹å¿«ç…§ç®¡ç†</title>
      <link href="/2017/10/30/kvm%E4%B9%8B%E5%BF%AB%E7%85%A7%E7%AE%A1%E7%90%86/"/>
      <url>/2017/10/30/kvm%E4%B9%8B%E5%BF%AB%E7%85%A7%E7%AE%A1%E7%90%86/</url>
      <content type="html"><![CDATA[<h1 id="kvmä¹‹å¿«ç…§ç®¡ç†"><a href="#kvmä¹‹å¿«ç…§ç®¡ç†" class="headerlink" title="kvmä¹‹å¿«ç…§ç®¡ç†"></a>kvmä¹‹å¿«ç…§ç®¡ç†</h1><h3 id="ä½¿ç”¨kvmå¿«ç…§ï¼Œç£ç›˜åˆ™å¿…éœ€è¦ä½¿ç”¨qcow2çš„æ ¼å¼"><a href="#ä½¿ç”¨kvmå¿«ç…§ï¼Œç£ç›˜åˆ™å¿…éœ€è¦ä½¿ç”¨qcow2çš„æ ¼å¼" class="headerlink" title="ä½¿ç”¨kvmå¿«ç…§ï¼Œç£ç›˜åˆ™å¿…éœ€è¦ä½¿ç”¨qcow2çš„æ ¼å¼"></a>ä½¿ç”¨kvmå¿«ç…§ï¼Œç£ç›˜åˆ™å¿…éœ€è¦ä½¿ç”¨qcow2çš„æ ¼å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># qemu-img info centos6.test-x86_64.raw </span></div><div class="line">image: centos6.test-x86_64.raw</div><div class="line">file format: raw</div><div class="line">virtual size: 80G (85899345920 bytes)</div><div class="line">disk size: 1.2G</div><div class="line"><span class="comment">#</span></div></pre></td></tr></table></figure><h3 id="å…³é—­è™šæ‹Ÿæœºå¹¶æ”¹å˜ç£ç›˜çš„æ ¼å¼"><a href="#å…³é—­è™šæ‹Ÿæœºå¹¶æ”¹å˜ç£ç›˜çš„æ ¼å¼" class="headerlink" title="å…³é—­è™šæ‹Ÿæœºå¹¶æ”¹å˜ç£ç›˜çš„æ ¼å¼"></a>å…³é—­è™šæ‹Ÿæœºå¹¶æ”¹å˜ç£ç›˜çš„æ ¼å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># virsh list</span></div><div class="line"> Id    åç§°                         çŠ¶æ€</div><div class="line">----------------------------------------------------</div><div class="line"> 2     ubuntu-14.4-n1                 running</div><div class="line"> 14    ubuntu-14.4-113-pycharm        running</div><div class="line"> 16    ubuntu-14.4-n2                 running</div><div class="line"> 20    centos-6.8-grafana             running</div><div class="line"> 22    centos-6.8-data                running</div><div class="line"> 24    centos-6.8-test                running</div><div class="line"><span class="comment"># virsh destroy centos-6.8-test</span></div><div class="line">åŸŸ centos-6.8-test è¢«åˆ é™¤</div><div class="line"><span class="comment"># virsh  list --all</span></div><div class="line"> Id    åç§°                         çŠ¶æ€</div><div class="line">----------------------------------------------------</div><div class="line"> 2     ubuntu-14.4-n1                 running</div><div class="line"> 14    ubuntu-14.4-113-pycharm        running</div><div class="line"> 16    ubuntu-14.4-n2                 running</div><div class="line"> 20    centos-6.8-grafana             running</div><div class="line"> 22    centos-6.8-data                running</div><div class="line"> -     centos-6.8-n1                  å…³é—­</div><div class="line"> -     centos-6.8-test                å…³é—­</div><div class="line"> -     renjin-scripts                 å…³é—­</div><div class="line"> -     ubuntu-14.4-n3                 å…³é—­</div><div class="line"><span class="comment"># qemu-img convert -f raw -O qcow2 centos6.test-x86_64.raw centos6.test-x86_64.qcow2</span></div><div class="line"><span class="comment"># virsh edit centos-6.8-test</span></div><div class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">'file'</span> device=<span class="string">'disk'</span>&gt;</div><div class="line">      &lt;driver name=<span class="string">'qemu'</span> <span class="built_in">type</span>=<span class="string">'qcow2'</span> cache=<span class="string">'none'</span>/&gt;</div><div class="line">      &lt;<span class="built_in">source</span> file=<span class="string">'/media/67cbdcec-6419-4571-9632-c605b3e2b910/data/centos6.test-x86_64.qcow2'</span>/&gt;</div></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹ç®¡ç†å¿«ç…§çš„å‘½ä»¤æœ‰å“ªäº›"><a href="#æŸ¥çœ‹ç®¡ç†å¿«ç…§çš„å‘½ä»¤æœ‰å“ªäº›" class="headerlink" title="æŸ¥çœ‹ç®¡ç†å¿«ç…§çš„å‘½ä»¤æœ‰å“ªäº›"></a>æŸ¥çœ‹ç®¡ç†å¿«ç…§çš„å‘½ä»¤æœ‰å“ªäº›</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># virsh --help | grep snap</span></div><div class="line">  iface-begin                    create a snapshot of current interfaces settings, <span class="built_in">which</span> can be later committed (iface-commit) or restored (iface-rollback)</div><div class="line"> Snapshot (<span class="built_in">help</span> keyword <span class="string">'snapshot'</span>)</div><div class="line">    snapshot-create                Create a snapshot from XML</div><div class="line">    snapshot-create-as             Create a snapshot from a <span class="built_in">set</span> of args</div><div class="line">    snapshot-current               Get or <span class="built_in">set</span> the current snapshot</div><div class="line">    snapshot-delete                Delete a domain snapshot</div><div class="line">    snapshot-dumpxml               Dump XML <span class="keyword">for</span> a domain snapshot</div><div class="line">    snapshot-edit                  edit XML <span class="keyword">for</span> a snapshot</div><div class="line">    snapshot-info                  snapshot information</div><div class="line">    snapshot-list                  List snapshots <span class="keyword">for</span> a domain</div><div class="line">    snapshot-parent                Get the name of the parent of a snapshot</div><div class="line">    snapshot-revert                Revert a domain to a snapshot</div></pre></td></tr></table></figure><h3 id="åˆ›å»ºå¿«ç…§"><a href="#åˆ›å»ºå¿«ç…§" class="headerlink" title="åˆ›å»ºå¿«ç…§"></a>åˆ›å»ºå¿«ç…§</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># virsh snapshot-create centos-6.8-test</span></div><div class="line"><span class="comment"># virsh snapshot-list centos-6.8-test</span></div><div class="line"> åç§°               Creation Time             çŠ¶æ€</div><div class="line">------------------------------------------------------------</div><div class="line"> 1509359245           2017-10-30 18:27:25 +0800 shutoff</div><div class="line"><span class="comment"># å…¶ä¸­å¿«ç…§é…ç½®æ–‡ä»¶æ”¾åˆ°äº†/var/lib/libvirt/qemu/snapshot/</span></div></pre></td></tr></table></figure><h3 id="å¿«ç…§æ¢å¤"><a href="#å¿«ç…§æ¢å¤" class="headerlink" title="å¿«ç…§æ¢å¤"></a>å¿«ç…§æ¢å¤</h3><h4 id="æŸ¥çœ‹å“ªäº›å¿«ç…§éœ€è¦æ¢å¤"><a href="#æŸ¥çœ‹å“ªäº›å¿«ç…§éœ€è¦æ¢å¤" class="headerlink" title="æŸ¥çœ‹å“ªäº›å¿«ç…§éœ€è¦æ¢å¤"></a>æŸ¥çœ‹å“ªäº›å¿«ç…§éœ€è¦æ¢å¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># virsh  list --all</span></div><div class="line"> Id    åç§°                         çŠ¶æ€</div><div class="line">----------------------------------------------------</div><div class="line"> 2     ubuntu-14.4-n1                 running</div><div class="line"> 14    ubuntu-14.4-113-pycharm        running</div><div class="line"> 16    ubuntu-14.4-n2                 running</div><div class="line"> 20    centos-6.8-grafana             running</div><div class="line"> 22    centos-6.8-data                running</div><div class="line"> 25    centos-6.8-test                running</div><div class="line"> -     centos-6.8-n1                  å…³é—­</div><div class="line"> -     renjin-scripts                 å…³é—­</div><div class="line"> -     ubuntu-14.4-n3                 å…³é—­</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># virsh snapshot-list centos-6.8-test</span></div><div class="line"> åç§°               Creation Time             çŠ¶æ€</div><div class="line">------------------------------------------------------------</div><div class="line"> 1509359245           2017-10-30 18:27:25 +0800 shutoff</div><div class="line"> <span class="comment"># virsh destroy centos-6.8-test</span></div><div class="line">åŸŸ centos-6.8-test è¢«åˆ é™¤</div><div class="line"><span class="comment"># virsh  snapshot-revert centos-6.8-test 1509359245</span></div><div class="line"><span class="comment"># virsh snapshot-current centos-6.8-test</span></div><div class="line"><span class="comment"># virsh start centos-6.8-test</span></div><div class="line"><span class="comment">#è‡³æ­¤ï¼Œå·²ç»æ¢å¤å®Œæˆ</span></div></pre></td></tr></table></figure><h3 id="å¿«ç…§çš„åˆ é™¤"><a href="#å¿«ç…§çš„åˆ é™¤" class="headerlink" title="å¿«ç…§çš„åˆ é™¤"></a>å¿«ç…§çš„åˆ é™¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># virsh snapshot-list centos-6.8-test</span></div><div class="line"> åç§°               Creation Time             çŠ¶æ€</div><div class="line">------------------------------------------------------------</div><div class="line"> 1509359245           2017-10-30 18:27:25 +0800 shutoff</div><div class="line"></div><div class="line"><span class="comment"># virsh snapshot-delete centos-6.8-test  1509359245</span></div></pre></td></tr></table></figure><h3 id="è¡¥å……-åœ¨å®¿ä¸»æœºå…³æœºåï¼Œå¯åŠ¨kvmé‡ä»¥ä¸‹é—®é¢˜"><a href="#è¡¥å……-åœ¨å®¿ä¸»æœºå…³æœºåï¼Œå¯åŠ¨kvmé‡ä»¥ä¸‹é—®é¢˜" class="headerlink" title="è¡¥å……:åœ¨å®¿ä¸»æœºå…³æœºåï¼Œå¯åŠ¨kvmé‡ä»¥ä¸‹é—®é¢˜:"></a>è¡¥å……:åœ¨å®¿ä¸»æœºå…³æœºåï¼Œå¯åŠ¨kvmé‡ä»¥ä¸‹é—®é¢˜:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># virsh start  centos-7.2-xxxxxxxx</div><div class="line">é”™è¯¯ï¼šå¼€å§‹åŸŸ centos-7.2-xxxxxxxå¤±è´¥</div><div class="line">é”™è¯¯ï¼šUnable to read from monitor: Connection reset by peer</div><div class="line"># virsh managedsave-remove centos-6.8-grafana</div><div class="line"># virsh start centos-7.2-xxxxxxxxx </div><div class="line">åŸŸ centos-7.2-xxxxxxxxx å·²å¼€å§‹</div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>linux ç³»ç»Ÿä¼˜åŒ–</title>
      <link href="/2017/10/29/linux-%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96/"/>
      <url>/2017/10/29/linux-%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<h2 id="è¿›ç¨‹è°ƒåº¦"><a href="#è¿›ç¨‹è°ƒåº¦" class="headerlink" title="è¿›ç¨‹è°ƒåº¦"></a>è¿›ç¨‹è°ƒåº¦</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">OS:ç¡¬ä»¶æŠ½è±¡ï¼Œè™šæ‹Ÿè®¡ç®—æœº</div><div class="line">system call </div><div class="line">CPU: time slice</div><div class="line">è·å¾—CPUæƒé™çš„ä¼˜å…ˆçº§ï¼Œæœ‰äº›è¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜¯å¯ä»¥è¢«æé«˜çš„</div><div class="line">è°ƒåº¦å™¨(æœ¬èº«ä¹Ÿæ˜¯ä¸ªç¨‹åº): CFS Big O</div><div class="line">O(1) ä¸€ä¸ªç®—æ³•çš„æ—¶é—´å¤æ‚åº¦</div><div class="line">0-139</div><div class="line">0-99</div><div class="line">100-139:</div><div class="line">nice</div><div class="line">Memory:</div><div class="line">è™šæ‹Ÿåœ°å€ç©ºé—´</div><div class="line">PAEï¼šç‰©ç†åœ°å€æ‰© 32bitsï¼Œå¯»å€çš„ç‰©ç†ç©ºé—´æ˜¯4Gï¼Œ4bitsæ˜¯é¢å¤–å¼•å…¥çš„ï¼Œæ‰€ä»¥è¢«ç§°ä¸ºPAEæŠ€æœ¯(64G)</div><div class="line">ä¹Ÿå°±æ˜¯è¯´å®ƒçš„çº¿æ€§åœ°å€ç©ºé—´ä¾ç„¶ä¸º4G </div><div class="line"></div><div class="line">MySQL:å•è¿›ç¨‹å¤šçº¿ç¨‹</div><div class="line">å¯ä»¥ä½¿ç”¨2.7Gå·¦å³ï¼Œå› æ­¤ä½¿ç”¨PAEæŠ€æœ¯å¯¹MySQLæ²¡æœ‰æŠ€æœ¯ï¼Œå› æ­¤ä½¿ç”¨MySQLæœåŠ¡æ—¶ï¼Œå»ºè®®ä½¿ç”¨64ä½çš„</div><div class="line">page frame: åˆ†é¡µæŠ€æœ¯ </div><div class="line">ç‰©ç†åœ°å€ä¸­çš„å†…å­˜ç©ºé—´ï¼Œè¢«åˆ’åˆ†æˆäº†å¤šä¸ªé¡µé¢ç©ºé—´ï¼Œéƒ½è¢«ç»„ç»‡æˆä¸ºå¤šä¸ªé¡µé¢å½¢åŠ¿</div><div class="line">ä»é¡µé¢åˆ°é¡µæ¡†å®Œæˆæ˜ å°„çš„</div><div class="line">    ä¸€ä¸ªè¿›ç¨‹è¯»å–æ•°æ®æ—¶ï¼Œé¦–å…ˆéœ€è¦æŠŠæ•°æ®è½½å…¥åˆ°å†…å­˜ä¸­ã€‚é‡åˆ°ç»å¸¸è¢«è°ƒç”¨çš„æ•°æ®æ—¶ï¼Œå¯ä»¥é…ç½®ç¼“å­˜</div><div class="line">    å¦‚æœç¼“å­˜ä¸æ–­çš„å‘½ä¸­ï¼Œåˆ™è¯´æ˜æ€§èƒ½å¯ä»¥ä¸æ–­çš„æé«˜ï¼Œå°†é¢‘ç¹è¢«è®¿é—®æ•°æ®æ”¾åˆ°CPUç¼“å­˜ä¸­</div><div class="line">    å¯¹äºCPUæ¥è¯´ï¼ŒCPUçš„ç¼“å­˜å¯¹æé«˜CPUçš„æ€§èƒ½æ˜¯è‡³å…³é‡è¦çš„</div><div class="line">    ç¼“å­˜ç©ºé—´é€šå¸¸æ˜¯æŒ‰å€ç›¸å·®çš„</div><div class="line">    TLB è½¬æ¢åå…ƒç¼“å­˜å™¨</div><div class="line"> page frame:</div><div class="line"> huge page: ä½¿ç”¨å¤§é¡µï¼Œæ¥æå‡TLBçš„å‘½ä¸­ç‡</div><div class="line"> 0000</div><div class="line"> 0001</div><div class="line"> 0101</div><div class="line"> 1111</div><div class="line"> cpu 1,3</div><div class="line"> </div><div class="line"> ä¸¤ä¸­æ‹†ä¸­æ–¹æ³•ï¼Œæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼Œæ‹¿ç©ºé—´æ¢æ—¶é—´ </div><div class="line"> è¾ƒä¸“ä¸šçš„æœåŠ¡å™¨ä¸Šä¼šæœ‰NUMAçš„ç»“æ„ï¼Œéä¸€è‡´å†…å­˜è®¿é—®ï¼ŒNUMAç»“æ„çš„å‰é¢˜æ˜¯ï¼Œè¦æœ‰å¤šé¢—CPU </div><div class="line"> å°†è¿›ç¨‹å’ŒCPUå®Œæˆäº²å’Œæ€§ç»‘å®šï¼Œè¿›ç¨‹å‘½ä¸­CPUç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œå°†ä¼šå˜çš„å¾ˆé«˜</div></pre></td></tr></table></figure><h2 id="CPUè°ƒä¼˜æ“ä½œ"><a href="#CPUè°ƒä¼˜æ“ä½œ" class="headerlink" title="CPUè°ƒä¼˜æ“ä½œ"></a>CPUè°ƒä¼˜æ“ä½œ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># æŸ¥çœ‹å½“å‰è¿›å’Œè¿è¡Œåœ¨å“ªé¢—CPU</div><div class="line"># ps axo psr,comm,pid</div><div class="line"># cat /proc/cpuinfo</div><div class="line"># å®šä¹‰è¿›ç¨‹å·ä¸º 11215çš„è¿›ç¨‹ç»‘å®šåœ¨ç¬¬å››é¢—CPUä¸Š</div><div class="line"># taskset -p -c 3 11215 (ä¸ºä¸ªå‘½ä»¤çš„æ ¼å¼æ¯”è¾ƒè¯¡å¼‚) </div><div class="line"># taskset -p cpu1,cpu2,... pid </div><div class="line"># vim /boot/grup/grub.conf kernel è¡ŒåŠ ä¸Š isol = 2,3</div><div class="line"># cat /proc/interrupts # é€šå¸¸åº”è¯¥æŠŠ0å·éš”ç¦»å‡ºæ¥ï¼Œç¦»ç»™å†…æ ¸ä½¿ç”¨</div><div class="line"># ls /proc/irq/0/</div><div class="line"># cat /proc/irq/0/smp_affinity </div><div class="line">ffffffff,ffffffff  è¡¨ç¤ºä»»æ„CPU</div><div class="line"></div><div class="line"># echo 1 &gt; /proc/irq/32/smp_affinity</div><div class="line"># cat /proc/irq/32/smp_affinity</div><div class="line"># cat </div><div class="line"># å¯¹äºç”Ÿäº§æ¥è¯´ï¼Œè¶Šç®€å•ï¼Œè¶Šæ ‡å‡†ä¼šå¥½</div><div class="line"># å‹æ¦¨ç³»ç»Ÿèµ„æºï¼Œä¼šé€ æˆç³»ç»Ÿä¸ç¨³å®šçš„ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ï¼Œä¸å»ºè®®è¿™æ ·åšçš„</div><div class="line"># nice, renice ç»å¸¸ç”¨åˆ°çš„è¿›ç¨‹ä¼˜å…ˆçº§çš„è°ƒæ•´</div></pre></td></tr></table></figure><h2 id="å®šä¹‰ä¸­æ–­-smp-affinityy"><a href="#å®šä¹‰ä¸­æ–­-smp-affinityy" class="headerlink" title="å®šä¹‰ä¸­æ–­ smp affinityy:"></a>å®šä¹‰ä¸­æ–­ smp affinityy:</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo cpunumber ,.. &gt; /proc/irq/#/smp_affinity</span></div><div class="line"><span class="comment"># è¿™é‡Œä½¿ç”¨çš„cpuåº”è¯¥ä¸ºisoicpusä¸­å®šä¹‰CPUé›†åˆä¹‹å¤–çš„å…¶å®ƒCPU</span></div><div class="line"><span class="comment"># numa,numactl,numad å°½å¯èƒ½æŠŠè¿›ç¨‹ç»‘å®šåœ¨å•é¢—CPUä¸Š</span></div><div class="line"><span class="comment"># å¯¹åŒä¸€ä¸ªè¿›ç¨‹æ¥è®²ï¼Œå¯èƒ½é€‚ç”¨çš„è°ƒåº¦å™¨æœ‰å¤šä¸ªï¼Œæœ‰å…¶ä¼˜å…ˆçº§è¾ƒé«˜çš„è°ƒåº¦æ¥å™¨æ¥è°ƒåº¦</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># SCHED_FIFO [1-99] </span></div><div class="line">chrt -f [1-99] /path/to/program arguments</div><div class="line"><span class="comment"># SCHED_RR  </span></div><div class="line">chrt -f [1-99] /path/to/program arguments</div><div class="line"><span class="comment"># SCHED_NORMAL (100-139)</span></div><div class="line">è¿›ç¨‹çš„è°ƒåº¦ç±»åˆ«: </div><div class="line">SCHEd_FIFO, SCHED_RR:real-time </div><div class="line"></div><div class="line">SCHED_NORMAL, SCHED_OTHER: 100-139</div><div class="line">nice,renice (å¯¹äºå·²å¯åŠ¨çš„è¿›ç¨‹ä½¿ç”¨reniceå¯åŠ¨)</div><div class="line">å»ºè®®ä½¿ç”¨CPU Utilizationå·¥å…·:</div><div class="line">htop,dstat,glances,sar</div><div class="line">w,uptime, vmstat 1 5  </div><div class="line"><span class="comment"># sar -P all 1</span></div><div class="line"><span class="comment"># iostat -c 1 2 </span></div><div class="line"><span class="comment"># sysdig</span></div><div class="line">/proc,/sys</div><div class="line"></div><div class="line">DMA: ç›´æ¥å†…å­˜è®¿é—®</div><div class="line"></div><div class="line">CPUè·Ÿå¤–éƒ¨IOè®¾å¤‡äº¤äº’çš„æ–¹å¼:</div><div class="line">poll:è½®è¯¢ï¼Œå¿™ç­‰å¾…</div><div class="line">ä¸­æ–­:</div><div class="line">CPU: è°ƒä¼˜</div><div class="line">cpu affinity </div><div class="line">ä¼˜å…ˆçº§è°ƒæ•´</div><div class="line">cgroups,</div><div class="line">å†…å­˜:</div><div class="line">overcommit_memory</div><div class="line">msg </div><div class="line">shm</div></pre></td></tr></table></figure><h2 id="è¡¥å……nginx-ä¼˜åŒ–åŠ é€Ÿ"><a href="#è¡¥å……nginx-ä¼˜åŒ–åŠ é€Ÿ" class="headerlink" title="è¡¥å……nginx ä¼˜åŒ–åŠ é€Ÿ"></a>è¡¥å……nginx ä¼˜åŒ–åŠ é€Ÿ</h2><blockquote><p>ç»™Nginxä¸Š ngx_http_gzip_module è¿™ä¸ªæ¨¡å—;<br>ç”¨ nginx -V å‘½ä»¤æŸ¥çœ‹ configure arguments æ˜¯å¦æœ‰<br>æ²¡æœ‰çš„è¯éœ€è¦ç¼–è¯‘åŠ è½½è¿™ä¸ªæ¨¡å—</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /usr/local/nginx/nginx.conf</span></div><div class="line"><span class="comment"># åœ¨ httpd æ®µä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹</span></div><div class="line">gzip on;</div><div class="line"><span class="comment">#è¯¥æŒ‡ä»¤ç”¨äºå¼€å¯æˆ–å…³é—­gzipæ¨¡å—(on/off)</span></div><div class="line"></div><div class="line">gzip_buffers 16 8k;</div><div class="line"><span class="comment">#è®¾ç½®ç³»ç»Ÿè·å–å‡ ä¸ªå•ä½çš„ç¼“å­˜ç”¨äºå­˜å‚¨gzipçš„å‹ç¼©ç»“æœæ•°æ®æµã€‚16 8kä»£è¡¨ä»¥8kä¸ºå•ä½ï¼Œå®‰è£…åŸå§‹æ•°æ®å¤§å°ä»¥8kä¸ºå•ä½çš„16å€ç”³è¯·å†…å­˜</span></div><div class="line"></div><div class="line">gzip_comp_level 6;</div><div class="line"><span class="comment">#gzipå‹ç¼©æ¯”ï¼Œæ•°å€¼èŒƒå›´æ˜¯1-9ï¼Œ1å‹ç¼©æ¯”æœ€å°ä½†å¤„ç†é€Ÿåº¦æœ€å¿«ï¼Œ9å‹ç¼©æ¯”æœ€å¤§ä½†å¤„ç†é€Ÿåº¦æœ€æ…¢</span></div><div class="line"></div><div class="line">gzip_http_version 1.1;</div><div class="line"><span class="comment">#è¯†åˆ«httpçš„åè®®ç‰ˆæœ¬</span></div><div class="line"></div><div class="line">gzip_min_length 256;</div><div class="line"><span class="comment">#è®¾ç½®å…è®¸å‹ç¼©çš„é¡µé¢æœ€å°å­—èŠ‚æ•°ï¼Œé¡µé¢å­—èŠ‚æ•°ä»headerå¤´å¾—content-lengthä¸­è¿›è¡Œè·å–ã€‚é»˜è®¤å€¼æ˜¯0ï¼Œä¸ç®¡é¡µé¢å¤šå¤§éƒ½å‹ç¼©ã€‚è¿™é‡Œæˆ‘è®¾ç½®äº†ä¸º256</span></div><div class="line"></div><div class="line">gzip_proxied any;</div><div class="line"><span class="comment">#è¿™é‡Œè®¾ç½®æ— è®ºheaderå¤´æ˜¯æ€ä¹ˆæ ·ï¼Œéƒ½æ˜¯æ— æ¡ä»¶å¯ç”¨å‹ç¼©</span></div><div class="line"></div><div class="line">gzip_vary on;</div><div class="line"><span class="comment">#åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encoding ,ç»™ä»£ç†æœåŠ¡å™¨ç”¨çš„</span></div><div class="line"></div><div class="line">gzip_types</div><div class="line">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</div><div class="line">    text/javascript application/javascript application/x-javascript</div><div class="line">    text/x-json application/json application/x-web-app-manifest+json</div><div class="line">    text/css text/plain text/x-component</div><div class="line">    font/opentype font/ttf application/x-font-ttf application/vnd.ms-fontobject</div><div class="line">    image/x-icon;</div><div class="line"><span class="comment">#è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹,è¿™é‡Œç‰¹åˆ«æ·»åŠ äº†å¯¹å­—ä½“çš„æ–‡ä»¶ç±»å‹</span></div><div class="line"></div><div class="line">gzip_disable <span class="string">"MSIE [1-6]\.(?!.*SV1)"</span>;</div><div class="line"><span class="comment">#ç¦ç”¨IE 6 gzip</span></div><div class="line"></div><div class="line"><span class="comment"># vim /etc/nginx/conf.d/ssjinyao.conf </span></div><div class="line"><span class="comment"># åœ¨è™šæ‹Ÿä¸»æœºserver æ®µä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹</span></div><div class="line">location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$ &#123;</div><div class="line">    expires 30d;</div><div class="line">    access_log off;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location ~ .*\.(eot|ttf|otf|woff|svg)$ &#123;</div><div class="line">    expires 30d;</div><div class="line">    access_log off;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location ~ .*\.(js|css)?$ &#123;</div><div class="line">    expires 7d;</div><div class="line">    access_log off;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>dockeråˆæ­¥ä½¿ç”¨</title>
      <link href="/2017/10/27/docker%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8/"/>
      <url>/2017/10/27/docker%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<h1 id="Dockeråˆæ­¥ä½¿ç”¨"><a href="#Dockeråˆæ­¥ä½¿ç”¨" class="headerlink" title="Dockeråˆæ­¥ä½¿ç”¨"></a>Dockeråˆæ­¥ä½¿ç”¨</h1><h2 id="ä¸€ã€è¯´æ˜"><a href="#ä¸€ã€è¯´æ˜" class="headerlink" title="ä¸€ã€è¯´æ˜"></a>ä¸€ã€è¯´æ˜</h2><blockquote><p>lxc linux container,openvz;<br>å®¹å™¨ä¸­å„è™šæ‹Ÿæœºåªæœ‰ä¸€ä¸ªå†…æ ¸ï¼Œè€Œæ˜¯å¤šä¸ªç”¨æˆ·ç©ºé—´;<br>åœ¨åº“ä¸­å®Œæˆè™šæ‹ŸåŒ–ï¼Œæ¯”å¦‚wine æˆ–è€…åœ¨windowsä¸­è¿è¡Œbash;<br>åœ¨åº”ç”¨ç¨‹åºçš„è¿è¡Œçº§åˆ«æä¾›è™šæ‹ŸåŒ–ï¼Œæ¯”å¦‚jvm;<br>pstree , pid ä¸º1 çš„è¿›ç¨‹  è¿™ä¸ªè¿›ç¨‹æ˜¯ç›´æ¥å’Œå†…æ ¸æ¥æ‰“äº¤é“çš„;<br>å®¹å™¨ä¹‹é—´ï¼Œå’Œè™šæ‹Ÿæœºä¹‹é—´éš”ç¦»çš„æŠ€æœ¯;<br>å®¹å™¨ä¹‹é—´çš„éš”ç¦»ç›¸å¯¹æ¯”è¾ƒå›°éš¾;<br>NameSpace,ï¼ˆåç§°ç©ºé—´);</p></blockquote><h3 id="å†…æ ¸çº§åˆ«ï¼Œç¯å¢ƒéš”ç¦»"><a href="#å†…æ ¸çº§åˆ«ï¼Œç¯å¢ƒéš”ç¦»" class="headerlink" title="å†…æ ¸çº§åˆ«ï¼Œç¯å¢ƒéš”ç¦»"></a>å†…æ ¸çº§åˆ«ï¼Œç¯å¢ƒéš”ç¦»</h3><ul><li>PID NameSpace: ç”¨äºéš”ç¦»pidå·çš„ Linux 2.6.24  PIDéš”ç¦»;</li><li>Network NameSpace : Linux 2.6.29 ç½‘ç»œåç§°ç©ºé—´çš„éš”ç¦»  ç½‘ç»œè®¾å¤‡ã€ç½‘ç»œæ ˆã€ç«¯å£ç­‰ç½‘ç»œè®¾å¤‡éš”ç¦»;</li><li>User NameSpace: Linux ç”¨æˆ·ç©ºé—´çš„éš”ç¦»  Linux 3.8 ç”šè‡³ 3.10ä¹‹å ç”¨æˆ·å’Œç”¨æˆ·ç»„èµ„æºéš”ç¦»;</li><li>IPC NameSpace: è¿›ç¨‹é—´é€šä¿¡æŠ€æœ¯  Linux 2.6.19  signal ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œå…±äº«å†…å­˜çš„éš”ç¦»;</li><li>UTS NameSpace: Linux 2.6.19 ï¼Œ ä¸»æœºåå’ŒåŸŸåçš„éš”ç¦»ï¼›</li><li>Mount NameSpace: Linux 2.4.19 æŒ‚è½½ç‚¹ï¼ˆæ–‡ä»¶ç³»ç»Ÿ ï¼‰éš”ç¦»ï¼›</li><li>API:clone()å®ç°çº¿ç¨‹ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨æ¥åˆ›å»ºæ–°çº¿ç¨‹;</li><li>setns()è®¾å®šä¸€ä¸ªæ–°çš„å±æ€§,å°†æŸ(è¿›ç¨‹|æˆ–è®¾å¤‡)åŠ å…¥åˆ°æ–°çš„NameSpaceä¸­å»çš„;</li><li>unshare()éå…±äº«æœºåˆ¶ï¼Œè„±ç¦»NameSpaceï¼Œè€Œå…³è”è‡³æ–°NameSpace;</li><li>å°†NameSpaceéš”ç¦»å¼€æ¥æ²¡æœ‰é—®é¢˜ï¼Œè€Œé—®é¢˜åœ¨äºï¼Œæ¶æ„ç”¨æˆ·å¼ºè¡Œè°ƒç”¨èµ„æºï¼Œä¸€ä¸ªç”¨æˆ·å®Œå…¨å¯ä»¥å°†ç³»ç»Ÿèµ„æºè€—å°½ï¼Œcpuå ç”¨è‡³100%;</li><li>å› æ­¤å¸¦æ¥äº†å¦ä¸€ç§æœºåˆ¶çš„å‡ºç°ï¼›</li><li>CGroup: Linux Control Group,æ§åˆ¶ç»„ Linux 2.6.24è¢«æ”¶å…¥è¿›å†…æ ¸</li><li>å†…æ ¸çº§åˆ«ï¼Œé™åˆ¶ã€æ§åˆ¶ä¸ä¸€ä¸ªè¿›ç¨‹ç»„ç¾¤çš„èµ„æºï¼›</li><li>èµ„æºï¼šCPU,å†…å­˜ï¼ŒIO çº§åˆ«æ¥è¿›è¡Œå®šä¹‰</li><li>googleå·¥ç¨‹å¸ˆï¼š2006å¼€å§‹æ­¤æŠ€æœ¯ï¼Œå‘½ä»¤ä¸ºè¿›ç¨‹å®¹å™¨è€Œåå‘½ä»¤ä¸ºCGroup</li></ul><h3 id="åŠŸèƒ½ï¼š"><a href="#åŠŸèƒ½ï¼š" class="headerlink" title="åŠŸèƒ½ï¼š"></a>åŠŸèƒ½ï¼š</h3><ul><li>Resource limitation:èµ„æºé™åˆ¶ï¼›</li><li>Prioritization:ä¼˜å…ˆçº§æ§åˆ¶ï¼›</li><li>Accounting:å®¡è®¡å’Œç»Ÿè®¡ï¼Œä¸»è¦ä¸ºè®¡è´¹ï¼›</li><li>Contorl:æŒ‚èµ·è¿›ç¨‹ï¼Œæ¢å¤è¿›ç¨‹ï¼›</li><li>CGroup åŸºäºå•æ ¹å€’æ ‘çŠ¶ç»“æ„æ¥å®ç°</li><li>åœ¨CentOS7 ä¸­å¯ä»¥ç”¨mount å‘½ä»¤æ¥æŸ¥çœ‹å…¶èµ„æºç»„çš„éš”ç¦»æŠ€æœ¯å·²ç»è¢«ä½¿ç”¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"> /sys/fs/cgroup</div><div class="line"> <span class="comment"># mount</span></div><div class="line"> <span class="comment"># lssubsys -m </span></div><div class="line">``` </div><div class="line"><span class="comment">### CGroupçš„å­ç³»ç»Ÿ:</span></div><div class="line">* blkio:è®¾å®šå—è®¾å¤‡çš„IOé™åˆ¶ï¼Œè€Œè®¾å®šçš„å­ç³»ç»Ÿï¼›</div><div class="line">* cpu:è®¾å®šCPUçš„é™åˆ¶ï¼›</div><div class="line">* cpuacct:æŠ¥å‘Šcgroupä¸­æ‰€ä½¿ç”¨çš„CPUèµ„æºï¼›</div><div class="line">* cpuset:ä¸ºcgroupä¸­çš„ä»»åŠ¡åˆ†é… CPUå’Œå†…å­˜èµ„æº ï¼›</div><div class="line">* memory:è®¾å®šå†…å­˜çš„ä½¿ç”¨é™åˆ¶ï¼›</div><div class="line">* devices:æ§åˆ¶cgroupä¸­çš„ä»»åŠ¡å¯¹è®¾å¤‡çš„è®¿é—®èƒ½åŠ¡ï¼›</div><div class="line">* freezer: æŒ‚èµ·å’Œæ¢å¤cgroupä¸­çš„ä»»åŠ¡ï¼›      </div><div class="line">* net_cls:(classid) ï¼Œä½¿ç”¨ç­‰çº§çº§åˆ«æ ‡è¯†ç¬¦æ¥æ ‡è®°ç½‘ç»œæ•°æ®åŒ…ï¼›</div><div class="line">* tc: æµé‡æ•´å½¢å‘½ä»¤ ï¼›</div><div class="line">* perf_event:å¯¹ç”¨æˆ·ç©ºé—´ä¸­ä»»åŠ¡ï¼Œå¯¹ç”¨æˆ·ç©ºé—´äº§ç”Ÿçš„è¿›ç¨‹è¿›è¡Œåˆ†ç±»ï¼›</div><div class="line">* ä½¿ç”¨åä½¿cgrupä¸­çš„ä»»åŠ¡å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„æ€§èƒ½æµ‹è¯•ï¼›  </div><div class="line">* hugetlb:è½¬æ¢åå…ƒç¼“å†²åŒºï¼Œå¯¹HugeTLBå­ç³»ç»Ÿè¿›è¡Œé™åˆ¶ï¼›</div><div class="line"><span class="comment">### CGroupä¸­çš„æœ¯è¯­ï¼š</span></div><div class="line">* task(ä»»åŠ¡)ï¼šè¿›ç¨‹æˆ–çº¿ç¨‹ï¼›</div><div class="line">* cgroup:ä¸€ä¸ªç‹¬ç«‹çš„èµ„æºæ§åˆ¶å•ä½ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­ç³»ç»Ÿï¼›</div><div class="line">* subsystem:å­ç³»ç»Ÿï¼Œ</div><div class="line">* hierarchy:å±‚çº§</div><div class="line">* AUFS:UnionFSï¼š</div><div class="line">* UnionFSï¼šæŠŠä¸åŒçš„ç‰©ç†ä½ç½®çš„ç›®å½•åˆå¹¶åˆ°åŒä¸€ä¸ªç›®å½•ä¸­ã€‚</div><div class="line">* Another UFS,Alternative UFS,Adanced UFS å‡ ä¹å®Œå…¨é‡å†™äº†unix FS </div><div class="line"></div><div class="line">```bash</div><div class="line"><span class="comment"># tc  </span></div><div class="line"><span class="comment"># lssubsys -m</span></div></pre></td></tr></table></figure><h3 id="Device-mapper"><a href="#Device-mapper" class="headerlink" title="Device mapper:"></a>Device mapper:</h3><ul><li>linux 2.6å†…æ ¸å¼•å…¥çš„æœ€é‡è¦çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œç”¨äºåœ¨å†…æ ¸ä¸­æ”¯æŒé€»è¾‘å·ç®¡ç†çš„é€šç”¨è®¾å¤‡æ˜ å°„æŠ€æœ¯ï¼›</li><li>Mapped Device</li><li>Mapping Table</li><li>Target Device</li><li>åœ¨å†…æ ¸ç©ºé—´åªèƒ½å¼€å¯ä¸€ä¸ªç«¯ï¼Œä½†æ˜¯å¯ä»¥æ˜ å°„è‡³å…¶å®ƒçš„ç”¨æˆ·ç©ºé—´</li></ul><h3 id="Device-mapper-1"><a href="#Device-mapper-1" class="headerlink" title="Device mapper:"></a>Device mapper:</h3><ul><li>Linux2.6 å†…æ ¸å¼•å…¥çš„æœ€é‡è¦çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œç”¨äºåœ¨å†…æ ¸ ä¸­æ”¯æŒé€»è¾‘å·ç®¡ç†çš„é€šç”¨è®¾å¤‡æ˜ å°„æœºåˆ¶ï¼›</li><li>Mapped Device</li><li>Mapping Table</li><li>Target Device</li></ul><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul><li>2013,GO,Apache 2.0,dotCloud<h4 id="C-S"><a href="#C-S" class="headerlink" title="C/S:"></a>C/S:</h4></li><li>Docker Client:å‘èµ·dockerç›¸å…³çš„è¯·æ±‚</li><li>Docker Server:çª—å£è¿è¡Œçš„èŠ‚ç‚¹ï¼›</li><li>Containers å®¹å™¨</li><li>images  dockeræ˜ åƒæ–‡ä»¶ â€“&gt; å­˜äºä»“åº“ä¹‹ä¸­</li><li>å¯åŠ¨dockerå®¹å™¨éœ€è¦åŠ è½½é•œåƒæ–‡ä»¶ â€“&gt; dockerä»“åº“ä¸Šçš„é•œåƒåŠ è½½è¿›æ¥</li><li>dockerå…è®¸æˆ‘ä»¬åˆ›å»ºç§æœ‰ä»“åº“</li><li>æ¯”è¾ƒéš¾çš„ï¼Œå¦‚ä½•åˆ›å»ºæ˜ åƒæ–‡ä»¶</li><li>dockerfile:</li><li>namespace cgroup</li></ul><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><blockquote><p>lxc,openvz<br>lxc,linux container<br>libcontainer<br>Host OS â€“&gt; hypervisor â€“&gt; Guest OS<br>Host OS â€“&gt; hpervisor â€“&gt; user spaceï¼ˆnä¸ªï¼‰</p></blockquote><h3 id="æ ¸å¿ƒç»„ä»¶ï¼š"><a href="#æ ¸å¿ƒç»„ä»¶ï¼š" class="headerlink" title="æ ¸å¿ƒç»„ä»¶ï¼š"></a>æ ¸å¿ƒç»„ä»¶ï¼š</h3><blockquote><p>docker clientï¼šdockerçš„å®¢æˆ·ç«¯å·¥å…·ï¼Œæ˜¯ç”¨æˆ·ä½¿ç”¨dockerçš„ä¸»è¦æ¥å£ï¼Œdocker client ä¸docker daemoné€šä¿¡å¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·<br>docker deamon:è¿è¡Œäºå®¿ä¸»æœºä¸Šï¼ŒDockerå®ˆæŠ¤è¿›ç¨‹ ï¼Œç”¨æˆ·å¯é€šè¿‡docker clientå…¶äº¤äº’<br>image:é•œåƒæ–‡ä»¶æ˜¯åªè¯»çš„ï¼›ç”¨æ¥åˆ›å»ºcontainer,ä¸€ä¸ªé•œåƒå¯ä»¥è¿è¡Œå¤šä¸ªcontainer<br>é•œåƒæ–‡ä»¶å¯ä»¥é€šDockerfileæ–‡ä»¶æ¥åˆ›å»ºï¼Œå¯ä»¥ä»docker hub/registryä¸‹è½½ï¼›</p></blockquote><h3 id="repository"><a href="#repository" class="headerlink" title="repository"></a>repository</h3><blockquote><p>å…¬å…±ä»“åº“:Docker hub/registry<br>ç§æœ‰ä»“åº“:docker registry<br>ä»“åº“å¯ä»¥å­˜æœ‰:nginx image httpd image tomcat image<br>docker container: dockerçš„è¿è¡Œå®ä¾‹ï¼Œå®¹å™¨æ˜¯ä¸€ä¸ªéš”ç¦»ç¯å¢ƒï¼›  </p></blockquote><h3 id="å¦å¤–ä¸¤ä¸ªé‡è¦ç»„ä»¶ï¼š"><a href="#å¦å¤–ä¸¤ä¸ªé‡è¦ç»„ä»¶ï¼š" class="headerlink" title="å¦å¤–ä¸¤ä¸ªé‡è¦ç»„ä»¶ï¼š"></a>å¦å¤–ä¸¤ä¸ªé‡è¦ç»„ä»¶ï¼š</h3><blockquote><p>  docker link: å„dockerå®¹å™¨è¿™é—´èƒ½å¤Ÿé€šä¿¡<br>  docker volume:</p></blockquote><h2 id="äºŒã€Docker-YUMæºçš„å®‰è£…é…ç½®"><a href="#äºŒã€Docker-YUMæºçš„å®‰è£…é…ç½®" class="headerlink" title="äºŒã€Docker YUMæºçš„å®‰è£…é…ç½®"></a>äºŒã€Docker YUMæºçš„å®‰è£…é…ç½®</h2><h3 id="å®‰è£…ä½¿ç”¨docker-é€šè¿‡ä½¿ç”¨epelæºæ¥å®ç°ï¼Œ-CentOS7-è‡ªå¸¦çš„å°±æœ‰äº†"><a href="#å®‰è£…ä½¿ç”¨docker-é€šè¿‡ä½¿ç”¨epelæºæ¥å®ç°ï¼Œ-CentOS7-è‡ªå¸¦çš„å°±æœ‰äº†" class="headerlink" title="å®‰è£…ä½¿ç”¨docker é€šè¿‡ä½¿ç”¨epelæºæ¥å®ç°ï¼Œ CentOS7 è‡ªå¸¦çš„å°±æœ‰äº†"></a>å®‰è£…ä½¿ç”¨docker é€šè¿‡ä½¿ç”¨epelæºæ¥å®ç°ï¼Œ CentOS7 è‡ªå¸¦çš„å°±æœ‰äº†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">dockerfile </div><div class="line"> è‡ªå®šä¹‰çš„docker æº </div><div class="line"> [root@node1 ~]<span class="comment"># vim /etc/yum.repos.d/docker.repo </span></div><div class="line"> [dockerrepo]</div><div class="line"> name=Docker Repository</div><div class="line"> baseurl=https://yum.dockerproject.org/repo/main/centos/<span class="variable">$releasever</span>/</div><div class="line"> gpgcheck=1</div><div class="line"> gpgkey=https://yum.dockerproject.org/gpg</div><div class="line"> </div><div class="line">  [jin]</div><div class="line">  name=renjin2</div><div class="line">  baseurl=https://mirrors.aliyun.com/centos/7/os/x86_64/</div><div class="line">  gpgcheck=0</div><div class="line">  enabled=1</div><div class="line">  [extra]</div><div class="line">  name=renjin3</div><div class="line">  baseurl=https://mirrors.aliyun.com/centos/7/extras/x86_64/</div><div class="line">  gpgcheck=0</div><div class="line">  enabled=1</div><div class="line">  [epel]</div><div class="line">  name=renji4</div><div class="line">  baseurl=https://mirrors.aliyun.com/epel/7Server/x86_64/</div><div class="line">  gpgcheck=0</div><div class="line">  enabled=1</div><div class="line"> æˆ–è€…å¯ä»¥ä½¿ç”¨è‡ªå¸¦çš„æº https://mirrors.aliyun.com/centos/7.2.1511/extras/x86_64</div><div class="line"> æŸ¥çœ‹dockerç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># yum info docker-engine</span></div><div class="line">Loaded plugins: fastestmirror, langpacks</div><div class="line">Loading mirror speeds from cached hostfile</div><div class="line">Installed Packages</div><div class="line">Name        : docker-engine</div><div class="line">Arch        : x86_64</div><div class="line">Version     : 17.04.0.ce</div><div class="line">Release     : 1.el7.centos</div><div class="line">Size        : 63 M</div><div class="line">Repo        : installed</div><div class="line">From repo   : dockerrepo</div><div class="line">Summary     : The open-source application container engine</div><div class="line">URL         : https://dockerproject.org</div><div class="line">License     : ASL 2.0</div><div class="line">Description : Docker is an open <span class="built_in">source</span> project to build, ship and run any application as a</div><div class="line">   : lightweight container.</div><div class="line">   : </div><div class="line">   : Docker containers are both hardware-agnostic and platform-agnostic. This means</div><div class="line">   : they can run anywhere, from your laptop to the largest EC2 compute instance and</div><div class="line">   : everything <span class="keyword">in</span> between - and they don<span class="string">'t require you to use a particular</span></div><div class="line"><span class="string">   : language, framework or packaging system. That makes them great building blocks</span></div><div class="line"><span class="string">   : for deploying and scaling web apps, databases, and backend services without</span></div><div class="line"><span class="string">   : depending on a particular stack or provider.</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># yum -y install docker-engine</span></div><div class="line">[root@node1 ~]<span class="comment"># systemctl start docker.service</span></div></pre></td></tr></table></figure><h1 id="ä¸‰ã€Dcoker-çš„ç®€å•æµ‹è¯•åŠä½¿ç”¨"><a href="#ä¸‰ã€Dcoker-çš„ç®€å•æµ‹è¯•åŠä½¿ç”¨" class="headerlink" title="ä¸‰ã€Dcoker çš„ç®€å•æµ‹è¯•åŠä½¿ç”¨"></a>ä¸‰ã€Dcoker çš„ç®€å•æµ‹è¯•åŠä½¿ç”¨</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker images </span></div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">[root@node1 ~]<span class="comment"># docker search centos</span></div><div class="line">NAME                                   DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</div><div class="line">centos                                 The official build of CentOS.                   3239      [OK]       </div><div class="line">jdeathe/centos-ssh                     CentOS-6 6.8 x86_64 / CentOS-7 7.3.1611 x8...   63                   [OK]</div><div class="line">jdeathe/centos-ssh-apache-php          CentOS-6 6.8 x86_64 - Apache / PHP-FPM / P...   25                   [OK]</div><div class="line">consol/centos-xfce-vnc                 Centos container with <span class="string">"headless"</span> VNC sessi...   24                   [OK]</div><div class="line">nimmis/java-centos                     This is docker images of CentOS 7 with dif...   24                   [OK]</div><div class="line">gluster/gluster-centos                 Official GlusterFS Image [ CentOS-7 +  Glu...   18                   [OK]</div><div class="line">million12/centos-supervisor            Base CentOS-7 with supervisord launcher, h...   15                   [OK]</div><div class="line">torusware/speedus-centos               Always updated official CentOS docker imag...   8                    [OK]</div><div class="line">egyptianbman/docker-centos-nginx-php   A simple and highly configurable docker co...   6                    [OK]</div><div class="line">nathonfowlie/centos-jre                Latest CentOS image with the JRE pre-insta...   5                    [OK]</div><div class="line">centos/mariadb55-centos7                                                               4                    [OK]</div><div class="line">centos/redis                           Redis built <span class="keyword">for</span> CentOS                          2                    [OK]</div><div class="line">harisekhon/centos-java                 Java on CentOS (OpenJDK, tags jre/jdk7-8)       2                    [OK]</div><div class="line">harisekhon/centos-scala                Scala + CentOS (OpenJDK tags 2.10-jre7 - 2...   2                    [OK]</div><div class="line">blacklabelops/centos                   CentOS Base Image! Built and Updates Daily!     1                    [OK]</div><div class="line">darksheer/centos                       Base Centos Image -- Updated hourly             1                    [OK]</div><div class="line">freenas/centos                         Simple CentOS Linux interactive container       1                    [OK]</div><div class="line">timhughes/centos                       Centos with systemd installed and running       1                    [OK]</div><div class="line">januswel/centos                        yum update-ed CentOS image                      0                    [OK]</div><div class="line">kz8s/centos                            Official CentOS plus epel-release               0                    [OK]</div><div class="line">grayzone/centos                        auto build <span class="keyword">for</span> centos.                          0                    [OK]</div><div class="line">repositoryjp/centos                    Docker Image <span class="keyword">for</span> CentOS.                        0                    [OK]</div><div class="line">otagoweb/centos                        Apache (with PHP7), built on CentOS 7           0                    [OK]</div><div class="line">vcatechnology/centos                   A CentOS Image <span class="built_in">which</span> is updated daily           0                    [OK]</div><div class="line">grossws/centos                         CentOS 6 and 7 base images with gosu and l...   0                    [OK]</div></pre></td></tr></table></figure><h3 id="ä¹‹æ‰€ä»¥èƒ½æœç´¢å‡ºæ¥ï¼Œæ˜¯å› ä¸ºåˆ«äººç»™æˆ‘ä»¬åšäº†å…¬å¼€çš„ä½¿ç”¨"><a href="#ä¹‹æ‰€ä»¥èƒ½æœç´¢å‡ºæ¥ï¼Œæ˜¯å› ä¸ºåˆ«äººç»™æˆ‘ä»¬åšäº†å…¬å¼€çš„ä½¿ç”¨" class="headerlink" title="ä¹‹æ‰€ä»¥èƒ½æœç´¢å‡ºæ¥ï¼Œæ˜¯å› ä¸ºåˆ«äººç»™æˆ‘ä»¬åšäº†å…¬å¼€çš„ä½¿ç”¨"></a>ä¹‹æ‰€ä»¥èƒ½æœç´¢å‡ºæ¥ï¼Œæ˜¯å› ä¸ºåˆ«äººç»™æˆ‘ä»¬åšäº†å…¬å¼€çš„ä½¿ç”¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker search busybox</span></div><div class="line">NAME                            DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</div><div class="line">busybox                         Busybox base image.                             973       [OK]       </div><div class="line">progrium/busybox                                                                65                   [OK]</div><div class="line">radial/busyboxplus              Full-chain, Internet enabled, busybox made...   12                   [OK]</div><div class="line">container4armhf/armhf-busybox   Automated build of Busybox <span class="keyword">for</span> armhf devic...   6                    [OK]</div><div class="line">odise/busybox-python                                                            4                    [OK]</div><div class="line">multiarch/busybox               multiarch ports of ubuntu-debootstrap           2                    [OK]</div><div class="line">azukiapp/busybox                This image is meant to be used as the base...   2                    [OK]</div><div class="line">ofayau/busybox-jvm              Prepare busybox to install a 32 bits JVM.       2                    [OK]</div><div class="line">zanner/busybox                  https://github.com/sergej-kucharev/zanner-...   1                    [OK]</div><div class="line">ofayau/busybox-libc32           Busybox with 32 bits (and 64 bits) libs         1                    [OK]</div><div class="line">elektritter/busybox-teamspeak   Leightweight teamspeak3 container based on...   1                    [OK]</div><div class="line">getblank/busybox                Docker container busybox <span class="keyword">for</span> Blank              1                    [OK]</div><div class="line">prom/busybox                    Prometheus Busybox Docker base images           1                    [OK]</div><div class="line">skomma/busybox-data             Docker image suitable <span class="keyword">for</span> data volume cont...   1                    [OK]</div><div class="line">odise/busybox-curl                                                              1                    [OK]</div><div class="line">jahroots/busybox                Busybox containers                              0                    [OK]</div><div class="line">ggtools/busybox-ubuntu          Busybox ubuntu version with extra goodies       0                    [OK]</div><div class="line">cucy/busybox                    aouto  build busybox                            0                    [OK]</div><div class="line">freenas/busybox                 Simple Busybox interactive Linux container      0                    [OK]</div><div class="line">sdurrheimer/prom-busybox        Moved to https://hub.docker.com/r/prom/bus...   0                    [OK]</div><div class="line">jiangshouzhuang/busybox         busybox                                         0                    [OK]</div><div class="line">padcom/busybox-java             Oracle Java on BusyBox                          0                    [OK]</div><div class="line">futurenda/busybox               Mini busybox                                    0                    [OK]</div><div class="line">hongtao12310/busybox            <span class="keyword">for</span> busybox image based on the gcr.io/goog...   0                    [OK]</div><div class="line">ddn0/busybox                    fork of official busybox                        0                    [OK]</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> [root@node1 ~]<span class="comment"># docker pull buxybox</span></div><div class="line"> [root@node1 ~]<span class="comment"># docker pull busybox</span></div><div class="line"> Using default tag: latest</div><div class="line"> latest: Pulling from library/busybox</div><div class="line"> 7520415ce762: Pull complete </div><div class="line"> Digest: sha256:32f093055929dbc23dec4d03e09dfe971f5973a9ca5cf059cbfb644c206aa83f æ ¡éªŒç  </div><div class="line"> Status: Downloaded newer image <span class="keyword">for</span> busybox:latest</div><div class="line">[root@node1 ~]<span class="comment"># docker pull hub.magedu.com:5000/busybox ##æŒ‡å®šåˆ°å“ªå°æœåŠ¡å™¨ä¸Šè·å–busybox [root@node1 ~]# docker images </span></div><div class="line"> REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line"> busybox             latest              00f017a8c2a6        3 weeks ago         1.11MB</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker run -it busybox:latest /bin/sh ##å¯åŠ¨ä¸€å°è™šæ‹Ÿæœºçš„å®ä¾‹ </span></div><div class="line">/ <span class="comment"># ls</span></div><div class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</div><div class="line">[root@node1 ~]<span class="comment"># docker ps ##æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ä¸»æœº</span></div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line">7090d8fd9861        busybox:latest      <span class="string">"/bin/sh"</span>           2 minutes ago       Up 2 minutes                            boring_archimedes</div></pre></td></tr></table></figure><h1 id="å››ã€-dockerçš„å¸¸ç”¨å‘½ä»¤æ€»ç»“"><a href="#å››ã€-dockerçš„å¸¸ç”¨å‘½ä»¤æ€»ç»“" class="headerlink" title="å››ã€ dockerçš„å¸¸ç”¨å‘½ä»¤æ€»ç»“"></a>å››ã€ dockerçš„å¸¸ç”¨å‘½ä»¤æ€»ç»“</h1><h3 id="ç¯å¢ƒä¿¡æ¯ç›¸å…³ï¼š"><a href="#ç¯å¢ƒä¿¡æ¯ç›¸å…³ï¼š" class="headerlink" title="ç¯å¢ƒä¿¡æ¯ç›¸å…³ï¼š"></a>ç¯å¢ƒä¿¡æ¯ç›¸å…³ï¼š</h3><ul><li>info </li><li>version </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker info ##æŸ¥çœ‹dockerçš„ç¯å¢ƒä¿¡æ¯</span></div><div class="line">[root@node1 ~]<span class="comment"># docker version ##æŸ¥çœ‹dockerçš„ç‰ˆæœ¬å·</span></div></pre></td></tr></table></figure><h3 id="ç³»ç»Ÿç»´æŠ¤ç›¸å…³ï¼š"><a href="#ç³»ç»Ÿç»´æŠ¤ç›¸å…³ï¼š" class="headerlink" title="ç³»ç»Ÿç»´æŠ¤ç›¸å…³ï¼š"></a>ç³»ç»Ÿç»´æŠ¤ç›¸å…³ï¼š</h3><ul><li>images</li><li>inspect</li><li>build åˆ›å»ºæ˜ åƒæ–‡ä»¶</li><li>commint åŸºäºè¿è¡Œä¸­çš„å®¹å™¨åˆ›å»ºæ˜ åƒæ–‡ä»¶</li><li>pause/unpause</li><li>ps</li><li>rm</li><li>rmi</li><li>run</li><li>start/stop/restart</li><li>top</li><li>kill</li></ul><h3 id="æ—¥å¿—ä¿¡æ¯ç›¸å…³ï¼š"><a href="#æ—¥å¿—ä¿¡æ¯ç›¸å…³ï¼š" class="headerlink" title="æ—¥å¿—ä¿¡æ¯ç›¸å…³ï¼š"></a>æ—¥å¿—ä¿¡æ¯ç›¸å…³ï¼š</h3><ul><li>events</li><li>history</li><li>logs</li><li>Docer hubæœåŠ¡ç›¸å…³</li><li>login</li><li>logout</li><li>pull</li><li>push</li><li>search</li></ul><h3 id="åŸºæœ¬æ“ä½œï¼š"><a href="#åŸºæœ¬æ“ä½œï¼š" class="headerlink" title="åŸºæœ¬æ“ä½œï¼š"></a>åŸºæœ¬æ“ä½œï¼š</h3><ul><li>è·å–æ˜ åƒ:pull </li><li>å¯åŠ¨å®¹å™¨:run </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"> [root@node1 ~]<span class="comment"># docker ps </span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line"> 7090d8fd9861        busybox:latest      <span class="string">"/bin/sh"</span>           17 minutes ago      Up 17 minutes                           boring_archimedes</div><div class="line"> [root@node1 ~]<span class="comment"># docker kill 7090d8fd9861</span></div><div class="line"> 7090d8fd9861</div><div class="line"> [root@node1 ~]<span class="comment"># docker ps #ç»“æŸä¸€ä¸ªdockerè¿›ç¨‹ </span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line"> [root@node1 ~]<span class="comment"># docker ps  -a #ä½†ä¸ä¼šåˆ é™¤å®¹å™¨</span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES</div><div class="line"> 7090d8fd9861        busybox:latest      <span class="string">"/bin/sh"</span>           20 minutes ago      Exited (137) 3 minutes ago                       boring_archimedes</div><div class="line"> [root@node1 ~]<span class="comment"># docker rm 7090d8fd9861 #æ­¤æ—¶ä¼šåˆ é™¤container</span></div><div class="line"> 7090d8fd9861</div><div class="line"> [root@node1 ~]<span class="comment"># docker ps  -a </span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line"> [root@node1 ~]<span class="comment"># docker ps </span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line"> 2bca1aa3d38d        busybox:latest      <span class="string">"/bin/sh"</span>           4 minutes ago       Up 4 minutes                            naughty_goldberg</div><div class="line">[root@node1 ~]<span class="comment"># docker</span></div><div class="line"> docker                  docker-containerd-ctr   dockerd                 docker-proxy</div><div class="line"> docker-containerd       docker-containerd-shim  docker-init             docker-runc</div><div class="line">[root@node1 ~]<span class="comment"># docker commit 2bca1aa3d38d centos:newuser</span></div><div class="line"> sha256:08d1d05a6e490c31b0e4e3ffb9532a25bb3d9e8f588b30990338f1ae64b34286</div><div class="line">[root@node1 ~]<span class="comment"># docker</span></div><div class="line"> docker                  docker-containerd-ctr   dockerd                 docker-proxy</div><div class="line"> docker-containerd       docker-containerd-shim  docker-init             docker-runc</div><div class="line">[root@node1 ~]<span class="comment"># docker images</span></div><div class="line"> REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line"> centos              newuser             08d1d05a6e49        9 seconds ago       1.11MB</div><div class="line"> busybox             latest              00f017a8c2a6        3 weeks ago         1.11MB</div><div class="line">[root@node1 ~]<span class="comment"># docker run -it --rm centos:newuser /bin/sh</span></div><div class="line"> / <span class="comment"># </span></div><div class="line">[root@node1 ~]<span class="comment"># docker kill fee1da85d418</span></div><div class="line"> fee1da85d418</div><div class="line">[root@node1 ~]<span class="comment"># docker ps -a </span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div></pre></td></tr></table></figure><ul><li>linux Kernel â€“&gt; libcontainer â€“&gt; (execdriverã€networkdriver)â€“&gt; Docker Daemon (GraphDB) â€“&gt; API server â€“&gt; ç”¨æˆ·<br>åœ¨docker ä¹‹å¤–æœ‰ä¸ªé‡è¦å­˜å‚¨è¿˜éœ€è¦GraphDB GraphDBä¹Ÿç§°ä¸ºå›¾å¼æ•°æ®åº“</li></ul><h2 id="Dockeråº”ç”¨ï¼š"><a href="#Dockeråº”ç”¨ï¼š" class="headerlink" title="Dockeråº”ç”¨ï¼š"></a>Dockeråº”ç”¨ï¼š</h2><ul><li>é•œåƒï¼šåŒ…å«äº†å¯åŠ¨Dockerå®¹å™¨æ‰€éœ€è¦çš„æ–‡ä»¶ç³»ç»Ÿå±‚ç»™åŠå…¶å†…å®¹ï¼›</li><li>åŸºäºUninFSé‡‡ç”¨åˆ†å±‚ç»“æ„å®ç°;<br>  bootfs,rootfs;</li><li>registry:ç”¨äºä¿å­˜é•œåƒçš„å…ƒæ•°æ®,ä¿å­˜dockeré•œåƒå±‚æ¬¡ç»“æ„å’Œå…ƒæ•°æ®ï¼›</li><li>reposistory:ç”±å…·æœ‰æŸä¸ªåŠŸèƒ½çš„é•œåƒçš„æ‰€æœ‰ç›¸å…³ç‰ˆæœ¬æ„å»ºæˆçš„é›†åˆï¼›</li><li>index:ç®¡ç†ç”¨æˆ·çš„è´¦å·ã€è®¿é—®æƒé™ã€é•œåƒåŠé•œåƒæ ‡ç­¾ç­‰ç­‰ç›¸å…³çš„;</li><li>graph:ä»registryä¸­ä¸‹è½½çš„Dockeré•œåƒéœ€è¦ä¿å­˜åœ¨æœ¬åœ°ï¼Œæ­¤åŠŸèƒ½å³ç”±graphå®Œæˆï¼›</li><li>/var/lib/docker/graph;</li></ul><p>##ä¸é•œåƒç›¸å…³çš„å‘½ä»¤ï¼š</p><ul><li>docker images  åˆ—å‡ºæœ¬åœ°çš„é•œåƒ</li><li>docker search   æœç´¢</li><li>docker pull  ä¸‹è½½é•œåƒ</li><li>docker push   ä¸Šä¼ é•œåƒ</li><li>docker login   ç™»å½•</li><li>docker logout  ç™»å‡º</li></ul><h2 id="åˆ›å»ºé•œåƒï¼šcommint-build"><a href="#åˆ›å»ºé•œåƒï¼šcommint-build" class="headerlink" title="åˆ›å»ºé•œåƒï¼šcommint,build"></a>åˆ›å»ºé•œåƒï¼šcommint,build</h2><ul><li>åˆ é™¤æœ¬åœ°é•œåƒ: rmi</li><li>å®¹å™¨ï¼šä¹Ÿå¯ä»¥æƒ³è±¡æˆä¸€ä¸ªè™šæ‹Ÿæœº</li><li>ç‹¬ç«‹è¿è¡Œçš„ä¸€ä¸ªæˆ–ä¸€ç»„åº”ç”¨ï¼Œä»¥åŠå®ƒä»¬è¿è¡Œçš„ç¯å¢ƒ</li></ul><h2 id="å‘½ä»¤ï¼š"><a href="#å‘½ä»¤ï¼š" class="headerlink" title="å‘½ä»¤ï¼š"></a>å‘½ä»¤ï¼š</h2><ul><li>run,kill,stop,start,restart ,log,export,import</li></ul><h2 id="å¯åŠ¨æ–¹æ³•"><a href="#å¯åŠ¨æ–¹æ³•" class="headerlink" title="å¯åŠ¨æ–¹æ³•:"></a>å¯åŠ¨æ–¹æ³•:</h2><ul><li>é€šè¿‡é•œåƒåˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨: run</li><li>å¯åŠ¨ä¸€ä¸ªå¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨: start</li></ul><h2 id="å®¹å™¨æœ¬æ¥å°±æ˜¯åº”ç”¨çš„ï¼Œå½“åº”ç”¨ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿä¼šç»“æŸçš„ï¼›"><a href="#å®¹å™¨æœ¬æ¥å°±æ˜¯åº”ç”¨çš„ï¼Œå½“åº”ç”¨ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿä¼šç»“æŸçš„ï¼›" class="headerlink" title="å®¹å™¨æœ¬æ¥å°±æ˜¯åº”ç”¨çš„ï¼Œå½“åº”ç”¨ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿä¼šç»“æŸçš„ï¼›"></a>å®¹å™¨æœ¬æ¥å°±æ˜¯åº”ç”¨çš„ï¼Œå½“åº”ç”¨ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿä¼šç»“æŸçš„ï¼›</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker run busybox:latest /bin/echo "hello world"</span></div><div class="line"> hello world</div><div class="line"></div><div class="line">[root@node1 ~]<span class="comment"># docker run -it --name=busybox busybox:latest /bin/sh</span></div><div class="line">[root@node1 ~]<span class="comment"># docker stop busybox ##æ­£å¸¸åœæ­¢ä¸€ä¸ªå®¹å™¨ï¼Œç›¸å½“äºæ­£å¸¸å…³æœº</span></div><div class="line"> busybox</div></pre></td></tr></table></figure><h2 id="runå‘½ä»¤"><a href="#runå‘½ä»¤" class="headerlink" title="runå‘½ä»¤:"></a>runå‘½ä»¤:</h2><blockquote><p> â€“name= Assign a name to the container<br>-i,â€“interactive=false Keep STDIN open even if not attached<br>it,-tty=false Alocate a pseudo-TTY<br>â€“net=default Set the Network for the container</p></blockquote><h2 id="æ­¥éª¤ï¼š"><a href="#æ­¥éª¤ï¼š" class="headerlink" title="æ­¥éª¤ï¼š"></a>æ­¥éª¤ï¼š</h2><blockquote><p>æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„é•œåƒï¼Œä¸å­˜åœ¨åˆ™ä»registryä¸‹è½½ï¼›<br>åˆ©ç”¨é•œåƒå¯åŠ¨å®¹å™¨<br>åˆ†é…ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åœ¨åªè¯»çš„é•œåƒå±‚ä¹‹å¤–ï¼ŒæŒ‚è½½ä¸€ä¸ªå¯è¯»å†™å±‚ï¼›<br>ä»å®¿ä¸»æœºé…ç½®çš„ç½‘æ¡¥å£ä¸­ï¼Œæ¡¥æ¥ä¸€ä¸ªè™šæ‹Ÿæ¥å£ç»™æ­¤å®¹å™¨;<br>ä»åœ°å€æ± ä¸­åˆ†é…ä¸€ä¸ªåœ°å€å®¹å™¨ï¼›<br>æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„åº”ç”¨ç¨‹åºï¼›<br>ç¨‹åºæ‰§è¡Œå®Œæˆåï¼Œå®¹å™¨å³ç»ˆæ­¢ï¼›<br>logså‘½ä»¤:è·å–ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—ï¼Œè·å–å…¶è¾“å‡ºä¿¡æ¯;<br>å¯¹äºäº¤äº’å¼æ¨¡å¼å¯åŠ¨çš„å®¹å™¨ï¼Œç»ˆæ­¢å¯ä»¥ä½¿ç”¨exit å‘½ä»¤æˆ–ctrl+dç»„åˆé”®;</p></blockquote><h2 id="attach-é™„åŠ è‡³ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ï¼›"><a href="#attach-é™„åŠ è‡³ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ï¼›" class="headerlink" title="attach  é™„åŠ è‡³ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ï¼›"></a>attach  é™„åŠ è‡³ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ï¼›</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]<span class="comment"># docker start 31a67d66b2c2</span></div><div class="line">[root@node1 ~]<span class="comment"># docker attach busybox</span></div><div class="line">[root@node1 ~]<span class="comment"># docker run busybox:latest /bin/echo "hello world"</span></div><div class="line">[root@node1 ~]<span class="comment"># docker ps -a </span></div><div class="line"> CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES</div><div class="line"> d35a2673722e        busybox:latest      <span class="string">"/bin/echo 'hello ..."</span>   13 seconds ago      Exited (0) 12 seconds </div><div class="line">[root@node1 ~]<span class="comment"># docker start d35a2673722e  </span></div><div class="line"> d35a2673722e</div><div class="line">[root@node1 ~]<span class="comment"># docker logs  cabd0e52f8f8 ##å¯ä»¥æŸ¥çœ‹æ‰§è¡Œå‘½ä»¤åçš„è¾“å‡ºä¿¡æ¯</span></div><div class="line"> hello world</div><div class="line"> hello world</div><div class="line"> hello world</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"> / <span class="comment"># exit ç»ˆæ­¢å½“å‰å®¹å™¨  æˆ–è€…ctrl +d </span></div><div class="line"> attach </div><div class="line"> [root@node1 ~]<span class="comment"># docker start -i busybox  ##å¯åŠ¨ä¸€ä¸ªäº¤äº’å¼ä¸€ä¸ªæ¥å£</span></div><div class="line"> [root@node1 ~]<span class="comment"># docker start busybox </span></div><div class="line"> [root@node1 ~]<span class="comment"># docker attach busybox   ##é™„åŠ è‡³ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨ï¼›</span></div><div class="line"> / <span class="comment"># </span></div><div class="line">```  </div><div class="line">  </div><div class="line"><span class="comment">## Docker Hub  </span></div><div class="line"></div><div class="line">* registryæœ‰ä¸¤ç§</div><div class="line">* docker hub</div><div class="line">* private registry</div><div class="line"></div><div class="line">```bash</div><div class="line"> <span class="comment"># docker login</span></div><div class="line"> <span class="comment"># docker push busybox:latest</span></div><div class="line"> [root@node2 yum.repos.d]<span class="comment"># yum -y install docker-registry</span></div><div class="line"> ä¸Šæ¡å‘½ä»¤å®è´¨ä¸Šå®‰è£…çš„æ˜¯å¦å¤–çš„ä¸€ä¸ªåŒ…</div><div class="line"> [root@node2 yum.repos.d]<span class="comment"># yum -y installdocker-distribution-2.6.0-1.el7.x86_64</span></div><div class="line"> [root@node1 yum.repos.d]<span class="comment"># systemctl start docker-distribution.service </span></div><div class="line"> [root@node1 yum.repos.d]<span class="comment"># ss -tnl | grep 5000</span></div><div class="line"> LISTEN     0      128         :::5000                    :::* </div><div class="line"> [root@node1 yum.repos.d]<span class="comment"># docker images </span></div><div class="line"> REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line"> centos              newuser             08d1d05a6e49        2 weeks ago         1.11MB</div><div class="line"> centos              latest              98d35105a391        5 weeks ago         192MB</div><div class="line"> busybox             latest              00f017a8c2a6        6 weeks ago         1.11MB</div><div class="line"> [root@node1 yum.repos.d]<span class="comment"># </span></div><div class="line"> [root@node1 yum.repos.d]<span class="comment"># docker tag 08d1d05a6e49  192.168.99.15:5000/centos:1.2.1 ç»™ä¸€ä¸ªé•œåƒæ‰“æ ‡ç­¾ </span></div><div class="line"> [root@node1 yum.repos.d]<span class="comment"># docker push 192.168.99.15:5000/centos:1.2.1</span></div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>ldirectord+ipvsadmä¹‹nat/dræ¨¡å‹çš„å®ç°</title>
      <link href="/2017/10/26/ldirectord-ipvsadm%E4%B9%8Bnat-dr%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
      <url>/2017/10/26/ldirectord-ipvsadm%E4%B9%8Bnat-dr%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<h1 id="ldirectord-ç»“åˆipvsadm-é…ç½®nat-dræ¨¡å‹"><a href="#ldirectord-ç»“åˆipvsadm-é…ç½®nat-dræ¨¡å‹" class="headerlink" title="ldirectord ç»“åˆipvsadm é…ç½®nat,dræ¨¡å‹"></a>ldirectord ç»“åˆipvsadm é…ç½®nat,dræ¨¡å‹</h1><h2 id="ä¸€ã€natæ¨¡å‹"><a href="#ä¸€ã€natæ¨¡å‹" class="headerlink" title="ä¸€ã€natæ¨¡å‹"></a>ä¸€ã€natæ¨¡å‹</h2><ul><li>drector  </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># wget ftp://172.16.0.1/pub/Sources/7.x86_64/crmsh/ldirectord-3.9.6-0rc1.1.1.x86_64.rpm</span></div><div class="line"><span class="comment"># yum -y install nginx (åŒæ—¶ç”¨äºåšä¸ºsorryä¸»æœº)</span></div><div class="line"><span class="comment"># yum -y install ldirectord-3.9.6-0rc1.1.1.x86_64.rpm</span></div><div class="line"><span class="comment"># echo â€œsorry, the service is down for maintenance, is recoveringâ€ &gt; /usr/share/nginx/html/index.html</span></div></pre></td></tr></table></figure><h3 id="ä¸»æœºä¸ºä¸¤å—ç½‘å¡ï¼Œ-ä¸€ä¸ªæ˜¯æ¡¥æ¥ï¼Œä¸€ä¸ªä»…ä¸»æœº-å…¶ä¸­ä»…ä¸»æœºçš„é…ç½®é™æ€åœ°å€ä¸º192-16-0-5"><a href="#ä¸»æœºä¸ºä¸¤å—ç½‘å¡ï¼Œ-ä¸€ä¸ªæ˜¯æ¡¥æ¥ï¼Œä¸€ä¸ªä»…ä¸»æœº-å…¶ä¸­ä»…ä¸»æœºçš„é…ç½®é™æ€åœ°å€ä¸º192-16-0-5" class="headerlink" title="ä¸»æœºä¸ºä¸¤å—ç½‘å¡ï¼Œ ä¸€ä¸ªæ˜¯æ¡¥æ¥ï¼Œä¸€ä¸ªä»…ä¸»æœº (å…¶ä¸­ä»…ä¸»æœºçš„é…ç½®é™æ€åœ°å€ä¸º192.16.0.5)"></a>ä¸»æœºä¸ºä¸¤å—ç½‘å¡ï¼Œ ä¸€ä¸ªæ˜¯æ¡¥æ¥ï¼Œä¸€ä¸ªä»…ä¸»æœº (å…¶ä¸­ä»…ä¸»æœºçš„é…ç½®é™æ€åœ°å€ä¸º192.16.0.5)</h3><ul><li>å¼€å¯æ ¸å¿ƒè½¬å‘åŠŸèƒ½ </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo 1 &gt; /proc/sys/net/ipv4/ip_forward </span></div><div class="line">nodeff1</div><div class="line"><span class="comment"># yum -y install httpd </span></div><div class="line"><span class="comment"># echo â€œ&lt;h1&gt;RS1&lt;/h1&gt;â€ &gt; /var/www/html/index.html</span></div></pre></td></tr></table></figure><h3 id="ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192-16-0-2ï¼‰"><a href="#ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192-16-0-2ï¼‰" class="headerlink" title="ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192.16.0.2ï¼‰"></a>ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192.16.0.2ï¼‰</h3><h3 id="ç½‘å…³æŒ‡å‘-192-16-0-5"><a href="#ç½‘å…³æŒ‡å‘-192-16-0-5" class="headerlink" title="ç½‘å…³æŒ‡å‘ 192.16.0.5"></a>ç½‘å…³æŒ‡å‘ 192.16.0.5</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># route add default gw 192.16.0.5 </span></div><div class="line">node2   </div><div class="line"><span class="comment"># yum -y install nginx </span></div><div class="line"><span class="comment"># echo â€œ&lt;h1&gt;RS2&lt;/h1&gt;â€ &gt; /var/www/html/index.html</span></div></pre></td></tr></table></figure><h3 id="ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192-16-0-3ï¼‰"><a href="#ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192-16-0-3ï¼‰" class="headerlink" title="ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192.16.0.3ï¼‰"></a>ä¸»æœºä¸ºä¸€å—ç½‘å¡ï¼Œä»…ä¸»æœºï¼ˆé…ç½®é™æ€åœ°å€ä¸º192.16.0.3ï¼‰</h3><h3 id="ç½‘å…³æŒ‡å‘-192-16-0-5-1"><a href="#ç½‘å…³æŒ‡å‘-192-16-0-5-1" class="headerlink" title="ç½‘å…³æŒ‡å‘ 192.16.0.5"></a>ç½‘å…³æŒ‡å‘ 192.16.0.5</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># route add default gw 192.16.0.5</span></div></pre></td></tr></table></figure><h3 id="directory-æ­¤æ—¶-å¯ä»¥åœ¨drectorä¸»æœºä¸Šè¿›è¡Œæµ‹è¯•ï¼Œ"><a href="#directory-æ­¤æ—¶-å¯ä»¥åœ¨drectorä¸»æœºä¸Šè¿›è¡Œæµ‹è¯•ï¼Œ" class="headerlink" title="directory æ­¤æ—¶:å¯ä»¥åœ¨drectorä¸»æœºä¸Šè¿›è¡Œæµ‹è¯•ï¼Œ"></a>directory æ­¤æ—¶:å¯ä»¥åœ¨drectorä¸»æœºä¸Šè¿›è¡Œæµ‹è¯•ï¼Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># curl 192.16.0.2 è¿”å›RS1 </span></div><div class="line"><span class="comment"># curl 192.16.0.3 è¿”å›RS2</span></div></pre></td></tr></table></figure><h3 id="directory-ä½¿ç”¨ipvsadmæŒ‡å®šè°ƒåº¦ç®—æ³•åŠè°ƒåº¦ä¸»æœºï¼›"><a href="#directory-ä½¿ç”¨ipvsadmæŒ‡å®šè°ƒåº¦ç®—æ³•åŠè°ƒåº¦ä¸»æœºï¼›" class="headerlink" title="directory ä½¿ç”¨ipvsadmæŒ‡å®šè°ƒåº¦ç®—æ³•åŠè°ƒåº¦ä¸»æœºï¼›"></a>directory ä½¿ç”¨ipvsadmæŒ‡å®šè°ƒåº¦ç®—æ³•åŠè°ƒåº¦ä¸»æœºï¼›</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ipvsadm -A -t 172.16.250.89:80 -wrr </span></div><div class="line"><span class="comment"># ipvsadm -a -t 172.16.250.89:80 -r 192.16.0.2:80 -m -w 3 </span></div><div class="line"><span class="comment"># ipvsadm -a -t 172.16.250.89:80 -r 192.16.0.3:80 -m -w 1</span></div></pre></td></tr></table></figure><h3 id="åœ¨åˆ«çš„ä¸»æœºä¸­æµ‹è¯•ç»“æœ"><a href="#åœ¨åˆ«çš„ä¸»æœºä¸­æµ‹è¯•ç»“æœ" class="headerlink" title="åœ¨åˆ«çš„ä¸»æœºä¸­æµ‹è¯•ç»“æœ"></a>åœ¨åˆ«çš„ä¸»æœºä¸­æµ‹è¯•ç»“æœ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..4&#125; ; do curl 172.16.250.89; done </span></div><div class="line">&lt;h1&gt;RS1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h1&gt;</div><div class="line"><span class="comment"># å°†è§„åˆ™ä¿å­˜ ipvsadm -S &gt; /etc/sysconfig/ipvsadm</span></div></pre></td></tr></table></figure><ul><li>directory é…ç½®ldirectord </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cp /usr/share/doc/ldirectord-3.9.6/ldirectord.cf /etc/ha.d/ldirectord.cf </span></div><div class="line"><span class="comment"># vim /etc/ha.d/ldirectord.cf </span></div><div class="line">checktimeout=3</div><div class="line">checkinterval=1</div><div class="line">fallback=127.0.0.1:80</div><div class="line">autoreload=yes</div><div class="line">logfile=â€/var/<span class="built_in">log</span>/ldirectord.logâ€</div><div class="line">quiescent=no</div><div class="line">virtual=172.16.250.89:80 </div><div class="line">real=192.16.0.2:80 masq 1</div><div class="line">real=192.16.0.3:80 masq 3</div><div class="line">fallback=127.0.0.1:80 masq</div><div class="line">service=http</div><div class="line">scheduler=wrr</div><div class="line">protocol=tcp</div><div class="line">checktype=negotiate</div><div class="line">checkport=80</div></pre></td></tr></table></figure><h3 id="æ³¨ï¼švirtual-172-16-250-89-80-ï¼Œåé¢éœ€è¦æŒ‡å®šç«¯å£ï¼Œå¦åˆ™protocol-tcpæŒ‡å®šå¯åŠ¨æ—¶ä¼šæŠ¥é”™"><a href="#æ³¨ï¼švirtual-172-16-250-89-80-ï¼Œåé¢éœ€è¦æŒ‡å®šç«¯å£ï¼Œå¦åˆ™protocol-tcpæŒ‡å®šå¯åŠ¨æ—¶ä¼šæŠ¥é”™" class="headerlink" title="æ³¨ï¼švirtual:172.16.250.89:80 ï¼Œåé¢éœ€è¦æŒ‡å®šç«¯å£ï¼Œå¦åˆ™protocol=tcpæŒ‡å®šå¯åŠ¨æ—¶ä¼šæŠ¥é”™"></a>æ³¨ï¼švirtual:172.16.250.89:80 ï¼Œåé¢éœ€è¦æŒ‡å®šç«¯å£ï¼Œå¦åˆ™protocol=tcpæŒ‡å®šå¯åŠ¨æ—¶ä¼šæŠ¥é”™</h3><h3 id="real-192-16-0-2-80-masq-å› ä¸ºä¸Šé¢é…ç½®çš„ä¸ºnatæ¨¡å‹ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨masq"><a href="#real-192-16-0-2-80-masq-å› ä¸ºä¸Šé¢é…ç½®çš„ä¸ºnatæ¨¡å‹ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨masq" class="headerlink" title="real=192.16.0.2:80 masq  å› ä¸ºä¸Šé¢é…ç½®çš„ä¸ºnatæ¨¡å‹ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨masq"></a>real=192.16.0.2:80 masq  å› ä¸ºä¸Šé¢é…ç½®çš„ä¸ºnatæ¨¡å‹ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨masq</h3><h3 id="fallback-172-0-0-1-80-æ­¤å¤„ä¾¿æ˜¯nginxçš„sorry-server-ä½†æ‰€æœ‰ç»“ç‚¹éƒ½åœæ‰æ—¶ï¼Œä¼šå‘ç”¨æˆ·æä¾›ä¸€ä¸ªsorry-server"><a href="#fallback-172-0-0-1-80-æ­¤å¤„ä¾¿æ˜¯nginxçš„sorry-server-ä½†æ‰€æœ‰ç»“ç‚¹éƒ½åœæ‰æ—¶ï¼Œä¼šå‘ç”¨æˆ·æä¾›ä¸€ä¸ªsorry-server" class="headerlink" title="fallback=172.0.0.1:80 æ­¤å¤„ä¾¿æ˜¯nginxçš„sorry server,ä½†æ‰€æœ‰ç»“ç‚¹éƒ½åœæ‰æ—¶ï¼Œä¼šå‘ç”¨æˆ·æä¾›ä¸€ä¸ªsorry server"></a>fallback=172.0.0.1:80 æ­¤å¤„ä¾¿æ˜¯nginxçš„sorry server,ä½†æ‰€æœ‰ç»“ç‚¹éƒ½åœæ‰æ—¶ï¼Œä¼šå‘ç”¨æˆ·æä¾›ä¸€ä¸ªsorry server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl start ldirectord </span></div><div class="line"><span class="comment"># ipvsadm -Ln æŸ¥çœ‹ç»“ç‚¹ </span></div><div class="line">åœ¨åˆ«çš„ä¸»æœºä¸­æµ‹è¯• </div><div class="line"><span class="comment">#for i in &#123;1..4&#125; ; do curl 172.16.250.89; done </span></div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">node1,node2 å°†ä¸¤ä¸ªç»“ç‚¹æ‰‹åŠ¨åœæ‰</div><div class="line"><span class="comment"># systemctl stop httpd  åœ¨æµ‹è¯•ä¸»æœºä¸­ä¼šè¿”å›sorryä¿¡æ¯</span></div></pre></td></tr></table></figure><h1 id="äºŒã€dr-æ¨¡å‹"><a href="#äºŒã€dr-æ¨¡å‹" class="headerlink" title="äºŒã€dr æ¨¡å‹"></a>äºŒã€dr æ¨¡å‹</h1><ul><li>directory ,node1 ,node2 ä¸‰å°ä¸»æœºéƒ½æ˜¯ä¸€å—ç½‘å—ï¼Œ å¹¶ä¸”ç½‘å¡éƒ½ä¸ºæ¡¥æ¥ï¼Œä¸”node1,nod2ï¼Œä¸éœ€è¦æŒ‡å®šç½‘å…³<h3 id="ç¼–å†™è„šæœ¬"><a href="#ç¼–å†™è„šæœ¬" class="headerlink" title="ç¼–å†™è„šæœ¬"></a>ç¼–å†™è„šæœ¬</h3></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#vim setkp.sh </span></div><div class="line"><span class="meta">#!/bin/bash </span></div><div class="line">vip=172.16.252.166</div><div class="line">mask=255.255.255.255</div><div class="line">interface=â€™lo:0â€²</div><div class="line">eth=â€™eno16777736:0â€² </div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </div><div class="line">start) </div><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line">ifconfig <span class="variable">$interface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up </div><div class="line">route add -host <span class="variable">$vip</span> dev <span class="variable">$interface</span> </div><div class="line">;; </div><div class="line">dstart) </div><div class="line">ifconfig <span class="variable">$eth</span> <span class="variable">$vip</span>/32 netmask <span class="variable">$mask</span> broadcast <span class="variable">$vip</span> up</div><div class="line">;;</div><div class="line">dstop)</div><div class="line">ifconfig <span class="variable">$eth</span> down</div><div class="line">;;</div><div class="line">stop)</div><div class="line">ifconfig <span class="variable">$interface</span> down </div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line">;; </div><div class="line">status) </div><div class="line">ifconfig </div><div class="line">cat /proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line">cat /proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line">cat /proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line">cat /proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line">;; </div><div class="line">*)</div><div class="line"><span class="built_in">echo</span> â€œUsage: $(basename <span class="variable">$0</span>) &#123;dstart|dstop|start|stop&#125;â€</div><div class="line"><span class="built_in">exit</span> 1 </div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure><h3 id="åœ¨directorä¸»æœºä¸­æ‰§è¡Œ"><a href="#åœ¨directorä¸»æœºä¸­æ‰§è¡Œ" class="headerlink" title="åœ¨directorä¸»æœºä¸­æ‰§è¡Œ"></a>åœ¨directorä¸»æœºä¸­æ‰§è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sh setkp.sh dstart </span></div><div class="line"><span class="comment"># sh setkp.sh status æŸ¥çœ‹çŠ¶æ€</span></div><div class="line"><span class="comment"># scp setkp.sh 172.16.251.232:/root</span></div><div class="line"><span class="comment"># scp setkp.sh 172.16.251.191:/root </span></div><div class="line"><span class="comment"># ipvsadm -A -t 172.16.252.166:http -s wrr</span></div><div class="line"><span class="comment"># ipvsadm -a -t 172.16.252.166:http -r 172.16.251.232:http -g -w 1</span></div><div class="line"><span class="comment"># ipvsadm -a -t 172.16.252.166:http -r 172.16.251.191:http -g -w 3</span></div><div class="line"><span class="comment"># systemctl start nginx </span></div><div class="line"><span class="comment"># echo â€œSorry Pageâ€ &gt; /usr/share/nginx/html/index.html</span></div></pre></td></tr></table></figure><h3 id="åœ¨node1ä¸»æœºä¸­æ‰§è¡Œ"><a href="#åœ¨node1ä¸»æœºä¸­æ‰§è¡Œ" class="headerlink" title="åœ¨node1ä¸»æœºä¸­æ‰§è¡Œ"></a>åœ¨node1ä¸»æœºä¸­æ‰§è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sh setkp.sh start </span></div><div class="line"><span class="comment"># sh setkp.sh status </span></div><div class="line"><span class="comment"># systemctl start httpd </span></div><div class="line"><span class="built_in">echo</span> â€œ&lt;h1&gt;NODE1&lt;/h1&gt;â€ &gt; /var/www/html/index.html</div></pre></td></tr></table></figure><h3 id="åœ¨node2ä¸»æœºä¸­æ‰§è¡Œ"><a href="#åœ¨node2ä¸»æœºä¸­æ‰§è¡Œ" class="headerlink" title="åœ¨node2ä¸»æœºä¸­æ‰§è¡Œ"></a>åœ¨node2ä¸»æœºä¸­æ‰§è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sh setkp.sh start</span></div><div class="line"><span class="comment"># sh setkp.sh status </span></div><div class="line"><span class="comment"># systemctl start httpd </span></div><div class="line"><span class="built_in">echo</span> â€œ&lt;h2&gt;NODE2&lt;/h2&gt;â€ &gt; /var/www/html/index.html</div></pre></td></tr></table></figure><h3 id="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•"><a href="#åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•" class="headerlink" title="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•"></a>åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#for i in &#123;1..4&#125; ; do curl 172.16.252.166; done </div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div></pre></td></tr></table></figure><ul><li>ldirectordé…ç½®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/ha.d/ldirectord.cf | grep -v  â€œ^[[:space:]]*#â€ | grep -v â€œ^[[:space:]]*$â€ </span></div><div class="line"><span class="comment"># vim /etc/ha.d/ldirectord.cf </span></div><div class="line">checktimeout=3</div><div class="line">checkinterval=1</div><div class="line">fallback=127.0.0.1:80</div><div class="line">autoreload=yes</div><div class="line">logfile=â€/var/<span class="built_in">log</span>/ldirectord.logâ€</div><div class="line">quiescent=no</div><div class="line">virtual=172.16.252.166:80</div><div class="line">real=172.16.251.191:80 gate 1</div><div class="line">real=172.16.251.232:80 gate 3</div><div class="line">fallback=127.0.0.1:80 gate</div><div class="line">service=http</div><div class="line">scheduler=wrr</div><div class="line">protocol=tcp</div><div class="line">checktype=negotiate</div><div class="line">checkport=80</div><div class="line"><span class="comment"># systemctl start ldirectord</span></div></pre></td></tr></table></figure><h3 id="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-1"><a href="#åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-1" class="headerlink" title="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•"></a>åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..4&#125; ; do curl 172.16.252.166; done </span></div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">å½“ä¸»æœºæ‰€æœ‰ç»“ç‚¹éƒ½åœæ­¢æœåŠ¡æ—¶ ï¼ˆnode1,node2ï¼‰</div><div class="line"><span class="comment"># systemctl stop httpd </span></div><div class="line"><span class="comment"># for i in &#123;1..4&#125; ; do curl 172.16.252.166; done </span></div><div class="line">Sorry Page</div><div class="line">Sorry Page</div><div class="line">Sorry Page</div><div class="line">Sorry Page</div></pre></td></tr></table></figure><ul><li>å€ŸåŠ©é˜²ç«å¢™æ ‡è®°æ¥åˆ†ç±»æŠ¥æ–‡,è€Œåæ ‡è®°å®šä¹‰é›†ç¾¤æœåŠ¡ï¼Œè¿™æ ·ä¸åŒçš„æœåŠ¡å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé›†ç¾¤è¿›è¡Œè°ƒåº¦,å¹¶å¯ç”¨æŒä¹…è¿æ¥ </li><li>å°†ä¸¤å°nodeç»“ç‚¹å¯åŠ¨ </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl start httpd</span></div></pre></td></tr></table></figure><h3 id="åœ¨directorä¸»æœºä¸­é…ç½®"><a href="#åœ¨directorä¸»æœºä¸­é…ç½®" class="headerlink" title="åœ¨directorä¸»æœºä¸­é…ç½®"></a>åœ¨directorä¸»æœºä¸­é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.252.166 -p tcp -m multiport â€“dport 80,443 -j MARK â€“set-mark 10 ä¸ºç«¯å£æ‰“æ ‡è®° </span></div><div class="line"><span class="comment"># ipvsadm -A -f 10 -s rr -p 360</span></div><div class="line"><span class="comment"># ipvsadm -a -f 10 -r 172.16.251.191:0 -g -w 1</span></div><div class="line"><span class="comment"># ipvsadm -a -f 10 -r 172.16.251.232:0 -g -w 1</span></div></pre></td></tr></table></figure><h3 id="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-2"><a href="#åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-2" class="headerlink" title="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•"></a>åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..5&#125; ; do curl 172.16.252.166; done </span></div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div></pre></td></tr></table></figure><h3 id="åœ¨ä¸¤å°nodeç»“ç‚¹ä¸Šå»ºç«‹httpsæœåŠ¡"><a href="#åœ¨ä¸¤å°nodeç»“ç‚¹ä¸Šå»ºç«‹httpsæœåŠ¡" class="headerlink" title="åœ¨ä¸¤å°nodeç»“ç‚¹ä¸Šå»ºç«‹httpsæœåŠ¡"></a>åœ¨ä¸¤å°nodeç»“ç‚¹ä¸Šå»ºç«‹httpsæœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">nod1 </div><div class="line"><span class="comment"># mkdir /etc/httpd/cacert </span></div><div class="line"><span class="comment"># cd /etc/httpd/cacert </span></div><div class="line"><span class="comment"># (umask 066;openssl genrsa -out httpd.key 1024)</span></div><div class="line"><span class="comment"># openssl req -new -key httpd.key  -out httpd.crt -days 7200</span></div><div class="line"><span class="comment"># scp httpd.csr 172.16.252.162:/root</span></div></pre></td></tr></table></figure><h3 id="åœ¨directorä¸»æœºä¸­ç”Ÿæˆè‡ªç­¾è¯ä¹¦"><a href="#åœ¨directorä¸»æœºä¸­ç”Ÿæˆè‡ªç­¾è¯ä¹¦" class="headerlink" title="åœ¨directorä¸»æœºä¸­ç”Ÿæˆè‡ªç­¾è¯ä¹¦"></a>åœ¨directorä¸»æœºä¸­ç”Ÿæˆè‡ªç­¾è¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo 01 &gt; /etc/pki/CA/serial</span></div><div class="line"><span class="comment"># touch /etc/pki/CA/index.txt </span></div><div class="line"><span class="comment"># cd /etc/pki/CA/</span></div><div class="line"><span class="comment"># (umask 077; openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)</span></div><div class="line"><span class="comment"># openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</span></div><div class="line"><span class="comment"># openssl ca -in /root/httpd.csr  -out /tmp/httpd.crt</span></div><div class="line"><span class="comment"># scp /tmp/httpd.crt  172.16.251.232:/root</span></div><div class="line"><span class="comment"># scp /etc/pki/CA/cacert.pem  172.16.250.69:/root</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">node2  </div><div class="line"><span class="comment"># mkdir /etc/httpd/cacert</span></div><div class="line">node1  </div><div class="line"><span class="comment"># cd /etc/httpd/cacert/ &amp;&amp; scp * 172.16.251.191:/etc/httpd/cacert/ </span></div><div class="line">nod1,node1 </div><div class="line"><span class="comment"># vim /etc/httpd/conf.d/ssl.conf  </span></div><div class="line">ä¿®æ”¹ : SSLCertificateFile /etc/httpd/cacert/httpd.crt</div><div class="line">SSLCertificateKeyFile /etc/httpd/cacert/httpd.key </div><div class="line"><span class="comment"># systemctl restart httpd</span></div></pre></td></tr></table></figure><h3 id="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-3"><a href="#åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-3" class="headerlink" title="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•:"></a>åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vim /etc/hosts </span></div><div class="line">åŠ å…¥ : 172.16.252.166  www.rj.com</div></pre></td></tr></table></figure><h3 id="æµ‹è¯•httpsä¸httpçš„æŒä¹…è¿æ¥"><a href="#æµ‹è¯•httpsä¸httpçš„æŒä¹…è¿æ¥" class="headerlink" title="æµ‹è¯•httpsä¸httpçš„æŒä¹…è¿æ¥"></a>æµ‹è¯•httpsä¸httpçš„æŒä¹…è¿æ¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..4&#125; ;do curl â€“cacert /root/cacert.pem https://www.rj.com &amp;&amp; curl http://www.rj.com ; done </span></div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div></pre></td></tr></table></figure><h3 id="åœ¨-ldirectord-ä¸­å®ç°"><a href="#åœ¨-ldirectord-ä¸­å®ç°" class="headerlink" title="åœ¨ ldirectord ä¸­å®ç°"></a>åœ¨ ldirectord ä¸­å®ç°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">driector  </div><div class="line"><span class="comment"># vim /etc/ha.d/ldirectord.cf </span></div><div class="line">checktimeout=3</div><div class="line">checkinterval=1</div><div class="line">fallback=127.0.0.1:80</div><div class="line">autoreload=yes</div><div class="line">logfile=â€/var/<span class="built_in">log</span>/ldirectord.logâ€</div><div class="line">quiescent=no</div><div class="line">virtual=10</div><div class="line">real=172.16.251.191:80 gate 1</div><div class="line">real=172.16.251.232:80 gate 3</div><div class="line">fallback=127.0.0.1:80 gate</div><div class="line">service=http</div><div class="line">scheduler=wrr</div><div class="line">checktype=negotiate</div><div class="line">checkport=80</div><div class="line"><span class="comment"># systemctl start ldirectord</span></div><div class="line"><span class="comment"># ipvsadm -Ln</span></div></pre></td></tr></table></figure><h3 id="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-4"><a href="#åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•-4" class="headerlink" title="åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•"></a>åœ¨å…¶å®ƒä¸»æœºä¸­è¿›è¡Œæµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># for i in &#123;1..4&#125; ;do curl â€“cacert /root/cacert.pem https://www.rj.com &amp;&amp; curl http://www.rj.com ; done </span></div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS2&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div><div class="line">&lt;h1&gt;RS1&lt;/h2&gt;</div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
    <entry>
      <title>ç¬”è®°ä¹‹--bashåŸºç¡€ç‰¹æ€§</title>
      <link href="/2017/10/19/%E7%AC%94%E8%AE%B0%E4%B9%8B-bash%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7/"/>
      <url>/2017/10/19/%E7%AC%94%E8%AE%B0%E4%B9%8B-bash%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7/</url>
      <content type="html"><![CDATA[<h1 id="bash-åŸºç¡€ç‰¹æ€§"><a href="#bash-åŸºç¡€ç‰¹æ€§" class="headerlink" title="bash åŸºç¡€ç‰¹æ€§"></a>bash åŸºç¡€ç‰¹æ€§</h1><h3 id="å‘½ä»¤æ¨¡å¼"><a href="#å‘½ä»¤æ¨¡å¼" class="headerlink" title="å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h3><p>systemctl set-default multi-user.target  </p><h3 id="å›¾å½¢æ¨¡å¼"><a href="#å›¾å½¢æ¨¡å¼" class="headerlink" title="å›¾å½¢æ¨¡å¼"></a>å›¾å½¢æ¨¡å¼</h3><p>systemctl set-default graphical.target  </p><h3 id="ipythonå®‰è£…ä½¿ç”¨"><a href="#ipythonå®‰è£…ä½¿ç”¨" class="headerlink" title="ipythonå®‰è£…ä½¿ç”¨"></a>ipythonå®‰è£…ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># python ipython </div><div class="line"># tar -xvf pip-8.1.2.tar.gz</div><div class="line"># tar -xvf setuptools-28.2.0.tar.gz</div><div class="line"># tar -xvf ipython-5.1.0</div><div class="line"># cd åˆ°å…¶å„ä¸ªç›®å½•ä¸­  python setup.py build &amp;&amp; pyton setup.py install </div><div class="line"># pip install traitlets</div><div class="line"># pip install pygments</div><div class="line"># pip install simplegeneric</div><div class="line"># pip install --upgrade setuptools pi</div><div class="line"># pip unistall ipython</div><div class="line"># pip uninstall ipython</div><div class="line"># pip install ipython</div><div class="line"># pip install jupyter</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">jupyter-notebook --ip 0.0.0.0 --port 46  å¯åŠ¨jupyter </div><div class="line">jupyter-nbconvert --to html filename.ipynb</div><div class="line">ipython nbconvert --to python &lt;YourNotebook&gt;.ipynb</div></pre></td></tr></table></figure><ul><li>å†å²è®°å½•çš„ä½¿ç”¨æ ¼å¼  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export HISTTIMEFORMAT=&quot;`whoami`:%F%T&quot;</div></pre></td></tr></table></figure><ul><li>å®šä¹‰å†å²å‘½ä»¤çš„æ ¼å¼  </li><li>HISTSIZE=1000000 å®šä¹‰å‘½ä»¤çš„æ•°é‡  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># rmdir [OPTION]...DIRECTORY... </div><div class="line">     -p:åˆ é™¤æŸå½•åï¼Œå¦‚æœå…¶çˆ¶ç›®å½•ä¸ºç©ºï¼Œåˆ™ä¸€å¹¶åˆ é™¤ä¹‹</div><div class="line">     -v:æ˜¾ç¤ºè¿‡ç¨‹</div><div class="line"># mkdir -pv /tmp/x&#123;y1/&#123;a,b&#125;,y2&#125;</div><div class="line"># mkdir -v &#123;a,b&#125;_&#123;c,d&#125;</div><div class="line"># mkdir -pv /tmp/mysysroot/&#123;bin,sbin,etc/sysconfig/network-scripts,usr/</div><div class="line">  &#123;bin,sbin,local/&#123;bin,sbin,etc,lib&#125;,lib,lib64&#125;,var/&#123;cache,log,run&#125;&#125;</div><div class="line"># tree -L levelæŒ‡å®šæ˜¾ç¤ºå±‚çº§</div></pre></td></tr></table></figure><ul><li>bashçš„åŸºç¡€ç‰¹æ€§ï¼šå‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ç»“æœ  </li><li>å‘½ä»¤æ‰§è¡Œçš„çŠ¶æ€ç»“æœ  </li><li>bashé€šè¿‡çŠ¶æ€è¿”å›å€¼æ¥è¾“å‡ºæ­¤ç»“æœ  </li><li>æˆåŠŸ0  å¤±è´¥1-255  </li><li>å‘½ä»¤æ‰§è¡Œå®Œæˆä¹‹åï¼Œå…¶çŠ¶æ€è¿”å›å€¼ä¿å­˜åœ¨bashçš„ç‰¹æ®Šå˜é‡$?ä¸­  </li><li>å‘½ä»¤æ­£å¸¸æ‰§è¡Œæ—¶ï¼Œæœ‰çš„è¿˜å›æœ‰å‘½ä»¤è¿”å›å€¼  </li><li>æ ¹æ®å‘½ä»¤åŠå…¶åŠŸèƒ½ä¸åŒï¼Œç»“æœå„ä¸ç›¸åŒ  </li><li>å¼•ç”¨å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼›$(COMMAND)æˆ–<code>COMMAND</code>  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir $(date +%H-%M-%S)</div></pre></td></tr></table></figure><ul><li>bash å¿«æ·é”®  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ctrl +a ï¼šè·³è½¬åˆ°å‘½ä»¤è¡Œé¦–</div><div class="line">ctrl +e ï¼šè·³è½¬åˆ°å‘½ä»¤è¡Œå°¾</div><div class="line">ctrl +u ï¼šåˆ é™¤è¡Œé¦–åˆ°å…‰æ ‡æ‰€åœ¨å¤„ä¹‹é—´çš„æ‰€æœ‰å­—ç¬¦</div><div class="line">ctrl +k ï¼šåˆ é™¤å…‰æ ‡æ‰€åœ¨å¤„åˆ°è¡Œå°¾çš„æ‰€æœ‰å­—ç¬¦</div><div class="line">ctrl +l ï¼šæ¸…å±ï¼Œç›¸å½“äºclear</div></pre></td></tr></table></figure><ul><li>æ–‡ä»¶æŸ¥çœ‹ç±»å‘½ä»¤ï¼šcat,tac,head,tail,more,less  </li><li>åˆ†å±æŸ¥çœ‹å‘½ä»¤ï¼šmore less  </li><li>moreå‘½ä»¤  </li><li>moreã€€FILEã€€ç‰¹ç‚¹ï¼šç¿»å±è‡³æ–‡ä»¶å°¾åè‡ªåŠ¨é€€å‡º  </li><li>lesså‘½ä»¤   </li><li>less  FILE</li><li>headå‘½ä»¤</li><li>æŸ¥çœ‹æ–‡ä»¶çš„å‰nè¡Œï¼š head [options] FILE</li><li>-n # or -#</li><li>tailå‘½ä»¤ï¼š</li><li>æŸ¥çœ‹æ–‡ä»¶çš„ånè¡Œï¼štail [options] FILE </li><li>-n # or -#</li><li>æ³¨ -f ï¼šoutput appended data as the file grows</li><li>æŸ¥çœ‹å†…å®¹åä¸é€€å‡ºï¼Œç”¨æ¥æŸ¥çœ‹æ–‡ä»¶å†…çš„æ–°å¢å†…å®¹</li></ul><blockquote><p>stat /tmp/functions ç”¨æ¥æ˜¾ç¤ºæ–‡ä»¶çš„çŠ¶æ€<br>stat FILEâ€¦   æ–‡ä»¶ï¼šä¸¤ç±»æ•°æ®  å…ƒæ•°æ‰€ï¼šmetadata   æ®æ•°ï¼šdata<br>æ—¶é—´æˆ³ access time<br>       modify time<br>       change time    </p><p>touch æ‘¸ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œä¼šåˆ›å»ºç©ºæ–‡ä»¶<br>      touch - change file timestamps<br>      touch [OPTION]â€¦FILEâ€¦<br>      -c:æŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¸äºˆåˆ›å»ºï¼›<br>      -a:ä»…ä¿®æ”¹access time;<br>      -m:ä»…ä¿®æ”¹modify time;<br>      -t STAMP [[CC]YY]MMDDhhmm[-ss].  </p></blockquote><h2 id="bashåŸºç¡€ç‰¹æ€§"><a href="#bashåŸºç¡€ç‰¹æ€§" class="headerlink" title="bashåŸºç¡€ç‰¹æ€§"></a>bashåŸºç¡€ç‰¹æ€§</h2><ul><li>globbing:æ–‡ä»¶åé€šé…(æ•´ä½“æ–‡ä»¶ååŒ¹é…ï¼Œè€Œééƒ¨åˆ†)</li><li>*ï¼šåŒ¹é…ä»»æ„é•¿åº¦çš„ä»»æ„å­—ç¬¦</li><li>pa*æ‰€æœ‰ä»¥paå¼€å¤´çš„æ–‡ä»¶</li><li><em>pa</em> <em>pa </em>p<em>a</em></li><li>?ï¼šåŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦</li><li>pa?  paa ??pa p?a  p?a?</li><li>[]:åŒ¹é…æŒ‡å®šèŒƒå›´å†…çš„ä»»æ„å•ä¸ªå­—ç¬¦</li><li>æœ‰å‡ ç§ç‰¹æ®Šæ ¼å¼ [ a-z],[A-Z],[a-z,0-9]</li><li>pa[0-9][0-9],2[0-9][0-9]</li></ul><h2 id="nmtui-NetworkManager"><a href="#nmtui-NetworkManager" class="headerlink" title="nmtui  NetworkManager"></a>nmtui  NetworkManager</h2><ul><li>rootç”¨æˆ·ä¸ä¸€ç›´æ˜¯ç®¡ç†å‘˜ï¼ŒåŸå› ï¼šç®¡ç†å‘˜æ˜¯å¯ä»¥æ›´æ”¹çš„</li><li>ttyå‘½ä»¤æŸ¥çœ‹ç»ˆç«¯ç±»å‹ï¼šç‰©ç†ç»ˆç«¯ï¼Œä¼ªç»ˆç«¯ï¼Œpts  è™šæ‹Ÿç»ˆç«¯tty å›¾å½¢ç»ˆç«¯</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># echo $SHELL</div><div class="line"># cat /etc/shells</div><div class="line"># type pwd builtin(å†…ç½®)  å†…ç½®å‘½ä»¤åœ¨/bin/bash ä¸­</div><div class="line"># type ls åˆ«å</div><div class="line">#     hashed(å¤–ç½®å‘½ä»¤)</div><div class="line"># hash æ˜¾ç¤ºå‘½ä»¤ç¼“å­˜ï¼Œä½œç”¨æé«˜ç³»ç»ŸæŸ¥æ‰¾å‘½ä»¤çš„é€Ÿåº¦</div><div class="line"># hash -d  tty æŒ‡å®šåˆ é™¤ ï¼ˆæ³¨ï¼šæŒ‡å®šåˆ«åæ—¶ç›´æ¥åˆ é™¤åˆ«åï¼‰</div><div class="line"># hash -r  å…¨æ¸…ç©º</div><div class="line"># hash -l æ˜¾ç¤ºç¼“å­˜</div><div class="line"># hash -p /usr/bin/tty newtty ç»™ç¼“å­˜çš„å‘½ä»¤èµ·ä¸€ä¸ªåˆ«å</div><div class="line"># hash -t æŸ¥çœ‹å‘½ä»¤å¯¹åº”è·¯å¾„</div></pre></td></tr></table></figure><ul><li><p>alias </p><blockquote><p>eg ce7 grep æœ‰åˆ«å   alias grep=â€™grep â€“color=autoâ€™ è€Œce6çš„grepæ²¡æœ‰<br>alias åˆ«åè¦æƒ³ç”Ÿæ•ˆè¦å®šä¹‰åˆ° .bashrcä¸­<br>åˆ«åæ¯”å†…éƒ¨ä¼˜å…ˆçº§é«˜ï¼Œå†…éƒ¨å‘½ä»¤æ¯”å¤–éƒ¨å‘½ä»¤ä¼˜å…ˆçº§é«˜<br>alias  å†…éƒ¨  å¤–éƒ¨  </p></blockquote></li><li><p>hashed æ¯”PATHä¸­å®šä¹‰çš„è¦é«˜  </p></li><li>which -a cat  å¼ºç½®æœç´¢catæ‰€åœ¨çš„æ‰€æœ‰ç›®å½•ï¼ˆæ³¨ï¼Œå¦‚æœå‘½ä»¤æœ‰å¤šä¸ªçš„è¯ï¼‰  </li><li>which â€“skip-alias ls  æŸ¥æ‰¾lsæ‰€åœ¨ç›®å½•æ—¶ï¼Œè·³è¿‡åˆ«å  </li><li>unalias  å–æ¶ˆåˆ«å -a å–æ¶ˆæ‰€æœ‰åˆ«å åŒæ ·åªå¯¹å½“å‰ç»ˆç«¯ç”Ÿæ•ˆ  </li><li>æ³¨ï¼šbashè‡ªèº«æ˜¯ä¸€ä¸ªå¤–éƒ¨çš„å‘½ä»¤  </li><li>æŸ¥æ‰¾å†…éƒ¨å‘½ä»¤çš„æ—¶å€™man æ–‡æ¡£æ‰“å¼€çš„ç›¸å½“äº man bash  </li><li><p>æ³¨ï¼šç›´æ¥é”®å…¥helpæ—¶å€™ï¼Œå¯ä»¥ç›´æ¥åˆ—å‡ºæ‰€æœ‰çš„å†…éƒ¨å‘½ä»¤  </p></li><li><p>enalbe -n pwd  ä¸´æ—¶ç¦ç”¨pwdå‘½ä»¤ -a å¯ç”¨</p></li><li>echo $[RANDOMM%80] éšæœºæ•°çš„ç”Ÿæˆ</li><li>æ³¨pwd æœ‰å¤–éƒ¨å‘½ä»¤</li><li><p>æ³¨åªè¦æ˜¯èƒ½åªæ¥manæŸ¥åˆ°çš„å‘½ä»¤ï¼Œå®ƒéƒ½æœ‰å¤–éƒ¨å‘½ä»¤</p></li><li><p>æ³¨PS1=\e[31m     \e[0mç”¨æ¥æˆªæ­¢é¢œè‰² PS1=â€™\033[31m[\u@\h\W]\$\033[0mâ€™</p></li><li><p>ascii 7 ä½ 2^7=128å­—ç¬¦</p></li><li><p>unicodeï¼ˆä»–å¯ä»¥æŠŠä¸–ç•Œå…¨éƒ¨çš„æ–‡å­—éƒ½å½•å…¥è¿›æ¥ï¼‰ è¡¨ utf-8å°±æ˜¯å…¶ä¸­çš„ä¸€ç§</p></li><li><p>bcè®¡ç®—å™¨  ibase=8 æŒ‡å®šè¿›åˆ¶ä¸ºå…« ibase=16  æŒ‡å®šè¿›åˆ¶ä¸º16   obase=8 æŒ‡å®šè¾“å‡ºä¸ºå…«è¿›åˆ¶</p></li><li><p>æ€»ç»“ï¼šalias nano bc enable (ç®¡ç†å†…éƒ¨å‘½ä»¤) -n</p></li><li><p>hash -d -r -l  type help which  man unalias</p></li><li><p>whereis     æŸ¥çœ‹å‘½ä»¤æ¯”which æ›´è¯¦ç»†</p></li><li>hostname æŸ¥çœ‹ä¸»æœºå</li><li>ä»…å¯¹å½“å‰ç”¨æˆ·ç”Ÿæ•ˆï¼š ~/.bashrc</li><li><p>å¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿäº¤ï¼š /etc/bashrcä¸­</p></li><li><p>ä½¿ç”¨vmare å‰æœŸè¦æœ‰å¿«ç…§    å¯å°†vmware ä¸‹çš„æ–‡ä»¶å¤åˆ¶å‡ºæ¥</p></li><li><p>source å’Œ .  æ˜¯ç­‰ä»·çš„   eg source .bashrc   . .bashrc (æ³¨ä¸­é—´æœ‰ç©ºæ ¼)</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">å‡å¦‚æœ‰åˆ«åä¹‹åï¼Œè¦ç”¨å®ƒçš„çœŸå®å  /bin/grep   root /etc/passwd</div><div class="line">\grep   root /etc/passwd</div><div class="line">&apos;grep&apos;   root /etc/passwd</div></pre></td></tr></table></figure><blockquote><p>å‘½ä»¤  é€‰é¡¹  å‚æ•°<br>ls -la çŸ­æ ¼å¼   â€“allçŸ­æ ¼å¼<br>åŒºåˆ«ï¼šçŸ­æ ¼å¼å¯ä»¥ç®€å†™è¿åœ¨ä¸€èµ·è€ŒçŸ­çš„ä¸èƒ½<br>è¿˜æœ‰çš„ä¸é¡»è¦ -    eg : ps a<br>pwd;ls;hostname   å¤šä¸ªå‘½ä»¤å¯ä»¥ç”¨;éš”å¼€<br>å‘½ä»¤å¤ªè¿‡é•¿æ—¶å¯åŠ \<br>ls -l (æ„æ€ä¸ºlist)<br>-rwâ€”â€”-. 1 root root    1537 Oct  4 01:52 anaconda-ks.cfg<br>ä»€ä¹ˆæ—¶å€™ä¿®æ”¹çš„  </p><ul><li>d  b(block) l s(sock) cï¼ˆchararterï¼‰<br>-p (pip)    æ³¨åœ¨æœ¬æœºå†…éƒ¨çš„ä¸¤ä¸ªç¨‹åºé€šä¿¡æ—¶å€ŸåŠ©äºsocketæ–‡ä»¶    </li></ul><p>ç¡¬ç›˜IDE SCSI SATA SAS (ç”¨äºæœåŠ¡å™¨é¢)<br>/dev/hd(IDE)  /dev/sd(é™¤IDEä¹‹å¤–çš„) /dev/vd(è™šæ‹Ÿçš„)<br>lsblk æ˜¾ç¤ºå—æ–‡ä»¶<br>éšæœºè®¿é—®ï¼šå¯ä»¥ç›´æ¥å»è®¿é—®é‚£ä¸ªæ–‡ä»¶<br>c (câ€¦â€¦â€¦â€¦â€¦â€¦hararter) é¡»è¦é¡ºåºè®¿é—® ll /dev/zero<br>df  å¯æŸ¥çœ‹åˆ†åŒºçš„åˆ©ç”¨ç‡<br>mount æŒ‚è½½ï¼Œæ˜ å°„<br>/dev/sda1  ==mount==&gt; (æ˜ å°„åˆ°) /boot (C:) æŒ‚è½½ç‚¹<br>æŠŠä¸€ä¸ªè®¾å¤‡mount dir(æŒ‚è½½ç‚¹)<br>dd ifï¼ˆè¾“å…¥æ–‡ä»¶ï¼‰=/dev/zero of=f1 count=1<br>hexdump -v -C f1  å¯æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶<br>od  ä¹Ÿå¯ä»¥<br>cat ç”¨äºçœ‹æ–‡æœ¬<br>/dev/nullï¼ˆç©ºï¼‰ç³»ç»Ÿé»‘æ´<br>dd if=/dev/sda of=/dev/null<br>nano /etc/DIR_COLORS å¯æ›´æ”¹ç³»ç»Ÿæ–‡ä»¶çš„é¢œè‰²<br>ctrl +D æ­£å¸¸é€€å‡ºï¼ˆé€€å‡ºå½“å‰è¿›ç¨‹ï¼‰  ctrl +C å¼ºè¡Œé€€å‡º<br>date -u å…¶å®ƒåŒºçš„æ—¶é—´ </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[11:54:27root@clu~]# cal 9 1752</div><div class="line">                         September 1752   </div><div class="line">                       Su Mo Tu We Th Fr Sa</div><div class="line">                              1  2 14 15 16</div><div class="line">                       17 18 19 20 21 22 23</div><div class="line">                       24 25 26 27 28 29 30</div></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šcd /misc/cd  df  ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ<br>screen -S ï¼ˆsessionï¼‰renjin    åˆ›å»ºä¼šè¯  screen -x åŠ å…¥ä¼šè¯   exit é€€å‡º  ctrl +a,d å‰¥ç¦»å½“å‰ä¼šè¯<br>screen -lsæ˜¾ç¤ºå½“å‰ä¼šè¯  screen -r è¿˜åŸä¼šè¯<br>è¡¥screen -S some_name -X quit<br>mount /dev/sr0  /mnt/yum mount /dev/cdrom  /mnt/yum<br>æ­¥éª¤ å½“å‰æœºå™¨ screen -S renjin    å¦ä¸€å°æœºå™¨screen -x  renjin<br>echo  -n ä¸æ¢è¡Œ<br>-e å¯å¼€å¯\ç‰¹æ€§ï¼ˆ\aå‘å£°\cä¸æ¢è¡Œ\nå¼ºåˆ¶å†æ¢è¡Œ\t tab \bé€€æ ¼x\rå…‰æ ‡ç§»åˆ°è¡Œé¦–ï¼Œä½†ä¸æ¢è¡Œ<br>\033[43(èƒŒæ™¯è‰²);33m   \033[0m   \HH åå…­è¿›æŠ•å½±  \e â€œ\x#â€æ‰“å°ascii \onnnå…«è¿›åˆ¶asciic &lt; </p><p>echo â€˜åªä»»å­—ç¬¦ä¸²ï¼ˆå¼ºï¼‰â€™                           eg echo -e â€œa\nbâ€<br>echo <code>å‘½ä»¤å’Œå¼•ç”¨éƒ½èƒ½å®åˆ«</code><br>echo â€œå¤„äºä¸­é—´çŠ¶æ€ï¼ˆå¼±ï¼‰â€<br>å‘½ä»¤è°ƒç”¨å¦ä¸€ä¸ªå‘½ä»¤ï¼Œè¢«è°ƒç”¨çš„å‘½ä»¤ç”¨çš„åå‘å•å¼•å·<code>touch `date +%F`.log  touch `hostname`.txt  $() ä¸</code>æ˜¯ç­‰ä»·çš„<br>linux ls åˆ—å‡ºçš„é¡ºåºå°Šé‡asciiç çš„é¡ºåº å¤§å†™å­—æ¯åœ¨å°å†™å­—æ¯å‰  Aa Bb<br>touch f{a,b,c}.{txt,log} touch f{a,b,c}.{txt,log}<br>echo {000ï¼ˆåˆå§‹æ•°ï¼Œå®šä¹‰äº†ä½çš„0ï¼‰..30ï¼ˆ0åˆ°30ï¼‰..2(æ¯æ¬¡é€’å¢2)}<br>echo {a-z}</p></blockquote>]]></content>
      
      
    </entry>
    
    <entry>
      <title>GITç®€å•ä½¿ç”¨åŠæœåŠ¡å™¨æ—¥å¸¸é”™è¯¯å¤„ç†</title>
      <link href="/2017/10/18/GIT%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
      <url>/2017/10/18/GIT%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<h1 id="git-ç®€å•ä½¿ç”¨"><a href="#git-ç®€å•ä½¿ç”¨" class="headerlink" title="git ç®€å•ä½¿ç”¨"></a>git ç®€å•ä½¿ç”¨</h1><ul><li>gitlab æ–°å»ºé¡¹ç›®<br><a href="http://10.180.55.111:8088/dashboard/projects/" target="_blank" rel="external">gitlab æœ¬åœ°æ–°å»ºåœ°å€</a><br> <a href="http://10.180.55.111:8088/dashboard/projects/" target="_blank" rel="external">http://10.180.55.111:8088/dashboard/projects/</a><br> ç‚¹å‡»  New Project â€”&gt; RenJin  /   You project name â€”&gt; Create Project</li><li>ç»ˆç«¯ä¸­çš„é…ç½®  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># git config --global user.name &quot;Jin.Ren&quot;</div><div class="line"># git config --global user.emal &quot;renjin@transfereasy.com&quot;</div><div class="line">æŸ¥çœ‹æœ¬æœºçš„å¯†é’¥ï¼Œæ·»åŠ è‡³gitlabä¸­</div><div class="line"># cat ~/.ssh/id_rsa.pub</div></pre></td></tr></table></figure><ul><li><p>å¤åˆ¶å¯†é’¥è‡³  </p><p>   gitlab ç‚¹å‡»å·¦ä¸‹è„šçš„ç”¨æˆ·å â€”&gt; Profile Settings â€“&gt;SSH Keys â€”&gt; (key) â€”&gt; Add key  </p></li><li><p>gitæœ¬åœ°æ–°é¡¹ç›®ä¸Šä¼   </p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># mkdir deplay-test</div><div class="line"># git init </div><div class="line"># vim secruity.sh</div><div class="line"># vim rolbask.sh </div><div class="line"># chmod +x *.sh</div><div class="line"># git commit -m &quot;security scripts&quot;</div><div class="line"># git remote add origin git@10.180.55.111:Jin.Ren/deplay-test.git</div><div class="line"># git push -u origin master</div></pre></td></tr></table></figure><ul><li>gitä¸Šä¼ å·²ç»å­˜åœ¨çš„repository</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># cd old-deplay </div><div class="line"># git remote add origin git@10.180.55.111:Jin.Ren/deplay-test.git</div><div class="line"># git push -u origin master</div></pre></td></tr></table></figure><ul><li>git ä¸Šä¼ å·²ç»å­˜åœ¨çš„repository  </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># git checkout -b seq</div><div class="line"># git branch </div><div class="line"># git checkout master  </div><div class="line">å¯ä»¥åˆ‡æ¢å›masteråˆ†æ”¯</div></pre></td></tr></table></figure><ul><li>è¡¥å……mysqlæ•°æ®çš„å¯¼å…¥å¯¼å‡º</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># mysqldump -uuser -ppasswd -hhost --databases data &gt; /tmp/database.sql</div></pre></td></tr></table></figure><h1 id="mongoç”Ÿäº§æŠ¥é”™æ€»ç»“"><a href="#mongoç”Ÿäº§æŠ¥é”™æ€»ç»“" class="headerlink" title="mongoç”Ÿäº§æŠ¥é”™æ€»ç»“"></a>mongoç”Ÿäº§æŠ¥é”™æ€»ç»“</h1><ul><li>python è®°å…¥mongoæ—¶ä¼šæŠ¥é”™ 2.x ä¸ 3.x ä½¿ç”¨çš„åŠ å¯†æ–¹å¼ä¸åŒ<br>ubuntuå‡çº§mongo2.xåˆ°3.x </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"># sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10</div><div class="line"># echo &quot;deb http://repo.mongodb.org/apt/ubuntu &quot;$(lsb_release -sc)&quot;/mongodb-org/3.0 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.0.list</div><div class="line"># sudo apt-get update</div><div class="line"># sudo apt-get install -y mongodb-org=3.0.1 mongodb-org-server=3.0.1 mongodb-org-shell=3.0.1 mongodb-org-mongos=3.0.1 mongodb-org-tools=3.0.1</div><div class="line"># su - root -c &quot;echo &apos;never&apos; &gt; /sys/kernel/mm/transparent_hugepage/enabled&quot;</div><div class="line"># su - root -c &quot;echo &apos;never&apos; &gt; /sys/kernel/mm/transparent_hugepage/defrag&quot;</div><div class="line"># sudo /etc/init.d/mongodb start</div><div class="line"># mogon #æ­¤å¤„ä¾¿å¯ä»¥çœ‹åˆ°ç‰ˆæœ¬å·äº†</div><div class="line"># mogodbé»˜è®¤æ˜¯æ²¡æœ‰å¯†ç çš„ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å°†è®¤è¯å¼€å¯ï¼ˆä½†åœ¨æ­¤ä¹‹å‰é…ç½®å¥½ç”¨æˆ·æœ‰åå’Œå¯†ç ï¼‰</div><div class="line"># mogon</div><div class="line">&#123; user: &quot;&lt;name&gt;&quot;,  </div><div class="line">  pwd: &quot;&lt;cleartext password&gt;&quot;,</div><div class="line">  customData: &#123; &lt;any information&gt; &#125;, # ä»»æ„çš„æ•°æ®,ä¸€èˆ¬æ˜¯ç”¨äºæè¿°ç”¨æˆ·ç®¡ç†å‘˜çš„ä¿¡æ¯</div><div class="line">  roles: [</div><div class="line">    &#123; role: &quot;&lt;role&gt;&quot;, db: &quot;&lt;database&gt;&quot; &#125; | &quot;&lt;role&gt;&quot;, # å¦‚æœæ˜¯roleå°±æ˜¯ç›´æ¥æŒ‡å®šäº†è§’è‰²,å¹¶ä½œç”¨äºå½“å‰çš„æ•°æ®åº“</div><div class="line">    ...</div><div class="line">  ] # rolesæ˜¯å¿…ä¼ é¡¹,ä½†æ˜¯å¯ä»¥æŒ‡å®šç©ºæ•°ç»„,ä¸ºç©ºå°±æ˜¯ä¸æŒ‡å®šä»»ä½•æƒé™</div><div class="line">&#125;</div><div class="line"></div><div class="line">use products # mongoDBçš„æƒé™è®¾ç½®æ˜¯ä»¥åº“ä¸ºå•ä½çš„,å¿…é€‰è¦å…ˆé€‰æ‹©åº“</div><div class="line">db.createUser( </div><div class="line">&#123; &quot;user&quot; : &quot;accountAdmin01&quot;, </div><div class="line"> &quot;pwd&quot;: &quot;cleartext password&quot;,</div><div class="line"> &quot;customData&quot; : &#123; employeeId: 12345 &#125;,</div><div class="line"> &quot;roles&quot; : [ &#123; role: &quot;clusterAdmin&quot;, db: &quot;admin&quot; &#125;, </div><div class="line">             &#123; role: &quot;readAnyDatabase&quot;, db: &quot;admin&quot; &#125;,</div><div class="line">             &quot;readWrite&quot; </div><div class="line">             ] &#125;,</div><div class="line">&#123; w: &quot;majority&quot; , wtimeout: 5000 &#125; ) # readWrite é€‚ç”¨äºproductsåº“,clusterAdminä¸readAnyDatabaseè§’è‰²é€‚ç”¨äºadminåº“</div></pre></td></tr></table></figure><h2 id="macæµ‹è¯•ç¯å¢ƒå¤šç‰ˆæœ¬phpæ·»åŠ mongoæŠ¥é”™-php-h-file-not-fond"><a href="#macæµ‹è¯•ç¯å¢ƒå¤šç‰ˆæœ¬phpæ·»åŠ mongoæŠ¥é”™-php-h-file-not-fond" class="headerlink" title="macæµ‹è¯•ç¯å¢ƒå¤šç‰ˆæœ¬phpæ·»åŠ mongoæŠ¥é”™ php.h file not fond"></a>macæµ‹è¯•ç¯å¢ƒå¤šç‰ˆæœ¬phpæ·»åŠ mongoæŠ¥é”™ php.h file not fond</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cp -r /Library/Developer/Command LineTools/SDKs/MacOSX10.12.sdk/usr/i nclude /Applications/MAMP/bin/php/ph p5.6.10/  </span></div><div class="line"><span class="comment"># brew install pcre</span><span class="comment"># sudo ./pecl install mongodb</span></div></pre></td></tr></table></figure><h2 id="nginx-é‡å†™443å…¨å±€ç”Ÿæ•ˆçš„ä¸¤ç§æ–¹å¼"><a href="#nginx-é‡å†™443å…¨å±€ç”Ÿæ•ˆçš„ä¸¤ç§æ–¹å¼" class="headerlink" title="nginx é‡å†™443å…¨å±€ç”Ÿæ•ˆçš„ä¸¤ç§æ–¹å¼"></a>nginx é‡å†™443å…¨å±€ç”Ÿæ•ˆçš„ä¸¤ç§æ–¹å¼</h2><h3 id="åœ¨serverä¸­æ–°å¼€èµ·ä¸€ä¸ª000-http2https-confè™šæ‹Ÿä¸»æœº"><a href="#åœ¨serverä¸­æ–°å¼€èµ·ä¸€ä¸ª000-http2https-confè™šæ‹Ÿä¸»æœº" class="headerlink" title="åœ¨serverä¸­æ–°å¼€èµ·ä¸€ä¸ª000-http2https.confè™šæ‹Ÿä¸»æœº"></a>åœ¨serverä¸­æ–°å¼€èµ·ä¸€ä¸ª000-http2https.confè™šæ‹Ÿä¸»æœº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen  80;</div><div class="line">    server_name _;</div><div class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$HOST</span><span class="variable">$request_uri</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#server &#123;</span></div><div class="line"><span class="comment">#    listen 80;</span></div><div class="line"><span class="comment">#    server_name test.com;</span></div><div class="line"><span class="comment">#   rewrite ^(.*)$  https://$host$1 permanent;  </span></div><div class="line"><span class="comment">#    </span></div><div class="line"><span class="comment">#&#125;</span></div></pre></td></tr></table></figure><h2 id="nginx-ä¸´æ—¶è¿”å›ä¸€ä¸ªå€¼æˆ–ä¸€ä¸ªåœ°å€"><a href="#nginx-ä¸´æ—¶è¿”å›ä¸€ä¸ªå€¼æˆ–ä¸€ä¸ªåœ°å€" class="headerlink" title="nginx ä¸´æ—¶è¿”å›ä¸€ä¸ªå€¼æˆ–ä¸€ä¸ªåœ°å€"></a>nginx ä¸´æ—¶è¿”å›ä¸€ä¸ªå€¼æˆ–ä¸€ä¸ªåœ°å€</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">    location /rjyy &#123;</div><div class="line">    return &apos;https://rjyy.ssjinyao.com&apos; ;</div><div class="line">&#125;</div><div class="line">    location /nene &#123;</div><div class="line">    return &apos;https://nene.ssjinyao.com&apos; ;</div><div class="line">&#125;</div><div class="line">    location /sange.html &#123;</div><div class="line">    return 200 &apos;&lt;h1&gt;mei tou nao a&lt;/h1&gt;&apos; ;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="sshä¸èƒ½keyç™»å½•"><a href="#sshä¸èƒ½keyç™»å½•" class="headerlink" title="sshä¸èƒ½keyç™»å½•"></a>sshä¸èƒ½keyç™»å½•</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">æŸ¥çœ‹.ssh ä¸ authorized_keysçš„æƒé™</div><div class="line">æŸ¥çœ‹/etc/sshé…ç½®é—®é¢˜</div><div class="line">AuthorizedKeysFile%h/.ssh/authorized_keys</div></pre></td></tr></table></figure><h2 id="å…è®¸HTTPä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è®¾å®šå¤§å°"><a href="#å…è®¸HTTPä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è®¾å®šå¤§å°" class="headerlink" title="å…è®¸HTTPä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è®¾å®šå¤§å°"></a>å…è®¸HTTPä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è®¾å®šå¤§å°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /etc/php.ini</div><div class="line">file_uploads = on; æ˜¯å¦å…è®¸é€šè¿‡HTTPä¸Šä¼ æ–‡ä»¶çš„å¼€å…³ã€‚é»˜è®¤ä¸ºONå³æ˜¯å¼€;</div><div class="line">upload_tmp_dir;  æ–‡ä»¶ä¸Šä¼ è‡³æœåŠ¡å™¨ä¸Šå­˜å‚¨ä¸´æ—¶æ–‡ä»¶çš„åœ°æ–¹ï¼Œå¦‚æœæ²¡æŒ‡å®šå°±ä¼šç”¨ç³»ç»Ÿé»˜è®¤çš„ä¸´æ—¶æ–‡ä»¶å¤¹;</div><div class="line">post_max_filesize = 8m;  å…è®¸ä¸Šä¼ æ–‡ä»¶å¤§å°çš„æœ€å¤§å€¼ã€‚é»˜è®¤ä¸º2M; </div><div class="line">post_max_size 8m; æŒ‡é€šè¿‡è¡¨å•POSTç»™PHPçš„æ‰€èƒ½æ¥æ”¶çš„æœ€å¤§å€¼ï¼ŒåŒ…æ‹¬è¡¨å•é‡Œçš„æ‰€æœ‰å€¼ã€‚é»˜è®¤ä¸º8M;</div></pre></td></tr></table></figure><h2 id="gitlab-ci-æŒç»­åŒ–å‘å¸ƒå¹³å°"><a href="#gitlab-ci-æŒç»­åŒ–å‘å¸ƒå¹³å°" class="headerlink" title="gitlab-ci æŒç»­åŒ–å‘å¸ƒå¹³å°"></a>gitlab-ci æŒç»­åŒ–å‘å¸ƒå¹³å°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># gitlab-ci è®¤è¯æ˜¯ä¸€å‘ï¼Œç‰ˆæœ¬ä¸å…¼å®¹çš„è¯ä¸€ç›´ä¼šè®¤è¯å¤±è´¥çš„,gitlab-ci ä¸gilab å¯ä»¥ä¸åœ¨åŒä¸€å°æœåŠ¡å™¨; </div><div class="line"># ä½†æ˜¯å¯ä»¥å ¡å’æœºæ”¾åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Š;</div><div class="line"># apt-get install  gitlab-ci-multi-runner=1.10.2</div><div class="line"># gitlab-ci-multi-runner register</div><div class="line">http://xxx.xx.xxx.xxx:8080/ci</div><div class="line">å¦‚æœæ˜¯å»ºç«‹å…¬å…±runnerï¼Œåˆ™éœ€è¦ä»¥rootç™»å½•gitlab --&gt; root --&gt; Admin Area --&gt; Ruuners -&gt; å¯ä»¥æŸ¥çœ‹åˆ°å˜çº¢çš„koen </div><div class="line">deploy</div><div class="line">shell</div><div class="line">shell</div></pre></td></tr></table></figure><p>ä¾¿å¯ä»¥æ·»åŠ ä¸Šäº†</p><p>åœ¨æŒ‡å®šåˆ†æ”¯ä¸­æ·»åŠ .gitlab-ci.yml ï¼Œå¦‚teståˆ†æ”¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">before_script:</div><div class="line">    - cd /xxxxx/xxxx/deploy_ci</div><div class="line">job:</div><div class="line">    only: </div><div class="line">        - test</div><div class="line">    tags:</div><div class="line">        - inner</div><div class="line">    script:</div><div class="line">        - /usr/bin/fab -f xx-deploy.py xxxxxx:test,0</div></pre></td></tr></table></figure><h3 id="å…³äºpython-éƒ¨ç½²çš„å‘"><a href="#å…³äºpython-éƒ¨ç½²çš„å‘" class="headerlink" title="å…³äºpython éƒ¨ç½²çš„å‘"></a>å…³äºpython éƒ¨ç½²çš„å‘</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># é¡¹ç›®ç›®å½• /root/text/</div><div class="line"># éœ€è¦æ‰§è¡Œçš„ä»£ç   /root/text/poor/fober.py</div><div class="line"># config é…ç½®æ–‡ä»¶ /root/text/config/config.py</div><div class="line">å…±ä¸¤ç§è§£å†³æ–¹å¼</div><div class="line">1. æ·»åŠ v.pth åœ¨ENVä¸­ </div><div class="line"># virtualenv /root/text/ENV</div><div class="line"># vim /root/text/ENV/lib/python2.7/site-packages/v.pth</div><div class="line">/root/text</div><div class="line">2. åœ¨è°ƒç”¨configå‰ï¼Œå®šä¹‰å¥½ç›®å½•</div><div class="line"># sys.path.append(&apos;/root/text/&apos;)</div></pre></td></tr></table></figure>]]></content>
      
      
    </entry>
    
  
  
</search>
